--- 
slug: Add policy to application
eventname: Add policy to application
title: Add policy to application
sidebar_label: Add policy to application
---
                       
### Event Information

- The "Add policy to application" event in Azure Active Directory refers to the action of adding a policy to an application within the Azure AD tenant.
- Policies in Azure AD are used to enforce specific security and access control requirements for applications. These policies can include authentication methods, conditional access rules, and other settings.
- By adding a policy to an application, administrators can define and enforce specific security measures and access controls for that application, ensuring that only authorized users and devices can access it.


### Examples

1. Misconfigured permissions: When adding a policy to an application in Azure Active Directory (AAD), it is important to ensure that the permissions granted to the application are appropriate and aligned with the principle of least privilege. If the permissions are misconfigured and grant excessive access, it can lead to security risks such as unauthorized access to sensitive data or resources.

2. Lack of authentication and authorization controls: When adding a policy to an application in AAD, it is crucial to implement strong authentication and authorization controls. Failing to do so can result in security vulnerabilities, such as allowing unauthorized users to access the application or perform actions they should not be able to.

3. Inadequate monitoring and logging: Adding a policy to an application in AAD should be accompanied by robust monitoring and logging mechanisms. Without proper monitoring and logging, it becomes difficult to detect and respond to security incidents or suspicious activities. It is important to have visibility into the application's behavior and be able to identify any potential security breaches or policy violations.

### Remediation

#### Using Console

1. Misconfigured permissions:
- Access the Azure portal and navigate to the Azure Active Directory (AAD) service.
- Select the "App registrations" option from the left-hand menu.
- Find and select the application for which you want to review and remediate permissions.
- In the application's overview page, click on the "API permissions" tab.
- Review the list of permissions granted to the application and identify any overly broad or unnecessary permissions.
- Remove any unnecessary permissions by selecting them and clicking on the "Remove" button.
- Adjust the permissions to align with the principle of least privilege by selecting the appropriate options from the "Add a permission" button.

2. Lack of authentication and authorization controls:
- Access the Azure portal and navigate to the Azure Active Directory (AAD) service.
- Select the "App registrations" option from the left-hand menu.
- Find and select the application for which you want to configure authentication and authorization controls.
- In the application's overview page, click on the "Authentication" tab.
- Configure the appropriate authentication methods, such as enabling multi-factor authentication or setting up conditional access policies.
- In the application's overview page, click on the "Authorization" tab.
- Define the necessary authorization rules and roles to control access to the application's resources.
- Test the authentication and authorization controls to ensure they are functioning as expected.

3. Inadequate monitoring and logging:
- Access the Azure portal and navigate to the Azure Active Directory (AAD) service.
- Select the "App registrations" option from the left-hand menu.
- Find and select the application for which you want to enable monitoring and logging.
- In the application's overview page, click on the "Diagnostic settings" tab.
- Click on the "Add diagnostic setting" button to create a new diagnostic setting.
- Configure the diagnostic setting to capture the relevant logs and events, such as authentication logs and policy changes.
- Specify the destination for the logs, such as Azure Monitor or a storage account.
- Enable any necessary alerting or notification mechanisms to be alerted of security incidents or policy violations.
- Regularly review and analyze the logs to detect and respond to any security incidents or policy violations.

#### Using CLI

1. To remediate misconfigured permissions in Azure Active Directory (AAD), you can use the Azure CLI commands to review and modify the permissions granted to an application:

- List all the permissions granted to an application:
  `az ad app permission list --id <application_id>`

- Remove a specific permission from an application:
  `az ad app permission delete --id <application_id> --api <api_id>`

- Grant a specific permission to an application:
  `az ad app permission add --id <application_id> --api <api_id> --scope <scope>`

2. To remediate the lack of authentication and authorization controls in AAD, you can use the following Azure CLI commands:

- Configure authentication for an application:
  `az ad app update --id <application_id> --set "signInAudience=<audience>"`

- Configure authorization for an application:
  `az ad app update --id <application_id> --required-resource-accesses <resource_accesses>`

3. To remediate inadequate monitoring and logging in AAD, you can use the Azure CLI commands to enable and configure logging and monitoring:

- Enable diagnostic settings for an application:
  `az monitor diagnostic-settings create --name <settings_name> --resource <resource_id> --logs <logs> --metrics <metrics>`

- View diagnostic settings for an application:
  `az monitor diagnostic-settings show --name <settings_name> --resource <resource_id>`

- Update diagnostic settings for an application:
  `az monitor diagnostic-settings update --name <settings_name> --resource <resource_id> --logs <logs> --metrics <metrics>`

Note: Replace `<application_id>`, `<api_id>`, `<scope>`, `<audience>`, `<resource_accesses>`, `<settings_name>`, and `<resource_id>` with the appropriate values for your environment.

#### Using Python

1. Misconfigured permissions: To remediate misconfigured permissions in Azure Active Directory (AAD) using Python scripts, you can utilize the Azure AD Graph API or Microsoft Graph API to programmatically manage application permissions. Here's an example script that demonstrates how to update the permissions of an application:

```python
import requests
import json

# Define the necessary variables
tenant_id = '<your_tenant_id>'
client_id = '<your_client_id>'
client_secret = '<your_client_secret>'
application_id = '<target_application_id>'
new_permissions = ['User.Read', 'Group.Read']

# Get an access token using client credentials flow
token_url = f'https://login.microsoftonline.com/{tenant_id}/oauth2/token'
data = {
    'grant_type': 'client_credentials',
    'client_id': client_id,
    'client_secret': client_secret,
    'resource': 'https://graph.microsoft.com'
}
response = requests.post(token_url, data=data)
access_token = response.json()['access_token']

# Update the application permissions
update_url = f'https://graph.microsoft.com/v1.0/applications/{application_id}'
headers = {
    'Authorization': f'Bearer {access_token}',
    'Content-Type': 'application/json'
}
data = {
    'requiredResourceAccess': [
        {
            'resourceAppId': '00000003-0000-0000-c000-000000000000',
            'resourceAccess': [{'id': p} for p in new_permissions]
        }
    ]
}
response = requests.patch(update_url, headers=headers, data=json.dumps(data))
response.raise_for_status()

print('Permissions updated successfully.')
```

2. Lack of authentication and authorization controls: To remediate the lack of authentication and authorization controls in Azure Active Directory (AAD) using Python scripts, you can leverage the Azure AD Graph API or Microsoft Graph API to configure the necessary controls. Here's an example script that demonstrates how to enable multi-factor authentication (MFA) for a user:

```python
import requests
import json

# Define the necessary variables
tenant_id = '<your_tenant_id>'
client_id = '<your_client_id>'
client_secret = '<your_client_secret>'
user_id = '<target_user_id>'

# Get an access token using client credentials flow
token_url = f'https://login.microsoftonline.com/{tenant_id}/oauth2/token'
data = {
    'grant_type': 'client_credentials',
    'client_id': client_id,
    'client_secret': client_secret,
    'resource': 'https://graph.microsoft.com'
}
response = requests.post(token_url, data=data)
access_token = response.json()['access_token']

# Enable multi-factor authentication for the user
update_url = f'https://graph.microsoft.com/v1.0/users/{user_id}'
headers = {
    'Authorization': f'Bearer {access_token}',
    'Content-Type': 'application/json'
}
data = {
    'strongAuthenticationMethods': [
        {
            'type': 'microsoftAuthenticatorApp',
            'phoneAppDetails': {
                'phoneNumber': '<user_phone_number>'
            }
        }
    ]
}
response = requests.patch(update_url, headers=headers, data=json.dumps(data))
response.raise_for_status()

print('Multi-factor authentication enabled successfully.')
```

3. Inadequate monitoring and logging: To remediate inadequate monitoring and logging in Azure Active Directory (AAD) using Python scripts, you can utilize Azure Monitor or Azure Log Analytics to collect and analyze the relevant logs and events. Here's an example script that demonstrates how to enable diagnostic settings for an AAD tenant:

```python
from azure.mgmt.monitor import MonitorManagementClient
from azure.identity import DefaultAzureCredential

# Define the necessary variables
tenant_id = '<your_tenant_id>'
subscription_id = '<your_subscription_id>'
resource_group_name = '<your_resource_group_name>'
aad_tenant_id = '<your_aad_tenant_id>'

# Create the MonitorManagementClient using DefaultAzureCredential
credential = DefaultAzureCredential()
monitor_client = MonitorManagementClient(credential, subscription_id)

# Enable diagnostic settings for AAD tenant
settings_name = 'aad-diagnostic-settings'
log_analytics_workspace_id = '<your_log_analytics_workspace_id>'
log_analytics_workspace_name = '<your_log_analytics_workspace_name>'
log_analytics_workspace_resource_group = '<your_log_analytics_workspace_resource_group>'

monitor_client.diagnostic_settings.create_or_update(
    resource_uri=f'/providers/Microsoft.AAD/tenants/{aad_tenant_id}',
    resource_group_name=resource_group_name,
    parameters={
        'name': settings_name,
        'workspace_id': log_analytics_workspace_id,
        'logs': [
            {
                'category': 'AuditLogs',
                'enabled': True
            }
        ]
    }
)

print('Diagnostic settings enabled successfully.')
```

Note: Make sure to install the necessary Python packages (`requests`, `azure-mgmt-monitor`, `azure-identity`) before running these scripts.


 