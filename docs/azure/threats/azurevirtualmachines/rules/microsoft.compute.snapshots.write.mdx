--- 
slug: Microsoft.Compute.snapshots.write
eventname: Microsoft.Compute.snapshots.write
title: Microsoft.Compute.snapshots.write
sidebar_label: Microsoft.Compute.snapshots.write
---
                       
### Event Information

- The Microsoft.Compute.snapshots.write event in Azure for AzureVirtualMachines refers to the action of creating or updating a snapshot of a virtual machine in Azure.
- This event indicates that a user or an automated process has initiated the creation or modification of a snapshot for a virtual machine.
- Snapshots are point-in-time copies of virtual machine disks, which can be used for backup, disaster recovery, or creating new virtual machines.


### Examples

1. Unauthorized access to snapshots: If security is impacted with Microsoft.Compute.snapshots.write permission, it could potentially allow unauthorized users to create, modify, or delete snapshots of Azure Virtual Machines. This could lead to data breaches or unauthorized access to sensitive information stored within the snapshots.

2. Data loss or corruption: If security is compromised with Microsoft.Compute.snapshots.write permission, it could result in the accidental deletion or modification of snapshots. This can lead to data loss or corruption, impacting the availability and integrity of the virtual machine snapshots.

3. Privilege escalation: If security is impacted with Microsoft.Compute.snapshots.write permission, it could potentially allow an attacker to escalate their privileges within the Azure environment. They may be able to gain unauthorized access to other resources or perform actions that they are not authorized to perform, leading to further security breaches or unauthorized activities.

### Remediation

#### Using Console

To remediate unauthorized access to snapshots, data loss or corruption, and privilege escalation in Azure Virtual Machines using the Azure console, you can follow these steps:

1. Review and update access control: 
   - Navigate to the Azure portal and go to the Azure Virtual Machine resource.
   - Select "Access control (IAM)" from the left-hand menu.
   - Review the existing roles assigned to users or groups and ensure that the Microsoft.Compute.snapshots.write permission is only granted to authorized individuals or service principals.
   - Remove any unnecessary or unused permissions.

2. Enable Azure RBAC (Role-Based Access Control) for snapshots:
   - In the Azure portal, go to the Azure Virtual Machine resource.
   - Select "Access control (IAM)" from the left-hand menu.
   - Click on "Add" to assign a new role assignment.
   - Choose the appropriate role (e.g., Virtual Machine Contributor) and select the desired user or group.
   - Ensure that the Microsoft.Compute.snapshots.write permission is not granted to unauthorized users or groups.

3. Monitor and audit snapshot activities:
   - Enable Azure Monitor to track and analyze activities related to snapshots.
   - Configure alerts or notifications for any suspicious or unauthorized activities.
   - Regularly review the logs and audit reports to identify any potential security issues or anomalies.

By following these steps, you can mitigate the risks associated with unauthorized access, data loss or corruption, and privilege escalation in Azure Virtual Machine snapshots.

#### Using CLI

1. To remediate unauthorized access to snapshots in Azure Virtual Machines, you can follow these steps using Azure CLI commands:

- Identify the affected snapshots by listing all the snapshots in your Azure subscription:
  `az snapshot list`

- Remove the unauthorized access by revoking the Microsoft.Compute.snapshots.write permission from the unauthorized user or role:
  `az role assignment delete --assignee <assignee-id> --role "Microsoft.Compute.snapshots.write"`

- Regularly monitor and audit the access control settings for snapshots to ensure that only authorized users or roles have the necessary permissions.

2. To remediate the risk of data loss or corruption in Azure Virtual Machine snapshots, you can take the following actions using Azure CLI commands:

- Enable soft delete for snapshots to provide an additional layer of protection against accidental deletion:
  `az snapshot update --name <snapshot-name> --resource-group <resource-group-name> --set "properties.softDeleteEnabled=true"`

- Implement backup and disaster recovery strategies to ensure that you have multiple copies of your snapshots stored in different locations.

- Regularly test the restore process to validate the integrity and availability of your snapshots.

3. To mitigate the risk of privilege escalation in Azure Virtual Machines, you can use the following Azure CLI commands:

- Regularly review and update the role assignments for the Microsoft.Compute.snapshots.write permission to ensure that only authorized users or roles have the necessary privileges:
  `az role assignment list --role "Microsoft.Compute.snapshots.write"`

- Implement the principle of least privilege by granting only the minimum required permissions to users or roles.

- Enable Azure AD Privileged Identity Management (PIM) to provide just-in-time access to privileged roles and enforce approval workflows for elevation of privileges.

#### Using Python

To remediate unauthorized access to snapshots in Azure Virtual Machines, you can follow these steps using Python scripts:

1. Identify and remove unnecessary permissions: Use the Azure SDK for Python to retrieve the existing permissions for the snapshots. Filter out any unauthorized or unnecessary permissions associated with the Microsoft.Compute.snapshots.write permission. You can then use the Azure SDK to remove these permissions programmatically.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient

# Authenticate using default credentials
credential = DefaultAzureCredential()
compute_client = ComputeManagementClient(credential, subscription_id)

# Retrieve the existing permissions for the snapshots
snapshot_id = "<snapshot_id>"
permissions = compute_client.snapshots.list_permissions(resource_group_name, snapshot_id)

# Filter out unauthorized or unnecessary permissions
unauthorized_permissions = [p for p in permissions if p.role_name == "Microsoft.Compute.snapshots.write" and p.principal_id != "<authorized_principal_id>"]

# Remove unauthorized permissions
for permission in unauthorized_permissions:
    compute_client.snapshots.delete_permission(resource_group_name, snapshot_id, permission.principal_id)
```

2. Implement access controls: Ensure that only authorized users or roles have the Microsoft.Compute.snapshots.write permission. You can use the Azure SDK for Python to grant the necessary permissions to the authorized users or roles.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient

# Authenticate using default credentials
credential = DefaultAzureCredential()
compute_client = ComputeManagementClient(credential, subscription_id)

# Grant Microsoft.Compute.snapshots.write permission to authorized users or roles
snapshot_id = "<snapshot_id>"
principal_id = "<authorized_principal_id>"
compute_client.snapshots.grant_access(resource_group_name, snapshot_id, principal_id, duration_in_seconds)
```

3. Monitor and audit permissions: Regularly review and audit the permissions associated with the snapshots to detect any unauthorized changes. You can use the Azure SDK for Python to retrieve and analyze the permissions for the snapshots.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient

# Authenticate using default credentials
credential = DefaultAzureCredential()
compute_client = ComputeManagementClient(credential, subscription_id)

# Retrieve the existing permissions for the snapshots
snapshot_id = "<snapshot_id>"
permissions = compute_client.snapshots.list_permissions(resource_group_name, snapshot_id)

# Analyze the permissions for any unauthorized changes
for permission in permissions:
    if permission.role_name == "Microsoft.Compute.snapshots.write" and permission.principal_id != "<authorized_principal_id>":
        # Raise an alert or take appropriate action for unauthorized changes
        print("Unauthorized permission detected:", permission.principal_id)
```

These Python scripts utilize the Azure SDK for Python to programmatically manage permissions for Azure Virtual Machine snapshots.


 