--- 
slug: Microsoft.ClassicCompute.virtualMachines.write
eventname: Microsoft.ClassicCompute.virtualMachines.write
title: Microsoft.ClassicCompute.virtualMachines.write
sidebar_label: Microsoft.ClassicCompute.virtualMachines.write
---
                       
### Event Information

- The Microsoft.ClassicCompute.virtualMachines.write event in Azure for AzureVirtualMachines refers to a write operation performed on a virtual machine (VM) resource in the Classic deployment model.
- This event indicates that a change or modification has been made to the configuration or properties of a VM in the Classic deployment model.
- It could involve actions such as creating a new VM, updating the VM's size or settings, or deleting the VM from the Classic deployment model.


### Examples

1. Unauthorized creation of virtual machines: If security is impacted with Microsoft.ClassicCompute.virtualMachines.write permission, it means that an attacker can create virtual machines without proper authorization. This can lead to the deployment of malicious instances that can compromise the security of the Azure environment.

2. Unauthorized modification of virtual machines: With the Microsoft.ClassicCompute.virtualMachines.write permission, an attacker can modify the configuration of existing virtual machines without proper authorization. This can include changing network settings, disk configurations, or even injecting malicious code into the virtual machine's operating system.

3. Unauthorized deletion of virtual machines: Another security impact of Microsoft.ClassicCompute.virtualMachines.write permission is the ability to delete virtual machines without proper authorization. This can result in the loss of critical data and disruption of services running on those virtual machines. Additionally, an attacker may use this capability to cover their tracks after carrying out malicious activities within the virtual machines.

### Remediation

#### Using Console

To remediate unauthorized creation of virtual machines in Azure using the Azure console, follow these steps:

1. Review and update RBAC (Role-Based Access Control) permissions:
   - Identify the role or user assigned with the Microsoft.ClassicCompute.virtualMachines.write permission.
   - Remove or modify the permission to restrict unauthorized creation of virtual machines.
   - Ensure that only trusted individuals or roles have the necessary permissions to create virtual machines.

2. Implement Azure Policy:
   - Create a custom Azure Policy that denies the creation of virtual machines without proper authorization.
   - Assign the policy to the appropriate scope, such as a management group, subscription, or resource group.
   - This policy will enforce the restriction and prevent unauthorized creation of virtual machines.

3. Monitor and audit activity:
   - Enable Azure Monitor and Azure Security Center to monitor and detect any unauthorized attempts to create virtual machines.
   - Regularly review audit logs and security alerts to identify any suspicious activity related to virtual machine creation.
   - Take appropriate actions, such as investigating and blocking the source of unauthorized attempts.

By following these steps, you can effectively remediate the unauthorized creation of virtual machines in Azure and enhance the security of your environment.

#### Using CLI

1. To remediate unauthorized creation of virtual machines in Azure using Azure CLI commands, you can follow these steps:
   - Identify the role assignment or user/group that has the Microsoft.ClassicCompute.virtualMachines.write permission.
   - Revoke the permission by removing the role assignment or user/group from the appropriate role or access control list.
   - Use the following Azure CLI command to remove the role assignment:
     ```
     az role assignment delete --assignee <assignee> --role <role> --scope <scope>
     ```
     Replace `<assignee>` with the user or group's object ID, `<role>` with the appropriate role name, and `<scope>` with the scope where the permission was granted.

2. To remediate data exfiltration in Azure using Azure CLI commands, you can take the following actions:
   - Identify the role assignment or user/group that has the AzureVirtualMachines.write permission.
   - Revoke the permission by removing the role assignment or user/group from the appropriate role or access control list.
   - Use the following Azure CLI command to remove the role assignment:
     ```
     az role assignment delete --assignee <assignee> --role <role> --scope <scope>
     ```
     Replace `<assignee>` with the user or group's object ID, `<role>` with the appropriate role name, and `<scope>` with the scope where the permission was granted.

3. To remediate unauthorized modifications to virtual machines in Azure using Azure CLI commands, you can take the following steps:
   - Identify the role assignment or user/group that has the Microsoft.ClassicCompute.virtualMachines.write permission.
   - Revoke the permission by removing the role assignment or user/group from the appropriate role or access control list.
   - Use the following Azure CLI command to remove the role assignment:
     ```
     az role assignment delete --assignee <assignee> --role <role> --scope <scope>
     ```
     Replace `<assignee>` with the user or group's object ID, `<role>` with the appropriate role name, and `<scope>` with the scope where the permission was granted.

#### Using Python

To remediate unauthorized creation of virtual machines in Azure using Python scripts, you can follow these steps:

1. Identify and revoke unnecessary permissions: Review the existing role assignments and remove any users or groups that have the Microsoft.ClassicCompute.virtualMachines.write permission but do not require it for their tasks. This can be done using the Azure Management SDK for Python.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.authorization import AuthorizationManagementClient

credential = DefaultAzureCredential()
authorization_client = AuthorizationManagementClient(credential, <subscription_id>)

role_assignments = authorization_client.role_assignments.list()
for assignment in role_assignments:
    if assignment.role_definition_id == '<role_definition_id>':
        authorization_client.role_assignments.delete_by_id(assignment.id)
```

2. Enable Azure Policy: Create an Azure Policy that denies the creation of virtual machines without proper authorization. This policy can be assigned at the subscription or resource group level. You can use the Azure SDK for Python to create and assign the policy.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.resource import PolicyClient

credential = DefaultAzureCredential()
policy_client = PolicyClient(credential, <subscription_id>)

policy_definition = {
    "displayName": "Deny unauthorized creation of virtual machines",
    "policyType": "Custom",
    "mode": "All",
    "parameters": {},
    "policyRule": {
        "if": {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
        },
        "then": {
            "effect": "deny"
        }
    }
}

policy_client.policy_definitions.create_or_update('<policy_definition_id>', policy_definition)
policy_assignment = policy_client.policy_assignments.create('<policy_assignment_id>', {
    "policyDefinitionId": "<policy_definition_id>",
    "scope": "<subscription_or_resource_group_scope>"
})
```

3. Monitor and alert on unauthorized activities: Implement Azure Monitor to track any unauthorized creation of virtual machines. Set up alerts to notify the appropriate personnel when such activities are detected. This can be done using the Azure SDK for Python and Azure Monitor SDK.

```python
from azure.identity import DefaultAzureCredential
from azure.monitor.query import LogsQueryClient

credential = DefaultAzureCredential()
query_client = LogsQueryClient(credential)

query = "AzureActivity | where OperationName == 'Microsoft.Compute/virtualMachines/write' | project TimeGenerated, Caller, ResourceId"
response = query_client.query('<workspace_id>', query)

for result in response.tables[0].rows:
    time_generated = result[0]
    caller = result[1]
    resource_id = result[2]
    # Send alert/notification with the relevant information
```

These Python scripts demonstrate how to remediate unauthorized creation of virtual machines in Azure by revoking unnecessary permissions, enforcing Azure Policy, and monitoring for unauthorized activities.


 