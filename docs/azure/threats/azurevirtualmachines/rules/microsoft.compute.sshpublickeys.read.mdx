--- 
slug: Microsoft.Compute.sshPublicKeys.read
eventname: Microsoft.Compute.sshPublicKeys.read
title: Microsoft.Compute.sshPublicKeys.read
sidebar_label: Microsoft.Compute.sshPublicKeys.read
---
                       
### Event Information

- The Microsoft.Compute.sshPublicKeys.read event in Azure for AzureVirtualMachines refers to the action of reading the SSH public keys associated with a virtual machine in Azure.
- This event is triggered when someone or a process retrieves the SSH public keys for a specific virtual machine.
- It is important to monitor this event as it can help track who is accessing the SSH public keys and when, providing visibility into potential security risks or unauthorized access attempts.


### Examples

1. Unauthorized access: If security is impacted with Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines, it could potentially allow unauthorized individuals to read the SSH public keys associated with virtual machines. This could lead to unauthorized access to the virtual machines, compromising the confidentiality and integrity of the data stored within them.

2. Privilege escalation: If an attacker gains access to the SSH public keys through Microsoft.Compute.sshPublicKeys.read, they may be able to use this information to escalate their privileges within the virtual machine. This could allow them to perform actions that they are not authorized to do, potentially leading to further security breaches or unauthorized modifications to the system.

3. Key exposure: If the security of Microsoft.Compute.sshPublicKeys.read is compromised, it could result in the exposure of SSH public keys, which are used for authentication purposes. This could enable attackers to impersonate legitimate users or gain unauthorized access to other systems that rely on the compromised SSH keys. It is crucial to protect the confidentiality and integrity of SSH keys to prevent unauthorized access and maintain a secure environment.

### Remediation

#### Using Console

To remediate unauthorized access, privilege escalation, and key exposure related to Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines, you can follow these step-by-step instructions:

1. Monitor and review access controls:
   - Regularly review and update access controls for AzureVirtualMachines to ensure that only authorized individuals have access.
   - Use Azure RBAC (Role-Based Access Control) to assign appropriate roles and permissions to users and groups.
   - Implement just-in-time (JIT) access to limit the exposure of SSH keys and reduce the attack surface.

2. Enable Azure Security Center:
   - Enable Azure Security Center to get insights into the security posture of your Azure resources, including virtual machines.
   - Configure security policies and recommendations provided by Azure Security Center to detect and mitigate security risks related to unauthorized access and privilege escalation.
   - Continuously monitor and remediate security alerts generated by Azure Security Center.

3. Implement SSH key management best practices:
   - Regularly rotate SSH keys associated with AzureVirtualMachines to minimize the impact of key exposure.
   - Store SSH private keys securely and restrict access to authorized individuals.
   - Consider using Azure Key Vault to securely store and manage SSH keys.
   - Implement multi-factor authentication (MFA) for SSH access to add an extra layer of security.

By following these steps, you can mitigate the risks associated with unauthorized access, privilege escalation, and key exposure in Azure for AzureVirtualMachines.

#### Using CLI

1. To remediate unauthorized access related to Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines, you can take the following steps using Azure CLI commands:

- Identify the affected virtual machines: `az vm list --query "[?identity.type=='SystemAssigned']"`. This command will list all the virtual machines with system-assigned managed identity enabled.

- Disable SSH public key retrieval: `az vm update --ids <vm_id> --set identity.type=None`. Replace `<vm_id>` with the ID of the affected virtual machine. This command will disable the retrieval of SSH public keys through Microsoft.Compute.sshPublicKeys.read.

- Monitor and investigate: Continuously monitor the virtual machines for any unauthorized access attempts or suspicious activities. Use Azure Monitor and Azure Security Center to gain insights and take appropriate actions to mitigate any potential security risks.

2. To remediate privilege escalation related to Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines, you can follow these steps using Azure CLI commands:

- Review and update SSH public key access: `az vm show --ids <vm_id> --query "identity.principalId"`. Replace `<vm_id>` with the ID of the affected virtual machine. This command will retrieve the principal ID associated with the virtual machine.

- Limit SSH public key access: `az role assignment create --role "Virtual Machine Contributor" --assignee <principal_id> --scope <vm_id>`. Replace `<principal_id>` with the principal ID obtained from the previous step and `<vm_id>` with the ID of the affected virtual machine. This command will limit the SSH public key access to only authorized individuals.

- Regularly review and update role assignments: Continuously review and update the role assignments to ensure that only necessary privileges are granted to users or service principals. Remove any unnecessary or excessive privileges to minimize the risk of privilege escalation.

3. To remediate key exposure related to Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines, you can take the following steps using Azure CLI commands:

- Rotate SSH keys: Generate new SSH key pairs for the affected virtual machines using a secure method. Ensure that the private keys are securely stored and the public keys are updated on the virtual machines.

- Update SSH public keys: `az vm update --ids <vm_id> --set "osProfile.linuxConfiguration.ssh.publicKeys=[{path='/home/<username>/.ssh/authorized_keys', keyData='<new_public_key>'}]`. Replace `<vm_id>` with the ID of the affected virtual machine, `<username>` with the appropriate username, and `<new_public_key>` with the new SSH public key. This command will update the SSH public key associated with the virtual machine.

- Monitor and audit SSH key usage: Implement logging and monitoring mechanisms to track SSH key usage and detect any unauthorized access attempts. Regularly review the logs and audit trails to identify any suspicious activities related to SSH key usage.

#### Using Python

To remediate unauthorized access, privilege escalation, and key exposure related to Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines, you can follow these steps using Python scripts:

1. Regularly monitor and review access controls: Implement a script that periodically checks the access controls for Microsoft.Compute.sshPublicKeys.read. Ensure that only authorized individuals or services have the necessary permissions to read SSH public keys associated with virtual machines.

```python
import os
from azure.identity import DefaultAzureCredential
from azure.mgmt.authorization import AuthorizationManagementClient

def check_access_controls():
    subscription_id = os.environ["AZURE_SUBSCRIPTION_ID"]
    credential = DefaultAzureCredential()
    auth_client = AuthorizationManagementClient(credential, subscription_id)

    # Get the role assignments for Microsoft.Compute.sshPublicKeys.read
    role_assignments = auth_client.role_assignments.list(
        filter="roleDefinitionId eq '/providers/Microsoft.Authorization/roleDefinitions/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'"
    )

    # Check if any unauthorized assignments exist
    unauthorized_assignments = [assignment for assignment in role_assignments if not is_authorized(assignment)]

    if unauthorized_assignments:
        # Take appropriate actions to remove unauthorized assignments
        ...

def is_authorized(assignment):
    # Implement logic to determine if the assignment is authorized
    ...

check_access_controls()
```

2. Implement strong authentication mechanisms: Ensure that SSH keys used for authentication are properly managed and protected. Use strong encryption algorithms and regularly rotate SSH keys to minimize the risk of key exposure.

```python
import os
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient

def rotate_ssh_keys():
    subscription_id = os.environ["AZURE_SUBSCRIPTION_ID"]
    credential = DefaultAzureCredential()
    compute_client = ComputeManagementClient(credential, subscription_id)

    # Get the list of virtual machines
    virtual_machines = compute_client.virtual_machines.list_all()

    for vm in virtual_machines:
        # Generate new SSH key pair
        new_ssh_public_key, new_ssh_private_key = generate_ssh_key_pair()

        # Update the virtual machine with the new SSH public key
        compute_client.virtual_machines.update(
            resource_group_name=vm.resource_group,
            vm_name=vm.name,
            parameters={
                "osProfile": {
                    "linuxConfiguration": {
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "/home/<username>/.ssh/authorized_keys",
                                    "keyData": new_ssh_public_key
                                }
                            ]
                        }
                    }
                }
            }
        )

def generate_ssh_key_pair():
    # Implement logic to generate a new SSH key pair
    ...

rotate_ssh_keys()
```

3. Enable auditing and monitoring: Implement a script that enables auditing and monitoring for Microsoft.Compute.sshPublicKeys.read operations. This will help detect any unauthorized access attempts or suspicious activities related to SSH public keys.

```python
import os
from azure.identity import DefaultAzureCredential
from azure.mgmt.monitor import MonitorManagementClient

def enable_monitoring():
    subscription_id = os.environ["AZURE_SUBSCRIPTION_ID"]
    credential = DefaultAzureCredential()
    monitor_client = MonitorManagementClient(credential, subscription_id)

    # Enable auditing for Microsoft.Compute.sshPublicKeys.read
    monitor_client.diagnostic_settings.create_or_update(
        resource_uri="subscriptions/<subscription_id>/providers/Microsoft.Compute/virtualMachines",
        name="ssh-public-keys-audit",
        parameters={
            "logs": [
                {
                    "category": "Administrative",
                    "enabled": True
                }
            ]
        }
    )

enable_monitoring()
```

These Python scripts provide a starting point for remediating unauthorized access, privilege escalation, and key exposure related to Microsoft.Compute.sshPublicKeys.read in Azure for AzureVirtualMachines. However, it is important to customize and adapt these scripts based on your specific requirements and environment.


 