--- 
slug: Microsoft.Compute.snapshots.delete
eventname: Microsoft.Compute.snapshots.delete
title: Microsoft.Compute.snapshots.delete
sidebar_label: Microsoft.Compute.snapshots.delete
---
                       
### Event Information

#### Meaning

- The Microsoft.Compute.snapshots.delete event in Azure for AzureVirtualMachines refers to the deletion of a snapshot associated with a virtual machine in the Azure Compute service.
- This event indicates that a user or an automated process has initiated the deletion of a snapshot, which is a point-in-time copy of a virtual machine's disk.
- The event signifies that the snapshot has been successfully deleted and any associated resources, such as backup data or recovery points, may also be removed.

Note: It is important to consider the implications of deleting a snapshot, as it may impact data recovery options and backup strategies for the virtual machine.

### Remediation

#### Using Console

- Example: If security is impacted with Microsoft.Compute.snapshots.delete in Azure for Azure Virtual Machines, it means that an unauthorized user or process has the ability to delete snapshots of virtual machines, potentially leading to data loss or unauthorized access to sensitive information.

- Remediation steps using the Azure console:
  1. Identify the affected Azure Virtual Machines: Use the Azure portal or Azure CLI to list all the virtual machines in your subscription.
  2. Review and update access control: Ensure that only authorized users or processes have the necessary permissions to delete snapshots. This can be done by modifying the role-based access control (RBAC) settings for the affected resources.
  3. Enable auditing and monitoring: Set up Azure Monitor or Azure Security Center to monitor and alert on any suspicious activities related to snapshot deletion. This will help in detecting and responding to any security incidents in a timely manner.

Note: The specific steps may vary depending on the Azure portal version and the RBAC settings in your environment. It is recommended to consult the Azure documentation or seek assistance from Azure support for detailed instructions tailored to your specific scenario.

#### Using CLI

- Example: If security is impacted with `Microsoft.Compute.snapshots.delete` in Azure for `AzureVirtualMachines`, it means that unauthorized users or processes have the ability to delete snapshots of virtual machines, potentially leading to data loss or unauthorized access to sensitive information.

- Remediation for AZU `AzureVirtualMachines` using AZU CLI:
  1. Grant the necessary permissions: Ensure that only authorized users or processes have the permission to delete snapshots. This can be achieved by assigning the appropriate RBAC roles to the users or service principals. For example, the `Contributor` role can be assigned to allow snapshot deletion.
  2. Enable auditing and monitoring: Implement auditing and monitoring mechanisms to track any deletion activities related to snapshots. This can be done using Azure Monitor or Azure Security Center. Configure alerts or notifications to be triggered when any unauthorized deletion attempts are detected.
  3. Implement backup and recovery strategies: To mitigate the impact of accidental or malicious snapshot deletions, regularly backup the virtual machines or their snapshots. This ensures that in case of any deletion, the data can be restored from the backups.

CLI commands:
- Granting RBAC role:
  ```
  az role assignment create --assignee <principal-id> --role Contributor --scope /subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.Compute/snapshots/<snapshot-name>
  ```

- Enabling auditing and monitoring:
  ```
  az monitor diagnostic-settings create --name <diagnostic-settings-name> --resource /subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.Compute/snapshots/<snapshot-name> --logs '[{"category": "Delete", "enabled": true}]'
  ```

- Implementing backup and recovery:
  ```
  az backup protection enable-for-vm --resource-group <resource-group> --vault-name <vault-name> --vm <vm-name> --policy-name <policy-name>
  ```

#### Using Python

Example of security impact: If an unauthorized user gains access to the Azure subscription and deletes snapshots of Azure Virtual Machines using the `Microsoft.Compute.snapshots.delete` action, it can result in data loss and potential disruption of services.

Remediation for AZU AzureVirtualMachines using Python:

1. Implement RBAC (Role-Based Access Control): Ensure that proper RBAC roles and permissions are assigned to users and service principals. Limit the access to the `Microsoft.Compute.snapshots.delete` action only to authorized individuals or groups.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.authorization import AuthorizationManagementClient
from azure.mgmt.authorization.models import RoleAssignmentCreateParameters

# Authenticate using DefaultAzureCredential or any other suitable method
credential = DefaultAzureCredential()

# Create an instance of the AuthorizationManagementClient
authorization_client = AuthorizationManagementClient(credential, subscription_id)

# Define the scope at which the role assignment should be applied
scope = "/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.Compute/snapshots/{snapshot_name}"

# Define the role assignment parameters
role_assignment_params = RoleAssignmentCreateParameters(
    role_definition_id="/subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{role_definition_id}",
    principal_id="/subscriptions/{subscription_id}/providers/Microsoft.Azure.ActiveDirectory/users/{user_id}",
    scope=scope
)

# Create the role assignment
authorization_client.role_assignments.create(scope, role_assignment_params)
```

2. Enable Azure Monitor for monitoring and alerting: Set up Azure Monitor to track and alert on any deletion activities related to snapshots. Create a log alert that triggers when the `Microsoft.Compute.snapshots.delete` action is performed, and configure it to send notifications to the appropriate stakeholders.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.monitor import MonitorManagementClient
from azure.mgmt.monitor.models import AlertRuleResource

# Authenticate using DefaultAzureCredential or any other suitable method
credential = DefaultAzureCredential()

# Create an instance of the MonitorManagementClient
monitor_client = MonitorManagementClient(credential, subscription_id)

# Define the alert rule parameters
alert_rule_params = AlertRuleResource(
    location="global",
    description="Alert for snapshot deletion",
    severity=2,
    enabled=True,
    condition={
        "odata.type": "Microsoft.Azure.Management.Monitor.Models.ThresholdRuleCondition",
        "dataSource": {
            "odata.type": "Microsoft.Azure.Management.Monitor.Models.RuleMetricDataSource",
            "resourceUri": "/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.Compute/snapshots/{snapshot_name}",
            "metricName": "DeleteRequests",
            "aggregation": {
                "odata.type": "Microsoft.Azure.Management.Monitor.Models.AggregationType",
                "type": "Total"
            }
        },
        "threshold": 1,
        "windowSize": "PT5M",
        "operator": "GreaterThan"
    },
    actions=[
        {
            "odata.type": "Microsoft.Azure.Management.Monitor.Models.RuleEmailAction",
            "sendToServiceOwners": True
        }
    ]
)

# Create the alert rule
monitor_client.alert_rules.create_or_update("{resource_group}", "{alert_rule_name}", alert_rule_params)
```

3. Implement Azure Policy: Create an Azure Policy that enforces the requirement for RBAC roles and permissions on the `Microsoft.Compute.snapshots.delete` action. This policy can be assigned at the subscription or resource group level to ensure compliance.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.resource import PolicyClient
from azure.mgmt.resource.models import PolicyAssignment

# Authenticate using DefaultAzureCredential or any other suitable method
credential = DefaultAzureCredential()

# Create an instance of the PolicyClient
policy_client = PolicyClient(credential, subscription_id)

# Define the policy assignment parameters
policy_assignment_params = PolicyAssignment(
    display_name="Restrict snapshot deletion",
    policy_definition_id="/subscriptions/{subscription_id}/providers/Microsoft.Authorization/policyDefinitions/{policy_definition_id}",
    scope="/subscriptions/{subscription_id}/resourceGroups/{resource_group}"
)

# Create the policy assignment
policy_client.policy_assignments.create("{policy_assignment_name}", policy_assignment_params)
```

Note: Replace the placeholders `{subscription_id}`, `{resource_group}`, `{snapshot_name}`, `{role_definition_id}`, `{user_id}`, `{alert_rule_name}`, `{policy_definition_id}`, and `{policy_assignment_name}` with the appropriate values specific to your environment.


 