--- 
slug: Microsoft.Compute.sshPublicKeys.delete
eventname: Microsoft.Compute.sshPublicKeys.delete
title: Microsoft.Compute.sshPublicKeys.delete
sidebar_label: Microsoft.Compute.sshPublicKeys.delete
---
                       
### Event Information

#### Meaning

- The Microsoft.Compute.sshPublicKeys.delete event in Azure for AzureVirtualMachines indicates that a SSH public key has been deleted for a virtual machine.
- This event signifies that the access to the virtual machine via SSH using the deleted public key will no longer be possible.
- It is important to monitor this event to ensure that the deletion of SSH public keys is intentional and authorized, and to track any changes made to the SSH access configuration for virtual machines.

### Remediation

#### Using Console

- Example: If security is impacted with Microsoft.Compute.sshPublicKeys.delete in Azure for Azure Virtual Machines, it means that an attacker can delete the SSH public keys associated with a virtual machine, potentially gaining unauthorized access to the machine.

To remediate this issue for Azure Virtual Machines using the Azure console, you can follow these step-by-step instructions:

1. Sign in to the Azure portal (https://portal.azure.com) using your Azure account credentials.
2. Navigate to the Azure Virtual Machines service.
3. Select the virtual machine for which you want to remediate the security issue.
4. In the left-hand menu, under the "Settings" section, click on "Identity".
5. In the "System assigned" tab, toggle the switch to enable the system-assigned managed identity for the virtual machine.
6. Click on "Save" to apply the changes.
7. Navigate to the Azure Active Directory service.
8. In the left-hand menu, click on "App registrations".
9. Click on "New registration" to create a new application registration.
10. Provide a name for the application and select the appropriate account type.
11. Under the "Redirect URI" section, select the appropriate URI or leave it blank if not required.
12. Click on "Register" to create the application registration.
13. Once the registration is complete, navigate to the "Certificates & secrets" section.
14. Click on "New client secret" to generate a new client secret.
15. Provide a description for the secret and select an appropriate expiration period.
16. Click on "Add" to generate the client secret.
17. Copy the generated client secret value and securely store it.
18. Go back to the Azure Virtual Machines service and select the virtual machine again.
19. In the left-hand menu, under the "Settings" section, click on "Access control (IAM)".
20. Click on "Add" to add a new role assignment.
21. Select the appropriate role (e.g., "Contributor") and search for the application registration created earlier.
22. Select the application registration and click on "Save" to assign the role.
23. Finally, update your application or scripts to use the client secret for authentication instead of SSH public keys.

By following these steps, you will remediate the security issue by enabling a system-assigned managed identity for the virtual machine and using a client secret for authentication instead of relying on SSH public keys.

#### Using CLI

- The security impact of using `Microsoft.Compute.sshPublicKeys.delete` in Azure for Azure Virtual Machines is that it allows the deletion of SSH public keys associated with the virtual machine, potentially compromising the authentication and access control of the VM.
- To remediate this security issue for Azure Virtual Machines using Azure CLI, you can follow these steps:
  1. Identify the affected virtual machine by its resource group and name.
  2. Retrieve the existing SSH public keys associated with the virtual machine using the `az vm show` command.
  3. Add the necessary SSH public keys back to the virtual machine using the `az vm update` command, ensuring that the appropriate access control and authentication measures are in place.

Example CLI commands:
```
# Step 1: Identify the affected virtual machine
az vm show --resource-group <resource-group-name> --name <virtual-machine-name>

# Step 2: Retrieve existing SSH public keys
az vm show --resource-group <resource-group-name> --name <virtual-machine-name> --query 'osProfile.sshPublicKeys'

# Step 3: Add SSH public keys back to the virtual machine
az vm update --resource-group <resource-group-name> --name <virtual-machine-name> --set 'osProfile.sshPublicKeys=<ssh-public-keys>'
```
Note: Replace `<resource-group-name>`, `<virtual-machine-name>`, and `<ssh-public-keys>` with the actual values specific to your environment.

#### Using Python

1. Example of security impact: If an unauthorized user gains access to the Azure Virtual Machine's SSH public keys and deletes them using the `Microsoft.Compute.sshPublicKeys.delete` action, they can effectively remove the authorized SSH keys and potentially gain unauthorized access to the virtual machine.

2. Remediation for Azure Virtual Machines using Python:
   - Use Azure SDK for Python (azure-mgmt-compute) to manage Azure Virtual Machines.
   - To remediate the security impact, you can implement a script that periodically checks the SSH public keys associated with the virtual machine and restores them if they are missing or have been deleted.
   - Here's an example Python script that uses the Azure SDK for Python to restore the SSH public keys for an Azure Virtual Machine:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient

# Set your Azure subscription ID and resource group name
subscription_id = '<your-subscription-id>'
resource_group_name = '<your-resource-group-name>'
vm_name = '<your-vm-name>'

# Create a credential object using default Azure credentials
credential = DefaultAzureCredential()

# Create a ComputeManagementClient object
compute_client = ComputeManagementClient(credential, subscription_id)

# Get the virtual machine
virtual_machine = compute_client.virtual_machines.get(resource_group_name, vm_name)

# Check if SSH public keys are missing or deleted
if not virtual_machine.os_profile.linux_configuration.ssh.public_keys:
    # Restore the SSH public keys
    virtual_machine.os_profile.linux_configuration.ssh.public_keys = [
        {
            'path': '/home/<your-username>/.ssh/authorized_keys',
            'key_data': '<your-ssh-public-key>'
        }
    ]

    # Update the virtual machine
    compute_client.virtual_machines.create_or_update(resource_group_name, vm_name, virtual_machine)
```

Note: Replace `<your-subscription-id>`, `<your-resource-group-name>`, `<your-vm-name>`, `<your-username>`, and `<your-ssh-public-key>` with the appropriate values for your environment.


 