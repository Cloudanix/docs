---
slug: azure_audit_appservice_managed_service_identities_disabled
title: Managed Service Identities Disabled
sidebar_label: Managed Service Identities Disabled
---

### More Info:

Managed service identity in App Service makes the app more secure by eliminating secrets from the app, such as credentials in the connection strings. When registering with Azure Active Directory in the app service, the app will connect to other Azure services securely without the need of username and passwords.

### Risk Level

Medium

### Address

Security

### Compliance Standards

SOC2, HIPAA, CISAZURE, CBP, HITRUST, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your credentials.
2. Navigate to the "App Services" section from the left-hand side menu.
3. Select the specific App Service you want to check.
4. In the App Service's dashboard, look for the "Identity" option under the "Settings" section.
5. Check the status of the "System Assigned" or "User Assigned" Managed Service Identity. If it is turned off or not assigned, then Managed Service Identities are disabled for that App Service.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI, you need to install it on your local machine. You can download it from the official Microsoft Azure website. After installation, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the Azure login page in your web browser.
   ```
   az login
   ```
3. List App Services: Use the following command to list all the App Services in your Azure account. This will return a JSON object with all the App Services.
   ```
   az webapp list --query "[].{name:name, resourceGroup:resourceGroup}"
   ```
4. Check Managed Service Identities: For each App Service, use the following command to check if Managed Service Identities are disabled. Replace `<app_name>` and `<resource_group>` with the name and resource group of your App Service respectively. If the `identity` field in the output is `null`, it means Managed Service Identities are disabled.
   ```
   az webapp identity show --name <app_name> --resource-group <resource_group>
   ```

#### Using Python

Managed Service Identities (MSI) is a feature in Azure that provides Azure services with an automatically managed identity in Azure Active Directory. You can use this identity to authenticate to any service that supports Azure AD authentication without having any credentials in your code.

Here are the steps to detect if Managed Service Identities are disabled in App Service using Python scripts:

1. Install Azure SDK for Python: Azure SDK for Python is a set of libraries that allow you to work with Azure services like Azure Storage, Azure Cosmos DB, etc. You can install it using pip:

   ```python
   pip install azure
   ```

2. Import necessary libraries and establish a connection: Import the necessary libraries and establish a connection with Azure. You will need to authenticate using your Azure credentials.

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.resource import ResourceManagementClient
   from azure.mgmt.web import WebSiteManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id' # replace with your Azure subscription id
   resource_client = ResourceManagementClient(credential, subscription_id)
   web_client = WebSiteManagementClient(credential, subscription_id)
   ```

3. Get the list of all App Services: Use the `web_client` object to get the list of all App Services in your subscription.

   ```python
   for item in web_client.web_apps.list():
       print(item.name)
   ```

4. Check if Managed Service Identities are disabled: For each App Service, check if the Managed Service Identity is disabled. If the `identity` attribute is `None`, it means that MSI is disabled.

   ```python
   for item in web_client.web_apps.list():
       if item.identity is None:
           print(f"Managed Service Identity is disabled for {item.name}")
       else:
           print(f"Managed Service Identity is enabled for {item.name}")
   ```

This script will print the names of all App Services and whether MSI is enabled or disabled for each one.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Managed Service Identities Disabled" misconfiguration in Azure using the Azure console, please follow these steps:

1. Open the Azure portal and navigate to the resource group containing the affected Azure service.

2. Click on the affected Azure service, and then click on the "Access control (IAM)" menu option.

3. Click on the "Add" button to add a new role assignment.

4. In the "Add role assignment" blade, select "Contributor" as the role and then select the "Azure resource" option.

5. In the "Select" box, search for the name of the affected Azure service and select it.

6. Leave the "Assign access to" field as "Azure AD user, group, or service principal" and then click on the "Select" button.

7. In the "Select" box, search for the name of the managed identity that needs to be enabled and select it.

8. Click on the "Save" button to save the role assignment.

9. Verify that the managed identity is now enabled by checking the "Managed identities" blade of the affected Azure service.

10. Repeat this process for any other affected Azure services.

By following these steps, you can remediate the "Managed Service Identities Disabled" misconfiguration in Azure using the Azure console.

#### Using CLI

To remediate the "Managed Service Identities Disabled" misconfiguration in Azure using Azure CLI, you can follow these steps:

1. Open the Azure CLI and log in to your Azure account using the command `az login`.

2. Check if Managed Service Identity is enabled for your Azure subscription using the command `az account show --query "isIdentityCrmEnabled"`. If the output is `false`, it means Managed Service Identity is disabled for your subscription.

3. To enable Managed Service Identity for your subscription, use the command `az provider register --namespace Microsoft.ManagedIdentity`.

4. After the registration is complete, you can create a new Managed Service Identity using the command `az identity create --name <identity-name> --resource-group <resource-group-name>`.

5. Once the Managed Service Identity is created, you can assign it to your Azure resources using the command `az role assignment create --role <role-name> --assignee <identity-client-id> --scope <resource-id>`.

6. Replace `<identity-name>`, `<resource-group-name>`, `<role-name>`, `<identity-client-id>` and `<resource-id>` with the actual values for your Azure environment.

7. Finally, verify that Managed Service Identity is enabled for your subscription and that the identity is assigned to the correct resources using the command `az identity show --name <identity-name> --resource-group <resource-group-name>`.

By following these steps, you should be able to remediate the "Managed Service Identities Disabled" misconfiguration in Azure using Azure CLI.

#### Using Python

To remediate the "Managed Service Identities Disabled" misconfiguration in Azure using Python, follow these steps:

1. Import the necessary libraries:

```python
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.authorization import AuthorizationManagementClient
from azure.common.credentials import ServicePrincipalCredentials
```

2. Set the credentials for your Azure account:

```python
subscription_id = 'your-subscription-id'
tenant_id = 'your-tenant-id'
client_id = 'your-client-id'
client_secret = 'your-client-secret'

credentials = ServicePrincipalCredentials(
    client_id=client_id,
    secret=client_secret,
    tenant=tenant_id
)
```

3. Create a ResourceManagementClient and an AuthorizationManagementClient:

```python
resource_client = ResourceManagementClient(credentials, subscription_id)
auth_client = AuthorizationManagementClient(credentials, subscription_id)
```

4. Get the list of resource groups in your subscription:

```python
resource_groups = resource_client.resource_groups.list()
```

5. For each resource group, check if managed service identities are enabled for all resources:

```python
for rg in resource_groups:
    rg_name = rg.name
    rg_id = rg.id

    # Check if managed service identities are enabled for all resources in the resource group
    permissions = auth_client.permissions.list_by_resource_group(rg_name)

    for perm in permissions:
        if perm.name == 'Microsoft.ManagedIdentity/userAssignedIdentities':
            if perm.actions == ['*/read']:
                print(f"Managed service identities are enabled for all resources in resource group {rg_name}")
            else:
                print(f"Managed service identities are not enabled for all resources in resource group {rg_name}")
```

6. If managed service identities are not enabled for all resources in a resource group, enable them:

```python
for rg in resource_groups:
    rg_name = rg.name
    rg_id = rg.id

    # Check if managed service identities are enabled for all resources in the resource group
    permissions = auth_client.permissions.list_by_resource_group(rg_name)

    for perm in permissions:
        if perm.name == 'Microsoft.ManagedIdentity/userAssignedIdentities':
            if perm.actions != ['*/read']:
                print(f"Enabling managed service identities for all resources in resource group {rg_name}")
                auth_client.permissions.create_or_update(
                    rg_name,
                    'Microsoft.ManagedIdentity/userAssignedIdentities',
                    {
                        'actions': [
                            'Microsoft.ManagedIdentity/userAssignedIdentities/read',
                            'Microsoft.ManagedIdentity/userAssignedIdentities/write',
                            'Microsoft.ManagedIdentity/userAssignedIdentities/delete',
                            'Microsoft.ManagedIdentity/userAssignedIdentities/assign/action'
                        ]
                    }
                )
```

These steps will enable managed service identities for all resources in all resource groups in your Azure subscription using Python.

### Additional Reading:

- [https://docs.microsoft.com/en-gb/azure/app-service/app-service-web-tutorial-connect-msi](https://docs.microsoft.com/en-gb/azure/app-service/app-service-web-tutorial-connect-msi) 


</Tab>
</Tabs>