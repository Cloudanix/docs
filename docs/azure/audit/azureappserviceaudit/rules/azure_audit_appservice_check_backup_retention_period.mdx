---
slug: azure_audit_appservice_check_backup_retention_period
title: Check for Sufficient Backup Retention Period
sidebar_label: Check for Sufficient Backup Retention Period
---

### More Info:

Ensure there is a sufficient backup retention period configured for Azure App Services applications.

### Risk Level

Medium 

### Address

Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal and navigate to the App Services.
2. Select the App Service for which you want to check the backup retention period.
3. In the left-hand menu, under the 'Settings' section, click on 'Backups'.
4. In the 'Backup Configuration' section, you can see the 'Retention Period (Days)'. This shows the number of days the backups are retained. If the retention period is not sufficient as per your requirement, it indicates a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft website. Once installed, open your command prompt or terminal and type `az --version` to confirm that it's installed correctly.

2. Login to Azure: Use the command `az login` to log in to your Azure account. This will open a new browser window asking for your Azure credentials. Once you've logged in, the terminal or command prompt will display a JSON output with your account details.

3. Select the Subscription: If you have multiple subscriptions, you need to select the one where your App Service is located. Use the command `az account set --subscription "my-subscription-name"` to set the active subscription.

4. Check Backup Retention Period: Use the command `az webapp config backup list --resource-group MyResourceGroup --webapp-name MyAppName --query "[].retentionPeriodInDays"` to check the backup retention period of your App Service. This command will return a list of all backups for the specified App Service along with their retention periods in days. If the retention period is less than your organization's policy, then it's a misconfiguration.

#### Using Python

To check for sufficient backup retention period in Azure App Service using Python scripts, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: You can install the Azure SDK for Python using pip. Run the following command in your terminal:

   ```bash
   pip install azure-mgmt-web
   ```

2. **Authenticate to Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for Python to authenticate. Here is an example:

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.resource import ResourceManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   client = ResourceManagementClient(credential, subscription_id)
   ```

3. **Get the App Service Backup Configuration**: You can use the `WebSiteManagementClient` from the Azure SDK for Python to get the backup configuration of an App Service. Here is an example:

   ```python
   from azure.mgmt.web import WebSiteManagementClient

   web_client = WebSiteManagementClient(credential, subscription_id)
   resource_group_name = 'your-resource-group-name'
   app_service_name = 'your-app-service-name'
   backup_configuration = web_client.backup_policies.get(resource_group_name, app_service_name)
   ```

4. **Check the Backup Retention Period**: The backup configuration object has a `retention_period_in_days` property that you can check to see if it is sufficient. Here is an example:

   ```python
   retention_period = backup_configuration.retention_period_in_days
   if retention_period < 30:  # replace 30 with your desired retention period
       print(f'Insufficient backup retention period: {retention_period} days')
   else:
       print(f'Sufficient backup retention period: {retention_period} days')
   ```

Remember to replace `'your-subscription-id'`, `'your-resource-group-name'`, and `'your-app-service-name'` with your actual Azure subscription ID, resource group name, and App Service name.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration of "Sufficient Backup Retention Period" in Azure using the Azure console:

1. Log in to the Azure portal (https://portal.azure.com/).
2. In the left-hand menu, click on "Recovery Services vaults".
3. Select the recovery services vault that you want to remediate.
4. Click on the "Backup policy" option in the left-hand menu.
5. In the "Backup policy" page, click on the "Edit" button.
6. In the "Backup policy" editor, click on the "Retention" tab.
7. In the "Retention" tab, set the retention period to the desired value.
8. Click on the "Save" button to save the changes.

By following these steps, you will remediate the misconfiguration of "Sufficient Backup Retention Period" in Azure using the Azure console.

#### Using CLI

To remediate the misconfiguration of insufficient backup retention period in AZURE using AZURE CLI, follow the below steps:

1. Open the Azure CLI in your terminal or command prompt.

2. Run the following command to check the current retention period for backups:

   ```az backup policy show --name <backup-policy-name> --resource-group <resource-group-name> --vault-name <vault-name>```

   Replace `<backup-policy-name>`, `<resource-group-name>` and `<vault-name>` with the actual names of your backup policy, resource group and vault respectively.

3. Check the `retentionPolicy` object in the output to see the current retention period.

4. Run the following command to update the retention period to the desired value:

   ```az backup policy set --name <backup-policy-name> --resource-group <resource-group-name> --vault-name <vault-name> --retention-days <number-of-days>```

   Replace `<backup-policy-name>`, `<resource-group-name>`, `<vault-name>` and `<number-of-days>` with the actual names of your backup policy, resource group, vault and the desired number of retention days respectively.

5. Verify that the retention period has been updated by running the command in step 2 again and checking the `retentionPolicy` object in the output.

6. Repeat steps 2-5 for all backup policies in your Azure environment to ensure that all backups have sufficient retention periods.

By following these steps, you can remediate the misconfiguration of insufficient backup retention period in AZURE using AZURE CLI.

#### Using Python

To remediate the misconfiguration of insufficient backup retention period in Azure using Python, you can follow the below steps:

1. Import the required libraries for Azure authentication and management:
```
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.recoveryservicesbackup import RecoveryServicesBackupClient
from azure.mgmt.recoveryservicesbackup.models import ProtectionPolicyResource
```

2. Authenticate with Azure using Service Principal credentials:
```
credentials = ServicePrincipalCredentials(
    client_id='<client-id>',
    secret='<client-secret>',
    tenant='<tenant-id>'
)
```

3. Instantiate a `RecoveryServicesBackupClient` object using the credentials:
```
client = RecoveryServicesBackupClient(credentials, '<subscription-id>')
```

4. Get the list of backup protection policies:
```
policies = client.protection_policies.list('<resource-group-name>', '<vault-name>')
```

5. For each policy, check if the retention period is sufficient:
```
for policy in policies:
    if policy.backup_management_type == 'AzureIaasVM':
        if policy.recovery_points_retention_period == 30:
            policy.recovery_points_retention_period = 60
            client.protection_policies.create_or_update('<resource-group-name>', '<vault-name>', policy.name, policy)
```

6. If the retention period is not sufficient (in this case, 30 days), update the policy with a new retention period (in this case, 60 days):
```
policy.recovery_points_retention_period = 60
client.protection_policies.create_or_update('<resource-group-name>', '<vault-name>', policy.name, policy)
```

7. Save the updated policy:
```
client.protection_policies.create_or_update('<resource-group-name>', '<vault-name>', policy.name, policy)
```

By following these steps, you can remediate the misconfiguration of insufficient backup retention period in Azure using Python.



</Tab>
</Tabs>