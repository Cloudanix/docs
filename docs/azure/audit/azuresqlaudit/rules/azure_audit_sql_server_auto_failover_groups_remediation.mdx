

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your Azure account credentials.

2. Navigate to the SQL servers section. Here, you will find a list of all the SQL servers that are currently running in your Azure environment.

3. Select the SQL server for which you want to check the Auto-Failover Groups configuration. This will open the SQL server dashboard.

4. In the SQL server dashboard, look for the "Failover groups" option in the menu on the left side. Click on it to see the current configuration. If Auto-Failover is enabled, you will see it listed here. If not, then it means that Auto-Failover Groups are not enabled for this server.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have it installed on your system. You can download it from the official Microsoft Azure website and follow the installation instructions.

2. Login to Azure: Open your command line interface and type the following command to login to your Azure account:
   ```
   az login
   ```
   Follow the prompts in your browser to complete the authentication process.

3. Select the Subscription: If you have multiple subscriptions, you need to select the one where your SQL Server is located. Use the following command to list all your subscriptions:
   ```
   az account list --output table
   ```
   Then, use the following command to set your desired subscription as the active one:
   ```
   az account set --subscription "Your Subscription Name"
   ```

4. Check Auto-Failover Groups: Now, you can check the status of Auto-Failover Groups for your SQL Server. Use the following command to list all the failover groups in your SQL Server:
   ```
   az sql failover-group list --server "Your Server Name" --resource-group "Your Resource Group Name"
   ```
   This command will return a JSON output with the details of all the failover groups in your SQL Server. Look for the "autoFailover" property in the output. If its value is "Enabled", then Auto-Failover Groups are enabled for your SQL Server. If its value is "Disabled", then Auto-Failover Groups are not enabled.

#### Using Python

To check if Auto-Failover Groups are enabled by server in SQL using Python scripts, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: If you haven't installed it yet, you can do so by running the following command in your terminal:
   ```
   pip install azure-mgmt-sql
   ```
2. **Import Required Libraries**: Import the necessary libraries in your Python script. You will need the `Credential` from `azure.identity` and `SqlManagementClient` from `azure.mgmt.sql`.
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.sql import SqlManagementClient
   ```
3. **Authenticate and Initialize**: Authenticate to your Azure account and initialize the SqlManagementClient. Replace `subscription_id` with your actual Azure subscription ID.
   ```python
   credential = DefaultAzureCredential()
   sql_client = SqlManagementClient(credential, subscription_id)
   ```
4. **Check Auto-Failover Groups**: Now, you can use the `sql_client` to list all the servers and check if Auto-Failover Groups are enabled. Replace `resource_group` with your actual resource group name.
   ```python
   for server in sql_client.servers.list_by_resource_group(resource_group):
       failover_groups = sql_client.failover_groups.list_by_server(resource_group, server.name)
       for failover_group in failover_groups:
           print(f"Server: {server.name}, Failover Group: {failover_group.name}, Auto-Failover: {failover_group.read_write_endpoint.failover_policy}")
   ```
   This script will print the server name, failover group name, and whether auto-failover is enabled for each server in the specified resource group. If the `failover_policy` is 'Automatic', then auto-failover is enabled. If it's 'Manual', then it's not enabled.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Enable Auto-Failover Groups By Server" for Azure using Azure console, follow the below steps:

1. Login to Azure portal (https://portal.azure.com/).
2. Navigate to the SQL Server for which you want to enable auto-failover group.
3. Click on the "Failover groups" option in the left-hand side menu.
4. Click on the "Add" button to create a new failover group.
5. In the "Basic" tab, provide the below details:
   - Name: Enter a name for the failover group.
   - Subscription: Select the subscription in which the failover group should be created.
   - Resource group: Select the resource group in which the failover group should be created.
   - Region: Select the primary region for the failover group.
   - Primary server: Select the primary SQL server for the failover group.
   - Secondary region: Select the secondary region for the failover group.
   - Secondary server: Select the secondary SQL server for the failover group.
6. In the "Advanced" tab, select the checkbox "Enable auto-failover groups by server".
7. Click on the "Review + create" button.
8. Review the details and click on the "Create" button to create the failover group.

Once the failover group is created with auto-failover groups enabled by server, the SQL server will be configured to automatically failover to the secondary server in case of any outage or failure in the primary server.

#### Using CLI

To remediate the misconfiguration "Enable Auto-Failover Groups By Server" in Azure using Azure CLI, follow the below steps:

Step 1: Open Azure CLI and login to your Azure account using the command below:

```
az login
```

Step 2: Once you are logged in, set the subscription where the server is located using the command below:

```
az account set --subscription <subscription_id>
```

Step 3: Check the current configuration of the server using the command below:

```
az sql server show --name <server_name> --resource-group <resource_group_name>
```

Step 4: If the "auto-failover" property is set to "Disabled", you can enable it using the command below:

```
az sql server update --name <server_name> --resource-group <resource_group_name> --auto-failover-group Enabled
```

Step 5: Once the command is executed successfully, verify the changes using the command below:

```
az sql server show --name <server_name> --resource-group <resource_group_name>
```

Step 6: Verify that the "auto-failover" property is set to "Enabled".

By following the above steps, you can remediate the misconfiguration "Enable Auto-Failover Groups By Server" in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration "Enable Auto-Failover Groups By Server" in Azure using Python, follow the below steps:

1. Import the required libraries:

```
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.sql import SqlManagementClient
from azure.mgmt.resource import ResourceManagementClient
```

2. Authenticate with Azure using Service Principal credentials:

```
TENANT_ID = 'your_tenant_id'
CLIENT_ID = 'your_client_id'
CLIENT_SECRET = 'your_client_secret'
SUBSCRIPTION_ID = 'your_subscription_id'

credentials = ServicePrincipalCredentials(
    client_id=CLIENT_ID,
    secret=CLIENT_SECRET,
    tenant=TENANT_ID
)
```

3. Create a resource management client:

```
resource_client = ResourceManagementClient(credentials, SUBSCRIPTION_ID)
```

4. Get the list of SQL servers:

```
sql_client = SqlManagementClient(credentials, SUBSCRIPTION_ID)
servers = sql_client.servers.list_by_resource_group(resource_group_name)
```

5. For each server, check if Auto-Failover is enabled, and if not, enable it:

```
for server in servers:
    failover_group_policies = sql_client.failover_groups.list_by_server(resource_group_name, server.name)
    if not failover_group_policies:
        failover_group_policy = sql_client.failover_groups.create_or_update(
            resource_group_name,
            server.name,
            {
                'read_write_endpoint': {
                    'failover_policy': 'Automatic',
                    'failover_with_data_loss_grace_period_minutes': 60
                },
                'partner_servers': []
            }
        )
```

6. Save the script and run it to enable Auto-Failover Groups By Server for all SQL servers in the specified resource group.

Note: Replace the placeholders "your_tenant_id", "your_client_id", "your_client_secret", "your_subscription_id" and "resource_group_name" with the appropriate values for your Azure environment.


</Tab>
</Tabs>