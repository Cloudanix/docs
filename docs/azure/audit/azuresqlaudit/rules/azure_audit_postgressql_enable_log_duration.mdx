---
slug: azure_audit_postgressql_enable_log_duration
title: Enable "LOG_DURATION" Parameter for PostgreSQL Servers
sidebar_label: Enable "LOG_DURATION" Parameter for PostgreSQL Servers
---

### More Info:

Ensure that "log_duration" server parameter is enabled for all PostgreSQL database servers created in your Microsoft Azure cloud account. Once enabled, the "log_duration" parameter allows recording the duration of each completed PostgreSQL statement. Only users with administrative privileges can change this setting within Azure PostgreSQL server configuration. For database clients using extended query protocol, the duration of the "Parse", "Bind", and "Execute" steps is logged independently.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, SOC2, NISTCSF, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to PostgreSQL servers: On the Azure portal, click on "All Services" in the left-hand menu. In the "All Services" box, type "PostgreSQL servers" in the search bar and select it.

3. Select the PostgreSQL server: In the "PostgreSQL servers" page, you will see a list of all your PostgreSQL servers. Click on the name of the server for which you want to check the "LOG_DURATION" parameter.

4. Check the "LOG_DURATION" parameter: In the server dashboard, click on "Server parameters" under the "Settings" section. In the "Server parameters" page, type "log_duration" in the search bar and press enter. If the "LOG_DURATION" parameter is enabled, its value will be 'ON'. If it's not enabled, its value will be 'OFF'.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have it installed on your local machine. You can download it from the official Microsoft Azure website and follow the installation instructions.

2. Login to Azure: Open your command line interface and type the following command to login to your Azure account:
   ```
   az login
   ```
   Follow the prompts in your browser to complete the authentication process.

3. Select the Subscription: If you have multiple subscriptions, set the subscription where your PostgreSQL server is located. Replace 'my-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'my-subscription-id'
   ```

4. Check "LOG_DURATION" Parameter: Use the following command to check the "LOG_DURATION" parameter for your PostgreSQL server. Replace 'my-resource-group', 'my-server-name' and 'log_duration' with your actual resource group name, server name and parameter name respectively.
   ```
   az postgres server configuration show --resource-group 'my-resource-group' --server-name 'my-server-name' --name 'log_duration'
   ```
   This command will return the configuration of the 'log_duration' parameter. If it is enabled, the "value" field in the output will be "on". If it is not enabled, the "value" field will be "off".

#### Using Python

To detect whether the "LOG_DURATION" parameter is enabled for PostgreSQL servers in SQL, you can use the psycopg2 library in Python, which is a PostgreSQL database adapter. Here are the steps:

1. **Install the psycopg2 library**: If you haven't installed the psycopg2 library, you can install it using pip:
   ```python
   pip install psycopg2-binary
   ```
2. **Establish a connection to the PostgreSQL server**: You need to establish a connection to the PostgreSQL server. Replace 'dbname', 'user', 'host', 'password' with your database details.
   ```python
   import psycopg2
   try:
       connection = psycopg2.connect(user = "user",
                                     password = "password",
                                     host = "host",
                                     port = "5432",
                                     database = "dbname")
       cursor = connection.cursor()
   except (Exception, psycopg2.Error) as error :
       print ("Error while connecting to PostgreSQL", error)
   ```
3. **Execute a query to check the "LOG_DURATION" parameter**: You can execute a SQL query to check the status of the "LOG_DURATION" parameter.
   ```python
   try:
       postgreSQL_select_Query = "SHOW log_duration;"
       cursor.execute(postgreSQL_select_Query)
       print("Selecting rows from mobile table using cursor.fetchall")
       mobile_records = cursor.fetchall() 
   
       print("Print each row and it's columns values")
       for row in mobile_records:
           print("log_duration = ", row[0], "\n")
   except (Exception, psycopg2.Error) as error :
       print ("Error while fetching data from PostgreSQL", error)
   ```
4. **Close the connection**: After you have finished, you should close the connection.
   ```python
   finally:
       #closing database connection.
       if(connection):
           cursor.close()
           connection.close()
           print("PostgreSQL connection is closed")
   ```
This script will print the status of the "LOG_DURATION" parameter. If it is 'on', then it is enabled. If it is 'off', then it is disabled.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "LOG_DURATION" parameter misconfiguration for PostgreSQL Servers in Azure, you can follow the below steps:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Navigate to the PostgreSQL server for which you want to enable the "LOG_DURATION" parameter.
3. Click on the "Configuration" tab from the left-hand side menu.
4. Scroll down to the "Parameters" section and search for the "log_duration" parameter.
5. If the "log_duration" parameter is not present, click on the "+ Add parameter" button and add the parameter.
6. Set the value of the "log_duration" parameter to "on" to enable it.
7. Click on the "Save" button to save the changes.

After following the above steps, the "LOG_DURATION" parameter will be enabled for the PostgreSQL server in Azure.

#### Using CLI

To remediate the misconfiguration of enabling the "LOG_DURATION" parameter for PostgreSQL servers in AZURE using AZURE CLI, you can follow the below steps:

1. Open the AZURE CLI and log in to your AZURE account.
2. Run the below command to get the list of all the PostgreSQL servers in your subscription:

   ```
   az postgres server list
   ```

3. Select the PostgreSQL server for which you want to enable the "LOG_DURATION" parameter and note down its resource group name and server name.
4. Run the below command to enable the "LOG_DURATION" parameter for the selected PostgreSQL server:

   ```
   az postgres server configuration set --resource-group <resource_group_name> --server-name <server_name> --name log_duration --value on
   ```

   Replace `<resource_group_name>` and `<server_name>` with the actual values of the resource group name and server name noted down in step 3.

5. Verify that the "LOG_DURATION" parameter is enabled for the PostgreSQL server by running the below command:

   ```
   az postgres server configuration list --resource-group <resource_group_name> --server-name <server_name> --query "[?name=='log_duration']"
   ```

   If the output shows the value of "value" parameter as "on", then the "LOG_DURATION" parameter is enabled for the PostgreSQL server.

By following the above steps, you can remediate the misconfiguration of enabling the "LOG_DURATION" parameter for PostgreSQL servers in AZURE using AZURE CLI.

#### Using Python

To enable the "LOG_DURATION" parameter for PostgreSQL servers in Azure using python, you can follow the below steps:

1. Import the necessary libraries:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.rdbms.postgresql import PostgreSQLManagementClient
```

2. Set the credentials for authentication:

```python
TENANT_ID = '<your tenant id>'
CLIENT = '<your client id>'
KEY = '<your client secret>'
SUBSCRIPTION_ID = '<your subscription id>'

credentials = ServicePrincipalCredentials(
    client_id=CLIENT,
    secret=KEY,
    tenant=TENANT_ID
)
```

3. Create a PostgreSQL management client object:

```python
client = PostgreSQLManagementClient(
    credentials=credentials,
    subscription_id=SUBSCRIPTION_ID
)
```

4. Get the PostgreSQL server you want to enable the "LOG_DURATION" parameter for:

```python
RESOURCE_GROUP_NAME = '<your resource group name>'
SERVER_NAME = '<your server name>'

server = client.servers.get(
    resource_group_name=RESOURCE_GROUP_NAME,
    server_name=SERVER_NAME
)
```

5. Update the server configuration to enable the "LOG_DURATION" parameter:

```python
CONFIGURATION_NAME = 'postgresql.conf'
CONFIGURATION_VALUE = 'log_duration = on'

parameters = {
    'name': CONFIGURATION_NAME,
    'value': CONFIGURATION_VALUE
}

client.configurations.create_or_update(
    resource_group_name=RESOURCE_GROUP_NAME,
    server_name=SERVER_NAME,
    configuration_name=CONFIGURATION_NAME,
    parameters=parameters
)
```

6. Verify that the configuration has been updated:

```python
configuration = client.configurations.get(
    resource_group_name=RESOURCE_GROUP_NAME,
    server_name=SERVER_NAME,
    configuration_name=CONFIGURATION_NAME
)

print(configuration.value)
```

This should enable the "LOG_DURATION" parameter for the PostgreSQL server in Azure.


</Tab>
</Tabs>