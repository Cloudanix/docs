---
slug: azure_audit_sqlserver_threat_detection_alerts_notification_disabled
title: Send Threat Detection Alerts Disabled for SQL Servers
sidebar_label: Send Threat Detection Alerts Disabled for SQL Servers
---

### More Info:

Specify email addresses and ensure that alerts are sent to them.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISAZURE, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal.
2. Navigate to the SQL servers section. You can do this by searching for "SQL servers" in the search bar at the top of the Azure portal.
3. Select the SQL server you want to check for misconfigurations.
4. In the SQL server blade, select "Security" from the left-hand menu, then select "Advanced Threat Protection".
5. Check the status of "Send Threat Detection Alerts". If it is disabled, then this is a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. After installation, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your Azure account credentials.
   ```
   az login
   ```
3. Set your Azure subscription: If you have multiple Azure subscriptions, set the subscription you want to use. Replace 'my-subscription-name' with your subscription name.
   ```
   az account set --subscription 'my-subscription-name'
   ```
4. Check Send Threat Detection Alerts: Now, you can check if Send Threat Detection Alerts is disabled for SQL Servers in SQL. Replace 'resource-group-name' and 'server-name' with your resource group and server name respectively.
   ```
   az sql server threat-policy show --resource-group 'resource-group-name' --server 'server-name' --query 'emailAccountAdmins'
   ```
   If the output of this command is 'Disabled', then Send Threat Detection Alerts is disabled for the SQL Server. If it's 'Enabled', then it's enabled.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the Azure SDK for Python. This SDK provides libraries to work with Azure resources. You can install it using pip:

   ```python
   pip install azure-mgmt-sql
   pip install azure-identity
   ```

2. Authenticate to Azure: To interact with Azure resources, you need to authenticate using a service principal or managed identity. Here is an example of how to authenticate using a service principal:

   ```python
   from azure.identity import ClientSecretCredential
   from azure.mgmt.sql import SqlManagementClient

   tenant_id = "your-tenant-id"
   client_id = "your-client-id"
   client_secret = "your-client-secret"

   credential = ClientSecretCredential(tenant_id, client_id, client_secret)
   sql_client = SqlManagementClient(credential, "your-subscription-id")
   ```

3. List all SQL servers and check the threat detection policy: Now, you can list all SQL servers in your subscription and check the threat detection policy for each server. If the policy is disabled, it means that Send Threat Detection Alerts is disabled.

   ```python
   for server in sql_client.servers.list():
       threat_detection_policy = sql_client.server_security_alert_policies.get(server.resource_group, server.name)
       if threat_detection_policy.state == "Disabled":
           print(f"Send Threat Detection Alerts is disabled for server: {server.name}")
   ```

4. Run the script: Finally, you can run the script to detect if Send Threat Detection Alerts is disabled for any SQL server in your Azure subscription. If it is disabled, the script will print the name of the server.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the "Threat Detection Alerts Disabled for SQL Servers" misconfiguration in Azure:

1. Log in to the Azure portal (https://portal.azure.com/).

2. Navigate to the SQL Server that you want to remediate.

3. Click on the "Security" tab in the left-hand menu.

4. Under the "Advanced Data Security" section, click on "Threat Detection" to open the settings page.

5. In the "Threat Detection" settings page, toggle the switch to "On" to enable threat detection.

6. Choose the types of alerts you want to receive by selecting the appropriate checkboxes.

7. Set the email address(es) where you want to receive the alerts.

8. Click on the "Save" button to save your changes.

9. Wait for a few minutes for the changes to take effect.

By following these steps, you have successfully remediated the "Threat Detection Alerts Disabled for SQL Servers" misconfiguration in Azure.

#### Using CLI

To remediate the misconfiguration "Threat Detection Alerts Disabled for SQL Servers" in Azure using Azure CLI, you can follow the below steps:

Step 1: Open Azure CLI and login to your Azure account using the command:

```
az login
```

Step 2: Once you are logged in, run the following command to check if threat detection is enabled for your SQL server:

```
az sql server threat-policy show --resource-group <resource-group-name> --server <sql-server-name>
```

Step 3: If the output shows that the threat detection is disabled, run the following command to enable it:

```
az sql server threat-policy update --state Enabled --resource-group <resource-group-name> --server <sql-server-name>
```

Note: Replace `<resource-group-name>` and `<sql-server-name>` with the actual names of your resource group and SQL server respectively.

Step 4: Once the command is executed successfully, the threat detection will be enabled for your SQL server.

Step 5: Verify the status of the threat detection using the command in Step 2.

This will remediate the misconfiguration "Threat Detection Alerts Disabled for SQL Servers" in Azure using Azure CLI.

#### Using Python

To remediate the "Threat Detection Alerts Disabled for SQL Servers" misconfiguration in Azure using Python, you can use the Azure SDK for Python. Here are the steps to do so:

1. First, you need to authenticate to Azure using your credentials. You can do this using the `DefaultAzureCredential` class from the `azure.identity` package. Here's an example:

```
from azure.identity import DefaultAzureCredential
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.sql import SqlManagementClient

credential = DefaultAzureCredential()
subscription_id = '<your-subscription-id>'

resource_client = ResourceManagementClient(credential, subscription_id)
sql_client = SqlManagementClient(credential, subscription_id)
```

2. Next, you need to get a list of all the SQL servers in your Azure subscription. You can do this using the `sql_client.servers.list()` method. Here's an example:

```
servers = sql_client.servers.list()
```

3. For each SQL server, you need to check if the Threat Detection feature is enabled. You can do this using the `sql_client.servers.get_threat_detection_policy()` method. Here's an example:

```
for server in servers:
    policy = sql_client.servers.get_threat_detection_policy(server.resource_group, server.name)
    if not policy.state:
        # Threat Detection is disabled, enable it
        policy.state = 'Enabled'
        sql_client.servers.create_or_update_threat_detection_policy(server.resource_group, server.name, policy)
```

4. Finally, you need to create an Azure Monitor alert to notify you when Threat Detection is disabled for a SQL server. You can do this using the `azure.mgmt.monitor` package. Here's an example:

```
from azure.mgmt.monitor import MonitorManagementClient
from azure.mgmt.monitor.models import AlertRuleResource, AlertRuleAllOfCondition, \
    AlertRuleAllOfAction, AlertRuleActionGroup

monitor_client = MonitorManagementClient(credential, subscription_id)

# Create an action group for the alert
action_group = AlertRuleActionGroup(
    group_id='<your-action-group-id>',
    webhook_properties={}
)

# Create the alert rule
alert_rule = AlertRuleResource(
    name='Threat Detection Disabled',
    location='<your-location>',
    description='Alert when Threat Detection is disabled for a SQL server',
    condition=AlertRuleAllOfCondition(
        all_of=[
            {
                "field": "category",
                "equals": "Administrative"
            },
            {
                "field": "resourceId",
                "contains": "/providers/Microsoft.Sql/servers/"
            },
            {
                "field": "resourceStatus",
                "equals": "Disabled"
            }
        ]
    ),
    actions=AlertRuleAllOfAction(
        all_of=[action_group]
    )
)

monitor_client.alert_rules.create_or_update('<your-resource-group>', '<your-alert-rule-name>', alert_rule)
```

These are the steps to remediate the "Threat Detection Alerts Disabled for SQL Servers" misconfiguration in Azure using Python.




</Tab>
</Tabs>