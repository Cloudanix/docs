

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser's address bar. Enter your login credentials to access your Azure account.

2. Navigate to SQL databases: From the left-hand side menu, select "SQL databases". This will open a list of all the SQL databases that are currently running in your Azure environment.

3. Check auditing settings: Click on the name of the database for which you want to check the auditing settings. This will open the database's dashboard. From here, navigate to the "Security" section and then click on "Auditing".

4. Verify auditing status: On the Auditing page, check the status of the "Auditing" option. If it is set to "Off", then auditing is disabled for that SQL database. If it is set to "On", then auditing is enabled.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft website and follow the installation instructions.

2. Login to Azure: After installing Azure CLI, open your command prompt and type the following command to login to your Azure account:

   ```
   az login
   ```
   Follow the instructions on the screen to complete the login process.

3. List SQL Servers: Once you are logged in, you can list all the SQL servers in your Azure account by running the following command:

   ```
   az sql server list --query "[].{name:name, resourceGroup:resourceGroup}"
   ```
   This command will return a list of all SQL servers along with their respective resource groups.

4. Check Auditing Status: Now, for each SQL server, you can check the auditing status by running the following command:

   ```
   az sql server audit-policy show --name {server_name} --resource-group {resource_group_name}
   ```
   Replace `{server_name}` and `{resource_group_name}` with the actual name of your SQL server and resource group respectively. This command will return the auditing policy of the specified SQL server. If the `state` field in the returned result is `Disabled`, it means that auditing is disabled for that SQL server.

#### Using Python

To check if auditing is disabled for SQL databases in Azure, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: You can install the Azure SDK for Python using pip. Run the following command in your terminal:
   ```
   pip install azure-mgmt-sql
   ```
2. **Authenticate to Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for Python to authenticate. Here is a sample code snippet:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.sql import SqlManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'  # replace with your Azure Subscription ID
   sql_client = SqlManagementClient(credential, subscription_id)
   ```
3. **List all SQL servers and databases**: You can use the `sql_client` object to list all SQL servers and databases in your subscription. Here is a sample code snippet:
   ```python
   for server in sql_client.servers.list():
       for database in sql_client.databases.list_by_server(server.resource_group, server.name):
           print(f"Server: {server.name}, Database: {database.name}")
   ```
4. **Check if auditing is enabled**: You can use the `sql_client` object to check if auditing is enabled for each database. Here is a sample code snippet:
   ```python
   for server in sql_client.servers.list():
       for database in sql_client.databases.list_by_server(server.resource_group, server.name):
           server_blob_auditing_policies = sql_client.server_blob_auditing_policies.get(server.resource_group, server.name)
           if server_blob_auditing_policies.state == "Disabled":
               print(f"Auditing is disabled for Server: {server.name}, Database: {database.name}")
   ```
   This script will print out the names of all servers and databases for which auditing is disabled.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of auditing disabled for SQL databases in Azure, you can follow the below steps:

1. Open the Azure portal and go to the SQL database that needs to be remediated.

2. In the left-hand menu, select "Auditing and Threat Detection".

3. In the "Auditing and Threat Detection" blade, select "Audit logs".

4. In the "Audit logs" blade, click on the "Turn on auditing" button.

5. In the "Audit logs" blade, select the storage account where the audit logs will be stored.

6. Click on "Save" to enable auditing for the SQL database.

7. In the "Auditing and Threat Detection" blade, select "Threat Detection".

8. In the "Threat Detection" blade, click on "Enable Threat Detection".

9. In the "Threat Detection" blade, select the storage account where the threat detection logs will be stored.

10. Click on "Save" to enable threat detection for the SQL database.

Once the above steps are completed, auditing and threat detection will be enabled for the SQL database in Azure.

#### Using CLI

To remediate the "Auditing Disabled for SQL Databases" misconfiguration in Azure using Azure CLI, follow these steps:

1. Open Azure CLI and login to your Azure account using the command:
```
az login
```
2. Once you are logged in, set the default subscription where your SQL databases are located using the command:
```
az account set --subscription <subscription_name>
```
3. Enable auditing for the SQL server by running the following command:
```
az sql server audit-policy update --state Enabled --storage-account <storage_account_name> --storage-key <storage_account_key> --storage-endpoint <storage_account_endpoint> --retention-days <retention_period> --resource-group <resource_group_name> --server <sql_server_name>
```
Note: Replace the placeholders with actual values for storage account name, storage account key, storage account endpoint, retention period, resource group name, and SQL server name.

4. Once the command is executed successfully, auditing will be enabled for the SQL server and all the databases under it.

5. Verify the status of auditing by running the following command:
```
az sql server audit-policy show --resource-group <resource_group_name> --server <sql_server_name>
```
This command will display the current audit policy for the SQL server and its databases.

6. Repeat the above steps for all the SQL servers in your Azure environment to ensure that auditing is enabled for all the databases. 

By following the above steps, you can remediate the "Auditing Disabled for SQL Databases" misconfiguration in Azure using Azure CLI.

#### Using Python

To remediate the issue of auditing disabled for SQL databases in Azure, you can use the following Python code:

1. First, import the necessary libraries:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.sql import SqlManagementClient
```

2. Next, authenticate and create a SQL management client object:

```python
credential = DefaultAzureCredential()
sql_client = SqlManagementClient(credential, subscription_id)
```

3. Get the list of SQL servers in your subscription:

```python
servers = sql_client.servers.list()
```

4. For each server, get the list of databases and enable auditing for each database:

```python
for server in servers:
    databases = sql_client.databases.list_by_server(resource_group_name, server.name)
    for database in databases:
        database_properties = sql_client.databases.get(resource_group_name, server.name, database.name)
        database_properties.auditing_policy.state = "Enabled"
        database_properties.auditing_policy.is_azure_monitor_target_enabled = True
        sql_client.databases.create_or_update(resource_group_name, server.name, database.name, database_properties)
```

This code will iterate through all the SQL servers in your subscription, and for each server, it will enable auditing for all the databases and set Azure Monitor as the target. This will remediate the issue of auditing disabled for SQL databases in Azure.


</Tab>
</Tabs>