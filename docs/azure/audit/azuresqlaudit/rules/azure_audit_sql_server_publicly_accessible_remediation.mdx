

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to SQL servers: From the left-hand menu, click on "SQL servers" under the "SQL databases" section. This will open a list of all the SQL servers in your Azure account.

3. Check for public access: For each SQL server, click on the server name to open its dashboard. Under the "Settings" section, click on "Firewalls and virtual networks". Here, you can see the list of IP addresses that are allowed to access this SQL server. If the "Allow Azure services and resources to access this server" option is enabled or if there are any IP addresses in the range 0.0.0.0 to 255.255.255.255, then the SQL server is publicly accessible.

4. Check for authentication: Additionally, you should also check the "Authentication" method for each SQL server. If it is set to "SQL Server" instead of "Azure Active Directory", it means that anyone with the SQL server credentials can access it from any IP address, making it publicly accessible.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List all SQL servers: Use the following command to list all the SQL servers in your Azure account. This will return a list of all SQL servers along with their properties.
   ```
   az sql server list
   ```
3. Check for public network access: For each SQL server, check the 'publicNetworkAccess' property. If it is set to 'Enabled', then the SQL server is publicly accessible. You can use the following command to get the details of a specific SQL server:
   ```
   az sql server show --name <server_name> --resource-group <resource_group_name>
   ```
   Replace `<server_name>` and `<resource_group_name>` with the name of your SQL server and resource group respectively.

4. Check for firewall rules: Even if public network access is enabled, the SQL server may not be publicly accessible if there are no firewall rules that allow access from all IP addresses. You can list the firewall rules for a SQL server using the following command:
   ```
   az sql server firewall-rule list --server <server_name> --resource-group <resource_group_name>
   ```
   Replace `<server_name>` and `<resource_group_name>` with the name of your SQL server and resource group respectively. If there is a rule with 'startIpAddress' as '0.0.0.0' and 'endIpAddress' as '255.255.255.255', then the SQL server is publicly accessible.

#### Using Python

1. AWS:
   - Install and configure AWS CLI and Boto3 Python library.
   - Use the following Python script to list all RDS instances and check if they are publicly accessible:

```python
import boto3

def check_public_rds():
    client = boto3.client('rds')
    response = client.describe_db_instances()
    for instance in response['DBInstances']:
        if instance['PubliclyAccessible']:
            print(f"RDS instance {instance['DBInstanceIdentifier']} is publicly accessible")

check_public_rds()
```

2. Azure:
   - Install and configure Azure CLI and Azure SDK for Python.
   - Use the following Python script to list all SQL servers and check if they have firewall rules that allow public access:

```python
from azure.mgmt.sql import SqlManagementClient
from azure.identity import DefaultAzureCredential

def check_public_sql_servers():
    credential = DefaultAzureCredential()
    subscription_id = 'your-subscription-id'
    sql_client = SqlManagementClient(credential, subscription_id)
    for server in sql_client.servers.list():
        firewall_rules = sql_client.firewall_rules.list_by_server(server.resource_group, server.name)
        for rule in firewall_rules:
            if rule.start_ip_address == '0.0.0.0' and rule.end_ip_address == '255.255.255.255':
                print(f"SQL server {server.name} is publicly accessible")

check_public_sql_servers()
```

3. GCP:
   - Install and configure Google Cloud SDK and Google Cloud Client Library for Python.
   - Use the following Python script to list all Cloud SQL instances and check if they have authorized networks:

```python
from google.cloud import sql

def check_public_sql_instances():
    client = sql.SqlInstancesServiceClient()
    project_id = 'your-project-id'
    instances = client.list(project=project_id)
    for instance in instances:
        if instance.settings.ip_configuration.authorized_networks:
            print(f"Cloud SQL instance {instance.name} is publicly accessible")

check_public_sql_instances()
```

Please replace 'your-subscription-id' and 'your-project-id' with your actual Azure subscription ID and GCP project ID respectively.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration of "Publicly Accessible SQL Servers" in Azure:

1. Log in to the Azure Portal (https://portal.azure.com/).
2. Navigate to the SQL servers page by clicking on "SQL servers" in the left-hand menu.
3. Select the SQL server that is publicly accessible.
4. Click on the "Firewalls and virtual networks" tab.
5. Under "Firewall settings," select "Selected networks."
6. Click on the "Add client IP" button to add the IP address of your computer to the list of allowed IPs.
7. If you want to allow access from other IPs, you can add them by clicking on the "Add IP range" button.
8. Click on the "Save" button to save the changes.

By following these steps, you have now remediated the misconfiguration of "Publicly Accessible SQL Servers" in Azure and restricted access to only the allowed IPs.

#### Using CLI

Sure, here are the step-by-step instructions to remediate the "Publicly Accessible SQL Servers" misconfiguration in AZURE using AZURE CLI:

1. Open the AZURE CLI and login to your AZURE account using the following command:

```
az login
```

2. Run the following command to list all the SQL servers in your subscription:

```
az sql server list
```

3. Identify the SQL server(s) that are publicly accessible and note down their resource group name and server name.

4. Run the following command to set the "public network access" property to "Disabled" for the identified SQL server(s):

```
az sql server update --resource-group <resource-group-name> --name <server-name> --public-network-access Disabled
```

Make sure to replace `<resource-group-name>` and `<server-name>` with the actual names of the resource group and server that you identified in step 3.

5. Verify that the "public network access" property has been set to "Disabled" for the SQL server(s) by running the following command:

```
az sql server show --resource-group <resource-group-name> --name <server-name> --query 'publicNetworkAccess'
```

This command should return "Disabled" for the identified SQL server(s).

That's it! You have successfully remediated the "Publicly Accessible SQL Servers" misconfiguration in AZURE using AZURE CLI.

#### Using Python

To remediate publicly accessible SQL servers in Azure using Python, you can follow these steps:

1. First, you need to import the necessary libraries:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.sql import SqlManagementClient
```

2. Next, you need to authenticate with Azure using the `DefaultAzureCredential` class.

```python
credential = DefaultAzureCredential()
```

3. Then, you need to create an instance of the `SqlManagementClient` class.

```python
subscription_id = 'your-subscription-id'
sql_client = SqlManagementClient(credential, subscription_id)
```

4. After that, you can use the `sql_client` instance to get a list of all the SQL servers in your subscription.

```python
servers = sql_client.servers.list()
```

5. For each SQL server, you can check if it is publicly accessible by getting its firewall rules.

```python
for server in servers:
    firewall_rules = sql_client.firewall_rules.list_by_server(resource_group_name='<resource-group-name>', server_name=server.name)
    for rule in firewall_rules:
        if rule.start_ip_address == '0.0.0.0' and rule.end_ip_address == '255.255.255.255':
            print(f"Server {server.name} has a publicly accessible firewall rule.")
```

6. If you find a SQL server with a publicly accessible firewall rule, you can delete the rule using the `delete` method of the `FirewallRulesOperations` class.

```python
if rule.start_ip_address == '0.0.0.0' and rule.end_ip_address == '255.255.255.255':
    print(f"Server {server.name} has a publicly accessible firewall rule. Deleting rule {rule.name}...")
    sql_client.firewall_rules.delete(resource_group_name='<resource-group-name>', server_name=server.name, firewall_rule_name=rule.name)
```

7. Finally, you can confirm that the firewall rule has been deleted by checking the list of firewall rules again.

```python
firewall_rules = sql_client.firewall_rules.list_by_server(resource_group_name='<resource-group-name>', server_name=server.name)
for rule in firewall_rules:
    if rule.start_ip_address == '0.0.0.0' and rule.end_ip_address == '255.255.255.255':
        print(f"Server {server.name} still has a publicly accessible firewall rule.")
```

Note: You will need to replace `<resource-group-name>` with the name of the resource group containing your SQL servers.


</Tab>
</Tabs>