---
slug: azure_audit_sqlserver_auditing_disabled
title: Auditing Disabled for SQL Servers
sidebar_label: Auditing Disabled for SQL Servers
---

### More Info:

Enable auditing for all SQL Servers.

### Risk Level

Medium

### Address

Security, Operational Maturity

### Compliance Standards

CISAZURE, CBP, HIPAA, ISO27001, HITRUST, SOC2, NISTCSF, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser's address bar. Enter your Azure account credentials to log in.

2. Navigate to SQL servers: Once you're logged in, click on the hamburger icon (three horizontal lines) in the top left corner of the Azure portal. This will open the navigation pane. From the navigation pane, click on "SQL servers" under the "Databases" section.

3. Select the SQL Server: You will see a list of all the SQL servers in your Azure account. Click on the name of the SQL server for which you want to check if auditing is disabled.

4. Check Auditing settings: In the SQL server dashboard, click on "Security" in the left-hand menu, then select "Auditing". Here, you can see the status of Auditing. If it's turned off, then Auditing is disabled for this SQL server.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft website. Once installed, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your Azure account credentials.
   ```
   az login
   ```
3. Set your subscription: If you have multiple subscriptions, set the subscription you want to use. Replace 'my-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'my-subscription-id'
   ```
4. Check Auditing Status: Now, you can check the auditing status of your SQL servers. Replace 'my-resource-group' and 'my-sql-server' with your actual resource group and SQL server names.
   ```
   az sql server audit-policy show --name 'my-sql-server' --resource-group 'my-resource-group'
   ```
   If the state of the 'isAzureMonitorTargetEnabled', 'isStorageSecondaryKeyInUse', or 'state' properties is 'Disabled', then Auditing is disabled for the SQL Server.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the necessary Python libraries. You will need the `azure-mgmt-sql` library to interact with Azure SQL Server and `azure-identity` for Azure SDK authentication. You can install these libraries using pip:

```python
pip install azure-mgmt-sql azure-identity
```

2. Authenticate with Azure: You need to authenticate with Azure before you can interact with the resources. You can use Azure Identity library to authenticate:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.sql import SqlManagementClient

credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'  # replace with your Azure Subscription ID
client = SqlManagementClient(credential, subscription_id)
```

3. List all SQL Servers and check auditing settings: Now, you can list all SQL servers in your subscription and check the auditing settings for each server:

```python
from azure.mgmt.sql.models import ServerBlobAuditingPolicyState

for server in client.servers.list():
    server_name = server.name
    resource_group = server.id.split('/')[4]  # extract resource group from server id

    # get server's blob auditing policy
    auditing_policy = client.server_blob_auditing_policies.get(resource_group, server_name)

    # check if auditing is disabled
    if auditing_policy.state == ServerBlobAuditingPolicyState.DISABLED:
        print(f"Auditing is disabled for SQL Server: {server_name}")
```

4. Interpret the results: If the script prints out any SQL Server names, it means that auditing is disabled for those servers. If it doesn't print anything, it means that auditing is enabled for all SQL Servers in your subscription.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Auditing Disabled for SQL Servers" misconfiguration in Azure using the Azure console, follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/) using your credentials.

2. Navigate to the Azure SQL Server that you want to remediate.

3. Click on the "Auditing" option from the left-hand side menu.

4. In the "Auditing" blade, click on "Enable Auditing".

5. In the "Audit to" section, select the destination where you want to store the audit logs. You can choose to store the logs in a storage account or log analytics workspace.

6. In the "Audit logs retention (days)" section, specify the number of days for which you want to retain the audit logs.

7. In the "Event types to audit" section, select the events that you want to audit. You can choose to audit all events or select specific events.

8. In the "Storage account settings" or "Log Analytics workspace settings" section, specify the required details for the destination where you want to store the audit logs.

9. Click on "Save" to enable auditing for the SQL Server.

10. Verify that auditing is enabled by checking the "Auditing" blade. You should see a message that says "Auditing is enabled". 

That's it! You have successfully remediated the "Auditing Disabled for SQL Servers" misconfiguration in Azure.

#### Using CLI

Here are the step-by-step instructions to remediate the issue of auditing disabled for SQL Servers on Azure using Azure CLI:

1. Open the Azure CLI on your local machine or Azure Cloud Shell.

2. Login to your Azure account using the following command:
```
az login
```

3. Once you are logged in, select the Azure subscription that contains the SQL Server you want to remediate:
```
az account set --subscription <subscription_id>
```

4. Next, check the current auditing status of the SQL Server using the following command:
```
az sql server audit-policy show --resource-group <resource_group_name> --server <server_name>
```

5. If auditing is disabled, you can enable it by running the following command:
```
az sql server audit-policy update --resource-group <resource_group_name> --server <server_name> --state Enabled --storage-account <storage_account_name> --storage-key <storage_account_key> --storage-endpoint <storage_account_endpoint>
```

Note: Replace `<resource_group_name>`, `<server_name>`, `<storage_account_name>`, `<storage_account_key>`, and `<storage_account_endpoint>` with the appropriate values for your environment.

6. After running the command, wait for a few minutes to allow the changes to propagate.

7. Finally, verify that auditing is now enabled for the SQL Server using the following command:
```
az sql server audit-policy show --resource-group <resource_group_name> --server <server_name>
```

That's it! You have successfully remediated the misconfiguration of auditing disabled for SQL Servers on Azure using Azure CLI.

#### Using Python

To remediate the issue of auditing being disabled for SQL Servers in Azure using Python, you can use the Azure SDK for Python. Here are the step-by-step instructions:

1. Install the Azure SDK for Python using pip:
```python
pip install azure-mgmt-sql
```
2. Import the necessary modules:
```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.sql import SqlManagementClient
```
3. Authenticate using the default Azure credentials:
```python
credential = DefaultAzureCredential()
subscription_id = 'YOUR_SUBSCRIPTION_ID'
resource_group_name = 'YOUR_RESOURCE_GROUP_NAME'
server_name = 'YOUR_SQL_SERVER_NAME'
```
4. Create a `SqlManagementClient` object:
```python
sql_client = SqlManagementClient(credential, subscription_id)
```
5. Enable auditing for the SQL Server:
```python
from azure.mgmt.sql.models import ServerSecurityAlertPolicy, SecurityAlertPolicyState
security_alert_policy = ServerSecurityAlertPolicy(state=SecurityAlertPolicyState.enabled)
sql_client.server_security_alert_policies.create_or_update(resource_group_name, server_name, security_alert_policy_name='default', parameters=security_alert_policy)
```
6. Verify that auditing has been enabled by checking the current state of the security alert policy:
```python
current_security_alert_policy = sql_client.server_security_alert_policies.get(resource_group_name, server_name, security_alert_policy_name='default')
print(current_security_alert_policy.state)
```

These steps will enable auditing for the specified SQL Server in Azure using Python.




</Tab>
</Tabs>