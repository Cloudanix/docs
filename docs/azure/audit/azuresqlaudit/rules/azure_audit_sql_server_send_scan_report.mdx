---
slug: azure_audit_sql_server_send_scan_report
title: Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured
sidebar_label: Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured
---

### More Info:

Configure 'Send scan reports to' with email ids of concerned data owners/stakeholders for a critical SQL servers.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISAZURE, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to SQL servers: On the left-hand side menu, click on "SQL servers" under the "Databases" section. This will open a list of all your SQL servers.

3. Check Vulnerability Assessment settings: Click on the name of the SQL server you want to check. This will open the server's dashboard. On the left-hand side menu, under the "Security" section, click on "Vulnerability Assessment". This will open the Vulnerability Assessment settings.

4. Check Send Scan Reports To setting: In the Vulnerability Assessment settings, look for the "Send Scan Reports To" setting. If it is configured, it should have an email address or a storage account specified. If it is not configured, it will be blank or have a default value.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install the Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command line interface and run the following command to login to your Azure account:

   ```
   az login
   ```
   Follow the prompts in your command line interface to complete the login process.

2. List SQL Servers: Once you're logged in, you can list all the SQL servers in your Azure account by running the following command:

   ```
   az sql server list --output table
   ```
   This command will return a table that includes the name and resource group for each SQL server.

3. Check Vulnerability Assessment Settings: For each SQL server, you can check the vulnerability assessment settings by running the following command:

   ```
   az sql va list --resource-group {ResourceGroupName} --server {ServerName} --database {DatabaseName}
   ```
   Replace `{ResourceGroupName}`, `{ServerName}`, and `{DatabaseName}` with the name of the resource group, server, and database you want to check. This command will return a list of all vulnerability assessment settings for the specified database.

4. Check Send Scan Reports To Setting: In the output from the previous command, look for the "storageContainerPath" field. This field indicates where scan reports are sent. If this field is not set or is set to an inappropriate location, then the "Send Scan Reports To" setting is misconfigured.

#### Using Python

1. Install the necessary Python libraries: To interact with Azure resources, you need to install the Azure SDK for Python. You can do this using pip:

   ```python
   pip install azure-mgmt-sql
   ```

2. Authenticate to Azure: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for this. Here is an example of how to authenticate using a service principal:

   ```python
   from azure.identity import ClientSecretCredential
   from azure.mgmt.sql import SqlManagementClient

   tenant_id = "your-tenant-id"
   client_id = "your-client-id"
   client_secret = "your-client-secret"

   credential = ClientSecretCredential(tenant_id, client_id, client_secret)
   sql_client = SqlManagementClient(credential, "your-subscription-id")
   ```

3. Get the list of SQL servers and databases: You can use the `sql_client` object to get the list of SQL servers and databases in your subscription:

   ```python
   for server in sql_client.servers.list():
       for database in sql_client.databases.list(server.name):
           print(f"Server: {server.name}, Database: {database.name}")
   ```

4. Check the Vulnerability Assessment settings: For each database, you can check the Vulnerability Assessment settings to see if the "Send Scan Reports To" is configured:

   ```python
   for server in sql_client.servers.list():
       for database in sql_client.databases.list(server.name):
           va_settings = sql_client.database_vulnerability_assessment_rule_baselines.get(server.name, database.name)
           if va_settings.email_addresses:
               print(f"Server: {server.name}, Database: {database.name}, Send Scan Reports To: {va_settings.email_addresses}")
           else:
               print(f"Server: {server.name}, Database: {database.name}, Send Scan Reports To: Not configured")
   ```

This script will print the "Send Scan Reports To" setting for each database in each SQL server in your Azure subscription. If the setting is not configured, it will print "Not configured".

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured" in Azure, please follow the below steps:

1. Login to your Azure portal.
2. Select the subscription where you want to remediate the misconfiguration.
3. Go to the Security Center in the left-hand menu.
4. Click on "Security policy" in the Security Center dashboard.
5. Scroll down to the "Vulnerability Assessment" section and click on it.
6. Click on the "Edit settings" button.
7. Scroll down to the "Scan Reports" section.
8. Ensure that the "Send scan reports to" option is set to a valid email address or a storage account.
9. If you want to send the scan reports to an email address, enter the email address in the text box.
10. If you want to send the scan reports to a storage account, select the storage account from the drop-down list.
11. Click on the "Save" button to save the changes.

After completing these steps, the misconfiguration "Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured" will be remediated in Azure.

#### Using CLI

To remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured" for AZURE using AZURE CLI, follow the steps below:

1. Open the Azure CLI in your terminal or command prompt.
2. Login to your Azure account using the command "az login".
3. Once you are logged in, run the following command to set the "sendScanReportTo" property to a valid email address:

   ```
   az sql vm group update --name <resource-group-name> --sql-management --send-scan-report-to <email-address>
   ```

   Replace `<resource-group-name>` with the name of the resource group where your SQL Server virtual machine is located and `<email-address>` with a valid email address where you want to receive the scan reports.

4. After running the command, the "sendScanReportTo" property will be set and the vulnerability assessment scan reports will be sent to the specified email address.

By following these steps, you can remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured" for AZURE using AZURE CLI.

#### Using Python

To remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured" for Azure using python, you can follow the below steps:

1. Import the necessary libraries:

```
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.security import SecurityCenter
from azure.mgmt.security.models import SecurityAssessmentMetadata
```

2. Authenticate and create a client object:

```
credentials = ServicePrincipalCredentials(client_id=<client_id>,
                                          secret=<client_secret>,
                                          tenant=<tenant_id>)

security_center_client = SecurityCenter(credentials, <subscription_id>)
```

3. Retrieve the assessment metadata for the specific subscription:

```
assessment_metadata = security_center_client.assessment_metadata.get(<subscription_id>, "vulnerabilityAssessmentSettings")
```

4. Check if the "sendScanReportsTo" property is configured:

```
if assessment_metadata.send_scan_reports_to is None:
    assessment_metadata.send_scan_reports_to = "<email_address>"
```

5. Update the assessment metadata:

```
security_center_client.assessment_metadata.create_or_update(<subscription_id>, "vulnerabilityAssessmentSettings", assessment_metadata)
```

By following these steps, you can remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Send Scan Reports To Is Configured" for Azure using python.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment](https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment) 


</Tab>
</Tabs>