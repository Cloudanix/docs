---
slug: azure_audit_sql_server_periodic_recurring_scans
title: Ensure That Vulnerability Assessment Setting Periodic Recurring Scans Is Set To On
sidebar_label: Ensure That Vulnerability Assessment Setting Periodic Recurring Scans Is Set To On
---

### More Info:

Enable Vulnerability Assessment (VA) Periodic recurring scans for critical SQL servers and corresponding SQL databases.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISAZURE, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal (https://portal.azure.com/), and log in with your Azure account credentials.

2. Navigate to SQL databases: From the left-hand menu, click on "SQL databases". This will open a list of all the SQL databases that are currently running in your Azure environment.

3. Check SQL Server settings: Click on the name of the SQL database for which you want to check the vulnerability assessment setting. This will open the SQL database dashboard. From here, click on "Security" in the left-hand menu, then click on "Vulnerability Assessment".

4. Check Periodic Recurring Scans setting: In the Vulnerability Assessment settings, look for the "Periodic Recurring Scans" setting. If this setting is set to "On", then vulnerability assessment scans are being performed on a regular basis. If it is set to "Off", then regular vulnerability assessment scans are not being performed.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install the Azure CLI on your local machine. You can download it from the official Microsoft Azure website. After installation, open your command prompt or terminal.

2. Login to Azure Account: Use the following command to log in to your Azure account. You will be redirected to the browser for login.
   ```
   az login
   ```
3. Select the Subscription: If you have multiple subscriptions, select the subscription where the SQL server is located. Replace 'my-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'my-subscription-id'
   ```
4. Check Vulnerability Assessment Setting: Use the following command to check the vulnerability assessment setting for a SQL server. Replace 'my-resource-group', 'my-server' and 'my-database' with your actual resource group, server, and database names.
   ```
   az sql db va show --name 'my-database' --resource-group 'my-resource-group' --server 'my-server' --query 'recurringScans'
   ```
   If the 'isEnabled' field in the output is 'true', then the periodic recurring scans are set to on. If it's 'false', then the scans are not set to on.

#### Using Python

1. Install the necessary Python libraries: You will need the 'azure-mgmt-sql' library to interact with Azure SQL databases. You can install it using pip:

```python
pip install azure-mgmt-sql
```

2. Authenticate with Azure: Before you can interact with Azure resources, you need to authenticate. You can do this using a service principal or managed identity. Here is an example of how to authenticate using a service principal:

```python
from azure.common.credentials import ServicePrincipalCredentials

credentials = ServicePrincipalCredentials(
    client_id = 'your-client-id',
    secret = 'your-secret',
    tenant = 'your-tenant-id'
)
```

3. Connect to the SQL server: Once you have authenticated, you can connect to the SQL server. You will need the server's resource group name and server name:

```python
from azure.mgmt.sql import SqlManagementClient

sql_client = SqlManagementClient(credentials, 'your-subscription-id')
server = sql_client.servers.get('your-resource-group', 'your-server-name')
```

4. Check the vulnerability assessment settings: You can now check the vulnerability assessment settings for the server. If the 'recurringScans' property is not set to 'Enabled', then the server is misconfigured:

```python
va_policy = sql_client.server_vulnerability_assessments.get('your-resource-group', 'your-server-name')

if va_policy.recurring_scans.emails_subscription == 'Disabled':
    print('Misconfiguration detected: Periodic recurring scans are not enabled.')
else:
    print('No misconfiguration detected.')
```

This script will print a message indicating whether or not the server is misconfigured. You can modify it to suit your needs, for example by raising an exception or sending an alert if a misconfiguration is detected.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Periodic Recurring Scans Is Set To On" for AZURE using AZURE console, follow the below steps:

1. Login to the Azure portal using your credentials.
2. Navigate to the Security Center dashboard from the left-hand side menu.
3. Click on the "Security policy" tab from the top menu.
4. Select the subscription and the scope for which you want to configure the vulnerability assessment settings.
5. Click on the "Edit" button to edit the security policy.
6. Scroll down to the "Vulnerability Assessment" section and click on the "On" button for "Periodic recurring scans".
7. Set the "Recurring scans" frequency as per your requirement.
8. Click on the "Save" button to save the changes.

Once the above steps are completed, the vulnerability assessment setting for periodic recurring scans will be turned on and the system will perform periodic scans as per the configured frequency.

#### Using CLI

To remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Periodic Recurring Scans Is Set To On" for Azure using Azure CLI, you can follow the below steps:

1. Open the Azure CLI command prompt.
2. Run the following command to enable vulnerability assessment for the specified Azure SQL Server:

   ```
   az sql server va show --resource-group <resource-group-name> --server <server-name> --name default
   ```

   This command will show the current status of vulnerability assessment for the specified Azure SQL Server.

3. Run the following command to enable periodic recurring scans for the specified Azure SQL Server:

   ```
   az sql server va update --resource-group <resource-group-name> --server <server-name> --name default --email-admins On --email-address <email-address> --state On --recurring-scans-interval 1
   ```

   This command will enable periodic recurring scans for the specified Azure SQL Server with a frequency of 1 day.

4. Verify the vulnerability assessment settings by running the following command:

   ```
   az sql server va show --resource-group <resource-group-name> --server <server-name> --name default
   ```

   This command will show the updated status of vulnerability assessment for the specified Azure SQL Server.

By following these steps, you can remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Periodic Recurring Scans Is Set To On" for Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration "Ensure That Vulnerability Assessment Setting Periodic Recurring Scans Is Set To On" in Azure using Python, you can use the Azure SDK for Python. Here are the steps to remediate the issue:

1. Install the Azure SDK for Python using the following command:

```
pip install azure-mgmt-security
```

2. Import the necessary modules:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.security import SecurityCenter
```

3. Set up the credentials and the client:

```python
TENANT_ID = '<your tenant id>'
CLIENT_ID = '<your client id>'
CLIENT_SECRET = '<your client secret>'
SUBSCRIPTION_ID = '<your subscription id>'

credentials = ServicePrincipalCredentials(
    client_id=CLIENT_ID,
    secret=CLIENT_SECRET,
    tenant=TENANT_ID
)

security_center_client = SecurityCenter(credentials, SUBSCRIPTION_ID)
```

4. Get the security policy for your subscription:

```python
policy = security_center_client.policies.get('default')
```

5. Update the vulnerability assessment setting to enable periodic recurring scans:

```python
vulnerability_assessment_settings = policy.security_contact_configurations.vulnerability_assessment
vulnerability_assessment_settings.recurring_scans = True

security_center_client.policies.create_or_update(policy.id, policy)
```

This will enable the vulnerability assessment setting for periodic recurring scans in Azure.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment](https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment) 


</Tab>
</Tabs>