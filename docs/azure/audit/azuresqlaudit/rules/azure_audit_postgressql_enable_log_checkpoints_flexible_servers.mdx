---
slug: azure_audit_postgressql_enable_log_checkpoints_flexible_servers
title: Enable log_checkpoints Parameter for PostgreSQL Flexible Servers
sidebar_label: Enable log_checkpoints Parameter for PostgreSQL Flexible Servers
---

### More Info:

Ensure that "log_checkpoints" server parameter is enabled for all PostgreSQL flexible database servers available within your Microsoft Azure cloud account. The "log_checkpoints" parameter allows checkpoints and restart points to be logged in the Azure PostgreSQL server log.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal (https://portal.azure.com/), and sign in with your Azure account credentials.

2. Navigate to PostgreSQL servers: On the Azure portal, click on "All services" in the left-hand menu. In the "All services" box, type "PostgreSQL servers" in the search bar and select it.

3. Select the PostgreSQL server: In the "PostgreSQL servers" pane, select the name of the PostgreSQL server for which you want to check the "log_checkpoints" parameter.

4. Check the "log_checkpoints" parameter: In the PostgreSQL server pane, click on "Server parameters" in the left-hand menu. In the "Server parameters" pane, look for the "log_checkpoints" parameter in the list. If the "log_checkpoints" parameter is set to "ON", it means that the logging of checkpoint starts and completions is enabled. If it's set to "OFF", it means that the logging is disabled.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have the Azure CLI installed on your system. You can download it from the official Microsoft Azure website.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your login credentials.
   ```
   az login
   ```
3. Select the Subscription: If you have multiple subscriptions, select the subscription where the PostgreSQL Flexible Server is located using the following command. Replace 'your-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'your-subscription-id'
   ```
4. Check the log_checkpoints Parameter: Use the following command to check the log_checkpoints parameter for your PostgreSQL Flexible Server. Replace 'your-resource-group' with the name of your resource group, 'your-server-name' with the name of your server, and 'log_checkpoints' with the parameter you want to check.
   ```
   az postgres flexible-server parameter show --resource-group 'your-resource-group' --server-name 'your-server-name' --name 'log_checkpoints'
   ```
This command will return the current configuration of the log_checkpoints parameter. If it is enabled, the value will be 'on'. If it is not enabled, the value will be 'off'.

#### Using Python

1. Install the necessary Python libraries: Before you can start, you need to install the necessary Python libraries. You will need the `psycopg2` library to connect to the PostgreSQL database and the `azure.identity` and `azure.mgmt.rdbms` libraries to interact with Azure. You can install these libraries using pip:

```python
pip install psycopg2-binary azure-identity azure-mgmt-rdbms
```

2. Connect to the PostgreSQL database: Use the `psycopg2` library to connect to the PostgreSQL database. You will need the connection details for the database, including the host, database name, username, and password.

```python
import psycopg2

def create_conn():
    conn = psycopg2.connect(
        host="your_host",
        database="your_database",
        user="your_username",
        password="your_password"
    )
    return conn
```

3. Query the PostgreSQL database: Once you have a connection to the database, you can query the `pg_settings` table to check the value of the `log_checkpoints` parameter. If the value is 'off', then the parameter is not enabled.

```python
def check_log_checkpoints(conn):
    cur = conn.cursor()
    cur.execute("SELECT setting FROM pg_settings WHERE name = 'log_checkpoints'")
    result = cur.fetchone()
    return result[0] == 'on'
```

4. Check the parameter for all PostgreSQL Flexible Servers: Use the `azure.mgmt.rdbms` library to get a list of all PostgreSQL Flexible Servers in your Azure subscription. For each server, connect to the database and check the `log_checkpoints` parameter.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.rdbms import PostgreSQLManagementClient

def check_all_servers():
    credential = DefaultAzureCredential()
    client = PostgreSQLManagementClient(credential, "your_subscription_id")

    for server in client.servers.list():
        conn = create_conn(server.fully_qualified_domain_name, "postgres", server.administrator_login, server.administrator_login_password)
        if not check_log_checkpoints(conn):
            print(f"Server {server.name} does not have log_checkpoints enabled.")
```

This script will print out the names of all servers that do not have the `log_checkpoints` parameter enabled.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To enable the `log_checkpoints` parameter for PostgreSQL Flexible Servers in Azure, you can follow the below steps:

1. Open the Azure portal and go to your PostgreSQL Flexible Server resource.

2. In the left-hand menu, click on the "Configuration" option.

3. In the "Configuration" blade, click on the "Edit" button located at the top.

4. In the "Edit configuration" blade, search for the `log_checkpoints` parameter in the "Parameters" section.

5. If the parameter is not present, click on the "Add parameter" button and enter the following details:
   - Name: log_checkpoints
   - Value: on

6. If the parameter is already present, click on the parameter and change its value to "on".

7. Click on the "Save" button to save the changes.

8. Once the changes are saved, the PostgreSQL Flexible Server will be restarted to apply the new configuration.

9. After the server is restarted, the `log_checkpoints` parameter will be enabled and the server will start logging checkpoint activities.

This will remediate the misconfiguration of not having the `log_checkpoints` parameter enabled for PostgreSQL Flexible Servers in Azure.

#### Using CLI

To remediate the misconfiguration "Enable log_checkpoints Parameter for PostgreSQL Flexible Servers" for Azure using Azure CLI, you can follow the below steps:

Step 1: Open Azure CLI and login to your Azure account using the command:

```
az login
```

Step 2: Once you are logged in, select the Azure subscription where your PostgreSQL Flexible Server is running using the command:

```
az account set --subscription <subscription_id>
```

Step 3: Now, enable the log_checkpoints parameter for your PostgreSQL Flexible Server using the following command:

```
az postgres flexible-server configuration set --name log_checkpoints --resource-group <resource_group_name> --server-name <server_name> --value on
```

Make sure to replace `<resource_group_name>` and `<server_name>` with the actual resource group name and server name where your PostgreSQL Flexible Server is running.

Step 4: Verify that the parameter has been enabled successfully using the following command:

```
az postgres flexible-server configuration show --name log_checkpoints --resource-group <resource_group_name> --server-name <server_name>
```

This will display the current value of the log_checkpoints parameter.

That's it! You have now successfully remediated the misconfiguration "Enable log_checkpoints Parameter for PostgreSQL Flexible Servers" for Azure using Azure CLI.

#### Using Python

To enable the `log_checkpoints` parameter for PostgreSQL Flexible Servers on Azure using Python, you can follow these steps:

1. Install the `azure-mgmt-postgresql` Python package using pip:

```
pip install azure-mgmt-postgresql
```

2. Import the necessary modules:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.postgresql import PostgreSQLManagementClient
from azure.mgmt.postgresql.models import ServerConfiguration
```

3. Set up the credentials for authentication:

```python
credential = DefaultAzureCredential()
subscription_id = '<subscription_id>'
resource_group_name = '<resource_group_name>'
server_name = '<server_name>'
```

4. Create the `PostgreSQLManagementClient` object:

```python
client = PostgreSQLManagementClient(credential, subscription_id)
```

5. Get the current server configurations:

```python
server_configurations = client.configurations.list_by_server(resource_group_name, server_name)
```

6. Check if the `log_checkpoints` parameter is already enabled:

```python
log_checkpoints_enabled = False
for configuration in server_configurations:
    if configuration.name == 'log_checkpoints':
        if configuration.value == 'on':
            log_checkpoints_enabled = True
        break
```

7. If the `log_checkpoints` parameter is not enabled, create a new configuration object and update the server configuration:

```python
if not log_checkpoints_enabled:
    new_configuration = ServerConfiguration(name='log_checkpoints', value='on')
    client.configurations.create_or_update(resource_group_name, server_name, 'log_checkpoints', new_configuration)
```

8. Verify that the `log_checkpoints` parameter is now enabled:

```python
server_configurations = client.configurations.list_by_server(resource_group_name, server_name)
for configuration in server_configurations:
    if configuration.name == 'log_checkpoints':
        if configuration.value == 'on':
            print('log_checkpoints parameter is now enabled')
        break
```

The complete code snippet to enable the `log_checkpoints` parameter for PostgreSQL Flexible Servers on Azure using Python is as follows:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.postgresql import PostgreSQLManagementClient
from azure.mgmt.postgresql.models import ServerConfiguration

credential = DefaultAzureCredential()
subscription_id = '<subscription_id>'
resource_group_name = '<resource_group_name>'
server_name = '<server_name>'

client = PostgreSQLManagementClient(credential, subscription_id)

server_configurations = client.configurations.list_by_server(resource_group_name, server_name)

log_checkpoints_enabled = False
for configuration in server_configurations:
    if configuration.name == 'log_checkpoints':
        if configuration.value == 'on':
            log_checkpoints_enabled = True
        break

if not log_checkpoints_enabled:
    new_configuration = ServerConfiguration(name='log_checkpoints', value='on')
    client.configurations.create_or_update(resource_group_name, server_name, 'log_checkpoints', new_configuration)

server_configurations = client.configurations.list_by_server(resource_group_name, server_name)
for configuration in server_configurations:
    if configuration.name == 'log_checkpoints':
        if configuration.value == 'on':
            print('log_checkpoints parameter is now enabled')
        break
```




</Tab>
</Tabs>