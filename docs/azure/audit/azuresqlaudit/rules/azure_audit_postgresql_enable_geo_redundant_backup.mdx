---
slug: azure_audit_postgresql_enable_geo_redundant_backup
title: Enable Geo-Redundant Backups
sidebar_label: Enable Geo-Redundant Backups
---

### More Info:

Ensure that your Microsoft Azure PostgreSQL database servers have geo-redundant backups enabled, to allow you to restore your PostgreSQL servers to a different Azure region in the event of a regional outage or a disaster.

### Risk Level

High

### Address

Security

### Compliance Standards

HITRUST, SOC2, NISTCSF


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your Azure account credentials.
2. Navigate to the SQL databases section from the left-hand side menu. Here, you will see a list of all the SQL databases that are currently running in your Azure environment.
3. Click on the specific SQL database for which you want to check the Geo-Redundant Backup configuration. This will open the database's dashboard.
4. In the database's dashboard, go to the 'Settings' section and click on 'Backup'. Here, you can see the current backup configuration for your database. If the 'Geo-Redundant Backup' option is enabled, it means that the Geo-Redundant Backups are currently active for your database. If not, it means that the Geo-Redundant Backups are not enabled.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have it installed on your local machine. You can download it from the official Microsoft Azure website and follow the installation instructions.

2. Login to Azure: Open your command line interface and type the following command to login to your Azure account:
   ```
   az login
   ```
   Follow the prompts in your browser to complete the authentication process.

3. Select the Subscription: If you have multiple subscriptions, you need to select the subscription where your SQL Server is located. Use the following command to list all your subscriptions:
   ```
   az account list --output table
   ```
   Then, use the following command to set your desired subscription:
   ```
   az account set --subscription "Your Subscription Name"
   ```

4. Check Geo-Redundant Backup: Now, you can check the status of Geo-Redundant Backups for your SQL Server. Use the following command:
   ```
   az sql server show --name YourSqlServerName --resource-group YourResourceGroupName --query backupStorageRedundancy
   ```
   If the output is "Geo", then Geo-Redundant Backups are enabled. If the output is "Local", then Geo-Redundant Backups are not enabled.

#### Using Python

To check if Geo-Redundant Backups are enabled in Azure SQL using Python scripts, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: You need to install the Azure SDK for Python to interact with Azure resources. You can install it using pip:
   ```bash
   pip install azure-mgmt-sql
   ```

2. **Authenticate with Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for this. Here is a sample code snippet:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.sql import SqlManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'  # replace with your Azure Subscription ID
   sql_client = SqlManagementClient(credential, subscription_id)
   ```

3. **List all SQL Servers and Databases**: Now, you can list all SQL servers and databases in your subscription. Here is a sample code snippet:
   ```python
   for server in sql_client.servers.list():
       for database in sql_client.databases.list_by_server(server.resource_group, server.name):
           print(f"Server: {server.name}, Database: {database.name}")
   ```

4. **Check Geo-Redundant Backup Setting**: For each database, you can check if Geo-Redundant Backups are enabled. Here is a sample code snippet:
   ```python
   for server in sql_client.servers.list():
       for database in sql_client.databases.list_by_server(server.resource_group, server.name):
           if database.geo_redundant_backup == "Disabled":
               print(f"Server: {server.name}, Database: {database.name}, Geo-Redundant Backup: Disabled")
   ```
   This script will print the names of all servers and databases where Geo-Redundant Backups are disabled.

Please replace 'your-subscription-id' with your actual Azure Subscription ID. Also, ensure that you have the necessary permissions to list and view properties of SQL servers and databases in your Azure subscription.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of not having Geo-Redundant Backups enabled in Azure, follow these step-by-step instructions:

1. Log in to the Azure portal at https://portal.azure.com/.
2. Navigate to the resource group that contains the storage account you want to remediate.
3. Select the storage account from the list of resources.
4. In the left-hand menu, click on "Backup".
5. In the "Backup" menu, click on "Backup policy".
6. Click on "Edit".
7. In the "Policy details" section, select "Geo-redundant" from the "Replication" drop-down menu.
8. Click on "Save".

After completing these steps, Geo-Redundant Backups will be enabled for the selected storage account. It is recommended to regularly review and update backup policies to ensure that they align with your business continuity and disaster recovery requirements.

#### Using CLI

To remediate the misconfiguration of not having Geo-Redundant Backups enabled in Azure using Azure CLI, you can follow these steps:

1. Open the Azure CLI command prompt or terminal.

2. Login to your Azure account using the command: 

   ```
   az login
   ```

3. Once you are logged in, set the target subscription using the command:

   ```
   az account set --subscription <subscription_id>
   ```

4. Next, enable Geo-Redundant Backups for the desired resource group using the command:

   ```
   az backup vault backup-properties set --backup-management-type AzureIaasVM --resource-group <resource_group_name> --vault-name <vault_name> --backup-storage-redundancy GeoRedundant
   ```

   Here, replace `<resource_group_name>` with the name of the resource group where the backup vault is located and `<vault_name>` with the name of the backup vault.

5. Verify the backup properties using the command:

   ```
   az backup vault backup-properties show --backup-management-type AzureIaasVM --resource-group <resource_group_name> --vault-name <vault_name>
   ```

   This command will display the backup properties for the specified backup vault.

6. Once you have verified that Geo-Redundant Backups have been enabled, you can exit the Azure CLI using the command:

   ```
   exit
   ```

With these steps, you should be able to remediate the misconfiguration of not having Geo-Redundant Backups enabled in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of not having Geo-Redundant Backups enabled in Azure using Python, you can use the Azure SDK for Python. Here are the step-by-step instructions:

1. Install the Azure SDK for Python using pip:

```python
pip install azure-mgmt-recoveryservicesbackup
```

2. Import the necessary modules:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.recoveryservicesbackup import RecoveryServicesBackupClient
from azure.mgmt.recoveryservicesbackup.models import ProtectionIntent
```

3. Set up the authentication credentials using a service principal:

```python
credentials = ServicePrincipalCredentials(
    client_id='<client_id>',
    secret='<client_secret>',
    tenant='<tenant_id>'
)
```

4. Instantiate the `RecoveryServicesBackupClient` using the authentication credentials:

```python
client = RecoveryServicesBackupClient(credentials, '<subscription_id>')
```

5. Get the list of protection intents:

```python
protection_intents = client.protection_intents.list()
```

6. Check if Geo-Redundant Backups are enabled for each protection intent:

```python
for protection_intent in protection_intents:
    if protection_intent.properties.backup_management_type == 'AzureIaasVM':
        if not protection_intent.properties.is_geo_redundant:
            # Enable Geo-Redundant Backups
            protection_intent.properties.is_geo_redundant = True
            client.protection_intents.create_or_update(
                protection_intent.name,
                protection_intent
            )
```

7. Save the changes by calling `create_or_update` on each protection intent that had Geo-Redundant Backups enabled.

That's it! With these steps, you can remediate the misconfiguration of not having Geo-Redundant Backups enabled in Azure using Python.




</Tab>
</Tabs>