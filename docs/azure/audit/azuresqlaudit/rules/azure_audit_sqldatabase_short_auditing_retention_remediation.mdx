

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to SQL databases: From the left-hand menu, click on "SQL databases" to view all the SQL databases in your Azure environment.

3. Check auditing settings: For each SQL database, click on the database name to open its dashboard. From there, navigate to the "Security" section and click on "Auditing". Here, you can see the retention period for the audit logs.

4. Verify retention period: Check the number of days set in the "Retention (days)" field. If the retention period is less than 90 days, it is considered a short auditing retention period misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List SQL Servers: Use the following command to list all the SQL servers in your Azure account. This will return a list of all SQL servers along with their properties.
    ```
    az sql server list --output table
    ```
3. List SQL Databases: For each SQL server, list all the databases using the following command. Replace `<server_name>` with the name of your SQL server.
    ```
    az sql db list --server <server_name> --output table
    ```
4. Check Auditing Retention Period: For each database, check the auditing retention period using the following command. Replace `<server_name>` and `<database_name>` with the name of your SQL server and database respectively. The `retentionDays` property in the output indicates the auditing retention period.
    ```
    az sql db audit-policy show --name <database_name> --server <server_name> --resource-group <resource_group_name> --query 'retentionDays'
    ```
If the `retentionDays` is less than the recommended value (for example, 90 days), then it indicates a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: Before you can start, you need to install the necessary Python libraries. You can do this by running the following command in your terminal:

```python
pip install azure-mgmt-sql
```

2. Import the necessary Python libraries: After you have installed the necessary Python libraries, you need to import them into your Python script. You can do this by adding the following lines of code at the top of your script:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.sql import SqlManagementClient
```

3. Authenticate with Azure: Before you can interact with Azure, you need to authenticate. You can do this by adding the following lines of code to your script:

```python
credentials = ServicePrincipalCredentials(
    client_id = 'your_client_id',
    secret = 'your_secret',
    tenant = 'your_tenant_id'
)

client = SqlManagementClient(credentials, 'your_subscription_id')
```

4. Check the auditing retention period: Now that you are authenticated, you can check the auditing retention period for your SQL databases. You can do this by adding the following lines of code to your script:

```python
for server in client.servers.list():
    for database in client.databases.list_by_server(server.resource_group, server.name):
        blob_auditing_policies = client.database_blob_auditing_policies.get(server.resource_group, server.name, database.name)
        if blob_auditing_policies.retention_days < 90:
            print(f"The database {database.name} on server {server.name} has a short auditing retention period of {blob_auditing_policies.retention_days} days.")
```

This script will print out the names of all databases that have an auditing retention period of less than 90 days.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the short auditing retention period for SQL databases in AZURE using the AZURE console, follow these steps:

1. Log in to the AZURE portal and navigate to the SQL server that needs to be remediated.

2. Click on the "Auditing" tab from the left-hand menu.

3. Under the "Auditing" tab, click on the "Diagnostic settings" option.

4. Click on the "Edit setting" option to modify the diagnostic settings.

5. Under the "Retention (days)" option, increase the retention period to a value that meets your organization's compliance requirements.

6. Click on the "Save" button to save the changes.

7. Once the changes are saved, you will receive a notification that the diagnostic settings have been updated successfully.

By following these steps, you can remediate the short auditing retention period for SQL databases in AZURE using the AZURE console.

#### Using CLI

To remediate the short auditing retention period for SQL databases in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI and login to your Azure account using the command: 

   ```
   az login
   ```

2. Once you are logged in, select the subscription that contains the SQL database you want to remediate using the command:

   ```
   az account set --subscription <subscription-id>
   ```

   Replace `<subscription-id>` with the ID of the subscription that contains the SQL database.

3. Check the current auditing retention period for the SQL database using the command:

   ```
   az sql db audit-policy show --name <database-name> --resource-group <resource-group-name> --server <server-name>
   ```

   Replace `<database-name>`, `<resource-group-name>`, and `<server-name>` with the name of the SQL database, the resource group it belongs to, and the name of the server that hosts the database.

4. If the retention period is less than the required duration, remediate it by setting the retention period to the required duration using the command:

   ```
   az sql db audit-policy update --name <database-name> --resource-group <resource-group-name> --server <server-name> --state Enabled --retention-days <retention-period>
   ```

   Replace `<database-name>`, `<resource-group-name>`, and `<server-name>` with the name of the SQL database, the resource group it belongs to, and the name of the server that hosts the database. Replace `<retention-period>` with the required retention period in days.

5. Verify that the retention period has been updated by running the command in step 3 again.

By following these steps, you can remediate the short auditing retention period for SQL databases in Azure using Azure CLI.

#### Using Python

To remediate the short auditing retention period for SQL databases in Azure, you can use the following steps in Python:

1. Import the required modules:
```python
import os
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.sql import SqlManagementClient
```

2. Set up the credentials to authenticate with Azure:
```python
subscription_id = '<subscription_id>'
client_id = '<client_id>'
client_secret = '<client_secret>'
tenant_id = '<tenant_id>'

credentials = ServicePrincipalCredentials(
    client_id=client_id,
    secret=client_secret,
    tenant=tenant_id
)
```

3. Instantiate the SQL Management client:
```python
sql_client = SqlManagementClient(
    credentials=credentials,
    subscription_id=subscription_id
)
```

4. Get the SQL server and database you want to remediate:
```python
server_name = '<server_name>'
database_name = '<database_name>'

server = sql_client.servers.get_by_resource_group('<resource_group_name>', server_name)
database = sql_client.databases.get('<resource_group_name>', server_name, database_name)
```

5. Check the current auditing retention period for the database:
```python
print(database.auditing_policy.retention_days)
```

6. Set the new auditing retention period for the database (e.g. 90 days):
```python
database.auditing_policy.retention_days = 90
sql_client.databases.create_or_update('<resource_group_name>', server_name, database_name, database)
```

7. Verify that the new auditing retention period has been set:
```python
print(database.auditing_policy.retention_days)
```

These steps will remediate the short auditing retention period for the specified SQL database in Azure.


</Tab>
</Tabs>