

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the Azure portal: Navigate to the Azure portal and sign in with your Azure account credentials.

2. Navigate to SQL servers: From the left-hand menu, select "SQL servers" under the "Databases" section. This will display a list of all SQL servers associated with your Azure account.

3. Check Active Directory Admin configuration: Click on the name of the SQL server you want to check. This will open the server's dashboard. From here, select "Active Directory admin" under the "Settings" section. 

4. Verify the configuration: On the Active Directory admin page, check if an admin is configured. If an admin is not configured, the page will display "Not configured". If an admin is configured, the page will display the name of the admin.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft website. Once installed, open your command prompt or terminal and type `az` to ensure it's installed correctly.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your credentials and login.
   ```
   az login
   ```
3. Select the Subscription: If you have multiple subscriptions, select the subscription where your SQL Server is located. Replace 'my-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'my-subscription-id'
   ```
4. Check Azure Active Directory Admin: Use the following command to check the Azure Active Directory Admin for your SQL Server. Replace 'my-resource-group' and 'my-server' with your actual resource group and server name.
   ```
   az sql server ad-admin show --resource-group 'my-resource-group' --server 'my-server'
   ```
   If the Azure Active Directory Admin is not configured, the command will return an empty JSON object. If it is configured, it will return the details of the admin.

#### Using Python

1. Install and Import Required Libraries:
   First, you need to install and import the required libraries. You will need the 'azure-mgmt-sql' library to interact with Azure SQL Server resources and 'azure-identity' for Azure Identity client library.

   ```python
   pip install azure-mgmt-sql azure-identity
   ```

   Then import the necessary modules in your python script.

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.sql import SqlManagementClient
   ```

2. Authenticate and Initialize SQL Management Client:
   Use the DefaultAzureCredential from the azure-identity library to authenticate your application. Then, initialize the SqlManagementClient with your subscription ID.

   ```python
   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   sql_client = SqlManagementClient(credential, subscription_id)
   ```

3. List All SQL Servers and Check for Azure AD Admin:
   Now, you can list all the SQL servers in your subscription and check if Azure AD Admin is configured for each server.

   ```python
   for server in sql_client.servers.list():
       server_azure_ad_admin = sql_client.server_azure_ad_administrators.get(server.resource_group, server.name)
       if server_azure_ad_admin.login is None:
           print(f"Azure AD Admin is not configured for SQL Server: {server.name}")
   ```

4. Analyze the Output:
   The script will print the names of all SQL servers where Azure AD Admin is not configured. If no output is returned, it means Azure AD Admin is configured for all SQL servers in your subscription.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of not having Azure Active Directory (AD) Admin configured, you can follow these steps:

1. Log in to the Azure portal (https://portal.azure.com) using your credentials.
2. In the left-hand menu, click on "Azure Active Directory".
3. Click on "Properties" under the "Manage" section in the left-hand menu.
4. Scroll down to the "Azure AD admin" section.
5. Click on "Set Azure AD admin" button.
6. In the "Set administrator" pane, select the user or group that you want to designate as the Azure AD admin.
7. Click on the "Select" button.
8. Click on the "Save" button to save the changes.

Once you have completed the above steps, the Azure AD admin will be configured, and you will have successfully remediated the misconfiguration.

#### Using CLI

To remediate the misconfiguration "Ensure That Azure Active Directory Admin Is Configured" for AZURE using AZURE CLI, follow the below steps:

1. Open the AZURE CLI and login to your Azure account using the command: 

   ```
   az login
   ```

2. Once you are logged in, set your subscription using the command:

   ```
   az account set --subscription <subscription-id>
   ```

   Replace `<subscription-id>` with the ID of your Azure subscription.

3. Next, use the following command to set the Azure Active Directory (Azure AD) admin for your subscription:

   ```
   az ad sp create-for-rbac --role="Owner" --scopes="/subscriptions/<subscription-id>"
   ```

   Replace `<subscription-id>` with the ID of your Azure subscription.

4. This command will create a new Azure AD application and assign it the Owner role for your subscription. It will output the following details:

   - `appId`: The Application ID of the newly created Azure AD application.
   - `displayName`: The display name of the Azure AD application.
   - `password`: The password for the Azure AD application. This is the only time the password will be shown, so make sure to save it in a secure location.
   - `tenant`: The ID of the Azure AD tenant associated with the subscription.

5. Finally, use the following command to assign the newly created Azure AD application as the subscription admin:

   ```
   az role assignment create --assignee <appId> --role "Owner" --subscription <subscription-id>
   ```

   Replace `<appId>` with the Application ID of the newly created Azure AD application, and `<subscription-id>` with the ID of your Azure subscription.

6. After running the above command, the Azure AD admin will be configured for your subscription. You can verify this by running the following command:

   ```
   az account show
   ```

   This command will display the details of your Azure subscription, including the Azure AD admin.

#### Using Python

To remediate the misconfiguration "Ensure that Azure Active Directory Admin is configured" in Azure using Python, you can follow the below steps:

Step 1: Install the Azure SDK for Python using the pip command:

```python
!pip install azure-mgmt-resource
```

Step 2: Import the required modules:

```python
from azure.common.credentials import UserPassCredentials
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.sql import SqlManagementClient
```

Step 3: Authenticate and create a client object:

```python
subscription_id = 'your_subscription_id'
username = 'your_username'
password = 'your_password'
credentials = UserPassCredentials(username, password)

resource_client = ResourceManagementClient(credentials, subscription_id)
sql_client = SqlManagementClient(credentials, subscription_id)
```

Step 4: Get the list of all SQL servers in the subscription:

```python
servers = sql_client.servers.list()
```

Step 5: For each SQL server, check if the Azure Active Directory Admin is configured:

```python
for server in servers:
    server_name = server.name
    server_resource_group = server.resource_group_name
    server_details = resource_client.resources.get_by_id(
        server.id, 
        api_version='2018-06-01-preview'
    )
    properties = server_details.properties
    if 'administratorLogin' in properties and 'administratorLoginPassword' in properties:
        admin_login = properties['administratorLogin']
        admin_password = properties['administratorLoginPassword']
        aad_admin = sql_client.servers.get_server_auditing_policy(
            server_resource_group, 
            server_name
        ).auditing_policy_details.audit_actions_and_groups.audit_actions.contains('DATABASE_SQL_AUDIT_ACTION_GROUP')
        if not aad_admin:
            sql_client.servers.create_or_update_server_auditing_policy(
                server_resource_group, 
                server_name, 
                {
                    "properties": {
                        "state": "Enabled",
                        "auditActionsAndGroups": {
                            "auditActions": [
                                "DATABASE_SQL_AUDIT_ACTION_GROUP"
                            ]
                        },
                        "storageEndpoint": "https://your_storage_account.blob.core.windows.net",
                        "storageAccountAccessKey": "your_storage_account_access_key",
                        "storageAccountSubscriptionId": "your_storage_account_subscription_id",
                        "retentionDays": 90,
                        "useServerDefault": False
                    }
                }
            )
            print(f"Azure Active Directory Admin is configured for SQL server {server_name}")
    else:
        print(f"Admin login and password not found for SQL server {server_name}")
```

Note: You will need to replace the placeholders `your_subscription_id`, `your_username`, `your_password`, `your_storage_account`, `your_storage_account_access_key`, and `your_storage_account_subscription_id` with your own values.

The above code will enable auditing for the SQL server and ensure that the Azure Active Directory Admin is configured.


</Tab>
</Tabs>