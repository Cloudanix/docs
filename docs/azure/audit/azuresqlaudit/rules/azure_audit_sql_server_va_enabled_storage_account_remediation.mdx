

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal and navigate to the SQL servers section.
2. Select the SQL server you want to check for vulnerability assessment settings.
3. In the SQL server blade, under the 'Security' section, click on 'Vulnerability Assessment'.
4. Check the 'Storage Account' setting. If it is not set or enabled, then the vulnerability assessment is not enabled on the SQL server.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. After installation, open your command prompt and type `az` to ensure it's installed correctly.

2. Login to Azure Account: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your credentials and login.
   ```
   az login
   ```
3. List SQL Servers: Now, you need to list all the SQL servers in your account. Use the following command to do so. This will return a list of all SQL servers along with their details.
   ```
   az sql server list --query "[].{name:name, resourceGroup:resourceGroup}"
   ```
4. Check Vulnerability Assessment Setting: For each SQL server, check if the vulnerability assessment is enabled or not. Replace `<server_name>` and `<resource_group>` with your actual server name and resource group.
   ```
   az sql va show --name <server_name> --resource-group <resource_group> --query "storageContainerPath"
   ```
   If the `storageContainerPath` is null, it means the vulnerability assessment is not enabled on the SQL server.

#### Using Python

1. Install and import the necessary Python libraries. You will need the 'azure-mgmt-sql' library to interact with Azure SQL Server and 'azure-mgmt-storage' to interact with Azure Storage. You can install these using pip:

```python
pip install azure-mgmt-sql azure-mgmt-storage
```

Then import the necessary modules in your Python script:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.sql import SqlManagementClient
from azure.mgmt.storage import StorageManagementClient
```

2. Establish a connection to Azure. You will need to authenticate using a service principal which has the necessary permissions to access your SQL Server and Storage Account. Replace 'your_client_id', 'your_secret', 'your_tenant' with your Azure Active Directory ID, Secret and Tenant ID respectively.

```python
credentials = ServicePrincipalCredentials(
    client_id='your_client_id',
    secret='your_secret',
    tenant='your_tenant'
)
```

3. Instantiate a client object for SQL Server and Storage Account. Replace 'your_subscription_id' with your Azure subscription ID.

```python
sql_client = SqlManagementClient(credentials, 'your_subscription_id')
storage_client = StorageManagementClient(credentials, 'your_subscription_id')
```

4. Check if Vulnerability Assessment is enabled on SQL Server. You can do this by retrieving the server's vulnerability assessment settings and checking if the 'storageContainerPath' property is set. If it is not set, Vulnerability Assessment is not enabled. Replace 'resource_group_name' and 'server_name' with your resource group and server names respectively.

```python
va_settings = sql_client.server_vulnerability_assessments.get('resource_group_name', 'server_name')
if not va_settings.storage_container_path:
    print("Vulnerability Assessment is not enabled on SQL Server.")
else:
    print("Vulnerability Assessment is enabled on SQL Server.")
```

This script will print a message indicating whether Vulnerability Assessment is enabled on the specified SQL Server.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure That Vulnerability Assessment Is Enabled On SQL Server By Setting Storage Account" in Azure using Azure console, follow the below steps:

1. Login to the Azure portal (https://portal.azure.com/) using your credentials.
2. Navigate to the SQL server that you want to remediate.
3. Click on the "Security + Compliance" option from the left-hand side menu.
4. Under the "Security + Compliance" menu, click on the "Vulnerability assessment" option.
5. In the "Vulnerability assessment" page, click on the "Storage settings" tab.
6. Click on the "Configure storage settings" button.
7. In the "Configure storage settings" page, select the "Use existing storage account" option.
8. Select the storage account that you want to use for vulnerability assessment.
9. Click on the "Save" button to save the changes.

By following the above steps, you have successfully remediated the misconfiguration "Ensure That Vulnerability Assessment Is Enabled On SQL Server By Setting Storage Account" in Azure using Azure console.

#### Using CLI

To remediate this misconfiguration in AZURE using AZURE CLI, follow these steps:

1. Open the AZURE CLI terminal and log in to your AZURE account using the command `az login`.

2. Once you are logged in, set the subscription in which the SQL Server is running using the command `az account set --subscription <subscription_id>`.

3. Now, create a new storage account or use an existing one to store the vulnerability assessment scan results. You can create a new storage account using the command `az storage account create --name <storage_account_name> --resource-group <resource_group_name> --location <location> --sku Standard_LRS`, where `<storage_account_name>` is the name of the storage account, `<resource_group_name>` is the name of the resource group in which the storage account will be created, and `<location>` is the location where the storage account will be created.

4. Once the storage account is created, enable vulnerability assessment on the SQL Server using the command `az sql server va create --resource-group <resource_group_name> --server <sql_server_name> --storage-account <storage_account_name> --storage-key <storage_account_key> --scan-results-container-name <container_name>`, where `<resource_group_name>` is the name of the resource group in which the SQL Server is running, `<sql_server_name>` is the name of the SQL Server, `<storage_account_name>` is the name of the storage account created in step 3, `<storage_account_key>` is the access key of the storage account, and `<container_name>` is the name of the container in which the vulnerability assessment scan results will be stored.

5. Once the vulnerability assessment is enabled, you can run a scan on the SQL Server using the command `az sql server va scan create --resource-group <resource_group_name> --server <sql_server_name> --scan-id <scan_id>`, where `<resource_group_name>` is the name of the resource group in which the SQL Server is running, `<sql_server_name>` is the name of the SQL Server, and `<scan_id>` is the ID of the vulnerability assessment scan.

By following these steps, you can remediate the misconfiguration and ensure that vulnerability assessment is enabled on SQL Server by setting the storage account in AZURE using AZURE CLI.

#### Using Python

To remediate the misconfiguration "Ensure that Vulnerability Assessment is enabled on SQL Server by setting storage account" in Azure using Python, follow these steps:

1. Import the necessary libraries:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.sql import SqlManagementClient
from azure.mgmt.storage import StorageManagementClient
from azure.mgmt.storage.models import StorageAccountCreateParameters
```

2. Set up the Azure credentials:

```python
credential = DefaultAzureCredential()
subscription_id = '<subscription_id>'
resource_group_name = '<resource_group_name>'
server_name = '<server_name>'
database_name = '<database_name>'
storage_account_name = '<storage_account_name>'
storage_account_key = '<storage_account_key>'
```

3. Create a Storage Account:

```python
storage_client = StorageManagementClient(credential, subscription_id)
storage_params = StorageAccountCreateParameters(
    sku={"name": "Standard_LRS"},
    kind="StorageV2",
    location="<location>"
)
storage_async_operation = storage_client.storage_accounts.create(
    resource_group_name,
    storage_account_name,
    storage_params
)
storage_account = storage_async_operation.result()
```

4. Enable Vulnerability Assessment on SQL Server:

```python
sql_client = SqlManagementClient(credential, subscription_id)
sql_client.vulnerability_assessments.create_or_update(
    resource_group_name,
    server_name,
    database_name,
    "default",
    {
        "storage_container_path": "<container_path>",
        "storage_account_access_key": storage_account_key,
        "recurring_scans": {
            "isEnabled": True,
            "emailSubscriptionAdmins": False,
            "emails": []
        }
    }
)
```

5. Verify that Vulnerability Assessment is enabled:

```python
vulnerability_assessment = sql_client.vulnerability_assessments.get(
    resource_group_name,
    server_name,
    database_name,
    "default"
)
print(vulnerability_assessment.state)
```

Note: Replace the placeholders `<subscription_id>`, `<resource_group_name>`, `<server_name>`, `<database_name>`, `<storage_account_name>`, `<storage_account_key>`, `<location>` and `<container_path>` with the appropriate values for your environment.


</Tab>
</Tabs>