---
slug: azure_audit_cosmosdb_restrict_default_network_access
title: Restrict Default Network Access for Azure Cosmos DB Accounts
sidebar_label: Restrict Default Network Access for Azure Cosmos DB Accounts
---

### More Info:

Ensure that your Microsoft Azure Cosmos DB accounts are configured to deny access to traffic from all networks, including the public Internet. By restricting the public access to your Azure Cosmos accounts, you add an additional layer of security to the account resources, as the default action is to accept requests from any source. To limit access to trusted networks and/or IP addresses only, you must update the firewall and the virtual network configuration for your Cosmos DB accounts.

### Risk Level

Medium

### Address

Security

### Compliance Standards




<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the Azure portal: Navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to Azure Cosmos DB: On the left-hand side menu, click on "Azure Cosmos DB". This will open up a list of all the Azure Cosmos DB accounts associated with your Azure subscription.

3. Select the Azure Cosmos DB account: From the list of Azure Cosmos DB accounts, select the account for which you want to check the default network access.

4. Check the Firewall and Virtual Networks settings: Once you've selected the Azure Cosmos DB account, navigate to the "Firewall and Virtual Networks" settings under the "Security" section. Here, you can check the "Allow access from" setting. If it's set to "All networks", then the default network access is not restricted for this Azure Cosmos DB account.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. After installation, open your command prompt or terminal.

2. Login to Azure Account: Use the following command to login to your Azure account. You will be redirected to the Azure login page where you need to enter your credentials.
   ```
   az login
   ```
3. List Cosmos DB Accounts: Use the following command to list all the Cosmos DB accounts in your Azure subscription. This will return a list of all Cosmos DB accounts with their details.
   ```
   az cosmosdb list --query "[].{name:name, resourceGroup:resourceGroup}"
   ```
4. Check Default Network Access: For each Cosmos DB account, use the following command to check the default network access. Replace `<name>` with the name of your Cosmos DB account and `<resource-group>` with the name of the resource group. If the output is 'All', then the default network access is not restricted.
   ```
   az cosmosdb show --name <name> --resource-group <resource-group> --query publicNetworkAccess
   ```

#### Using Python

1. Install Azure SDK: To interact with Azure services, you need to install Azure SDK for Python. You can install it using pip:
```python
pip install azure-mgmt-cosmosdb
```

2. Authenticate with Azure: Before you can interact with Azure services, you need to authenticate. You can authenticate using Azure CLI or by creating a service principal and using it to authenticate. Here is an example of how to authenticate using Azure CLI:
```python
from azure.identity import AzureCliCredential
from azure.mgmt.cosmosdb import CosmosDBManagementClient

credential = AzureCliCredential()
subscription_id = 'your-subscription-id'
client = CosmosDBManagementClient(credential, subscription_id)
```

3. List all Cosmos DB Accounts: Once you have authenticated, you can list all Cosmos DB accounts in your subscription. Here is an example of how to do it:
```python
for account in client.database_accounts.list():
    print(account.name)
```

4. Check Default Network Access: For each Cosmos DB account, you can check if default network access is restricted. If the `public_network_access` property is set to 'Enabled', then default network access is not restricted. Here is an example of how to check this:
```python
for account in client.database_accounts.list():
    if account.public_network_access == 'Enabled':
        print(f'Default network access is not restricted for {account.name}')
```
This script will print the names of all Cosmos DB accounts for which default network access is not restricted.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Restrict Default Network Access for Azure Cosmos DB Accounts" in Azure using the Azure console, follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/).

2. Navigate to the Azure Cosmos DB account for which you want to restrict network access.

3. Click on the "Firewalls and virtual networks" tab.

4. Under the "Firewall" section, select "Enabled".

5. Under the "Virtual networks" section, select the virtual network that you want to allow access to.

6. Under the "Subnets" section, select the subnet that you want to allow access to.

7. Click on "Save" to apply the changes.

By following these steps, you have successfully remediated the misconfiguration "Restrict Default Network Access for Azure Cosmos DB Accounts" in Azure using the Azure console.

#### Using CLI

To remediate the misconfiguration "Restrict Default Network Access for Azure Cosmos DB Accounts" in Azure using Azure CLI, follow the below steps:

1. Open the Azure CLI on your local machine or use the Azure Cloud Shell.
2. Login to your Azure account using the command `az login`.
3. Once logged in, select the subscription you want to work with using the command `az account set --subscription <subscription_id>`.
4. Get the list of Cosmos DB accounts in the selected subscription using the command `az cosmosdb list`.
5. Choose the Cosmos DB account for which you want to restrict default network access.
6. Run the following command to update the Cosmos DB account settings to restrict default network access:

```
az cosmosdb update \
    --name <cosmos_db_account_name> \
    --resource-group <resource_group_name> \
    --default-consistency-level <consistency_level> \
    --disable-key-based-metadata-write-access true \
    --enable-automatic-failover true \
    --enable-multiple-write-locations true \
    --locations regionName=<region_name> isZoneRedundant=False \
    --max-interval 10 \
    --max-staleness-prefix 200 \
    --max-staleness-seconds 300 \
    --network-acl-bypass AzureServices \
    --network-acl-bypass-resource-ids /subscriptions/<subscription_id>/resourceGroups/Microsoft.Network/providers/Microsoft.Network/virtualNetworks/default \
    --virtual-network-rule "" \
    --ip-range-filter "" \
    --public-network-access Disabled
```

Note: Replace the placeholders `<cosmos_db_account_name>`, `<resource_group_name>`, `<consistency_level>`, `<region_name>`, and `<subscription_id>` with the actual values.

7. Once the command is executed successfully, the default network access for the Cosmos DB account will be restricted.

This will remediate the misconfiguration "Restrict Default Network Access for Azure Cosmos DB Accounts" in Azure using Azure CLI.

#### Using Python

To restrict default network access for Azure Cosmos DB Accounts using Python, you can follow these steps:

1. Import the necessary modules:

```python
from azure.cosmos import CosmosClient
from azure.cosmos.errors import CosmosHttpResponseError
```

2. Create a Cosmos DB client instance:

```python
endpoint = "your_cosmos_db_account_endpoint"
key = "your_cosmos_db_account_key"
client = CosmosClient(endpoint, key)
```

3. Get the Cosmos DB account properties:

```python
try:
    properties = client.ReadAccount()
except CosmosHttpResponseError as e:
    print(e)
    sys.exit(1)
```

4. Check if default network access is enabled:

```python
if properties["enableMultipleWriteLocations"]:
    print("Default network access is enabled.")
else:
    print("Default network access is disabled.")
    sys.exit(0)
```

5. Disable default network access:

```python
properties["enableMultipleWriteLocations"] = False
try:
    client.UpdateAccount(properties)
    print("Default network access has been disabled.")
except CosmosHttpResponseError as e:
    print(e)
    sys.exit(1)
```

The complete code will look like this:

```python
from azure.cosmos import CosmosClient
from azure.cosmos.errors import CosmosHttpResponseError

endpoint = "your_cosmos_db_account_endpoint"
key = "your_cosmos_db_account_key"
client = CosmosClient(endpoint, key)

try:
    properties = client.ReadAccount()
except CosmosHttpResponseError as e:
    print(e)
    sys.exit(1)

if properties["enableMultipleWriteLocations"]:
    print("Default network access is enabled.")
else:
    print("Default network access is disabled.")
    sys.exit(0)

properties["enableMultipleWriteLocations"] = False
try:
    client.UpdateAccount(properties)
    print("Default network access has been disabled.")
except CosmosHttpResponseError as e:
    print(e)
    sys.exit(1)
```

Note: Replace "your_cosmos_db_account_endpoint" and "your_cosmos_db_account_key" with the actual values of your Cosmos DB account.




</Tab>
</Tabs>