---
slug: azure_audit_postgressql_enable_log_disconnections
title: Enable "LOG_DISCONNECTIONS" Parameter for PostgreSQL Servers
sidebar_label: Enable "LOG_DISCONNECTIONS" Parameter for PostgreSQL Servers
---

### More Info:

Ensure that the "log_disconnections" server parameter is enabled for all PostgreSQL database servers provisioned in your Microsoft Azure cloud account. The "log_disconnections" parameter enables the logging of session termination. The log output provides information similar to the one generated by the "log_connections" parameter, plus the duration of the session. Only Azure account admins can change this parameter at the session start, and it cannot be changed at all during a session.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISAZURE, CBP, HITRUST, SOC2, NISTCSF, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal using your login credentials. 

2. Navigate to PostgreSQL servers: From the left-hand side menu, select "All services". In the "All services" box, search for "PostgreSQL servers". Select the PostgreSQL server for which you want to check the "LOG_DISCONNECTIONS" parameter.

3. Check server parameters: Once you've selected the PostgreSQL server, navigate to the "Settings" section in the left-hand side menu. Click on "Server parameters". 

4. Verify "LOG_DISCONNECTIONS" parameter: In the server parameters page, look for the "LOG_DISCONNECTIONS" parameter. If it's enabled, it will show as 'ON'. If it's not, it will show as 'OFF'.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to have the Azure CLI installed on your system. You can download it from the official Azure website and install it on your system.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your username and password.
   ```
   az login
   ```
3. Select the Subscription: If you have multiple subscriptions, select the subscription where the PostgreSQL server is located using the following command. Replace 'my-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'my-subscription-id'
   ```
4. Check LOG_DISCONNECTIONS Parameter: Use the following command to check the status of the LOG_DISCONNECTIONS parameter for your PostgreSQL server. Replace 'my-resource-group' with the name of your resource group, 'my-server-name' with the name of your PostgreSQL server, and 'log_disconnections' with the name of the parameter you want to check.
   ```
   az postgres server configuration show --resource-group 'my-resource-group' --server-name 'my-server-name' --name 'log_disconnections'
   ```
   The output of this command will show the current value of the LOG_DISCONNECTIONS parameter. If it is set to 'OFF', then it is a misconfiguration.

#### Using Python

To check if the "LOG_DISCONNECTIONS" parameter is enabled for PostgreSQL servers in SQL using Python scripts, you can follow these steps:

1. **Install Required Libraries**: First, you need to install the necessary libraries. You will need the `psycopg2` library to connect to your PostgreSQL database. You can install it using pip:
   ```python
   pip install psycopg2-binary
   ```
2. **Establish a Connection**: Next, you need to establish a connection to your PostgreSQL server. Replace `'dbname'`, `'user'`, `'host'`, `'password'` with your actual database name, user, host, and password.
   ```python
   import psycopg2
   try:
       connection = psycopg2.connect(user = "user",
                                     password = "password",
                                     host = "host",
                                     port = "5432",
                                     database = "dbname")
       cursor = connection.cursor()
   except (Exception, psycopg2.Error) as error :
       print ("Error while connecting to PostgreSQL", error)
   ```
3. **Execute a Query**: Now, you can execute a query to check the status of the "LOG_DISCONNECTIONS" parameter. The query is `SHOW log_disconnections;`. If the parameter is enabled, it will return 'on'.
   ```python
   try:
       cursor.execute("SHOW log_disconnections;")
       record = cursor.fetchone()
       print("Log Disconnections Status : ", record)
   except (Exception, psycopg2.Error) as error :
       print ("Error while fetching data from PostgreSQL", error)
   ```
4. **Close the Connection**: Finally, don't forget to close the connection after you're done.
   ```python
   if(connection):
       cursor.close()
       connection.close()
       print("PostgreSQL connection is closed")
   ```
This script will print the status of the "LOG_DISCONNECTIONS" parameter. If it's 'on', then the parameter is enabled. If it's 'off', then the parameter is disabled.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Enable 'LOG_DISCONNECTIONS' Parameter for PostgreSQL Servers" in Azure using the Azure console, follow the below steps:

1. Login to Azure Portal (https://portal.azure.com/).
2. Go to the Azure Database for PostgreSQL servers.
3. Select the PostgreSQL server for which you want to enable "LOG_DISCONNECTIONS" parameter.
4. Click on the "Connection security" option in the left-hand side menu.
5. Scroll down to the "Firewall and virtual networks" section and click on the "Configure firewall" button.
6. In the "Firewall rules" section, click on the "Add client IP" button to add your IP address to the firewall rules.
7. Click on the "Save" button to save the changes.
8. Go back to the PostgreSQL server overview page and click on the "Connection strings" option in the left-hand side menu.
9. Copy the connection string for the PostgreSQL server.
10. Open the PostgreSQL client tool (e.g. pgAdmin) and connect to the PostgreSQL server using the connection string.
11. Once connected, execute the following SQL command to enable "LOG_DISCONNECTIONS" parameter:

   ALTER SYSTEM SET log_disconnections = on;

12. Restart the PostgreSQL server to apply the changes.

With these steps, you have successfully remediated the misconfiguration "Enable 'LOG_DISCONNECTIONS' Parameter for PostgreSQL Servers" in Azure using the Azure console.

#### Using CLI

To remediate the misconfiguration "Enable 'LOG_DISCONNECTIONS' Parameter for PostgreSQL Servers" for Azure using Azure CLI, follow the below steps:

Step 1: Open the Azure CLI on your system.

Step 2: Login to your Azure account using the below command:

```
az login
```

Step 3: Once you are logged in, set the default subscription to the one you want to work with using the below command:

```
az account set --subscription <SubscriptionID>
```

Step 4: Now, to enable the "LOG_DISCONNECTIONS" parameter for PostgreSQL servers, you need to update the PostgreSQL server configuration. For this, you need to get the resource ID of the PostgreSQL server using the below command:

```
az postgres server list --resource-group <ResourceGroupName> --query "[].id"
```

Note: Replace `<ResourceGroupName>` with the name of the resource group where the PostgreSQL server is located.

Step 5: Once you have the resource ID of the PostgreSQL server, use the below command to update the server configuration and enable the "LOG_DISCONNECTIONS" parameter:

```
az postgres server configuration set --resource-group <ResourceGroupName> --server-name <PostgreSQLServerName> --name log_disconnections --value on
```

Note: Replace `<ResourceGroupName>` with the name of the resource group where the PostgreSQL server is located and `<PostgreSQLServerName>` with the name of the PostgreSQL server.

Step 6: After executing the above command, the "LOG_DISCONNECTIONS" parameter will be enabled for the PostgreSQL server.

That's it! You have successfully remediated the misconfiguration "Enable 'LOG_DISCONNECTIONS' Parameter for PostgreSQL Servers" for Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration "Enable 'LOG_DISCONNECTIONS' Parameter for PostgreSQL Servers" in Azure using Python, you can follow the below steps:

1. First, you need to install the Azure SDK for Python using the following command:

   ```
   pip install azure-mgmt-resource
   ```

2. After installing the Azure SDK, you need to authenticate to your Azure account using the following code:

   ```
   from azure.common.credentials import ServicePrincipalCredentials
   from azure.mgmt.resource import ResourceManagementClient
   from azure.mgmt.postgresql import PostgreSQLManagementClient

   credentials = ServicePrincipalCredentials(
       client_id='<client-id>',
       secret='<client-secret>',
       tenant='<tenant-id>'
   )

   resource_client = ResourceManagementClient(credentials, '<subscription-id>')
   postgresql_client = PostgreSQLManagementClient(credentials, '<subscription-id>')
   ```

   Replace the `<client-id>`, `<client-secret>`, `<tenant-id>`, `<subscription-id>` with your own values.

3. Once you are authenticated, you can get the list of PostgreSQL servers using the following code:

   ```
   servers = postgresql_client.servers.list_by_resource_group('<resource-group-name>')
   ```

   Replace the `<resource-group-name>` with the name of the resource group where your PostgreSQL servers are located.

4. Next, you need to update the configuration of each PostgreSQL server to enable the `log_disconnections` parameter. You can do this using the following code:

   ```
   for server in servers:
       parameters = postgresql_client.configurations.get('<resource-group-name>', server.name, 'default')
       parameters.log_disconnections = True
       postgresql_client.configurations.create_or_update('<resource-group-name>', server.name, 'default', parameters)
   ```

   This code will update the configuration of each PostgreSQL server in the specified resource group to enable the `log_disconnections` parameter.

5. Finally, you can verify that the `log_disconnections` parameter is enabled by connecting to your PostgreSQL server and checking the PostgreSQL logs.

   ```
   psql -h <server-name>.postgres.database.azure.com -U <username>@<server-name> -d postgres -c "SELECT * FROM pg_settings WHERE name = 'log_disconnections'"
   ```

   Replace the `<server-name>`, `<username>` with your own values.

That's it! This will remediate the misconfiguration "Enable 'LOG_DISCONNECTIONS' Parameter for PostgreSQL Servers" in Azure using Python.




</Tab>
</Tabs>