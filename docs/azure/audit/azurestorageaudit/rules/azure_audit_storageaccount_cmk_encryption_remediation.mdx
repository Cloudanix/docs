

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal and navigate to the storage account you want to check.
2. In the storage account window, scroll down to the "Security + networking" section in the left-hand menu, then click on "Encryption".
3. In the Encryption window, check the "Use your own key" option under "Customer-managed keys". If this option is not selected, it means that the storage account is not using customer-managed keys for encryption.
4. To further verify, check the Key Vault and Key details. If these fields are empty or not configured correctly, it indicates a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List all storage accounts: Use the following command to list all the storage accounts in your Azure subscription. This will return a list of all storage accounts along with their properties.
    ```
    az storage account list
    ```
3. Check for Customer Managed Keys: For each storage account, check if the encryption is set to use customer-managed keys. This can be done using the following command:
    ```
    az storage account show --name <storage_account_name> --query encryption.keySource
    ```
    Replace `<storage_account_name>` with the name of your storage account. If the output is "Microsoft.Storage", it means that the storage account is not using customer-managed keys.

4. Check the status of the key: If the storage account is using customer-managed keys, you can check the status of the key using the following command:
    ```
    az storage account show --name <storage_account_name> --query encryption.keyVaultProperties.keyStatus
    ```
    Replace `<storage_account_name>` with the name of your storage account. If the output is "Unresolved", it means that the key is not available or not valid.

#### Using Python

To check Storage Account Encryption using Customer Managed Keys in Azure Storage using Python scripts, you can follow these steps:

1. **Install Azure SDK for Python**: Azure SDK for Python is a set of libraries that allow you to manage and utilize Azure services. You can install it using pip:
   ```
   pip install azure-mgmt-storage
   ```
2. **Authenticate to Azure**: Before you can interact with Azure services, you need to authenticate. You can use Azure Identity library for Python to authenticate. Here is an example of how to authenticate using a service principal:
   ```python
   from azure.identity import ClientSecretCredential
   credential = ClientSecretCredential(
       tenant_id="<azure-tenant-id>",
       client_id="<azure-client-id>",
       client_secret="<azure-client-secret>"
   )
   ```
3. **Initialize Storage Management Client**: After authenticating, you can initialize the Storage Management Client. This client will allow you to interact with Azure Storage services.
   ```python
   from azure.mgmt.storage import StorageManagementClient
   storage_client = StorageManagementClient(credential, "<azure-subscription-id>")
   ```
4. **Check Storage Account Encryption**: Now you can use the Storage Management Client to check if a storage account is encrypted using customer-managed keys. Here is an example:
   ```python
   storage_account = storage_client.storage_accounts.get_properties("<resource-group-name>", "<storage-account-name>")
   if storage_account.encryption.key_source == "Microsoft.Storage":
       print("Storage account is not encrypted using customer-managed keys.")
   else:
       print("Storage account is encrypted using customer-managed keys.")
   ```
In this script, replace `<azure-tenant-id>`, `<azure-client-id>`, `<azure-client-secret>`, `<azure-subscription-id>`, `<resource-group-name>`, and `<storage-account-name>` with your actual Azure tenant ID, client ID, client secret, subscription ID, resource group name, and storage account name.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the Storage Account Encryption misconfiguration using Customer Managed Keys in Azure:

1. Login to Azure Portal (https://portal.azure.com/)
2. Navigate to the Storage Account for which you want to enable encryption using Customer Managed Keys.
3. Click on the 'Encryption' option under the 'Settings' section in the left-hand side menu.
4. Under the 'Encryption' tab, select the 'Customer-managed key' option.
5. Click on the 'Select' button to choose an existing Key Vault or create a new one.
6. If you want to create a new Key Vault, click on the 'Create new' button and provide the required details.
7. Once you have selected the Key Vault, select the key that you want to use for encryption.
8. Click on the 'Save' button to save the changes.

That's it! The Storage Account Encryption using Customer Managed Keys misconfiguration has been remediated successfully. Now your storage account data will be encrypted using the customer-managed keys stored in the Key Vault.

#### Using CLI

To remediate the storage account encryption misconfiguration using Customer Managed Keys in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI in your terminal or command prompt.

2. Login to your Azure account using the following command:
   ```
   az login
   ```
   
3. Set the subscription where the storage account is located using the following command:
   ```
   az account set --subscription <subscription_id>
   ```
   Replace `<subscription_id>` with the ID of your subscription.

4. Get the resource group name and the name of the storage account that needs to be remediated.

5. Check if Customer Managed Keys are available in the Key Vault using the following command:
   ```
   az keyvault key list --vault-name <key_vault_name>
   ```
   Replace `<key_vault_name>` with the name of your Key Vault.

6. Create a new key in the Key Vault if it is not available using the following command:
   ```
   az keyvault key create --vault-name <key_vault_name> --name <key_name> --kty RSA
   ```
   Replace `<key_vault_name>` with the name of your Key Vault and `<key_name>` with the name of the key you want to create.

7. Get the key identifier using the following command:
   ```
   az keyvault key show --vault-name <key_vault_name> --name <key_name> --query "key.kid" -o tsv
   ```
   Replace `<key_vault_name>` with the name of your Key Vault and `<key_name>` with the name of the key you created.

8. Set the storage account encryption using the Customer Managed Key using the following command:
   ```
   az storage account update --name <storage_account_name> --resource-group <resource_group_name> --encryption-services blob --encryption-key-name <key_name> --encryption-key-vault <key_vault_url>
   ```
   Replace `<storage_account_name>` with the name of your storage account, `<resource_group_name>` with the name of your resource group, `<key_name>` with the name of the key you created, and `<key_vault_url>` with the URL of your Key Vault.

9. Verify that the storage account encryption using Customer Managed Keys is enabled using the following command:
   ```
   az storage account show --name <storage_account_name> --resource-group <resource_group_name> --query "encryption.services.blob.enabled"
   ```
   Replace `<storage_account_name>` with the name of your storage account and `<resource_group_name>` with the name of your resource group.

Once these steps are completed, the storage account encryption using Customer Managed Keys will be properly configured in Azure.

#### Using Python

To remediate the misconfiguration of Storage Account Encryption using Customer Managed Keys in AZURE using python, you can follow the below steps:

1. First, you need to ensure that you have a valid Customer Managed Key available in your Key Vault. If not, you can create one using the Azure Portal or Azure CLI.

2. Next, you need to get the details of the Storage Account that needs to be remediated. You can use the Azure SDK for Python to get the details of the Storage Account.

3. Once you have the details of the Storage Account, you need to ensure that the encryption is enabled and set to use the Customer Managed Key. You can use the Azure SDK for Python to enable encryption and set the Customer Managed Key.

Here's some sample Python code to remediate the misconfiguration:

```python
from azure.identity import DefaultAzureCredential
from azure.keyvault.keys import KeyClient
from azure.mgmt.storage import StorageManagementClient
from azure.mgmt.storage.models import StorageAccountUpdateParameters
from azure.mgmt.storage.models import Encryption
from azure.mgmt.storage.models import EncryptionService
from azure.mgmt.storage.models import EncryptionServiceType
from azure.mgmt.storage.models import KeyVaultProperties
from azure.mgmt.storage.models import KeyVaultPropertiesKeyToEncrypt

# Set the subscription ID, resource group name, and storage account name
subscription_id = 'your-subscription-id'
resource_group_name = 'your-resource-group-name'
storage_account_name = 'your-storage-account-name'

# Set the Key Vault details
key_vault_uri = 'https://your-key-vault-name.vault.azure.net/'
key_name = 'your-customer-managed-key-name'
key_version = 'your-customer-managed-key-version'

# Create the Azure SDK clients
credential = DefaultAzureCredential()
key_client = KeyClient(vault_url=key_vault_uri, credential=credential)
storage_client = StorageManagementClient(credential, subscription_id)

# Get the Storage Account details
storage_account = storage_client.storage_accounts.get_properties(resource_group_name, storage_account_name)

# Enable encryption using Customer Managed Key
encryption_service = EncryptionService(type=EncryptionServiceType.blob, enabled=True)
key_vault_properties = KeyVaultProperties(key_name=key_name, key_version=key_version)
key_vault_properties_key_to_encrypt = KeyVaultPropertiesKeyToEncrypt(key_vault_properties=key_vault_properties)
encryption = Encryption(services=[encryption_service], key_vault_properties=key_vault_properties_key_to_encrypt)

# Update the Storage Account with encryption settings
update_parameters = StorageAccountUpdateParameters(encryption=encryption)
storage_client.storage_accounts.update(resource_group_name, storage_account_name, update_parameters)
```

This code will enable encryption using the specified Customer Managed Key for the specified Storage Account.


</Tab>
</Tabs>