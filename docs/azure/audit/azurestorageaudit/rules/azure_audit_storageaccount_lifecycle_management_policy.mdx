---
slug: azure_audit_storageaccount_lifecycle_management_policy
title: Enable Blob Storage Lifecycle Management
sidebar_label: Enable Blob Storage Lifecycle Management
---

### More Info:

Ensure that Azure Blob Storage service has a lifecycle management policy configured.

### Risk Level

Medium

### Address

Security

### Compliance Standards

SOC2, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your Azure account credentials.

2. Navigate to the "Storage Accounts" section from the left-hand side menu. Here, you will see a list of all the storage accounts associated with your Azure account.

3. Select the specific storage account for which you want to check the Blob Storage Lifecycle Management status.

4. In the storage account window, scroll down to the "Blob service" section in the left-hand side menu. Click on "Lifecycle Management". Here, you can see if the Lifecycle Management is enabled or not. If there are any rules set up, they will be displayed here.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have Azure CLI installed on your system. You can download it from the official Azure website and install it.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your login credentials.
   ```
   az login
   ```
3. Select the subscription: If you have multiple subscriptions, select the subscription where the storage account resides.
   ```
   az account set --subscription "mySubscription"
   ```
4. Check Blob Storage Lifecycle Management: Use the following command to check the lifecycle management policy of a storage account. Replace 'mystorageaccount' with the name of your storage account.
   ```
   az storage blob service-properties show --account-name mystorageaccount --query 'policy'
   ```
   If the output is null, it means that the Blob Storage Lifecycle Management is not enabled. If it returns a policy, it means that the Blob Storage Lifecycle Management is enabled.

#### Using Python

To check if Blob Storage Lifecycle Management is enabled in Azure Storage using Python scripts, you can follow these steps:

1. **Install Azure SDK for Python**: Azure SDK for Python is a set of libraries that allow you to manage and utilize Azure services. You can install it using pip:
   ```bash
   pip install azure-storage-blob
   ```

2. **Import Required Libraries**: Import the necessary libraries in your Python script:
   ```python
   from azure.storage.blob import BlobServiceClient
   ```

3. **Create a BlobServiceClient**: You need to create a BlobServiceClient object that represents your Azure Storage account. You will need your storage account's blob service URL, which you can find in the Azure portal, and your account access key, which you can also find in the portal.
   ```python
   blob_service_client = BlobServiceClient(account_url="your-storage-account-url", credential="your-account-access-key")
   ```

4. **Check Lifecycle Management Policy**: Use the `get_blob_service_properties` method to get the properties of the Blob service, and then check the `delete_retention_policy` attribute to see if Lifecycle Management is enabled.
   ```python
   service_properties = blob_service_client.get_blob_service_properties()
   lifecycle_management_enabled = service_properties.delete_retention_policy.enabled
   print(f"Is Lifecycle Management Enabled: {lifecycle_management_enabled}")
   ```
   If Lifecycle Management is enabled, the `delete_retention_policy.enabled` attribute will be `True`. If it's not enabled, the attribute will be `False`.

Please note that you need to replace "your-storage-account-url" and "your-account-access-key" with your actual Azure Storage account's blob service URL and account access key.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step by step instructions to enable Blob Storage Lifecycle Management in Azure using Azure console:

1. Open the Azure portal and navigate to the storage account that needs to be remediated.
2. In the left-hand menu, click on "Lifecycle management" under the "Blob service" section.
3. Click on the "+ Add" button to create a new lifecycle management rule.
4. In the "Name" field, give a name to the rule.
5. In the "Prefix matches" field, enter the prefix of the blob names that you want to apply the rule to. You can also leave it blank to apply the rule to all blobs.
6. In the "Blob types" field, select the type of blobs that you want to apply the rule to.
7. In the "Action" field, select the action that you want to perform on the blobs that match the rule. For example, you can choose to delete or move the blobs to a different storage tier.
8. In the "Days after last modification" field, enter the number of days after which the action should be performed on the blobs.
9. Click on the "Review + create" button to review the rule details.
10. Once you have reviewed the details, click on the "Create" button to create the rule.

That's it! The lifecycle management rule has been created and will be applied to the blobs that match the rule criteria.

#### Using CLI

To remediate the misconfiguration of enabling Blob Storage Lifecycle Management in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI on your local machine or cloud shell.

2. Login to your Azure account using the following command:
   
   ```
   az login
   ```
   
3. Once you are logged in, set the subscription that you want to work with using the following command:

   ```
   az account set --subscription <subscription_id>
   ```
   
   Replace `<subscription_id>` with the ID of the subscription that you want to use.

4. Next, create a policy definition that will enable Blob Storage Lifecycle Management using the following command:

   ```
   az policy definition create --name 'Enable Blob Storage Lifecycle Management' --mode All --rules 'https://raw.githubusercontent.com/Azure/azure-policy/master/samples/Storage/storage-account-enable-blob-lifecycle-management/azurepolicy.rules.json' --params 'https://raw.githubusercontent.com/Azure/azure-policy/master/samples/Storage/storage-account-enable-blob-lifecycle-management/azurepolicy.parameters.json'
   ```

5. Assign the policy definition to the scope where you want to enable Blob Storage Lifecycle Management using the following command:

   ```
   az policy assignment create --name 'Enable Blob Storage Lifecycle Management' --scope <scope> --policy "Enable Blob Storage Lifecycle Management"
   ```

   Replace `<scope>` with the scope where you want to enable Blob Storage Lifecycle Management. This can be a resource group, subscription, or management group.

6. Verify that the policy is applied correctly by checking the compliance status using the following command:

   ```
   az policy state list --resource-type Microsoft.Storage/storageAccounts --query "[?policyDefinitionAction=='deny'].{name:policyDefinitionName,description:policyDefinitionDescription,compliant:isCompliant}"
   ```

   This command will show you the compliance status of the policy. If it is compliant, then Blob Storage Lifecycle Management is enabled.

That's it! You have now remediated the misconfiguration of enabling Blob Storage Lifecycle Management in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of enabling Blob Storage Lifecycle Management in Azure using Python, you can follow the below steps:

Step 1: Install the Azure Blob Storage library for Python using the command `pip install azure-storage-blob`.

Step 2: Import the necessary libraries in your Python script.

```python
from azure.storage.blob import BlobServiceClient, BlobClient, ContainerClient, BlobProperties, ContentSettings
```

Step 3: Authenticate with Azure using your Azure Storage Account name and access key.

```python
account_name = '<your-storage-account-name>'
account_key = '<your-storage-account-key>'

blob_service_client = BlobServiceClient(account_url=f"https://{account_name}.blob.core.windows.net", credential=account_key)
```

Step 4: Get the container client object for which you want to enable the Blob Storage Lifecycle Management.

```python
container_client = blob_service_client.get_container_client('<your-container-name>')
```

Step 5: Define the Blob Storage Lifecycle Management policy using the `set_blob_lifecycle()` method of the container client object. The policy should be defined in a JSON format.

```python
lifecycle_policy = {
    "rules": [
        {
            "name": "Delete blob",
            "type": "Lifecycle",
            "definition": {
                "filters": {
                    "blobTypes": [
                        "blockBlob"
                    ],
                    "prefixMatch": [
                        "logs/"
                    ]
                },
                "actions": {
                    "baseBlob": {
                        "delete": {
                            "daysAfterModificationGreaterThan": 30
                        }
                    }
                }
            }
        }
    ]
}

container_client.set_blob_lifecycle(lifecycle_policy)
```

Step 6: Run the Python script to enable Blob Storage Lifecycle Management for the specified container.

After running the above Python script, the Blob Storage Lifecycle Management will be enabled for the specified container in Azure.




</Tab>
</Tabs>