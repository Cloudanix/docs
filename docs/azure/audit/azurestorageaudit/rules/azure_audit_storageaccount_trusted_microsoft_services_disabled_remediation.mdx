

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser's address bar. Enter your Azure account credentials to log in.

2. Navigate to the Storage Account: On the left-hand side menu, click on "Storage accounts" to view all the storage accounts associated with your Azure subscription. Select the storage account you want to check.

3. Check the Firewall and Virtual Networks settings: Once you've selected the storage account, navigate to the "Firewalls and virtual networks" section under the "Settings" menu. Here, you can view the current configuration of the storage account.

4. Verify Trusted Microsoft Services: In the "Firewalls and virtual networks" settings, look for the "Allow trusted Microsoft services to access this storage account" option. If this option is enabled, it means that Trusted Microsoft Services are enabled for the selected storage account. If it's not enabled, then Trusted Microsoft Services are not enabled.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to have the Azure CLI installed on your system. You can download it from the official Microsoft website and install it.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your credentials and login.
   ```
   az login
   ```
3. List all storage accounts: Use the following command to list all the storage accounts in your subscription. This will return a JSON output with details of all storage accounts.
   ```
   az storage account list
   ```
4. Check Trusted Microsoft Services: For each storage account, check the 'bypass' property in the 'networkAcls' section. If the value of 'bypass' is 'AzureServices', then Trusted Microsoft Services is enabled. If not, then it is disabled. You can use the following command to check this:
   ```
   az storage account show --name <storage_account_name> --query 'networkAcls.bypass'
   ```
   Replace `<storage_account_name>` with the name of your storage account. If the output is 'AzureServices', then Trusted Microsoft Services is enabled. If not, then it is disabled.

#### Using Python

1. Install Azure SDK: To interact with Azure services, you need to install Azure SDK in your Python environment. You can do this using pip:
   ```
   pip install azure-storage-blob azure-identity
   ```

2. Import Required Libraries: Import the necessary libraries into your Python script.
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.storage.blob import BlobServiceClient
   ```

3. Authenticate and Create a Service Client: Use the DefaultAzureCredential class from the azure-identity library to authenticate the user. Then, create a BlobServiceClient.
   ```python
   credential = DefaultAzureCredential()
   blob_service_client = BlobServiceClient(account_url="https://<your-storage-account>.blob.core.windows.net", credential=credential)
   ```

4. Check for Trusted Microsoft Services: Now, you can use the get_blob_service_properties method to get the properties of the Blob service, which includes the firewall settings. If the "Allow Trusted Microsoft Services" option is enabled, the "bypass" property will include the value "AzureServices".
   ```python
   properties = blob_service_client.get_service_properties()
   if "AzureServices" in properties.firewall_rules.bypass:
       print("Trusted Microsoft Services are enabled.")
   else:
       print("Trusted Microsoft Services are not enabled.")
   ```
Please replace `<your-storage-account>` with your actual storage account name. This script will print whether Trusted Microsoft Services are enabled or not.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Trusted Microsoft Services Enabled" misconfiguration in Azure using the Azure console, follow these steps:

1. Log in to the Azure portal at https://portal.azure.com/
2. Navigate to the Azure Security Center.
3. Click on "Security policy" on the left-hand side of the screen.
4. Click on the policy that you want to modify.
5. Click on the "Edit" button at the top of the screen.
6. Scroll down to the "Trusted Microsoft Services" section.
7. Toggle the switch to "Off" to disable Trusted Microsoft Services.
8. Click "Save" to apply the changes.

Once you have completed these steps, Trusted Microsoft Services will be disabled, and you will have remediated the misconfiguration. It's important to note that this may impact some functionality in your Azure environment, so be sure to test thoroughly before making any changes in production.

#### Using CLI

To remediate the Trusted Microsoft Services Enabled misconfiguration in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI and log in to your Azure account.
2. Run the following command to check if Trusted Microsoft Services are enabled or not:
   
   ```az security setting show --name 'TrustedMicrosoftServices'```
   
   If the output shows "false" for the "isEnabled" parameter, it means that Trusted Microsoft Services are not enabled.

3. To remediate this misconfiguration, run the following command to enable Trusted Microsoft Services:

   ```az security setting set --name 'TrustedMicrosoftServices' --enabled true```

4. After running the command, the output should show "true" for the "isEnabled" parameter, indicating that Trusted Microsoft Services have been enabled.

5. Verify that the remediation is successful by running the first command again to check if Trusted Microsoft Services are now enabled.

   ```az security setting show --name 'TrustedMicrosoftServices'```

   The output should show "true" for the "isEnabled" parameter.

By following the above steps, you can successfully remediate the Trusted Microsoft Services Enabled misconfiguration in Azure using Azure CLI.

#### Using Python

To remediate the "Trusted Microsoft Services Enabled" misconfiguration in Azure using Python, you can use the Azure SDK for Python. Follow these steps:

1. Install the Azure SDK for Python using pip:

```
pip install azure-mgmt-resource
```

2. Import the required modules:

```
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.resource.resources.models import DeploymentMode
```

3. Create a Service Principal and assign it the `Contributor` role for the subscription:

```
credentials = ServicePrincipalCredentials(
    client_id='<your-client-id>',
    secret='<your-client-secret>',
    tenant='<your-tenant-id>'
)

client = ResourceManagementClient(credentials, '<your-subscription-id>')
client.providers.register('Microsoft.Authorization')
```

4. Define the remediation template to disable the "Trusted Microsoft Services" feature:

```
template = {
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "resources": [
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "name": "DisableTrustedMicrosoftServices",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Disable Trusted Microsoft Services",
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4e079ed2-211c-42c5-9c5c-8f9e9c9e4c74",
                "parameters": {},
                "enforcementMode": "Default",
                "scope": "/subscriptions/<your-subscription-id>"
            }
        }
    ]
}
```

5. Deploy the remediation template:

```
deployment_properties = {
    'mode': DeploymentMode.incremental,
    'template': template,
}

deployment_async_operation = client.deployments.create_or_update(
    '<your-resource-group>',
    'DisableTrustedMicrosoftServices',
    deployment_properties,
)

deployment_async_operation.wait()
```

This will deploy a policy assignment to disable the "Trusted Microsoft Services" feature in your Azure subscription. Note that it may take a few minutes for the policy to take effect.


</Tab>
</Tabs>