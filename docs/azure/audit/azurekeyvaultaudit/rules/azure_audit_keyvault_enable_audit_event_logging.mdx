---
slug: azure_audit_keyvault_enable_audit_event_logging
title: AuditEvent logging should be enabled
sidebar_label: AuditEvent logging should be enabled
---

### More Info:

Ensure that AuditEvent logging is enabled for Azure Key Vault instances in order to record any interactions with your vaults for enhancing data protection and compliance within your Azure cloud account.

### Risk Level

Medium

### Address

Security

### Compliance Standards

ISO27001, HIPAA, CISAZURE, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser. Enter your login credentials to access your Azure account.

2. Navigate to Key Vault: Once you are logged in, look for the "Key Vaults" service in the left-hand menu. If it's not visible, you can use the search bar at the top of the dashboard to find it. Click on the "Key Vaults" service to open it.

3. Select the Key Vault: In the Key Vaults section, you will see a list of all your Key Vaults. Click on the name of the Key Vault for which you want to check the AuditEvent logging.

4. Check AuditEvent logging: Once you have opened the Key Vault, navigate to the "Settings" section and then click on "Diagnostic settings". Here, you can see if the "AuditEvent" logging is enabled or not. If it is enabled, you will see a checkmark or "Enabled" next to it. If it is not enabled, you will see "Disabled" or no checkmark next to it.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your Azure account credentials.
   ```
   az login
   ```
3. Select the Subscription: If you have multiple subscriptions, select the subscription where the Key Vault is located. Replace 'your-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'your-subscription-id'
   ```
4. Check AuditEvent Logging: Now, use the following command to check if AuditEvent logging is enabled in Key Vault. Replace 'your-keyvault-name' with the name of your Key Vault.
   ```
   az monitor diagnostic-settings show --resource /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.KeyVault/vaults/{your-keyvault-name} --name service
   ```
   In the output, look for the 'logs' section. If AuditEvent logging is enabled, you will see 'AuditEvent' listed under 'category'. If it's not listed, then AuditEvent logging is not enabled.

#### Using Python

To check if AuditEvent logging is enabled in Azure Key Vault using Python scripts, you can follow these steps:

1. **Install Azure SDK for Python**: Azure SDK for Python is a set of libraries that allow you to work with Azure services like Key Vault. You can install it using pip:
   ```bash
   pip install azure-mgmt-keyvault
   ```

2. **Authenticate to Azure**: Before you can interact with Azure services, you need to authenticate. You can use Azure Identity library for this. Here is a sample code snippet:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.keyvault import KeyVaultManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'  # replace with your Azure Subscription ID
   kv_client = KeyVaultManagementClient(credential, subscription_id)
   ```

3. **List all Key Vaults and check for AuditEvent logging**: You can list all Key Vaults in your subscription and check if AuditEvent logging is enabled. Here is a sample code snippet:
   ```python
   for vault in kv_client.vaults.list():
       properties = vault.properties
       if properties.enable_soft_delete is not None and properties.enable_soft_delete:
           print(f"AuditEvent logging is enabled for {vault.name}")
       else:
           print(f"AuditEvent logging is not enabled for {vault.name}")
   ```
   
4. **Interpret the results**: If the script prints "AuditEvent logging is not enabled for {vault.name}" for any Key Vault, it means that AuditEvent logging is not enabled for that Key Vault.

Please note that you need to replace 'your-subscription-id' with your actual Azure Subscription ID in the above scripts. Also, you need to have appropriate permissions to list Key Vaults and read their properties.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the AuditEvent logging misconfiguration in AZURE using the AZURE console, you can follow the below steps:

1. Login to the AZURE portal (https://portal.azure.com/).
2. Navigate to the resource group where the affected resource is located.
3. Click on the affected resource to open its properties page.
4. In the left-hand menu, click on the "Monitoring" option.
5. Under the Monitoring section, click on "Diagnostic settings".
6. Click on "Add diagnostic setting" to create a new diagnostic setting.
7. In the "Add diagnostic setting" page, provide a name for the diagnostic setting.
8. Under the "Logs" section, enable the "AuditEvent" log by selecting it from the list of available logs.
9. Choose the destination where you want to send the logs (such as a storage account or event hub).
10. Click on "Save" to save the new diagnostic setting.

Once the diagnostic setting is saved, Azure will start collecting the AuditEvent logs and sending them to the specified destination. This will remediate the AuditEvent logging misconfiguration in Azure.

#### Using CLI

To remediate the misconfiguration of AuditEvent logging not being enabled in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI on your local machine or the Azure Cloud Shell.

2. Run the following command to enable AuditEvent logging:

   ```
   az monitor diagnostic-settings create --name <DIAGNOSTIC-SETTING-NAME> --resource <RESOURCE-ID> --resource-type <RESOURCE-TYPE> --logs '[{"category": "AuditEvent", "enabled": true}]'
   ```

   Replace the placeholders `<DIAGNOSTIC-SETTING-NAME>`, `<RESOURCE-ID>`, and `<RESOURCE-TYPE>` with the appropriate values. 

   For example, if you want to enable AuditEvent logging for a virtual machine, the command would be:

   ```
   az monitor diagnostic-settings create --name audit-vm --resource /subscriptions/<SUBSCRIPTION-ID>/resourceGroups/<RESOURCE-GROUP-NAME>/providers/Microsoft.Compute/virtualMachines/<VM-NAME> --resource-type Microsoft.Compute/virtualMachines --logs '[{"category": "AuditEvent", "enabled": true}]'
   ```

3. Once the command is executed successfully, the AuditEvent logging will be enabled for the specified resource.

4. To verify that AuditEvent logging is enabled, run the following command:

   ```
   az monitor diagnostic-settings show --name <DIAGNOSTIC-SETTING-NAME> --resource <RESOURCE-ID> --resource-type <RESOURCE-TYPE>
   ```

   This command will display the current diagnostic settings for the specified resource, including whether AuditEvent logging is enabled or not.

That's it! The AuditEvent logging misconfiguration has been remediated for Azure using Azure CLI.

#### Using Python

To remediate the AuditEvent logging misconfiguration in Azure using Python, follow these steps:

1. Import the necessary modules:

```python
from azure.mgmt.monitor import MonitorManagementClient
from azure.common.credentials import ServicePrincipalCredentials
```

2. Set the credentials for the Azure account:

```python
credentials = ServicePrincipalCredentials(
    client_id=<client-id>,
    secret=<client-secret>,
    tenant=<tenant-id>
)
```

Replace `<client-id>`, `<client-secret>`, and `<tenant-id>` with the corresponding values for your Azure account.

3. Instantiate the `MonitorManagementClient`:

```python
monitor_client = MonitorManagementClient(
    credentials=credentials,
    subscription_id=<subscription-id>
)
```

Replace `<subscription-id>` with the ID of the subscription you want to remediate.

4. Enable AuditEvent logging:

```python
monitor_client.activity_log_alerts.create_or_update(
    resource_group_name=<resource-group-name>,
    activity_log_alert_name=<alert-name>,
    activity_log_alert={
        'location': '<location>',
        'tags': {
            '<tag-key>': '<tag-value>'
        },
        'enabled': True,
        'scopes': [
            '/subscriptions/<subscription-id>'
        ],
        'condition': {
            'allOf': [
                {
                    'field': 'category',
                    'equals': 'AuditEvent'
                }
            ]
        },
        'actions': {
            'action_groups': [
                {
                    'action_group_id': '<action-group-id>'
                }
            ]
        }
    }
)
```

Replace `<resource-group-name>` with the name of the resource group containing the alert, `<alert-name>` with the name of the alert, `<location>` with the location of the alert, `<tag-key>` and `<tag-value>` with the key and value of any tags you want to add to the alert, and `<action-group-id>` with the ID of the action group you want to associate with the alert.

5. Verify that AuditEvent logging is enabled:

```python
alert = monitor_client.activity_log_alerts.get(
    resource_group_name=<resource-group-name>,
    activity_log_alert_name=<alert-name>
)

print(alert.enabled)
```

Replace `<resource-group-name>` and `<alert-name>` with the corresponding values for your alert.

If the output is `True`, then AuditEvent logging is enabled.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/key-vault/key-vault-logging](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-logging) 


</Tab>
</Tabs>