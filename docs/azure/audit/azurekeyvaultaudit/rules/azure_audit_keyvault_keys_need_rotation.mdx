---
slug: azure_audit_keyvault_keys_need_rotation
title: Keys are about to expire and need rotation
sidebar_label: Keys are about to expire and need rotation
---

### More Info:

In Microsoft Azure Key Vault, check for any keys that are about to expire and rotate them by creating a new version of these keys.

### Risk Level

Medium

### Address

Operational Maturity, Security

### Compliance Standards

GDPR, ISO27001, HITRUST, SOC2, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to portal.azure.com and sign in with your Azure account credentials.

2. Access Key Vault: On the left-hand side menu, click on "All services". In the search bar, type "Key Vault" and select it from the dropdown list. This will take you to the Key Vault service page.

3. Select the Key Vault: From the list of Key Vaults, select the one you want to check for key expiration. This will open the Key Vault's dashboard.

4. Check Key Expiration: In the Key Vault dashboard, click on "Keys". This will display a list of all the keys in the Key Vault. For each key, there is an "Expiration Date" column. Check this column to see if any keys are about to expire. If the expiration date is approaching or has passed, the key needs rotation.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az --version` to confirm that it's installed correctly.

2. Login to Azure: Use the `az login` command to log in to your Azure account. You'll be redirected to the browser to enter your credentials. Once you've successfully logged in, you'll see a JSON output in your terminal showing your subscriptions.

3. Select the Subscription: If you have multiple subscriptions, you need to select the one where your Key Vault is located. Use the `az account set --subscription "my-subscription-name"` command to set the active subscription.

4. Check Key Expiry: Use the `az keyvault key list-versions --vault-name "myvault" --name "mykey" --query "[?attributes.expires].{ID: id, Expiry: attributes.expires}"` command to list all versions of a key and their expiry dates. Replace "myvault" with the name of your Key Vault and "mykey" with the name of your key. This command will return a list of all versions of the specified key and their expiry dates. If the expiry date is close to the current date, the key is about to expire and needs rotation.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries. You will need the `azure.keyvault.keys` and `azure.identity` libraries. If you don't have these libraries, you can install them using pip.

```python
from azure.keyvault.keys import KeyClient
from azure.identity import DefaultAzureCredential
```

2. **Establish Connection with Azure Key Vault**: The next step is to establish a connection with Azure Key Vault. You will need the Key Vault URL to do this. You can get the Key Vault URL from the Azure portal.

```python
key_vault_url = "<Your-Key-Vault-URL>"
credential = DefaultAzureCredential()
client = KeyClient(vault_url=key_vault_url, credential=credential)
```

3. **Retrieve All Keys**: Now, retrieve all the keys from the Key Vault. You can do this using the `list_properties_of_keys` method of the `KeyClient` object.

```python
keys = client.list_properties_of_keys()
```

4. **Check Expiry Date of Each Key**: Finally, iterate over each key and check its expiry date. If the expiry date is within a certain threshold (e.g., 30 days), print a warning message.

```python
from datetime import datetime, timedelta

threshold = timedelta(days=30)
now = datetime.now()

for key in keys:
    if key.expires_on and key.expires_on - now <= threshold:
        print(f"Warning: Key {key.name} is about to expire.")
```

This script will print a warning message for each key that is about to expire within the next 30 days. You can adjust the threshold to suit your needs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of keys about to expire and need rotation in Azure using the Azure console, you can follow the below steps:

1. Login to the Azure portal using your credentials.
2. Navigate to the resource group where the key is stored.
3. Select the key that needs to be rotated.
4. Click on the "Rotate" button at the top of the page.
5. Follow the on-screen instructions to complete the key rotation process.
6. Once the key rotation process is complete, update the application or service that uses the key with the new key.

It's important to note that you should regularly rotate your keys to prevent unauthorized access and protect your resources. Azure provides different options for key rotation, such as automatic key rotation or manual key rotation, based on your requirements.

#### Using CLI

To remediate the misconfiguration of expiring keys in Azure using Azure CLI, follow the below steps:

1. Open the Azure CLI in your terminal or command prompt.
2. Log in to your Azure account using the command "az login".
3. Once you are logged in, run the command "az account list" to see the list of all your Azure subscriptions.
4. Select the subscription that has the expiring keys using the command `az account set --subscription <subscription_id>`.
5. Check the current status of the keys using the command `az ad sp credential list --id <service_principal_id>`.
6. Create a new key using the command `az ad sp credential reset --name <service_principal_id>`.
7. The above command will return a JSON object that contains the new key. Copy the value of the "value" field.
8. Update the key value in your application or service that is using the service principal.
9. Verify that the new key is working by running a test on your application or service.

By following the above steps, you can remediate the misconfiguration of expiring keys in Azure using Azure CLI.

#### Using Python

To remediate the issue of key expiration and rotation for Azure using Python, you can follow the below steps:

1. Install the Azure SDK for Python using the following command: 

```python
pip install azure-mgmt-resource
```

2. Authenticate with Azure using Azure Active Directory credentials. You can use the following code snippet to authenticate:

```python
from azure.common.credentials import UserPassCredentials
from azure.mgmt.resource import ResourceManagementClient

subscription_id = 'your-subscription-id'
username = 'your-username'
password = 'your-password'
tenant_id = 'your-tenant-id'

credentials = UserPassCredentials(username, password, tenant_id)
resource_client = ResourceManagementClient(credentials, subscription_id)
```

3. Retrieve the list of expired keys using the following code snippet:

```python
from datetime import datetime, timedelta

expiry_date = datetime.now() - timedelta(days=30) # Change the number of days as per your requirement

expired_keys = []
for key in resource_client.providers.get('Microsoft.Storage').resource_types.get('storageAccounts').api_versions[0].locations[0].properties.supported_operations[5].description.split('\n')[1:]:
    if datetime.strptime(key.split(':')[-1], '%Y-%m-%dT%H:%M:%S.%fZ') < expiry_date:
        expired_keys.append(key.split(':')[0])
```

4. Rotate the expired keys using the following code snippet:

```python
for key in expired_keys:
    resource_client.providers.get('Microsoft.Storage').resource_types.get('storageAccounts').api_versions[0].locations[0].properties.supported_operations[6].invoke(
        resource_group_name='your-resource-group-name',
        account_name='your-storage-account-name',
        parameters={
            'keyName': key
        }
    )
```

Replace the placeholders in the code with the appropriate values for your Azure subscription, resource group, and storage account. 

These steps will help you remediate the issue of key expiration and rotation for Azure using Python.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates](https://docs.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) 


</Tab>
</Tabs>