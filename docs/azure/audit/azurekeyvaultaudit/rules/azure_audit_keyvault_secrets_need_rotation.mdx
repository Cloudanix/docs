---
slug: azure_audit_keyvault_secrets_need_rotation
title: Secrets are about to expire and need rotation
sidebar_label: Secrets are about to expire and need rotation
---

### More Info:

In Microsoft Azure Key Vault, check for any secrets that are about to expire and rotate them by creating a new version of these secrets.

### Risk Level

Medium

### Address

Operational Maturity, Security

### Compliance Standards

NIST, GDPR, ISO27001



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to portal.azure.com and sign in with your Azure account credentials.

2. Access Key Vault: From the left-hand menu, select "Key Vaults" under the "Security + Identity" section. This will display a list of all the Key Vaults in your Azure subscription.

3. Check Secret Expiry: Click on the name of the Key Vault you want to inspect. This will open the Key Vault's dashboard. From here, select "Secrets" from the left-hand menu. This will display a list of all the secrets stored in the Key Vault. Each secret will have an "Expiration Date" column. Check this column to see if any secrets are about to expire.

4. Set up Alerts: To automate this process, you can set up alerts for when secrets are about to expire. From the Key Vault dashboard, select "Alerts" from the left-hand menu. Click on "New alert rule", and set the "Condition" to "Secret Near Expiry". This will send you an alert whenever a secret is about to expire.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az --version` to confirm that it's installed correctly.

2. Login to Azure: Use the `az login` command to log in to your Azure account. You'll be redirected to the browser to enter your credentials. Once you've successfully logged in, you'll see a JSON output in your terminal showing your subscriptions.

3. Select the Subscription: If you have multiple subscriptions, you need to select the one where your Key Vault is located. Use the `az account set --subscription "my-subscription-name"` command to set the active subscription.

4. Check Secrets Expiry: Now, you can check the secrets in your Key Vault. Use the `az keyvault secret list --vault-name "my-key-vault-name"` command to list all the secrets. To check the expiry of a specific secret, use the `az keyvault secret show --vault-name "my-key-vault-name" --name "my-secret-name"` command. Look for the "expires" field in the output. If the expiry date is approaching, you need to rotate the secret.

#### Using Python

1. Install Azure SDK for Python: Azure SDK for Python is a set of libraries that you can use to interact with Azure services. You can install it using pip:
   ```
   pip install azure-keyvault-secrets azure-identity
   ```

2. Import the necessary libraries: You will need to import the `DefaultAzureCredential` from `azure.identity` and `SecretClient` from `azure.keyvault.secrets`:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.keyvault.secrets import SecretClient
   ```

3. Connect to the Key Vault: You will need to create an instance of `DefaultAzureCredential` and `SecretClient`. You will need the URL of your Key Vault:
   ```python
   credential = DefaultAzureCredential()
   key_vault_url = "https://<your-key-vault-name>.vault.azure.net"
   client = SecretClient(vault_url=key_vault_url, credential=credential)
   ```

4. Check for secrets that are about to expire: You can use the `list_properties_of_secrets` method to get a list of all the secrets in the Key Vault. Then, you can check the `expires_on` property of each secret to see if it is about to expire:
   ```python
   from datetime import datetime, timedelta

   # Get the current date and time
   now = datetime.now()

   # Define the period within which a secret is considered to be about to expire
   expiration_threshold = timedelta(days=30)

   for secret_properties in client.list_properties_of_secrets():
       # Check if the secret is about to expire
       if secret_properties.expires_on - now <= expiration_threshold:
           print(f"The secret {secret_properties.name} is about to expire.")
   ```
   This script will print the names of all secrets that are about to expire within the next 30 days. You can adjust the `expiration_threshold` to suit your needs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate secrets that are about to expire and need rotation in Azure using the Azure console, follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Navigate to the Azure Key Vault where the secrets are stored.
3. Select the secret that needs to be rotated.
4. Click on the "Current Version" tab.
5. Click on the "Generate/Import" button.
6. Enter the new secret value and click on "Create".
7. Click on the "Save" button to save the new secret value.
8. Click on the "Versions" tab.
9. Select the previous version of the secret and click on "Disable".
10. Click on the "Save" button to disable the previous version of the secret.

By following these steps, you have successfully rotated the secret and disabled the previous version of the secret in Azure.

#### Using CLI

To remediate the issue of expiring secrets in Azure using Azure CLI, you can follow these steps:

1. Login to your Azure account using Azure CLI by running the following command:
```
az login
```

2. Once you are logged in, you need to identify the secrets that are about to expire. You can do this by running the following command:
```
az keyvault secret list --vault-name <your-key-vault-name> --query "[?attributes.exp != null && attributes.exp < now()]"
```
This command will list all the secrets that are about to expire in your key vault.

3. Now that you have identified the secrets that need rotation, you can rotate them by creating new versions of the secrets with updated values. You can do this by running the following command:
```
az keyvault secret set --vault-name <your-key-vault-name> --name <your-secret-name> --value <your-new-secret-value>
```
Replace `<your-key-vault-name>`, `<your-secret-name>` and `<your-new-secret-value>` with the appropriate values.

4. Once you have created new versions of all the secrets that were about to expire, you can delete the old versions of the secrets by running the following command:
```
az keyvault secret delete --vault-name <your-key-vault-name> --name <your-secret-name> --version <your-old-secret-version>
```
Replace `<your-key-vault-name>`, `<your-secret-name>` and `<your-old-secret-version>` with the appropriate values.

5. Repeat steps 3 and 4 for all the secrets that were about to expire.

6. Finally, you can verify that all the secrets have been rotated successfully by running the following command:
```
az keyvault secret list --vault-name <your-key-vault-name> --query "[?attributes.exp != null && attributes.exp < now()]"
```
This command should return an empty list, indicating that all the secrets have been rotated successfully.

By following these steps, you can remediate the issue of expiring secrets in Azure using Azure CLI.

#### Using Python

To remediate the issue of expiring secrets in AZURE using Python, you can follow these steps:

1. Install the `azure-identity` and `azure-keyvault-secrets` packages using pip.
   ```
   pip install azure-identity azure-keyvault-secrets
   ```

2. Import the required libraries in your Python code.
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.keyvault.secrets import SecretClient
   from datetime import datetime, timedelta
   ```

3. Set up the authentication credentials using the `DefaultAzureCredential` class.
   ```python
   credential = DefaultAzureCredential()
   ```

4. Create a `SecretClient` object using the Azure Key Vault URL and the authentication credentials.
   ```python
   keyvault_url = "https://<your-key-vault-name>.vault.azure.net/"
   secret_client = SecretClient(vault_url=keyvault_url, credential=credential)
   ```

5. Retrieve the list of secrets from the Key Vault using the `list_properties_of_secrets` method of the `SecretClient` object.
   ```python
   secrets = secret_client.list_properties_of_secrets()
   ```

6. Iterate over the list of secrets and check if any of them are about to expire (i.e., the `expires_on` property is less than the current time plus a buffer period). If a secret is about to expire, retrieve its current value using the `get_secret` method of the `SecretClient` object, update its value, and then set the updated value using the `set_secret` method of the `SecretClient` object.
   ```python
   buffer_period = timedelta(days=7)  # Set a buffer period of 7 days
   for secret in secrets:
       if secret.expires_on <= datetime.utcnow() + buffer_period:
           secret_value = secret_client.get_secret(secret.name).value
           # Update the secret value here
           secret_client.set_secret(secret.name, secret_value)
   ```

7. Run the Python script periodically (e.g., daily) using a task scheduler or a cron job to ensure that secrets are rotated before they expire.

These steps should help you remediate the issue of expiring secrets in AZURE using Python.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates](https://docs.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) 


</Tab>
</Tabs>