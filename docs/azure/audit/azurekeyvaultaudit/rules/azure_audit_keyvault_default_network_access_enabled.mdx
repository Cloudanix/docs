---
slug: azure_audit_keyvault_default_network_access_enabled
title: Default Network Access should be restricted
sidebar_label: Default Network Access should be restricted
---

### More Info:

Ensure that your Microsoft Azure Key Vaults are configured to deny access to traffic from all networks (including the public Internet). This adds an important layer of security.

### Risk Level

Critical

### Address

Security

### Compliance Standards

CISAZURE, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser. Enter your login credentials to access your Azure account.

2. Navigate to Key Vaults: Once you are logged in, go to the left-hand side menu and click on "Key Vaults" under the "Security + Identity" section. This will display a list of all the Key Vaults in your Azure account.

3. Select a Key Vault: From the list of Key Vaults, select the one you want to check for default network access restrictions. This will open the Key Vault's dashboard.

4. Check Network Access: In the Key Vault's dashboard, go to the "Settings" section and click on "Firewalls and virtual networks". Here, you can see the network access settings for the Key Vault. If the option "Allow access from" is set to "All networks", it means that default network access is not restricted.

#### Using CLI

1. First, you need to install the Azure CLI on your local machine. You can download it from the official Azure website and follow the installation instructions. Once installed, open your command prompt or terminal.

2. Login to your Azure account using the following command:
   ```
   az login
   ```
   This command will open a new browser window for you to enter your Azure credentials.

3. Once logged in, you can list all the Key Vaults in your account using the following command:
   ```
   az keyvault list --query "[].{name: name, id: id}"
   ```
   This command will return a list of all Key Vaults along with their IDs.

4. For each Key Vault, you can check the network access policy using the following command:
   ```
   az keyvault show --name {KeyVaultName} --query "properties.networkAcls.defaultAction"
   ```
   Replace `{KeyVaultName}` with the name of your Key Vault. This command will return the default network access policy for the specified Key Vault. If the returned value is "Allow", then the default network access is not restricted.

#### Using Python

To check if Default Network Access is restricted in Azure Key Vault using Python scripts, you can follow these steps:

1. **Install Azure SDK for Python**: Azure SDK for Python is a set of libraries that allow you to manage your Azure resources. To install it, you can use pip:
   ```
   pip install azure-mgmt-keyvault
   ```
2. **Authenticate to Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for this. Here is an example of how to authenticate using DefaultAzureCredential:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.keyvault import KeyVaultManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   kv_client = KeyVaultManagementClient(credential, subscription_id)
   ```
3. **List all Key Vaults**: Now that you are authenticated, you can list all Key Vaults in your subscription:
   ```python
   key_vaults = kv_client.vaults.list()
   for kv in key_vaults:
       print(kv.name)
   ```
4. **Check Network Access Policy**: For each Key Vault, you can check the network access policy. If the default action is 'Allow', then the default network access is not restricted:
   ```python
   for kv in key_vaults:
       access_policy = kv.properties.access_policies[0].network_acls
       if access_policy.default_action == 'Allow':
           print(f'Default Network Access is not restricted for Key Vault: {kv.name}')
   ```
Please replace 'your-subscription-id' with your actual Azure subscription ID.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Default Network Access being unrestricted in Azure, follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Navigate to the resource group that contains the resources you want to secure.
3. Select the Virtual Network that you want to secure.
4. Click on the "Firewalls and virtual networks" tab.
5. Under the "Firewalls and virtual networks" tab, select "Selected networks" to restrict access to the virtual network.
6. Under the "Selected networks" option, select "Add existing virtual network".
7. Select the virtual network that you want to allow access to and click "Add".
8. Under the "Firewalls and virtual networks" tab, select "Selected IP addresses" to restrict access to specific IP addresses.
9. Under the "Selected IP addresses" option, select "Add IP address range".
10. Enter the IP address range that you want to allow access to and click "Add".
11. Click "Save" to apply the changes.

By following these steps, you have successfully remediated the misconfiguration of Default Network Access being unrestricted in Azure.

#### Using CLI

To remediate the misconfiguration of Default Network Access being unrestricted in Azure, you can follow these steps using Azure CLI:

1. Open the Azure CLI and login to your account using the command:

   ```
   az login
   ```

2. Once you have successfully logged in, set the scope to the subscription level using the command:

   ```
   az account set --subscription <subscription-id>
   ```

   Replace `<subscription-id>` with the ID of the subscription you want to work with.

3. Next, create a Network Security Group (NSG) using the command:

   ```
   az network nsg create --name <nsg-name> --resource-group <resource-group-name>
   ```

   Replace `<nsg-name>` with a unique name for the NSG and `<resource-group-name>` with the name of the resource group where you want to create the NSG.

4. Once the NSG is created, you can define inbound and outbound rules to restrict network access. For example, you can create a rule to allow traffic only from a specific IP address using the command:

   ```
   az network nsg rule create --name <rule-name> --nsg-name <nsg-name> --resource-group <resource-group-name> --priority 100 --source-address-prefixes <ip-address> --destination-port-ranges '*'
   ```

   Replace `<rule-name>` with a unique name for the rule, `<nsg-name>` with the name of the NSG you created in step 3, `<resource-group-name>` with the name of the resource group where the NSG is located, and `<ip-address>` with the IP address you want to allow traffic from.

   You can also create additional rules to allow traffic for specific ports and protocols.

5. Finally, associate the NSG with the appropriate subnet or network interface using the command:

   ```
   az network vnet subnet update --name <subnet-name> --vnet-name <vnet-name> --resource-group <resource-group-name> --network-security-group <nsg-name>
   ```

   Replace `<subnet-name>` with the name of the subnet you want to associate the NSG with, `<vnet-name>` with the name of the virtual network where the subnet is located, `<resource-group-name>` with the name of the resource group where the virtual network is located, and `<nsg-name>` with the name of the NSG you created in step 3.

By following these steps, you can remediate the misconfiguration of Default Network Access being unrestricted in Azure.

#### Using Python

To remediate the misconfiguration of default network access being unrestricted in Azure using Python, you can follow the below steps:

1. Import the required libraries:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.network import NetworkManagementClient
from azure.mgmt.network.models import NetworkSecurityGroup
```

2. Authenticate to Azure using DefaultAzureCredential:

```python
credential = DefaultAzureCredential()
network_client = NetworkManagementClient(credential, subscription_id)
```

3. Get the Network Security Group (NSG) resource:

```python
nsg_name = "nsg_name"
nsg_resource_group = "nsg_resource_group"
nsg = network_client.network_security_groups.get(nsg_resource_group, nsg_name)
```

4. Update the NSG rules to restrict default network access:

```python
# Remove the default allow-all inbound rule
for rule in nsg.security_rules:
    if rule.name == "AllowVnetInBound":
        nsg.security_rules.remove(rule)

# Add a new rule to allow only necessary traffic
nsg.security_rules.append(
    {
        "name": "AllowNecessaryTraffic",
        "protocol": "*",
        "source_address_prefix": "*",
        "destination_address_prefix": "*",
        "access": "Allow",
        "direction": "Inbound",
        "priority": 100,
        "source_port_range": "*",
        "destination_port_range": "80,443",
    }
)

# Update the NSG
network_client.network_security_groups.begin_create_or_update(nsg_resource_group, nsg_name, nsg)
```

The above code will remove the default allow-all inbound rule from the NSG and add a new rule to allow only necessary traffic. You can modify the rule parameters as per your requirements. Finally, the NSG is updated using the `begin_create_or_update` method.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/key-vault/key-vault-network-security](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-network-security) 


</Tab>
</Tabs>