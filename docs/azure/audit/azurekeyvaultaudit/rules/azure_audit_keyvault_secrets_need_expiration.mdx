---
slug: azure_audit_keyvault_secrets_need_expiration
title: Secrets should have an expiration time
sidebar_label: Secrets should have an expiration time
---

### More Info:

In Microsoft Azure Key Vault, check for any secrets that does not have any expiration time set.

### Risk Level

Medium

### Address

Security

### Compliance Standards

GDPR, ISO27001, CISAZURE, CBP, HITRUST, SOC2, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to portal.azure.com and sign in with your Azure account credentials.

2. Access Key Vault: From the left-hand menu, select "Key Vaults" under the "Security + Identity" section. This will display a list of all the Key Vaults in your Azure subscription.

3. Select a Key Vault: Click on the name of the Key Vault you want to inspect. This will open the Key Vault's dashboard.

4. Check Secret Expiration: In the Key Vault dashboard, select "Secrets" from the left-hand menu. This will display a list of all the secrets stored in the Key Vault. Click on a secret to view its details. In the details pane, look for the "Expiration Date" field. If this field is empty or set to a date in the past, the secret does not have a valid expiration time set. Repeat this process for each secret in the Key Vault.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List all Key Vaults: Use the following command to list all the Key Vaults in your Azure subscription:

    ```
    az keyvault list --query "[].{name: name, id: id}"
    ```
   This command will return a list of all Key Vaults along with their names and IDs.

3. List all Secrets in a Key Vault: Now, for each Key Vault, you need to list all the secrets. You can do this using the following command:

    ```
    az keyvault secret list --vault-name "<Your-Key-Vault-Name>"
    ```
   Replace `<Your-Key-Vault-Name>` with the name of your Key Vault. This command will return a list of all secrets in the specified Key Vault.

4. Check Secret Expiration Date: For each secret, you need to check the expiration date. You can do this using the following command:

    ```
    az keyvault secret show --name "<Your-Secret-Name>" --vault-name "<Your-Key-Vault-Name>" --query "attributes.expires"
    ```
   Replace `<Your-Secret-Name>` with the name of your secret and `<Your-Key-Vault-Name>` with the name of your Key Vault. This command will return the expiration date of the specified secret. If the returned value is null, it means the secret does not have an expiration date set.

#### Using Python

1. Install Azure SDK for Python: Azure SDK for Python is a set of libraries that you can use to interact with Azure services. You can install it using pip:

   ```bash
   pip install azure-keyvault-secrets azure-identity
   ```

2. Import the necessary modules and establish a connection to Azure Key Vault:

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.keyvault.secrets import SecretClient

   # Establish a connection to Azure Key Vault
   credential = DefaultAzureCredential()
   secret_client = SecretClient(vault_url="https://<your-key-vault-name>.vault.azure.net/", credential=credential)
   ```

3. Retrieve all secrets from the Key Vault:

   ```python
   secret_properties = secret_client.list_properties_of_secrets()
   ```

4. Check the expiration time of each secret:

   ```python
   for secret_property in secret_properties:
       # If the secret does not have an expiration time, print a warning
       if secret_property.expires_on is None:
           print(f"Warning: Secret {secret_property.name} does not have an expiration time.")
   ```

This script will print a warning for each secret in the specified Key Vault that does not have an expiration time set. This can help you identify potential misconfigurations in your Azure Key Vault setup.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of secrets not having an expiration time in AZURE, you can follow the below steps:

1. Login to the AZURE portal using your credentials.
2. Navigate to the "Key vaults" service from the dashboard.
3. Select the key vault that contains the secrets that you want to remediate.
4. Click on the "Secrets" option from the left-hand side menu.
5. Select the secret that you want to remediate and click on it.
6. In the secret details page, scroll down to the "Validity period" section.
7. Click on the "Enable" button to enable the expiration time for the secret.
8. Set the expiration time as per your requirement using the "Expires" field.
9. Click on the "Save" button to save the changes.

By following the above steps, you can remediate the misconfiguration of secrets not having an expiration time in AZURE.

#### Using CLI

To remediate the misconfiguration of secrets not having an expiration time in Azure, you can follow the below steps using Azure CLI:

1. Open the Azure CLI on your local machine or on the Azure Cloud Shell.

2. Run the following command to set the expiration time for the secrets:

   ```
   az keyvault secret set-attributes --name <secret-name> --vault-name <vault-name> --expires <expiration-time>
   ```

   Replace `<secret-name>` with the name of the secret that you want to set the expiration time for, `<vault-name>` with the name of the Key Vault where the secret is stored, and `<expiration-time>` with the expiration time in UTC format.

3. Verify that the expiration time has been set for the secret by running the following command:

   ```
   az keyvault secret show --name <secret-name> --vault-name <vault-name>
   ```

   This command will display the details of the secret, including the expiration time.

4. Repeat the above steps for all the secrets that do not have an expiration time set.

By following the above steps, you can remediate the misconfiguration of secrets not having an expiration time in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of secrets not having an expiration time in Azure using Python, you can use the following steps:

1. First, you need to authenticate to Azure using the Azure Python SDK. You can use the following code to authenticate:

```python
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

credential = DefaultAzureCredential()
client = SecretClient(vault_url="https://<your-key-vault-name>.vault.azure.net/", credential=credential)
```

2. Next, you need to retrieve the secrets from the key vault. You can use the following code to retrieve all the secrets:

```python
secrets = client.list_properties_of_secrets()
```

3. Once you have retrieved the secrets, you can loop through each secret and set an expiration time for it. You can use the following code to set an expiration time for each secret:

```python
from datetime import datetime, timedelta

for secret in secrets:
    secret_properties = client.get_secret_properties(secret.name)
    expires_on = datetime.utcnow() + timedelta(days=30)
    secret_properties.expires_on = expires_on
    client.update_secret_properties(secret.name, secret_properties)
```

In the above code, we are setting an expiration time of 30 days for each secret. You can modify this value as per your requirements.

4. Finally, you can verify that the secrets now have an expiration time by retrieving the secret properties again:

```python
secrets = client.list_properties_of_secrets()

for secret in secrets:
    secret_properties = client.get_secret_properties(secret.name)
    print(f"{secret.name} expires on {secret_properties.expires_on}")
```

This will print the name of each secret and its expiration time.

By following the above steps, you can remediate the misconfiguration of secrets not having an expiration time in Azure using Python.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates](https://docs.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) 


</Tab>
</Tabs>