---
slug: azure_audit_monitor_security_group_rule_alert_create_update
title: Ensure Activity Log Alert exists for Create or Update Network Security Group Rule
sidebar_label: Ensure Activity Log Alert exists for Create or Update Network Security Group Rule
---

### More Info:

Monitoring for 'Create' or 'Update Network Security Group Rule' events gives insight into network access changes and may reduce the time it takes to detect suspicious activity.

### Risk Level

Low

### Address

Security, Operational Maturity

### Compliance Standards

SOC2, ISO27001, HIPAA, CISAZURE, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal and sign in with your Azure account credentials.

2. Navigate to Monitor: On the left-hand side menu, click on "Monitor". This will open the Monitor blade where you can view and manage all your monitoring settings.

3. Check Activity Log Alerts: In the Monitor blade, click on "Alerts" and then select "Manage alert rules". This will open a list of all your existing alert rules. Look for an alert rule that is set up to trigger when a "Create or Update Network Security Group Rule" event occurs. 

4. Verify Alert Details: Click on the alert rule to view its details. Make sure that the "Activity Log - Administrative" category is selected and the "Create or Update Network Security Group Rule" operation is specified. Also, ensure that the alert is enabled and properly configured to notify the appropriate parties when triggered.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List Activity Log Alerts: Use the following command to list all the activity log alerts in your Azure account. This will return a list of all the alerts along with their details.

    ```
    az monitor activity-log alert list
    ```

3. Filter for Network Security Group Rule Alerts: In the output of the previous command, look for alerts related to the creation or updating of Network Security Group rules. You can do this manually by looking at the 'condition' field of each alert, or you can use a command like the following to filter the output:

    ```
    az monitor activity-log alert list --query "[?contains(condition, 'CreateOrUpdateSecurityRule')]"
    ```

4. Check for Existence of Alert: If the previous command returns any results, then an activity log alert exists for the creation or updating of Network Security Group rules. If it does not return any results, then no such alert exists.

#### Using Python

To check if an Activity Log Alert exists for Create or Update Network Security Group Rule in Azure Monitoring using Python scripts, you can follow these steps:

1. **Setup Azure SDK for Python**: First, you need to install the Azure SDK for Python. You can do this by running the command `pip install azure-mgmt-monitor`. This SDK allows you to interact with Azure's monitoring services.

2. **Authenticate with Azure**: Before you can interact with Azure's services, you need to authenticate. You can do this using Azure's `DefaultAzureCredential` class. Here's an example:

    ```python
    from azure.identity import DefaultAzureCredential
    from azure.mgmt.monitor import MonitorManagementClient

    credential = DefaultAzureCredential()
    subscription_id = "your-subscription-id"  # replace with your subscription id
    client = MonitorManagementClient(credential, subscription_id)
    ```

3. **Fetch Activity Log Alerts**: Now that you're authenticated, you can fetch the activity log alerts. You can do this using the `activity_log_alerts` property of your client. Here's an example:

    ```python
    alerts = client.activity_log_alerts.list()
    ```

4. **Check for Network Security Group Rule Alerts**: Finally, you can iterate over the alerts and check if there's an alert for Create or Update Network Security Group Rule. Here's an example:

    ```python
    for alert in alerts:
        if "Create or Update Network Security Group Rule" in alert.condition.all_of:
            print(f"Alert {alert.name} exists for Create or Update Network Security Group Rule")
    ```

This script will print the names of all alerts that exist for Create or Update Network Security Group Rule. If no such alerts exist, it won't print anything.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration "Ensure Activity Log Alert exists for Create or Update Network Security Group Rule" in Azure using the Azure console:

1. Log in to the Azure portal using your credentials.
2. In the Azure portal, click on the "Security Center" icon in the left-hand menu.
3. Select "Security policy" from the Security Center menu.
4. In the "Security policy" page, click on the "Activity Log Alerts" option.
5. On the "Activity Log Alerts" page, click on the "+ Add activity log alert" button.
6. In the "Add activity log alert" page, select the "Resource Group" or "Subscription" that you want to create the alert for.
7. In the "Condition" section, select "Service" as "Network Security Group Rule" and "Operation" as "Write".
8. In the "Action group" section, select the action group that you want to use for the alert.
9. In the "Alert details" section, provide a name and description for the alert.
10. Click on the "Create alert rule" button to create the alert.

Once you have completed these steps, the misconfiguration "Ensure Activity Log Alert exists for Create or Update Network Security Group Rule" will be remediated in Azure. The alert will notify you when a new network security group rule is created or updated, which will help you identify any potential security issues.

#### Using CLI

To remediate the misconfiguration "Ensure Activity Log Alert exists for Create or Update Network Security Group Rule" in Azure using Azure CLI, you can follow the below steps:

1. Open the Azure CLI and login to your Azure account by running the command:

   ```
   az login
   ```

2. Once you are logged in, set the subscription where the misconfiguration exists by running the command:

   ```
   az account set --subscription <subscription_id>
   ```

   Replace `<subscription_id>` with the ID of the subscription where the misconfiguration exists.

3. Create an Activity Log Alert for Network Security Group Rule creation or update by running the command:

   ```
   az monitor activity-log alert create --name <alert_name> --description <alert_description> --condition category=Administrative and resourceType=Microsoft.Network/networkSecurityGroups and operationName=Microsoft.Network/networkSecurityGroups/securityRules/write --action-group <action_group_id> --enabled true
   ```

   Replace `<alert_name>` with a name for the alert, `<alert_description>` with a description for the alert, and `<action_group_id>` with the ID of an existing action group that will be notified when the alert is triggered.

4. Verify that the Activity Log Alert was created successfully by running the command:

   ```
   az monitor activity-log alert show --name <alert_name>
   ```

   Replace `<alert_name>` with the name of the alert that you created.

5. Once the Activity Log Alert is created, it will trigger whenever there is a Create or Update operation on a Network Security Group Rule. The action group that you specified will be notified when the alert is triggered.

By following the above steps, you can remediate the misconfiguration "Ensure Activity Log Alert exists for Create or Update Network Security Group Rule" in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration "Ensure Activity Log Alert exists for Create or Update Network Security Group Rule" for Azure using Python, you can follow these steps:

1. Install the necessary Python packages: 

```python
pip install azure-mgmt-monitor
pip install azure.identity
```

2. Authenticate to Azure using Python:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.monitor import MonitorManagementClient

credential = DefaultAzureCredential()
subscription_id = '<your-subscription-id>'

monitor_client = MonitorManagementClient(credential, subscription_id)
```

3. Create a new activity log alert:

```python
from azure.mgmt.monitor.models import (ActivityLogAlertActionList, ActivityLogAlertAllOfCondition, ActivityLogAlertLeafCondition, ActivityLogAlertList, ActivityLogAlertResourceRegionCondition)

alert_name = '<your-alert-name>'
resource_group_name = '<your-resource-group-name>'
nsg_name = '<your-nsg-name>'

condition = ActivityLogAlertAllOfCondition(
    all_of=[
        ActivityLogAlertLeafCondition(
            field='category',
            equals='Administrative'
        ),
        ActivityLogAlertLeafCondition(
            field='resourceType',
            equals='Microsoft.Network/networkSecurityGroups/securityRules'
        ),
        ActivityLogAlertLeafCondition(
            field='operationName',
            equals='Microsoft.Network/networkSecurityGroups/securityRules/write'
        ),
        ActivityLogAlertResourceRegionCondition(
            field='resourceRegion',
            equals='<your-region>'
        )
    ]
)

actions = ActivityLogAlertActionList(
    action_groups=[]
)

monitor_client.activity_log_alerts.create_or_update(
    resource_group_name=resource_group_name,
    activity_log_alert_name=alert_name,
    activity_log_alert=ActivityLogAlertList(
        scopes=[
            f"/subscriptions/{subscription_id}/resourceGroups/{resource_group_name}/providers/Microsoft.Network/networkSecurityGroups/{nsg_name}"
        ],
        condition=condition,
        actions=actions
    )
)
```

4. Verify that the activity log alert has been created:

```python
alert = monitor_client.activity_log_alerts.get(
    resource_group_name=resource_group_name,
    activity_log_alert_name=alert_name
)

print(alert)
```

This should remediate the misconfiguration "Ensure Activity Log Alert exists for Create or Update Network Security Group Rule" for Azure using Python.


### Additional Reading:

- [https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log](https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log) 


</Tab>
</Tabs>