---
slug: azure_audit_monitor_security_group_rule_alert_delete
title: Ensure Activity Log Alert exists for Delete Network Security Group Rule
sidebar_label: Ensure Activity Log Alert exists for Delete Network Security Group Rule
---

### More Info:

Monitoring for 'Delete Network Security Group Rule' events gives insight into network access changes and may reduce the time it takes to detect suspicious activity.

### Risk Level

Low

### Address

Security, Operational Maturity

### Compliance Standards

CISAZURE, CBP, SOC2, ISO27001, HIPAA



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal and sign in with your Azure account credentials.

2. Navigate to Monitor: On the left-hand side menu, click on "Monitor". This will open the Monitor blade where you can view and manage all your monitoring settings.

3. Check Activity Log Alerts: In the Monitor blade, click on "Alerts" and then select "Manage alert rules". This will open a list of all your existing alert rules. Look for an alert rule that is set up to trigger when a "Delete Network Security Group Rule" event occurs. 

4. Verify Alert Details: Click on the alert rule to view its details. Make sure that the "Action Group" is set to send notifications to the appropriate recipients and that the "Condition" is set to trigger on "Delete Network Security Group Rule" events. If such an alert does not exist, then it is a misconfiguration.

#### Using CLI

1. Install and configure Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine and sign in to your Azure account. You can install Azure CLI by following the instructions on the official Azure CLI documentation. Once installed, you can sign in to your Azure account using the command `az login`.

2. List existing Activity Log Alerts: Use the following command to list all the existing Activity Log Alerts in your Azure account.

   ```
   az monitor activity-log alert list
   ```

   This command will return a list of all the existing Activity Log Alerts. Each alert will have a name, resource group, condition, actions, and other properties.

3. Check for Delete Network Security Group Rule Alert: Now, you need to check if there is an alert for "Delete Network Security Group Rule". You can do this by looking at the "condition" property of each alert. The condition property should contain "Delete Network Security Group Rule" if such an alert exists.

   You can use the following command to filter the alerts and find the one for "Delete Network Security Group Rule".

   ```
   az monitor activity-log alert list --query "[?contains(condition, 'Delete Network Security Group Rule')]"
   ```

4. Verify the Alert: If the above command returns an alert, it means that an Activity Log Alert for "Delete Network Security Group Rule" exists. If it doesn't return anything, it means that such an alert doesn't exist. You can also verify the alert by checking its actions. The actions property should contain the actions that will be taken when the alert is triggered.

#### Using Python

1. Install Azure SDK: To interact with Azure services, you need to install Azure SDK in your Python environment. You can do this by running the command `pip install azure-mgmt-monitor`.

2. Authenticate with Azure: Before you can interact with Azure services, you need to authenticate. You can do this using Azure CLI or by creating a service principal and using it to authenticate. Here is a sample code snippet for authentication:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.monitor import MonitorManagementClient

credential = DefaultAzureCredential()
subscription_id = "your-subscription-id" # replace with your Azure Subscription ID
monitor_client = MonitorManagementClient(credential, subscription_id)
```

3. Fetch Activity Log Alerts: Now, you can fetch all the activity log alerts in your subscription. Here is a sample code snippet:

```python
activity_log_alerts = monitor_client.activity_log_alerts.list_by_subscription_id()

for alert in activity_log_alerts:
    print(alert.name)
```

4. Check for Delete Network Security Group Rule Alert: Now, you can iterate over all the alerts and check if there is an alert for "Delete Network Security Group Rule". Here is a sample code snippet:

```python
def check_for_delete_nsg_rule_alert(activity_log_alerts):
    for alert in activity_log_alerts:
        if 'Delete Network Security Group Rule' in alert.name:
            return True
    return False

if check_for_delete_nsg_rule_alert(activity_log_alerts):
    print("Delete Network Security Group Rule alert exists.")
else:
    print("Delete Network Security Group Rule alert does not exist.")
```

This script will print whether the "Delete Network Security Group Rule" alert exists or not.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure Activity Log Alert exists for Delete Network Security Group Rule" for Azure using Azure console, follow the below steps:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Select the subscription for which you want to remediate the misconfiguration.
3. Click on the "Activity log alerts" option from the left-hand side menu.
4. Click on the "+ Add activity log alert" button to create a new alert.
5. In the "Basics" tab, provide a name for the alert, select the subscription, and resource group for which you want to create the alert.
6. In the "Condition" tab, select the "Delete Network Security Group Rule" option from the "Event name" dropdown.
7. In the "Actions" tab, select the action you want to take when the alert is triggered. You can choose to send an email, a webhook, or a SMS message.
8. In the "Review + create" tab, review the alert configuration and click on the "Create" button to create the alert.

Once the alert is created, it will trigger whenever a network security group rule is deleted, and you will receive a notification based on the action you have configured. This will help you to identify and prevent accidental or unauthorized deletion of network security group rules.

#### Using CLI

To remediate the misconfiguration of missing Activity Log Alert for Delete Network Security Group Rule in AZURE using AZURE CLI, follow the below steps:

Step 1: Open the AZURE CLI on your local machine or use the AZURE Cloud Shell.

Step 2: Check if the Activity Log Alert exists for Delete Network Security Group Rule by running the following command:

```
az monitor activity-log alert list --query "[?contains(details.action, 'Microsoft.Network/networkSecurityGroups/securityRules/delete')]"
```

This command will list all the Activity Log Alerts that exist for the Delete Network Security Group Rule.

Step 3: If the Activity Log Alert does not exist, create a new one by running the following command:

```
az monitor activity-log alert create --name <alert-name> --resource-group <resource-group-name> --condition category=Administrative and operationName=Microsoft.Network/networkSecurityGroups/securityRules/delete --action-group <action-group-id>
```

Replace `<alert-name>` with the name you want to give to the new Activity Log Alert, `<resource-group-name>` with the name of the resource group where the security group is located, and `<action-group-id>` with the ID of the action group that should be notified when the Activity Log Alert is triggered.

Step 4: Verify if the Activity Log Alert is created successfully by running the following command:

```
az monitor activity-log alert list --query "[?contains(details.action, 'Microsoft.Network/networkSecurityGroups/securityRules/delete')]"
```

This command will list all the Activity Log Alerts that exist for the Delete Network Security Group Rule, and the newly created Activity Log Alert should be listed.

By following these steps, you can remediate the misconfiguration of missing Activity Log Alert for Delete Network Security Group Rule in AZURE using AZURE CLI.

#### Using Python

To remediate the misconfiguration "Ensure Activity Log Alert exists for Delete Network Security Group Rule" in Azure using Python, you can follow the below steps:

Step 1: Install the Azure Python SDK using the following command:
```
pip install azure-mgmt-monitor
```

Step 2: Authenticate to Azure using the Azure CLI or using a Service Principal.

Step 3: Use the following Python code to create an Activity Log alert for the Delete Network Security Group Rule:

```python
from azure.mgmt.monitor import MonitorManagementClient
from azure.mgmt.monitor.models import *

# Replace <Subscription_Id> with your Subscription Id
subscription_id = '<Subscription_Id>'

# Replace <Resource_Group_Name> with the name of the Resource Group where the Network Security Group is located
resource_group_name = '<Resource_Group_Name>'

# Replace <Network_Security_Group_Name> with the name of the Network Security Group
network_security_group_name = '<Network_Security_Group_Name>'

# Replace <Activity_Log_Alert_Name> with the name of the Activity Log Alert
activity_log_alert_name = '<Activity_Log_Alert_Name>'

# Create a Monitor Management Client
monitor_client = MonitorManagementClient(
    credential=credentials,
    subscription_id=subscription_id
)

# Create a condition for the Activity Log Alert
condition = ManagementEventRuleCondition(
    all_of=[
        ManagementEventAggregationCondition(
            field='category',
            equals='Administrative'
        ),
        ManagementEventAggregationCondition(
            field='resourceId',
            equals=f'/subscriptions/{subscription_id}/resourceGroups/{resource_group_name}/providers/Microsoft.Network/networkSecurityGroups/{network_security_group_name}'
        ),
        ManagementEventAggregationCondition(
            field='operationName',
            equals='Microsoft.Network/networkSecurityGroups/securityRules/delete'
        )
    ]
)

# Create an Action Group for the Activity Log Alert
action_group = ActionGroup(
    group_short_name='Email Action Group',
    email_receivers=[
        ActionGroupReceiver(
            name='Email Receiver',
            email_address='youremail@example.com'
        )
    ]
)

# Create the Activity Log Alert
monitor_client.alert_rules.create_or_update(
    resource_group_name=resource_group_name,
    rule_name=activity_log_alert_name,
    parameters=ActivityLogAlert(
        location='global',
        enabled=True,
        condition=condition,
        actions=[action_group]
    )
)
```

In the above code, replace the placeholders `<Subscription_Id>`, `<Resource_Group_Name>`, `<Network_Security_Group_Name>` and `<Activity_Log_Alert_Name>` with the appropriate values.

This code will create an Activity Log Alert for the Delete Network Security Group Rule in Azure. When this rule is triggered, an email will be sent to the specified email address.


### Additional Reading:

- [https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log](https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log) 


</Tab>
</Tabs>