

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to Monitor: On the left-hand side menu, click on "Monitor". This will open the Monitor blade where you can view and manage all your monitoring settings.

3. Access Activity Log: In the Monitor blade, click on "Activity log" under the "Insights" section. This will open the Activity Log blade where you can view all the activities that have occurred in your Azure environment.

4. Check Log Retention Policy: In the Activity Log blade, click on "Diagnostic settings" under the "Settings" section. Here, you can view the current log retention policy. Ensure that the retention period is set to 365 days or greater. If it's less than 365 days, then it's a misconfiguration.

#### Using CLI

1. Install and configure Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine and sign in to your Azure account. You can install Azure CLI by following the instructions provided by Microsoft. After installing Azure CLI, you can sign in to your Azure account by running the following command in your terminal:

   ```
   az login
   ```

2. List all the activity log alert rules: Once you are signed in to your Azure account, you can list all the activity log alert rules in your account by running the following command:

   ```
   az monitor activity-log alert list
   ```

3. Check the retention period of each activity log alert rule: The output of the previous command includes information about the retention period of each activity log alert rule. You can check the retention period of each rule by looking at the 'retentionDays' field in the output. 

4. Verify the retention period: If the 'retentionDays' field of all the activity log alert rules is 365 or greater, then the activity log retention is set for 365 days or greater. If any of the 'retentionDays' fields is less than 365, then the activity log retention is not set for 365 days or greater.

#### Using Python

To check if the activity log retention is set for 365 days or greater in Azure Monitoring using Python scripts, you can follow these steps:

1. **Install Azure SDK for Python**: Azure SDK for Python is a set of libraries that allow you to manage your Azure resources. To install it, you can use pip:
   ```
   pip install azure-mgmt-monitor
   ```
2. **Authenticate to Azure**: Before you can interact with Azure resources, you need to authenticate using a Service Principal. You can use Azure CLI to create one:
   ```
   az ad sp create-for-rbac --name "myApp" --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} --sdk-auth
   ```
   This will output a JSON with the credentials that you can use in your Python script.

3. **Get the Activity Log Profile**: Use the Azure SDK for Python to get the activity log profile. This will contain the information about the retention policy. Here is a sample script:
   ```python
   from azure.identity import ClientSecretCredential
   from azure.mgmt.monitor import MonitorManagementClient

   subscription_id = 'your-subscription-id'
   credentials = ClientSecretCredential(
       client_id='your-client-id',
       client_secret='your-client-secret',
       tenant_id='your-tenant-id'
   )

   monitor_client = MonitorManagementClient(credentials, subscription_id)

   activity_log_profile = monitor_client.activity_log_alerts.get('your-resource-group', 'your-activity-log-profile')

   print(activity_log_profile)
   ```
4. **Check the Retention Policy**: The `activity_log_profile` object will contain a `retention_policy` attribute. You can check if the `days` attribute is 365 or greater:
   ```python
   if activity_log_profile.retention_policy.days >= 365:
       print('Activity log retention is set for 365 days or greater')
   else:
       print('Activity log retention is less than 365 days')
   ```
Remember to replace 'your-subscription-id', 'your-client-id', 'your-client-secret', 'your-tenant-id', 'your-resource-group', and 'your-activity-log-profile' with your actual Azure details.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure activity log retention is set for 365 days or greater" in Azure using Azure console, follow the below steps:

1. Login to the Azure portal (https://portal.azure.com/).
2. Click on the "Azure Active Directory" icon from the left-hand side menu.
3. Select the "Activity log" option from the left-hand side menu.
4. Click on the "Export settings" option from the top menu.
5. In the "Export settings" page, select the "Retention (days)" option.
6. Enter "365" or greater in the "Retention (days)" field.
7. Click on the "Save" button to save the changes.

Once the retention period is set to 365 days or greater, all the activity logs will be retained for the specified period, and the misconfiguration will be remediated.

#### Using CLI

To remediate the misconfiguration of activity log retention for Azure using Azure CLI, follow the below steps:

Step 1: Open the Azure CLI command prompt.

Step 2: Run the following command to set the activity log retention to 365 days or greater:

```
az monitor log-profiles create --name Default --location <location> --categories Write --days 365
```

Note: Replace `<location>` with the location where you want to create the log profile.

Step 3: Verify the configuration by running the following command:

```
az monitor log-profiles show --name Default
```

This command will show the details of the log profile that you just created.

Step 4: Once verified, you can close the Azure CLI command prompt.

By following these steps, you have successfully remediated the misconfiguration of activity log retention for Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of activity log retention for Azure using Python, you need to use the Azure SDK for Python. Here are the steps to remediate the issue:

1. Install the Azure SDK for Python by running the following command in the terminal:

```
pip install azure-mgmt-monitor
```

2. Import the necessary modules in your Python script:

```
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.monitor import MonitorManagementClient
```

3. Set the credentials for your Azure account by creating a Service Principal and assigning it the appropriate permissions. You will need to provide the following details in your script:

- Tenant ID
- Client ID
- Client Secret
- Subscription ID

```
credentials = ServicePrincipalCredentials(
    client_id='<client-id>',
    secret='<client-secret>',
    tenant='<tenant-id>'
)

subscription_id = '<subscription-id>'
```

4. Create a MonitorManagementClient object using the credentials and subscription ID:

```
monitor_client = MonitorManagementClient(
    credentials=credentials,
    subscription_id=subscription_id
)
```

5. Retrieve the current retention period for activity logs:

```
retention_period = monitor_client.activity_log_alerts.list()[0].retention_policy.enabled
```

6. If the retention period is less than 365 days, update the retention policy:

```
if retention_period < 365:
    monitor_client.activity_log_alerts.update_retention_policy(
        enabled=True,
        days=365
    )
```

7. Run the script to remediate the misconfiguration.

This will ensure that activity log retention is set for 365 days or greater in Azure.


</Tab>
</Tabs>