---
slug: azure_audit_monitor_security_solution_alert_delete
title: Create Alert for "Delete Security Solution" Events
sidebar_label: Create Alert for "Delete Security Solution" Events
---

### More Info:

Security solution changes have been detected within your Microsoft Azure cloud account.

### Risk Level

High

### Address

Security

### Compliance Standards

HIPAA, CISAZURE, CBP, ISO27001


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal and log in with your Azure account credentials.

2. Navigate to Azure Monitor: From the left-hand side menu, select "Monitor". Azure Monitor provides base-level infrastructure metrics and logs for most services in Microsoft Azure.

3. Create a new alert rule: In the Azure Monitor section, click on "Alerts" in the left-hand menu, then click on "+ New alert rule". This will open a new pane where you can create a new alert rule.

4. Configure the alert rule: In the "Create rule" pane, you need to specify the following details:
   - Resource: Select the resource you want to monitor. In this case, it would be the Security Solution.
   - Condition: Set the condition for the alert. Here, you would select "Delete Security Solution" as the event that triggers the alert.
   - Action Group: Define what actions should be taken when the alert is triggered. This could be sending an email or SMS, calling a webhook, etc.
   - Alert Details: Provide a name and description for the alert rule, and set the severity level.

After you've filled in these details, click on "Create alert rule" to finalize and create the alert. Now, whenever a "Delete Security Solution" event occurs, Azure Monitor will trigger the alert and perform the actions you've defined.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI, you need to install it on your local machine. You can download it from the official Microsoft website and follow the installation instructions.

2. Login to Azure: After installing Azure CLI, you need to login to your Azure account. Open your terminal or command prompt and type the following command:
   ```
   az login
   ```
   This command will open a new window in your web browser asking you to login to your Azure account. After logging in, you can close the browser window and return to your terminal.

3. Check for existing alerts: To check if there is an existing alert for "Delete Security Solution" events, you can use the following command:
   ```
   az monitor activity-log alert list
   ```
   This command will list all the existing alerts. You can look for "Delete Security Solution" in the output.

4. Create a new alert: If there is no existing alert for "Delete Security Solution" events, you can create a new one using the following command:
   ```
   az monitor activity-log alert create --name "DeleteSecuritySolutionAlert" --condition "category = 'Administrative' and operationName = 'Microsoft.Security/securitySolutions/delete'"
   ```
   This command will create a new alert named "DeleteSecuritySolutionAlert" that will trigger when a "Delete Security Solution" event occurs.

#### Using Python

1. **AWS CloudTrail and Boto3:**
   AWS CloudTrail allows you to log, continuously monitor, and retain account activity related to actions across your AWS infrastructure. You can use Boto3, the AWS SDK for Python, to create, configure, and manage AWS services.

   ```python
   import boto3

   client = boto3.client('cloudtrail')

   response = client.lookup_events(
       LookupAttributes=[
           {
               'AttributeKey': 'EventName',
               'AttributeValue': 'DeleteSecurityGroup'
           },
       ],
   )

   if response['Events']:
       print("Delete Security Group event detected!")
   ```

2. **Azure Monitor and Azure SDK for Python:**
   Azure Monitor maximizes the availability and performance of your applications by delivering a comprehensive solution for collecting, analyzing, and acting on telemetry from your cloud and on-premises environments. 

   ```python
   from azure.monitor import MonitorManagementClient
   from azure.common.credentials import ServicePrincipalCredentials

   credentials = ServicePrincipalCredentials(
       client_id = 'your_client_id',
       secret = 'your_secret',
       tenant = 'your_tenant_id'
   )

   client = MonitorManagementClient(credentials, 'your_subscription_id')

   activity_logs = client.activity_logs.list(
       filter="eventTimestamp ge '2020-06-01T00:00:00Z' and eventTimestamp le '2020-06-02T00:00:00Z' and operationName eq 'Microsoft.Security/delete'"
   )

   for log in activity_logs:
       print("Delete Security Solution event detected!")
   ```

3. **Google Cloud Logging and Google Cloud Client Library for Python:**
   Google Cloudâ€™s operations suite (formerly Stackdriver) allows you to store, search, analyze, monitor, and alert on log data and events from Google Cloud and AWS.

   ```python
   from google.cloud import logging

   client = logging.Client()

   filter_str = 'resource.type="gce_instance" AND protoPayload.methodName="v1.compute.instances.delete"'

   for entry in client.list_entries(filter_=filter_str):  # API call
       print("Delete Security Solution event detected!")
   ```
   
Please replace 'your_client_id', 'your_secret', 'your_tenant_id', 'your_subscription_id' with your actual Azure credentials. Also, ensure that you have the necessary permissions and have set up the environment correctly to use AWS Boto3, Azure SDK, and Google Cloud Client Library for Python.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration of creating an alert for "Delete Security Solution" events in Azure using the Azure console:

1. Open the Azure portal and navigate to the Security Center.

2. Click on "Security policy" from the left-hand menu.

3. Select the policy that you want to update.

4. Scroll down to the "Alerts" section and click on "Add alert".

5. In the "Create alert rule" window, select the "Activity log" option.

6. Under "Event types", select "Service Health" and then select "Service health status changes".

7. In the "Service health status changes" section, select "Resolved" and "Dismissed" as the status changes to be alerted for.

8. Under "Actions", select "Email/SMS/Push/Voice" and add the email addresses of the people who should be alerted.

9. Click on "Create alert rule" to save the configuration.

Once you have followed these steps, you should receive an alert whenever a "Delete Security Solution" event is detected in Azure. This will help you to take immediate action to remediate any potential security risks.

#### Using CLI

To remediate the misconfiguration of not having an alert for "Delete Security Solution" events in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI on your local machine or Azure Cloud Shell.
2. Run the following command to create a new activity log alert rule:

```
az monitor activity-log alert create --name <alert-name> --description <alert-description> --resource-group <resource-group-name> --condition category=Administrative and operationName=Microsoft.Security/securitySolutions/delete --action <action-group-name> --enabled true
```

Replace the placeholders `<alert-name>`, `<alert-description>`, `<resource-group-name>`, and `<action-group-name>` with the appropriate values for your environment.

3. The `--condition` parameter specifies the condition for the alert rule. In this case, it is set to trigger when an administrative action is taken to delete a security solution. You can modify this condition to suit your specific needs.
4. The `--action` parameter specifies the action to take when the alert is triggered. You can specify an action group that contains one or more actions, such as sending an email notification or invoking a webhook.
5. Once the command completes successfully, the alert rule will be created and enabled.

By following these steps, you will have successfully remediated the misconfiguration of not having an alert for "Delete Security Solution" events in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of not having an alert for "Delete Security Solution" events in Azure, you can follow these steps using Python:

1. Install the Azure SDK for Python using the following command:

```
pip install azure-mgmt-monitor
```

2. Import the required modules:

```
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.monitor import MonitorManagementClient
from azure.mgmt.monitor.models import RuleCondition, ManagementEventAggregationCondition, RuleDataSource, RuleMetricDataSourceConfiguration, RuleManagementEventClaimsDataSourceConfiguration, RuleEmailAction, RuleAction
```

3. Set up the Azure credentials by creating a Service Principal:

```
subscription_id = '<your-subscription-id>'
client_id = '<your-client-id>'
client_secret = '<your-client-secret>'
tenant_id = '<your-tenant-id>'

credentials = ServicePrincipalCredentials(client_id=client_id, secret=client_secret, tenant=tenant_id)
```

4. Create a MonitorManagementClient object:

```
monitor_client = MonitorManagementClient(credentials, subscription_id)
```

5. Define the alert rule condition:

```
condition = RuleCondition(
    data_source=RuleDataSource(
        type='Microsoft.Insights/scheduledQueryResults',
        query='SecurityEvent\n| where EventID == "4688"\n| where TimeGenerated > ago(1d)\n| where OperationName == "Microsoft.Compute/virtualMachines/delete"\n| project ResourceId, ResourceGroupName, Computer, Caller, TimeGenerated'
    ),
    window_size='PT5M',
    all_of=[
        ManagementEventAggregationCondition(
            metric_name='count',
            operator='GreaterThan',
            threshold=0,
            metric_namespace='Microsoft.Insights/scheduledQueryResults',
            dimensions=[
                {
                    'name': 'ResourceId',
                    'operator': 'Include',
                    'values': [
                        '*'
                    ]
                }
            ],
            time_aggregation='Average'
        )
    ]
)
```

6. Define the alert rule action:

```
action = RuleAction(
    send_email=RuleEmailAction(
        custom_emails=[
            '<your-email-address>'
        ],
        send_to_service_owners=False,
        send_to_subscription_administrators=False
    )
)
```

7. Create the alert rule:

```
rule_name = 'Delete Security Solution Alert'
resource_group_name = '<your-resource-group-name>'
location = '<your-location>'

data_source_config = RuleMetricDataSourceConfiguration(
    metric_name='count',
    metric_namespace='Microsoft.Insights/scheduledQueryResults',
    resource_uri='/subscriptions/{0}'.format(subscription_id)
)

claims_data_source_config = RuleManagementEventClaimsDataSourceConfiguration()

monitor_client.alert_rules.create_or_update(
    resource_group_name=resource_group_name,
    rule_name=rule_name,
    parameters={
        'location': location,
        'description': 'Alert rule for detecting delete security solution events',
        'is_enabled': True,
        'condition': condition,
        'actions': [action],
        'data_source': data_source_config,
        'claims_data_source': claims_data_source_config
    }
)
```

This will create an alert rule in Azure that will send an email notification to the specified email address when a "Delete Security Solution" event is detected.




</Tab>
</Tabs>