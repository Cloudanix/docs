---
slug: azure_audit_networksecurity_security_group_unrestricted_tcp_udp_selected_port
title: Check for Unrestricted Inbound TCP or UDP Access on Selected Ports
sidebar_label: Check for Unrestricted Inbound TCP or UDP Access on Selected Ports
---

### More Info:

Ensure that no network security groups allow unrestricted inbound access via TCP or UDP on selected ports.

### Risk Level

High

### Address

Security

### Compliance Standards

CISAZURE, CBP, HITRUST, GDPR, SOC2, NISTCSF, PCIDSS, FedRAMP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser's address bar. Enter your Azure account credentials to log in.

2. Navigate to Network Security Groups: From the left-hand side menu, select "All services". In the "All services" box, type "Network Security Groups". Select "Network Security Groups" from the search results.

3. Check Inbound Security Rules: Select the Network Security Group (NSG) you want to inspect. In the NSG window, select "Inbound security rules" from the left-hand side menu. This will display a list of all inbound security rules configured for the selected NSG.

4. Inspect the Rules: Look for any rules that allow unrestricted inbound TCP or UDP access on selected ports. These rules will have "Any" in the "Source" column and the port range in the "Destination port ranges" column. If such rules exist, it indicates a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install the Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List Network Security Groups: The first step to check for unrestricted inbound TCP or UDP access on selected ports is to list all the Network Security Groups (NSGs) in your Azure account. You can do this by running the following command: `az network nsg list --query "[].{Name:name, ResourceGroup:resourceGroup}" -o table`. This command will display a table with the names of all NSGs and their respective resource groups.

3. Check NSG Rules: For each NSG, you need to check the rules to see if there are any that allow unrestricted inbound TCP or UDP access. You can do this by running the following command for each NSG: `az network nsg rule list --nsg-name NSG_NAME --resource-group RESOURCE_GROUP --query "[?direction=='Inbound'].{Name:name, Protocol:protocol, SourcePortRange:sourcePortRange, DestinationPortRange:destinationPortRange, SourceAddressPrefix:sourceAddressPrefix, Access:access}" -o table`. Replace `NSG_NAME` and `RESOURCE_GROUP` with the name and resource group of the NSG you want to check. This command will display a table with the details of all inbound rules for the specified NSG.

4. Analyze the Results: The last step is to analyze the results. If any of the rules have a SourceAddressPrefix of '*' (which means any source) and Access of 'Allow', then that means unrestricted inbound TCP or UDP access is allowed. The Protocol column will tell you whether the rule applies to TCP, UDP, or both. The SourcePortRange and DestinationPortRange columns will tell you which ports the rule applies to.

#### Using Python

1. AWS:
   - Use the boto3 library in Python to interact with AWS services. 
   - To check for unrestricted inbound TCP or UDP access, you can use the EC2 client's `describe_security_groups()` function to get a list of all security groups and their rules.
   - Then, iterate over these rules and check if any of them allow unrestricted inbound TCP or UDP access. This can be done by checking if the 'IpProtocol' field is 'tcp' or 'udp', and the 'CidrIp' field is '0.0.0.0/0'.
   - Here is a sample script:
   ```python
   import boto3

   ec2 = boto3.client('ec2')

   response = ec2.describe_security_groups()

   for group in response['SecurityGroups']:
       for permission in group['IpPermissions']:
           if permission['IpProtocol'] in ['tcp', 'udp'] and '0.0.0.0/0' in [rule['CidrIp'] for rule in permission['IpRanges']]:
               print(f"Unrestricted inbound TCP or UDP access detected in security group: {group['GroupId']}")
   ```

2. Azure:
   - Use the azure-mgmt-network library in Python to interact with Azure Network resources.
   - To check for unrestricted inbound TCP or UDP access, you can use the NetworkManagementClient's `network_security_groups.get()` function to get a list of all network security groups and their rules.
   - Then, iterate over these rules and check if any of them allow unrestricted inbound TCP or UDP access. This can be done by checking if the 'protocol' field is 'Tcp' or 'Udp', and the 'source_address_prefix' field is '*'.
   - Here is a sample script:
   ```python
   from azure.mgmt.network import NetworkManagementClient
   from azure.identity import DefaultAzureCredential

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   network_client = NetworkManagementClient(credential, subscription_id)

   for nsg in network_client.network_security_groups.list_all():
       for rule in nsg.security_rules:
           if rule.protocol in ['Tcp', 'Udp'] and rule.source_address_prefix == '*':
               print(f"Unrestricted inbound TCP or UDP access detected in network security group: {nsg.id}")
   ```

3. GCP:
   - Use the google-cloud-compute library in Python to interact with GCP Compute Engine resources.
   - To check for unrestricted inbound TCP or UDP access, you can use the Compute Engine client's `firewalls().list()` function to get a list of all firewall rules.
   - Then, iterate over these rules and check if any of them allow unrestricted inbound TCP or UDP access. This can be done by checking if the 'allowed' field contains 'tcp' or 'udp', and the 'sourceRanges' field contains '0.0.0.0/0'.
   - Here is a sample script:
   ```python
   from google.cloud import compute_v1

   compute = compute_v1.ComputeEngineClient()

   for firewall in compute.firewalls().list(project='your-project-id'):
       for rule in firewall.allowed:
           if rule.IPProtocol in ['tcp', 'udp'] and '0.0.0.0/0' in firewall.source_ranges:
               print(f"Unrestricted inbound TCP or UDP access detected in firewall rule: {firewall.name}")
   ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the issue of unrestricted inbound TCP or UDP access on selected ports in Azure:

1. Log in to the Azure portal using your credentials.
2. Navigate to the 'Security Center' from the left-hand side menu.
3. Click on 'Security Alerts' and then select the alert that says 'Unrestricted inbound TCP/UDP access to a port in a Network Security Group (NSG)'.
4. Review the details of the alert, including the affected NSG and the specific port(s) that have unrestricted access.
5. Click on the 'Remediate' button at the top of the alert details page.
6. Select the 'Deploy to Resource Group' option and then click on 'Create'.
7. In the 'Basics' tab of the deployment wizard, select the affected subscription, resource group, and location.
8. In the 'Template' tab, select the 'Edit Template' option and then make the following changes:
   - Under 'parameters', select the appropriate NSG from the dropdown menu.
   - Under 'variables', add a new variable for the port(s) that need to be restricted, such as:
     ```
      "restrictedPorts": {
           "value": [
             "22",
             "3389"
           ]
         }
         ```
   - Under 'resources', add a new resource for the NSG rule that will restrict access to the specified port(s), such as:
        ```
         {
             "type": "Microsoft.Network/networkSecurityGroups/securityRules",
             "apiVersion": "2021-02-01",
             "name": "restrictInboundPorts",
             "location": "[parameters('location')]",
             "dependsOn": [
                 "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
             ],
             "properties": {
                 "description": "Restrict inbound access to specified ports",
                 "protocol": "Tcp",
                 "sourcePortRange": "*",
                 "destinationPortRange": "[variables('restrictedPorts')]",
                 "sourceAddressPrefix": "*",
                 "destinationAddressPrefix": "*",
                 "access": "Deny",
                 "priority": 200,
                 "direction": "Inbound"
             }
         }
         ```
9. Save the template and then click on `Review + create`.
10. Review the deployment settings and then click on 'Create' to initiate the deployment.

Once the deployment is complete, the NSG rule will be in effect and inbound access to the specified port(s) will be restricted. You can verify the changes by reviewing the NSG rules in the Azure portal.

#### Using CLI

To remediate the misconfiguration of unrestricted inbound TCP or UDP access on selected ports in Azure using Azure CLI, you can follow the below steps:

Step 1: Open the Azure CLI and run the following command to list all the network security groups (NSGs) in your subscription:

```
az network nsg list
```

Step 2: Identify the NSG that is associated with the virtual machine (VM) or network interface (NIC) that has the unrestricted inbound TCP or UDP access on selected ports.

Step 3: Run the following command to identify the NSG rules that allow unrestricted inbound access:

```
az network nsg rule list --nsg-name <NSG name> --query "[?destinationPortRange=='*']"
```

Replace `<NSG name>` with the name of the NSG identified in step 2.

Step 4: Identify the rule that needs to be remediated and note down its name.

Step 5: Run the following command to update the NSG rule and restrict the inbound access:

```
az network nsg rule update --nsg-name <NSG name> --name <rule name> --access Deny
```

Replace `<NSG name>` with the name of the NSG identified in step 2 and `<rule name>` with the name of the rule identified in step 4.

Step 6: Verify that the rule has been updated by running the following command:

```
az network nsg rule show --nsg-name <NSG name> --name <rule name>
```

Replace `<NSG name>` with the name of the NSG identified in step 2 and `<rule name>` with the name of the rule identified in step 4.

Step 7: Repeat steps 3-6 for all the NSGs that have unrestricted inbound TCP or UDP access on selected ports.

By following these steps, you can remediate the misconfiguration of unrestricted inbound TCP or UDP access on selected ports in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of unrestricted inbound TCP or UDP access on selected ports in Azure using Python, follow these steps:

1. Install the Azure SDK for Python using the following command:

```
pip install azure
```

2. Authenticate to Azure using the following code:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.network import NetworkManagementClient

credential = DefaultAzureCredential()
network_client = NetworkManagementClient(credential, subscription_id)
```

Replace `<subscription_id>` with your Azure subscription ID.

3. Get the list of network security groups in the resource group using the following code:

```python
nsg_list = network_client.network_security_groups.list(resource_group_name)
```

Replace `<resource_group_name>` with the name of your resource group.

4. Iterate through each network security group and get the list of security rules using the following code:

```python
for nsg in nsg_list:
    rule_list = network_client.security_rules.list(resource_group_name, nsg.name)
```

Replace `<resource_group_name>` with the name of your resource group.

5. Iterate through each security rule and check if it allows unrestricted inbound TCP or UDP access on selected ports using the following code:

```python
for rule in rule_list:
    if rule.destination_port_range == '*' and rule.protocol in ['Tcp', 'Udp'] and rule.source_address_prefix == '*':
        # Delete the security rule
        network_client.security_rules.delete(resource_group_name, nsg.name, rule.name)
```

6. If the security rule allows unrestricted inbound TCP or UDP access on selected ports, delete the security rule using the following code:

```python
network_client.security_rules.delete(resource_group_name, nsg.name, rule.name)
```

Replace `<resource_group_name>` with the name of your resource group and `<nsg.name>` with the name of the network security group.

7. Save the Python script and run it using the following command:

```
python <script_name>.py
```

Replace `<script_name>` with the name of your Python script.

By following these steps, you can remediate the misconfiguration of unrestricted inbound TCP or UDP access on selected ports in Azure using Python.




</Tab>
</Tabs>