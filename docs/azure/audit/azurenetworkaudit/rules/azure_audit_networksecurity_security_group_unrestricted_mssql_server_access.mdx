---
slug: azure_audit_networksecurity_security_group_unrestricted_mssql_server_access
title: Unrestricted MSSQL Server Access
sidebar_label: Unrestricted MSSQL Server Access
---

### More Info:

Ensure that all your Microsoft Azure network security groups (NSGs) restrict inbound/ingress access on TCP port 1433 to trusted IP addresses only in order to implement the principle of least privilege and significantly reduce the attack surface. TCP port 1433 is used by Microsoft Azure SQL Server, the relational database management system developed by Microsoft.

### Risk Level

High

### Address

Security

### Compliance Standards

SOC2, GDPR, HIPAA, NISTCSF, PCIDSS, FedRAMP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to SQL servers: From the left-hand menu, select "SQL servers" under the "SQL databases" section. This will display a list of all SQL servers in your Azure environment.

3. Check firewall settings: For each SQL server, click on the server name to open its dashboard. Then, select "Firewalls and virtual networks" under the "Security" section. Here, you can see the firewall rules that are currently in place for the server.

4. Check for unrestricted access: Look for any firewall rules that have a Start IP and End IP range of 0.0.0.0 to 255.255.255.255. This indicates that the SQL server is accessible from any IP address, which is a misconfiguration as it allows unrestricted access.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List Network Security Groups: Use the following command to list all the Network Security Groups (NSGs) in a specific subscription:

    ```
    az network nsg list --subscription MySubscription
    ```
   Replace 'MySubscription' with your actual subscription name. This command will return a JSON output with all the NSGs in your subscription.

3. Check Security Rules: For each NSG, check the security rules to see if there are any rules allowing unrestricted access to MSSQL Server. The default port for MSSQL Server is 1433. Use the following command to list all the security rules for a specific NSG:

    ```
    az network nsg rule list --nsg-name MyNSG --resource-group MyResourceGroup
    ```
   Replace 'MyNSG' with the name of your NSG and 'MyResourceGroup' with the name of your resource group. This command will return a JSON output with all the security rules for the specified NSG.

4. Analyze the Output: Look for any rules in the output that have 'destinationPortRange' set to '1433' and 'access' set to 'Allow'. If such a rule exists, it means that unrestricted access to MSSQL Server is allowed.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries. For this task, we will need the 'boto3' library for AWS, 'azure.mgmt.network' for Azure, and 'google-cloud-securitycenter' for GCP. These libraries allow us to interact with the respective cloud services.

```python
import boto3
from azure.mgmt.network import NetworkManagementClient
from google.cloud import securitycenter_v1
```

2. **Create a Client**: The next step is to create a client for the respective cloud service. This client will be used to interact with the cloud service.

```python
# AWS
aws_client = boto3.client('ec2')

# Azure
credentials = ServicePrincipalCredentials(
    client_id = 'client_id',
    secret = 'secret',
    tenant = 'tenant'
)
azure_client = NetworkManagementClient(credentials, 'subscription_id')

# GCP
gcp_client = securitycenter_v1.SecurityCenterClient()
```

3. **Check for Unrestricted MSSQL Server Access**: Now, we can use the client to check for unrestricted MSSQL server access. This can be done by checking the security groups for any rules that allow unrestricted access to port 1433, which is the default port for MSSQL server.

```python
# AWS
response = aws_client.describe_security_groups()
for group in response['SecurityGroups']:
    for permission in group['IpPermissions']:
        if permission['FromPort'] == 1433 and permission['IpRanges'] == [{'CidrIp': '0.0.0.0/0'}]:
            print(f"Unrestricted MSSQL Server Access in group {group['GroupName']}")

# Azure
for security_group in azure_client.network_security_groups.list_all():
    for rule in security_group.security_rules:
        if rule.destination_port_range == '1433' and rule.source_address_prefix == '*':
            print(f"Unrestricted MSSQL Server Access in group {security_group.name}")

# GCP
for finding in gcp_client.list_findings('organization_id'):
    if finding.category == 'Unrestricted MSSQL Server Access':
        print(f"Unrestricted MSSQL Server Access in project {finding.project_id}")
```

4. **Handle Exceptions**: Finally, it's a good practice to handle any exceptions that might occur during the execution of the script. This can be done using a try-except block.

```python
try:
    # Code to check for unrestricted MSSQL server access
except Exception as e:
    print(f"An error occurred: {e}")
```

Please replace 'client_id', 'secret', 'tenant', 'subscription_id', and 'organization_id' with your actual credentials.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the unrestricted MSSQL Server Access misconfiguration in AZURE, please follow the below steps:

1. Open the Azure Portal and login with your credentials.

2. Navigate to the Azure SQL Server that you want to remediate.

3. Click on "Firewalls and virtual networks" under the "Security" section in the left-hand menu.

4. Ensure that the "Allow Azure services and resources to access this server" option is turned off.

5. Under the "Firewall rules" section, click on "Add client IP".

6. Enter the IP address of the client that needs to access the SQL server.

7. Click on "Save" to apply the changes.

8. Repeat steps 5-7 for all the clients that require access to the SQL server.

9. Once you have added all the required client IP addresses, turn on the "Allow Azure services and resources to access this server" option.

10. Click on "Save" to apply the changes.

With these steps, you have now remediated the unrestricted MSSQL Server Access misconfiguration in AZURE.

#### Using CLI

To remediate unrestricted MSSQL Server access in Azure using Azure CLI, you can follow the below steps:

Step 1: Login to Azure CLI
```
az login
```

Step 2: Get the resource group name and MSSQL server name where the misconfiguration is present
```
az sql server list --query '[].{ResourceGroup:resourceGroup, ServerName:name}'
```

Step 3: Set the resource group and server name variables
```
$resourceGroup = "<resource-group-name>"
$serverName = "<mssql-server-name>"
```

Step 4: Get the firewall rules for the MSSQL server
```
az sql server firewall-rule list --resource-group $resourceGroup --server $serverName
```

Step 5: Identify the unrestricted firewall rule that allows all IP addresses to access the MSSQL server

Step 6: Delete the unrestricted firewall rule
```
az sql server firewall-rule delete --resource-group $resourceGroup --server $serverName --name <firewall-rule-name>
```

Step 7: Create a new firewall rule that allows only specific IP addresses to access the MSSQL server
```
az sql server firewall-rule create --resource-group $resourceGroup --server $serverName --name <firewall-rule-name> --start-ip-address <start-ip-address> --end-ip-address <end-ip-address>
```

Note: Replace the placeholders `<resource-group-name>`, `<mssql-server-name>`, `<firewall-rule-name>`, `<start-ip-address>` and `<end-ip-address>` with the actual values.

#### Using Python

To remediate the unrestricted MSSQL Server Access misconfiguration in AZURE using python, follow the below steps:

Step 1: Import the required libraries
```python
import os
from azure.identity import DefaultAzureCredential
from azure.mgmt.sql import SqlManagementClient
```

Step 2: Set the credentials and subscription ID
```python
credential = DefaultAzureCredential()
subscription_id = 'your_subscription_id'
```

Step 3: Create the SQL Management client
```python
sql_client = SqlManagementClient(credential, subscription_id)
```

Step 4: Get the list of MSSQL servers in the subscription
```python
servers = sql_client.servers.list()
```

Step 5: For each server, check if the firewall rules allow unrestricted access and remove them
```python
for server in servers:
    firewall_rules = sql_client.firewall_rules.list_by_server(resource_group_name=server.resource_group, server_name=server.name)
    for rule in firewall_rules:
        if rule.start_ip_address == '0.0.0.0' and rule.end_ip_address == '255.255.255.255':
            sql_client.firewall_rules.delete(resource_group_name=server.resource_group, server_name=server.name, firewall_rule_name=rule.name)
```

Step 6: Run the python script to remediate the unrestricted MSSQL Server Access misconfiguration in AZURE.

Note: The above code will remove all the firewall rules that allow unrestricted access to the MSSQL server. It is recommended to review the firewall rules before removing them to ensure that no legitimate access is blocked.




</Tab>
</Tabs>