---
slug: azure_audit_networksecurity_security_group_unrestricted_dns_access
title: Unrestricted DNS Access
sidebar_label: Unrestricted DNS Access
---

### More Info:

Ensure that no network security groups allow unrestricted inbound access on TCP and UDP port 53

### Risk Level

High

### Address

Security

### Compliance Standards

HIPAA, HITRUST, GDPR, SOC2, NISTCSF, PCIDSS, FedRAMP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal.
2. Navigate to the "Virtual Networks" section. Here, you will see a list of all the virtual networks in your Azure environment.
3. Select the virtual network you want to check for unrestricted DNS access. In the settings pane on the left, click on "DNS servers".
4. Check the configuration of the DNS servers. If the DNS servers are set to "Default (Azure-provided)", it means that the DNS access is not unrestricted. If it is set to "Custom", check the IP addresses of the DNS servers. If any of these IP addresses are public, it means that the DNS access is unrestricted.

#### Using CLI

1. Install and configure Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine and sign in to your Azure account. You can install Azure CLI by following the instructions on the official Azure CLI documentation. Once installed, you can sign in to your Azure account using the following command:

   ```
   az login
   ```
   This command will open a new browser window for you to sign in to your Azure account. If the automatic sign-in process fails, you can manually sign in by copying the code provided and pasting it in the Azure sign-in page.

2. List all network security groups: The next step is to list all the network security groups in your Azure account. You can do this using the following command:

   ```
   az network nsg list --output table
   ```
   This command will display a table that lists all the network security groups in your Azure account.

3. Check the security rules for each network security group: For each network security group, you need to check the security rules to see if there are any rules that allow unrestricted DNS access. You can do this using the following command:

   ```
   az network nsg rule list --nsg-name <nsg-name> --resource-group <resource-group-name> --output table
   ```
   Replace `<nsg-name>` with the name of the network security group and `<resource-group-name>` with the name of the resource group that the network security group belongs to. This command will display a table that lists all the security rules for the specified network security group.

4. Look for rules that allow unrestricted DNS access: In the table of security rules, look for any rules that have 'DestinationPortRange' set to '53' and 'Access' set to 'Allow'. This indicates that the rule allows unrestricted DNS access. If you find any such rules, it means that there is a misconfiguration.

#### Using Python

Detecting unrestricted DNS access in a network involves checking if the security groups in your cloud environment are allowing unrestricted (0.0.0.0/0) access to port 53, which is used for DNS. Here's how you can do it in AWS, Azure, and GCP using Python scripts:

1. AWS:
   - Use the Boto3 library in Python to interact with AWS resources.
   - Use the `describe_security_groups()` function to get a list of all security groups.
   - Iterate over the security groups and their rules, checking if any rule allows unrestricted access to port 53.
   - Python script example:
     ```python
     import boto3
     ec2 = boto3.resource('ec2')
     for security_group in ec2.security_groups.all():
         for permission in security_group.ip_permissions:
             if permission['FromPort'] == 53 and permission['IpRanges'] == [{'CidrIp': '0.0.0.0/0'}]:
                 print(f"Unrestricted DNS access detected in security group {security_group.id}")
     ```

2. Azure:
   - Use the Azure SDK for Python to interact with Azure resources.
   - Use the `network_client.security_groups.list_all()` function to get a list of all network security groups.
   - Iterate over the security groups and their rules, checking if any rule allows unrestricted access to port 53.
   - Python script example:
     ```python
     from azure.mgmt.network import NetworkManagementClient
     from azure.identity import DefaultAzureCredential
     credential = DefaultAzureCredential()
     subscription_id = 'your-subscription-id'
     network_client = NetworkManagementClient(credential, subscription_id)
     for security_group in network_client.network_security_groups.list_all():
         for rule in security_group.security_rules:
             if rule.destination_port_range == '53' and rule.source_address_prefix == '*':
                 print(f"Unrestricted DNS access detected in security group {security_group.name}")
     ```

3. GCP:
   - Use the google-cloud-sdk library in Python to interact with GCP resources.
   - Use the `compute.firewalls().list()` function to get a list of all firewall rules.
   - Iterate over the firewall rules, checking if any rule allows unrestricted access to port 53.
   - Python script example:
     ```python
     from googleapiclient import discovery
     compute = discovery.build('compute', 'v1')
     project = 'your-project-id'
     for firewall in compute.firewalls().list(project=project).execute()['items']:
         for rule in firewall['allowed']:
             if 'ports' in rule and '53' in rule['ports'] and firewall['sourceRanges'] == ['0.0.0.0/0']:
                 print(f"Unrestricted DNS access detected in firewall rule {firewall['name']}")
     ```
Please replace 'your-subscription-id' and 'your-project-id' with your actual Azure subscription ID and GCP project ID respectively.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the unrestricted DNS access issue in Azure, please follow the below steps:

Step 1: Login to the Azure portal (https://portal.azure.com/) using your credentials.

Step 2: In the left-hand side menu, click on the "Networking" option.

Step 3: Under the "Networking" menu, click on the "DNS zones" option.

Step 4: Select the DNS zone that you want to restrict access to.

Step 5: Under the "Settings" menu, click on the "Access control (IAM)" option.

Step 6: Click on the "Add" button to add a new role assignment.

Step 7: In the "Add role assignment" window, select the "Contributor" role from the "Role" dropdown menu.

Step 8: In the "Assign access to" section, select "User, group, or service principal" from the dropdown menu.

Step 9: In the "Select" field, enter the name of the user, group, or service principal that you want to restrict access to.

Step 10: Click on the "Save" button to save the changes.

By following the above steps, you can restrict access to the DNS zone and remediate the unrestricted DNS access issue in Azure.

#### Using CLI

To remediate Unrestricted DNS Access in AZURE using AZURE CLI, follow these steps:

1. Open the AZURE CLI and login to your AZURE account.
2. Run the following command to list all the virtual networks in your subscription:
   ```
   az network vnet list
   ```
3. Identify the virtual network that has unrestricted DNS access.
4. Run the following command to update the virtual network and restrict DNS access:
   ```
   az network vnet update --name <virtual_network_name> --resource-group <resource_group_name> --dns-servers ""
   ```
   Replace `<virtual_network_name>` with the name of the virtual network that has unrestricted DNS access and `<resource_group_name>` with the name of the resource group that contains the virtual network.
5. After running the command, verify that the DNS servers are restricted by running the following command:
   ```
   az network vnet show --name <virtual_network_name> --resource-group <resource_group_name> --query 'dnsServers'
   ```
   This command should return an empty array, which means that DNS access is restricted.

By following these steps, you can remediate Unrestricted DNS Access in AZURE using AZURE CLI.

#### Using Python

To remediate unrestricted DNS access in Azure using Python, you can use the Azure SDK for Python. Here are the steps:

1. Install the Azure SDK for Python using pip:

```
pip install azure-mgmt-dns
```

2. Import the necessary modules:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.dns import DnsManagementClient
```

3. Authenticate using Service Principal credentials:

```python
credentials = ServicePrincipalCredentials(
    client_id='<client-id>',
    secret='<client-secret>',
    tenant='<tenant-id>'
)
```

Replace the `<client-id>`, `<client-secret>`, and `<tenant-id>` with your own values.

4. Create a DNS management client:

```python
dns_client = DnsManagementClient(credentials, '<subscription-id>')
```

Replace `<subscription-id>` with your own subscription ID.

5. Get the DNS zone that needs to be remediated:

```python
zone_name = '<zone-name>'
resource_group_name = '<resource-group-name>'
zone = dns_client.zones.get(resource_group_name, zone_name)
```

Replace `<zone-name>` and `<resource-group-name>` with your own values.

6. Remove any records that allow unrestricted access:

```python
for record in zone.records:
    if record.a_records:
        for a_record in record.a_records:
            if a_record.ipv4_address == '0.0.0.0':
                zone.records.remove(record)
    if record.aaaa_records:
        for aaaa_record in record.aaaa_records:
            if aaaa_record.ipv6_address == '::':
                zone.records.remove(record)
```

This code loops through all the records in the zone and removes any A or AAAA records that allow unrestricted access.

7. Update the DNS zone:

```python
dns_client.zones.create_or_update(resource_group_name, zone_name, zone)
```

This code updates the DNS zone with the changes made in step 6.

That's it! This code should remediate unrestricted DNS access in Azure using Python.




</Tab>
</Tabs>