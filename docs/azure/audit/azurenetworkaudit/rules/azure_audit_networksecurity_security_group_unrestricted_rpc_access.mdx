---
slug: azure_audit_networksecurity_security_group_unrestricted_rpc_access
title: Unrestricted RPC Access
sidebar_label: Unrestricted RPC Access
---

### More Info:

Ensure that Microsoft Azure network security groups (NSGs) do not allow unrestricted access (i.e. 0.0.0.0/0) on TCP port 135 in order to implement the principle of least privilege and effectively reduce the attack surface. Remote Procedure Call (RPC) TCP port 135 is used for client-server communications by Microsoft Message Queuing (MSMQ) as well as other Microsoft Windows/Windows Server software.

### Risk Level

High

### Address

Security

### Compliance Standards

SOC2, GDPR, ISO27001, HIPAA, HITRUST, NISTCSF, PCIDSS, FedRAMP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Azure Portal: Open your web browser and navigate to the Azure portal. Sign in with your Azure account credentials.

2. Navigate to Network Security Groups: From the left-hand menu, click on "All Services". In the search box, type "Network Security Groups" and select it from the dropdown list.

3. Check Inbound Security Rules: Select the Network Security Group (NSG) you want to check. In the NSG blade, click on "Inbound security rules". Here, you can see all the inbound rules that are applied to the resources associated with this NSG.

4. Check for Unrestricted RPC Access: Look for any rules that allow inbound traffic to port 135 (the port used by RPC). If there are any rules that allow traffic from any source (0.0.0.0/0) to port 135, this indicates unrestricted RPC access, which is a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to have the Azure CLI installed on your system. You can download and install it from the official Azure website.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your username and password.
   ```
   az login
   ```
3. List Network Security Groups: Use the following command to list all the Network Security Groups (NSGs) in your Azure account. NSGs contain the rules that allow or deny traffic to your resources.
   ```
   az network nsg list --output table
   ```
4. Check NSG Rules: For each NSG, check the rules to see if there is unrestricted RPC access. Use the following command to list the rules for a specific NSG. Replace `<nsg-name>` with the name of your NSG.
   ```
   az network nsg rule list --nsg-name <nsg-name> --output table
   ```
   Look for rules that allow inbound traffic from any source to port 135 (the port used by RPC). If such a rule exists, then you have unrestricted RPC access.

#### Using Python

1. AWS:
   - Install and configure AWS CLI and Boto3 Python library.
   - Use the following Python script to detect unrestricted RPC access:

```python
import boto3
ec2 = boto3.resource('ec2')
sgs = ec2.security_groups.all()
for sg in sgs:
    for rule in sg.ip_permissions:
        for ip_range in rule['IpRanges']:
            if ip_range['CidrIp'] == '0.0.0.0/0' and rule['FromPort'] <= 135 and rule['ToPort'] >= 135:
                print("Security Group {} has unrestricted RPC access".format(sg.id))
```

2. Azure:
   - Install and configure Azure CLI and Azure SDK for Python.
   - Use the following Python script to detect unrestricted RPC access:

```python
from azure.mgmt.network import NetworkManagementClient
from azure.identity import DefaultAzureCredential

credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'
network_client = NetworkManagementClient(credential, subscription_id)

for sg in network_client.network_security_groups.list_all():
    for rule in sg.security_rules:
        if rule.destination_port_range == '135' and rule.source_address_prefix == '*':
            print("Network Security Group {} has unrestricted RPC access".format(sg.id))
```

3. GCP:
   - Install and configure Google Cloud SDK and Google Cloud Client Library for Python.
   - Use the following Python script to detect unrestricted RPC access:

```python
from google.cloud import compute_v1

def list_firewalls(project_id):
    client = compute_v1.FirewallsClient()
    firewalls = client.list(project=project_id)
    for firewall in firewalls:
        for allowed in firewall.allowed:
            if '135' in allowed.ports and '0.0.0.0/0' in firewall.source_ranges:
                print("Firewall {} has unrestricted RPC access".format(firewall.id))

list_firewalls('your-project-id')
```

Remember to replace 'your-subscription-id' and 'your-project-id' with your actual Azure subscription ID and GCP project ID respectively.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Unrestricted RPC Access" misconfiguration in Azure using the Azure Console, you can follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/).

2. Navigate to the virtual machine that has the misconfiguration.

3. Click on the "Networking" tab in the left-hand menu.

4. Under "Inbound port rules", click on "Add inbound port rule".

5. In the "Add inbound security rule" dialog box, fill in the following information:

- Name: A unique name for the rule (e.g., "RPC Access Restricted").
- Priority: A number that determines the order in which the rule is applied (e.g., 100).
- Protocol: Select "TCP".
- Port range: Enter "135-139, 445".
- Action: Select "Deny".
- Source: Select "Any".

6. Click "Add" to create the new rule.

7. Repeat steps 4-6 for any other virtual machines that have the same misconfiguration.

By following these steps, you will have restricted RPC access to the virtual machine, which will help mitigate the risk of unauthorized access.

#### Using CLI

To remediate unrestricted RPC access in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI command prompt.

2. Run the following command to get a list of all virtual machines in your Azure subscription:

   `az vm list --query "[].{Name:name, ResourceGroup:resourceGroup}"`

   This will give you a list of all the virtual machines in your subscription along with their resource group names.

3. Identify the virtual machine that has unrestricted RPC access.

4. Run the following command to get the public IP address of the virtual machine:

   `az vm show -d -g <resource-group-name> -n <vm-name> --query publicIps -o tsv`

   Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located and `<vm-name>` with the name of the virtual machine.

5. Note down the public IP address of the virtual machine.

6. Run the following command to create a network security group:

   `az network nsg create -g <resource-group-name> -n <nsg-name>`

   Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located and `<nsg-name>` with a name for the network security group.

7. Run the following command to create a rule in the network security group to block all incoming traffic on port 135:

   `az network nsg rule create -g <resource-group-name> --nsg-name <nsg-name> -n block-rpc --priority 100 --source-address-prefixes '*' --destination-port-ranges 135 --access Deny --protocol Tcp --description "Block all incoming traffic on port 135"`

   Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located and `<nsg-name>` with the name of the network security group that you created in step 6.

8. Run the following command to associate the network security group with the virtual machine's network interface:

   `az network nic update -g <resource-group-name> -n <nic-name> --network-security-group <nsg-name>`

   Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located, `<nic-name>` with the name of the virtual machine's network interface, and `<nsg-name>` with the name of the network security group that you created in step 6.

9. Verify that the network security group is associated with the virtual machine's network interface by running the following command:

   `az network nic show -g <resource-group-name> -n <nic-name> --query networkSecurityGroup`

   Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located and `<nic-name>` with the name of the virtual machine's network interface.

10. Verify that the rule to block incoming traffic on port 135 is applied by running the following command:

    `az network nsg rule show -g <resource-group-name> --nsg-name <nsg-name> -n block-rpc`

    Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located and `<nsg-name>` with the name of the network security group that you created in step 6.

By following these steps, you have remediated unrestricted RPC access in Azure using Azure CLI.

#### Using Python

To remediate the Unrestricted RPC Access misconfiguration in AZURE using Python, you can follow the below steps:

1. Import the required Python libraries:
   ```
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.network import NetworkManagementClient
   from azure.mgmt.network.models import SecurityRule, SecurityGroup
   ```

2. Authenticate with the Azure cloud using the `DefaultAzureCredential` class:
   ```
   credential = DefaultAzureCredential()
   ```

3. Instantiate a `NetworkManagementClient` object using the `credential` object:
   ```
   network_client = NetworkManagementClient(credential, subscription_id)
   ```

4. Get the `SecurityGroup` object that contains the rule you want to remediate:
   ```
   security_group = network_client.security_groups.get(resource_group_name, security_group_name)
   ```

5. Get the `SecurityRule` object that contains the unrestricted RPC access:
   ```
   rpc_rule = next((rule for rule in security_group.security_rules if rule.name == 'Allow-RPC-Inbound'), None)
   ```

6. Update the `SecurityRule` object to restrict the RPC access:
   ```
   rpc_rule.access = 'Deny'
   rpc_rule.direction = 'Inbound'
   rpc_rule.protocol = 'TCP'
   rpc_rule.source_address_prefix = '*'
   rpc_rule.destination_address_prefix = '*'
   rpc_rule.destination_port_range = '135-139'
   ```

7. Update the `SecurityGroup` object in Azure with the new `SecurityRule` object:
   ```
   network_client.security_rules.create_or_update(resource_group_name, security_group_name, rpc_rule.name, rpc_rule)
   ```

With these steps, you can remediate the Unrestricted RPC Access misconfiguration in AZURE using Python.




</Tab>
</Tabs>