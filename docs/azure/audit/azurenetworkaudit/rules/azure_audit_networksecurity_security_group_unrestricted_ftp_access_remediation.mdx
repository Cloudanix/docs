

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal.
2. Navigate to the "Security Center" from the left-hand side menu.
3. In the Security Center, go to the "Networking" section. Here, you can see all the networking resources and their configurations.
4. Check the "Adaptive Network Hardening" recommendations. If there is unrestricted FTP access to port 20, it will be listed here. You can also check the "Effective Network Security Rules" for the specific resource to see if port 20 is open to the internet.

#### Using CLI

1. Install and configure Azure CLI: Before you can run any commands, you need to install the Azure CLI on your local machine and authenticate it with your Azure account. You can do this by running the following command and following the prompts:

   ```
   az login
   ```

2. List all Network Security Groups (NSGs): NSGs contain the rules that determine whether to allow or deny network traffic to resources connected to Azure networks. To list all NSGs in your Azure account, run the following command:

   ```
   az network nsg list --output table
   ```

3. Check the rules for each NSG: For each NSG, you need to check the rules to see if any of them allow unrestricted FTP access to port 20. You can do this by running the following command for each NSG:

   ```
   az network nsg rule list --nsg-name <NSG Name> --resource-group <Resource Group Name> --output table
   ```

4. Look for rules that allow unrestricted FTP access to port 20: In the output of the previous command, look for rules that have 'Destination Port Ranges' set to '20', 'Source Address Prefix' set to '*', and 'Access' set to 'Allow'. This indicates that the rule allows unrestricted FTP access to port 20.

#### Using Python

1. Import Necessary Libraries: The first step is to import the necessary libraries in your Python script. You will need the 'socket' library to create a socket object and connect to the server, and 'os' library to interact with the operating system.

```python
import socket
import os
```

2. Define the Target: Next, you need to define the target IP address and the port number. In this case, the port number is 20, which is the default port for FTP data transfer.

```python
target_ip = "your_target_ip"
port = 20
```

3. Create a Socket and Connect: Now, create a socket object and try to connect to the target IP address on port 20. If the connection is successful, it means that the port is open.

```python
try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((target_ip, port))
    print(f"Port {port} is open on {target_ip}")
except:
    print(f"Port {port} is not open on {target_ip}")
```

4. Check for FTP Access: If the port is open, you can then check for unrestricted FTP access. You can do this by sending an FTP command to the server and checking the response. If the server responds with a status code of 200, it means that FTP access is unrestricted.

```python
try:
    sock.send(b'USER anonymous\r\n')
    response = sock.recv(1024)
    if b'200' in response:
        print(f"Unrestricted FTP access on port {port} of {target_ip}")
    else:
        print(f"No unrestricted FTP access on port {port} of {target_ip}")
except:
    print("Error in sending FTP command")
```

Remember to replace "your_target_ip" with the actual IP address of the server you want to check. Also, this script only checks for unrestricted FTP access on port 20. If the server uses a different port for FTP, you will need to modify the script accordingly.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate unrestricted FTP access to Port 20 in Azure, follow these steps:

1. Open the Azure portal and navigate to the Virtual Machine (VM) that has unrestricted FTP access to Port 20.

2. Stop the VM by clicking on the "Stop" button at the top of the VM's overview page.

3. Once the VM is stopped, click on the "Networking" tab in the left-hand menu.

4. Click on the "Add inbound port rule" button.

5. In the "Add inbound security rule" dialog, configure the following settings:

- Name: A descriptive name for the new rule.
- Priority: A number that determines the order in which rules are evaluated (lower numbers are evaluated first).
- Source: The IP address range or subnet that should be allowed to access Port 20. If you want to restrict access to a specific IP address, enter that IP address in the "Source IP addresses/CIDR ranges" field.
- Destination port ranges: Enter "20" to restrict access to Port 20.
- Protocol: Select "TCP" from the dropdown menu.
- Action: Select "Allow" from the dropdown menu.

6. Click on the "Add" button to create the new inbound security rule.

7. Start the VM by clicking on the "Start" button at the top of the VM's overview page.

By following these steps, you have remediated the unrestricted FTP access to Port 20 in Azure by restricting access to only the IP address range or subnet that should be allowed to access Port 20.

#### Using CLI

To remediate the unrestricted FTP access to port 20 misconfiguration in Azure using Azure CLI, you can follow the following steps:

1. Open the Azure CLI and login to your Azure account using the command `az login`.

2. Once you are logged in, run the following command to get the list of all the virtual machines in your Azure subscription:
   ```
   az vm list --query "[].{name:name, resourceGroup:resourceGroup}"
   ```

3. Identify the virtual machine that has unrestricted FTP access to port 20 and note down its name and resource group.

4. Run the following command to open port 20 for FTP traffic on the identified virtual machine:
   ```
   az vm open-port --port 20 --resource-group <resource-group-name> --name <vm-name> --priority 1001
   ```

   Note: Replace `<resource-group-name>` and `<vm-name>` with the actual names of the resource group and virtual machine that you have identified.

5. Verify that the port 20 is now open for FTP traffic on the virtual machine by running the following command:
   ```
   az vm show --resource-group <resource-group-name> --name <vm-name> --query "networkProfile.networkInterfaces[].ipConfigurations[].openPorts"
   ```

   This command should return the list of all the open ports on the virtual machine, including port 20 for FTP traffic.

6. Repeat the above steps for all the virtual machines in your Azure subscription that have unrestricted FTP access to port 20.

By following the above steps, you can remediate the unrestricted FTP access to port 20 misconfiguration in Azure using Azure CLI.

#### Using Python

To remediate the unrestricted FTP access to port 20 in Azure using Python, you can follow the below steps:

1. Identify the Azure virtual machine(s) that have unrestricted FTP access to port 20.
2. Use the Python SDK for Azure to create a network security group (NSG) for the virtual machine(s) that allows FTP access only from a specific IP address or range.
3. Associate the NSG with the virtual machine(s) that have unrestricted FTP access to port 20.
4. Verify that the NSG is working as expected by testing FTP access from a different IP address.

Here is an example Python code to create a network security group and associate it with a virtual machine in Azure:

```python
from azure.mgmt.network import NetworkManagementClient
from azure.common.credentials import ServicePrincipalCredentials

# Set your Azure subscription ID, client ID, secret, and tenant ID
subscription_id = 'your_subscription_id'
client_id = 'your_client_id'
secret = 'your_secret'
tenant = 'your_tenant_id'

# Set the resource group and virtual machine name
resource_group_name = 'your_resource_group_name'
vm_name = 'your_virtual_machine_name'

# Set the IP address or range that is allowed to access FTP
ftp_ip_address = 'your_ftp_ip_address'

# Authenticate with Azure using a service principal
credentials = ServicePrincipalCredentials(
    client_id=client_id,
    secret=secret,
    tenant=tenant
)

# Create a network security group
network_client = NetworkManagementClient(credentials, subscription_id)
nsg_params = {
    'location': 'your_location',
    'security_rules': [
        {
            'name': 'FTP',
            'protocol': 'Tcp',
            'source_port_range': '*',
            'destination_port_range': '20',
            'source_address_prefix': ftp_ip_address,
            'destination_address_prefix': '*',
            'access': 'Allow',
            'priority': 100,
            'direction': 'Inbound'
        }
    ]
}
nsg = network_client.network_security_groups.create_or_update(
    resource_group_name,
    'FTP-NSG',
    nsg_params
)

# Associate the network security group with the virtual machine
vm = network_client.virtual_machines.get(
    resource_group_name,
    vm_name
)
vm.network_profile.network_interfaces[0].network_security_group = nsg
network_client.virtual_machines.create_or_update(
    resource_group_name,
    vm_name,
    vm
)
```

This code creates a network security group that allows FTP access only from the specified IP address or range, and associates it with the virtual machine. You can customize the code to meet your specific requirements.


</Tab>
</Tabs>