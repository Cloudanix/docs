

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to Network Security Groups: From the left-hand menu, select "All services". In the "All services" box, type "Network Security Groups". Select it from the dropdown menu.

3. Check the inbound security rules: Select the Network Security Group (NSG) you want to check. In the NSG window, select "Inbound security rules" from the left-hand menu. This will display a list of all inbound security rules associated with the selected NSG.

4. Check for unrestricted SSH access: Look for any rules that have "Any" in the "Source" column and "22" (the port number for SSH) in the "Destination port ranges" column. If such a rule exists and its "Action" is set to "Allow", then unrestricted SSH access is enabled.

#### Using CLI

1. Install and configure Azure CLI: Before you can use Azure CLI to detect misconfigurations, you need to install it on your local machine. Once installed, you can log in to your Azure account using the command `az login`. This will open a new browser window for you to enter your Azure credentials.

2. List all Network Security Groups (NSGs): NSGs contain the rules that allow or deny traffic to resources in a Virtual Network. To list all NSGs in your Azure account, use the command `az network nsg list --output table`. This will display a table with all NSGs and their details.

3. Check NSG rules: For each NSG, you can check its rules using the command `az network nsg rule list --nsg-name <NSG Name> --resource-group <Resource Group Name> --output table`. Replace `<NSG Name>` and `<Resource Group Name>` with the actual names of your NSG and resource group respectively. This will display a table with all rules in the specified NSG.

4. Detect unrestricted SSH access: In the table of NSG rules, look for rules with 'DestinationPortRange' set to '22' (the port for SSH) and 'Access' set to 'Allow'. If the 'SourceAddressPrefix' for such a rule is '*', this means that SSH access is allowed from any IP address, indicating a misconfiguration.

#### Using Python

1. AWS:
   - Use the boto3 library in Python to interact with AWS services. 
   - To check for unrestricted SSH access, you would need to inspect the security groups. Here is a sample script:

```python
import boto3

ec2 = boto3.resource('ec2')

def check_sg():
    for sg in ec2.security_groups.all():
        for rule in sg.ip_permissions:
            if rule['FromPort'] == 22 and rule['ToPort'] == 22:
                for ip_range in rule['IpRanges']:
                    if ip_range['CidrIp'] == '0.0.0.0/0':
                        print(f"Security Group {sg.id} has unrestricted SSH access")

check_sg()
```

2. Azure:
   - Use the azure-mgmt-network library in Python to interact with Azure Network services.
   - To check for unrestricted SSH access, you would need to inspect the network security groups. Here is a sample script:

```python
from azure.mgmt.network import NetworkManagementClient
from azure.identity import DefaultAzureCredential

credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'
network_client = NetworkManagementClient(credential, subscription_id)

def check_nsg():
    for nsg in network_client.network_security_groups.list_all():
        for rule in nsg.security_rules:
            if rule.destination_port_range == '22' and rule.source_address_prefix == '*':
                print(f"Network Security Group {nsg.id} has unrestricted SSH access")

check_nsg()
```

3. GCP:
   - Use the google-cloud-compute library in Python to interact with GCP Compute services.
   - To check for unrestricted SSH access, you would need to inspect the firewall rules. Here is a sample script:

```python
from google.cloud import compute_v1

def check_firewall():
    client = compute_v1.FirewallsClient()
    for firewall in client.list(project='your-project-id'):
        for rule in firewall.allowed:
            if '22' in rule.ports and firewall.source_ranges == ['0.0.0.0/0']:
                print(f"Firewall {firewall.name} has unrestricted SSH access")

check_firewall()
```

Remember to replace 'your-subscription-id' and 'your-project-id' with your actual Azure subscription ID and GCP project ID respectively.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate unrestricted SSH access in Azure, you can follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Navigate to the virtual machine that has unrestricted SSH access.
3. Click on the "Networking" tab in the left-hand menu.
4. Under "Inbound port rules," click on "Add inbound port rule."
5. In the "Add inbound security rule" window, enter a name for the rule (e.g., "SSH access restricted").
6. Under "Destination port ranges," enter "22" (or the port number that SSH is using).
7. Under "Source," select "IP Addresses."
8. Under "Source IP addresses," enter the IP address or range that should have access to SSH (e.g., your own IP address or a specific subnet).
9. Under "Action," select "Allow."
10. Click "Add" to create the rule.
11. Repeat steps 4-10 for any other virtual machines that have unrestricted SSH access.

By following these steps, you have now restricted SSH access to only the specified IP address or range, thereby reducing the risk of unauthorized access to your virtual machines.

#### Using CLI

The following are the steps to remediate unrestricted SSH access in AZURE using AZURE CLI:

1. Login to your Azure account using the Azure CLI command: 

   `az login`

2. Once you are logged in, select the subscription that contains the virtual machine you want to remediate by using the command:

   `az account set --subscription <subscription-id>`

3. Get the name of the virtual machine you want to remediate by using the command:

   `az vm list --query "[].{name:name}" -o table`

4. Once you have identified the virtual machine, get the resource group name by using the command:

   `az vm show --name <vm-name> --query "resourceGroup" -o tsv`

5. Next, get the network security group associated with the virtual machine by using the command:

   `az vm show --name <vm-name> --resource-group <resource-group-name> --query "networkProfile.networkInterfaces[].id" -o tsv | xargs az network nic show --ids --query "networkSecurityGroup.id" -o tsv`

6. Get the name of the network security group by using the command:

   `az network nsg list --query "[].{name:name}" -o table`

7. Once you have identified the network security group, get the name of the security rule that allows unrestricted SSH access by using the command:

   `az network nsg rule list --nsg-name <nsg-name> --query "[?access=='Allow' && protocol=='Tcp' && destinationPortRange=='22' && destinationAddressPrefix=='*'].name" -o tsv`

8. Finally, delete the security rule that allows unrestricted SSH access by using the command:

   `az network nsg rule delete --name <rule-name> --nsg-name <nsg-name>`

   Note: Replace `<subscription-id>`, `<vm-name>`, `<resource-group-name>`, `<nsg-name>`, and `<rule-name>` with the actual values from your Azure environment.

After following these steps, the security rule that allows unrestricted SSH access will be deleted from the network security group associated with the virtual machine, thereby remediating the misconfiguration.

#### Using Python

To remediate unrestricted SSH access in Azure using Python, you can follow these steps:

1. Import the necessary libraries:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.network import NetworkManagementClient
```

2. Authenticate to Azure using the DefaultAzureCredential:

```python
credential = DefaultAzureCredential()
network_client = NetworkManagementClient(
    credential=credential,
    subscription_id="<subscription-id>"
)
```

3. Get the network security group (NSG) that needs to be remediated:

```python
nsg_name = "<nsg-name>"
resource_group_name = "<resource-group-name>"

nsg = network_client.network_security_groups.get(
    resource_group_name=resource_group_name,
    network_security_group_name=nsg_name
)
```

4. Get the NSG rules and find the rule that allows unrestricted SSH access:

```python
for rule in nsg.security_rules:
    if rule.name == "AllowSSH":
        if rule.destination_address_prefix == "*":
            if rule.destination_port_range == "22":
                # this is the rule that needs to be remediated
                break
```

5. Create a new NSG rule that allows SSH access only from a specific IP range:

```python
from azure.mgmt.network.v2021_03_01.models import SecurityRule

new_rule = SecurityRule(
    name="AllowSSH",
    access=rule.access,
    direction=rule.direction,
    priority=rule.priority,
    protocol=rule.protocol,
    source_address_prefix="<ip-range>",
    source_port_range="*",
    destination_address_prefix=rule.destination_address_prefix,
    destination_port_range=rule.destination_port_range
)

network_client.security_rules.begin_create_or_update(
    resource_group_name=resource_group_name,
    network_security_group_name=nsg_name,
    security_rule_name=new_rule.name,
    security_rule_parameters=new_rule
)
```

6. Delete the old NSG rule that allows unrestricted SSH access:

```python
network_client.security_rules.begin_delete(
    resource_group_name=resource_group_name,
    network_security_group_name=nsg_name,
    security_rule_name=rule.name
)
```

7. Verify that the new NSG rule has been created and the old rule has been deleted:

```python
nsg = network_client.network_security_groups.get(
    resource_group_name=resource_group_name,
    network_security_group_name=nsg_name
)

for rule in nsg.security_rules:
    if rule.name == "AllowSSH":
        if rule.destination_address_prefix == "<ip-range>":
            if rule.destination_port_range == "22":
                # the new rule has been created successfully
                break
    else:
        # the old rule has been deleted successfully
        pass
```

This will remediate unrestricted SSH access in Azure by creating a new NSG rule that allows SSH access only from a specific IP range and deleting the old NSG rule that allows unrestricted SSH access.


</Tab>
</Tabs>