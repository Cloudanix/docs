

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal (portal.azure.com) and sign in with your Azure account credentials.

2. Navigate to Network Security Groups: From the left-hand menu, select "All services". In the "All services" search box, type "Network Security Groups". Select it from the dropdown list.

3. Check Inbound Security Rules: Once you are in the Network Security Groups, select the specific network security group you want to check. In the settings menu, click on "Inbound security rules". 

4. Check for Unrestricted RDP Access: In the Inbound security rules, look for any rule that has Destination Port Ranges as 3389 (RDP port) and Source as Any or 0.0.0.0/0. This indicates that RDP access is unrestricted, which is a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt and type `az login` to log in to your Azure account.

2. List Network Security Groups: Network Security Groups (NSGs) are used to control inbound and outbound traffic to network interfaces (NIC), VMs, and subnets. To list all NSGs in a subscription, use the following command: `az network nsg list --output table`. This will display a table with all NSGs, their resource groups, and locations.

3. Show Network Security Group Rules: To view the rules of a specific NSG, use the following command: `az network nsg rule list --nsg-name <nsg-name> --resource-group <resource-group-name> --output table`. Replace `<nsg-name>` and `<resource-group-name>` with the name of your NSG and its resource group respectively. This will display a table with all the rules of the specified NSG.

4. Check for Unrestricted RDP Access: In the table displayed from the previous step, look for rules with 'DestinationPortRange' set to '3389' (the default port for RDP) and 'Access' set to 'Allow'. If 'SourceAddressPrefix' is set to '*', this means that RDP access is unrestricted, which is a misconfiguration.

#### Using Python

1. AWS:
   - Use the boto3 library in Python to interact with AWS services. 
   - To check for unrestricted RDP access, you would need to inspect the security groups associated with your EC2 instances.
   - Here is a sample script:

```python
import boto3

ec2 = boto3.resource('ec2')

def check_security_groups():
    for security_group in ec2.security_groups.all():
        for permission in security_group.ip_permissions:
            if permission['FromPort'] == 3389 and permission['ToPort'] == 3389:
                for ip_range in permission['IpRanges']:
                    if ip_range['CidrIp'] == '0.0.0.0/0':
                        print(f"Unrestricted RDP access detected in security group: {security_group.id}")

check_security_groups()
```

2. Azure:
   - Use the azure-mgmt-network library in Python to interact with Azure Network resources.
   - To check for unrestricted RDP access, you would need to inspect the network security groups.
   - Here is a sample script:

```python
from azure.mgmt.network import NetworkManagementClient
from azure.identity import DefaultAzureCredential

credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'
network_client = NetworkManagementClient(credential, subscription_id)

def check_network_security_groups():
    for nsg in network_client.network_security_groups.list_all():
        for rule in nsg.security_rules:
            if rule.destination_port_range == '3389' and rule.source_address_prefix == '*':
                print(f"Unrestricted RDP access detected in network security group: {nsg.id}")

check_network_security_groups()
```

3. GCP:
   - Use the google-cloud-compute library in Python to interact with GCP Compute Engine resources.
   - To check for unrestricted RDP access, you would need to inspect the firewall rules.
   - Here is a sample script:

```python
from google.cloud import compute_v1

def check_firewall_rules():
    client = compute_v1.FirewallsClient()
    for firewall in client.list(project='your-project-id'):
        for rule in firewall.allowed:
            if rule.IPProtocol == 'tcp' and '3389' in rule.ports:
                for source_range in firewall.source_ranges:
                    if source_range == '0.0.0.0/0':
                        print(f"Unrestricted RDP access detected in firewall rule: {firewall.id}")

check_firewall_rules()
```

Remember to replace 'your-subscription-id' and 'your-project-id' with your actual Azure subscription ID and GCP project ID respectively.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the unrestricted RDP access issue in Azure, you can follow the below steps:

1. Login to the Azure portal (https://portal.azure.com/)
2. Select the virtual machine that has unrestricted RDP access.
3. Click on the "Networking" option from the left-hand side menu.
4. Under the "Inbound port rules" section, click on "Add inbound port rule".
5. In the "Add inbound security rule" blade, provide the following details:
   - Name: Enter a name for the rule (e.g. RDP Restricted)
   - Priority: Set a priority number for the rule (e.g. 100)
   - Source: Select "IP Addresses" and enter the IP address range that you want to allow RDP access from. If you want to allow RDP access from a specific IP address, enter that IP address.
   - Protocol: Select "TCP"
   - Destination port ranges: Enter "3389"
   - Action: Select "Allow"
   - Description: Enter a description for the rule (optional)
6. Click on "Add" to create the rule.
7. Once the rule is created, delete the existing rule that allows unrestricted RDP access.
8. To delete the existing rule, click on the rule in the "Inbound port rules" section, and then click on the "Delete" button.

By following these steps, you can remediate the unrestricted RDP access issue in Azure.

#### Using CLI

The following steps can be taken to remediate unrestricted RDP access in Azure using Azure CLI:

1. Open the Azure CLI command prompt.
2. Run the following command to get the list of virtual machines in the subscription:

```
az vm list
```

3. Identify the virtual machine(s) that have unrestricted RDP access.
4. Run the following command to restrict RDP access to a specific IP address range:

```
az vm open-port --port 3389 --resource-group <resource-group-name> --name <vm-name> --priority 1001 --source-address-prefixes <ip-address-range> --protocol tcp
```

Note: Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located, `<vm-name>` with the name of the virtual machine, and `<ip-address-range>` with the IP address range that should be allowed RDP access.

5. Verify that RDP access is now restricted to the specified IP address range by attempting to connect to the virtual machine from a different IP address.

By following these steps, you can remediate unrestricted RDP access in Azure using Azure CLI.

#### Using Python

To remediate the unrestricted RDP access issue in Azure using Python, you can use the Azure SDK for Python. Here are the steps to follow:

1. Install the Azure SDK for Python using the following command:

```
pip install azure-mgmt-compute
```

2. Authenticate with Azure using the Azure CLI or Service Principal credentials.

3. Use the following code to retrieve the virtual machine:

```
from azure.mgmt.compute import ComputeManagementClient
from azure.identity import AzureCliCredential

credential = AzureCliCredential()

subscription_id = '<your-subscription-id>'
resource_group_name = '<your-resource-group-name>'
vm_name = '<your-vm-name>'

compute_client = ComputeManagementClient(credential, subscription_id)

vm = compute_client.virtual_machines.get(resource_group_name, vm_name, expand='instanceView')
```

4. Check if the virtual machine has any inbound rules that allow RDP access:

```
rdp_rule = None
for rule in vm.network_profile.network_interfaces[0].ip_configurations[0].load_balancer_backend_address_pools[0].backend_ip_configurations[0].load_balancer_inbound_nat_rules:
    if rule.protocol == 'tcp' and rule.backend_port == 3389:
        rdp_rule = rule
        break

if rdp_rule:
    print('RDP access is allowed')
else:
    print('RDP access is not allowed')
```

5. If the virtual machine has an inbound rule that allows RDP access, remove the rule using the following code:

```
if rdp_rule:
    lb_client = NetworkManagementClient(credential, subscription_id)
    lb_name = vm.network_profile.network_interfaces[0].ip_configurations[0].load_balancer_backend_address_pools[0].load_balancer.id.split('/')[-1]
    rule_name = rdp_rule.id.split('/')[-1]
    lb_client.load_balancer_inbound_nat_rules.delete(resource_group_name, lb_name, rule_name)
    print('RDP access rule has been removed')
else:
    print('RDP access is not allowed')
```

Note: This code assumes that the virtual machine is behind a load balancer and the inbound rule that allows RDP access is a NAT rule. If your virtual machine is not behind a load balancer, you need to modify the code accordingly.


</Tab>
</Tabs>