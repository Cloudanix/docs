---
slug: azure_audit_securitycenter_monitor_agent_not_provisioned
title: Monitoring Agent is not provisioned
sidebar_label: Monitoring Agent is not provisioned
---

### More Info:

Automatic provisioning of monitoring agent should be set.

### Risk Level

Informational

### Address

Operational Maturity, Security

### Compliance Standards

CISAZURE, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to portal.azure.com and sign in with your Azure account credentials.

2. Open Security Center: On the left-hand side menu, click on "Security Center". This will open the Azure Security Center dashboard.

3. Check Recommendations: In the Security Center dashboard, click on "Recommendations". This will open a list of all the security recommendations for your Azure resources.

4. Check for Monitoring Agent: Look for a recommendation titled "Provision the Monitoring Agent to enable Security Center to collect security data". If this recommendation is present, it means that the Monitoring Agent is not provisioned in Security Center.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. After installation, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your Azure account credentials.
   ```
   az login
   ```
3. Select Subscription: If you have multiple subscriptions, select the subscription where you want to check the monitoring agent. Use the following command to set the subscription.
   ```
   az account set --subscription "your-subscription-id"
   ```
4. Check Monitoring Agent: Use the following command to list all the resources and check if the monitoring agent is provisioned in the security center. If the output doesn't show the monitoring agent, it means it's not provisioned.
   ```
   az security auto-provisioning-setting list
   ```
   In the output, look for the "autoProvision" field. If it's set to "Off", it means the Monitoring Agent is not provisioned.

#### Using Python

To check if the Monitoring Agent is not provisioned in Security Center using Python scripts, you can follow these steps:

1. **Setup Azure SDK for Python**: First, you need to install the Azure SDK for Python. You can do this by running the command `pip install azure-mgmt-security` in your terminal. This will install the necessary libraries to interact with Azure Security Center.

2. **Authenticate with Azure**: Before you can interact with Azure, you need to authenticate. You can do this by creating a service principal and assigning it the necessary permissions. Here is a sample code snippet:

    ```python
    from azure.common.credentials import ServicePrincipalCredentials

    subscription_id = 'your-subscription-id'
    credentials = ServicePrincipalCredentials(
        client_id='your-app-id',
        secret='your-app-secret',
        tenant='your-tenant-id'
    )
    ```

3. **Create Security Center client**: Once you have authenticated, you can create a Security Center client. This client will allow you to interact with the Security Center. Here is a sample code snippet:

    ```python
    from azure.mgmt.security import SecurityCenter

    sc = SecurityCenter(credentials, subscription_id)
    ```

4. **Check for Monitoring Agent**: Now that you have a Security Center client, you can use it to check if the Monitoring Agent is provisioned. Here is a sample code snippet:

    ```python
    from azure.mgmt.security.models import AutoProvisioningSetting

    aps = sc.auto_provisioning_settings.get('default')
    if aps.auto_provision != AutoProvisioningSetting.on:
        print('Monitoring Agent is not provisioned')
    else:
        print('Monitoring Agent is provisioned')
    ```

This script will print 'Monitoring Agent is not provisioned' if the Monitoring Agent is not provisioned, and 'Monitoring Agent is provisioned' otherwise.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of Monitoring Agent not being provisioned in Azure, follow these steps:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Navigate to the virtual machine (VM) that needs to be remediated.
3. Click on the "Extensions" tab in the left-hand menu.
4. Click on the "Add" button to add a new extension.
5. In the "Add extension" blade, select the "Microsoft Monitoring Agent" extension.
6. Click on the "Create" button to create the extension.
7. In the "Monitoring Agent" blade, configure the following settings:
   - Workspace ID: Enter the ID of the Log Analytics workspace where you want to send the VM's monitoring data.
   - Workspace Key: Enter the key for the Log Analytics workspace.
   - Azure Environment: Select the Azure environment where the VM is located (e.g., AzureGlobalCloud).
8. Click on the "OK" button to save the settings.
9. Wait for the extension to be installed and configured on the VM. This may take several minutes.
10. Once the extension is installed and configured, verify that the Monitoring Agent is running on the VM by checking the status of the "Microsoft Monitoring Agent" service in the Windows Services console.

By following these steps, you should be able to remediate the issue of Monitoring Agent not being provisioned in Azure and ensure that your VMs are properly monitored.

#### Using CLI

To remediate the misconfiguration of Monitoring Agent not being provisioned in Azure using Azure CLI, you can follow the below steps:

Step 1: Install the Azure CLI on your local machine if you haven't already.

Step 2: Login to your Azure account using the Azure CLI command `az login`.

Step 3: Check if the Azure VM has the Microsoft Monitoring Agent installed using the Azure CLI command `az vm extension list --resource-group <resource-group-name> --vm-name <vm-name> --query "[].{Name:name, ProvisioningState:provisioningState}" --output table`. If the ProvisioningState is not 'Succeeded' for the Microsoft Monitoring Agent, then it is not provisioned.

Step 4: To remediate this, you can install the Microsoft Monitoring Agent on the Azure VM using the Azure CLI command `az vm extension set --resource-group <resource-group-name> --vm-name <vm-name> --name MicrosoftMonitoringAgent --publisher Microsoft.Azure.Monitoring.AzureMonitoringAgent --version 1.0 --protected-settings '{"workspaceKey": "<workspace-key>"}' --settings '{"workspaceId": "<workspace-id>"}'`.

Note: Replace `<resource-group-name>`, `<vm-name>`, `<workspace-key>` and `<workspace-id>` with the appropriate values for your environment.

Step 5: After executing the above command, wait for a few minutes for the extension installation to complete. You can check the status of the extension installation using the Azure CLI command `az vm extension list --resource-group <resource-group-name> --vm-name <vm-name> --query "[].{Name:name, ProvisioningState:provisioningState}" --output table`. Once the ProvisioningState is 'Succeeded', the Microsoft Monitoring Agent is provisioned.

Step 6: You can now monitor the Azure VM using Azure Monitor.

These steps should help you remediate the misconfiguration of Monitoring Agent not being provisioned in Azure using Azure CLI.

#### Using Python

To remediate the "Monitoring Agent is not provisioned" misconfiguration in Azure using Python, you can use the Azure Python SDK. Here are the steps to remediate the issue:

1. Install the Azure Python SDK using pip:

```
pip install azure-mgmt-monitor
```

2. Import the necessary modules:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.monitor import MonitorManagementClient
```

3. Create a Service Principal and retrieve the credentials:

```python
TENANT_ID = '<your tenant id>'
CLIENT_ID = '<your client id>'
SECRET = '<your client secret>'
SUBSCRIPTION_ID = '<your subscription id>'

credentials = ServicePrincipalCredentials(client_id=CLIENT_ID, secret=SECRET, tenant=TENANT_ID)
```

4. Create a MonitorManagementClient object:

```python
monitor_client = MonitorManagementClient(credentials, SUBSCRIPTION_ID)
```

5. Check if the Monitoring Agent is provisioned:

```python
monitoring_status = monitor_client.activity_logs.list(filter="category eq 'Administrative' and operationName.value eq 'Microsoft.Compute/virtualMachines/extensions/write' and resourceType eq 'Microsoft.Compute/virtualMachines/extensions' and status.value eq 'Succeeded'")
if len(list(monitoring_status)) == 0:
    print("Monitoring Agent is not provisioned")
else:
    print("Monitoring Agent is provisioned")
```

6. If the Monitoring Agent is not provisioned, you can remediate the issue by installing the agent extension:

```python
vm_name = '<your virtual machine name>'
resource_group_name = '<your resource group name>'
extension_name = 'MicrosoftMonitoringAgent'

monitor_client.virtual_machine_extensions.create_or_update(
    resource_group_name,
    vm_name,
    extension_name,
    {
        'location': '<your location>',
        'publisher': 'Microsoft.EnterpriseCloud.Monitoring',
        'virtual_machine_extension_type': extension_name,
        'type_handler_version': '1.0',
        'auto_upgrade_minor_version': True,
        'settings': {},
        'protected_settings': {
            'workspaceId': '<your workspace id>',
            'workspaceKey': '<your workspace key>'
        }
    }
)
```

Note: Replace the placeholders with your own values.




</Tab>
</Tabs>