

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal and sign in with your Azure account credentials.

2. Navigate to Security Center: Once you are logged in, locate the "Security Center" in the left-hand menu. Click on it to open the Azure Security Center dashboard.

3. Check Policy & Compliance: In the Security Center dashboard, click on the "Policy & Compliance" option in the sidebar. This will open a new page where you can see all the policy assignments and their status.

4. Check Not Allowed Resource Types Policy: In the Policy & Compliance page, look for the "Not Allowed Resource Types" policy. Check if it is in use. If it is in use, it means that there are resources that are not allowed by the policy. If it is not in use, it means that all resources are allowed by the policy.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI, you need to install it on your local machine. You can download it from the official Microsoft website and follow the installation instructions.

2. Login to Azure: After installing Azure CLI, you need to login to your Azure account. Open your command prompt and type the following command:
   ```
   az login
   ```
   This command will open a new window in your web browser asking you to sign in to your Azure account. After signing in, the command prompt will display a JSON output containing information about your subscriptions.

3. Check the current policy assignments: To check the current policy assignments, you can use the following command:
   ```
   az policy assignment list
   ```
   This command will list all the policy assignments in your Azure account. You can look for the "Not Allowed Resource Types" policy in this list.

4. Check the policy assignment details: If you find the "Not Allowed Resource Types" policy in the list, you can check its details using the following command:
   ```
   az policy assignment show --name "Not Allowed Resource Types"
   ```
   This command will show the details of the "Not Allowed Resource Types" policy, including its status. If the status is "In Use", it means that the policy is currently being enforced.

#### Using Python

1. Install Azure SDK: To interact with Azure services, you need to install Azure SDK for Python. You can install it using pip:
   ```
   pip install azure-mgmt-security
   ```

2. Authenticate with Azure: Before you can interact with Azure services, you need to authenticate. You can use Azure Identity library for this. Here is a sample code to authenticate:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.security import SecurityCenter

   credential = DefaultAzureCredential()
   security_center = SecurityCenter(credential, "<subscription_id>")
   ```

3. Fetch Policy Assignments: Now, you can fetch all the policy assignments and check if 'Not Allowed Resource Types' policy assignment is in use. Here is a sample code to do this:
   ```python
   policy_assignments = security_center.policy_assignments.list()

   for policy_assignment in policy_assignments:
       if policy_assignment.name == 'Not Allowed Resource Types':
           print(f"Policy Assignment '{policy_assignment.name}' is in use.")
   ```

4. Check Policy Assignment Status: If the 'Not Allowed Resource Types' policy assignment is in use, you can check its status. If the status is 'Disabled', it means the policy assignment is not being enforced. Here is a sample code to check the status:
   ```python
   if policy_assignment.name == 'Not Allowed Resource Types':
       if policy_assignment.properties.status == 'Disabled':
           print(f"Policy Assignment '{policy_assignment.name}' is in use but not being enforced.")
       else:
           print(f"Policy Assignment '{policy_assignment.name}' is in use and being enforced.")
   ```

Please replace `<subscription_id>` with your actual Azure subscription ID.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Ensure Not Allowed Resource Types Policy Assignment In Use" misconfiguration in Azure using the Azure console, follow the below steps:

1. Open the Azure Portal and log in to your account.
2. In the left-hand menu, click on "Policy" under "Governance and management".
3. In the "Policy" blade, click on "Assignments" and select the policy assignment that is causing the misconfiguration.
4. Click on the "Edit" button at the top of the blade.
5. In the "Edit assignment" blade, scroll down to the "Parameters" section and locate the "disallowedResourceTypes" parameter.
6. Edit the value of the "disallowedResourceTypes" parameter to remove any resource types that are not actually disallowed.
7. Click on the "Review + Save" button at the bottom of the blade.
8. Review the changes and click on the "Save" button to apply the changes.

Once the changes are saved, the "Ensure Not Allowed Resource Types Policy Assignment In Use" misconfiguration will be remediated in Azure.

#### Using CLI

To remediate the "Ensure Not Allowed Resource Types Policy Assignment In Use" misconfiguration in Azure using Azure CLI, you can follow the below steps:

1. Open the Azure CLI on your local machine or Azure Cloud Shell.

2. Run the following command to list all the policy assignments:

   ```
   az policy assignment list
   ```

3. Identify the policy assignment that is causing the misconfiguration. The policy assignment name can be found in the "name" field of the output.

4. Run the following command to delete the policy assignment:

   ```
   az policy assignment delete --name <policy-assignment-name>
   ```

   Replace `<policy-assignment-name>` with the name of the policy assignment that you identified in step 3.

5. Verify that the policy assignment has been deleted by running the following command:

   ```
   az policy assignment list
   ```

   The output should not contain the deleted policy assignment.

6. Once the policy assignment has been deleted, remediation is complete.

Note: Before deleting the policy assignment, make sure that it is safe to do so and that it will not cause any unintended consequences.

#### Using Python

To remediate the Azure misconfiguration "Ensure Not Allowed Resource Types Policy Assignment In Use" using Python, follow these steps:

1. First, you need to authenticate to your Azure account using the Azure Python SDK. You can do this by following the instructions here: https://docs.microsoft.com/en-us/azure/developer/python/azure-sdk-authenticate?tabs=cmd.

2. Once you have authenticated, you can use the Azure Python SDK to get a list of all the policy assignments in your Azure subscription. You can do this by using the `azure.mgmt.resource.policy` module and the `PolicyAssignmentsOperations` class.

   ```
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.resource.policy import PolicyAssignmentsOperations, PolicyClient
   from azure.mgmt.resource import ResourceManagementClient, SubscriptionClient
   from azure.mgmt.subscription import SubscriptionClient

   credential = DefaultAzureCredential()

   subscription_id = "<your-subscription-id>"
   policy_client = PolicyClient(credential, subscription_id=subscription_id)
   assignments = policy_client.policy_assignments.list()
   ```

3. Next, you can filter the list of policy assignments to find the ones that are not allowed. You can do this by checking the `notScopes` property of each policy assignment.

   ```
   for assignment in assignments:
       if assignment.not_scopes is not None:
           # This policy assignment is not allowed
           # You can delete it using the PolicyAssignmentsOperations.delete() method
           policy_client.policy_assignments.delete(assignment.id)
   ```

4. Finally, you can delete the policy assignments that are not allowed using the `PolicyAssignmentsOperations.delete()` method.

   ```
   for assignment in assignments:
       if assignment.not_scopes is not None:
           # This policy assignment is not allowed
           # You can delete it using the PolicyAssignmentsOperations.delete() method
           policy_client.policy_assignments.delete(assignment.id)
   ```

That's it! By following these steps, you can remediate the Azure misconfiguration "Ensure Not Allowed Resource Types Policy Assignment In Use" using Python.


</Tab>
</Tabs>