

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal using your credentials. 

2. Open Security Center: On the left-hand side menu, click on "Security Center". This will open the Security Center dashboard where you can monitor and manage the security of your Azure resources.

3. Navigate to the "Security policy" section: In the Security Center dashboard, click on "Security policy". This will open a list of all your subscriptions. 

4. Check for "Monitor External Accounts with Write Permissions": Click on your subscription to open the policy settings. Scroll down to the "Data Collection" section. Here, you should see a setting named "Monitor External Accounts with Write Permissions". If this setting is not enabled, it means that your Azure account may have a misconfiguration.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. Check Azure Security Center Settings: To check the Azure Security Center settings, use the following command: `az security setting list --query "[?name=='MCAS']"`. This command will list all the settings related to Microsoft Cloud App Security (MCAS) in the Security Center.

3. Check External Accounts with Write Permissions: To check for external accounts with write permissions, you can use the following command: `az security adaptive-application-controls list`. This command will list all the adaptive application controls, including the details of the external accounts with write permissions.

4. Check Alerts: To check for any alerts related to external accounts with write permissions, use the following command: `az security alert list --query "[?properties.description contains 'External Accounts with Write Permissions']"`. This command will list all the alerts where the description contains 'External Accounts with Write Permissions'.

#### Using Python

1. **Setup Azure SDK for Python**: To interact with Azure services, you need to install Azure SDK for Python. You can install it using pip:
   ```
   pip install azure-mgmt-security
   ```
2. **Authenticate with Azure**: Before you can interact with Azure services, you need to authenticate. You can use Azure Identity library for this. Here is a sample code to authenticate:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.security import SecurityCenter

   credential = DefaultAzureCredential()
   client = SecurityCenter(credential, "<subscription_id>")
   ```
   Replace `<subscription_id>` with your Azure subscription ID.

3. **Fetch External Accounts with Write Permissions**: Now, you can use the `client` object to fetch the external accounts with write permissions. Here is a sample code to do this:
   ```python
   from azure.mgmt.security.models import SecurityContact

   security_contacts = client.security_contacts.list()
   for contact in security_contacts:
       if isinstance(contact, SecurityContact) and contact.alerts_admins == 'On':
           print(f"External account with write permissions: {contact.email}")
   ```
   This script will print the email addresses of all external accounts with write permissions.

4. **Analyze the Results**: The script will print the email addresses of all external accounts with write permissions. You should review these accounts and ensure that they should have write permissions. If you find any account that should not have write permissions, you should take appropriate actions to remove the write permissions from that account.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

The misconfiguration "Monitor External Accounts with Write Permissions" in Azure means that external accounts have write permissions to your Azure resources, which can potentially lead to unauthorized access or data breaches. To remediate this, follow the steps below:

1. Open the Azure portal and sign in with your credentials.
2. Navigate to the "Azure Active Directory" service.
3. Click on "External Identities" in the left-hand menu.
4. Click on "Azure AD Domain Services" in the External Identities menu.
5. Click on the "Properties" tab.
6. Under "Write Access," select "Disabled."
7. Click "Save" to apply the changes.

By disabling write access for external accounts, you are limiting their ability to modify your Azure resources. This helps prevent unauthorized access or data breaches.

#### Using CLI

The following are the step-by-step instructions to remediate the "Monitor External Accounts with Write Permissions" misconfiguration in Azure using Azure CLI:

1. Open the Azure CLI on your local machine or Azure Cloud Shell.

2. Run the following command to list all the external accounts with write permissions in your subscription:

   ```
   az monitor activity-log list --query "[?category=='Administrative' and operationName.value=='Microsoft.Authorization/roleAssignments/write' and authorization.scope=='/subscriptions/{subscriptionId}'].caller"
   ```

   This command will return a list of all the external accounts with write permissions in your subscription.

3. Review the list of external accounts and identify any that should not have write permissions.

4. Run the following command to remove write permissions for an external account:

   ```
   az role assignment delete --assignee <external-account-id> --role <role-name> --scope /subscriptions/{subscriptionId}
   ```

   Replace `<external-account-id>` with the ID of the external account you want to remove write permissions for, and `<role-name>` with the name of the role that grants write permissions.

5. Repeat step 4 for any other external accounts that should not have write permissions.

6. Run the command from step 2 again to confirm that all external accounts with write permissions have been removed.

7. Monitor your subscription for any unauthorized write activity and investigate any suspicious activity.

By following these steps, you can remediate the "Monitor External Accounts with Write Permissions" misconfiguration in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration "Monitor External Accounts with Write Permissions" in Azure using Python, you can follow the below steps:

Step 1: Install the Azure SDK for Python using the pip command.

```python
pip install azure
```

Step 2: Authenticate with Azure using the Azure CLI or by providing the credentials in code.

```python
from azure.common.credentials import UserPassCredentials
from azure.mgmt.monitor import MonitorManagementClient
from azure.mgmt.resource import ResourceManagementClient

# Replace the values with your own
subscription_id = 'SUBSCRIPTION_ID'
username = 'USERNAME'
password = 'PASSWORD'
tenant_id = 'TENANT_ID'

credentials = UserPassCredentials(username, password, tenant_id)
monitor_client = MonitorManagementClient(
    credentials,
    subscription_id
)
resource_client = ResourceManagementClient(
    credentials,
    subscription_id
)
```

Step 3: Get the list of external accounts with write permissions.

```python
# Get the list of external accounts with write permissions
external_accounts = monitor_client.external_monitoring_configurations.list_by_subscription()

external_accounts_with_write_permissions = []
for account in external_accounts:
    if account.enabled and account.type == 'Azure' and account.write_access_enabled:
        external_accounts_with_write_permissions.append(account)
```

Step 4: Disable write permissions for the external accounts.

```python
# Disable write permissions for the external accounts
for account in external_accounts_with_write_permissions:
    account.write_access_enabled = False
    monitor_client.external_monitoring_configurations.create_or_update(
        resource_group_name=account.resource_group_name,
        configuration_name=account.name,
        parameters=account
    )
```

By following these steps, you can remediate the "Monitor External Accounts with Write Permissions" misconfiguration in Azure using Python.


</Tab>
</Tabs>