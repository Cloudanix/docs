

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Open your web browser, navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to Recovery Services vaults: On the Azure portal menu or from the 'Home' page, select 'All services'. In the 'All services' box, enter Recovery Services. The list filters based on your input. When you see 'Recovery Services vaults', select it.

3. Check Backup Policies: Once you are in the 'Recovery Services vaults' section, select the appropriate vault. In the vault dashboard, under 'Protected Items', select 'Backup Policies'. Here you can see all the backup policies associated with the vault.

4. Verify Retention Period: Click on each backup policy to check its settings. In the 'Retention Range' section, you can see the number of days the backup is retained. If the retention period is less than the required period, then it is a misconfiguration.

#### Using CLI

1. Install and configure Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine and sign in to your Azure account. You can install Azure CLI by following the instructions on the official Azure CLI documentation. After installation, you can sign in to your Azure account by running the following command in your terminal:

   ```
   az login
   ```
   Follow the instructions in the terminal to complete the sign-in process.

2. List all the virtual machines: The next step is to list all the virtual machines in your Azure account. You can do this by running the following command:

   ```
   az vm list --query "[].{name:name, resourceGroup:resourceGroup}" -o table
   ```
   This command will return a table that lists the names and resource groups of all the virtual machines in your Azure account.

3. Check the backup policy: For each virtual machine, you need to check the backup policy to see if it has a sufficient daily backup retention period. You can do this by running the following command:

   ```
   az backup policy list --resource-group <ResourceGroupName> --vault-name <VaultName> --query "[].{name:name, retentionPeriod:properties.instantRpRetentionRangeInDays}" -o table
   ```
   Replace `<ResourceGroupName>` and `<VaultName>` with the resource group and vault name of the virtual machine you are checking. This command will return a table that lists the names and retention periods of all the backup policies in the specified resource group and vault.

4. Analyze the results: The final step is to analyze the results. If the retention period of a backup policy is less than the required number of days, then the virtual machine is misconfigured. You need to manually check each virtual machine and its backup policy to ensure that they all have a sufficient daily backup retention period.

#### Using Python

1. AWS:
   - Install and configure AWS SDK for Python (Boto3).
   - Use the `describe_snapshots` function to retrieve information about all snapshots.
   - For each snapshot, check the `StartTime` attribute to determine when the snapshot was created. If the difference between the current date and the `StartTime` is more than the desired retention period, the backup retention period is insufficient.

```python
import boto3
from datetime import datetime, timedelta

def check_backup_retention():
    ec2 = boto3.client('ec2')
    snapshots = ec2.describe_snapshots(OwnerIds=['self'])
    for snapshot in snapshots['Snapshots']:
        if (datetime.now() - snapshot['StartTime'].replace(tzinfo=None)) > timedelta(days=7): # change the days as per your retention policy
            print(f"Snapshot {snapshot['SnapshotId']} has insufficient backup retention period")

check_backup_retention()
```

2. Azure:
   - Install and configure Azure SDK for Python.
   - Use the `list_by_resource_group` function to retrieve information about all backups.
   - For each backup, check the `time_created` attribute to determine when the backup was created. If the difference between the current date and the `time_created` is more than the desired retention period, the backup retention period is insufficient.

```python
from azure.mgmt.recoveryservicesbackup import RecoveryServicesBackupClient
from datetime import datetime, timedelta

def check_backup_retention():
    client = RecoveryServicesBackupClient(credentials, subscription_id)
    backups = client.backup_protected_items.list_by_resource_group(resource_group_name)
    for backup in backups:
        if (datetime.now() - backup.properties.time_created.replace(tzinfo=None)) > timedelta(days=7): # change the days as per your retention policy
            print(f"Backup {backup.name} has insufficient backup retention period")

check_backup_retention()
```

3. GCP:
   - Install and configure Google Cloud SDK for Python.
   - Use the `snapshots().list` function to retrieve information about all snapshots.
   - For each snapshot, check the `creationTimestamp` attribute to determine when the snapshot was created. If the difference between the current date and the `creationTimestamp` is more than the desired retention period, the backup retention period is insufficient.

```python
from google.cloud import storage
from datetime import datetime, timedelta

def check_backup_retention():
    client = storage.Client()
    snapshots = client.list_snapshots()
    for snapshot in snapshots:
        if (datetime.now() - datetime.strptime(snapshot.creationTimestamp, '%Y-%m-%dT%H:%M:%S.%fZ')) > timedelta(days=7): # change the days as per your retention policy
            print(f"Snapshot {snapshot.name} has insufficient backup retention period")

check_backup_retention()
```

Please replace the placeholders like `credentials`, `subscription_id`, `resource_group_name` with actual values. Also, you need to have appropriate permissions to access the resources.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Virtual Machines Should Have Sufficient Daily Backup Retention Period" for AZURE using the AZURE console, you can follow the below steps:

1. Log in to your Azure portal (https://portal.azure.com/).
2. Navigate to the Virtual Machines service.
3. Select the virtual machine that you want to configure the backup retention period for.
4. Under the "Operations" section, click on "Backup" to open the "Backup" blade.
5. In the "Backup" blade, click on "Backup policy" to open the "Backup policy" blade.
6. In the "Backup policy" blade, click on "Edit" to modify the backup policy.
7. In the "Backup policy" blade, select the appropriate backup policy that meets your retention period requirements. You can either select an existing policy or create a new one.
8. Once you have selected the policy, click on "Save" to apply the changes to the backup policy.

By following the above steps, you can remediate the misconfiguration "Virtual Machines Should Have Sufficient Daily Backup Retention Period" for AZURE using the AZURE console.

#### Using CLI

To remediate the misconfiguration "Virtual Machines Should Have Sufficient Daily Backup Retention Period" for AZURE using AZURE CLI, follow these steps:

1. Open the AZURE CLI and log in to your account using the command `az login`.

2. Once you are logged in, run the command `az vm list --query "[].{name:name, resourceGroup:resourceGroup, backup:provisioningState}"` to list all the virtual machines and their backup status.

3. Identify the virtual machine that has insufficient daily backup retention period.

4. Run the command `az backup protection enable-for-vm --resource-group <resource-group-name> --vault-name <vault-name> --vm <vm-name> --policy-name <policy-name>` to enable backup protection for the virtual machine.

Note: Replace `<resource-group-name>`, `<vault-name>`, `<vm-name>`, and `<policy-name>` with the appropriate values.

5. After enabling backup protection, run the command `az backup policy list --vault-name <vault-name> --query "[].{name:name, backupSchedule:backupSchedule}"` to list all the backup policies and their backup schedules.

6. Identify the backup policy that has the required daily backup retention period.

7. Run the command `az backup protection backup-now --resource-group <resource-group-name> --vault-name <vault-name> --container-name <container-name> --item-name <item-name> --retain-until <date-time>` to initiate a backup for the virtual machine.

Note: Replace `<resource-group-name>`, `<vault-name>`, `<container-name>`, `<item-name>`, and `<date-time>` with the appropriate values.

8. After initiating the backup, verify that the backup has been completed successfully by running the command `az backup job list --vault-name <vault-name> --query "[].{name:name, status:status}"`.

9. Finally, run the command `az backup policy set --vault-name <vault-name> --name <policy-name> --backup-schedule '{"scheduleFrequencyInMins":1440,"retentionPolicy":{"dailySchedule":{"retentionDuration":{"count":<count>,"durationType":"Days"}}}}'` to set the backup policy with the required daily backup retention period.

Note: Replace `<vault-name>`, `<policy-name>`, and `<count>` with the appropriate values.

By following these steps, you can remediate the misconfiguration "Virtual Machines Should Have Sufficient Daily Backup Retention Period" for AZURE using AZURE CLI.

#### Using Python

To remediate the misconfiguration "Virtual Machines Should Have Sufficient Daily Backup Retention Period" in Azure using Python, you can follow the below steps:

Step 1: Install the Azure SDK for Python using pip command.

```
pip install azure
```

Step 2: Import the required libraries and authenticate the credentials.

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.storage import StorageManagementClient

# Authentication
subscription_id = 'your_subscription_id'
credentials = ServicePrincipalCredentials(
    client_id='your_client_id',
    secret='your_secret',
    tenant='your_tenant'
)

# Resource Management Client
resource_client = ResourceManagementClient(credentials, subscription_id)

# Compute Management Client
compute_client = ComputeManagementClient(credentials, subscription_id)

# Storage Management Client
storage_client = StorageManagementClient(credentials, subscription_id)
```

Step 3: Get the list of virtual machines that are not having the sufficient daily backup retention period.

```python
# Get the list of virtual machines
vm_list = compute_client.virtual_machines.list_all()

# Iterate through each virtual machine
for vm in vm_list:
    # Get the backup policy of the virtual machine
    backup_policy = compute_client.virtual_machine_backup_policies.get(
        resource_group_name=vm.id.split('/')[4],
        vault_name='your_vault_name',
        vm_name=vm.name
    )

    # Check the daily backup retention period
    if backup_policy.backup_schedule.daily_retention_days < 7:
        # If retention period is less than 7 days, update the policy
        backup_policy.backup_schedule.daily_retention_days = 7
        compute_client.virtual_machine_backup_policies.create_or_update(
            resource_group_name=vm.id.split('/')[4],
            vault_name='your_vault_name',
            vm_name=vm.name,
            parameters=backup_policy
        )
```

Step 4: Save the Python script and run it to remediate the misconfiguration.

Note: Replace the `your_subscription_id`, `your_client_id`, `your_secret`, `your_tenant`, and `your_vault_name` with your Azure subscription details. Also, make sure to provide the appropriate permissions to the Service Principal used for authentication.


</Tab>
</Tabs>