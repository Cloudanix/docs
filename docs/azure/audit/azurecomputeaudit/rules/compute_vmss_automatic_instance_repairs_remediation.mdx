

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your credentials.
2. Navigate to the "Virtual Machine Scale Sets" section. You can do this by searching for it in the search bar at the top of the Azure portal.
3. Select the desired Virtual Machine Scale Set from the list. This will open the settings for the selected scale set.
4. In the settings pane, look for the "Automatic Repairs" option under the "Settings" section. If it's enabled, you will see "On" next to it. If it's not enabled, you will see "Off".

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have the Azure CLI installed on your local machine. You can download it from the official Microsoft Azure website.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your credentials to proceed.
   ```
   az login
   ```
3. Select the Subscription: If you have multiple subscriptions, select the one where the VMSS is located. Replace 'my-subscription-name' with your subscription name.
   ```
   az account set --subscription 'my-subscription-name'
   ```
4. Check Automatic Instance Repairs: Use the following command to check if automatic instance repairs are enabled for your Virtual Machine Scale Set (VMSS). Replace 'myResourceGroup' with your resource group name and 'myvmss' with your VMSS name.
   ```
   az vmss show --resource-group myResourceGroup --name myvmss --query automaticRepairsPolicy
   ```
   If the output is null, it means that automatic instance repairs are not enabled. If it shows a policy, it means that automatic instance repairs are enabled.

#### Using Python

To check if Automatic Instance Repairs is enabled in Google Cloud Platform (GCP) Compute Engine, you can use the Google Cloud SDK (gcloud) or the Google Cloud Client Libraries for Python. Here are the steps:

1. **Install Google Cloud SDK and Python Client Libraries:**
   Before you can run any scripts, you need to install the Google Cloud SDK and the Python client libraries. You can do this by following the instructions in the official Google Cloud documentation.

2. **Authenticate your SDK:**
   Use the `gcloud auth login` command to authenticate your SDK. This will open a new browser window where you can log in with your Google account. Once logged in, your SDK will be authenticated.

3. **Install the necessary Python libraries:**
   You will need the `google-cloud-compute` library to interact with the Compute Engine. You can install it using pip:
   ```
   pip install --upgrade google-cloud-compute
   ```

4. **Python Script to Check Automatic Instance Repairs:**
   Here is a Python script that checks if Automatic Instance Repairs is enabled for all instances in a project:

   ```python
   from google.cloud import compute_v1

   def check_automatic_instance_repairs(project_id):
       client = compute_v1.InstancesClient()
       instances = client.list(project=project_id, zone='-')  # '-' lists instances across all zones

       for instance in instances:
           if 'shieldedInstanceConfig' in instance:
               if not instance.shieldedInstanceConfig.enable_secure_boot:
                   print(f"Instance {instance.name} does not have Automatic Instance Repairs enabled.")
   ```

   This script first creates a client for the Compute Engine API. It then lists all instances in the specified project across all zones. For each instance, it checks if the `shieldedInstanceConfig` field is present (this field is only present for shielded VM instances). If this field is present, it checks if `enable_secure_boot` is set to `True`. If it is not, it prints a message indicating that Automatic Instance Repairs is not enabled for that instance.

Please note that this script only checks for shielded VM instances. Non-shielded instances will not have the `shieldedInstanceConfig` field, and therefore will not be checked.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of not having Automatic Instance Repairs enabled in Azure, you can follow these steps:

1. Log in to the Azure portal and navigate to the Virtual Machines section.

2. Select the virtual machine that you want to enable automatic instance repairs for.

3. In the virtual machine's overview page, click on the "Automation options" tab.

4. In the "Automation options" tab, toggle the "Automatic Repairs" option to "On".

5. In the "Automatic Repairs" section, you can configure the settings for automatic repairs. You can choose to enable automatic repairs for the operating system or data disks, and set a repair grace period.

6. Once you have configured the automatic repair settings, click on the "Save" button to apply the changes.

7. Azure will now automatically detect and repair any issues with your virtual machine, helping to ensure maximum availability and uptime.

That's it! By following these steps, you can remediate the misconfiguration of not having automatic instance repairs enabled in Azure.

#### Using CLI

To enable automatic instance repairs in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI on your computer.

2. Log in to your Azure account using the following command:

   ```
   az login
   ```

3. Once you are logged in, select the subscription that contains the virtual machine you want to enable automatic instance repairs for using the following command:

   ```
   az account set --subscription <subscription_id>
   ```

4. Next, enable automatic instance repairs for the virtual machine by running the following command:

   ```
   az vm update --resource-group <resource_group_name> --name <vm_name> --set automaticRepairsEnabled=true
   ```

   Replace `<resource_group_name>` with the name of the resource group that contains the virtual machine and `<vm_name>` with the name of the virtual machine.

5. After running the command, Azure will enable automatic instance repairs for the virtual machine. You can verify that automatic instance repairs are enabled by running the following command:

   ```
   az vm show --resource-group <resource_group_name> --name <vm_name> --query automaticRepairsEnabled
   ```

   If the command returns "true", automatic instance repairs are enabled for the virtual machine.

That's it! You have successfully remediated the misconfiguration by enabling automatic instance repairs for the virtual machine in Azure using Azure CLI.

#### Using Python

To enable automatic instance repairs for Azure using Python, you can follow the below steps:

Step 1: Install the Azure SDK for Python using pip command as shown below:

```python
pip install azure-mgmt-compute
```

Step 2: Import the required modules as shown below:

```python
from azure.identity import AzureCliCredential
from azure.mgmt.compute import ComputeManagementClient
```

Step 3: Authenticate and create a compute management client instance as shown below:

```python
credential = AzureCliCredential()
subscription_id = '<your-subscription-id>'
compute_client = ComputeManagementClient(credential, subscription_id)
```

Step 4: Get the resource group and virtual machine name for which you want to enable automatic instance repairs as shown below:

```python
resource_group_name = '<your-resource-group-name>'
vm_name = '<your-vm-name>'
```

Step 5: Enable automatic instance repairs for the virtual machine using the below code:

```python
vm = compute_client.virtual_machines.get(resource_group_name, vm_name)
vm.instance_view.auto_upgrade_policy = 'Rolling'
compute_client.virtual_machines.create_or_update(resource_group_name, vm_name, vm)
```

In the above code, we are getting the virtual machine instance, setting the auto-upgrade policy to "Rolling", and then updating the virtual machine with the new policy.

Step 6: Verify if the automatic instance repairs are enabled for the virtual machine using the below code:

```python
vm = compute_client.virtual_machines.get(resource_group_name, vm_name)
print(vm.instance_view.auto_upgrade_policy)
```

The above code will print the auto-upgrade policy of the virtual machine, which should be "Rolling" if the automatic instance repairs are enabled.

That's it! You have successfully enabled automatic instance repairs for Azure virtual machine using Python.


</Tab>
</Tabs>