---
slug: compute_vmss_automatic_os_upgrades
title: Enable Automatic OS Upgrades
sidebar_label: Enable Automatic OS Upgrades
---

### More Info:

Ensure that operating system (OS) upgrades are automatically applied to your Microsoft Azure virtual machine scale sets when a newer version of the OS image is released by the image publishers. Automatic OS Upgrades feature supports both Windows and Linux images, and can be enabled for all virtual machine sizes. An automatic OS upgrade works by replacing the boot (OS) disk of a virtual machine instance running within a scale set with a new disk created using the latest image version available. Any configured extensions and custom data scripts are run on the OS disk, while persisted data disks are retained.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, NISTCSF


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your credentials.
2. Navigate to the "Virtual Machines" section from the left-hand side menu. Here, you will see a list of all your virtual machines.
3. Click on the name of the virtual machine for which you want to check the automatic OS upgrades setting.
4. In the virtual machine's dashboard, click on the "Configuration" option under the "Settings" section. Here, you can see the status of 'Automatic OS upgrades'. If it is enabled, it will show 'On', otherwise, it will show 'Off'.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to have the Azure CLI installed on your system. You can download and install it from the official Azure website.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your username and password.
   ```
   az login
   ```
3. List all the VMs: Use the following command to list all the virtual machines in a specific resource group. Replace 'MyResourceGroup' with the name of your resource group.
   ```
   az vm list --resource-group MyResourceGroup --output table
   ```
4. Check for automatic OS upgrades: For each VM, use the following command to check if automatic OS upgrades are enabled. Replace 'MyResourceGroup' with the name of your resource group and 'MyVM' with the name of your VM.
   ```
   az vm get-instance-view --resource-group MyResourceGroup --name MyVM --query "[?automaticOsUpgrade]"
   ```
   If the output is 'true', then automatic OS upgrades are enabled. If the output is 'false', then automatic OS upgrades are not enabled.

#### Using Python

To check if automatic OS upgrades are enabled in Google Cloud Platform (GCP) Compute Engine instances, you can use the Google Cloud SDK (gcloud) or the Google Cloud Client Library for Python. Here are the steps:

1. **Install Google Cloud SDK and Python Client Library:**
   Before you can run any scripts, you need to install the Google Cloud SDK and the Python client library. You can do this using pip, the Python package installer.

   ```bash
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-cloud-compute
   ```

2. **Authenticate your SDK:**
   Use the `gcloud auth application-default login` command to authenticate your SDK. This will open a new browser window where you can log in with your Google account.

3. **Create a Python script:**
   Create a Python script that uses the Google Cloud Client Library to list all instances and check if they have automatic OS upgrades enabled. Here's an example:

   ```python
   from google.cloud import compute_v1

   def list_instances(project, zone):
       instances_client = compute_v1.InstancesClient()
       instances = instances_client.list(project=project, zone=zone)
       for instance in instances:
           check_auto_upgrade(instance)

   def check_auto_upgrade(instance):
       settings = instance.get('settings')
       if settings:
           auto_upgrade = settings.get('automaticRestart')
           if auto_upgrade:
               print(f"Instance {instance['name']} has automatic OS upgrades enabled.")
           else:
               print(f"Instance {instance['name']} does not have automatic OS upgrades enabled.")

   list_instances('your-project-id', 'your-zone')
   ```
   
   Replace 'your-project-id' and 'your-zone' with your actual project ID and zone.

4. **Run the Python script:**
   Save the script to a file, for example `check_auto_upgrade.py`, and run it with Python:

   ```bash
   python check_auto_upgrade.py
   ```

   The script will print out the names of all instances and whether they have automatic OS upgrades enabled or not.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To enable Automatic OS Upgrades in Azure, follow these steps:

1. Log in to the Azure portal.

2. Select the Virtual Machine that you want to configure.

3. In the Virtual Machine pane, select the "Update Management" option.

4. In the "Update Management" pane, select the "Schedule update deployments" option.

5. In the "Schedule update deployments" pane, select the "Automatic" option for "OS upgrades".

6. Choose the maintenance window time that suits your needs.

7. Click on the "Save" button to save the changes.

That's it! Now your Virtual Machine will automatically receive OS upgrades during the maintenance window you have selected, ensuring that your system is always up-to-date and secure.

#### Using CLI

To remediate the misconfiguration of not having automatic OS upgrades enabled for Azure using Azure CLI, you can follow these steps:

1. Open the Azure CLI and log in to your Azure account using the command: `az login`
2. Once you are logged in, set the subscription where the virtual machine is located using the command: `az account set --subscription <subscription_id>`
3. Identify the virtual machine that needs to have automatic OS upgrades enabled using the command: `az vm list`
4. Once you have identified the virtual machine, run the following command to enable automatic OS upgrades: `az vm auto-upgrade --resource-group <resource_group_name> --name <vm_name> --set upgradePolicy.mode="Automatic"`
5. This command will enable automatic OS upgrades for the specified virtual machine.

It is important to note that automatic OS upgrades may cause some issues with certain applications or services running on the virtual machine. Therefore, it is recommended to test the automatic OS upgrade feature in a non-production environment before enabling it in a production environment.

#### Using Python

To remediate the misconfiguration "Enable Automatic OS Upgrades" for Azure using Python, you can follow these steps:

1. Import the required Azure Python SDK modules:
   ```
   from azure.common.credentials import ServicePrincipalCredentials
   from azure.mgmt.compute import ComputeManagementClient
   from azure.mgmt.resource import ResourceManagementClient
   from azure.mgmt.subscription import SubscriptionClient
   ```
2. Authenticate and create a client object for the Azure subscription:
   ```
   credentials = ServicePrincipalCredentials(client_id=<client_id>, secret=<secret>, tenant=<tenant_id>)
   subscription_client = SubscriptionClient(credentials)
   subscription = next(subscription_client.subscriptions.list())
   ```
   Replace `<client_id>`, `<secret>`, and `<tenant_id>` with the appropriate values for your Azure account.
   
3. Create a client object for the Azure Resource Manager:
   ```
   resource_client = ResourceManagementClient(credentials, subscription.subscription_id)
   ```
   
4. Get the list of virtual machines in the Azure subscription:
   ```
   compute_client = ComputeManagementClient(credentials, subscription.subscription_id)
   vms = compute_client.virtual_machines.list_all()
   ```
   
5. For each virtual machine, enable automatic OS upgrades:
   ```
   for vm in vms:
       update_resource = compute_client.virtual_machines.begin_update(resource_group_name=vm.id.split('/')[4], vm_name=vm.name, parameters={'automatic_os_upgrade_policy': {'enable_automatic_os_upgrade': True}})
   ```
   
   This will enable automatic OS upgrades for all virtual machines in the subscription.
   
Note: Make sure you have the necessary permissions to perform these actions in your Azure subscription before running the script.




</Tab>
</Tabs>