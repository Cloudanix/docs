---
slug: azure_audit_compute_vms_with_extensions
title: Virtual Machine Extensions Installed
sidebar_label: Virtual Machine Extensions Installed
---

### More Info:

Azure virtual machine extensions are small applications that provide post-deployment configuration and automation tasks on Azure virtual machines. These extensions run with administrative privileges and could potentially access anything on a virtual machine. The Azure Portal and community provide several such extensions.

### Risk Level

High

### Address

Security

### Compliance Standards

CISAZURE, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your credentials.

2. Navigate to the "Virtual Machines" section from the left-hand side menu. This will display a list of all the virtual machines that are currently running in your Azure environment.

3. Click on the name of the virtual machine for which you want to check the installed extensions. This will open the dashboard of the selected virtual machine.

4. In the virtual machine dashboard, click on the "Extensions" option under the "Settings" section. This will display a list of all the extensions that are currently installed on the selected virtual machine.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI commands, you need to have Azure CLI installed on your system. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your credentials and login.
   ```
   az login
   ```
3. Set your subscription: If you have multiple subscriptions, you need to set the subscription you want to use. Replace 'my-subscription-name' with your subscription name.
   ```
   az account set --subscription 'my-subscription-name'
   ```
4. Check VM Extensions: Now, you can check the VM extensions installed in compute. Replace 'myResourceGroup' with your resource group name and 'myVM' with your VM name.
   ```
   az vm extension list --resource-group myResourceGroup --vm-name myVM --output table
   ```
This command will list all the extensions installed on the specified VM. If you want to see the details of a specific extension, you can use the '--name' option followed by the extension name.

#### Using Python

To check if Virtual Machine Extensions are installed in Compute using Python scripts, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: You need to install the Azure SDK for Python in your environment. You can do this using pip:
   ```
   pip install azure-mgmt-compute
   ```
2. **Authenticate to Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for this. Here is an example of how to authenticate using a service principal:
   ```python
   from azure.identity import ClientSecretCredential
   credential = ClientSecretCredential(
       tenant_id="your-tenant-id",
       client_id="your-client-id",
       client_secret="your-client-secret"
   )
   ```
3. **Initialize Compute Management Client**: After authenticating, you need to initialize the Compute Management Client. This client will allow you to interact with Azure Compute resources:
   ```python
   from azure.mgmt.compute import ComputeManagementClient
   compute_client = ComputeManagementClient(credential, "your-subscription-id")
   ```
4. **List VM Extensions**: Now you can list all VM extensions in a resource group. Here is an example:
   ```python
   vm_extensions = compute_client.virtual_machine_extensions.list("your-resource-group", "your-vm-name")
   for extension in vm_extensions:
       print(extension.name)
   ```
   This script will print the names of all extensions installed in the specified VM. If you want to check if a specific extension is installed, you can modify the script to check for that extension's name in the list of installed extensions.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Here are the step-by-step instructions to remediate the "Virtual Machine Extensions Installed" misconfiguration in Azure using the Azure console:

1. Log in to the Azure portal (https://portal.azure.com/).
2. Navigate to the virtual machine that has the misconfiguration.
3. Click on the virtual machine to open its overview page.
4. In the left-hand menu, click on "Extensions."
5. In the list of extensions, locate the extension that needs to be removed and click on it.
6. Click on the "Uninstall" button to remove the extension from the virtual machine.
7. Confirm the removal by clicking "Yes" on the confirmation page.
8. Wait for the extension to be uninstalled from the virtual machine.

Once the extension has been successfully uninstalled, the misconfiguration will be remediated. It is important to note that some extensions may be required for the proper functioning of the virtual machine, so it is recommended to consult with the appropriate stakeholders before removing any extensions.

#### Using CLI

To remediate the misconfiguration "Virtual Machine Extensions Installed" in Azure using Azure CLI, follow the below steps:

Step 1: Open the Azure CLI in your system.

Step 2: Run the following command to list all the virtual machines in the Azure subscription:

```
az vm list --query "[].{name:name, location:location, resourceGroup:resourceGroup}"
```

Step 3: From the list of virtual machines, select the virtual machine for which you want to remove the extensions.

Step 4: Run the following command to check the list of extensions installed on the virtual machine:

```
az vm extension list --resource-group <resource-group-name> --vm-name <virtual-machine-name> --query "[].{name:name, publisher:publisher, type:type, autoUpgradeMinorVersion:autoUpgradeMinorVersion, settings:settings, protectedSettings:protectedSettings, provisioningState:provisioningState, instanceView:instanceView}"
```

Step 5: From the list of extensions, select the extension that you want to remove.

Step 6: Run the following command to remove the selected extension from the virtual machine:

```
az vm extension delete --resource-group <resource-group-name> --vm-name <virtual-machine-name> --name <extension-name>
```

Step 7: After running the above command, the extension will be removed from the virtual machine.

Step 8: Repeat steps 4 to 7 for all the extensions that you want to remove from the virtual machine.

Step 9: Once all the extensions are removed, the misconfiguration "Virtual Machine Extensions Installed" will be remediated in Azure.

#### Using Python

To remediate the issue of virtual machine extensions installed in Azure using Python, you can follow the below steps:

Step 1: Connect to Azure Subscription
You need to connect to your Azure subscription using Python SDK. You can use the below code to authenticate and connect to the subscription.

```
from azure.identity import AzureCliCredential
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.resource import ResourceManagementClient

credential = AzureCliCredential()

subscription_id = 'your_subscription_id'

compute_client = ComputeManagementClient(credential, subscription_id)
resource_client = ResourceManagementClient(credential, subscription_id)
```

Step 2: Get Virtual Machines
You need to fetch the list of all virtual machines in your subscription. You can use the below code to get the list of virtual machines.

```
vms = compute_client.virtual_machines.list_all()
```

Step 3: Get Virtual Machine Extensions
You need to get the list of all virtual machine extensions installed on each virtual machine. You can use the below code to get the list of extensions.

```
for vm in vms:
    extensions = compute_client.virtual_machine_extensions.list(resource_group_name=vm.id.split('/')[4], virtual_machine_name=vm.name)
    for extension in extensions:
        print(extension.name)
```

Step 4: Remove Virtual Machine Extensions
You need to remove the virtual machine extensions from each virtual machine. You can use the below code to remove the extensions.

```
for vm in vms:
    extensions = compute_client.virtual_machine_extensions.list(resource_group_name=vm.id.split('/')[4], virtual_machine_name=vm.name)
    for extension in extensions:
        compute_client.virtual_machine_extensions.delete(resource_group_name=vm.id.split('/')[4], virtual_machine_name=vm.name, extension_name=extension.name)
```

Note: Please be cautious while deleting the extensions as it may impact the functionality of your virtual machines.

By following the above steps, you can remediate the issue of virtual machine extensions installed in Azure using Python.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/extensions-features](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/extensions-features) 


</Tab>
</Tabs>