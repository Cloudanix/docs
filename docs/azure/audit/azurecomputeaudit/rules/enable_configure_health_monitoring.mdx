---
slug: enable_configure_health_monitoring
title: Enable and Configure Health Monitoring
sidebar_label: Enable and Configure Health Monitoring
---

### More Info:

Ensure that Monitor Application Health feature is enabled for all the instances running within your Azure virtual machine scale set. Health monitoring via Application Health extension is required for OS upgrades and automatic instance repairs. The Azure Application Health extension reports on the application health from inside the virtual machine scale set instances. You can configure the health extension to probe on an application endpoint and update the status of the application on that instance.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HIPAA


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal and sign in with your Azure account credentials.

2. Navigate to the Virtual Machine: From the left-hand menu, select "Virtual Machines". Choose the virtual machine for which you want to enable and configure health monitoring.

3. Check Health Monitoring Status: Under the "Operations" section of the virtual machine's menu, select "Insights". Here, you can check the status of health monitoring. If it's not enabled, there will be a prompt to enable it.

4. Check Configuration: If health monitoring is enabled, you can check its configuration by selecting "Health State" under the "Monitoring" section. Here, you can see the current health state of your virtual machine and any health events that have occurred.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to have the Azure CLI installed on your system. You can download and install it from the official Azure website.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your username and password.
   ```
   az login
   ```
3. List all VMs: Use the following command to list all the virtual machines (VMs) in a specific resource group. Replace 'MyResourceGroup' with the name of your resource group.
   ```
   az vm list --resource-group MyResourceGroup --output table
   ```
4. Check Health Monitoring Status: For each VM, use the following command to check the health monitoring status. Replace 'MyResourceGroup' with the name of your resource group and 'MyVM' with the name of your VM.
   ```
   az vm get-instance-view --resource-group MyResourceGroup --name MyVM --query instanceView.statuses[1] --output table
   ```
   If the health monitoring is enabled and configured correctly, you should see the status as 'VM running'. If not, it means that the health monitoring is not enabled or not configured correctly.

#### Using Python

1. AWS:
   - Install and configure AWS CLI and Boto3 Python SDK.
   - Use the following Python script to check if health checks are enabled for EC2 instances:

```python
import boto3

def check_health_monitoring():
    ec2 = boto3.resource('ec2')
    instances = ec2.instances.all()
    for instance in instances:
        if 'Monitoring' in instance and instance['Monitoring']['State'] == 'enabled':
            print(f"Health Monitoring is enabled for instance {instance.id}")
        else:
            print(f"Health Monitoring is not enabled for instance {instance.id}")

check_health_monitoring()
```

2. Azure:
   - Install and configure Azure CLI and Azure Python SDK.
   - Use the following Python script to check if health checks are enabled for VMs:

```python
from azure.mgmt.monitor import MonitorManagementClient
from azure.common.credentials import ServicePrincipalCredentials

def check_health_monitoring():
    credentials = ServicePrincipalCredentials(
        client_id = 'client_id',
        secret = 'secret',
        tenant = 'tenant'
    )
    monitor_client = MonitorManagementClient(credentials, 'subscription_id')
    vm_list = monitor_client.virtual_machines.list_all()
    for vm in vm_list:
        if vm.diagnostics_profile.boot_diagnostics.enabled:
            print(f"Health Monitoring is enabled for VM {vm.name}")
        else:
            print(f"Health Monitoring is not enabled for VM {vm.name}")

check_health_monitoring()
```

3. GCP:
   - Install and configure GCP CLI and Google Cloud Python SDK.
   - Use the following Python script to check if health checks are enabled for Compute Engine instances:

```python
from google.cloud import compute_v1

def check_health_monitoring():
    client = compute_v1.InstancesClient()
    instances = client.list(project='project_id', zone='zone')
    for instance in instances:
        if 'healthCheck' in instance.metadata.items:
            print(f"Health Monitoring is enabled for instance {instance.name}")
        else:
            print(f"Health Monitoring is not enabled for instance {instance.name}")

check_health_monitoring()
```

Please replace 'client_id', 'secret', 'tenant', 'subscription_id', 'project_id', and 'zone' with your actual values.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Enable and Configure Health Monitoring" in Azure using the Azure console, please follow the below steps:

Step 1: Login to the Azure portal (https://portal.azure.com/).

Step 2: Select the resource group in which your virtual machine or application is located.

Step 3: Select the virtual machine or application for which you want to enable health monitoring.

Step 4: Under the Monitoring section, select "Health check".

Step 5: Click on "Add health check".

Step 6: Select the protocol (HTTP or HTTPS) and enter the URL for which you want to enable health monitoring.

Step 7: Configure the health check settings, including the frequency of the health check, the timeout value, and the number of retries.

Step 8: Click on "Save" to save the health check configuration.

Step 9: Verify that the health check is enabled and working properly by checking the status of the health check in the Azure portal.

By following these steps, you can remediate the misconfiguration "Enable and Configure Health Monitoring" in Azure using the Azure console.

#### Using CLI

To enable and configure health monitoring in Azure using Azure CLI, follow these steps:

1. Open the Azure CLI and log in to your Azure account.

2. Run the command `az monitor metrics alert create` to create a new alert rule.

3. Provide the required parameters for the alert rule, such as the resource group and resource name for the resource you want to monitor, the condition that triggers the alert, and the action to take when the alert is triggered.

4. Use the `--enabled` parameter to enable the alert rule.

5. Use the `--description` parameter to provide a description for the alert rule.

6. Use the `--tags` parameter to add any tags you want to the alert rule.

7. Run the command `az monitor metrics alert show` to verify that the alert rule was created successfully.

8. Use the `az monitor metrics alert update` command to modify the alert rule if necessary.

9. Use the `az monitor metrics alert delete` command to delete the alert rule if it is no longer needed.

Note: This is just a basic outline of the steps required to enable and configure health monitoring in Azure using Azure CLI. The specific commands and parameters you need to use may vary depending on your specific requirements and environment. Please refer to the Azure documentation for more detailed guidance on how to remediate this misconfiguration.

#### Using Python

To remediate the misconfiguration of enabling and configuring health monitoring in Azure using Python, you can follow the below steps:

1. Import the necessary libraries:

```python
from azure.mgmt.monitor import MonitorManagementClient
from azure.identity import ClientSecretCredential
```

2. Authenticate with Azure using the `ClientSecretCredential` class:

```python
TENANT_ID = 'your_tenant_id'
CLIENT_ID = 'your_client_id'
CLIENT_SECRET = 'your_client_secret'
credential = ClientSecretCredential(TENANT_ID, CLIENT_ID, CLIENT_SECRET)
```

3. Initialize the `MonitorManagementClient` using the `credential` object:

```python
SUBSCRIPTION_ID = 'your_subscription_id'
monitor_client = MonitorManagementClient(credential, SUBSCRIPTION_ID)
```

4. Get the resource group and resource ID where you want to enable health monitoring:

```python
RESOURCE_GROUP_NAME = 'your_resource_group_name'
RESOURCE_NAME = 'your_resource_name'
```

5. Enable health monitoring for the resource using the `monitor_client` object:

```python
monitor_client.service_diagnostic_settings.create_or_update(
    resource_group_name=RESOURCE_GROUP_NAME,
    resource_uri=f"/subscriptions/{SUBSCRIPTION_ID}/resourceGroups/{RESOURCE_GROUP_NAME}/providers/Microsoft.Compute/virtualMachines/{RESOURCE_NAME}",
    parameters={
        "storage_account_id": "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Storage/storageAccounts/{storageAccountName}",
        "metrics": {
            "enabled": True,
            "retentionPolicy": {
                "enabled": True,
                "days": 7
            }
        },
        "logs": {
            "enabled": True,
            "retentionPolicy": {
                "enabled": True,
                "days": 7
            }
        }
    }
)
```

6. Verify that health monitoring is enabled by checking the diagnostic settings:

```python
monitor_client.service_diagnostic_settings.get(
    resource_group_name=RESOURCE_GROUP_NAME,
    resource_uri=f"/subscriptions/{SUBSCRIPTION_ID}/resourceGroups/{RESOURCE_GROUP_NAME}/providers/Microsoft.Compute/virtualMachines/{RESOURCE_NAME}",
    name='default'
)
```

This should remediate the misconfiguration of enabling and configuring health monitoring in Azure using Python.




</Tab>
</Tabs>