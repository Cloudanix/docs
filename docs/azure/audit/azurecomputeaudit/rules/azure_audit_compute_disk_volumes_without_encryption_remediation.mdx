

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal by entering "https://portal.azure.com" in your web browser and enter your login credentials.

2. Navigate to the Disk service: On the left-hand side of the Azure portal, you will find a menu. Click on "All services" and in the new window, search for "Disks". Click on it to open the Disk service.

3. Check Disk Encryption: In the Disk service, you will see a list of all the disks in your Azure environment. Click on each disk to open its overview page. In the overview page, look for the "Encryption type" field. If the field says "Encryption at-rest with a platform-managed key" or "Encryption at-rest with a customer-managed key", then the disk is encrypted. If not, then the disk is not encrypted.

4. Repeat for all disks: Repeat step 3 for all the disks in your Azure environment. Make a note of all the disks that lack encryption.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List all disks: Use the following command to list all the disks in your Azure account. This will return a JSON object with details about each disk.

    ```
    az disk list --query '[].{Name:name, ResourceGroup:resourceGroup, Encryption:encryptionSettingsCollection}'
    ```

3. Parse the output: The output from the previous command will include a field called `Encryption`. If this field is `null` or does not exist, it means that the disk is not encrypted.

4. Filter unencrypted disks: You can modify the command to only return disks that are not encrypted. This can be done by adding a filter to the `--query` parameter.

    ```
    az disk list --query "[?encryptionSettingsCollection==null].{Name:name, ResourceGroup:resourceGroup}"
    ```

This command will return a list of all disks that do not have encryption enabled.

#### Using Python

Detecting disks lacking encryption in Compute across AWS, Azure, and GCP can be done using Python scripts. Here's how you can do it:

1. AWS:
   - Use the Boto3 library in Python to interact with AWS services.
   - Use the `describe_volumes` function to get a list of all EBS volumes.
   - Check the `KmsKeyId` field for each volume. If it's `None`, the volume is not encrypted.
   ```python
   import boto3
   ec2 = boto3.resource('ec2')
   volumes = ec2.volumes.all()
   for volume in volumes:
       if volume.kms_key_id is None:
           print(f"Volume {volume.id} is not encrypted.")
   ```

2. Azure:
   - Use the Azure SDK for Python to interact with Azure services.
   - Use the `list_all` function to get a list of all disks.
   - Check the `encryption_settings` field for each disk. If it's `None`, the disk is not encrypted.
   ```python
   from azure.mgmt.compute import ComputeManagementClient
   compute_client = ComputeManagementClient(credentials, subscription_id)
   disks = compute_client.disks.list_all()
   for disk in disks:
       if disk.encryption_settings is None:
           print(f"Disk {disk.name} is not encrypted.")
   ```

3. GCP:
   - Use the google-cloud-sdk library in Python to interact with GCP services.
   - Use the `list` function to get a list of all disks.
   - Check the `disk_encryption_key` field for each disk. If it's `None`, the disk is not encrypted.
   ```python
   from google.cloud import storage
   storage_client = storage.Client()
   buckets = list(storage_client.list_buckets())
   for bucket in buckets:
       if bucket.default_kms_key_name is None:
           print(f"Bucket {bucket.name} is not encrypted.")
   ```
Please note that you need to have the necessary permissions to access these resources and their encryption settings.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the issue of disks lacking encryption in Azure using the Azure console:

1. Login to your Azure portal (https://portal.azure.com/).

2. On the left-hand side of the portal, click on the "Virtual machines" option under the "Compute" section.

3. Select the virtual machine that has the unencrypted disk(s) that you want to encrypt.

4. In the virtual machine's "Overview" page, click on the "Disks" option in the left-hand menu.

5. Select the unencrypted disk that you want to encrypt, and then click on the "Disk encryption" option in the top menu.

6. In the "Disk encryption" page, click on the "Enable encryption" button.

7. In the "Enable encryption" page, select the Azure Key Vault where you want to store the disk encryption keys, or create a new one if you don't have one already.

8. Click on the "Select" button next to the "Key vault" field, and then select the key vault that you want to use or create a new one.

9. In the "Encryption settings" section, choose the encryption type that you want to use. Azure offers two types of encryption: "Azure managed keys" and "Customer managed keys".

10. If you choose "Azure managed keys", Azure will automatically generate and manage the encryption keys for you. If you choose "Customer managed keys", you will need to provide your own encryption keys.

11. Click on the "Review + create" button to review your settings.

12. If everything looks good, click on the "Create" button to enable encryption for the selected disk.

That's it! The selected disk will now be encrypted using the encryption settings that you specified. Repeat the above steps for any other unencrypted disks that you want to encrypt.

#### Using CLI

To remediate disks lacking encryption in Azure using Azure CLI, you can follow these steps:

1. Open Azure CLI and log in to your Azure account.

2. Run the following command to identify the disks that lack encryption:

   ```
   az disk list --query "[?encryptionSettingsCollection.enabled=='false']"
   ```

   This command will list all the disks that have encryption disabled.

3. Once you have identified the disks that lack encryption, you can enable encryption on them by running the following command:

   ```
   az disk encryption set --resource-group <resource-group-name> --name <disk-name> --encryption-type <encryption-type> --key-source <key-source>
   ```

   Replace `<resource-group-name>` with the name of the resource group that contains the disk, `<disk-name>` with the name of the disk, `<encryption-type>` with the encryption type you want to use (e.g. "EncryptionAtRestWithPlatformKey"), and `<key-source>` with the source of the encryption key (e.g. "Microsoft.Keyvault").

4. Verify that encryption has been enabled on the disk by running the following command:

   ```
   az disk show --resource-group <resource-group-name> --name <disk-name> --query "encryptionSettingsCollection.enabled"
   ```

   This command should return "true" if encryption has been enabled on the disk.

5. Repeat steps 3-4 for all the disks that lack encryption.

By following these steps, you can remediate disks lacking encryption in Azure using Azure CLI.

#### Using Python

To remediate disks lacking encryption in Azure using Python, you can follow these steps:

1. Import the necessary libraries:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.storage import StorageManagementClient
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.network import NetworkManagementClient
```

2. Authenticate with Azure using DefaultAzureCredential:

```python
credential = DefaultAzureCredential()
```

3. Create clients for Compute, Storage, Resource and Network:

```python
compute_client = ComputeManagementClient(credential, subscription_id)
storage_client = StorageManagementClient(credential, subscription_id)
resource_client = ResourceManagementClient(credential, subscription_id)
network_client = NetworkManagementClient(credential, subscription_id)
```

4. Get a list of all VMs in the subscription:

```python
vms = compute_client.virtual_machines.list_all()
```

5. For each VM, check if any of its disks lack encryption. If a disk is found without encryption, enable encryption for that disk:

```python
for vm in vms:
    vm_name = vm.name
    vm_rg = vm.id.split('/')[4]
    disks = compute_client.disks.list_by_resource_group(vm_rg)
    for disk in disks:
        disk_name = disk.name
        disk_rg = disk.id.split('/')[4]
        disk_encryption = compute_client.disks.get_encryption_status(disk_rg, disk_name)
        if not disk_encryption:
            encryption_settings = {
                "disk_encryption_key": {
                    "sourceVault": {
                        "id": "/subscriptions/" + subscription_id + "/resourceGroups/" + vault_rg + "/providers/Microsoft.KeyVault/vaults/" + vault_name
                    },
                    "secretUrl": secret_url
                },
                "keyEncryptionKey": {
                    "keyUrl": key_url,
                    "sourceVault": {
                        "id": "/subscriptions/" + subscription_id + "/resourceGroups/" + vault_rg + "/providers/Microsoft.KeyVault/vaults/" + vault_name
                    }
                }
            }
            compute_client.disks.enable_encryption(disk_rg, disk_name, encryption_settings)
```

Note that you will need to replace the variables `subscription_id`, `vault_rg`, `vault_name`, `secret_url`, and `key_url` with the appropriate values for your environment.


</Tab>
</Tabs>