

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal and navigate to the "Disk" service. Here you can see all the disks that are currently in your Azure environment.

2. Click on the disk that you want to check for server-side encryption. This will open the disk's properties page.

3. In the properties page, look for the "Encryption" section. If the disk is encrypted using a customer-managed key (CMK), it will show "Encryption type: Customer-managed key".

4. To verify the key, click on the "Encryption settings" link. This will open a new page where you can see the details of the key that is being used for encryption. If the key is not present or not properly configured, it indicates a misconfiguration.

#### Using CLI

1. Install and configure Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine and sign in to your Azure account. You can install Azure CLI by following the instructions provided by Microsoft. Once installed, you can sign in to your Azure account using the following command:

   ```
   az login
   ```

2. List all the disks: Once you are signed in, you can list all the disks in your Azure account using the following command:

   ```
   az disk list --query "[].{Name:name, ResourceGroup:resourceGroup, Encryption:encryptionSettingsCollection}"
   ```

   This command will return a list of all the disks in your Azure account along with their names, resource groups, and encryption settings.

3. Check the encryption settings: From the output of the previous command, you can check the encryption settings of each disk. If the encryption type is not 'EncryptionAtRestWithCustomerKey', then the disk is not encrypted using a customer-managed key (CMK).

4. Check if the disk is attached: To check if a disk is attached to a virtual machine, you can use the following command:

   ```
   az vm show --name <vm-name> --resource-group <resource-group-name> --query "storageProfile.dataDisks"
   ```

   Replace `<vm-name>` and `<resource-group-name>` with the name of your virtual machine and resource group respectively. This command will return a list of all the data disks attached to the specified virtual machine. If the disk is not in this list, then it is unattached.

#### Using Python

1. AWS:
   - Install and configure AWS SDK for Python (Boto3).
   - Use the `describe_volumes` method to list all EBS volumes.
   - For each volume, check the `KmsKeyId` attribute. If it's `None`, the volume is not encrypted with a CMK.
   - Python script:
     ```python
     import boto3
     ec2 = boto3.resource('ec2')
     volumes = ec2.volumes.all()
     for volume in volumes:
         if volume.kms_key_id is None:
             print(f"Volume {volume.id} is not encrypted with a CMK.")
     ```

2. Azure:
   - Install and configure Azure SDK for Python.
   - Use the `list_all` method from `DiskOperations` class to list all disks.
   - For each disk, check the `encryption` attribute. If it's `None`, the disk is not encrypted with a CMK.
   - Python script:
     ```python
     from azure.mgmt.compute import ComputeManagementClient
     compute_client = ComputeManagementClient(credentials, subscription_id)
     disks = compute_client.disks.list_all()
     for disk in disks:
         if disk.encryption is None:
             print(f"Disk {disk.name} is not encrypted with a CMK.")
     ```

3. GCP:
   - Install and configure Google Cloud SDK for Python.
   - Use the `list` method from `Disks` class to list all disks.
   - For each disk, check the `diskEncryptionKey` attribute. If it's `None`, the disk is not encrypted with a CMK.
   - Python script:
     ```python
     from google.cloud import compute_v1
     client = compute_v1.DisksClient()
     disks = client.list(project=project, zone=zone)
     for disk in disks:
         if disk.disk_encryption_key is None:
             print(f"Disk {disk.name} is not encrypted with a CMK.")
     ```

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration of Server Side Encryption for Unattached Disk using CMK in Azure:

1. Login to the Azure portal (https://portal.azure.com/).
2. Navigate to the Azure Disk Encryption extension.
3. Click on "Disk Encryption Sets" on the left-hand side menu.
4. Select the disk encryption set that you want to remediate.
5. Click on the "Key vault" tab.
6. Select the Key Vault that you want to use for encryption.
7. Click on "Save" to save the changes.

Once you have completed these steps, Azure will encrypt the unattached disks using the CMK specified in the Key Vault that you selected.

#### Using CLI

To remediate the misconfiguration of server-side encryption for unattached disk using CMK in Azure using Azure CLI, you can follow these steps:

1. Firstly, you need to identify the unattached disks in your Azure subscription. You can use the following Azure CLI command to list all the unattached disks:

   `az disk list --query "[?managedBy==null]"`

2. Once you have identified the unattached disks, you can use the following Azure CLI command to enable server-side encryption for those disks using a customer-managed key (CMK):

   `az disk encryption set --resource-group <resource-group-name> --name <disk-name> --encryption-type EncryptionAtRestWithCustomerKey --disk-encryption-key <key-uri> --key-encryption-key <key-uri>`

   Here, replace `<resource-group-name>` with the name of the resource group containing the unattached disk, `<disk-name>` with the name of the unattached disk, `<key-uri>` with the URI of the customer-managed key (CMK) that you want to use for encryption.

3. Once the encryption is enabled for the unattached disk, you can verify the encryption status using the following Azure CLI command:

   `az disk show --resource-group <resource-group-name> --name <disk-name> --query "encryptionSettings.collection[].diskEncryptionKey"`

   This command will show the encryption status of the disk and the key used for encryption.

4. Repeat the above steps for all the unattached disks in your Azure subscription to ensure that they are all encrypted using a customer-managed key (CMK).

By following the above steps, you can remediate the misconfiguration of server-side encryption for unattached disk using CMK in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of Server Side Encryption for Unattached Disk using CMK in Azure using Python, you can follow the below steps:

1. Install the Azure SDK for Python using the following command:

```
pip install azure-mgmt-compute
```

2. Authenticate with Azure by creating a service principal and assigning the appropriate permissions.

3. Use the following Python code to enable Server Side Encryption for Unattached Disk using CMK:

```python
from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.compute.models import DiskEncryptionSetParameters, EncryptionSetIdentity
from azure.mgmt.resource import ResourceManagementClient

# Set subscription ID, resource group name, disk name, and encryption set name
subscription_id = '<subscription_id>'
resource_group_name = '<resource_group_name>'
disk_name = '<disk_name>'
encryption_set_name = '<encryption_set_name>'

# Set service principal credentials
credentials = ServicePrincipalCredentials(
    client_id='<client_id>',
    secret='<client_secret>',
    tenant='<tenant_id>'
)

# Create compute and resource management clients
compute_client = ComputeManagementClient(credentials, subscription_id)
resource_client = ResourceManagementClient(credentials, subscription_id)

# Get the resource ID of the disk
disk = compute_client.disks.get(resource_group_name, disk_name)
disk_id = disk.id

# Get the resource ID of the encryption set
encryption_set = resource_client.resources.get_by_id(encryption_set_name, api_version='2019-04-01')
encryption_set_id = encryption_set.id

# Create encryption set parameters
encryption_set_params = DiskEncryptionSetParameters(
    identity=EncryptionSetIdentity(
        type='DiskEncryptionSetIdentity',
        resource_id=encryption_set_id
    )
)

# Update the disk with encryption set parameters
compute_client.disks.update(
    resource_group_name=resource_group_name,
    disk_name=disk_name,
    disk_encryption_set=encryption_set_params
)
```

4. Replace the placeholders `<subscription_id>`, `<resource_group_name>`, `<disk_name>`, `<encryption_set_name>`, `<client_id>`, `<client_secret>`, and `<tenant_id>` with the appropriate values.

5. Run the Python script to enable Server Side Encryption for Unattached Disk using CMK in Azure.

Note: This code assumes that the disk and encryption set are in the same subscription and region. If they are in different subscriptions or regions, you will need to modify the code accordingly.


</Tab>
</Tabs>