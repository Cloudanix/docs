---
slug: server_side_encryption_boot_disk_cmk
title: Server Side Encryption for Boot Disk using CMK
sidebar_label: Server Side Encryption for Boot Disk using CMK
---

### More Info:

Microsoft Azure provides multiple distinct layers of encryption protection for virtual machine (VM) managed disks. VM managed disks are encrypted with Azure Storage encryption, also known as Server-Side Encryption (SSE), using platform-managed keys (PMK), to protect your data at rest and help you meet your organizational security and compliance commitments. By default, VM managed disk volumes (OS and data disk volumes) use platform-managed encryption keys.

### Risk Level

High

### Address

Security

### Compliance Standards

ISO27001, HIPAA, CISAZURE, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal and navigate to the "Virtual Machines" section. Here, you will see a list of all your virtual machines.

2. Click on the name of the virtual machine for which you want to check the server-side encryption. This will open the virtual machine's dashboard.

3. In the virtual machine's dashboard, navigate to the "Disks" section. Here, you will see a list of all the disks attached to the virtual machine.

4. Click on the name of the boot disk. This will open the disk's dashboard. In the "Settings" section, look for the "Encryption" field. If the encryption is set to "Server-side encryption with customer-managed key", then the boot disk is encrypted using a customer-managed key (CMK). If not, then the boot disk is not encrypted using a CMK.

#### Using CLI

1. First, you need to install the Azure CLI on your local machine. You can download it from the official Microsoft website. Once installed, open your command prompt or terminal.

2. Login to your Azure account using the following command:
   ```
   az login
   ```
   Follow the instructions on the screen to complete the login process.

3. Now, you need to list all the disks in your Azure account. You can do this using the following command:
   ```
   az disk list --query "[].{name:name, resourceGroup:resourceGroup, encryption:encryptionSettingsCollection}"
   ```
   This command will list all the disks along with their encryption settings.

4. To check if Server Side Encryption for Boot Disk using CMK is enabled, you need to look at the 'encryption' field in the output of the previous command. If the 'encryption' field is not null and the 'encryptionType' is 'EncryptionAtRestWithCustomerKey', then Server Side Encryption for Boot Disk using CMK is enabled. If not, then it is not enabled.

#### Using Python

To check Server Side Encryption for Boot Disk using Customer-Managed Key (CMK) in Google Cloud Platform (GCP) Compute Engine, you can use the Google Cloud SDK (gcloud) or the Google Cloud Client Libraries for Python. Here are the steps:

1. **Setup Google Cloud SDK and Authentication:**
   Before you can interact with GCP resources using Python, you need to set up authentication. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key JSON file.

   ```python
   import os
   os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="/path/to/your/service-account-file.json"
   ```

2. **Install Google Cloud Client Libraries for Python:**
   You can install the Google Cloud Client Libraries for Python using pip. The library for Compute Engine is `google-cloud-compute`.

   ```bash
   pip install --upgrade google-cloud-compute
   ```

3. **List Disks and Check Encryption:**
   You can list all the disks in a project and check if they are encrypted with a customer-managed key. Here is a sample Python script:

   ```python
   from google.cloud import compute_v1

   def list_disks(project, zone):
       client = compute_v1.DisksClient()
       response = client.list(project=project, zone=zone)

       for disk in response:
           print(f"Disk: {disk.name}")
           print(f"Encryption type: {disk.disk_encryption_key.kind}")
           if disk.disk_encryption_key.kind == 'compute#customerEncryptionKey':
               print("Disk is encrypted with a customer-managed key.")
           else:
               print("Disk is not encrypted with a customer-managed key.")

   list_disks('your-project-id', 'your-zone')
   ```

4. **Interpret the Results:**
   If a disk is encrypted with a customer-managed key, the `kind` field of the `disk_encryption_key` object will be `compute#customerEncryptionKey`. If it is not, then the disk is not encrypted with a customer-managed key.

Please replace 'your-project-id' and 'your-zone' with your actual project ID and zone.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Server Side Encryption for Boot Disk using CMK in Azure, follow the below steps:

1. Login to the Azure portal (https://portal.azure.com/)
2. Navigate to the virtual machine which needs to be remediated.
3. Click on "Disks" under the "Settings" section of the virtual machine.
4. Select the boot disk that needs to be encrypted.
5. In the "Encryption Settings" section, click on "Disk encryption set".
6. Click on "Create new" to create a new disk encryption set.
7. Select the appropriate subscription, resource group and region.
8. Provide a name for the disk encryption set and select the key vault which contains the Customer Managed Key (CMK).
9. Click on "Create" to create the disk encryption set.
10. Once the disk encryption set is created, select the disk encryption set from the "Encryption Settings" section of the boot disk.
11. Click on "Save" to save the changes.

The boot disk of the virtual machine will now be encrypted using the Customer Managed Key (CMK) stored in the selected key vault.

#### Using CLI

To remediate the misconfiguration of Server Side Encryption for Boot Disk using CMK in Azure, you can follow the below steps using Azure CLI:

1. Open Azure CLI and login to your Azure account using the command: 

   `az login`

2. Once you are logged in, run the following command to identify the VM's boot disk that needs to be encrypted:

   `az vm show -g <resource-group-name> -n <vm-name> --query storageProfile.osDisk.managedDisk.id -o tsv`

3. Once you have identified the boot disk, run the following command to enable encryption on the boot disk using a customer-managed key:

   `az disk encryption set --resource-group <resource-group-name> --name <disk-name> --key-url <key-url> --encryption-type <EncryptionType>`

   Replace the following parameters in the command:

   - `<resource-group-name>`: Name of the resource group where the VM is located.
   - `<disk-name>`: Name of the disk that needs to be encrypted.
   - `<key-url>`: URL of the customer-managed key that needs to be used for encryption.
   - `<EncryptionType>`: Type of encryption to be used. In this case, it would be "EncryptionAtRestWithCustomerKey".

4. Once the encryption is enabled, you can verify the status of the encryption using the following command:

   `az disk encryption show --resource-group <resource-group-name> --name <disk-name> --query encryptionSettingsCollection -o json`

   This command will return the encryption settings for the disk in JSON format.

By following the above steps, you can remediate the misconfiguration of Server Side Encryption for Boot Disk using CMK in Azure using Azure CLI.

#### Using Python

To remediate Server Side Encryption for Boot Disk using CMK misconfiguration in Azure using Python, you can follow the below steps:

1. Import the necessary libraries:

```python
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.compute.models import DiskEncryptionSetParameters, EncryptionSettings, DiskEncryptionSettings, KeyVaultSecretReference
from azure.identity import DefaultAzureCredential
```

2. Set the credentials for authentication:

```python
credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'
resource_group = 'your-resource-group'
```

3. Create an instance of the ComputeManagementClient:

```python
compute_client = ComputeManagementClient(credential, subscription_id)
```

4. Get the virtual machine details:

```python
vm_name = 'your-vm-name'
vm = compute_client.virtual_machines.get(resource_group, vm_name)
```

5. Get the OS disk details:

```python
os_disk_name = vm.storage_profile.os_disk.name
os_disk = compute_client.disks.get(resource_group, os_disk_name)
```

6. Create a DiskEncryptionSetParameters object:

```python
disk_encryption_set_parameters = DiskEncryptionSetParameters(
    identity=None,
    encryption_type='EncryptionAtRestWithCustomerKey',
    disk_encryption_key=None,
    key_encryption_key=None
)
```

7. Create an EncryptionSettings object:

```python
encryption_settings = EncryptionSettings(
    enabled=True,
    disk_encryption_set_id='your-disk-encryption-set-id'
)
```

8. Create a DiskEncryptionSettings object:

```python
disk_encryption_settings = DiskEncryptionSettings(
    disk_encryption_key=None,
    key_encryption_key=None,
    enabled=True,
    encryption_settings=encryption_settings
)
```

9. Create a KeyVaultSecretReference object:

```python
key_vault_secret_reference = KeyVaultSecretReference(
    source_vault=None,
    secret_url='your-cmk-secret-url'
)
```

10. Update the OS disk with the new encryption settings:

```python
os_disk.encryption_settings = disk_encryption_settings
os_disk.encryption_settings.disk_encryption_settings.disk_encryption_key.secret_url = key_vault_secret_reference.secret_url
os_disk.encryption_settings.disk_encryption_settings.disk_encryption_key.source_vault = key_vault_secret_reference.source_vault
compute_client.disks.create_or_update(resource_group, os_disk_name, os_disk)
```

Note: Make sure to replace the placeholders (your-subscription-id, your-resource-group, your-vm-name, your-disk-encryption-set-id, your-cmk-secret-url) with the actual values.

These steps will remediate the Server Side Encryption for Boot Disk using CMK misconfiguration in Azure using Python.




</Tab>
</Tabs>