

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal using your credentials.
2. Navigate to the "Virtual Machines" section from the left-hand side menu. Here, you will see a list of all the virtual machines that are currently running in your Azure environment.
3. Select the virtual machine for which you want to check the Performance Diagnostics. This will open the dashboard for that specific virtual machine.
4. In the virtual machine dashboard, scroll down to the "Monitoring" section and click on "Performance Diagnostics". If Performance Diagnostics is enabled, you will see a list of diagnostic settings. If it is not enabled, the Performance Diagnostics section will be empty or will prompt you to enable it.

#### Using CLI

1. Install Azure CLI: Before you can use Azure CLI to detect misconfigurations, you need to install it. You can download it from the official Microsoft website and install it on your local machine.

2. Login to Azure Account: After installing Azure CLI, open your command prompt and type the following command to login to your Azure account:

   ```
   az login
   ```
   Follow the instructions on the screen to complete the login process.

3. Select the Subscription: If you have multiple subscriptions, you need to select the subscription where the virtual machine is located. Use the following command to set the subscription:

   ```
   az account set --subscription "mySubscription"
   ```

4. Check Performance Diagnostics: Now, you can check if Performance Diagnostics is enabled for a specific virtual machine. Use the following command:

   ```
   az vm monitor log show --name "myVM" --resource-group "myResourceGroup"
   ```
   Replace "myVM" with the name of your virtual machine and "myResourceGroup" with the name of your resource group. If Performance Diagnostics is enabled, you will see it in the output. If it's not enabled, it won't be listed in the output.

#### Using Python

1. Install Azure SDK: To interact with Azure resources, you need to install Azure SDK in your Python environment. You can do this by running the command `pip install azure-mgmt-compute`.

2. Import necessary modules: Import the necessary modules in your Python script. You will need the `ComputeManagementClient` from `azure.mgmt.compute` and `DefaultAzureCredential` from `azure.identity`.

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient
```

3. Authenticate and initialize: Use the `DefaultAzureCredential` to authenticate your script with Azure. Then, initialize the `ComputeManagementClient` with your subscription ID.

```python
credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'
compute_client = ComputeManagementClient(credential, subscription_id)
```

4. Check Performance Diagnostics: Now, you can use the `compute_client` to get a list of all virtual machines in your subscription and check if Performance Diagnostics is enabled. 

```python
for vm in compute_client.virtual_machines.list_all():
    vm_extension = compute_client.virtual_machine_extensions.get('your-resource-group', vm.name, 'Microsoft.Insights.VMDiagnosticsSettings')
    if not vm_extension.settings['enabled']:
        print(f'Performance Diagnostics is not enabled for VM: {vm.name}')
```

This script will print the names of all virtual machines for which Performance Diagnostics is not enabled. Replace 'your-resource-group' with the name of your resource group.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To enable Performance Diagnostics for Azure Virtual Machines, you can follow the below steps:

1. Log in to the Azure portal (https://portal.azure.com/).

2. In the left-hand menu, click on "Virtual machines".

3. Select the virtual machine that you want to enable Performance Diagnostics for.

4. In the virtual machine menu, click on "Diagnostic settings" under the Monitoring section.

5. Click on the "Add diagnostic setting" button.

6. In the "Add diagnostic setting" blade, give a name to the setting.

7. Under "Metrics", select the "Performance counters" option.

8. Click on the "Add +" button to add a new performance counter.

9. In the "Add performance counter" blade, select the desired counter from the list.

10. Click on the "Add" button to add the performance counter.

11. Under "Logs", select the "Performance counters" option.

12. Click on the "Add +" button to add a new performance counter.

13. In the "Add performance counter" blade, select the desired counter from the list.

14. Click on the "Add" button to add the performance counter.

15. Click on the "Save" button to save the diagnostic setting.

Once you have completed the above steps, Performance Diagnostics will be enabled for the selected Azure virtual machine. You can view the collected metrics and logs in the Azure portal by navigating to the "Metrics" and "Logs" sections respectively.

#### Using CLI

To enable performance diagnostics for Azure Virtual Machines using Azure CLI, follow these steps:

1. Open the Azure CLI command prompt.

2. Set the subscription that contains the virtual machine. Use the following command to set the subscription:

   ```
   az account set --subscription <subscription-id>
   ```

3. Enable performance diagnostics for the virtual machine. Use the following command to enable performance diagnostics:

   ```
   az vm diagnostics set --resource-group <resource-group-name> --vm-name <vm-name> --settings "{
     \"performanceCounters\": {
       \"sinks\": [
         {
           \"name\": \"<sink-name>\",
           \"destination\": {
             \"storageUri\": \"<storage-account-uri>\",
             \"sasToken\": \"<sas-token>\"
           }
         }
       ],
       \"performanceCounters\": [
         {
           \"category\": \"<category>\",
           \"counterSpecifier\": \"<counter-specifier>\",
           \"samplingInterval\": \"<sampling-interval>\",
           \"unit\": \"<unit>\"
         }
       ]
     }
   }"
   ```

   Replace the following values in the command:

   - `<resource-group-name>`: The name of the resource group that contains the virtual machine.
   - `<vm-name>`: The name of the virtual machine.
   - `<sink-name>`: The name of the sink that will receive the performance data.
   - `<storage-account-uri>`: The URI of the storage account that will receive the performance data.
   - `<sas-token>`: The SAS token for the storage account.
   - `<category>`: The category of the performance counter.
   - `<counter-specifier>`: The name of the performance counter.
   - `<sampling-interval>`: The sampling interval for the performance counter.
   - `<unit>`: The unit of the performance counter.

4. Verify that performance diagnostics have been enabled for the virtual machine. Use the following command to verify the settings:

   ```
   az vm diagnostics get-default-config --is-windows-os --resource-group <resource-group-name> --vm-name <vm-name>
   ```

   Replace `<resource-group-name>` and `<vm-name>` with the actual resource group and virtual machine names.

   The command will return the default configuration for the virtual machine. Verify that the performance counters are included in the configuration.

That's it! Performance diagnostics have been enabled for the Azure Virtual Machine.

#### Using Python

To enable Performance Diagnostics for Azure Virtual Machines using Python, you can use the Azure SDK for Python. Here are the step-by-step instructions:

1. Install the Azure SDK for Python. You can install it using pip by running the following command:

```
pip install azure-mgmt-compute
```

2. Authenticate with Azure. You can authenticate using a service principal or user credentials. Here's an example of how to authenticate using a service principal:

```python
from azure.common.credentials import ServicePrincipalCredentials

TENANT_ID = '<your tenant id>'
CLIENT_ID = '<your client id>'
CLIENT_SECRET = '<your client secret>'

credentials = ServicePrincipalCredentials(
    client_id=CLIENT_ID,
    secret=CLIENT_SECRET,
    tenant=TENANT_ID
)
```

3. Create a `ComputeManagementClient` object using the authenticated credentials:

```python
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.compute.models import DiagnosticsProfile, BootDiagnostics

SUBSCRIPTION_ID = '<your subscription id>'
RESOURCE_GROUP_NAME = '<your resource group name>'
VM_NAME = '<your virtual machine name>'

compute_client = ComputeManagementClient(credentials, SUBSCRIPTION_ID)
```

4. Get the virtual machine object:

```python
vm = compute_client.virtual_machines.get(
    RESOURCE_GROUP_NAME,
    VM_NAME
)
```

5. Enable Performance Diagnostics for the virtual machine:

```python
diagnostics_profile = DiagnosticsProfile(
    boot_diagnostics=BootDiagnostics(
        enabled=True,
        storage_uri='<your storage account uri>'
    )
)

vm.diagnostics_profile = diagnostics_profile

compute_client.virtual_machines.create_or_update(
    RESOURCE_GROUP_NAME,
    VM_NAME,
    vm
)
```

Replace `<your tenant id>`, `<your client id>`, `<your client secret>`, `<your subscription id>`, `<your resource group name>`, `<your virtual machine name>`, and `<your storage account uri>` with the appropriate values.

These steps will enable Performance Diagnostics for the specified Azure Virtual Machine.


</Tab>
</Tabs>