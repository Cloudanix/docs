---
slug: cmk_virtual_hard_disk_encryption
title: Use Customer Managed Keys for Virtual Hard Disk Encryption
sidebar_label: Use Customer Managed Keys for Virtual Hard Disk Encryption
---

### More Info:

Ensure that your Microsoft Azure Virtual Hard Disk (VHD) volumes are using Customer Managed Keys (CMKs) instead of Platform-Managed Keys (PMKs â€“ default keys used by Microsoft Azure for disk encryption) in order to have full control over your VHD data encryption and decryption process. Virtual Hard Disks are the old style disks that were attached to Azure virtual machines (VMs). VHDs are stored in blob storage accounts.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, SOC2, NISTCSF, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal.

2. Navigate to the "Virtual Machines" section. Here, you will see a list of all the virtual machines that are currently running in your Azure environment.

3. Select the virtual machine for which you want to check the encryption status. In the virtual machine's dashboard, click on the "Disks" option in the left-hand menu.

4. In the Disks pane, you will see information about the OS disk and any data disks attached to the virtual machine. Look for the "Disk Encryption Set" column. If the disk is encrypted using a customer-managed key, the name of the Disk Encryption Set that contains the customer-managed key will be displayed in this column. If the column is blank, then the disk is not encrypted with a customer-managed key.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal and type `az login` to log in to your Azure account.

2. List all the disks: Use the following command to list all the disks in your Azure account. This will return a list of all the disks along with their properties.

    ```
    az disk list --query '[].{Name:name, ResourceGroup:resourceGroup, EncryptionType:encryption.type, DiskEncryptionSetId:encryption.diskEncryptionSet.id}' -o table
    ```

3. Check the encryption type: From the output of the above command, check the 'EncryptionType' column. If the value is 'EncryptionAtRestWithPlatformAndCustomerKeys', it means that the disk is encrypted using customer-managed keys.

4. Check the DiskEncryptionSetId: If the disk is encrypted using customer-managed keys, there should be a value in the 'DiskEncryptionSetId' column. This is the ID of the Disk Encryption Set that contains the customer-managed key used for encryption. If this column is empty, it means that the disk is not encrypted using a customer-managed key.

Remember, the above steps only help in detecting whether a disk is encrypted using a customer-managed key or not. If you find any disk that is not encrypted using a customer-managed key, you need to take appropriate actions to remediate it.

#### Using Python

To check if Customer Managed Keys are used for Virtual Hard Disk Encryption in Azure Compute, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: You can install the Azure SDK for Python using pip. Run the following command in your terminal:
   ```
   pip install azure-mgmt-compute
   ```
2. **Authenticate with Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for Python to authenticate. Here is a sample code snippet:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.compute import ComputeManagementClient

   credential = DefaultAzureCredential()
   compute_client = ComputeManagementClient(credential, "<your_subscription_id>")
   ```
3. **List all the disks and check for encryption settings**: You can list all the disks in your subscription and check if they are encrypted with a customer-managed key. Here is a sample code snippet:
   ```python
   disks = compute_client.disks.list()
   for disk in disks:
       if disk.encryption.type == "EncryptionAtRestWithCustomerKey":
           print(f"Disk {disk.name} is encrypted with a customer-managed key.")
       else:
           print(f"Disk {disk.name} is not encrypted with a customer-managed key.")
   ```
4. **Check the output**: The script will print the names of all disks and whether they are encrypted with a customer-managed key. If a disk is not encrypted with a customer-managed key, it means that it is a misconfiguration.

Please replace `<your_subscription_id>` with your actual Azure subscription ID.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Use Customer Managed Keys for Virtual Hard Disk Encryption" for Azure using the Azure console, follow the below steps:

1. Open the Azure portal and log in to your account.

2. Navigate to the virtual machine that you want to remediate.

3. Select the virtual machine and click on the "Disks" option in the left-hand side menu.

4. Select the disk that you want to encrypt with customer-managed keys.

5. Click on the "Disk Encryption" option in the top menu.

6. In the Disk Encryption pane, select "Customer Managed Keys" as the encryption type.

7. Click on the "Select a Key" option and choose the key that you want to use for encryption.

8. Click on the "Save" button to save the changes.

9. Wait for the encryption process to complete. 

Once the encryption process is complete, the virtual machine disk will be encrypted with the customer-managed key.

#### Using CLI

To remediate the misconfiguration "Use Customer Managed Keys for Virtual Hard Disk Encryption" for Azure using Azure CLI, follow the below steps:

1. Open Azure CLI and log in to your Azure account.

2. Create a new customer-managed key in Azure Key Vault using the below command:

   `az keyvault key create --vault-name <key-vault-name> --name <key-name> --protection software`

   Replace `<key-vault-name>` with the name of your Azure Key Vault and `<key-name>` with a name for your new key.

3. Retrieve the key ID of the newly created key using the below command:

   `az keyvault key show --vault-name <key-vault-name> --name <key-name> --query key.kid -o tsv`

   This command will return the key ID in the format: 

   `/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.KeyVault/vaults/<key-vault-name>/keys/<key-name>/<key-version>`

4. Update the virtual hard disk (VHD) to use the customer-managed key for encryption using the below command:

   `az disk encryption set --resource-group <resource-group-name> --name <disk-name> --key-url <key-id> --key-vault <key-vault-name> --encryption-type <encryption-type>`

   Replace `<resource-group-name>` with the name of the resource group containing the VHD, `<disk-name>` with the name of the VHD to be encrypted, `<key-id>` with the key ID retrieved in step 3, `<key-vault-name>` with the name of the Azure Key Vault, and `<encryption-type>` with the type of encryption to use (e.g. "AES256").

5. Verify that the disk encryption is enabled by running the below command:

   `az disk encryption show --resource-group <resource-group-name> --name <disk-name>`

   This command will return the encryption status of the disk.

By following the above steps, you can remediate the misconfiguration "Use Customer Managed Keys for Virtual Hard Disk Encryption" for Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration "Use Customer Managed Keys for Virtual Hard Disk Encryption" for AZURE using Python, you can follow the below steps:

Step 1: Import the required libraries and authenticate to Azure

```
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.resource import ResourceManagementClient

credential = DefaultAzureCredential()
compute_client = ComputeManagementClient(
    credential=credential,
    subscription_id='<subscription-id>'
)
resource_client = ResourceManagementClient(
    credential=credential,
    subscription_id='<subscription-id>'
)
```

Step 2: Get the list of virtual machines in the subscription

```
vm_list = compute_client.virtual_machines.list_all()
```

Step 3: For each virtual machine, check if the virtual hard disk is encrypted with a customer managed key. If not, update the encryption settings to use a customer managed key.

```
for vm in vm_list:
    for disk in vm.storage_profile.data_disks:
        if not disk.disk_encryption_settings or not disk.disk_encryption_settings.enabled:
            # Update the encryption settings to use customer managed key
            disk.disk_encryption_settings = {
                'enabled': True,
                'disk_encryption_key': {
                    'source': 'Microsoft.Keyvault',
                    'vault_uri': '<key-vault-uri>',
                    'secret_url': '<key-secret-url>'
                }
            }
            compute_client.virtual_machines.create_or_update(
                resource_group_name=vm.id.split('/')[4],
                vm_name=vm.name,
                parameters=vm
            )
```

Note: Replace the `<subscription-id>`, `<key-vault-uri>` and `<key-secret-url>` placeholders with the actual values.

By following the above steps, you can remediate the misconfiguration "Use Customer Managed Keys for Virtual Hard Disk Encryption" for AZURE using Python.




</Tab>
</Tabs>