---
slug: managed_disk_volumes_vm
title: Use Managed Disk Volumes for Virtual Machines
sidebar_label: Use Managed Disk Volumes for Virtual Machines
---

### More Info:

Ensure that your Microsoft Azure virtual machines (VMs) are configured to use managed disk volumes for reliable, efficient and simplified disk management. A managed disk is an abstraction of current Standard/Premium storage disk in Azure Storage. Managed disks provide granular access control with RBAC and better reliability for the virtual machines deployed within an Azure Availability Set.

### Risk Level

Medium

### Address

Security

### Compliance Standards




<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to the Azure portal (https://portal.azure.com/) and sign in with your Azure account credentials.

2. Navigate to Virtual Machines: From the left-hand side menu, select "Virtual Machines". This will display a list of all the virtual machines that are currently running in your Azure environment.

3. Check Disk Type: Click on the name of the virtual machine you want to check. This will open the virtual machine's dashboard. From here, select "Disks" from the left-hand side menu. This will display information about the disks attached to the virtual machine.

4. Verify Managed Disk: In the Disks pane, look at the "Type" column. If the disk is a managed disk, it will say "Managed" in this column. If it says "Unmanaged", then the virtual machine is using unmanaged disk volumes.

#### Using CLI

1. Install Azure CLI: Before you can use the Azure CLI commands, you need to have the Azure CLI installed on your system. You can download and install it from the official Azure website.

2. Login to Azure: Use the following command to login to your Azure account. You will be prompted to enter your username and password.
   ```
   az login
   ```
3. List all Virtual Machines: Use the following command to list all the virtual machines in your Azure account. This will give you a list of all the VMs along with their details.
   ```
   az vm list --output table
   ```
4. Check for Managed Disks: For each VM in the list, use the following command to check if it is using Managed Disks. Replace 'YourResourceGroup' with the name of your resource group and 'YourVM' with the name of your VM. If the "storageProfile.osDisk.managedDisk" field is null, then the VM is not using Managed Disks.
   ```
   az vm show --resource-group YourResourceGroup --name YourVM --query "storageProfile.osDisk.managedDisk"
   ```
   If the output is null, then the VM is not using Managed Disks. If it returns an object, then the VM is using Managed Disks.

#### Using Python

To check if Managed Disk Volumes are being used for Virtual Machines in Azure Compute, you can use the Azure SDK for Python. Here are the steps:

1. **Install Azure SDK for Python**: You need to install the Azure SDK for Python if it's not already installed. You can install it using pip:
   ```python
   pip install azure-mgmt-compute
   ```
2. **Authenticate with Azure**: Before you can interact with Azure resources, you need to authenticate. You can use Azure Identity library for this. Here is a sample code:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.compute import ComputeManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   compute_client = ComputeManagementClient(credential, subscription_id)
   ```
3. **List all VMs and check for Managed Disks**: Now, you can list all the VMs in your subscription and check if they are using Managed Disks. Here is a sample code:
   ```python
   for vm in compute_client.virtual_machines.list_all():
       if not vm.storage_profile.os_disk.managed_disk:
           print(f"VM {vm.name} is not using Managed Disks")
   ```
4. **Interpret the Results**: If the script prints out any VM names, those VMs are not using Managed Disks. If no VM names are printed, all VMs in your subscription are using Managed Disks.

Please replace 'your-subscription-id' with your actual Azure subscription ID. Also, ensure that the account you're using for authentication has the necessary permissions to list and view details of VMs in the subscription.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Use Managed Disk Volumes for Virtual Machines" in AZURE using the AZURE console, follow these steps:

1. Login to your AZURE account and go to the AZURE portal.

2. Click on the "Virtual Machines" option from the left-hand menu.

3. Select the virtual machine for which you want to remediate the misconfiguration.

4. Click on the "Disks" option from the left-hand menu.

5. Check if the virtual machine is using managed disks or not. If it is not using managed disks, then you need to migrate the virtual machine to use managed disks.

6. To migrate the virtual machine to use managed disks, click on the "Migrate to managed disks" option from the top menu.

7. In the "Migrate to managed disks" window, select the subscription, resource group, and virtual machine that you want to migrate.

8. Click on the "Review + create" button to review the migration settings.

9. Review the migration settings and click on the "Create" button to start the migration process.

10. Once the migration process is completed, go back to the "Disks" option and verify that the virtual machine is now using managed disks.

11. Repeat the above steps for all the virtual machines in your AZURE environment that are not using managed disks.

By following the above steps, you can remediate the misconfiguration "Use Managed Disk Volumes for Virtual Machines" in AZURE using the AZURE console.

#### Using CLI

To remediate the misconfiguration "Use Managed Disk Volumes for Virtual Machines" in AZURE using AZURE CLI, follow the below steps:

Step 1: Login to your AZURE account using AZURE CLI by running the command below:
```
az login
```

Step 2: Once you have logged in successfully, run the command below to list all the virtual machines in your subscription:
```
az vm list --query "[].{Name:name, ResourceGroup:resourceGroup}"
```

Step 3: Choose the virtual machine that you want to remediate and run the command below to convert the virtual machine's unmanaged disk to a managed disk:
```
az vm convert -g <resource-group-name> -n <vm-name> --force
```
Note: Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located, and `<vm-name>` with the name of the virtual machine that you want to remediate.

Step 4: Wait for the conversion to complete. Once the conversion is complete, the virtual machine's unmanaged disk will be replaced with a managed disk.

Step 5: Verify that the virtual machine's unmanaged disk has been replaced with a managed disk by running the command below:
```
az vm show -g <resource-group-name> -n <vm-name> --query "storageProfile.osDisk.managedDisk"
```
Note: Replace `<resource-group-name>` with the name of the resource group where the virtual machine is located, and `<vm-name>` with the name of the virtual machine that you want to remediate.

Step 6: Repeat the above steps for all the virtual machines in your subscription to ensure that they are using managed disk volumes.

By following the above steps, you can remediate the misconfiguration "Use Managed Disk Volumes for Virtual Machines" in AZURE using AZURE CLI.

#### Using Python

To remediate the misconfiguration of not using Managed Disk Volumes for Virtual Machines in Azure using Python, you can use the Azure SDK for Python. Here are the steps to remediate it:

1. Import the necessary packages:

```python
from azure.identity import AzureCliCredential
from azure.mgmt.compute import ComputeManagementClient
```

2. Authenticate with Azure using Azure CLI credentials:

```python
credential = AzureCliCredential()
subscription_id = '<your-subscription-id>'
compute_client = ComputeManagementClient(credential, subscription_id)
```

3. Get a list of all the virtual machines in your subscription:

```python
virtual_machines = compute_client.virtual_machines.list_all()
```

4. For each virtual machine, check if it is using Managed Disk Volumes. If not, update the virtual machine to use Managed Disk Volumes:

```python
for vm in virtual_machines:
    vm_name = vm.name
    vm_resource_group = vm.id.split('/')[4]
    vm_parameters = compute_client.virtual_machines.get(vm_resource_group, vm_name)
    storage_profile = vm_parameters.storage_profile
    if storage_profile.os_disk.managed_disk is None:
        # Update the virtual machine to use Managed Disk Volumes
        storage_profile.os_disk.create_option = 'Attach'
        storage_profile.os_disk.managed_disk = {'storage_account_type': 'Standard_LRS'}
        compute_client.virtual_machines.create_or_update(vm_resource_group, vm_name, vm_parameters)
```

This code will iterate through all the virtual machines in your subscription and check if they are using Managed Disk Volumes. If they are not, it will update the virtual machine to use Managed Disk Volumes.




</Tab>
</Tabs>