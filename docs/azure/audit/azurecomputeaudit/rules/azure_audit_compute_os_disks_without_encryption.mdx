---
slug: azure_audit_compute_os_disks_without_encryption
title: OS Disks Lacking Encryption
sidebar_label: OS Disks Lacking Encryption
---

### More Info:

Encrypting the IaaS VMs OS disk (boot volume) ensures that its entire content is fully unrecoverable without a key and thus protects the volume from unwarranted reads.

### Risk Level

High

### Address

Security

### Compliance Standards

HIPAA, HITRUST, SOC2, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Azure portal: Navigate to portal.azure.com and sign in with your Azure account credentials.

2. Navigate to the Virtual Machines: On the left-hand side menu, click on "Virtual Machines". This will open a list of all the virtual machines that are currently running in your Azure environment.

3. Check Disk Encryption: Click on a specific virtual machine to open its overview page. Under the 'Settings' section on the left-hand side, click on 'Disks'. This will open a page showing all the disks associated with the selected virtual machine. 

4. Verify Encryption Status: For each disk, check the 'Encryption type' field. If the field shows 'Not enabled' or 'Encryption at-rest with a platform-managed key', it means the disk is not encrypted with a customer-managed key, indicating a potential misconfiguration. Repeat this process for all virtual machines in your Azure environment.

#### Using CLI

1. Install Azure CLI: Before you can run any Azure CLI commands, you need to install the Azure CLI on your local machine. You can download it from the official Microsoft Azure website. Once installed, open your command prompt or terminal.

2. Login to Azure: Use the following command to login to your Azure account. You will be redirected to the browser for login. Enter your Azure account credentials.
   ```
   az login
   ```
3. Set your subscription: If you have multiple subscriptions, set the subscription you want to work with using the following command. Replace 'my-subscription-id' with your actual subscription id.
   ```
   az account set --subscription 'my-subscription-id'
   ```
4. Check for unencrypted disks: Run the following command to list all the disks in your subscription and their encryption settings. If the encryption settings are 'EncryptionNotEnabled', then those disks are not encrypted.
   ```
   az disk list --query "[].{Name:name, ResourceGroup:resourceGroup, Encryption:encryptionSettingsCollection}"
   ```
   This command will return a list of all disks, their associated resource groups, and their encryption settings. You can manually check this list for any disks that have encryption not enabled.

#### Using Python

1. AWS:
   - Install and configure AWS SDK for Python (Boto3).
   - Use the `describe_volumes` method from the EC2 client to get a list of all EBS volumes.
   - Check the `KmsKeyId` field for each volume. If this field is not present, the volume is not encrypted.
   - Python script example:
     ```python
     import boto3
     ec2 = boto3.client('ec2')
     response = ec2.describe_volumes()
     for volume in response['Volumes']:
         if 'KmsKeyId' not in volume:
             print(f"Volume {volume['VolumeId']} is not encrypted.")
     ```

2. Azure:
   - Install and configure Azure SDK for Python.
   - Use the `list_all` method from the ComputeManagementClient to get a list of all disks.
   - Check the `encryption_settings` field for each disk. If this field is not present or `enabled` is False, the disk is not encrypted.
   - Python script example:
     ```python
     from azure.mgmt.compute import ComputeManagementClient
     compute_client = ComputeManagementClient(credentials, subscription_id)
     disks = compute_client.disks.list_all()
     for disk in disks:
         if not disk.encryption_settings or not disk.encryption_settings.enabled:
             print(f"Disk {disk.name} is not encrypted.")
     ```

3. GCP:
   - Install and configure Google Cloud SDK for Python.
   - Use the `list` method from the Compute Engine client to get a list of all disks.
   - Check the `disk_encryption_key` field for each disk. If this field is not present, the disk is not encrypted.
   - Python script example:
     ```python
     from google.cloud import compute_v1
     client = compute_v1.DisksClient()
     disks = client.list(project=project_id, zone=zone)
     for disk in disks:
         if not disk.disk_encryption_key:
             print(f"Disk {disk.name} is not encrypted.")
     ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Here are the steps to remediate the OS Disks Lacking Encryption misconfiguration in AZURE using the AZURE console:

1. Log in to the AZURE portal.
2. Navigate to the Virtual Machines blade.
3. Select the virtual machine that has the OS Disks Lacking Encryption misconfiguration.
4. Click on the "Disks" option under the Settings section.
5. Select the OS disk that you want to encrypt.
6. Click on the "Disk Encryption" option under the "Settings" section.
7. Click on the "Enable" button to enable the disk encryption.
8. Choose the encryption type and the encryption key.
9. Click on the "Save" button to save the changes.

Once the encryption is enabled, the OS disk will be encrypted, and the misconfiguration will be remediated. It is important to note that the encryption process may take some time to complete, depending on the size of the disk.

#### Using CLI

To remediate the misconfiguration of OS Disks lacking encryption in AZURE using AZURE CLI, you can follow the below steps:

1. Open the Azure CLI on your local machine or Azure Cloud Shell.

2. Run the following command to check if the encryption is enabled on the VM:

   `az vm encryption show --resource-group <resource-group-name> --name <vm-name>`

   Replace `<resource-group-name>` with the name of the resource group in which the VM is located, and `<vm-name>` with the name of the VM.

3. If encryption is not enabled on the VM, run the following command to enable encryption:

   `az vm encryption enable --resource-group <resource-group-name> --name <vm-name> --disk-encryption-keyvault <key-vault-name> --key-encryption-keyvault <key-vault-name> --volume-type ALL`

   Replace `<resource-group-name>` with the name of the resource group in which the VM is located, `<vm-name>` with the name of the VM, and `<key-vault-name>` with the name of the key vault where encryption keys are stored.

4. Once the command is executed successfully, the encryption process will start, and it may take some time depending on the size of the VM.

5. After the encryption process is complete, run the following command to verify that encryption is enabled:

   `az vm encryption show --resource-group <resource-group-name> --name <vm-name>`

   This command will display the encryption status of the VM.

6. Finally, confirm that the OS disks are encrypted by logging into the VM and checking the disk properties.

By following these steps, you can remediate the misconfiguration of OS disks lacking encryption in Azure using Azure CLI.

#### Using Python

To remediate the misconfiguration of OS Disks Lacking Encryption in AZURE using python, follow these steps:

1. Install the Azure SDK for Python using the following command:

```
pip install azure-mgmt-compute
```

2. Import the necessary modules:

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.compute import ComputeManagementClient
```

3. Authenticate to the Azure account using the `DefaultAzureCredential` class:

```python
credential = DefaultAzureCredential()
subscription_id = 'your-subscription-id'
compute_client = ComputeManagementClient(credential, subscription_id)
```

4. Get a list of all the virtual machines in the subscription:

```python
vm_list = compute_client.virtual_machines.list_all()
```

5. For each virtual machine, check if the OS disk is encrypted or not:

```python
for vm in vm_list:
    os_disk = vm.storage_profile.os_disk
    if not os_disk.encryption_settings:
        # Encrypt the OS disk
        encryption_settings = compute_client.disks.create_or_update_encryption_settings(
            resource_group_name=vm.id.split('/')[4],
            disk_name=os_disk.name,
            encryption_settings={
                "enabled": True
            }
        )
```

6. Save the script and run it to remediate the misconfiguration.

Note: This script assumes that the virtual machines are using managed disks. If the virtual machines are using unmanaged disks, you will need to modify the script accordingly.


### Additional Reading:

- [https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption-overview](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption-overview) 
- [https://docs.microsoft.com/en-us/azure/security-center/security-center-apply-disk-encryption](https://docs.microsoft.com/en-us/azure/security-center/security-center-apply-disk-encryption) 


</Tab>
</Tabs>