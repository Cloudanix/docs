

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Google Cloud Console: First, you need to log in to your Google Cloud Console. Make sure you have the necessary permissions to access and manage Bigtable resources.

2. Navigate to Bigtable Instances: From the main dashboard of the Google Cloud Console, navigate to the Bigtable service. You can do this by clicking on the navigation menu (hamburger icon on the top left), then "Bigtable".

3. Select the Bigtable Instance: Once you are in the Bigtable service, you will see a list of all your Bigtable instances. Click on the instance for which you want to check the encryption settings.

4. Check Encryption Settings: After selecting the instance, go to the "Encryption" section. Here, you can see the type of key used for encryption. If it says "Google-managed key", then the Bigtable cluster tables are not encrypted with a customer-managed key. If it says "Customer-managed key", then the tables are encrypted with a customer-managed key.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the SDK is installed and configured, you can list all the Bigtable instances in your project by running the following command in your terminal:

   ```
   gcloud bigtable instances list
   ```

   This command will return a list of all Bigtable instances along with their details.

3. To check the encryption settings of a specific Bigtable instance, you can use the following command:

   ```
   gcloud bigtable instances describe [INSTANCE_ID]
   ```

   Replace `[INSTANCE_ID]` with the ID of the Bigtable instance you want to check. This command will return the details of the specified Bigtable instance, including its encryption settings.

4. In the output of the above command, look for the `encryptionInfo` field. If the `encryptionType` is set to `GOOGLE_DEFAULT_ENCRYPTION`, it means that the Bigtable instance is not encrypted with a customer-managed key. If the `encryptionType` is set to `CUSTOMER_MANAGED_ENCRYPTION`, it means that the Bigtable instance is encrypted with a customer-managed key.

#### Using Python

To check if Bigtable Cluster Tables are encrypted with Customer Managed Keys in No SQL using Python scripts, follow the steps below:

1. **Setup Google Cloud SDK and Authentication:**
   First, you need to set up the Google Cloud SDK and authenticate your account. You can do this by running the following commands in your terminal:

   ```bash
   gcloud auth login
   gcloud config set project [PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your actual project ID.

2. **Install Google Cloud Bigtable Client Library:**
   Install the Google Cloud Bigtable Client Library for Python using pip:

   ```bash
   pip install google-cloud-bigtable
   ```

3. **Fetch Bigtable Instances and Clusters:**
   Use the Bigtable Client to fetch all Bigtable instances and their clusters. Here is a sample Python script:

   ```python
   from google.cloud import bigtable

   def list_clusters():
       client = bigtable.Client()
       for instance in client.list_instances():
           for cluster in instance.list_clusters():
               yield cluster
   ```

4. **Check Encryption Keys:**
   For each cluster, check if the encryption is set to Customer Managed Key. If the `encryption_type` is not `GOOGLE_DEFAULT_ENCRYPTION`, it means the cluster is using a Customer Managed Key.

   ```python
   for cluster in list_clusters():
       if cluster.encryption_type != 'GOOGLE_DEFAULT_ENCRYPTION':
           print(f'Cluster {cluster.cluster_id} is encrypted with a Customer Managed Key.')
       else:
           print(f'Cluster {cluster.cluster_id} is not encrypted with a Customer Managed Key.')
   ```

This script will print out the encryption status of all Bigtable clusters in your Google Cloud project. If a cluster is not encrypted with a Customer Managed Key, it will be flagged.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of Bigtable Cluster Tables not being encrypted with Customer Managed Keys in GCP, follow the below steps:

1. Open the Google Cloud Console and navigate to the Bigtable instance that you want to remediate.

2. Click on the "Encryption" tab from the left-hand side menu.

3. Under the "Encryption at rest" section, click on the "Edit" button.

4. Select "Customer-managed key" as the encryption type.

5. Click on the "Select key" button and choose an existing key or create a new one.

6. Click on the "Save" button to apply the changes.

7. Once the encryption type is updated, you need to enable the encryption for each table in the Bigtable cluster.

8. Click on the "Tables" tab from the left-hand side menu and select the table that you want to encrypt.

9. Click on the "Edit" button and select "Customer-managed key" as the encryption type.

10. Click on the "Select key" button and choose the same key that you selected in step 5.

11. Click on the "Save" button to apply the changes.

12. Repeat steps 8-11 for each table in the Bigtable cluster.

By following the above steps, you can remediate the issue of Bigtable Cluster Tables not being encrypted with Customer Managed Keys in GCP.

#### Using CLI

To remediate this misconfiguration, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to check if the Bigtable cluster tables are encrypted with customer-managed keys:

   ```
   gcloud bigtable tables describe [TABLE_ID] --cluster=[CLUSTER_ID] --project=[PROJECT_ID] --instance=[INSTANCE_ID]
   ```

   Replace `[TABLE_ID]`, `[CLUSTER_ID]`, `[PROJECT_ID]`, and `[INSTANCE_ID]` with the actual values.

3. If the output shows that the tables are not encrypted with customer-managed keys, then you need to create a new key ring and key for encryption. Run the following commands to create a new key ring and key:

   ```
   gcloud kms keyrings create [KEYRING_NAME] --location=[LOCATION] --project=[PROJECT_ID]
   gcloud kms keys create [KEY_NAME] --keyring=[KEYRING_NAME] --location=[LOCATION] --purpose=encryption --project=[PROJECT_ID]
   ```

   Replace `[KEYRING_NAME]`, `[LOCATION]`, `[PROJECT_ID]`, and `[KEY_NAME]` with the actual values.

4. After creating the key ring and key, you need to set the encryption for the Bigtable cluster tables. Run the following command to set the encryption:

   ```
   gcloud bigtable tables set-iam-policy [TABLE_ID] --cluster=[CLUSTER_ID] --project=[PROJECT_ID] --instance=[INSTANCE_ID] --member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" --role="roles/bigtable.encryptionKeyEncrypterDecrypter" --condition="encryption.encryptionKeyName=[KEY_NAME]"
   ```

   Replace `[TABLE_ID]`, `[CLUSTER_ID]`, `[PROJECT_ID]`, `[INSTANCE_ID]`, `[SERVICE_ACCOUNT_EMAIL]`, and `[KEY_NAME]` with the actual values.

5. Verify that the tables are now encrypted with the customer-managed keys by running the following command again:

   ```
   gcloud bigtable tables describe [TABLE_ID] --cluster=[CLUSTER_ID] --project=[PROJECT_ID] --instance=[INSTANCE_ID]
   ```

   The output should show that the tables are now encrypted with the customer-managed keys.

By following these steps, you can remediate the misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Bigtable Cluster Tables Should Be Encrypted With Customer Managed Keys" in GCP using Python, follow these steps:

1. Open the Cloud Shell in the GCP Console.

2. Install the Google Cloud Bigtable Python client library by running the following command:
```
pip install google-cloud-bigtable
```

3. Create a new key ring in the Cloud Key Management Service (KMS) by running the following command:
```
gcloud kms keyrings create <key-ring-name> --location <location>
```
Replace `<key-ring-name>` with the name of your key ring and `<location>` with the location where you want to store the key ring.

4. Create a new key in the key ring by running the following command:
```
gcloud kms keys create <key-name> --keyring <key-ring-name> --location <location> --purpose encryption
```
Replace `<key-name>` with the name of your key.

5. Enable the Cloud Bigtable API by running the following command:
```
gcloud services enable bigtable.googleapis.com
```

6. Use the following Python script to update the encryption configuration of your Bigtable cluster tables to use customer-managed keys:
```python
from google.cloud import bigtable
from google.cloud.bigtable import enums
from google.cloud.bigtable.admin import v2

# Set the project and instance IDs
project_id = 'your-project-id'
instance_id = 'your-instance-id'
cluster_id = 'your-cluster-id'
location_id = 'your-location-id'
key_ring_name = 'your-key-ring-name'
key_name = 'your-key-name'

# Create a Bigtable client
client = bigtable.Client(project=project_id)

# Create a Bigtable instance admin client
instance_admin_client = v2.BigtableInstanceAdminClient()

# Get the instance object
instance = client.instance(instance_id)

# Get the cluster object
cluster = instance.cluster(cluster_id)

# Create the encryption configuration object
encryption_config = v2.EncryptionConfig(
    kms_key_name=f"projects/{project_id}/locations/{location_id}/keyRings/{key_ring_name}/cryptoKeys/{key_name}",
    encryption_type=enums.EncryptionType.GOOGLE_DEFAULT_ENCRYPTION
)

# Update the cluster with the new encryption configuration
operation = instance_admin_client.update_cluster_encryption(
    request={
        "name": cluster.name,
        "encryption_config": encryption_config
    }
)

# Wait for the operation to complete
operation.result()
```
Replace the placeholders with your own project ID, instance ID, cluster ID, location ID, key ring name, and key name.

7. Run the Python script to update the encryption configuration of your Bigtable cluster tables to use customer-managed keys.

After completing these steps, your Bigtable cluster tables will be encrypted with customer-managed keys.


</Tab>
</Tabs>