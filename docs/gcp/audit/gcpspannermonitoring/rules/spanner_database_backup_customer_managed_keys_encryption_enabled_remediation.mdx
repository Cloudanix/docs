

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Spanner Instances: From the left-hand side menu, select "Spanner" under the "Storage" section. This will display a list of all Spanner instances in your GCP project.

3. Check Backup Encryption: Select a Spanner instance and navigate to the "Backups" tab. Here, you can see the details of all backups associated with the selected Spanner instance. Look for the "Encryption" column in the backup details. If the encryption is set to "Google-managed key", then the backup is not encrypted with a customer-managed key.

4. Verify Across All Instances: Repeat the above step for all Spanner instances in your GCP project to ensure that all Spanner database backups are encrypted with customer-managed keys.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the Google Cloud SDK is installed and configured, you can list all the backups in your Spanner database using the following command:

   ```
   gcloud spanner backups list --instance=[INSTANCE_ID]
   ```

   Replace `[INSTANCE_ID]` with the ID of your Spanner instance. This command will return a list of all backups in your Spanner instance.

3. For each backup, you can get the details including the encryption information using the following command:

   ```
   gcloud spanner backups describe [BACKUP_ID] --instance=[INSTANCE_ID]
   ```

   Replace `[BACKUP_ID]` with the ID of the backup and `[INSTANCE_ID]` with the ID of your Spanner instance. This command will return the details of the specified backup.

4. In the output of the above command, look for the `encryptionInfo` field. If the `encryptionType` is `GOOGLE_DEFAULT_ENCRYPTION`, it means the backup is encrypted with Google-managed keys. If the `encryptionType` is `CUSTOMER_MANAGED_ENCRYPTION`, it means the backup is encrypted with customer-managed keys. If the `encryptionType` is not present or if it is `GOOGLE_DEFAULT_ENCRYPTION`, it means the backup is not encrypted with customer-managed keys, which is a misconfiguration.

#### Using Python

1. Install Google Cloud SDK and Python Client for Cloud Spanner: Before you start, make sure you have installed the Google Cloud SDK and authenticated it with your Google Cloud account. Also, install the Python Client for Cloud Spanner using pip:

   ```
   pip install --upgrade google-cloud-spanner
   ```

2. Import the necessary libraries and set up the Spanner client: You will need to import the `google.cloud.spanner` library and create a Spanner client using your project ID.

   ```python
   from google.cloud import spanner

   def create_client(project_id):
       return spanner.Client(project=project_id)
   ```

3. List all databases and check their encryption configuration: You can list all databases in your Spanner instance and check their encryption configuration using the `instance.list_databases()` method. If the `encryption_config` attribute of a database is not set to a customer-managed key, it means the database backup is not encrypted with a customer-managed key.

   ```python
   def check_database_encryption(client, instance_id):
       instance = client.instance(instance_id)
       databases = list(instance.list_databases())
       for database in databases:
           if not database.encryption_config:
               print(f"Database {database.database_id} is not encrypted with a customer-managed key.")
           elif database.encryption_config.kms_key_name == "":
               print(f"Database {database.database_id} is not encrypted with a customer-managed key.")
   ```

4. Run the script: Finally, you can run the script by calling the `check_database_encryption` function with your project ID and Spanner instance ID.

   ```python
   if __name__ == "__main__":
       project_id = "your-project-id"
       instance_id = "your-instance-id"
       client = create_client(project_id)
       check_database_encryption(client, instance_id)
   ```

This script will print out the IDs of all databases in the specified Spanner instance that are not encrypted with a customer-managed key.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Spanner Database Backup not being encrypted with customer-managed keys in GCP, follow these steps:

1. Go to the GCP Console and navigate to the Spanner instance whose backup you want to encrypt.

2. Click on the "Backups" tab in the left-hand menu.

3. Find the backup that needs to be encrypted and click on its name.

4. Click on the "Encryption" tab in the top menu.

5. Click on the "Edit" button.

6. Select "Customer-managed key" from the "Encryption type" dropdown.

7. Choose the appropriate key from the "Key name" dropdown.

8. Click on the "Save" button to save the changes.

9. Verify that the backup is now encrypted with the customer-managed key by checking the "Encryption" tab.

10. Repeat these steps for any other Spanner backups that need to be encrypted with customer-managed keys.

By following these steps, you can remediate the misconfiguration of Spanner Database Backup not being encrypted with customer-managed keys in GCP.

#### Using CLI

To remediate this misconfiguration in GCP, you can follow these steps using GCP CLI:

1. First, you need to create a new key ring and key using the following command:

   ```
   gcloud kms keyrings create [KEY_RING_NAME] --location [LOCATION]
   gcloud kms keys create [KEY_NAME] --location [LOCATION] --keyring [KEY_RING_NAME] --purpose encryption
   ```

   Replace `[KEY_RING_NAME]`, `[LOCATION]`, and `[KEY_NAME]` with your own values.

2. Next, you need to grant the Cloud Spanner service account permission to use the key by adding the `cloudkms.cryptoKeyEncrypterDecrypter` role to the service account. You can use the following command:

   ```
   gcloud projects add-iam-policy-binding [PROJECT_ID] --member serviceAccount:[SERVICE_ACCOUNT_EMAIL] --role roles/cloudkms.cryptoKeyEncrypterDecrypter --condition=None
   ```

   Replace `[PROJECT_ID]` and `[SERVICE_ACCOUNT_EMAIL]` with your own values.

3. Now, you need to configure Cloud Spanner to use the customer-managed encryption key by updating the backup configuration. You can use the following command:

   ```
   gcloud spanner backups update [BACKUP_ID] --encryption-config kms-key-name=[KEY_NAME] --encryption-type customer-managed
   ```

   Replace `[BACKUP_ID]` and `[KEY_NAME]` with your own values.

4. Finally, you need to verify that the backup configuration has been updated successfully by running the following command:

   ```
   gcloud spanner backups describe [BACKUP_ID]
   ```

   This command should return the details of the backup configuration, including the encryption configuration.

By following these steps, you can remediate the misconfiguration and ensure that your Spanner database backups are encrypted with customer-managed keys in GCP.

#### Using Python

To remediate the misconfiguration "Spanner Database Backup Should Be Encrypted With Customer Managed Keys" for GCP using Python, you can follow these steps:

1. Create a Customer Managed Encryption Key (CMEK) in Google Cloud KMS. This key will be used to encrypt the backups. You can use the following code to create a CMEK:

```python
from google.cloud import kms_v1
from google.cloud.kms_v1 import enums

client = kms_v1.KeyManagementServiceClient()

# Set the Key Ring and Key ID
key_ring_id = 'your-key-ring-id'
key_id = 'your-key-id'

# Set the Key Purpose
purpose = enums.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT

# Create the Key
parent = client.key_ring_path('[PROJECT]', key_ring_id)
response = client.create_crypto_key(parent, key_id, {'purpose': purpose})
print('Created key: {}'.format(response.name))
```

2. Enable backup encryption for your Spanner instance. You can use the following code to enable backup encryption:

```python
from google.cloud import spanner_admin_database_v1

# Set the instance and database IDs
instance_id = 'your-instance-id'
database_id = 'your-database-id'

# Set the backup configuration
backup_config = {
    'encryption_config': {
        'kms_key_name': 'projects/[PROJECT]/locations/[LOCATION]/keyRings/[KEYRING]/cryptoKeys/[KEY]'
    }
}

# Update the backup configuration
database_admin_client = spanner_admin_database_v1.DatabaseAdminClient()
database_name = database_admin_client.database_path('[PROJECT]', instance_id, database_id)
operation = database_admin_client.update_backup(database_name, backup_config)
print('Backup encryption enabled: {}'.format(operation))
```

3. Verify that backup encryption is enabled for your Spanner instance. You can use the following code to verify backup encryption:

```python
from google.cloud import spanner_admin_database_v1

# Set the instance and database IDs
instance_id = 'your-instance-id'
database_id = 'your-database-id'

# Get the database backup configuration
database_admin_client = spanner_admin_database_v1.DatabaseAdminClient()
database_name = database_admin_client.database_path('[PROJECT]', instance_id, database_id)
backup_info = database_admin_client.get_backup_info(database_name)
print('Backup encryption enabled: {}'.format(backup_info.encryption_info.encryption_type))
```

This will ensure that your Spanner database backups are encrypted with a customer-managed encryption key in Google Cloud KMS.


</Tab>
</Tabs>