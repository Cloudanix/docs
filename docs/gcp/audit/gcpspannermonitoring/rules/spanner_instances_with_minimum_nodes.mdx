---
slug: spanner_instances_with_minimum_nodes
title: Spanner Instances Nodes Should Be Minimum
sidebar_label: Spanner Instances Nodes Should Be Minimum
---

### More Info:

Ensure node count for Spanner instances is not above allowed count

### Risk Level

Low

### Address

Operational Maturity, Reliability

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Google Cloud Console: Open your web browser and navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud credentials.

2. Navigate to Spanner Instances: From the left-hand side menu, navigate to the "Spanner" section under "Storage". Click on "Instances" to view all the Spanner instances in your project.

3. Check Spanner Instance Nodes: For each Spanner instance, you can see the number of nodes in the "Nodes" column. This will show you the number of nodes that each Spanner instance is using.

4. Verify Node Count: Check the number of nodes for each Spanner instance. If the number of nodes is less than the recommended minimum, then it is a misconfiguration. The recommended minimum number of nodes can vary depending on the specific requirements of your project, but generally, it should be at least 3 for production environments.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After downloading, you can install it by following the instructions provided. Once installed, you need to authenticate your Google Cloud account by running the command `gcloud auth login`.

2. List Spanner Instances: Use the `gcloud spanner instances list` command to list all the Spanner instances in your GCP project. This command will return a list of all Spanner instances along with their configurations. The command is as follows:

   ```
   gcloud spanner instances list
   ```

3. Get Spanner Instance Details: For each Spanner instance, you can use the `gcloud spanner instances describe` command to get more details about the instance, including the number of nodes. Replace `INSTANCE_ID` with the id of your instance. The command is as follows:

   ```
   gcloud spanner instances describe INSTANCE_ID
   ```

4. Check the Number of Nodes: In the output of the above command, look for the `nodeCount` field. This field indicates the number of nodes in the Spanner instance. If the number of nodes is less than the recommended minimum, then it indicates a misconfiguration.

#### Using Python

1. Install Google Cloud SDK and Python Client for Google Cloud Spanner: Before you can interact with Google Cloud Spanner using Python, you need to install the Google Cloud SDK and the Python client for Google Cloud Spanner. You can install these using pip:

   ```bash
   pip install --upgrade google-cloud-spanner
   ```

2. Import the necessary libraries and set up authentication: You need to import the Google Cloud Spanner library and authenticate your application. You can authenticate your application by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file.

   ```python
   import os
   from google.cloud import spanner

   os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/path/to/your/service-account-file.json"
   ```

3. Connect to Google Cloud Spanner and retrieve instance information: You can connect to Google Cloud Spanner and retrieve information about your instances using the `spanner.Client` class. You can then iterate over your instances and print out the number of nodes for each instance.

   ```python
   spanner_client = spanner.Client()

   for instance in spanner_client.list_instances():
       print(f"Instance ID: {instance.instance_id}, Nodes: {instance.node_count}")
   ```

4. Check if the number of nodes is less than the minimum: You can check if the number of nodes for each instance is less than the minimum required number of nodes (which is typically 1 for Google Cloud Spanner). If the number of nodes is less than the minimum, you can print out a warning message.

   ```python
   MINIMUM_NODES = 1

   for instance in spanner_client.list_instances():
       if instance.node_count < MINIMUM_NODES:
           print(f"WARNING: Instance {instance.instance_id} has less than the minimum required number of nodes.")
   ```
   
This script will help you detect if any of your Google Cloud Spanner instances have less than the minimum required number of nodes.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Spanner Instance Nodes should be minimum in GCP, you can follow the below steps:

1. Login to the GCP console and navigate to the Spanner Instance that needs to be remediated.

2. Click on the Spanner Instance and navigate to the "Nodes" tab.

3. In the "Nodes" tab, you will see the current number of nodes that are configured for the Spanner Instance.

4. To remediate the misconfiguration, you need to reduce the number of nodes to the minimum required. The minimum number of nodes required depends on the workload and the performance requirements.

5. To reduce the number of nodes, click on the "Edit" button on the top right corner of the "Nodes" tab.

6. In the "Edit Node Count" dialog box, reduce the number of nodes to the minimum required and click on the "Save" button.

7. GCP will initiate the process of reducing the number of nodes. This process may take some time depending on the number of nodes and the workload.

8. Once the process is complete, you will see the new number of nodes in the "Nodes" tab.

9. Verify that the Spanner Instance is working as expected with the reduced number of nodes.

By following the above steps, you can remediate the misconfiguration of Spanner Instance Nodes should be minimum in GCP using the GCP console.

#### Using CLI

The misconfiguration "Spanner Instances Nodes Should Be Minimum" suggests that the number of nodes in a Google Cloud Spanner instance is not set to the minimum recommended value. To remediate this issue, you can follow these steps:

1. Open the Google Cloud Console and navigate to the Cloud Spanner instances page.

2. Identify the instance that requires remediation and note down its instance ID.

3. Open the Cloud Shell from the Google Cloud Console.

4. In the Cloud Shell, run the following command to update the instance configuration:

```
gcloud spanner instances update INSTANCE_ID --num-nodes=1 --async
```

Replace INSTANCE_ID with the ID of the instance that requires remediation.

5. Wait for the update to complete. You can check the status of the update by running the following command:

```
gcloud spanner operations wait OPERATION_ID
```

Replace OPERATION_ID with the ID of the operation that you want to check.

6. Once the update is complete, verify that the number of nodes in the instance has been set to the minimum recommended value by running the following command:

```
gcloud spanner instances describe INSTANCE_ID
```

Replace INSTANCE_ID with the ID of the instance that you updated.

7. Repeat the above steps for any other instances that require remediation.

By following these steps, you can remediate the "Spanner Instances Nodes Should Be Minimum" misconfiguration for Google Cloud Spanner instances using the GCP CLI.

#### Using Python

To remediate the misconfiguration "Spanner Instances Nodes Should Be Minimum" for GCP using Python, you can follow the below steps:

Step 1: Import the required libraries:

```
from google.cloud import spanner_v1
from google.oauth2 import service_account
```

Step 2: Set the credentials for authentication:

```
credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_file>')
```

Step 3: Create a client object for Spanner:

```
spanner_client = spanner_v1.Client(credentials=credentials)
```

Step 4: Get the instance object for the Spanner instance:

```
instance_id = '<instance_id>'
instance = spanner_client.instance(instance_id)
```

Step 5: Get the current configuration for the instance:

```
config = instance.get()
```

Step 6: Set the minimum number of nodes for the instance:

```
config.node_count = <minimum_node_count>
```

Step 7: Update the instance configuration:

```
operation = instance.update_instance(config)
operation.result()
```

Note: Replace `<path_to_service_account_file>` with the path to your GCP service account key file, `<instance_id>` with the ID of your Spanner instance, and `<minimum_node_count>` with the desired minimum number of nodes for your instance.

By following these steps, you can remediate the misconfiguration "Spanner Instances Nodes Should Be Minimum" for GCP using Python.




</Tab>
</Tabs>