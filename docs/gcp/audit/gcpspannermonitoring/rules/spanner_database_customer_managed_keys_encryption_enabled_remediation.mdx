

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, visit the Google Cloud Platform (GCP) Console (https://console.cloud.google.com/) and sign in with your GCP account credentials.

2. Navigate to Spanner Instances: From the GCP Console dashboard, select the project that you want to examine from the project drop-down list available in the top navigation bar, then navigate to Spanner service by clicking on the "Navigation Menu" > "Spanner".

3. Check Spanner Database Encryption: Once you are in the "Spanner Instances" page, click on the name of the Spanner instance that you want to examine. In the instance details page, click on the "DATABASES" tab to access the list of databases available for the selected instance. Click on the name of the database that you want to examine. In the database details page, check the "Encryption" section. If the "Key type" is set to "Google-managed key", then the Spanner database is not encrypted with a customer-managed key (CMK).

4. Repeat the process: Repeat step 3 for each database available within the selected Spanner instance. Repeat steps 2 to 4 for each project available within your GCP account.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the SDK is installed and configured, you can list all the Spanner instances in your project by running the following command in your terminal:

   ```
   gcloud spanner instances list
   ```

   This command will return a list of all Spanner instances along with their details.

3. For each Spanner instance, list all the databases using the following command:

   ```
   gcloud spanner databases list --instance=[INSTANCE_ID]
   ```

   Replace [INSTANCE_ID] with the ID of your Spanner instance. This command will return a list of all databases in the specified Spanner instance.

4. For each database, check the encryption configuration by running the following command:

   ```
   gcloud spanner databases describe [DATABASE_ID] --instance=[INSTANCE_ID]
   ```

   Replace [DATABASE_ID] with the ID of your database and [INSTANCE_ID] with the ID of your Spanner instance. This command will return the details of the specified database, including its encryption configuration. If the encryption type is 'Google managed', then the database is not encrypted with a customer-managed key.

#### Using Python

To check if Spanner Databases are encrypted with Customer Managed Keys (CMKs) in Google Cloud Platform (GCP), you can use the Google Cloud SDK (gcloud) or the Google Cloud Client Libraries for Python. Here are the steps:

1. **Setup Google Cloud SDK and Authentication:**
   Before you can interact with GCP resources, you need to authenticate your SDK. You can do this by setting up a service account, downloading its key file, and setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of the key file.

2. **Install Google Cloud Client Libraries for Python:**
   You can install the Google Cloud Client Libraries for Python using pip:
   ```
   pip install --upgrade google-cloud-spanner
   ```

3. **List All Spanner Instances and Databases:**
   Use the Spanner Client to list all Spanner instances and their databases. Here is a sample script:
   ```python
   from google.cloud import spanner

   def list_databases(instance_id):
       spanner_client = spanner.Client()
       instance = spanner_client.instance(instance_id)

       databases = list(instance.list_databases())

       for database in databases:
           print(database.name)

   list_databases("your-instance-id")
   ```
   Replace `"your-instance-id"` with the ID of your Spanner instance.

4. **Check Encryption Config:**
   For each database, you can check its encryption configuration. If the `encryption_config` field is not set or if it's set to Google's default encryption, then the database is not encrypted with a CMK. Here is a sample script:
   ```python
   from google.cloud import spanner

   def check_encryption_config(instance_id, database_id):
       spanner_client = spanner.Client()
       instance = spanner_client.instance(instance_id)
       database = instance.database(database_id)

       if not database.encryption_config:
           print(f"Database {database_id} is not encrypted with a CMK.")
       elif database.encryption_config.kms_key_name == "Google managed":
           print(f"Database {database_id} is encrypted with Google's default encryption.")
       else:
           print(f"Database {database_id} is encrypted with a CMK.")

   check_encryption_config("your-instance-id", "your-database-id")
   ```
   Replace `"your-instance-id"` and `"your-database-id"` with the ID of your Spanner instance and the ID of the database you want to check, respectively.

Please note that the `encryption_config` field and the `kms_key_name` property are hypothetical and used for illustrative purposes. You should replace them with the actual properties provided by the Google Cloud Client Libraries for Python.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Spanner Databases Should Be Encrypted With Customer Managed Keys" for GCP using GCP console, follow the below steps:

1. Open the GCP Console and navigate to the Google Cloud Spanner instance for which you want to enable Customer Managed Encryption Keys (CMEK) encryption.

2. Click on the instance name to open the instance details page.

3. In the left navigation menu, click on "Encryption".

4. On the Encryption page, click on "Edit".

5. In the Encryption Settings dialog box, select "Customer-managed key" as the encryption type.

6. Select the key ring and key you want to use to encrypt the data.

7. Click on "Save" to apply the changes.

8. Once the encryption settings are updated, all the data stored in the Spanner database will be encrypted using the selected customer-managed key.

9. Verify that the encryption is working by accessing the data and checking that it is encrypted.

By following these steps, you can remediate the misconfiguration "Spanner Databases Should Be Encrypted With Customer Managed Keys" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Spanner Databases Should Be Encrypted With Customer Managed Keys" in GCP using GCP CLI, follow the below steps:

1. Open the Cloud Shell in the GCP Console.
2. Run the following command to check if any Spanner instances are not encrypted with customer-managed keys:

   ```
   gcloud spanner instances list --filter="encryptionConfig.kmsKeyName:missing"
   ```

3. If any Spanner instances are found that are not encrypted with customer-managed keys, then create a new key ring using the following command:

   ```
   gcloud kms keyrings create [KEYRING_NAME] --location [LOCATION]
   ```

   Replace `[KEYRING_NAME]` with the desired name for your key ring and `[LOCATION]` with the desired location for your key ring.

4. Create a new key in the key ring using the following command:

   ```
   gcloud kms keys create [KEY_NAME] --keyring [KEYRING_NAME] --location [LOCATION] --purpose encryption
   ```

   Replace `[KEY_NAME]` with the desired name for your key and `[KEYRING_NAME]` and `[LOCATION]` with the values you used in step 3.

5. Grant the Cloud Spanner service account the `cloudkms.cryptoKeyEncrypterDecrypter` role on the key you just created using the following command:

   ```
   gcloud kms keys add-iam-policy-binding [KEY_NAME] --keyring [KEYRING_NAME] --location [LOCATION] --member serviceAccount:[SERVICE_ACCOUNT_EMAIL] --role roles/cloudkms.cryptoKeyEncrypterDecrypter
   ```

   Replace `[KEY_NAME]` and `[KEYRING_NAME]` with the values you used in step 4, and replace `[LOCATION]` with the location of your key ring. Also, replace `[SERVICE_ACCOUNT_EMAIL]` with the email address of the Cloud Spanner service account.

6. Update the Spanner instance to use the customer-managed key using the following command:

   ```
   gcloud spanner instances update [INSTANCE_ID] --encryption-config kms-key-name=projects/[PROJECT_ID]/locations/[LOCATION]/keyRings/[KEYRING_NAME]/cryptoKeys/[KEY_NAME]
   ```

   Replace `[INSTANCE_ID]` with the ID of the Spanner instance you want to update, `[PROJECT_ID]` with the ID of your GCP project, `[LOCATION]` with the location of your key ring, and `[KEYRING_NAME]` and `[KEY_NAME]` with the values you used in step 4.

7. Verify that the Spanner instance is now encrypted with the customer-managed key using the following command:

   ```
   gcloud spanner instances describe [INSTANCE_ID] --format="value(encryptionConfig.kmsKeyName)"
   ```

   Replace `[INSTANCE_ID]` with the ID of the Spanner instance you updated.

With these steps, you have successfully remediated the misconfiguration "Spanner Databases Should Be Encrypted With Customer Managed Keys" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Spanner Databases Should Be Encrypted With Customer Managed Keys" for GCP using Python, you can follow the below steps:

1. First, you need to create a new Cloud KMS key ring and key for use with Cloud Spanner. You can use the following Python code to create a new key ring and key:

```python
from google.cloud import kms_v1

def create_key_ring(project_id, location_id, key_ring_id):
    client = kms_v1.KeyManagementServiceClient()
    parent = f"projects/{project_id}/locations/{location_id}"
    key_ring = client.create_key_ring(request={"parent": parent, "key_ring_id": key_ring_id})
    print(f"Created key ring: {key_ring.name}")
    return key_ring

def create_crypto_key(project_id, location_id, key_ring_id, crypto_key_id):
    client = kms_v1.KeyManagementServiceClient()
    parent = f"projects/{project_id}/locations/{location_id}/keyRings/{key_ring_id}"
    purpose = kms_v1.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT
    crypto_key = client.create_crypto_key(request={"parent": parent, "crypto_key_id": crypto_key_id, "purpose": purpose})
    print(f"Created crypto key: {crypto_key.name}")
    return crypto_key
```

2. Next, you need to enable customer-managed encryption for Cloud Spanner using the newly created key. You can use the following Python code to enable customer-managed encryption:

```python
from google.cloud import spanner_v1

def enable_customer_managed_encryption(instance_id, project_id, location_id, key_ring_id, crypto_key_id):
    client = spanner_v1.InstanceAdminClient()
    instance_name = f"projects/{project_id}/instances/{instance_id}"
    encryption_config = {"kms_key_name": f"projects/{project_id}/locations/{location_id}/keyRings/{key_ring_id}/cryptoKeys/{crypto_key_id}"}
    update_mask = {"paths": ["encryption_config"]}
    operation = client.update_instance(request={"instance": {"name": instance_name, "encryption_config": encryption_config}, "update_mask": update_mask})
    print(f"Enabled customer-managed encryption for instance: {instance_id}")
    return operation.result()
```

3. Finally, you need to verify that customer-managed encryption is enabled for the Cloud Spanner instance. You can use the following Python code to check the encryption status:

```python
def check_encryption_status(instance_id, project_id):
    client = spanner_v1.InstanceAdminClient()
    instance_name = f"projects/{project_id}/instances/{instance_id}"
    instance = client.get_instance(request={"name": instance_name})
    encryption_config = instance.encryption_config
    if encryption_config.kms_key_name:
        print(f"Customer-managed encryption is enabled for instance: {instance_id}")
    else:
        print(f"Customer-managed encryption is not enabled for instance: {instance_id}")
```

By following these steps, you can remediate the misconfiguration "Spanner Databases Should Be Encrypted With Customer Managed Keys" for GCP using Python.


</Tab>
</Tabs>