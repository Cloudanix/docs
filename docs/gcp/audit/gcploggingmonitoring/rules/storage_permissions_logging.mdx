---
slug: storage_permissions_logging
title: Storage Permissions Change Log Alerts Should Be Enabled
sidebar_label: Storage Permissions Change Log Alerts Should Be Enabled
---

### More Info:

Ensures that logging and log alerts exist for storage permission changes. Storage permissions include access to the buckets that store the logs, any changes in storage permissions should be heavily monitored to prevent unauthorized changes.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISGCP, CBP, HIPAA, ISO27001, HITRUST



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Logging: Once you're logged in, click on the navigation menu (three horizontal lines) in the top left corner of the console. Scroll down and click on "Logging" under the "Stackdriver" section.

3. Access Logs Viewer: In the Logging page, click on "Logs Viewer" in the left-hand menu. This will open a new page where you can view and filter your logs.

4. Check for Storage Permissions Change Log Alerts: In the Logs Viewer page, use the drop-down menu to select the GCP project you want to check. Then, in the "Filter by label or text search" field, enter "protoPayload.authorizationInfo.permission" to filter for logs related to storage permissions changes. If Storage Permissions Change Log Alerts are enabled, you should see logs related to storage permissions changes. If you don't see any logs, it means that the alerts are not enabled.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After installation, authenticate your account using the command `gcloud auth login`.

2. List all the projects: Use the following command to list all the projects in your GCP account. This will help you identify the project for which you want to check the storage permissions change log alerts.
   ```
   gcloud projects list
   ```
3. List all the logs-based metrics: Use the following command to list all the logs-based metrics in your project. This will help you identify if there are any metrics related to storage permissions change log alerts.
   ```
   gcloud logging metrics list --project=[PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your actual project ID.

4. Check the configuration of the logs-based metric: If you find a metric related to storage permissions change log alerts, use the following command to check its configuration.
   ```
   gcloud logging metrics describe [METRIC_NAME] --project=[PROJECT_ID]
   ```
   Replace `[METRIC_NAME]` with the name of the metric and `[PROJECT_ID]` with your actual project ID. This command will display the configuration of the metric, including the filter used to create it. If the filter includes `protoPayload.methodName="storage.setIamPermissions"`, it means that the metric is tracking changes to storage permissions.

#### Using Python

To check if Storage Permissions Change Log Alerts are enabled in Google Cloud Platform (GCP) using Python scripts, you can follow these steps:

1. **Install Google Cloud SDK and Python Client for Google Cloud Logging:**
   Before you start, make sure you have Google Cloud SDK and Python Client for Google Cloud Logging installed on your system. You can install the Python client using pip:
   ```
   pip install google-cloud-logging
   ```

2. **Set up Authentication:**
   You need to authenticate your SDK with GCP. You can do this by setting the environment variable `GOOGLE_APPLICATION_CREDENTIALS` to the path of your service account key JSON file.
   ```
   export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/service-account-file.json"
   ```

3. **Use Python Client for Google Cloud Logging:**
   You can use the Python client for Google Cloud Logging to fetch the logs. Here is a sample script to fetch the logs:
   ```python
   from google.cloud import logging

   # Instantiates a client
   client = logging.Client()

   # The name of the log to read from
   log_name = 'log-id'  # replace 'log-id' with the id of your log

   # Retrieves a Cloud Logging handler based on the environment
   # you're running the script in.
   logger = client.logger(log_name)

   # Retrieves the most recent log
   print("Logs:")
   for entry in logger.list_entries():  # API call
       timestamp = entry.timestamp.isoformat()
       print(f'Timestamp: {timestamp} Text Payload: {entry.payload}')
   ```

4. **Check for Storage Permissions Change Log Alerts:**
   In the logs fetched in the previous step, look for entries related to storage permissions change. If such entries are found, it means that Storage Permissions Change Log Alerts are enabled. If not, they are not enabled.

Remember to replace `'log-id'` with the id of your log in the above script. Also, the script assumes that you have the necessary permissions to read the logs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Storage Permissions Change Log Alerts Should Be Enabled" for GCP using GCP console, follow the below steps:

1. Open the Google Cloud Console and select the project for which you want to enable storage permissions change log alerts.

2. Navigate to the Cloud Storage page and select the bucket for which you want to enable the alerts.

3. Click on the "Edit Bucket Details" button to open the bucket details page.

4. Scroll down to the "Advanced Settings" section and click on the "Edit Bucket Permissions" button.

5. In the "Bucket Permissions" window, click on the "Add Member" button.

6. In the "Add members" window, enter the email address of the user or group that you want to receive the alerts.

7. In the "Select a role" dropdown menu, select the "Storage Object Admin" role.

8. Click on the "Save" button to add the member with the selected role.

9. Now, click on the "Add Notification" button in the "Advanced Settings" section.

10. In the "Add Notification" window, select the "Object Change" event type.

11. In the "Filter" section, select the "All object changes" option.

12. In the "Delivery" section, select the "Email" option and enter the email address of the user or group that you added in step 6.

13. Click on the "Save" button to save the notification.

14. Repeat steps 9 to 13 for each user or group that you want to receive the alerts.

15. Once you have added all the necessary members and notifications, click on the "Save" button to save the changes.

By following these steps, you have successfully enabled storage permissions change log alerts for the selected bucket in GCP.

#### Using CLI

To remediate the misconfiguration "Storage Permissions Change Log Alerts Should Be Enabled" for GCP using GCP CLI, you can follow the below steps:

1. Open the GCP CLI terminal and authenticate with your GCP account using the following command:
   ```
   gcloud auth login
   ```
2. Check whether the Stackdriver Logging API is enabled or not using the following command:
   ```
   gcloud services list --enabled | grep logging.googleapis.com
   ```
   If the Stackdriver Logging API is not enabled, then enable it using the following command:
   ```
   gcloud services enable logging.googleapis.com
   ```
3. Create a sink to export logs to Cloud Pub/Sub using the following command:
   ```
   gcloud logging sinks create [SINK_NAME] pubsub.googleapis.com/projects/[PROJECT_ID]/topics/[TOPIC_NAME] --log-filter='resource.type="gcs_bucket" AND protoPayload.methodName="storage.buckets.update" AND protoPayload.request.updateMask.fieldPaths="iamConfiguration" AND protoPayload.response.iamConfiguration' --include-children
   ```
   Replace the `[SINK_NAME]` with a name for the sink, `[PROJECT_ID]` with the ID of the GCP project, and `[TOPIC_NAME]` with the name of the Cloud Pub/Sub topic to export the logs to.
4. Grant the Cloud Pub/Sub Publisher role to the service account used by the sink using the following command:
   ```
   gcloud projects add-iam-policy-binding [PROJECT_ID] --member=serviceAccount:[SINK_SERVICE_ACCOUNT] --role=roles/pubsub.publisher
   ```
   Replace the `[PROJECT_ID]` with the ID of the GCP project and `[SINK_SERVICE_ACCOUNT]` with the email address of the service account used by the sink.
5. Enable the sink using the following command:
   ```
   gcloud logging sinks update [SINK_NAME] --destination=pubsub.googleapis.com/projects/[PROJECT_ID]/topics/[TOPIC_NAME] --include-children
   ```
   Replace the `[SINK_NAME]` with the name of the sink, `[PROJECT_ID]` with the ID of the GCP project, and `[TOPIC_NAME]` with the name of the Cloud Pub/Sub topic to export the logs to.

With the above steps, you have successfully remediated the misconfiguration "Storage Permissions Change Log Alerts Should Be Enabled" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Storage Permissions Change Log Alerts Should Be Enabled" for GCP using Python, you can follow these steps:

1. Import the necessary libraries: 

```python
from google.cloud import logging_v2
from google.cloud.logging_v2 import enums
from google.cloud.logging_v2.resource import Resource
```

2. Set up the client:

```python
client = logging_v2.LoggingServiceV2Client()
```

3. Define the project ID:

```python
project_id = 'your-project-id'
```

4. Define the log sink:

```python
log_sink = 'storage-permissions-change-log-alerts'
```

5. Define the log filter:

```python
log_filter = 'logName:"cloudaudit.googleapis.com%2Factivity" AND protoPayload.methodName:"storage.buckets.update" AND protoPayload.serviceName:"storage.googleapis.com"'
```

6. Define the log sink destination:

```python
log_sink_destination = f"storage.googleapis.com/{log_sink}"
```

7. Define the log sink configuration:

```python
sink_config = {
    "name": log_sink,
    "destination": log_sink_destination,
    "filter": log_filter,
    "output_version_format": enums.LogSink.VersionFormat.V2
}
```

8. Define the log sink resource:

```python
project_resource = Resource(type="project", labels={"project_id": project_id})
```

9. Create the log sink:

```python
response = client.create_sink(project_resource.project_id, sink_config)
```

10. Verify that the log sink was created successfully:

```python
if response.name == f"projects/{project_id}/sinks/{log_sink}":
    print(f"Log sink {log_sink} created successfully.")
else:
    print(f"Failed to create log sink {log_sink}.")
```

These steps will enable the storage permissions change log alerts for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/logging/docs/logs-based-metrics/](https://cloud.google.com/logging/docs/logs-based-metrics/) 


</Tab>
</Tabs>