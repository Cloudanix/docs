---
slug: vpc_network_route_logging
title: Network Route Change Log Alerts Should Be Enabled
sidebar_label: Network Route Change Log Alerts Should Be Enabled
---

### More Info:

Ensures that logging and log alerts exist for VPC network route changes.

### Risk Level

Medium

### Address

Security

### Compliance Standards

SOC2, NIST, ISO27001, HIPAA, CISGCP, CBP, HITRUST



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com) and sign in with your Google account credentials.

2. Navigate to Logging: Once you're logged in, click on the navigation menu (three horizontal lines) in the top left corner of the console. Scroll down and click on "Logging" under the "Operations" section.

3. Check for Network Route Change Log Alerts: In the Logging section, click on "Logs Explorer". Here, you can filter and search for specific logs. To check for Network Route Change Log Alerts, you can use the following filter in the "Query" field: 
   ```
   resource.type="gce_network_route"
   AND
   protoPayload.methodName="v1.compute.networks.updatePeering"
   ```
   This filter will show you all the logs related to changes in network routes.

4. Analyze the Logs: After applying the filter, you will see a list of logs related to network route changes. You can click on each log to see more details. If there are no logs, it means that Network Route Change Log Alerts are not enabled. If there are logs, it means that the alerts are enabled and working properly.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: Before you can use the Google Cloud CLI, you need to install it on your local machine and authenticate it with your Google Cloud account. You can download the SDK from the official Google Cloud website and follow the instructions to install it. Once installed, you can authenticate it by running the following command in your terminal:

   ```
   gcloud auth login
   ```
   This will open a new browser window where you can log in with your Google Cloud account. Once logged in, the CLI will be authenticated and ready to use.

2. List all the logs-based metrics: You can list all the logs-based metrics in your Google Cloud project by running the following command:

   ```
   gcloud logging metrics list
   ```
   This will return a list of all the logs-based metrics in your project. Look for a metric with a name like "network_route_change_log_alerts". If such a metric exists, it means that network route change log alerts are enabled.

3. Get the details of the logs-based metric: If you find a logs-based metric for network route change log alerts, you can get more details about it by running the following command:

   ```
   gcloud logging metrics describe network_route_change_log_alerts
   ```
   This will return detailed information about the metric, including its name, description, filter, and other properties.

4. Check the filter of the logs-based metric: The filter of the logs-based metric determines which log entries will trigger an alert. To check if network route change log alerts are properly configured, the filter should include log entries related to network route changes. You can check the filter of the logs-based metric by looking at the "filter" property in the output of the previous command. If the filter includes log entries related to network route changes, it means that network route change log alerts are enabled and properly configured.

#### Using Python

Detecting whether Network Route Change Log Alerts are enabled in Logging can be done using Python scripts. Here are the steps:

1. **Install the necessary libraries**: Before you start, you need to install the necessary libraries. You can use pip to install the Google Cloud Logging library. Run the following command in your terminal:

```python
pip install google-cloud-logging
```

2. **Import the libraries and initialize the client**: Import the necessary libraries and initialize the Logging client. 

```python
from google.cloud import logging

# Instantiates a client
client = logging.Client()
```

3. **Filter the logs**: You can filter the logs to only show the ones related to network route changes. This can be done using the `list_entries` method of the client, and passing a filter string to it. The filter string can be something like `"resource.type=gce_route AND protoPayload.methodName=compute.routes.insert"`, which will only show logs related to the creation of new network routes.

```python
filter_str = 'resource.type=gce_route AND protoPayload.methodName=compute.routes.insert'

# List all entries
entries = list(client.list_entries(filter_=filter_str)) # API call
```

4. **Check if alerts are enabled**: To check if alerts are enabled, you can look for the `logName` field in the entries. If it contains `"projects/[PROJECT_ID]/logs/cloudaudit.googleapis.com%2Factivity"`, then alerts are enabled. If not, they are disabled.

```python
for entry in entries:
    if 'logName' in entry and 'cloudaudit.googleapis.com%2Factivity' in entry['logName']:
        print('Alerts are enabled')
    else:
        print('Alerts are disabled')
```

Remember to replace `[PROJECT_ID]` with your actual project ID. This script will print whether alerts are enabled or disabled for each log entry related to network route changes.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Network Route Change Log Alerts Should Be Enabled" for GCP using GCP console, follow these steps:

1. Open the GCP console and navigate to the Logging section.

2. Click on "Logs Explorer" in the left-hand menu.

3. In the search bar at the top of the page, type "route" and press enter.

4. Select the "GCE_NETWORK_ROUTE" log type from the dropdown menu.

5. Click on the "Create Metric" button.

6. Name the metric "route-change" and set the aggregation to "Count".

7. Click on the "Create" button to create the metric.

8. In the left-hand menu, click on "Alerting".

9. Click on the "Create Policy" button.

10. Name the policy "route-change-alert" and set the "Resource Type" to "GCE Instance".

11. Under "Conditions", click on "Add Condition".

12. Select "Metric Threshold" as the condition type.

13. Set the "Metric" to "route-change" and set the "Aggregation" to "Count".

14. Set the "Threshold" to "1" and the "For" duration to "1 minute".

15. Click on "Add" to add the condition.

16. Under "Notifications", click on "Add Notification".

17. Select the notification method you want to use (e.g. email, SMS, etc.) and enter the appropriate information.

18. Click on "Save" to save the policy.

By following these steps, you will have successfully enabled network route change log alerts for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Network Route Change Log Alerts Should Be Enabled" for GCP using GCP CLI, please follow the below steps:

1. Open the Cloud Shell in the GCP Console.

2. Run the following command to enable route change log alerts for your project:

   ```
   gcloud beta logging sinks create ROUTE_CHANGE_LOGS_STORAGE_BUCKET_NAME \
   storage.googleapis.com/ROUTE_CHANGE_LOGS_STORAGE_BUCKET_NAME \
   --log-filter="resource.type=\"gce_route\" AND protoPayload.methodName=\"beta.compute.routes.patch\"" \
   --project=PROJECT_ID
   ```

   Note: Replace ROUTE_CHANGE_LOGS_STORAGE_BUCKET_NAME and PROJECT_ID with your own values.

3. Run the following command to grant the logs writer role to the sink service account:

   ```
   gcloud projects add-iam-policy-binding PROJECT_ID \
   --member="serviceAccount:SINK_SERVICE_ACCOUNT" \
   --role="roles/logging.logWriter"
   ```

   Note: Replace PROJECT_ID and SINK_SERVICE_ACCOUNT with your own values.

4. Run the following command to create a log metric for the route change logs:

   ```
   gcloud logging metrics create ROUTE_CHANGE_LOGS_METRIC_NAME \
   --description="Metric for route change logs" \
   --filter="resource.type=\"gce_route\" AND protoPayload.methodName=\"beta.compute.routes.patch\"" \
   --project=PROJECT_ID
   ```

   Note: Replace ROUTE_CHANGE_LOGS_METRIC_NAME and PROJECT_ID with your own values.

5. Run the following command to create an alert policy for the route change logs:

   ```
   gcloud alpha monitoring policies create-route-change-alert-policy \
   --display-name="Route Change Log Alerts" \
   --condition-filter="metric.type=\"logging.googleapis.com/user/ROUTE_CHANGE_LOGS_METRIC_NAME\" AND resource.type=\"gce_route\"" \
   --destination-channel-name="CHANNEL_NAME" \
   --project=PROJECT_ID
   ```

   Note: Replace ROUTE_CHANGE_LOGS_METRIC_NAME, CHANNEL_NAME, and PROJECT_ID with your own values.

6. Verify that the alert policy is created successfully by running the following command:

   ```
   gcloud alpha monitoring policies list --filter="displayName=\"Route Change Log Alerts\"" --project=PROJECT_ID
   ```

   Note: Replace PROJECT_ID with your own value.

By following the above steps, you will be able to remediate the misconfiguration "Network Route Change Log Alerts Should Be Enabled" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Network Route Change Log Alerts Should Be Enabled" for GCP using Python, follow the below steps:

1. Import the required libraries:

```python
from google.cloud import logging_v2
from google.cloud.logging_v2 import enums
from google.protobuf import field_mask_pb2
```

2. Set the project ID for which you want to enable the Network Route Change Log Alerts:

```python
project_id = 'your-project-id'
```

3. Initialize the Logging client:

```python
client = logging_v2.LoggingServiceV2Client()
```

4. Create a request to get the existing sink for the project:

```python
parent = f"projects/{project_id}"
response = client.list_sinks(parent)
```

5. Check if the sink already exists. If it exists, update it with the required configuration. If it doesn't exist, create a new sink with the required configuration:

```python
# Check if the sink already exists
for sink in response.sinks:
    if sink.name == f"{parent}/sinks/your-sink-name":
        # Update the existing sink with the required configuration
        sink.filter = "resource.type=gce_route AND protoPayload.methodName=beta.compute.routes.patch"
        sink.destination = "pubsub.googleapis.com/projects/your-project-id/topics/your-topic-name"
        sink.output_version_format = enums.LogSinkVersionFormat.V2
        update_mask = field_mask_pb2.FieldMask(paths=["filter", "destination", "output_version_format"])
        client.update_sink(sink=sink, update_mask=update_mask)
        break
else:
    # Create a new sink with the required configuration
    sink = logging_v2.types.LogSink()
    sink.name = f"{parent}/sinks/your-sink-name"
    sink.filter = "resource.type=gce_route AND protoPayload.methodName=beta.compute.routes.patch"
    sink.destination = "pubsub.googleapis.com/projects/your-project-id/topics/your-topic-name"
    sink.output_version_format = enums.LogSinkVersionFormat.V2
    client.create_sink(parent, sink)
```

Note: Replace `your-sink-name` and `your-topic-name` with the desired names for your sink and topic.

6. Confirm that the sink is created or updated successfully by checking the Stackdriver Logging console.

With these steps, you can remediate the misconfiguration "Network Route Change Log Alerts Should Be Enabled" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/logging/docs/logs-based-metrics](https://cloud.google.com/logging/docs/logs-based-metrics) 


</Tab>
</Tabs>