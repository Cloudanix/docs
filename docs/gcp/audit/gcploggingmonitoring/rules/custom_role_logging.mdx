---
slug: custom_role_logging
title: Custom Role Change Log Alerts Should Be Enabled
sidebar_label: Custom Role Change Log Alerts Should Be Enabled
---

### More Info:

Ensure that the log metric filter and alerts exist for Custom Role changes.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISGCP, CBP, HIPAA, ISO27001, HITRUST, SOC2, NISTCSF, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com) and sign in with your Google account credentials.

2. Navigate to Logging: Once you're logged in, click on the navigation menu (three horizontal lines) in the top left corner of the console. Scroll down and click on "Logging" under the "Stackdriver" section.

3. Check for Custom Role Change Log Alerts: In the Logging section, click on "Logs Explorer". Here, you can filter and search for specific logs. To check for Custom Role Change Log alerts, you can use the following filter in the "Filter by label or text search" field: 
   ```
   protoPayload.methodName="google.iam.admin.v1.CreateRole" OR protoPayload.methodName="google.iam.admin.v1.UpdateRole" OR protoPayload.methodName="google.iam.admin.v1.DeleteRole"
   ```
   This filter will show logs for any create, update, or delete operations on custom roles.

4. Verify Alert Configuration: To ensure that alerts are enabled for these operations, you need to check the alerting policies. Go back to the navigation menu and click on "Monitoring" under the "Stackdriver" section. Then click on "Alerting" and "Create Policy". Here, you can check if there are any existing policies for Custom Role Change Log alerts. If there are, they should be configured to notify you via email, SMS, or another method when these operations occur.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After installation, authenticate your account using the command `gcloud auth login`.

2. List all the sinks: Sinks are objects that you create in Logging to export entries to different destinations. To list all the sinks in your project, use the following command: `gcloud logging sinks list`. This will display a list of all the sinks in your project.

3. Check for Custom Role Change Log Alerts: To check if Custom Role Change Log Alerts are enabled, you need to look for a sink that exports data to the destination `pubsub.googleapis.com/projects/[PROJECT_ID]/topics/[TOPIC_ID]`. This sink should have a filter that includes `protoPayload.methodName="SetIamPolicy" AND protoPayload.serviceData.policyDelta.bindingDeltas.action="ADD" AND protoPayload.serviceData.policyDelta.bindingDeltas.role="roles/logging.viewer"`. If such a sink exists, it means that Custom Role Change Log Alerts are enabled.

4. Verify the sink: To verify the sink, use the following command: `gcloud logging sinks describe [SINK_NAME]`. Replace `[SINK_NAME]` with the name of the sink you want to verify. This command will display the details of the sink, including its filter and destination. If the filter and destination match the ones mentioned in step 3, it means that Custom Role Change Log Alerts are enabled.

#### Using Python

To check if Custom Role Change Log Alerts are enabled in Google Cloud Platform (GCP) using Python scripts, you can follow these steps:

1. **Set up Google Cloud SDK and Python Environment:**
   Before you start, make sure you have Google Cloud SDK and Python installed on your system. You can download Google Cloud SDK from the official Google Cloud website and install Python from the official Python website. After installing, authenticate your SDK using the command `gcloud auth login`.

2. **Install Required Python Libraries:**
   You will need the `google-cloud-logging` Python library. You can install it using pip:
   ```
   pip install --upgrade google-cloud-logging
   ```

3. **Create a Python Script to Check Log Alerts:**
   Create a Python script that uses the `google-cloud-logging` library to check if Custom Role Change Log Alerts are enabled. Here is a basic example:

   ```python
   from google.cloud import logging

   def list_logs():
       client = logging.Client()

       filter_str = 'resource.type="gce_instance" AND logName:"logs/cloudaudit.googleapis.com%2Factivity" AND protoPayload.methodName:"SetIamPolicy" AND protoPayload.serviceName:"cloudresourcemanager.googleapis.com"'

       for entry in client.list_entries(filter_=filter_str):  # API call
           timestamp = entry.timestamp.isoformat()
           print(f'Timestamp: {timestamp} Text Payload: {entry.payload}')

   list_logs()
   ```
   This script will list all the logs that match the filter criteria. The filter string is used to filter out logs related to IAM policy changes.

4. **Run the Python Script:**
   Run the Python script using the command `python script_name.py`. If Custom Role Change Log Alerts are enabled, you should see the relevant logs printed on the console. If not, it means the alerts are not enabled.

Remember to replace `script_name.py` with the name of your Python script. Also, ensure that the account you're using has the necessary permissions to access the logs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Custom Role Change Log Alerts Should Be Enabled" in GCP using GCP console, you can follow the below steps:

1. Open the GCP console and select the project for which you want to enable the Custom Role Change Log Alerts.

2. Click on the "Navigation menu" on the top-left corner of the console and select "Logging" under the "TOOLS" section.

3. In the Logging page, click on the "Create Sink" button.

4. In the "Create Sink" page, provide a name for the sink in the "Name" field.

5. In the "Sink Service" section, select "Cloud Pub/Sub" as the sink service.

6. In the "Cloud Pub/Sub topic" field, select or create a new topic to which the logs will be sent.

7. In the "Filter" section, add the following filter: 

```
protoPayload.methodName="google.iam.admin.v1.CreateRole" OR protoPayload.methodName="google.iam.admin.v1.UpdateRole" OR protoPayload.methodName="google.iam.admin.v1.DeleteRole"
```

This filter will capture the logs for any changes made to custom roles.

8. Click on the "Create Sink" button to create the sink.

9. Once the sink is created, click on the "Create Alert" button to create an alert based on the sink.

10. In the "Create Alerting Policy" page, provide a name for the alert in the "Name" field.

11. In the "Condition" section, click on the "Add Condition" button and select "Log-based Metric" as the condition type.

12. In the "Log-based Metric" section, select the sink that you created in step 4.

13. In the "Aggregation" section, select "Count" as the aggregation type and set the "Period" to 1 minute.

14. In the "Filter" section, add the same filter that you added in step 7.

15. In the "Configuration" section, set the "Threshold" to 1 and the "For" duration to 1 minute.

16. In the "Notification Channels" section, select the notification channels to which you want to send the alerts.

17. Click on the "Save" button to save the alerting policy.

Now, whenever a custom role is created, updated or deleted, a log entry will be created and sent to the Cloud Pub/Sub topic. The log-based metric and alerting policy that you created will capture these logs and send alerts to the specified notification channels.

#### Using CLI

To remediate the misconfiguration "Custom Role Change Log Alerts Should Be Enabled" for GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to enable the Custom Role Change Log Alerts:
```
gcloud alpha monitoring channels create --channel-content-type="text/plain" --display-name="Custom Role Change Log Alerts" --type="webhook" --channel-labels="project_id=<your-project-id>,role_change_alert=true" --description="Alerts when a custom role is created, updated, or deleted." --payload="{"text": "Custom role change detected in project <your-project-id>: $incident.name"}"
```
Note: Replace `<your-project-id>` with your actual GCP project ID.

3. Run the following command to verify the Custom Role Change Log Alerts:
```
gcloud alpha monitoring channels list --filter="display_name:Custom Role Change Log Alerts"
```
This command will list all the channels with the display name "Custom Role Change Log Alerts".

4. If the above command returns a valid response, then the Custom Role Change Log Alerts have been successfully enabled.

By following the above steps, you can remediate the misconfiguration "Custom Role Change Log Alerts Should Be Enabled" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Custom Role Change Log Alerts Should Be Enabled" in GCP using Python, you can follow the below steps:

1. First, you need to check if the Stackdriver Logging API is enabled for the project. You can do this by running the following command in the Cloud Shell:

```
gcloud services list --enabled --filter=NAME | grep logging.googleapis.com
```

2. If the Stackdriver Logging API is not enabled, you need to enable it by running the following command:

```
gcloud services enable logging.googleapis.com
```

3. Next, you need to create a sink to export the logs to Cloud Pub/Sub. You can do this by running the following command:

```
gcloud logging sinks create [SINK_NAME] pubsub.googleapis.com/projects/[PROJECT_ID]/topics/[TOPIC_NAME] --log-filter='protoPayload.methodName="google.iam.admin.v1.CreateRole" OR protoPayload.methodName="google.iam.admin.v1.UpdateRole" OR protoPayload.methodName="google.iam.admin.v1.DeleteRole"'
```

Note: Replace [SINK_NAME], [PROJECT_ID], and [TOPIC_NAME] with appropriate values.

4. After creating the sink, you need to grant the Pub/Sub Publisher role to the service account that will be used to create the sink. You can do this by running the following command:

```
gcloud projects add-iam-policy-binding [PROJECT_ID] --member=serviceAccount:[SERVICE_ACCOUNT_EMAIL] --role=roles/pubsub.publisher
```

Note: Replace `<PROJECT_ID>` and `<SERVICE_ACCOUNT_EMAIL>` with appropriate values.

5. Finally, you need to create a Cloud Function that will be triggered by the Pub/Sub topic and send an alert to the appropriate channels. You can use the following Python code as a starting point:

```python
import base64
import json

def custom_role_change_log_alert(event, context):
    pubsub_message = base64.b64decode(event['data']).decode('utf-8')
    log_entry = json.loads(pubsub_message)['protoPayload']
    # TODO: Implement alerting logic here
```

Note: Replace the TODO comment with the actual alerting logic.

6. Deploy the Cloud Function by running the following command:

```
gcloud functions deploy [FUNCTION_NAME] --runtime python37 --trigger-topic [TOPIC_NAME] --entry-point custom_role_change_log_alert
```

Note: Replace `<FUNCTION_NAME>` and `<TOPIC_NAME>` with appropriate values.

After following these steps, your GCP project should be remediated for the misconfiguration "Custom Role Change Log Alerts Should Be Enabled".


</Tab>
</Tabs>