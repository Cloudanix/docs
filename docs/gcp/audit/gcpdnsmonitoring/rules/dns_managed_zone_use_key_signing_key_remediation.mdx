

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Cloud DNS: From the main dashboard of the Google Cloud Console, click on the navigation menu (three horizontal lines) located at the top left corner of the page. Scroll down and click on "Network Services", then select "Cloud DNS".

3. Check Managed Zones: In the Cloud DNS page, you will see a list of your DNS managed zones. Click on the name of the managed zone you want to inspect.

4. Check Key Signing Key: In the managed zone details page, look for the DNSSEC section. If the DNSSEC is set to "Off", it means that the Key Signing Key (KSK) is not being used. If it's set to "On", check the details to see if the KSK is properly configured.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine and authenticate it with your Google Cloud account. You can do this by following the instructions provided by Google Cloud.

2. List all DNS managed zones: Use the following command to list all DNS managed zones in your GCP project:

   ```
   gcloud dns managed-zones list --project=[PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your actual GCP project ID.

3. Get DNSSEC details: For each managed zone, use the following command to get the DNSSEC details:

   ```
   gcloud dns managed-zones describe [ZONE_NAME] --project=[PROJECT_ID]
   ```
   Replace `[ZONE_NAME]` with the name of the managed zone and `[PROJECT_ID]` with your actual GCP project ID. Look for the `dnssecConfig` field in the output. If the `state` field under `dnssecConfig` is not set to `on`, it means that DNSSEC is not enabled for that managed zone.

4. Check for Key Signing Key (KSK): In the `dnssecConfig` field, check the `defaultKeySpecs` list. If there is no key with `keyType` set to `keySigning`, it means that no Key Signing Key (KSK) is being used for that managed zone.

#### Using Python

1. Install Google Cloud SDK and Python Client for Google Cloud DNS: Before you start, make sure you have installed the Google Cloud SDK and authenticated it with your GCP account. Also, install the Python Client for Google Cloud DNS using pip.

```bash
pip install --upgrade google-cloud-dns
```

2. Import the necessary libraries and initialize the client: In your Python script, you will need to import the google.cloud.dns library and initialize the client using your project ID.

```python
from google.cloud import dns

client = dns.Client(project='my-project-id')
```

3. Fetch all managed zones: You can fetch all the managed zones in your project using the list_zones() method. This will return an iterator that you can loop through to access each managed zone.

```python
zones = client.list_zones()

for zone in zones:
    print(zone.name)
```

4. Check for Key Signing Key (KSK): For each managed zone, you can check if it uses a Key Signing Key (KSK) by fetching its DNSSEC configuration and checking the state of the 'ksk_state' attribute. If it's not 'ACTIVE', then the managed zone is not using a KSK.

```python
for zone in zones:
    dnssec_config = zone.dnssec_config
    if dnssec_config.ksk_state != 'ACTIVE':
        print(f"Managed zone {zone.name} is not using a Key Signing Key (KSK)")
```

This script will print the names of all managed zones in your project that are not using a Key Signing Key (KSK).

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "GCP DNS Managed Zones Should Use Key Signing Key" for GCP using GCP console, please follow the below steps:

1. Login to your GCP console.
2. Navigate to the Cloud DNS page by clicking on the Navigation menu > Network services > Cloud DNS.
3. Select the DNS zone that you want to remediate.
4. Click on the "DNSSEC" tab.
5. Check if the DNSSEC is enabled or not. If not, click on the "Enable DNSSEC" button.
6. Once the DNSSEC is enabled, you will see the Key Signing Key (KSK) and Zone Signing Key (ZSK) options.
7. Click on the "Add KSK" button to add a new Key Signing Key.
8. Enter the required details like algorithm type, key size, and description.
9. Click on the "Create" button to create a new KSK.
10. Once the KSK is created, you will see it in the list of KSKs.
11. Now, select the KSK that you have just created and click on the "Activate" button to activate it.
12. Once the KSK is activated, it will be used for signing the DNS records in the managed zone.

This completes the remediation of the misconfiguration "GCP DNS Managed Zones Should Use Key Signing Key" for GCP using GCP console.

#### Using CLI

To remediate the GCP DNS Managed Zones Should Use Key Signing Key misconfiguration using GCP CLI, follow these steps:

1. Open the Google Cloud Console and select the project where you want to remediate the misconfiguration.

2. Open the Cloud Shell by clicking on the icon in the top right corner of the console.

3. Run the following command to list all the managed zones in the project:

   ```
   gcloud dns managed-zones list
   ```

4. Identify the managed zone that needs to be remediated and note down its name.

5. Run the following command to update the managed zone to use a key signing key:

   ```
   gcloud dns managed-zones update [MANAGED_ZONE_NAME] --dnssec-state on --ksk-key-signing-algorithm [ALGORITHM]
   ```

   Replace [MANAGED_ZONE_NAME] with the name of the managed zone that you identified in step 4, and [ALGORITHM] with the key signing algorithm that you want to use (e.g. "rsasha256").

6. Verify that the managed zone has been updated by running the following command:

   ```
   gcloud dns managed-zones describe [MANAGED_ZONE_NAME] --format="table(dnssecConfig.state, dnssecConfig.defaultKeySpecs[0].keyType, dnssecConfig.defaultKeySpecs[0].algorithm)"
   ```

   This command should display the updated DNSSEC state, key type and algorithm for the managed zone.

By following these steps, you should be able to remediate the GCP DNS Managed Zones Should Use Key Signing Key misconfiguration using GCP CLI.

#### Using Python

To remediate the misconfiguration "GCP DNS Managed Zones Should Use Key Signing Key", we need to perform the following steps:

Step 1: Create a new Key Signing Key (KSK) in Cloud DNS

```
from google.cloud import dns

client = dns.Client()

zone_name = "example.com."
zone = client.zone(zone_name)

ksk = zone.create_dnssec_key(
    key_type=dns.DnssecKeyAlgorithm.RSASHA256,
    key_length=2048,
    key_signing=True
)

print("Created KSK with ID: {}".format(ksk.id))
```

Step 2: Update the DNSSEC configuration of the Managed Zone to use the new KSK

```
from google.cloud import dns

client = dns.Client()

zone_name = "example.com."
zone = client.zone(zone_name)

dnssec_config = zone.dnssec_config
dnssec_config.state = dns.DnssecState.ON
dnssec_config.default_key_signing_key = ksk.id

zone.update(dnssec_config=dnssec_config)
```

Step 3: Wait for the DNSSEC configuration to propagate

DNSSEC changes can take up to 24 hours to propagate, so we need to wait for the changes to take effect.

```
import time

time.sleep(3600) # Wait for 1 hour
```

That's it! The DNS Managed Zone in GCP should now be using a Key Signing Key.


</Tab>
</Tabs>