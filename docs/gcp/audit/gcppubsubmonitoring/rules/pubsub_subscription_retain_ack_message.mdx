---
slug: pubsub_subscription_retain_ack_message
title: PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping
sidebar_label: PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping
---

### More Info:

Ensure that PubSub Subscriptions retain acknowledged messages

### Risk Level

Low

### Address

Operational Excellence, Reliability

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Pub/Sub Subscriptions: From the main navigation menu (hamburger icon in the top left corner), select "Pub/Sub" and then "Subscriptions". This will display a list of all Pub/Sub subscriptions in your project.

3. Check Subscription Details: Click on the name of the subscription you want to check. This will open the subscription details page.

4. Verify Message Retention: In the subscription details page, look for the "Message Retention Duration" setting. If this is set to "0 days", then acknowledged messages are not being retained for record keeping.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI if you haven't done so already. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the Google Cloud SDK CLI is installed and configured, you can list all the PubSub subscriptions in your project by running the following command in your terminal:

   ```
   gcloud pubsub subscriptions list
   ```

   This command will return a list of all the PubSub subscriptions in your project, along with their details.

3. To check if a specific PubSub subscription retains acknowledged messages for record keeping, you can run the following command:

   ```
   gcloud pubsub subscriptions describe [SUBSCRIPTION_NAME]
   ```

   Replace `[SUBSCRIPTION_NAME]` with the name of the subscription you want to check. This command will return the details of the specified subscription.

4. In the output of the above command, look for the `retainAckedMessages` field. If this field is set to `true`, then the subscription retains acknowledged messages for record keeping. If it's set to `false` or if the field is not present, then the subscription does not retain acknowledged messages.

#### Using Python

1. Install the necessary Python libraries: To interact with Google Cloud Pub/Sub, you need to install the Google Cloud Client Library for Python. You can do this using pip:

   ```python
   pip install --upgrade google-cloud-pubsub
   ```

2. Import the necessary libraries and set up the client: In your Python script, you'll need to import the Pub/Sub library and set up a client using your Google Cloud project ID.

   ```python
   from google.cloud import pubsub_v1

   # TODO: replace 'your-project-id' with your project id.
   project_id = "your-project-id"
   client = pubsub_v1.SubscriberClient()
   ```

3. Get the list of all subscriptions: You can get a list of all subscriptions in your project using the `list_subscriptions` method. This method returns an iterator, so you can loop through it to get each subscription.

   ```python
   project_path = client.project_path(project_id)
   subscriptions = client.list_subscriptions(project_path)
   ```

4. Check the 'retain_acked_messages' property for each subscription: For each subscription, you can check the 'retain_acked_messages' property. If this property is set to False, then the subscription is not retaining acknowledged messages for record keeping.

   ```python
   for subscription in subscriptions:
       if not subscription.retain_acked_messages:
           print(f"Subscription {subscription.name} is not retaining acknowledged messages.")
   ```

This script will print out the names of all subscriptions in your project that are not retaining acknowledged messages. If no subscriptions are printed, then all subscriptions in your project are correctly configured to retain acknowledged messages.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping" for GCP using GCP console, follow these steps:

1. Open the Google Cloud Console and navigate to the Pub/Sub page.
2. Select the subscription that you want to configure.
3. Click on the "Edit" button at the top of the page.
4. In the "Message retention duration" section, select "Custom".
5. Enter the number of days that you want to retain acknowledged messages.
6. Click on the "Save" button to apply the changes.

By following these steps, you will remediate the misconfiguration "PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping" in GCP using GCP CLI, follow the below steps:

1. Open the Cloud Shell in the GCP console.
2. Run the following command to list all the subscriptions in the project:
```
gcloud pubsub subscriptions list
```
3. Identify the subscription that needs to be remediated.
4. Run the following command to update the subscription to retain acknowledged messages for 7 days:
```
gcloud pubsub subscriptions update <subscription-name> --ack-deadline=604800
```
Note: Replace `<subscription-name>` with the name of the subscription that needs to be remediated.
5. Verify the subscription has been updated by running the following command:
```
gcloud pubsub subscriptions describe <subscription-name>
```
6. Check the "ackDeadlineSeconds" field in the output of the above command. It should be set to 604800 (7 days).

By following the above steps, you can remediate the misconfiguration "PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping" for GCP using Python, you can follow the below steps:

1. First, you need to enable the retention policy for the subscription. You can do this by setting the `expiration_policy` property of the subscription object to a value greater than zero. This will ensure that the messages that have been acknowledged are retained for a certain period of time.

```python
from google.cloud import pubsub_v1

# Initialize PubSub client
client = pubsub_v1.SubscriberClient()

# Set the subscription path
subscription_path = client.subscription_path(project_id, subscription_name)

# Set the retention policy for the subscription
expiration_policy = {"ttl": {"seconds": 604800}}  # 7 days in seconds
update_mask = {"paths": ["expiration_policy"]}
subscription = client.update_subscription(request={"subscription": subscription_path, "expiration_policy": expiration_policy, "update_mask": update_mask})
```

2. Next, you need to modify your code to handle the retained messages. You can do this by setting the `return_immediately` parameter of the `pull` method to `False`. This will ensure that the method waits for the server to return any retained messages before returning.

```python
# Pull messages from the subscription
response = client.pull(request={"subscription": subscription_path, "max_messages": max_messages, "return_immediately": False})
```

3. Finally, you need to acknowledge the retained messages after processing them. You can do this by calling the `acknowledge` method of the `SubscriberClient` object and passing in the message IDs of the retained messages.

```python
# Acknowledge the messages
ack_ids = [msg.ack_id for msg in response.received_messages]
client.acknowledge(request={"subscription": subscription_path, "ack_ids": ack_ids})
```

By following these steps, you can remediate the misconfiguration "PubSub Subscriptions Should Retain Acknowledged Messages For Record Keeping" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/pubsub/docs/replay-overview](https://cloud.google.com/pubsub/docs/replay-overview) 


</Tab>
</Tabs>