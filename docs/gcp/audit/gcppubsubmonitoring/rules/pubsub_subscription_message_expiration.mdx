---
slug: pubsub_subscription_message_expiration
title: PubSub Subscriptions Should Have Set Expiration For Messages
sidebar_label: PubSub Subscriptions Should Have Set Expiration For Messages
---

### More Info:

Ensure that PubSub Subscriptions have set expiration

### Risk Level

Low

### Address

Operational Excellence, Cost Optimization

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) Console: Navigate to the GCP console (console.cloud.google.com) and log in with your credentials.

2. Navigate to Pub/Sub Subscriptions: From the GCP console dashboard, select the hamburger menu in the upper left-hand corner. Scroll down and click on "Pub/Sub" under the "Big Data" section. Then, click on "Subscriptions" in the left-hand menu.

3. Check Subscription Details: In the Subscriptions page, you will see a list of all your Pub/Sub subscriptions. Click on the name of the subscription you want to check. This will open the subscription details page.

4. Verify Message Expiration: In the subscription details page, look for the "Message retention duration" field. If this field is set to "default" or a value greater than 7 days, it means that the subscription does not have a set expiration for messages, which is a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI if you haven't done so already. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the Google Cloud SDK CLI is installed and configured, you can list all the PubSub subscriptions in your project by running the following command in your terminal:

   ```
   gcloud pubsub subscriptions list
   ```

   This command will return a list of all the PubSub subscriptions in your project, along with their details.

3. To check the expiration policy for a specific subscription, you can use the following command:

   ```
   gcloud pubsub subscriptions describe [SUBSCRIPTION_NAME]
   ```

   Replace `[SUBSCRIPTION_NAME]` with the name of the subscription you want to check. This command will return the details of the specified subscription, including its expiration policy.

4. Look for the `messageRetentionDuration` field in the output. This field indicates the duration for which PubSub will retain unacknowledged messages in the subscription, measured from the time the message is published. If this field is not set or is set to a value greater than 7 days, then the subscription does not have an expiration set for messages.

#### Using Python

1. Install Google Cloud SDK and Python Client for Pub/Sub: Before you start, make sure you have installed the Google Cloud SDK and the Python client for Pub/Sub. You can install the Python client with pip:

   ```
   pip install --upgrade google-cloud-pubsub
   ```

2. Import the necessary libraries and set up the client: You will need to import the `pubsub_v1` module from the `google.cloud` library. Then, you can set up the Pub/Sub client. You will need to authenticate with your Google Cloud credentials.

   ```python
   from google.cloud import pubsub_v1

   # TODO: replace 'your-project-id' with your project id
   project_id = 'your-project-id'
   subscriber = pubsub_v1.SubscriberClient()
   ```

3. Get the list of all subscriptions: You can get the list of all subscriptions in your project using the `list_subscriptions` method. This method returns an iterator, so you can loop through it to get all subscriptions.

   ```python
   subscriptions = subscriber.list_subscriptions(request={"project": project_id})
   ```

4. Check the expiration policy for each subscription: For each subscription, you can check the `expiration_policy` attribute. If this attribute is not set, it means that the messages in the subscription do not have an expiration.

   ```python
   for subscription in subscriptions:
       if not subscription.expiration_policy:
           print(f"Subscription {subscription.name} does not have an expiration policy set.")
   ```

This script will print the names of all subscriptions that do not have an expiration policy set. If no names are printed, it means that all subscriptions have an expiration policy.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of PubSub Subscriptions not having set expiration for messages in GCP using GCP console, you can follow the below steps:

1. Open the GCP console and navigate to the Pub/Sub section.
2. Select the Subscription that you want to remediate.
3. Click on the "Edit" button for the selected Subscription.
4. In the "Edit Subscription" window, scroll down to the "Message retention duration" section.
5. Set the message retention duration to the desired value. This value should be based on how frequently the Subscription is polled and how long it takes to process the messages.
6. Click on the "Save" button to save the changes.

By following these steps, you will remediate the misconfiguration of PubSub Subscriptions not having set expiration for messages in GCP using GCP console.

#### Using CLI

To remediate the issue of PubSub subscriptions not having set expiration for messages in GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to list all the subscriptions in your project:

   ```
   gcloud pubsub subscriptions list
   ```

3. Choose the subscription for which you want to set the expiration time for messages.

4. Run the following command to set the expiration time for messages in the chosen subscription:

   ```
   gcloud pubsub subscriptions update <subscription-name> --expiration-period=<duration>
   ```

   Replace `<subscription-name>` with the name of the chosen subscription and `<duration>` with the duration for which you want to set the expiration time for messages. The duration should be in the format of `n[d|h|m|s]` where `n` is the number of days, hours, minutes or seconds.

   For example, to set the expiration time for messages in a subscription named `my-subscription` to 7 days, run the following command:

   ```
   gcloud pubsub subscriptions update my-subscription --expiration-period=7d
   ```

5. Verify that the expiration time for messages has been set for the chosen subscription by running the following command:

   ```
   gcloud pubsub subscriptions describe <subscription-name>
   ```

   Replace `<subscription-name>` with the name of the chosen subscription. The output should display the expiration time for messages in the subscription.

By following these steps, you can remediate the issue of PubSub subscriptions not having set expiration for messages in GCP using GCP CLI.

#### Using Python

To remediate the issue of PubSub subscriptions not having set expiration for messages in GCP using Python, you can follow the below steps:

1. First, you need to identify the subscription(s) that do not have set expiration for messages. You can use the following command to list all subscriptions in a project:

   ```
   gcloud pubsub subscriptions list --format="value(name)"
   ```

   This will give you a list of all subscriptions in your project.

2. Once you have identified the subscription(s) that need to be remediated, you can use the Google Cloud Pub/Sub client library for Python to set the message expiration time for each subscription. Here is a sample Python script that sets the message expiration time for a subscription:

   ```
   from google.cloud import pubsub_v1
   import datetime

   # Set the expiration time for messages to 7 days from now
   expiration_time = datetime.timedelta(days=7)

   # Set the subscription name
   subscription_name = 'projects/<PROJECT_ID>/subscriptions/<SUBSCRIPTION_NAME>'

   # Create a Pub/Sub subscriber client
   subscriber = pubsub_v1.SubscriberClient()

   # Set the subscription message retention duration
   subscription_path = subscriber.subscription_path(
       '<PROJECT_ID>', '<SUBSCRIPTION_NAME>')
   subscription = subscriber.modify_push_config(
       subscription_path,
       push_config=pubsub_v1.types.PushConfig(
           expiration_policy=expiration_time))

   # Print the updated subscription information
   print('Subscription {} updated with expiration time: {}'.format(
       subscription_name, expiration_time))
   ```

   Replace `<PROJECT_ID>` and `<SUBSCRIPTION_NAME>` with your project ID and subscription name respectively.

3. Run the Python script to set the message expiration time for the subscription(s) that need to be remediated.

   ```
   python set_subscription_expiration.py
   ```

   This will update the subscription(s) with the message expiration time and print the updated subscription information.

By following these steps, you can remediate the issue of PubSub subscriptions not having set expiration for messages in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/pubsub/docs/subscriber](https://cloud.google.com/pubsub/docs/subscriber) 


</Tab>
</Tabs>