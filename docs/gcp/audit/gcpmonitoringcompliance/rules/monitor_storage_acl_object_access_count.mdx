---
slug: monitor_storage_acl_object_access_count
title: Cloud Monitoring Should Monitor Storage ACL Based Object Access Count
sidebar_label: Cloud Monitoring Should Monitor Storage ACL Based Object Access Count
---

### More Info:

Ensure Cloud Monitoring monitors storage ACL based object access count.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Console: Open your web browser and navigate to the Google Cloud Console (console.cloud.google.com). Enter your login credentials to access your GCP account.

2. Navigate to Monitoring: Once you are logged in, click on the navigation menu (three horizontal lines) located at the top left corner of the console. Scroll down and click on "Monitoring" under the "Operations" section.

3. Access Metrics Explorer: In the Monitoring dashboard, click on "Metrics Explorer" on the left-hand side menu. This will open a new page where you can explore and analyze your metrics.

4. Check Storage ACL Based Object Access Count: In the "Find resource type and metric" field, type "Storage" and select "Cloud Storage Bucket". Then, in the "Metric" field, type "ACL Based Object Access Count". The graph will show the count of ACL based object access. If there is a significant increase in the count, it might indicate a misconfiguration.

#### Using CLI

1. Install and authenticate Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine and authenticate it. You can download the SDK from the official Google Cloud website and authenticate it using the command `gcloud auth login`.

2. Enable Monitoring API: To monitor storage ACL based object access count, you need to enable the Monitoring API. You can do this using the following command: `gcloud services enable monitoring.googleapis.com`.

3. List Metrics: Once the Monitoring API is enabled, you can list all the metrics that are being monitored using the following command: `gcloud beta monitoring metrics list`. This will give you a list of all the metrics that are being monitored.

4. Check Storage ACL Based Object Access Count: To check the storage ACL based object access count, you need to look for the metric `storage.googleapis.com/network/request_count`. This metric counts the number of HTTP/S requests made to a bucket. You can filter for this metric using the following command: `gcloud beta monitoring metrics list | grep storage.googleapis.com/network/request_count`. If this metric is not being monitored, it means that the storage ACL based object access count is not being monitored.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries. For this task, we will need the `google.cloud` library. If it's not already installed, you can install it using pip: `pip install google-cloud-monitoring`.

```python
from google.cloud import monitoring_v3
```

2. **Initialize the Client**: The next step is to initialize the client. You will need to authenticate with your GCP account. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file.

```python
client = monitoring_v3.MetricServiceClient()
project_id = "your-project-id"  # replace with your project id
project_name = f"projects/{project_id}"
```

3. **Create the Filter**: Now, we need to create a filter to get the metrics we want. In this case, we want the `storage.googleapis.com/network/request_count` metric, which counts the number of HTTP requests made to a bucket.

```python
filter = 'metric.type="storage.googleapis.com/network/request_count"'
```

4. **List Time Series Data**: Finally, we can use the `list_time_series` method to get the data. This method returns an iterator over time series data.

```python
response = client.list_time_series(
    request={
        "name": project_name,
        "filter": filter,
        "interval": {"start_time": {"seconds": 0}, "end_time": {"seconds": 0}},
        "view": monitoring_v3.ListTimeSeriesRequest.TimeSeriesView.FULL,
    }
)

for series in response:
    print(series)
```

This script will print out all the time series data that matches the filter. You can then analyze this data to detect any misconfigurations.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Cloud Monitoring Should Monitor Storage ACL Based Object Access Count" for GCP using the GCP console, you can follow the below steps:

1. Go to the GCP console and navigate to the Cloud Storage section.

2. Select the bucket for which you want to enable ACL based object access count monitoring.

3. Click on the "Edit bucket permissions" button located on the top of the page.

4. Under the "Add members" section, add the email address of the user or service account for which you want to enable ACL based object access count monitoring.

5. Select the "Storage Object Viewer" role for the added member.

6. Click on the "Add" button to add the member to the bucket's permissions.

7. Go to the Cloud Monitoring section of the GCP console.

8. Click on the "Uptime checks" tab and then click on the "Create uptime check" button.

9. Enter the required details for the uptime check, such as the name, check frequency, and target.

10. Under the "Advanced options" section, enable the "Log matched log entries" option.

11. Under the "Log-based metrics" section, select "Cloud Storage" as the log source and then select the log name for the bucket for which you enabled ACL based object access count monitoring.

12. Set the required filters for the log-based metric and then click on the "Create" button.

By following these steps, you can remediate the misconfiguration "Cloud Monitoring Should Monitor Storage ACL Based Object Access Count" for GCP using the GCP console.

#### Using CLI

To remediate the misconfiguration "Cloud Monitoring Should Monitor Storage ACL Based Object Access Count" for GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP Console.
2. Run the following command to enable Cloud Storage access logs:

   `gsutil logging set on gs://[BUCKET_NAME]`

   Replace `[BUCKET_NAME]` with the name of the bucket you want to enable access logs for.

3. Run the following command to create a new bucket for the access logs:

   `gsutil mb -p [PROJECT_ID] -c regional -l [REGION] gs://[BUCKET_NAME]`

   Replace `[PROJECT_ID]` with your GCP project ID, `[REGION]` with the region where you want to create the bucket, and `[BUCKET_NAME]` with the name of the bucket you want to create.

4. Run the following command to set the logging configuration for the bucket:

   ```
   gsutil logging set on -b gs://[BUCKET_NAME] \
   -o AccessLog \
   -t '[START_TIME],[END_TIME],[METHOD],[RESOURCE],[PROTOCOL],[STATUS],[REQUESTER],[REQUEST_ID],[OBJECT_SIZE],[VERSION_ID],[BUCKET_NAME],[OBJECT_NAME],[REMOTE_IP],[SERVER_IP],[REFERER],[USER_AGENT],[VERSION_FORMAT],[ERROR_CODE],[ERROR_MESSAGE]' \
   gs://[BUCKET_NAME]
   ```

   Replace `[BUCKET_NAME]` with the name of the bucket you want to enable access logs for.

5. Verify that access logs are being written to the bucket by running the following command:

   `gsutil ls -la gs://[BUCKET_NAME]/`

   Replace `[BUCKET_NAME]` with the name of the bucket you created in step 3.

6. You can now use Cloud Monitoring to monitor the access logs and count the number of ACL-based object accesses. To do this, follow these steps:

   a. Open the Cloud Monitoring console in the GCP Console.
   
   b. Click on "Metrics Explorer" in the left-hand menu.
   
   c. In the "Find resource type and metric" search box, type "gcs_bucket_access_count".
   
   d. Select the "gcs_bucket_access_count" metric from the list.
   
   e. In the "Filter by label" section, select the bucket you want to monitor.
   
   f. Click on "Add filter".
   
   g. In the "Find resource type and metric" search box, type "gcs_bucket_accessed_via_acl_count".
   
   h. Select the "gcs_bucket_accessed_via_acl_count" metric from the list.
   
   i. In the "Filter by label" section, select the bucket you want to monitor.
   
   j. Click on "Add filter".
   
   k. Click on "Create chart" to create a chart showing the number of ACL-based object accesses for the selected bucket.

That's it! You have now remediated the misconfiguration "Cloud Monitoring Should Monitor Storage ACL Based Object Access Count" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of monitoring storage ACL based object access count in GCP using python, you can follow these steps:

1. First, you need to enable Cloud Storage API in your GCP project.

2. Next, you need to install the Google Cloud Storage Python client library by running the following command:

   ```
   pip install google-cloud-storage
   ```

3. Once the library is installed, you can use the following python code to monitor the storage ACL based object access count:

   ```
   from google.cloud import storage

   # Instantiates a client
   storage_client = storage.Client()

   # The name of the bucket
   bucket_name = "your-bucket-name"

   # The name of the object
   object_name = "your-object-name"

   # Get the bucket object
   bucket = storage_client.get_bucket(bucket_name)

   # Get the object ACL
   acl = bucket.get_blob(object_name).acl

   # Get the number of users with read permission
   num_users = len([e for e in acl if e.get("role") == "READER"])

   # Get the number of users with write permission
   num_writers = len([e for e in acl if e.get("role") == "WRITER"])

   # Log the access count
   print(f"Object {object_name} has been accessed by {num_users} readers and {num_writers} writers.")
   ```

4. You can run this code periodically to monitor the storage ACL based object access count in your GCP project. You can also modify this code to send alerts or notifications when access count exceeds a certain threshold.

By following these steps, you can remediate the misconfiguration of monitoring storage ACL based object access count in GCP using python.


### Additional Reading:

- [https://cloud.google.com/monitoring/api/metrics_gcp](https://cloud.google.com/monitoring/api/metrics_gcp) 


</Tab>
</Tabs>