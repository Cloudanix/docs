---
slug: monitor_use_https_for_backend_resource_health_check
title: Cloud Monitoring Should Use HTTPS For Backend Resource Health Check
sidebar_label: Cloud Monitoring Should Use HTTPS For Backend Resource Health Check
---

### More Info:

Ensure that GCP Cloud Monitoring uses HTTPS only for checking the health of backend resources.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access the GCP resources.

2. Navigate to the Monitoring Dashboard: From the GCP Console dashboard, click on the navigation menu (three horizontal lines in the upper left corner), scroll down and click on "Monitoring" under the "Operations" section.

3. Check the Backend Services: In the Monitoring dashboard, click on "Uptime checks" in the left-hand menu. Here, you can see all the backend services that are being monitored. 

4. Verify HTTPS Usage: For each backend service, check the protocol used for health checks. If the protocol is not HTTPS, then it is a misconfiguration. The protocol can be found in the "Protocol" column of the "Uptime checks" page. If HTTPS is not being used, it indicates that the health checks are not secure, which is a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your CLI with your Google Cloud account. You can do this by running the following command in your terminal:
   ```
   gcloud auth login
   ```
   Follow the prompts to log in with your Google account.

3. List all the health checks in your project by running the following command:
   ```
   gcloud compute health-checks list
   ```
   This will display a list of all the health checks in your project.

4. For each health check, check if HTTPS is being used for backend resource health check. You can do this by running the following command for each health check:
   ```
   gcloud compute health-checks describe [HEALTH_CHECK_NAME]
   ```
   Replace `[HEALTH_CHECK_NAME]` with the name of the health check. In the output, look for the `checkIntervalSec` field. If the value of this field is `HTTPS`, then HTTPS is being used for the backend resource health check. If the value is not `HTTPS`, then HTTPS is not being used, indicating a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: To interact with Google Cloud Platform (GCP), you need to install the Google Cloud SDK and the Python client library. You can install these using pip:

   ```python
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-cloud-monitoring
   ```

2. Authenticate your SDK: Before you can interact with GCP, you need to authenticate your SDK. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key JSON file.

   ```python
   import os
   os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="/path/to/your/service-account-file.json"
   ```

3. Create a client for the Monitoring service: Once you've authenticated your SDK, you can create a client for the Monitoring service. This client will allow you to interact with the Monitoring API.

   ```python
   from google.cloud import monitoring_v3
   client = monitoring_v3.MetricServiceClient()
   ```

4. Check the backend health check configuration: Now you can use the client to check the backend health check configuration. You can do this by calling the `list_monitored_resource_descriptors` method on the client and checking the `type` and `labels.scheme` of each descriptor. If the `type` is `http` and the `labels.scheme` is not `HTTPS`, then the backend health check is not using HTTPS.

   ```python
   project_name = f"projects/{project_id}"
   descriptors = client.list_monitored_resource_descriptors(name=project_name)
   for descriptor in descriptors:
       if descriptor.type == "http" and descriptor.labels.scheme != "HTTPS":
           print(f"Backend health check is not using HTTPS: {descriptor.name}")
   ```
   
Please note that you need to replace `project_id` with your actual GCP project ID.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Cloud Monitoring Should Use HTTPS For Backend Resource Health Check" for GCP using GCP console, please follow the below steps:

1. Login to your GCP console.
2. Go to the Cloud Monitoring page.
3. In the left navigation menu, select "Uptime Checks".
4. Select the uptime check that needs to be remediated.
5. Click on the "Edit" button.
6. In the "Check Request" section, select "HTTPS" as the protocol.
7. In the "Check Request" section, enter the URL of the backend resource.
8. In the "Check Request" section, select the appropriate HTTP method.
9. In the "Advanced Settings" section, select "Require valid SSL certificate" checkbox.
10. Click on the "Save" button to save the changes.

After following the above steps, the misconfiguration "Cloud Monitoring Should Use HTTPS For Backend Resource Health Check" will be remediated for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Cloud Monitoring Should Use HTTPS For Backend Resource Health Check" for GCP using GCP CLI, follow the below steps:

1. Open the Cloud Shell in the GCP console.

2. Run the following command to set the default project:

```
gcloud config set project [PROJECT_ID]
```

3. Run the following command to update the health check configuration:

```
gcloud compute health-checks update https [HEALTH_CHECK_NAME] --use-https
```

Replace [HEALTH_CHECK_NAME] with the name of the health check you want to update.

4. Verify the updated configuration by running the following command:

```
gcloud compute health-checks describe [HEALTH_CHECK_NAME]
```

This will display the details of the health check, including the use of HTTPS.

By following these steps, you can remediate the misconfiguration "Cloud Monitoring Should Use HTTPS For Backend Resource Health Check" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Cloud Monitoring Should Use HTTPS For Backend Resource Health Check" in GCP using Python, follow these steps:

1. Import the required libraries for interacting with GCP using Python. For example, you can use the `google-auth` and `google-api-python-client` libraries.

```
from google.oauth2 import service_account
from googleapiclient.discovery import build
```

2. Set up the authentication credentials using a service account key file. You can create a service account with the required permissions for the Cloud Monitoring API in the GCP console and download the key file.

```
credentials = service_account.Credentials.from_service_account_file(
    'path/to/service_account_key.json')
```

3. Create a client object for the Cloud Monitoring API using the `build` function and the appropriate API version.

```
monitoring_client = build('monitoring', 'v3', credentials=credentials)
```

4. Get the list of backend services in the project using the `list` method of the `backendServices` resource.

```
backend_services = monitoring_client.projects().backendServices().list(
    name='projects/<project_id>').execute()
```

5. For each backend service, check if the health check protocol is set to HTTPS. If not, update the backend service using the `update` method of the `backendServices` resource.

```
for backend_service in backend_services.get('backendServices', []):
    if backend_service.get('healthChecks')[0].startswith('https://'):
        continue
    else:
        backend_service['healthChecks'][0] = 'https://' + backend_service['healthChecks'][0][7:]
        monitoring_client.projects().backendServices().update(
            name=backend_service['name'], body=backend_service).execute()
```

6. Save the Python script and run it using a Python interpreter.

These steps will remediate the misconfiguration "Cloud Monitoring Should Use HTTPS For Backend Resource Health Check" in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/monitoring/uptime-checks](https://cloud.google.com/monitoring/uptime-checks) 


</Tab>
</Tabs>