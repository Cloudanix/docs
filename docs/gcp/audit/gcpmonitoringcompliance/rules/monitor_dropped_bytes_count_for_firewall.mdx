---
slug: monitor_dropped_bytes_count_for_firewall
title: Cloud Monitoring Should Monitor Dropped Bytes Count For Firewall
sidebar_label: Cloud Monitoring Should Monitor Dropped Bytes Count For Firewall
---

### More Info:

Ensure Cloud Monitoring monitors dropped bytes count for firewall.

### Risk Level

Medium

### Address

Security, Performance Efficiency, Reliability

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to https://console.cloud.google.com/ and enter your login credentials.

2. Navigate to Monitoring: Once you are logged in, click on the navigation menu (three horizontal lines on the top left corner), scroll down and click on "Monitoring".

3. Check the Firewall Metrics: In the Monitoring dashboard, click on "Metrics Explorer" on the left-hand side. In the "Find resource type and metric" field, type "Firewall" and select "Firewall Rule" from the dropdown. In the "Metric" field, type "Dropped Bytes Count" and select it from the dropdown. 

4. Analyze the Data: After selecting the "Dropped Bytes Count" metric, you will see a graph displaying the number of dropped bytes over time. You can adjust the time range and frequency of the data points to get a more detailed view. If there are any significant spikes or unusual patterns, it may indicate a misconfiguration or issue with your firewall.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: The Google Cloud SDK includes the gcloud command-line tool, which is necessary to interact with GCP services. You can install it by following the instructions provided by Google Cloud. After installation, you need to authenticate your Google Cloud account using the command `gcloud auth login`.

2. List all the metrics descriptors: You can list all the metrics descriptors available in your project using the following command:
```
gcloud logging metrics list
```
This command will return a list of all the metrics descriptors in your project.

3. Check for the specific metric: Now, you need to check whether the 'Dropped Bytes Count For Firewall' metric is being monitored or not. You can do this by running the following command:
```
gcloud logging metrics describe dropped_bytes_count
```
Replace 'dropped_bytes_count' with the exact name of the metric you are looking for. This command will return the details of the metric if it exists.

4. If the metric does not exist, it means that Cloud Monitoring is not monitoring the 'Dropped Bytes Count For Firewall'. If the metric exists, you need to check its configuration to ensure it is set up correctly.

#### Using Python

1. **Setup Python Environment:**
   First, you need to set up your Python environment. Install the necessary libraries such as `google-cloud-monitoring` for GCP, `boto3` for AWS, and `azure-mgmt-monitor` for Azure. You can install these libraries using pip:
   ```python
   pip install google-cloud-monitoring boto3 azure-mgmt-monitor
   ```

2. **Create a Python Script to Check Dropped Bytes Count For Firewall:**
   You need to create a Python script that uses the respective cloud SDKs to fetch the metrics related to the dropped bytes count for the firewall.

   - For GCP:
     ```python
     from google.cloud import monitoring_v3

     client = monitoring_v3.MetricServiceClient()
     project_name = client.project_path("your-project-id")

     metrics = client.list_time_series(
         project_name,
         'metric.type="firewallinsights.googleapis.com/dropped_bytes_count"',
         interval,
         monitoring_v3.enums.ListTimeSeriesRequest.TimeSeriesView.FULL
     )
     for metric in metrics:
         print(metric)
     ```
   - For AWS:
     ```python
     import boto3

     client = boto3.client('cloudwatch')
     metrics = client.get_metric_statistics(
         Namespace='AWS/NetworkFirewall',
         MetricName='DroppedBytes',
         StartTime='2021-01-01T00:00:00Z',
         EndTime='2021-12-31T23:59:59Z',
         Period=3600,
         Statistics=['SampleCount', 'Average', 'Sum', 'Minimum', 'Maximum'],
     )
     print(metrics)
     ```
   - For Azure:
     ```python
     from azure.mgmt.monitor import MonitorManagementClient
     from azure.common.credentials import ServicePrincipalCredentials

     credentials = ServicePrincipalCredentials(
         client_id='your-client-id',
         secret='your-secret',
         tenant='your-tenant-id'
     )
     client = MonitorManagementClient(credentials, 'your-subscription-id')
     metrics_data = client.metrics.list(
         'resource-uri',
         timespan='2021-01-01T00:00:00Z/2021-12-31T23:59:59Z',
         interval='PT1H',
         metricnames='DroppedBytes',
         aggregation='Total'
     )
     print(metrics_data.value)
     ```

3. **Run the Python Script:**
   Run the Python script you created in the previous step. This script will fetch the metrics related to the dropped bytes count for the firewall from the respective cloud provider.

4. **Analyze the Output:**
   Analyze the output of the Python script. If the dropped bytes count for the firewall is higher than expected, it indicates a misconfiguration in the firewall settings.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the "Cloud Monitoring Should Monitor Dropped Bytes Count For Firewall" misconfiguration for GCP using the GCP console:

1. Open the GCP Console and navigate to the Firewall rules page by selecting "Firewall" under the "VPC Network" section in the left-hand menu.

2. Find the firewall rule that you want to monitor and click on its name to open its details page.

3. Click on the "Logs" tab to view the firewall logs.

4. In the logs, look for any entries related to dropped bytes. If you see any such entries, then your firewall is dropping traffic and you need to investigate further to determine whether this is expected behavior or not.

5. To monitor dropped bytes count, you need to create a log-based metric. Click on the "Create Metric" button to create a new metric.

6. Give your metric a name and a description. For example, you can name it "Dropped Bytes Count" and give it a description like "Number of bytes dropped by the firewall".

7. Under the "Filter" section, enter the following filter expression:

    ```
    resource.type="gce_subnetwork"
    log_name="projects/[PROJECT_ID]/logs/compute.googleapis.com%2Ffirewall"
    protoPayload.rule_details.action="DENY"
    ```

    Replace `[PROJECT_ID]` with your actual GCP project ID.

8. Set the metric aggregation to "Sum" and the metric unit to "By".

9. Click on the "Create Metric" button to create the new metric.

10. Now that you have created the metric, you can create a Cloud Monitoring alert based on it. Click on the "Create Alerting Policy" button to create a new alerting policy.

11. Give your alerting policy a name and a description.

12. Under the "Condition" section, select your newly created "Dropped Bytes Count" metric.

13. Set the threshold and duration for the alert. For example, you can set the threshold to "10" and the duration to "5 minutes".

14. Under the "Notification" section, select the notification channels where you want to receive alerts.

15. Click on the "Save" button to create the new alerting policy.

That's it! You have now remediated the "Cloud Monitoring Should Monitor Dropped Bytes Count For Firewall" misconfiguration for GCP using the GCP console.

#### Using CLI

To remediate the misconfiguration of monitoring dropped bytes count for firewall in GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in the GCP console.

2. Run the following command to list all the firewalls in your GCP project:

   ```
   gcloud compute firewall-rules list
   ```

3. Identify the firewall rule that needs to be remediated.

4. Run the following command to update the firewall rule and enable monitoring of dropped bytes count:

   ```
   gcloud compute firewall-rules update [FIREWALL_RULE_NAME] --enable-logging --log-config="metadata:INCLUDE_ALL_SCOPES,DROPPED_BYTES"
   ```

   Replace `[FIREWALL_RULE_NAME]` with the name of the firewall rule that needs to be updated.

5. Verify that the logging is enabled for the firewall rule by running the following command:

   ```
   gcloud compute firewall-rules describe [FIREWALL_RULE_NAME] --format="value(logConfig.enable)"
   ```

   This command should return `True` indicating that logging is enabled for the firewall rule.

By following these steps, you can remediate the misconfiguration of monitoring dropped bytes count for firewall in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of dropped bytes count for firewall in GCP using Python, you can follow the below steps:

1. First, you need to enable the Stackdriver Monitoring API in your GCP project.

2. Then, you need to install the `google-cloud-monitoring` library using the following command:

   ```
   pip install google-cloud-monitoring
   ```

3. Next, you need to create a Python script to monitor the dropped bytes count for firewall. Here is an example script:

   ```
   from google.cloud import monitoring_v3

   client = monitoring_v3.MetricServiceClient()

   project_name = client.project_path('<your-project-id>')
   filter_str = 'metric.type="compute.googleapis.com/firewall/dropped_bytes_count"'

   results = client.list_time_series(
       project_name,
       filter_str,
       interval={
           'end_time': {
               'seconds': int(time.time()),
           },
           'start_time': {
               'seconds': int(time.time()) - 3600,
           },
       },
       view=monitoring_v3.ListTimeSeriesRequest.TimeSeriesView.FULL)

   for result in results:
       print(result)
   ```

4. Replace `<your-project-id>` with your actual GCP project ID.

5. Run the script and it will print the dropped bytes count for firewall in the last hour.

6. You can then set up alerts in Stackdriver Monitoring based on this metric to get notified when the dropped bytes count exceeds a certain threshold.

By following these steps, you can remediate the misconfiguration of dropped bytes count for firewall in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/monitoring/api/metrics_gcp](https://cloud.google.com/monitoring/api/metrics_gcp) 


</Tab>
</Tabs>