---
slug: monitor_dropped_packets_count_for_firewall
title: Cloud Monitoring Should Monitor Dropped Packets Count For Firewall
sidebar_label: Cloud Monitoring Should Monitor Dropped Packets Count For Firewall
---

### More Info:

Ensure Cloud Monitoring monitors dropped packets count for firewall.

### Risk Level

Medium

### Address

Security, Performance Efficiency, Reliability

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to the GCP console (console.cloud.google.com) and log in with your credentials.

2. Navigate to Monitoring: On the left-hand side navigation menu, click on "Monitoring" or "Operations" (the name may vary depending on the updates). This will take you to the Cloud Monitoring dashboard.

3. Check Firewall Metrics: In the Monitoring dashboard, navigate to the "Metrics Explorer" which is under the "Monitoring" section. In the "Find resource type and metric" field, type and select "firewallinsight" as the resource type. Then, in the same field, type and select "Dropped Packets" as the metric. 

4. Analyze the Data: After selecting the appropriate resource type and metric, the graph below will update to reflect the dropped packets count for the firewall. You can adjust the time range and frequency to better understand the pattern of dropped packets. If the graph shows a high number of dropped packets, it indicates a misconfiguration in the firewall rules.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: The Google Cloud SDK includes the gcloud command-line tool, which is necessary to interact with GCP services. You can install it by following the instructions provided by Google Cloud. After installation, authenticate the SDK using the command `gcloud auth login`.

2. List all the monitoring metrics: Use the following command to list all the monitoring metrics in your GCP project. This will help you to identify whether the Dropped Packets Count for Firewall is being monitored or not.

    ```
    gcloud monitoring metrics list
    ```

3. Filter the metrics for Firewall Dropped Packets: The output of the above command will be a long list of metrics. You need to filter out the metrics related to Firewall Dropped Packets. You can do this by using the grep command in Unix-based systems or findstr command in Windows.

    ```
    gcloud monitoring metrics list | grep "firewall"
    ```

4. Check for the specific metric: Look for the specific metric "dropped_packets_count". If this metric is present in the list, it means that Cloud Monitoring is monitoring the Dropped Packets Count for Firewall. If it is not present, then it is not being monitored.

    ```
    gcloud monitoring metrics list | grep "dropped_packets_count"
    ```

#### Using Python

1. **Setup Python Environment:**
   First, you need to set up your Python environment. Install the necessary libraries such as `google-cloud-monitoring` for GCP, `boto3` for AWS, and `azure-mgmt-monitor` for Azure. You can install these libraries using pip:
   ```python
   pip install google-cloud-monitoring boto3 azure-mgmt-monitor
   ```

2. **GCP:**
   For Google Cloud Platform, you can use the `google-cloud-monitoring` library to check the dropped packets count for firewall. Here is a sample script:
   ```python
   from google.cloud import monitoring_v3

   client = monitoring_v3.MetricServiceClient()
   project_name = client.project_path("your-project-id")

   metrics = client.list_time_series(
       project_name,
       'metric.type="compute.googleapis.com/firewall/dropped_packets_count"',
       monitoring_v3.types.TimeInterval(
           end_time=monitoring_v3.types.Timestamp(seconds=int(time.time())),
           start_time=monitoring_v3.types.Timestamp(seconds=int(time.time()) - 3600),
       ),
       monitoring_v3.enums.ListTimeSeriesRequest.TimeSeriesView.FULL,
   )

   for metric in metrics:
       print(metric)
   ```
   This script will print the metrics for dropped packets count for the firewall in the last hour.

3. **AWS:**
   For AWS, you can use the `boto3` library to check the dropped packets count for firewall. Here is a sample script:
   ```python
   import boto3

   client = boto3.client('cloudwatch')

   response = client.get_metric_statistics(
       Namespace='AWS/NetworkELB',
       MetricName='DroppedPacketsCount',
       Dimensions=[
           {
               'Name': 'LoadBalancer',
               'Value': 'your-load-balancer-name'
           },
       ],
       StartTime=datetime.datetime.utcnow() - datetime.timedelta(seconds=600),
       EndTime=datetime.datetime.utcnow(),
       Period=60,
       Statistics=[
           'SampleCount',
       ],
   )

   print(response)
   ```
   This script will print the metrics for dropped packets count for the firewall in the last 10 minutes.

4. **Azure:**
   For Azure, you can use the `azure-mgmt-monitor` library to check the dropped packets count for firewall. Here is a sample script:
   ```python
   from azure.mgmt.monitor import MonitorManagementClient
   from azure.common.credentials import ServicePrincipalCredentials

   credentials = ServicePrincipalCredentials(
       client_id='your-client-id',
       secret='your-secret',
       tenant='your-tenant-id'
   )

   client = MonitorManagementClient(credentials, 'your-subscription-id')

   metrics_data = client.metrics.list(
       'resource-uri',
       timespan='PT1H',
       interval='PT1M',
       metricnames='DroppedPacketsCount',
       aggregation='Total'
   )

   for item in metrics_data.value:
       print(item)
   ```
   This script will print the metrics for dropped packets count for the firewall in the last hour.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of not monitoring dropped packets count for firewall in GCP using GCP console, please follow the below steps:

1. Login to the GCP console.
2. Select the project in which the firewall is configured.
3. Navigate to the VPC Network page from the left-hand side menu.
4. Click on the Firewall rules tab.
5. Click on the Edit button (pencil icon) next to the firewall rule you want to modify.
6. Scroll down to the Logs section and select the checkbox for "Log dropped packets."
7. Click on the Save button to save the changes.

By enabling logging for dropped packets, you can monitor and analyze the traffic that is being blocked by your firewall. This can help you identify potential security threats and take appropriate actions to mitigate them.

#### Using CLI

To remediate the misconfiguration of dropped packets count for firewall in GCP using GCP CLI, follow the below steps:

1. Open the GCP Cloud Shell.

2. Run the following command to list all the firewall rules in your project:

   ```
   gcloud compute firewall-rules list
   ```

3. Identify the firewall rule that needs to be modified.

4. Run the following command to update the firewall rule and enable logging for dropped packets:

   ```
   gcloud compute firewall-rules update [FIREWALL_RULE_NAME] --enable-logging --log-config="metadata:include-all-scopes=true"
   ```
   Replace `[FIREWALL_RULE_NAME]` with the name of the firewall rule that needs to be modified.

5. Verify that the logging is enabled for the firewall rule by running the following command:

   ```
   gcloud compute firewall-rules describe [FIREWALL_RULE_NAME]
   ```
   Replace `[FIREWALL_RULE_NAME]` with the name of the firewall rule that was modified.

6. Check the logs in the Logging section of the GCP Console to ensure that the dropped packets count is being monitored.

By following these steps, you can remediate the misconfiguration of dropped packets count for firewall in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of not monitoring the dropped packet count for Firewall in GCP using Python, follow the below steps:

1. Install the required libraries: 

   ```
   pip install google-cloud-monitoring google-auth google-auth-oauthlib google-auth-httplib2
   ```

2. Authenticate with GCP: 

   ```
   from google.oauth2 import service_account
   credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_file>')
   ```
   
3. Import the necessary libraries:

   ```
   from google.cloud import monitoring_v3
   from google.api_core.exceptions import AlreadyExists
   ```
   
4. Set the project ID and the client:

   ```
   project_id = '<your_project_id>'
   client = monitoring_v3.MetricServiceClient(credentials=credentials)
   ```

5. Define the metric descriptor:

   ```
   descriptor = monitoring_v3.types.MetricDescriptor()
   descriptor.type = 'custom.googleapis.com/firewall/dropped_packets'
   descriptor.metric_kind = monitoring_v3.enums.MetricDescriptor.MetricKind.GAUGE
   descriptor.value_type = monitoring_v3.enums.MetricDescriptor.ValueType.INT64
   descriptor.description = 'Dropped Packets Count for Firewall'
   descriptor.unit = '1'
   ```

6. Create the metric descriptor:

   ```
   try:
       client.create_metric_descriptor(project_id, descriptor)
   except AlreadyExists:
       pass
   ```

7. Define the time series data:

   ```
   series = monitoring_v3.types.TimeSeries()
   series.metric.type = 'custom.googleapis.com/firewall/dropped_packets'
   series.resource.type = 'global'
   series.resource.labels['project_id'] = project_id
   series.points.add(value=10)
   ```

8. Write the time series data:

   ```
   client.create_time_series(project_id, [series])
   ```
   
With these steps, the misconfiguration of not monitoring the dropped packet count for Firewall in GCP can be remediated using Python.


### Additional Reading:

- [https://cloud.google.com/monitoring/api/metrics_gcp](https://cloud.google.com/monitoring/api/metrics_gcp) 


</Tab>
</Tabs>