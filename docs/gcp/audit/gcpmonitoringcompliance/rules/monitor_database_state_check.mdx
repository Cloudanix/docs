---
slug: monitor_database_state_check
title: Cloud Monitoring Should Monitor Database State Check
sidebar_label: Cloud Monitoring Should Monitor Database State Check
---

### More Info:

Ensure Cloud Monitoring monitors database state check.

### Risk Level

Medium

### Address

Operational Maturity, Performance Efficiency

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to the GCP console (console.cloud.google.com) and sign in with your Google account that has the necessary permissions to access the GCP resources.

2. Navigate to Monitoring: From the GCP console dashboard, click on the navigation menu (three horizontal lines on the top left corner), scroll down and click on "Monitoring" under the "Operations" section.

3. Check for Database State: In the Monitoring dashboard, click on "Uptime checks" under the "Alerting" section. Here, you can see all the uptime checks configured for your resources. Look for any checks related to your database state. If there are any, it means your database state is being monitored.

4. Verify the Configuration: Click on the specific uptime check for your database to view its details. Ensure that the check is correctly configured to monitor the desired aspects of your database state. The configuration should include the correct resource type, check type, and other parameters as per your requirements.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After installation, authenticate your account using the command `gcloud auth login`.

2. List all the monitored resources: Use the following command to list all the monitored resources in your GCP project:

   ```
   gcloud monitoring dashboards list
   ```

   This command will return a list of all the dashboards and their details in your project.

3. Check the monitoring configuration for the database: Use the following command to describe the details of a specific dashboard:

   ```
   gcloud monitoring dashboards describe [DASHBOARD_ID]
   ```

   Replace `[DASHBOARD_ID]` with the ID of the dashboard that monitors your database. This command will return the configuration of the dashboard, including the metrics it monitors.

4. Check if the database state is being monitored: In the output of the previous command, look for the `uptime_check_config` field. If it contains a check for the `database` resource type, then the database state is being monitored. If not, then the database state is not being monitored.

#### Using Python

1. **Import Necessary Libraries**: The first step is to import the necessary libraries in your Python script. You will need the `google-cloud-monitoring` library to interact with GCP's Monitoring API. If you haven't installed it yet, you can do so using pip: `pip install --upgrade google-cloud-monitoring`. Then, in your script, import it as follows:

```python
from google.cloud import monitoring_v3
```

2. **Initialize the Client**: The next step is to initialize the client. This will allow you to interact with the Monitoring API. You will need to authenticate using your GCP credentials. Here's how you can do it:

```python
client = monitoring_v3.MetricServiceClient()
project_name = client.project_path("your-project-id")
```

3. **List Metrics Descriptors**: Now, you can list all the metric descriptors in your project. This will give you a list of all the metrics that are being monitored in your project. You can do this as follows:

```python
metrics = client.list_metric_descriptors(name=project_name)
for metric in metrics:
    print(metric.type)
```

4. **Check for Database State Metric**: Finally, you can check if the `cloudsql.googleapis.com/database/state` metric is being monitored. This metric indicates the state of the database. You can do this by checking if this metric is in the list of metrics you obtained in the previous step. Here's how you can do it:

```python
database_state_metric = 'cloudsql.googleapis.com/database/state'
if database_state_metric in [metric.type for metric in metrics]:
    print("Database state is being monitored.")
else:
    print("Database state is not being monitored.")
```

This script will print "Database state is being monitored." if the database state is being monitored and "Database state is not being monitored." otherwise.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of not monitoring the database state check in GCP using GCP console, follow the steps below:

1. Open the GCP Console and go to the Cloud SQL instances page.

2. Select the instance that you want to monitor and click on it.

3. In the left navigation menu, click on Monitoring.

4. In the Monitoring page, click on the Add Chart button.

5. In the Add Chart page, select the metric that you want to monitor. For database state check, you can select the metric "Cloud SQL Database State Check".

6. Configure the chart settings according to your preferences. You can set the chart title, chart type, chart size, and other options.

7. Click on the Save button to save the chart.

8. Once the chart is saved, it will be displayed in the Monitoring page. You can view the chart and monitor the database state check for the selected instance.

By following these steps, you will be able to remediate the misconfiguration of not monitoring the database state check in GCP using GCP console.

#### Using CLI

To remediate the misconfiguration of not monitoring the database state check in GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in the GCP console.
2. Run the following command to list all the databases in the project:

   ```
   gcloud sql instances list
   ```

3. Note down the name of the database instance for which you want to enable monitoring for database state check.
4. Run the following command to enable monitoring for database state check for the specified database instance:

   ```
   gcloud alpha sql instances patch [INSTANCE_NAME] --database-flags cloudsql.enable_database_state_checks=on
   ```

   Replace `[INSTANCE_NAME]` with the name of the database instance you noted down in step 3.

5. After running the above command, the monitoring for database state check will be enabled for the specified database instance.

Note: The above command will enable monitoring for database state check for all the databases in the specified instance. If you want to enable it for a specific database within the instance, you can use the `--database` flag followed by the name of the database.

#### Using Python

To remediate the misconfiguration of not monitoring the database state check in GCP using Python, follow the steps below:

Step 1: Install the necessary libraries

You will need to install the Google Cloud client library for Python. You can do this by running the following command in your terminal:

```
pip install google-cloud-monitoring
```

Step 2: Authenticate your application

You will need to authenticate your application to access the GCP API. You can do this by creating a service account and downloading the JSON key file. Then, set the environment variable `GOOGLE_APPLICATION_CREDENTIALS` to the path of the key file.

```
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/keyfile.json"
```

Step 3: Create a metric and alert policy

Create a metric to monitor the database state check. You can do this by running the following code:

```
from google.cloud import monitoring_v3

client = monitoring_v3.MetricServiceClient()

project_id = 'your-project-id'
metric_type = 'custom.googleapis.com/database_state_check'

descriptor = monitoring_v3.types.MetricDescriptor()
descriptor.type = metric_type
descriptor.metric_kind = (
    monitoring_v3.enums.MetricDescriptor.MetricKind.GAUGE)
descriptor.value_type = (
    monitoring_v3.enums.MetricDescriptor.ValueType.BOOL)
descriptor.description = 'Database state check'
descriptor = client.create_metric_descriptor(
    project_id, descriptor)
```

Next, create an alert policy to notify you when the metric value is false. You can do this by running the following code:

```
client = monitoring_v3.AlertPolicyServiceClient()

project_name = f'projects/{project_id}'
metric_filter = (
    f'metric.type="{metric_type}" '
    'resource.type="global"')
condition_threshold = (
    monitoring_v3.types.AlertPolicy.Condition.MetricThreshold(
        filter=metric_filter,
        duration={
            'seconds': 300
        },
        comparison=(
            monitoring_v3.enums.ComparisonType.COMPARISON_LT),
        threshold_value=0.5,
        trigger={
            'count': 1
        },
        aggregations=[
            monitoring_v3.types.Aggregation(
                alignment_period={
                    'seconds': 60
                },
                per_series_aligner=(
                    monitoring_v3.enums.Aggregation.Aligner.ALIGN_MEAN),
                cross_series_reducer=(
                    monitoring_v3.enums.Aggregation.Reducer.REDUCE_MEAN),
            )
        ]
    )
)
policy = monitoring_v3.types.AlertPolicy()
policy.display_name = 'Database state check alert'
policy.conditions = [condition_threshold]
policy = client.create_alert_policy(project_name, policy)
```

Step 4: Create a monitoring check

Finally, create a monitoring check to periodically check the database state. You can do this by running the following code:

```
from google.cloud import monitoring_v3

client = monitoring_v3.UptimeCheckServiceClient()

project_name = f'projects/{project_id}'
check_config = monitoring_v3.types.UptimeCheckConfig(
    display_name='Database state check',
    monitored_resource=monitoring_v3.types.MonitoredResource(
        type='uptime_url',
        labels={
            'host': 'your-database-hostname',
            'port': 'your-database-port',
            'path': 'your-database-state-check-path',
            'protocol': 'your-database-protocol'
        }
    ),
    http_check=monitoring_v3.types.UptimeCheckConfig.HttpCheck(
        path='your-database-state-check-path',
        port=your-database-port,
        use_ssl=True,
        auth_info=monitoring_v3.types.UptimeCheckConfig.HttpCheck.
            BasicAuthentication(username='your-database-username',
                                 password='your-database-password')
    ),
    timeout=monitoring_v3.types.Duration(seconds=10),
    period=monitoring_v3.types.Duration(seconds=60),
    content_matchers=[
        monitoring_v3.types.UptimeCheckConfig.ContentMatcher(
            content='your-database-state-check-result',
            matcher=monitoring_v3.enums.
                UptimeCheckConfig.ContentMatcher.Matcher.CONTAINS)
    ]
)
check = client.create_uptime_check_config(project_name, check_config)
```

With these steps, you have successfully remediated the misconfiguration of not monitoring the database state check in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/monitoring/api/metrics_gcp](https://cloud.google.com/monitoring/api/metrics_gcp) 


</Tab>
</Tabs>