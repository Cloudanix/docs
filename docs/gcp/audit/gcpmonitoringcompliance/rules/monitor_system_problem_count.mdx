---
slug: monitor_system_problem_count
title: Cloud Monitoring Should Monitor System Problem Count
sidebar_label: Cloud Monitoring Should Monitor System Problem Count
---

### More Info:

Ensure Cloud Monitoring monitors system problem count.

### Risk Level

Medium

### Address

Performance Efficiency, Reliability

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to the GCP console (console.cloud.google.com) and sign in with your Google account that has the necessary permissions to access the GCP resources.

2. Navigate to Monitoring: From the GCP console dashboard, click on the navigation menu (three horizontal lines on the top left corner), scroll down and click on "Monitoring" under the "Operations" section.

3. Check the Dashboard: Once you are in the Monitoring section, you will see a dashboard with various metrics. Look for the "System Problem Count" metric. This metric should be actively monitored to ensure the health and performance of your system. If it's not being monitored, it's a misconfiguration.

4. Check Alerting Policies: Go to the Alerting section in the Monitoring menu. Here, you can see all the alerting policies that have been set up. Ensure that there is an alerting policy for "System Problem Count". If there is no such policy, it indicates a misconfiguration.

#### Using CLI

1. Install and authenticate Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine and authenticate it. You can download the SDK from the official Google Cloud website and follow the instructions to install it. After installation, authenticate the SDK using the command `gcloud auth login`.

2. List all the monitoring metrics: Use the following command to list all the metrics that are being monitored in your GCP environment. This will help you identify if system problem count is being monitored.

   ```
   gcloud monitoring metrics list
   ```

3. Filter the metrics: The above command will list all the metrics. You need to filter out the system problem count metric. You can do this by using the grep command in Unix systems or findstr command in Windows. The command will look something like this:

   ```
   gcloud monitoring metrics list | grep "system/problem_count"
   ```

4. Check the metric details: If the system problem count metric is being monitored, the above command will return the details of the metric. If it doesn't return anything, that means the metric is not being monitored.

#### Using Python

1. **Install the necessary libraries**: Before you can start monitoring, you need to install the necessary libraries. For AWS, you would use Boto3, for Azure, you would use Azure SDK for Python, and for GCP, you would use Google Cloud Client Library for Python. You can install these libraries using pip.

    ```python
    pip install boto3
    pip install azure
    pip install google-cloud-monitoring
    ```

2. **Set up authentication**: Each cloud provider has a different way of authenticating. For AWS, you would use AWS Access Key ID and Secret Access Key. For Azure, you would use Azure Active Directory (Azure AD) and for GCP, you would use a service account key.

    AWS example:
    ```python
    import boto3
    session = boto3.Session(
        aws_access_key_id='YOUR_ACCESS_KEY',
        aws_secret_access_key='YOUR_SECRET_KEY',
    )
    ```

    Azure example:
    ```python
    from azure.identity import DefaultAzureCredential
    credential = DefaultAzureCredential()
    ```

    GCP example:
    ```python
    from google.oauth2 import service_account
    credentials = service_account.Credentials.from_service_account_file(
        'path/to/keyfile.json')
    ```

3. **Fetch the metrics**: Now that you have authenticated, you can fetch the metrics. Each cloud provider has a different way of fetching metrics.

    AWS example:
    ```python
    cloudwatch = session.client('cloudwatch')
    response = cloudwatch.get_metric_statistics(
        Namespace='AWS/EC2',
        MetricName='CPUUtilization',
        Dimensions=[
            {
                'Name': 'InstanceId',
                'Value': 'i-0c55b159cbfaad512'
            },
        ],
        StartTime=datetime.datetime.utcnow() - datetime.timedelta(seconds=600),
        EndTime=datetime.datetime.utcnow(),
        Period=300,
        Statistics=[
            'SampleCount',
        ],
    )
    ```

    Azure example:
    ```python
    from azure.mgmt.monitor import MonitorManagementClient
    monitor_client = MonitorManagementClient(credential, 'your-subscription-id')
    metrics_data = monitor_client.metrics.list(
        'resource-uri',
        timespan="2018-01-01T00:00:00Z/2018-01-02T00:00:00Z",
        interval='PT1H',
        metricnames='Percentage CPU',
        aggregation='Total'
    )
    ```

    GCP example:
    ```python
    from google.cloud import monitoring_v3
    client = monitoring_v3.MetricServiceClient(credentials=credentials)
    project_name = client.project_path('your-project-id')
    interval = monitoring_v3.types.TimeInterval()
    now = time.time()
    interval.end_time.seconds = int(now)
    interval.end_time.nanos = int(
        (now - interval.end_time.seconds) * 10**9)
    interval.start_time.seconds = int(now - 3600)
    interval.start_time.nanos = interval.end_time.nanos
    results = client.list_time_series(
        project_name,
        'metric.type = "compute.googleapis.com/instance/cpu/utilization"',
        interval,
        monitoring_v3.enums.ListTimeSeriesRequest.TimeSeriesView.FULL)
    ```

4. **Analyze the metrics**: Now that you have the metrics, you can analyze them to detect any misconfigurations. This would involve checking if the metrics are within the expected range. If they are not, then there is a misconfiguration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of not monitoring system problem count in GCP using GCP console, follow these steps:

1. Open the GCP console and navigate to the Monitoring section.

2. In the Monitoring section, select the Metrics Explorer from the left-hand menu.

3. In the Metrics Explorer, select the resource type for which you want to monitor system problem count. For example, if you want to monitor system problem count for a GCE instance, select "GCE VM Instance" as the resource type.

4. In the Metric field, type "system/problem_count" and select it from the dropdown list. This will show the system problem count metric for the selected resource type.

5. Set the time range for which you want to monitor the system problem count. You can select a predefined time range or set a custom time range.

6. Click on the "Create chart" button to create a chart for the system problem count metric.

7. You can set up alerting policies to get notified when the system problem count exceeds a certain threshold. To set up alerting policies, click on the "Create alerting policy" button and follow the prompts.

8. Once the alerting policy is set up, you will receive notifications when the system problem count exceeds the threshold.

By following these steps, you can remediate the misconfiguration of not monitoring system problem count in GCP using GCP console.

#### Using CLI

The "Cloud Monitoring Should Monitor System Problem Count" misconfiguration in GCP means that the system problem count metric is not being monitored in Cloud Monitoring. To remediate this issue, you can follow these steps:

1. Open the Google Cloud Console and navigate to the Cloud Monitoring page.

2. In the left-hand menu, select "Metrics Explorer".

3. In the "Find resource type and metric" search bar, type "system problem count".

4. Select the "System problem count" metric from the dropdown list.

5. In the "Find resource" search bar, select the resource you want to monitor (for example, a Compute Engine instance).

6. Under the "Chart Options" section, select the time range and chart type you want to use.

7. Click the "Add to Dashboard" button to add the chart to a dashboard.

8. If you want to receive alerts when the system problem count metric exceeds a certain threshold, you can create an alert policy by following these steps:

   a. In the left-hand menu, select "Alerting".

   b. Click the "Create Policy" button.

   c. In the "Add Condition" section, select "Metric Threshold" as the condition type.

   d. Select the "System problem count" metric and the resource you want to monitor.

   e. Set the threshold value and duration for the condition.

   f. In the "Notification Channels" section, select the channels you want to receive alerts on (for example, email or SMS).

   g. Click the "Save" button to create the alert policy.

By following these steps, you can remediate the "Cloud Monitoring Should Monitor System Problem Count" misconfiguration in GCP using the GCP CLI.

#### Using Python

To remediate the issue of not monitoring system problem count in GCP using Python, follow these steps:

1. First, you need to set up a monitoring workspace in GCP. To do this, go to the GCP console and navigate to "Monitoring" under "Operations". Click on "Create Workspace" and follow the prompts to set up your workspace.

2. Once your workspace is set up, you need to create a new monitoring policy that will monitor the system problem count. To do this, navigate to "Alerting" under "Monitoring" and click on "Create Policy". 

3. Give your policy a name and description, and then click on "Add Condition". 

4. In the "Target" section, select the GCP resource that you want to monitor. 

5. In the "Configuration" section, select "Metric Threshold" as the condition type. 

6. In the "Metric" section, select "System Problem Count" as the metric, and set the threshold value to the desired number of problems. 

7. In the "Notification" section, select the notification channels that you want to receive alerts on. 

8. Click on "Save" to create your monitoring policy. 

9. Finally, you need to set up a Python script to periodically check the system problem count and send alerts if the count exceeds the threshold. You can use the GCP Monitoring API to retrieve the system problem count and the Google Cloud Pub/Sub API to send alerts to the selected notification channels. 

10. You can use the following code as a starting point for your Python script:

```python
from google.cloud import monitoring_v3
from google.cloud import pubsub_v1

project_id = "YOUR_PROJECT_ID"
topic_name = "YOUR_TOPIC_NAME"
subscription_name = "YOUR_SUBSCRIPTION_NAME"
threshold_value = 10

client = monitoring_v3.MetricServiceClient()
project_name = client.project_path(project_id)

query = f'resource.type="gce_instance" AND metric.type="agent.googleapis.com/system/problem_count"'

response = client.list_time_series(
    request={
        "name": project_name,
        "filter": query,
        "interval": {
            "start_time": {"seconds": int(time.time() - 3600)},
            "end_time": {"seconds": int(time.time())},
        },
        "view": monitoring_v3.ListTimeSeriesRequest.TimeSeriesView.FULL,
    }
)

count = response[0].points[-1].value.double_value

if count > threshold_value:
    publisher = pubsub_v1.PublisherClient()
    topic_path = publisher.topic_path(project_id, topic_name)
    message = f"System problem count is {count}, which exceeds the threshold of {threshold_value}."
    data = message.encode("utf-8")
    publisher.publish(topic_path, data=data)
```

This code retrieves the system problem count for all GCE instances in the specified project and sends an alert message to the specified Pub/Sub topic if the count exceeds the threshold value. You can run this script periodically using a cron job or a similar scheduling mechanism.


### Additional Reading:

- [https://cloud.google.com/monitoring/api/metrics_gcp](https://cloud.google.com/monitoring/api/metrics_gcp) 


</Tab>
</Tabs>