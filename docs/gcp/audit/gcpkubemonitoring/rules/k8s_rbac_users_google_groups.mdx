---
slug: k8s_rbac_users_google_groups
title: Manage Kubernetes RBAC Users With Google Groups
sidebar_label: Manage Kubernetes RBAC Users With Google Groups
---

### More Info:

Cluster Administrators should leverage G Suite Groups and Cloud IAM to assign Kubernetes user roles to a collection of users, instead of to individual emails using only Cloud IAM.

### Risk Level

Low

### Address

Security, Reliability, Operational Excellence, Performance Efficiency

### Compliance Standards

SOC2, CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to your Google Cloud Platform (GCP) console: Open your browser and navigate to the GCP console. Enter your login credentials to access your GCP account.

2. Navigate to Kubernetes Engine: Once you are logged in, go to the navigation menu (hamburger icon on the top left corner), scroll down and click on "Kubernetes Engine". This will take you to the Kubernetes dashboard.

3. Check the Kubernetes clusters: In the Kubernetes dashboard, you will see a list of all your Kubernetes clusters. Click on the specific cluster you want to check for the misconfiguration.

4. Verify RBAC settings: Once you are in the specific cluster, navigate to the "Security" tab. Here, you can check the RBAC (Role-Based Access Control) settings. If Google Groups are being used to manage Kubernetes RBAC users, you should see the Google Group names listed under the "Identity and API access" section. If not, then it's a misconfiguration.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, authenticate your Google Cloud account by running the following command in your terminal:

   ```
   gcloud auth login
   ```

2. After you have authenticated, you can list all the clusters in your GCP project by running the following command:

   ```
   gcloud container clusters list
   ```

   This command will return a list of all the Kubernetes clusters in your project.

3. To check the RBAC configuration of a specific cluster, you need to get the cluster's credentials first. You can do this by running the following command:

   ```
   gcloud container clusters get-credentials [CLUSTER_NAME] --zone [ZONE_NAME] --project [PROJECT_ID]
   ```

   Replace `[CLUSTER_NAME]`, `[ZONE_NAME]`, and `[PROJECT_ID]` with your actual cluster name, zone, and project ID.

4. Now, you can check the RBAC configuration by describing the cluster's role bindings. Run the following command:

   ```
   kubectl describe rolebindings,clusterrolebindings
   ```

   This command will return a list of all role bindings and cluster role bindings in the cluster. Look for any bindings that are associated with Google Groups. If there are none, then Kubernetes RBAC users are not being managed with Google Groups.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries in your Python script. You will need the `googleapiclient` library to interact with the Google Cloud Platform (GCP) and the `kubernetes` library to interact with the Kubernetes API.

    ```python
    import googleapiclient.discovery
    from kubernetes import client, config
    ```

2. **Initialize GCP and Kubernetes Clients**: The next step is to initialize the GCP and Kubernetes clients. You will need to authenticate with GCP and Kubernetes using your credentials.

    ```python
    # Initialize the GCP client
    service = googleapiclient.discovery.build('cloudresourcemanager', 'v1')
    request = service.projects().getIamPolicy(resource='your-project-id')

    # Initialize the Kubernetes client
    config.load_kube_config()
    v1 = client.CoreV1Api()
    ```

3. **Fetch and Analyze IAM Policies**: Now, fetch the IAM policies for your GCP project and analyze them to check if Kubernetes RBAC users are managed with Google Groups. You can do this by checking if the `gke-security-groups` attribute is set in the IAM policy.

    ```python
    # Fetch the IAM policy
    response = request.execute()

    # Check if Kubernetes RBAC users are managed with Google Groups
    for binding in response['bindings']:
        if 'gke-security-groups' in binding['role']:
            print(f"Kubernetes RBAC users are managed with Google Groups in role {binding['role']}")
    ```

4. **Fetch and Analyze Kubernetes RBAC Policies**: Similarly, fetch the Kubernetes RBAC policies and analyze them to check if users are managed with Google Groups. You can do this by checking if the `user` field in the RBAC policy is a Google Group.

    ```python
    # Fetch the Kubernetes RBAC policies
    rbac_policies = v1.list_cluster_role_binding()

    # Check if users are managed with Google Groups
    for item in rbac_policies.items:
        if 'user' in item.metadata.annotations:
            user = item.metadata.annotations['user']
            if user.startswith('group:'):
                print(f"User {user} is managed with Google Groups")
    ```

This script will print out the roles in which Kubernetes RBAC users are managed with Google Groups and the users that are managed with Google Groups.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Manage Kubernetes RBAC Users With Google Groups" in GCP using GCP console, follow the below steps:

1. Go to the GCP console and navigate to the Kubernetes Engine section.
2. Select the cluster for which you want to manage RBAC users.
3. Click on the "Security" tab and then select "Identity and Access Management".
4. In the "Identity and Access Management" section, click on the "Add" button.
5. Add the Google group that you want to use for managing RBAC users.
6. Click on the "Role" drop-down and select the appropriate role that you want to assign to the group.
7. Click on the "Save" button to save the changes.

By following these steps, you have remediated the "Manage Kubernetes RBAC Users With Google Groups" misconfiguration in GCP using GCP console. Now, the RBAC users will be managed through the Google group that you have added and assigned the appropriate role.

#### Using CLI

The misconfiguration is related to managing Kubernetes RBAC Users with Google Groups. To remediate this issue, follow the below steps:

1. Open the Google Cloud Console and navigate to the Kubernetes Engine.

2. Select the cluster for which you want to manage the Kubernetes RBAC users.

3. Click on the "Edit" button to edit the cluster.

4. In the "Security" tab, select the "Security" option.

5. In the "Security" section, click on the "Edit" button to edit the security settings.

6. In the "Edit Security" section, scroll down to the "Kubernetes RBAC" section.

7. Under the "Kubernetes RBAC" section, select the "Google Groups" option.

8. Enter the name of the Google Group you want to use to manage the Kubernetes RBAC users.

9. Click on the "Save" button to save the changes.

10. Now, all the users in the Google Group will have the same access as the Kubernetes RBAC users.

To remediate this issue using the GCP CLI, follow the below steps:

1. Open the GCP CLI and navigate to the Kubernetes Engine.

2. Run the following command to set the Kubernetes RBAC users with Google Groups:

```
$ gcloud container clusters update [CLUSTER_NAME] --zone=[ZONE] --update-addons=HorizontalPodAutoscaling,HttpLoadBalancing --enable-rbac --no-enable-basic-auth --google-groups=[GOOGLE_GROUP_NAME]
```

3. Replace [CLUSTER_NAME] with the name of your cluster, [ZONE] with the zone where your cluster is located, and [GOOGLE_GROUP_NAME] with the name of the Google Group you want to use to manage the Kubernetes RBAC users.

4. Once the command is executed successfully, all the users in the Google Group will have the same access as the Kubernetes RBAC users.

#### Using Python

To remediate the misconfiguration "Manage Kubernetes RBAC Users With Google Groups" for GCP using Python, you can follow the below steps:

1. Install the required libraries:

```
pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
```

2. Set up authentication by creating a service account and downloading the JSON key file.

3. Create a Python script with the following code:

```python
from google.oauth2 import service_account
from googleapiclient.discovery import build

# Set the required variables
project_id = '<PROJECT_ID>'
zone = '<ZONE>'
cluster_name = '<CLUSTER_NAME>'
group_email = '<GROUP_EMAIL>'

# Set up credentials
credentials = service_account.Credentials.from_service_account_file('<PATH_TO_JSON_KEY_FILE>')

# Create the Kubernetes API client
container_service = build('container', 'v1', credentials=credentials)

# Get the cluster's endpoint
response = container_service.projects().zones().clusters().get(projectId=project_id, zone=zone, clusterId=cluster_name).execute()
cluster_endpoint = response['endpoint']

# Create the Kubernetes API client with the endpoint
kube_service = build('container', 'v1', credentials=credentials, endpoint=cluster_endpoint)

# Get the cluster's current RBAC configuration
rbac = kube_service.projects().zones().clusters().get(projectId=project_id, zone=zone, clusterId=cluster_name).execute()['masterAuth']['rbacConfig']

# Add the group to the RBAC configuration
rbac['groups'].append(group_email)

# Update the cluster's RBAC configuration
kube_service.projects().zones().clusters().update(projectId=project_id, zone=zone, clusterId=cluster_name, updateMask='masterAuth.rbacConfig', body={'masterAuth': {'rbacConfig': rbac}}).execute()
```

4. Replace the placeholders `<PROJECT_ID>`, `<ZONE>`, `<CLUSTER_NAME>`, `<GROUP_EMAIL>`, and `<PATH_TO_JSON_KEY_FILE>` with the appropriate values.

5. Run the Python script to add the Google group to the Kubernetes RBAC configuration.

This will remediate the misconfiguration "Manage Kubernetes RBAC Users With Google Groups" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#google-groups-for-gke](https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control#google-groups-for-gke) 


</Tab>
</Tabs>