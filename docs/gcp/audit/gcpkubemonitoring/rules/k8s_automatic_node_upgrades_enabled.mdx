---
slug: k8s_automatic_node_upgrades_enabled
title: Automatic Node Upgrades Should Be Enabled
sidebar_label: Automatic Node Upgrades Should Be Enabled
---

### More Info:

Ensures all Kubernetes cluster nodes have automatic upgrades enabled. Enabling automatic upgrades on nodes ensures that each node stays current with the latest version of the master branch, also ensuring that the latest security patches are installed to provide the most secure environment.

### Risk Level

Low

### Address

Security, Reliability

### Compliance Standards

HITRUST, SOC2, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Kubernetes Engine: From the left-hand side menu, select "Kubernetes Engine". This will take you to the Kubernetes clusters dashboard where you can see all your existing Kubernetes clusters.

3. Select the Kubernetes Cluster: Click on the name of the Kubernetes cluster you want to inspect. This will open the cluster's details page.

4. Check Node Auto-upgrade Status: In the cluster's details page, look for the "Node Pools" section. Under each node pool, there should be an "Auto-upgrade" field. If the status of this field is "Enabled", then automatic node upgrades are enabled for that node pool. If it's "Disabled", then automatic node upgrades are not enabled.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After installation, authenticate your account using the command `gcloud auth login`.

2. Get the list of clusters: Use the following command to get the list of all the Kubernetes clusters in your project:

   ```
   gcloud container clusters list
   ```

3. Check the status of Automatic Node Upgrades: For each cluster, check the status of Automatic Node Upgrades using the following command:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone [ZONE_NAME] --format='value(currentNodeVersion)'
   ```

   Replace `[CLUSTER_NAME]` with the name of your cluster and `[ZONE_NAME]` with the zone of your cluster. This command will return the current node version of the cluster.

4. Compare the current node version with the latest available version: If the current node version is not the latest available version, it means that Automatic Node Upgrades is not enabled. You can check the latest available version using the following command:

   ```
   gcloud container get-server-config --zone [ZONE_NAME] --format='value(validMasterVersions)'
   ```

   Replace `[ZONE_NAME]` with the zone of your cluster. This command will return a list of valid master versions. The first version in the list is the latest available version.

#### Using Python

To check if Automatic Node Upgrades are enabled in Kubernetes, you can use the Kubernetes Python client. Here are the steps:

1. **Install the Kubernetes Python client:**

   You can install the Kubernetes Python client using pip:
   ```
   pip install kubernetes
   ```

2. **Configure access to your Kubernetes cluster:**

   You need to configure your access to the Kubernetes cluster. This can be done by setting up the kubeconfig file which contains the necessary details like the cluster API server and the authentication details. The default location of the kubeconfig file is `~/.kube/config`.

3. **Create a Python script to check the node upgrade settings:**

   Here is a sample Python script that uses the Kubernetes Python client to check if Automatic Node Upgrades are enabled:

   ```python
   from kubernetes import client, config

   # Load the kubeconfig file
   config.load_kube_config()

   # Create an API client for the Kubernetes API
   api = client.CoreV1Api()

   # Get the list of all nodes
   nodes = api.list_node().items

   # Check the upgrade settings for each node
   for node in nodes:
       metadata = node.metadata
       annotations = metadata.annotations
       if 'cluster-autoscaler.kubernetes.io/scale-down-disabled' in annotations:
           print(f"Node {metadata.name} has automatic upgrades disabled")
       else:
           print(f"Node {metadata.name} has automatic upgrades enabled")
   ```

4. **Run the Python script:**

   You can run the Python script using the Python interpreter:
   ```
   python check_node_upgrades.py
   ```
   
   This script will print out the names of all nodes and whether they have automatic upgrades enabled or disabled. If a node has automatic upgrades disabled, it might be a misconfiguration that needs to be fixed.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Automatic Node Upgrades Should Be Enabled" for GCP using GCP console, you can follow the below steps:

1. Open the Google Kubernetes Engine (GKE) console.
2. Select the cluster for which you want to enable automatic node upgrades.
3. Click on the "Edit" button at the top of the page.
4. Scroll down to the "Node Pools" section and click on the "Default pool" or the pool for which you want to enable automatic node upgrades.
5. Under the "Auto-upgrade" section, select the checkbox next to "Enable auto-upgrade".
6. Choose the desired maintenance window during which automatic node upgrades should be performed.
7. Click on the "Save" button at the bottom of the page to save the changes.

Once you have followed these steps, automatic node upgrades will be enabled for the selected node pool. This will ensure that your nodes are always up-to-date with the latest security patches and bug fixes.

#### Using CLI

To remediate the misconfiguration "Automatic Node Upgrades Should Be Enabled" in GCP using GCP CLI, follow the below steps:

1. Open the terminal and login to your GCP account using the command:
   ```
   gcloud auth login
   ```
2. Set the project in which you want to enable automatic node upgrades using the command:
   ```
   gcloud config set project PROJECT_ID
   ```
   Replace PROJECT_ID with your GCP project ID.

3. Enable automatic node upgrades for the node pool using the command:
   ```
   gcloud container node-pools update NODE_POOL_NAME --cluster=CLUSTER_NAME --enable-autoupgrade
   ```
   Replace NODE_POOL_NAME with the name of the node pool for which you want to enable automatic node upgrades, and replace CLUSTER_NAME with the name of the cluster in which the node pool is present.

4. Verify that automatic node upgrades are enabled for the node pool using the command:
   ```
   gcloud container node-pools describe NODE_POOL_NAME --cluster=CLUSTER_NAME | grep autoupgrade
   ```
   This command will return the status of automatic node upgrades for the specified node pool.

By following the above steps, you can remediate the misconfiguration "Automatic Node Upgrades Should Be Enabled" in GCP using GCP CLI.

#### Using Python

To remediate the automatic node upgrades misconfiguration on GCP using Python, you can follow the below steps:

1. Import the necessary libraries:

```
from googleapiclient import discovery
from google.oauth2 import service_account
```

2. Set up the credentials:

```
credentials = service_account.Credentials.from_service_account_file(
    'path/to/your/credentials.json')
```

3. Create a `container` client:

```
container_client = discovery.build('container', 'v1', credentials=credentials)
```

4. Get the current cluster configuration:

```
project_id = 'your-project-id'
zone = 'your-zone'
cluster_id = 'your-cluster-id'

cluster = container_client.projects().zones().clusters().get(
    projectId=project_id,
    zone=zone,
    clusterId=cluster_id
).execute()
```

5. Check if automatic node upgrades are enabled:

```
if cluster['autoUpgradeEnabled']:
    print('Automatic node upgrades are already enabled.')
else:
    # Enable automatic node upgrades
    cluster['autoUpgradeEnabled'] = True

    # Update the cluster configuration
    operation = container_client.projects().zones().clusters().update(
        projectId=project_id,
        zone=zone,
        clusterId=cluster_id,
        body=cluster
    ).execute()

    print('Automatic node upgrades have been enabled.')
```

6. Run the Python script to enable automatic node upgrades.

Note: Make sure to replace the `path/to/your/credentials.json`, `your-project-id`, `your-zone`, and `your-cluster-id` with the appropriate values for your GCP environment.


### Additional Reading:

- [https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades](https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades) 


</Tab>
</Tabs>