---
slug: k8s_stackdriver_logging_monitoring_enabled
title: Ensure Stackdriver Kubernetes Logging And Monitoring Is Enabled
sidebar_label: Ensure Stackdriver Kubernetes Logging And Monitoring Is Enabled
---

### More Info:

Send logs and metrics to a remote aggregator to mitigate the risk of local tampering in the event of a breach.

### Risk Level

Low

### Address

Security, Reliability, Operational Excellence, Performance Efficiency

### Compliance Standards

CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Kubernetes Engine: From the left-hand side menu, select "Kubernetes Engine". This will display a list of all the Kubernetes clusters that are currently running in your GCP environment.

3. Select the Kubernetes Cluster: Click on the name of the Kubernetes cluster for which you want to check the Stackdriver Kubernetes Logging and Monitoring status.

4. Check Stackdriver Kubernetes Logging and Monitoring Status: In the cluster details page, scroll down to the "Stackdriver Logging" and "Stackdriver Monitoring" sections. If these are enabled, you will see a status of "Enabled". If not, the status will be "Disabled".

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Once the SDK is installed, authenticate your account by running the following command in your terminal:
   ```
   gcloud auth login
   ```
   Follow the prompts to log in with your Google Cloud account.

3. Set your project ID to the project you want to check. Replace `[PROJECT_ID]` with your actual project ID.
   ```
   gcloud config set project [PROJECT_ID]
   ```

4. Now, you can check if Stackdriver Kubernetes Logging and Monitoring is enabled by running the following command:
   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone [ZONE_NAME] --format='value(loggingService,monitoringService)'
   ```
   Replace `[CLUSTER_NAME]` with the name of your Kubernetes cluster and `[ZONE_NAME]` with the zone your cluster is located in. If Stackdriver Kubernetes Logging and Monitoring is enabled, the output should be `logging.googleapis.com/kubernetes` and `monitoring.googleapis.com/kubernetes` respectively. If not, it means that Stackdriver Kubernetes Logging and Monitoring is not enabled.

#### Using Python

To check if Stackdriver Kubernetes Logging and Monitoring is enabled in Kubernetes using Python scripts, you can follow these steps:

1. **Install Google Cloud SDK and Python Client for Google Cloud**:
   Before you start, make sure you have Google Cloud SDK and Python Client for Google Cloud installed on your system. You can install them using pip (Python package installer).

   ```bash
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-cloud
   ```

2. **Authenticate your SDK**:
   Use the `gcloud auth login` command to authenticate your Google Cloud SDK. This will open a new browser window for you to log in to your Google Cloud account.

3. **List all the clusters**:
   Use the `container_v1` module from the `google.cloud` package to list all the Kubernetes clusters in your project. Here is a sample Python script:

   ```python
   from google.cloud import container_v1

   def list_clusters(project_id, zone):
       client = container_v1.ClusterManagerClient()
       response = client.list_clusters(project_id, zone)
       for cluster in response.clusters:
           print(cluster.name)

   list_clusters('your-project-id', 'your-zone')
   ```

4. **Check if Stackdriver Kubernetes Logging and Monitoring is enabled**:
   For each cluster, check the `logging_service` and `monitoring_service` fields. If Stackdriver Kubernetes Logging and Monitoring is enabled, these fields should be set to `logging.googleapis.com/kubernetes` and `monitoring.googleapis.com/kubernetes` respectively. Here is a sample Python script:

   ```python
   from google.cloud import container_v1

   def check_stackdriver_enabled(project_id, zone):
       client = container_v1.ClusterManagerClient()
       response = client.list_clusters(project_id, zone)
       for cluster in response.clusters:
           if (cluster.logging_service == 'logging.googleapis.com/kubernetes' and
               cluster.monitoring_service == 'monitoring.googleapis.com/kubernetes'):
               print(f'Stackdriver Kubernetes Logging and Monitoring is enabled for cluster {cluster.name}')
           else:
               print(f'Stackdriver Kubernetes Logging and Monitoring is NOT enabled for cluster {cluster.name}')

   check_stackdriver_enabled('your-project-id', 'your-zone')
   ```

Remember to replace `'your-project-id'` and `'your-zone'` with your actual project ID and zone.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure Stackdriver Kubernetes Logging And Monitoring Is Enabled" for GCP using GCP console, follow the below steps:

1. Login to the GCP console with valid credentials.
2. Navigate to the Google Kubernetes Engine (GKE) cluster for which you want to enable Stackdriver Kubernetes Logging and Monitoring.
3. Click on the "Edit" button at the top of the page.
4. Scroll down to the "Stackdriver" section and click on it.
5. Under the "Stackdriver Logging" section, toggle the switch to "Enabled".
6. Under the "Stackdriver Monitoring" section, toggle the switch to "Enabled".
7. Click on the "Save" button at the bottom of the page.

Once the above steps are completed, Stackdriver Kubernetes Logging and Monitoring will be enabled for the GKE cluster. You can then view logs and metrics for your Kubernetes cluster in the Stackdriver Logging and Monitoring UI.

#### Using CLI

To remediate the misconfiguration of Stackdriver Kubernetes Logging and Monitoring not being enabled on GCP using GCP CLI, follow the below steps:

1. Install and configure the Google Cloud SDK (CLI) on your local machine.

2. Open the terminal or command prompt and authenticate to your GCP account using the following command:

```
gcloud auth login
```

3. Set the default project for the CLI to the project where the Kubernetes cluster is deployed using the following command:

```
gcloud config set project [PROJECT_ID]
```

4. Enable the Stackdriver Kubernetes Logging and Monitoring API for the project using the following command:

```
gcloud services enable container.googleapis.com stackdriver.googleapis.com
```

5. Verify that the Stackdriver Kubernetes Logging and Monitoring API is enabled by running the following command:

```
gcloud services list --enabled
```

6. If the API is enabled, you should see the following services listed:

```
NAME                                TITLE
container.googleapis.com            Kubernetes Engine API
logging.googleapis.com              Stackdriver Logging API
monitoring.googleapis.com           Stackdriver Monitoring API
stackdriver.googleapis.com          Stackdriver API
```

7. Once the API is enabled, you can configure the Kubernetes cluster to send logs and metrics to Stackdriver by following the official GCP documentation:

https://cloud.google.com/kubernetes-engine/docs/how-to/logging

https://cloud.google.com/monitoring/kubernetes-engine/

#### Using Python

To remediate the misconfiguration "Ensure Stackdriver Kubernetes Logging And Monitoring Is Enabled" for GCP using Python, you can follow these steps:

1. Install the `google-cloud-monitoring` and `google-cloud-logging` Python libraries using `pip`.

```
pip install google-cloud-monitoring google-cloud-logging
```

2. Create a service account with the necessary permissions to enable Stackdriver Kubernetes logging and monitoring.

3. Set the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of the service account key file.

```
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service_account_key.json
```

4. Use the `google-cloud-monitoring` and `google-cloud-logging` libraries to enable Stackdriver Kubernetes logging and monitoring.

```
from google.cloud.monitoring_v3 import MetricServiceClient
from google.cloud.logging_v2 import LoggingServiceV2Client
from google.cloud.logging_v2.types import LogMetric

# Enable Kubernetes API metrics
metric_client = MetricServiceClient()
project_name = f"projects/{project_id}"
metric_descriptor = metric_client.get_metric_descriptor(
    name=f"{project_name}/metricDescriptors/kubernetes.io/container/cpu/usage_time"
)
metric_descriptor.enabled = True
metric_client.update_metric_descriptor(metric_descriptor)

# Create a Stackdriver Logging metric for Kubernetes logs
logging_client = LoggingServiceV2Client()
parent = logging_client.project_path(project_id)
log_metric = LogMetric(
    name="kubernetes_log",
    description="Kubernetes logs",
    filter='resource.type="k8s_container"',
    metric_descriptor_name=f"{project_name}/metricDescriptors/logging.googleapis.com/container/log_bytes",
    value_extractor="SUM(jsonPayload.message_size)",
)
logging_client.create_log_metric(parent=parent, metric=log_metric)
```

Note: Replace `project_id` with your GCP project ID.

5. Verify that Stackdriver Kubernetes logging and monitoring is enabled by checking the Stackdriver Metrics Explorer and Logs Viewer in the GCP Console.

That's it! You have now remediated the misconfiguration "Ensure Stackdriver Kubernetes Logging And Monitoring Is Enabled" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/monitoring/kubernetes-engine/](https://cloud.google.com/monitoring/kubernetes-engine/) 


</Tab>
</Tabs>