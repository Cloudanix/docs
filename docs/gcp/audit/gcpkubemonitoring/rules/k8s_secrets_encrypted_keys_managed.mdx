---
slug: k8s_secrets_encrypted_keys_managed
title: Ensure Kubernetes Secrets Are Encrypted Using KMS Keys
sidebar_label: Ensure Kubernetes Secrets Are Encrypted Using KMS Keys
---

### More Info:

Encrypt Kubernetes secrets, stored in etcd, at the application-layer using a customermanaged key in Cloud KMS.

### Risk Level

Medium

### Address

Security, Reliability, Operational Excellence, Performance Efficiency

### Compliance Standards

CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Kubernetes Engine: From the left-hand side menu, select "Kubernetes Engine" to view the list of your Kubernetes clusters.

3. Check the Cluster Details: Click on the name of the Kubernetes cluster you want to inspect. This will open the cluster's details page. 

4. Verify the Application-layer Secrets Encryption: Look for the "Application-layer Secrets Encryption" section. If it's set to "Google-managed key", it means the Kubernetes Secrets are not encrypted using a Customer-managed key (KMS Key), indicating a misconfiguration. If it's set to a specific key, it means the Kubernetes Secrets are encrypted using a Customer-managed key (KMS Key).

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install and authenticate it.

2. Once the SDK is installed and configured, you can use the following command to list all the clusters in your project:

   ```
   gcloud container clusters list --project=[PROJECT_ID]
   ```

   Replace `[PROJECT_ID]` with your actual project ID.

3. After you have the list of clusters, you can check the configuration of each cluster to see if Kubernetes Secrets are encrypted using KMS keys. Use the following command:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone=[CLUSTER_ZONE] --format=json
   ```

   Replace `[CLUSTER_NAME]` with the name of your cluster and `[CLUSTER_ZONE]` with the zone of your cluster. This command will output the configuration of the cluster in JSON format.

4. In the output, look for the "databaseEncryption" field. If the "state" field under "databaseEncryption" is set to "ENCRYPTED" and the "keyName" field is set to the name of a KMS key, then Kubernetes Secrets are encrypted using KMS keys. If not, then they are not encrypted using KMS keys.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries in your Python script. You will need the Kubernetes client library to interact with the Kubernetes API.

```python
from kubernetes import client, config
```

2. **Configure Kubernetes Client**: The next step is to configure the Kubernetes client to connect to your Kubernetes cluster. You can do this by loading the kubeconfig file which contains the information about your cluster.

```python
config.load_kube_config()
v1 = client.CoreV1Api()
```

3. **Fetch Secrets**: Now, you can fetch all the secrets in your Kubernetes cluster. You can do this by calling the `list_secret_for_all_namespaces` method of the `CoreV1Api` class.

```python
secrets = v1.list_secret_for_all_namespaces().items
```

4. **Check Encryption**: Finally, you can check if the secrets are encrypted using KMS keys. You can do this by checking the `type` attribute of each secret. If the `type` is not `kubernetes.io/service-account-token`, then the secret is not encrypted using KMS keys.

```python
for secret in secrets:
    if secret.type != 'kubernetes.io/service-account-token':
        print(f"Secret {secret.metadata.name} in namespace {secret.metadata.namespace} is not encrypted using KMS keys.")
```

This script will print the names of all the secrets that are not encrypted using KMS keys. If no such secrets are found, it means all the secrets in your Kubernetes cluster are encrypted using KMS keys.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure Kubernetes Secrets Are Encrypted Using KMS Keys" in GCP using the GCP console, follow the below steps:

1. Open the Google Kubernetes Engine (GKE) cluster in the GCP console.

2. Navigate to the "Workloads" tab on the left-hand side menu and select the deployment that you want to remediate.

3. Click on the "Edit" button at the top of the screen.

4. Scroll down to the "Environment Variables" section and click on "Add Environment Variable".

5. Add the following environment variable:

   Name: GOOGLE_ENCRYPTION_KEY

   Value: [the name of the KMS key you want to use to encrypt the secrets]

6. Click on the "Save" button at the bottom of the screen to save the changes.

7. Repeat steps 4-6 for each deployment that needs to be remediated.

By following these steps, you have ensured that Kubernetes secrets are encrypted using KMS keys in GCP.

#### Using CLI

To remediate the misconfiguration of Kubernetes Secrets not being encrypted using KMS Keys on GCP, you can follow the below steps:

1. Open the Cloud Shell in the GCP Console.

2. Run the following command to get the list of Kubernetes secrets in the cluster:

   ```
   kubectl get secrets
   ```

3. Identify the secrets that are not encrypted using KMS keys.

4. Create a KMS keyring and key:

   ```
   gcloud kms keyrings create [KEYRING-NAME] --location [LOCATION]
   
   gcloud kms keys create [KEY-NAME] --location [LOCATION] --keyring [KEYRING-NAME] --purpose encryption
   ```

   Replace [KEYRING-NAME], [LOCATION] and [KEY-NAME] with the appropriate values.

5. Encrypt the Kubernetes secrets using the KMS key:

   ```
   gcloud kms encrypt --key [KEY-NAME] --keyring [KEYRING-NAME] --location [LOCATION] --plaintext-file [SECRET-FILE-PATH] --ciphertext-file [ENCRYPTED-FILE-PATH]
   ```

   Replace [KEYRING-NAME], [LOCATION], [KEY-NAME], [SECRET-FILE-PATH] and [ENCRYPTED-FILE-PATH] with the appropriate values.

6. Update the Kubernetes secrets with the encrypted data:

   ```
   kubectl create secret generic [SECRET-NAME] --from-file=[SECRET-FILE-PATH]=[ENCRYPTED-FILE-PATH]
   ```

   Replace [SECRET-NAME], [SECRET-FILE-PATH] and [ENCRYPTED-FILE-PATH] with the appropriate values.

7. Verify that the secrets have been encrypted using KMS keys:

   ```
   kubectl get secrets
   kubectl describe secret [SECRET-NAME]
   ```

   Replace [SECRET-NAME] with the name of the secret.

8. Delete the unencrypted Kubernetes secrets:

   ```
   kubectl delete secret [SECRET-NAME]
   ```

   Replace [SECRET-NAME] with the name of the secret.

By following these steps, you can ensure that the Kubernetes secrets are encrypted using KMS keys on GCP.

#### Using Python

To remediate the misconfiguration of ensuring Kubernetes secrets are encrypted using KMS keys in GCP using Python, you can follow the below steps:

1. Install the necessary Python libraries: 
   - google-auth
   - google-auth-oauthlib
   - google-auth-httplib2
   - google-cloud-kms
   - kubernetes

2. Authenticate with GCP using a service account key file:
   ```
   from google.oauth2 import service_account
   credentials = service_account.Credentials.from_service_account_file('key.json')
   ```

3. Connect to the KMS service:
   ```
   from google.cloud import kms_v1
   kms_client = kms_v1.KeyManagementServiceClient(credentials=credentials)
   ```

4. Get the KMS key resource name:
   ```
   key_name = kms_client.crypto_key_path_path('project-id', 'location', 'key-ring', 'key')
   ```

5. Retrieve the Kubernetes secret:
   ```
   from kubernetes import client, config
   config.load_kube_config()
   v1 = client.CoreV1Api()
   secret = v1.read_namespaced_secret('secret-name', 'namespace')
   ```

6. Encrypt the secret data using the KMS key:
   ```
   from google.cloud import kms_v1
   plaintext = secret.data['key']
   response = kms_client.encrypt(key_name, plaintext.encode('utf-8'))
   ```

7. Update the Kubernetes secret with the encrypted data:
   ```
   secret.data['key'] = response.ciphertext
   v1.replace_namespaced_secret('secret-name', 'namespace', secret)
   ```

By following these steps, you can ensure that Kubernetes secrets are encrypted using KMS keys in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/kubernetes-engine/docs/how-to/encrypting-secrets](https://cloud.google.com/kubernetes-engine/docs/how-to/encrypting-secrets) 


</Tab>
</Tabs>