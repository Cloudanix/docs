---
slug: k8s_cluster_least_privilege
title: Cluster Should Have Limited Service Account Access
sidebar_label: Cluster Should Have Limited Service Account Access
---

### More Info:

Ensures Kubernetes clusters are created with limited service account access scopes. Kubernetes service accounts should be limited in scope to the services necessary to operate the clusters.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISGCP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. Here, you will find a list of all your Kubernetes clusters.

3. Click on the specific cluster you want to inspect. This will open the cluster details page.

4. In the cluster details page, navigate to the "Workloads" tab. Here, you can see all the service accounts associated with the cluster. Check if any service account has more permissions than necessary. This can be done by clicking on the service account and viewing its roles. If a service account has roles that are not required for its function, it indicates a misconfiguration.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Once the SDK is installed, authenticate your account using the following command:
   ```
   gcloud auth login
   ```
   This will open a new browser window where you can log in with your Google account. After successful login, your credentials will be stored on your local machine.

3. Set your project ID to the project you want to check. Replace `YOUR_PROJECT_ID` with your actual project ID.
   ```
   gcloud config set project YOUR_PROJECT_ID
   ```

4. Now, you can list all the service accounts in your project using the following command:
   ```
   gcloud iam service-accounts list
   ```
   This will display a list of all service accounts, including their email addresses and descriptions.

5. To check the roles assigned to a specific service account, use the following command. Replace `SERVICE_ACCOUNT_EMAIL` with the email of the service account you want to check.
   ```
   gcloud iam service-accounts get-iam-policy SERVICE_ACCOUNT_EMAIL
   ```
   This will display a list of all roles assigned to the service account. If the service account has access to more roles than necessary, it indicates a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: You will need the Kubernetes Python client to interact with the Kubernetes API. You can install it using pip:

```python
pip install kubernetes
```

2. Connect to the Kubernetes API: Use the `config.load_kube_config()` function from the Kubernetes client to connect to the API. This function reads from the default kubeconfig file location (`~/.kube/config`) or the path specified in the `KUBECONFIG` environment variable.

```python
from kubernetes import client, config

config.load_kube_config()
v1 = client.CoreV1Api()
```

3. Fetch all Service Accounts: Use the `list_service_account_for_all_namespaces()` function to fetch all service accounts across all namespaces.

```python
service_accounts = v1.list_service_account_for_all_namespaces().items
```

4. Check for excessive permissions: For each service account, check if it has `cluster-admin` role. This role has full control over the entire cluster and should be limited. If a service account has this role, it's a misconfiguration.

```python
for sa in service_accounts:
    roles = v1.list_cluster_role_binding().items
    for role in roles:
        if role.role_ref.name == 'cluster-admin':
            for subject in role.subjects:
                if subject.kind == 'ServiceAccount' and subject.name == sa.metadata.name and subject.namespace == sa.metadata.namespace:
                    print(f"Service Account {sa.metadata.name} in namespace {sa.metadata.namespace} has cluster-admin role.")
```

This script will print out the names and namespaces of all service accounts that have the `cluster-admin` role. If no such service accounts are found, it means there is no misconfiguration in this regard.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Cluster Should Have Limited Service Account Access" for GCP using GCP console, follow these steps:

1. Open the Google Kubernetes Engine (GKE) console.
2. Select the cluster that needs to be remediated.
3. Click on the "Security" tab.
4. Scroll down to the "Service Accounts" section.
5. Click on the "Edit" button.
6. In the "Service Accounts" section, select the option "Limit service account access to this cluster".
7. Select the service account that needs access to the cluster.
8. Click on the "Save" button to save the changes.

By following these steps, the cluster will have limited service account access and only the selected service account will have access to the cluster.

#### Using CLI

To remediate the misconfiguration "Cluster Should Have Limited Service Account Access" for GCP using GCP CLI, you can follow the below steps:

Step 1: Open the Cloud Shell from the GCP console or install the GCP CLI on your local machine.

Step 2: Authenticate with your GCP account using the below command:
```
gcloud auth login
```

Step 3: Set the project where the cluster is located using the below command:
```
gcloud config set project [PROJECT_ID]
```

Step 4: Get the name of the cluster that needs to be remediated using the below command:
```
gcloud container clusters list
```

Step 5: Fetch the current IAM policy for the cluster using the below command:
```
gcloud container clusters get-iam-policy [CLUSTER_NAME] --zone [ZONE]
```

Step 6: Identify the service accounts that have access to the cluster and need to be removed from the IAM policy.

Step 7: Remove the service accounts from the IAM policy using the below command:
```
gcloud container clusters set-iam-policy [CLUSTER_NAME] --zone [ZONE] --remove-service-account [SERVICE_ACCOUNT_EMAIL_1],[SERVICE_ACCOUNT_EMAIL_2],...
```

Step 8: Verify the changes by fetching the updated IAM policy using the below command:
```
gcloud container clusters get-iam-policy [CLUSTER_NAME] --zone [ZONE]
```

By following these steps, you can remediate the misconfiguration "Cluster Should Have Limited Service Account Access" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Cluster Should Have Limited Service Account Access" for GCP using Python, follow these steps:

1. Install the required libraries:
   ```
   pip install google-auth google-auth-oauthlib google-auth-httplib2 google-cloud-container google-cloud-logging
   ```

2. Authenticate to GCP:
   ```
   from google.oauth2 import service_account
   credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_file>')
   ```

3. Retrieve the cluster object:
   ```
   from google.cloud import container_v1
   client = container_v1.ClusterManagerClient(credentials=credentials)
   project_id = '<your_project_id>'
   zone = '<your_zone>'
   cluster_id = '<your_cluster_id>'
   cluster = client.get_cluster(project_id, zone, cluster_id)
   ```

4. Update the cluster's `master_auth` field to limit service account access:
   ```
   cluster.master_auth.cluster_ca_certificate = '<your_cluster_ca_certificate>'
   cluster.master_auth.username = '<your_username>'
   cluster.master_auth.password = '<your_password>'
   cluster.master_auth.client_certificate = '<your_client_certificate>'
   cluster.master_auth.client_key = '<your_client_key>'
   cluster.master_auth.client_certificate_config = {
       'issue_client_certificate': False,
   }
   cluster.master_auth.client_certificate_config.allowed_client_certificates = [
       '<your_allowed_client_certificate_1>',
       '<your_allowed_client_certificate_2>',
   ]
   update_mask = {
       'paths': [
           'master_auth.cluster_ca_certificate',
           'master_auth.username',
           'master_auth.password',
           'master_auth.client_certificate',
           'master_auth.client_key',
           'master_auth.client_certificate_config.issue_client_certificate',
           'master_auth.client_certificate_config.allowed_client_certificates',
       ]
   }
   operation = client.update_cluster(project_id, zone, cluster_id, cluster, update_mask)
   ```

5. Verify that the update was successful:
   ```
   operation.result()
   ```

Note: The above steps assume that you have a GCP service account with sufficient permissions to access the cluster. Replace the placeholders (`<...>`) with your own values.


### Additional Reading:

- [https://cloud.google.com/compute/docs/access/service-accounts](https://cloud.google.com/compute/docs/access/service-accounts) 


</Tab>
</Tabs>