---
slug: k8s_cluster_access_gcr
title: Minimize Cluster Access To Read-Only For GCR
sidebar_label: Minimize Cluster Access To Read-Only For GCR
---

### More Info:

Configure the Cluster Service Account with Storage Object Viewer Role to only allow readonly access to GCR.

### Risk Level

Medium

### Address

Security, Reliability, Best Practice

### Compliance Standards

CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine from the left-hand side menu. 

3. Select the cluster you want to inspect and click on it to view its details.

4. In the details page, check the "Access scopes" section. If the Google Container Registry (GCR) access is set to "Read/Write" or "Full", then the cluster has more than read-only access to GCR.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install and authenticate it.

2. Once the SDK is installed and configured, you can list all the clusters in your project by running the following command in your terminal:

   ```
   gcloud container clusters list
   ```

   This command will return a list of all the clusters in your project, along with their details.

3. To check the access level of a specific cluster, you can run the following command:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone=[ZONE_NAME]
   ```

   Replace [CLUSTER_NAME] with the name of your cluster and [ZONE_NAME] with the zone of your cluster. This command will return a detailed description of your cluster, including its access level.

4. In the output of the above command, look for the "legacyAbac" field. If the "enabled" field under "legacyAbac" is set to true, it means that the cluster has read-write access. If it's set to false, it means that the cluster has read-only access.

#### Using Python

1. Install the necessary Python libraries: You will need the `google-cloud-container` library to interact with Google Kubernetes Engine (GKE). You can install it using pip:

   ```bash
   pip install --upgrade google-cloud-container
   ```

2. Import the necessary modules and set up the client:

   ```python
   from google.cloud import container_v1

   # Set up the client
   client = container_v1.ClusterManagerClient()
   ```

3. Get the list of clusters and check the access scopes:

   ```python
   # Get the list of clusters
   clusters = client.list_clusters(project_id, zone)

   # Check the access scopes for each cluster
   for cluster in clusters:
       if 'https://www.googleapis.com/auth/devstorage.read_only' not in cluster.addons_config.kubernetes_dashboard.disabled:
           print(f"Cluster {cluster.name} has not minimized access to read-only for GCR.")
   ```

4. Run the script: Save the script to a file, set your `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file, and run the script. If any clusters have not minimized access to read-only for GCR, they will be printed out.

   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/service-account-key.json"
   python check_gcr_access.py
   ```

Note: This script assumes that you have the necessary permissions to list and get details about clusters in the specified project and zone. If you do not, you will need to grant them before you can run the script.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To minimize cluster access to read-only for GCR in GCP, you can follow the below steps:

1. Open the Google Cloud Console and select the GKE cluster for which you want to minimize the access.

2. Click on the "Edit" button for the cluster.

3. Scroll down to the "Security" section and click on "Add item" under the "Container Registry" subsection.

4. In the "Add members" field, enter the email addresses of the users or service accounts that you want to grant read-only access to.

5. In the "Role" field, select "Storage Object Viewer" from the dropdown menu.

6. Click on the "Save" button to save the changes.

7. Repeat steps 4-6 for each user or service account that you want to grant read-only access to.

8. Once you have added all the users or service accounts, click on the "Save" button to save the changes to the cluster.

By following these steps, you will be able to minimize the cluster access to read-only for GCR in GCP using the GCP console.

#### Using CLI

To minimize cluster access to read-only for GCR, you can follow these steps:

1. Open the Cloud Shell in your GCP console.
2. Run the following command to create a new Kubernetes cluster role:

   ```
   kubectl create clusterrole read-only --verb=get,list,watch --resource=pods,endpoints,services,secrets
   ```

3. Run the following command to create a new Kubernetes cluster role binding:

   ```
   kubectl create clusterrolebinding read-only-binding --clusterrole=read-only --user=<your-email-address>
   ```

   Replace `<your-email-address>` with your GCP account email address.

4. Run the following command to grant the Kubernetes service account read-only access to the Google Container Registry:

   ```
   gcloud projects add-iam-policy-binding <your-project-id> --member=serviceAccount:<your-project-id>@cloudbuild.gserviceaccount.com --role=roles/storage.objectViewer
   ```

   Replace `<your-project-id>` with your GCP project ID.

5. Run the following command to verify that the Kubernetes service account has read-only access to the Google Container Registry:

   ```
   gcloud auth activate-service-account --key-file=/var/run/secrets/kubernetes.io/serviceaccount/token
   gcloud container images list
   ```

   This will list all the images in your project's Google Container Registry. If you can see the list of images, it means that the Kubernetes service account has read-only access to the Google Container Registry.

By following these steps, you have minimized cluster access to read-only for GCR in GCP using GCP CLI.

#### Using Python

To minimize cluster access to read-only for GCR in GCP, you can follow these steps:

1. Open the Cloud Shell in your GCP console.

2. Install the necessary Python libraries by running the following command:
   ```
   pip install google-cloud-storage google-auth
   ```

3. Create a Python script and import the necessary libraries:
   ```
   from google.cloud import storage
   from google.oauth2 import service_account
   ```

4. Set up the credentials for your GCP account:
   ```
   credentials = service_account.Credentials.from_service_account_file(
       '/path/to/your/credentials.json')
   ```

5. Create a storage client using the credentials:
   ```
   client = storage.Client(credentials=credentials)
   ```

6. Get the bucket that contains your GCR images:
   ```
   bucket = client.get_bucket('gcr.io')
   ```

7. Set the bucket's IAM policy to allow read-only access for the cluster:
   ```
   policy = bucket.get_iam_policy(requested_policy_version=3)
   policy.bindings.append(
       {
           "role": "roles/storage.objectViewer",
           "members": {
               "serviceAccount:my-cluster-sa@my-project.iam.gserviceaccount.com"
           }
       }
   )
   bucket.set_iam_policy(policy)
   ```

   Note: Replace `my-cluster-sa@my-project.iam.gserviceaccount.com` with the service account of your cluster.

8. Save the Python script and run it using the following command:
   ```
   python <script_name>.py
   ```

This will minimize cluster access to read-only for GCR in GCP.


### Additional Reading:

- [https://cloud.google.com/container-registry/docs/access-control](https://cloud.google.com/container-registry/docs/access-control) 


</Tab>
</Tabs>