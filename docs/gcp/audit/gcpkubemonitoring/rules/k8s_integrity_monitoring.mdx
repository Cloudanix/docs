---
slug: k8s_integrity_monitoring
title: Integrity Monitoring Should Be Enabled For Kubernetes Node Pools
sidebar_label: Integrity Monitoring Should Be Enabled For Kubernetes Node Pools
---

### More Info:

Ensure that kubernetes node pools have Integrity Monitoring enabled

### Risk Level

Medium

### Address

Performance Efficiency, Operational Excellence, Reliability, Security

### Compliance Standards

HITRUST, SOC2, NISTCSF



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (https://console.cloud.google.com/), and sign in with your Google account credentials.

2. Navigate to Kubernetes Engine: From the left-hand side menu of the GCP Console, click on "Kubernetes Engine" to access the Kubernetes clusters deployed within your Google Cloud account.

3. Select the Kubernetes Cluster: In the Kubernetes Engine dashboard, select the Kubernetes cluster that you want to examine.

4. Check Node Pools Integrity Monitoring: Once you've selected the cluster, click on the "Node pools" tab. Here, you can see all the node pools associated with your cluster. Click on each node pool and check the "Security" section. If "Integrity Monitoring" is not enabled, it indicates a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. This will allow you to interact with your GCP resources from your local machine. You can download it from the official Google Cloud website and install it on your machine. After installation, authenticate the SDK to your Google Cloud account using the command: 
```
gcloud auth login
```

2. List all the projects in your GCP account using the following command. This will display all the projects where you have GCP resources.
```
gcloud projects list
```

3. Set the project you want to check for the Kubernetes Node Pools integrity monitoring. Replace `PROJECT_ID` with your project's ID.
```
gcloud config set project PROJECT_ID
```

4. Now, list all the Kubernetes clusters in your project using the following command. This will display all the Kubernetes clusters in your project.
```
gcloud container clusters list
```

5. For each cluster, check the status of the Integrity Monitoring for the Node Pools. Replace `CLUSTER_NAME` with your cluster's name and `ZONE` with the zone of your cluster.
```
gcloud container node-pools describe NODE_POOL_NAME --cluster=CLUSTER_NAME --zone=ZONE
```
In the output, look for the `shieldedInstanceConfig` field. If `enableIntegrityMonitoring` is set to `false`, then Integrity Monitoring is not enabled for that Node Pool.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries. We will need the `google.cloud.container_v1` library to interact with Google Kubernetes Engine (GKE) and `os` to set the environment variables.

    ```python
    from google.cloud import container_v1
    import os
    ```

2. **Set Environment Variables**: Set the environment variables for your Google Cloud project and zone. Replace `'your-project-id'` and `'your-zone'` with your project ID and zone.

    ```python
    os.environ["GOOGLE_CLOUD_PROJECT"] = 'your-project-id'
    os.environ["GOOGLE_CLOUD_ZONE"] = 'your-zone'
    ```

3. **Create a GKE Client**: Create a GKE client to interact with the GKE API.

    ```python
    client = container_v1.ClusterManagerClient()
    ```

4. **Check Integrity Monitoring**: Iterate over all the clusters and their node pools in your project and zone, and check if integrity monitoring is enabled. If it is not enabled, print the name of the node pool.

    ```python
    clusters = client.list_clusters(project_id=os.getenv('GOOGLE_CLOUD_PROJECT'), zone=os.getenv('GOOGLE_CLOUD_ZONE'))
    for cluster in clusters.clusters:
        for node_pool in cluster.node_pools:
            if not node_pool.config.shielded_instance_config.enable_integrity_monitoring:
                print(f'Integrity Monitoring is not enabled for node pool {node_pool.name} in cluster {cluster.name}.')
    ```

This script will print the names of all the node pools in your GKE clusters where integrity monitoring is not enabled.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration "Integrity Monitoring Should Be Enabled For Kubernetes Node Pools" for GCP using GCP console:

1. Go to the GCP Console and select the project where the Kubernetes node pool is located.
2. In the left navigation menu, select "Kubernetes Engine" and then select "Node pools".
3. From the list of node pools, select the node pool that you want to enable Integrity Monitoring for.
4. Click on the "Edit" button at the top of the page.
5. Scroll down to the "Security" section and click on "Show".
6. Find the option for "Integrity monitoring" and toggle it to "On".
7. Click on the "Save" button at the bottom of the page to save your changes.

After completing these steps, Integrity Monitoring will be enabled for the selected Kubernetes node pool on GCP.

#### Using CLI

To remediate the misconfiguration "Integrity Monitoring should be enabled for Kubernetes Node Pools" for GCP using GCP CLI, follow the below steps:

1. Open the GCP Cloud Shell or open the terminal and connect to the GCP project using the command `gcloud auth login` and `gcloud config set project [PROJECT_ID]`.

2. Run the following command to enable the integrity monitoring for Kubernetes node pools:

```
gcloud container node-pools update [NODE_POOL_NAME] --cluster=[CLUSTER_NAME] --enable-intra-node-visibility --enable-integrity-monitoring
```

Replace `[NODE_POOL_NAME]` with the name of the node pool and `[CLUSTER_NAME]` with the name of the cluster.

3. Verify the integrity monitoring is enabled for the node pool by running the following command:

```
gcloud container node-pools describe [NODE_POOL_NAME] --cluster=[CLUSTER_NAME] | grep integrity
```

If the output shows `"integrityMonitoringEnabled: true"`, then the integrity monitoring is enabled for the node pool.

4. Repeat the above steps for all the node pools in the cluster.

By following the above steps, integrity monitoring will be enabled for Kubernetes node pools in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Integrity Monitoring Should Be Enabled For Kubernetes Node Pools" for GCP using python, you can follow the below steps:

1. First, you need to authenticate with the GCP project using the following python code:

```python
from google.auth import compute_engine
from google.cloud import monitoring_v3

# Authenticate with GCP project
credentials = compute_engine.Credentials()
client = monitoring_v3.MetricServiceClient(credentials=credentials)
project_id = 'your-project-id'
```

2. Then, you need to get the list of Kubernetes node pools in the GCP project using the following python code:

```python
# Get the list of Kubernetes node pools
node_pools = []
for cluster in client.list_clusters(project_id):
    for pool in client.list_node_pools(project_id, cluster.name):
        node_pools.append(pool)
```

3. Next, you need to check if integrity monitoring is enabled for each Kubernetes node pool using the following python code:

```python
# Check if integrity monitoring is enabled for each node pool
for pool in node_pools:
    if not pool.management.auto_repair.integrity_monitoring:
        # Enable integrity monitoring
        pool.management.auto_repair.integrity_monitoring = True
        client.update_node_pool(project_id, pool.cluster_id, pool.name, pool)
```

4. Finally, you can print a message indicating that the remediation is complete using the following python code:

```python
# Print a message indicating that the remediation is complete
print('Integrity monitoring has been enabled for all Kubernetes node pools.')
```

By following these steps, you can remediate the misconfiguration "Integrity Monitoring Should Be Enabled For Kubernetes Node Pools" for GCP using python.


### Additional Reading:

- [https://cloud.google.com/kubernetes-engine/docs/how-to/shielded-gke-nodes](https://cloud.google.com/kubernetes-engine/docs/how-to/shielded-gke-nodes) 


</Tab>
</Tabs>