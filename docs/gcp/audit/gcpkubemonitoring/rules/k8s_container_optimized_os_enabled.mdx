---
slug: k8s_container_optimized_os_enabled
title: Container-Optimized OS Should Be Enabled
sidebar_label: Container-Optimized OS Should Be Enabled
---

### More Info:

Ensures all Kubernetes cluster nodes have Container-Optimized OS enabled. Container-Optimized OS is optimized to enhance node security. It is backed by a team at Google that can quickly patch it.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your preferred web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access GCP resources.

2. Navigate to Kubernetes Engine: From the left-hand side menu of the GCP Console, click on "Kubernetes Engine". This will take you to the Kubernetes clusters page where you can see all your Kubernetes clusters.

3. Select the Kubernetes Cluster: From the list of Kubernetes clusters, select the cluster you want to inspect for the misconfiguration. Click on the cluster name to open its details page.

4. Check the Node Configuration: In the cluster details page, look for the "Node Pools" section. Here, you can see the details of the nodes used in the cluster. Check the "Image Type" field. If it is not set to "Container-Optimized OS", then the misconfiguration is present.

#### Using CLI

1. Install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Authenticate your gcloud CLI with your Google Cloud account by running the following command and following the prompts:
   ```
   gcloud auth login
   ```

3. Set your default project to the project where your Kubernetes clusters are located. Replace `PROJECT_ID` with your actual project ID.
   ```
   gcloud config set project PROJECT_ID
   ```

4. Run the following command to list all the Kubernetes clusters in your project and check if Container-Optimized OS is enabled. The `NODE_CONFIG_IMAGE_TYPE` field should be `COS` for Container-Optimized OS.
   ```
   gcloud container clusters list --format='table(name, nodeConfig.imageType)'
   ```
   If the `NODE_CONFIG_IMAGE_TYPE` is not `COS`, then Container-Optimized OS is not enabled for that cluster.

#### Using Python

Container-Optimized OS (COS) is a lightweight operating system designed by Google that is optimized for running Docker containers. It comes with a built-in Docker and it is based on the open-source Chromium OS project. COS is maintained by Google and it is designed to provide a secure and stable platform for running containerized workloads in the cloud.

To check if Container-Optimized OS is enabled in Kubernetes, you can use the Kubernetes Python client. Here are the steps:

1. Install the Kubernetes Python client:

```python
pip install kubernetes
```

2. Import the necessary modules and configure the client:

```python
from kubernetes import client, config

# Load the kube config from the default location
config.load_kube_config()
```

3. Get the list of nodes and check the OS image:

```python
v1 = client.CoreV1Api()
print("Listing nodes with their OS image:\n")
ret = v1.list_node(watch=False)
for i in ret.items:
    print("%s\t%s\t%s" % (i.status.node_info.machine_id, i.status.node_info.system_uuid, i.status.node_info.os_image))
```

4. Check if the OS image is Container-Optimized OS:

```python
for i in ret.items:
    if "Container-Optimized OS" not in i.status.node_info.os_image:
        print("Node %s is not running Container-Optimized OS" % i.metadata.name)
```

This script will print out the nodes that are not running Container-Optimized OS. If all nodes are running Container-Optimized OS, it will not print anything.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of "Container-Optimized OS Should Be Enabled" in GCP, you can follow the below steps using the GCP console:

1. Open the GCP Console and go to the Compute Engine page.
2. Select the instance for which you want to enable Container-Optimized OS.
3. Click on the "Edit" button on the top of the page.
4. Scroll down to the "Cloud API access scopes" section.
5. Expand the "Compute Engine default service account" section.
6. Click on the "Set access for each API" button.
7. In the "Compute Engine" section, select the "Read Write" access level.
8. Click on the "Save" button to save the changes.
9. Scroll up to the "Boot disk" section.
10. Click on the "Change" button.
11. In the "Operating system" section, select "Container-Optimized OS".
12. Click on the "Select" button to save the changes.
13. Click on the "Save" button to apply the changes to the instance.

Once the above steps are completed, the Container-Optimized OS will be enabled for the selected instance.

#### Using CLI

To enable Container-Optimized OS on GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell on the GCP Console.
2. Run the following command to enable the Container-Optimized OS:

```
gcloud compute instances create [INSTANCE_NAME] \
--image-project cos-cloud \
--image-family cos-stable \
--boot-disk-size [DISK_SIZE] \
--boot-disk-type pd-standard \
--boot-disk-device-name [DEVICE_NAME]
```

Replace [INSTANCE_NAME] with the name of the instance that you want to enable Container-Optimized OS on, [DISK_SIZE] with the size of the boot disk in GB, and [DEVICE_NAME] with the name of the boot disk device.

3. Once the instance is created, SSH into the instance and verify that Container-Optimized OS is enabled by running the following command:

```
cat /etc/os-release
```

This command should output information about the OS, including the line "ID=cos".

That's it! Container-Optimized OS is now enabled on your GCP instance.

#### Using Python

To remediate the misconfiguration of "Container-Optimized OS Should Be Enabled" in GCP using Python, you can follow the below steps:

1. Import the necessary libraries:

```
from googleapiclient.discovery import build
from google.oauth2 import service_account
```

2. Set the project ID and the service account credentials:

```
project_id = "<PROJECT_ID>"
credentials = service_account.Credentials.from_service_account_file('<SERVICE_ACCOUNT_KEY_FILE_PATH>')
```

3. Build the GCP Compute Engine API client:

```
compute_client = build('compute', 'v1', credentials=credentials)
```

4. Get the list of instances in the project:

```
instances = compute_client.instances().list(project=project_id, zone='<ZONE>').execute()
```

5. Loop through the instances and check if the Container-Optimized OS is enabled:

```
for instance in instances['items']:
    instance_name = instance['name']
    instance_id = instance['id']
    instance_zone = instance['zone'].split('/')[-1]
    
    # Get the instance metadata
    metadata = compute_client.instances().get(project=project_id, zone=instance_zone, instance=instance_name).execute()['metadata']['items']
    
    # Check if Container-Optimized OS is enabled
    cos_enabled = False
    for item in metadata:
        if item['key'] == 'google-container-os':
            if item['value'] == 'true':
                cos_enabled = True
                break
    
    # If Container-Optimized OS is not enabled, enable it
    if not cos_enabled:
        metadata.append({
            'key': 'google-container-os',
            'value': 'true'
        })
        compute_client.instances().update(project=project_id, zone=instance_zone, instance=instance_name, body={
            'metadata': {
                'items': metadata
            }
        }).execute()
        print(f"Container-Optimized OS enabled for instance {instance_name} (ID: {instance_id}) in zone {instance_zone}")
    else:
        print(f"Container-Optimized OS already enabled for instance {instance_name} (ID: {instance_id}) in zone {instance_zone}")
```

This code will check all the instances in the specified zone of the project and enable the Container-Optimized OS if it is not already enabled.


### Additional Reading:

- [https://cloud.google.com/container-optimized-os/](https://cloud.google.com/container-optimized-os/) 
- [https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster](https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster) 


</Tab>
</Tabs>