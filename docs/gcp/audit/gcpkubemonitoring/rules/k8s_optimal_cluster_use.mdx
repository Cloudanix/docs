---
slug: k8s_optimal_cluster_use
title: Autoscaling Profile For Clusters Should Be Set To Optimize_Utilization or Balanced
sidebar_label: Autoscaling Profile For Clusters Should Be Set To Optimize_Utilization or Balanced
---

### More Info:

Ensure that cluster autoscaling profile is set to OPTIMIZE_UTILIZATION or BALANCED for optimal resource utilization

### Risk Level

Medium

### Address

Performance Efficiency, Operational Excellence, Reliability, Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. You can do this by clicking on the hamburger menu on the top left corner, then select "Kubernetes Engine" from the drop-down menu.

3. Once you're in the Kubernetes Engine section, select "Clusters". This will show you a list of all your Kubernetes clusters.

4. Click on the name of the cluster you want to check. This will take you to the cluster's details page. Here, you can see the autoscaling profile for the cluster under the "Autoscaling" section. The profile should be set to either "Optimize_Utilization" or "Balanced". If it's set to anything else, then it's a misconfiguration.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install and authenticate it.

2. Once the SDK is installed and configured, open your terminal and run the following command to list all the clusters in your GCP project:

   ```
   gcloud container clusters list
   ```

   This command will return a list of all the Kubernetes clusters in your project, along with some basic information about them.

3. To check the autoscaling profile for a specific cluster, you can use the following command:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone=[ZONE_NAME]
   ```

   Replace [CLUSTER_NAME] with the name of your cluster and [ZONE_NAME] with the zone where your cluster is located. This command will return a detailed description of your cluster, including the autoscaling profile.

4. In the output of the previous command, look for the "autoscalingProfile" field. If it is set to "OPTIMIZE_UTILIZATION" or "BALANCED", then the autoscaling profile for your cluster is correctly configured. If it is set to any other value or if the field is not present, then there is a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: You will need the Kubernetes Python client to interact with the Kubernetes API. You can install it using pip:

```python
pip install kubernetes
```

2. Connect to the Kubernetes API: You will need to create a configuration object to connect to the Kubernetes API. This can be done using the `config.load_kube_config()` function if you are running the script from a machine that has kubectl installed and configured. If you are running the script from within a pod in the cluster, you can use the `config.load_incluster_config()` function.

```python
from kubernetes import client, config

# Load the kube config from the machine running the script
config.load_kube_config()

# Create an API client object
api = client.AutoscalingV1Api()
```

3. Retrieve the autoscaling profiles for all clusters: You can use the `list_horizontal_pod_autoscaler_for_all_namespaces()` function to retrieve the autoscaling profiles for all clusters.

```python
hpa_list = api.list_horizontal_pod_autoscaler_for_all_namespaces()
```

4. Check the autoscaling profile for each cluster: You can iterate over the list of horizontal pod autoscalers and check the `spec.targetCPUUtilizationPercentage` and `spec.targetMemoryUtilizationPercentage` fields. If these fields are not set to `Optimize_Utilization` or `Balanced`, then the cluster is misconfigured.

```python
for hpa in hpa_list.items:
    if hpa.spec.targetCPUUtilizationPercentage != 'Optimize_Utilization' and hpa.spec.targetMemoryUtilizationPercentage != 'Balanced':
        print(f"Cluster {hpa.metadata.name} is misconfigured")
```

Please note that the above script assumes that you have the necessary permissions to list and view the horizontal pod autoscalers in all namespaces. If you do not have these permissions, you will need to modify the script to only check the namespaces that you have access to.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the Autoscaling Profile for Clusters misconfiguration in GCP using GCP console, follow these steps:

1. Open the GCP console and navigate to the Kubernetes Engine page.
2. Select the cluster that you want to remediate.
3. Click on "Edit" button at the top of the page.
4. In the "Node pools" section, click on the name of the node pool that you want to remediate.
5. Scroll down to the "Autoscaling" section and click on "Edit".
6. In the "Autoscaling mode" section, select either "Optimize utilization" or "Balanced" depending on your requirements.
7. Click on "Save" to apply the changes.

Once you have completed these steps, the Autoscaling Profile for Clusters misconfiguration will be remediated in GCP.

#### Using CLI

To remediate the misconfiguration "Autoscaling Profile For Clusters Should Be Set To Optimize_Utilization or Balanced" for GCP using GCP CLI, you can follow the below steps:

Step 1: Open the Cloud Shell in your GCP console.

Step 2: Run the following command to list all the existing node pool configurations in the cluster:

```
gcloud container node-pools list --cluster <cluster-name>
```

Step 3: Choose the node pool for which you want to set the autoscaling profile.

Step 4: Run the following command to set the autoscaling profile to "optimize-utilization":

```
gcloud container node-pools update <node-pool-name> --cluster <cluster-name> --autoscaling-profile optimize-utilization
```

OR

Run the following command to set the autoscaling profile to "balanced":

```
gcloud container node-pools update <node-pool-name> --cluster <cluster-name> --autoscaling-profile balanced
```

Note: Replace `<cluster-name>` and `<node-pool-name>` with the actual names of your cluster and node pool respectively.

Step 5: Verify that the autoscaling profile has been set correctly by running the following command:

```
gcloud container node-pools describe <node-pool-name> --cluster <cluster-name> --format="value(config.autoscaling.autoprovisioningProfile)"
```

This should return either "optimize-utilization" or "balanced" depending on which profile you chose to set.

By following these steps, you can remediate the misconfiguration "Autoscaling Profile For Clusters Should Be Set To Optimize_Utilization or Balanced" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Autoscaling Profile For Clusters Should Be Set To Optimize_Utilization or Balanced" in GCP, you can follow the below steps using Python:

1. Import the required libraries:

```
from google.cloud import dataproc_v1 as dataproc
from google.protobuf import field_mask_pb2 as field_mask
```

2. Set the project ID, region, and cluster name:

```
project_id = "your-project-id"
region = "your-region"
cluster_name = "your-cluster-name"
```

3. Create a client object:

```
client = dataproc.ClusterControllerClient()
```

4. Get the current cluster configuration:

```
cluster = client.get_cluster(project_id, region, cluster_name)
```

5. Update the autoscaling configuration with the desired profile:

```
autoscaling_config = cluster.config.software_config.autoscaling_config
autoscaling_config.policy_uri = ""
autoscaling_config.secondary_worker_config = {}
autoscaling_config.policy_uri = ""
autoscaling_config.worker_config.autoscaling_policy.policy_uri = ""
autoscaling_config.worker_config.autoscaling_policy.basic_algorithm = "BASIC_AUTOSCALING"
autoscaling_config.worker_config.autoscaling_policy.yarn_config.graceful_decommission_timeout = {}
autoscaling_config.worker_config.autoscaling_policy.yarn_config.scale_up_factor = 0.5
autoscaling_config.worker_config.autoscaling_policy.yarn_config.scale_down_factor = 1.0
autoscaling_config.worker_config.autoscaling_policy.yarn_config.scale_down_min_worker_fraction = 0.8
autoscaling_config.secondary_worker_config.autoscaling_policy.policy_uri = ""
autoscaling_config.secondary_worker_config.autoscaling_policy.basic_algorithm = "BASIC_AUTOSCALING"
autoscaling_config.secondary_worker_config.autoscaling_policy.yarn_config.graceful_decommission_timeout = {}
autoscaling_config.secondary_worker_config.autoscaling_policy.yarn_config.scale_up_factor = 0.5
autoscaling_config.secondary_worker_config.autoscaling_policy.yarn_config.scale_down_factor = 1.0
autoscaling_config.secondary_worker_config.autoscaling_policy.yarn_config.scale_down_min_worker_fraction = 0.8
```

6. Update the cluster configuration:

```
update_mask = field_mask.FieldMask(paths=["config.software_config.autoscaling_config"])
client.update_cluster(project_id, region, cluster_name, cluster, update_mask)
```

This will update the autoscaling configuration for the specified GCP cluster with the desired profile.


### Additional Reading:

- [https://cloud.google.com/kubernetes-engine/docs/reference/rest/v1/projects.locations.clusters#Cluster.AutoscalingProfile](https://cloud.google.com/kubernetes-engine/docs/reference/rest/v1/projects.locations.clusters#Cluster.AutoscalingProfile) 


</Tab>
</Tabs>