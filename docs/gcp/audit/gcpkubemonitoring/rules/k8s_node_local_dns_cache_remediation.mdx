

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. Here, you will find a list of all your Kubernetes clusters.

3. Click on the specific cluster you want to check. This will open the cluster's details page.

4. In the details page, look for the "Node Local DNS Cache" setting. If it's enabled, you will see it listed there. If it's not listed, then the cluster is not using Node Local DNS Cache.

#### Using CLI

1. First, you need to install and configure Google Cloud SDK (gcloud CLI) on your local machine. Once installed, authenticate your SDK using the command `gcloud auth login`.

2. After successful authentication, set your project ID to the current project using the command `gcloud config set project [PROJECT_ID]`.

3. Now, list all the clusters in the current project using the command `gcloud container clusters list`. This will give you a list of all the clusters along with their details.

4. For each cluster, check if NodeLocal DNSCache is enabled or not. You can do this by describing the cluster using the command `gcloud container clusters describe [CLUSTER_NAME] --zone=[ZONE_NAME] | grep -A5 dnsCacheConfig`. If the output contains `enabled: true`, then NodeLocal DNSCache is enabled. If not, it means NodeLocal DNSCache is not enabled for that cluster.

#### Using Python

To check if a Kubernetes cluster is using Node Local DNS Cache, you can use the Kubernetes Python client. Here are the steps:

1. **Install the Kubernetes Python client:**

   You can install the Kubernetes Python client using pip:
   ```
   pip install kubernetes
   ```
2. **Configure access to your Kubernetes cluster:**

   You need to configure your access to the Kubernetes cluster. If you're running the script from within a pod in the cluster, you can use the service account token and cluster CA certificate that Kubernetes automatically mounts into the pod. If you're running the script from outside the cluster, you'll need to provide a kubeconfig file that specifies the cluster's API server and a user to authenticate as.

   Here's how you can configure the client to use a kubeconfig file:
   ```python
   from kubernetes import config

   config.load_kube_config('/path/to/your/kubeconfig')
   ```
3. **Check the ConfigMap of kube-dns:**

   You can use the Kubernetes Python client to get the ConfigMap of kube-dns in the kube-system namespace. If the cluster is using Node Local DNS Cache, the ConfigMap should contain a stubDomains field that redirects DNS queries for the cluster's DNS domain to the Node Local DNS Cache.

   Here's how you can get the ConfigMap and check for the stubDomains field:
   ```python
   from kubernetes import client

   v1 = client.CoreV1Api()
   config_map = v1.read_namespaced_config_map('kube-dns', 'kube-system')

   if 'stubDomains' in config_map.data:
       print('Cluster is using Node Local DNS Cache')
   else:
       print('Cluster is not using Node Local DNS Cache')
   ```
4. **Check the DaemonSet of node-local-dns:**

   In addition to the ConfigMap, you can also check if there's a DaemonSet for node-local-dns in the kube-system namespace. If the cluster is using Node Local DNS Cache, this DaemonSet should exist and its pods should be running on every node in the cluster.

   Here's how you can get the DaemonSet and check if its pods are running on every node:
   ```python
   from kubernetes import client

   v1 = client.AppsV1Api()
   daemon_set = v1.read_namespaced_daemon_set('node-local-dns', 'kube-system')

   if daemon_set.status.current_number_scheduled == daemon_set.status.number_ready:
       print('Node Local DNS Cache is running on every node')
   else:
       print('Node Local DNS Cache is not running on every node')
   ```

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Cluster Should Use Node Local DNS Cache" for GCP using GCP console, please follow the below steps:

1. Open the Google Cloud Console and select your project.

2. Go to the Kubernetes Engine section of the console.

3. Select the cluster you want to remediate.

4. Click on the "Edit" button at the top of the page.

5. In the "Node pools" section, click on the name of the node pool you want to remediate.

6. Scroll down to the "Node image" section and click on the "Change" button.

7. Select the latest version of the node image that includes the node local DNS cache feature.

8. Click on the "Save" button to save the changes.

9. Wait for the nodes in the node pool to be updated with the new node image.

10. Verify that the node local DNS cache feature is enabled by running a test pod and checking its DNS resolution.

By following these steps, you can remediate the misconfiguration "Cluster Should Use Node Local DNS Cache" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Cluster Should Use Node Local DNS Cache" in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in GCP Console.
2. Run the following command to get the list of clusters in your project:

```
gcloud container clusters list
```

3. Identify the cluster that needs to be remediated and run the following command to get the cluster's credentials:

```
gcloud container clusters get-credentials <cluster-name> --zone <zone> --project <project-id>
```

4. Once you have the credentials, run the following command to update the cluster configuration:

```
gcloud container clusters update <cluster-name> --zone <zone> --project <project-id> --enable-dns-cache
```

This command enables the node local DNS cache for the specified cluster. 

5. Verify that the configuration has been updated by running the following command:

```
gcloud container clusters describe <cluster-name> --zone <zone> --project <project-id> | grep dnsCacheConfig
```

This command should return the following output, indicating that the node local DNS cache is enabled:

```
dnsCacheConfig:
  enabled: true
```

By following these steps, you have successfully remediated the misconfiguration "Cluster Should Use Node Local DNS Cache" for your GCP cluster using GCP CLI.

#### Using Python

To remediate the misconfiguration "Cluster Should Use Node Local DNS Cache" in GCP using Python, you can follow the below steps:

Step 1: Install the necessary Python packages - `google-auth` and `google-api-python-client`.

```
pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
```

Step 2: Authenticate with GCP using a service account key file.

```
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_key_file>')
```

Step 3: Enable the "Cloud DNS API" for the project.

```
from googleapiclient.discovery import build

dns_service = build('dns', 'v1', credentials=credentials)

project_id = '<your_project_id>' # Replace with your GCP project ID

dns_service.projects().get(project=project_id).execute()

```

Step 4: Create a new DNS policy with node-local caching enabled.

```
policy_body = {
    "alternativeNameServerConfig": {
      "kind": "dns#policyAlternativeNameServerConfig",
      "targetNameServers": [
        {
          "forwardingPath": "default",
          "ipv4Address": "127.0.0.1",
          "kind": "dns#policyAlternativeNameServerConfigTargetNameServer",
          "networkUrl": "https://www.googleapis.com/compute/v1/projects/<your_project_id>/global/networks/default"
        }
      ]
    },
    "description": "Node-local DNS caching enabled policy",
    "enableInboundForwarding": False,
    "enableLogging": False,
    "id": "<your_policy_id>", # Replace with a unique ID for the policy
    "kind": "dns#policy",
    "name": "node-local-dns-caching-policy",
    "networks": [
      {
        "kind": "dns#policyNetwork",
        "networkUrl": "https://www.googleapis.com/compute/v1/projects/<your_project_id>/global/networks/default"
      }
    ],
    "rules": [
      {
        "action": "allow",
        "description": "Allow all DNS queries",
        "kind": "dns#policyRule",
        "match": {
          "kind": "dns#policyRuleCriteriaMatch",
          "queryNamePattern": ".*"
        }
      }
    ],
    "targetNameServers": [
      {
        "forwardingPath": "default",
        "ipv4Address": "8.8.8.8",
        "kind": "dns#policyAlternativeNameServerConfigTargetNameServer",
        "networkUrl": "https://www.googleapis.com/compute/v1/projects/<your_project_id>/global/networks/default"
      }
    ],
    "visibility": "private"
}

policy = dns_service.policies().create(project=project_id, body=policy_body).execute()
```

Step 5: Assign the newly created DNS policy to the cluster.

```
from googleapiclient.errors import HttpError

cluster_name = '<your_cluster_name>' # Replace with the name of your GKE cluster
zone = '<your_zone>' # Replace with the zone in which your GKE cluster is located

try:
    cluster = container_service.projects().zones().clusters().get(project=project_id, zone=zone, clusterId=cluster_name).execute()
    cluster['nodeConfig']['dnsPolicy'] = 'Policy'
    cluster['nodeConfig']['dnsConfig']['nameServerConfig']['networks'] = [
        {
          "kind": "dns#policyNetwork",
          "policy": policy['id']
        }
    ]
    update_cluster = container_service.projects().zones().clusters().update(project=project_id, zone=zone, clusterId=cluster_name, body=cluster).execute()
    print(f"DNS policy with node-local caching enabled has been successfully assigned to the cluster: {cluster_name}")
except HttpError as e:
    print(f"An error occurred while assigning DNS policy to the cluster: {cluster_name}. Error message: {e}")
```

With these steps, the misconfiguration "Cluster Should Use Node Local DNS Cache" has been remediated for GCP using Python.


</Tab>
</Tabs>