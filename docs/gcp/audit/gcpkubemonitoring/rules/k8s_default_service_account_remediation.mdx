

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. You can do this by clicking on the hamburger menu on the top left corner, then select "Kubernetes Engine".

3. In the Kubernetes Engine section, you will see a list of all your Kubernetes clusters. Click on the name of the cluster you want to inspect.

4. In the cluster details page, navigate to the "Workloads" tab. Here, you will see a list of all the workloads running on your cluster. Click on the name of the workload you want to inspect.

5. In the workload details page, navigate to the "Details" tab. Here, you will see the service account used by the workload. If the service account is the default service account, then it is a misconfiguration. The default service account is usually named "default".

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After downloading, you can install it by following the instructions provided. Once installed, you can initialize the SDK by running the command `gcloud init` and follow the prompts to authorize the SDK to use your Google account.

2. Get the list of clusters: Use the following command to get the list of all the clusters in the current project.
   ```
   gcloud container clusters list
   ```
   This command will return a list of all the clusters along with their details.

3. Get the details of each cluster: For each cluster, you can get the details by using the following command.
   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone [CLUSTER_ZONE]
   ```
   Replace `[CLUSTER_NAME]` with the name of your cluster and `[CLUSTER_ZONE]` with the zone of your cluster. This command will return the details of the specified cluster.

4. Check the service account: In the output of the above command, look for the `serviceAccount` field under `nodeConfig`. If the `serviceAccount` field is set to `default`, then the default service account is being used.

#### Using Python

1. Import the necessary libraries: You will need the Kubernetes Python client to interact with the Kubernetes API. You can install it using pip:

```python
pip install kubernetes
```

2. Connect to the Kubernetes API: Use the `config.load_kube_config()` function to load your kubeconfig file and connect to the Kubernetes API.

```python
from kubernetes import client, config

config.load_kube_config()
v1 = client.CoreV1Api()
```

3. List all service accounts: Use the `list_service_account_for_all_namespaces()` function to get a list of all service accounts in all namespaces.

```python
service_accounts = v1.list_service_account_for_all_namespaces().items
```

4. Check for default service accounts: Iterate over the list of service accounts and check if any of them are the default service account. If they are, print a warning message.

```python
for sa in service_accounts:
    if sa.metadata.name == 'default':
        print(f"Warning: Default service account used in namespace {sa.metadata.namespace}")
```

This script will print a warning for each namespace where the default service account is used. This can be a sign of a misconfiguration, as using the default service account can grant more permissions than necessary, violating the principle of least privilege.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Default Service Accounts Should Not Be Used" in GCP using GCP console, please follow these steps:

1. Open the GCP Console and navigate to the "IAM & Admin" section.

2. Click on "Service Accounts" in the left-hand menu.

3. Identify the default service accounts that are being used in your project. The default service accounts are "App Engine default service account" and "Compute Engine default service account".

4. Click on the default service account you want to remediate.

5. Click on the "Edit" button at the top of the page.

6. Scroll down to the "Roles" section and remove any unnecessary roles that have been assigned to the default service account.

7. Click on "Save" to apply the changes.

8. Repeat steps 4-7 for all default service accounts being used in your project.

9. Create new service accounts with the appropriate roles and permissions for your project.

10. Update your applications and services to use the new service accounts instead of the default service accounts.

By following these steps, you will have successfully remediated the misconfiguration "Default Service Accounts Should Not Be Used" in GCP using GCP console.

#### Using CLI

To remediate the "Default Service Accounts Should Not Be Used" misconfiguration for GCP using GCP CLI, follow these steps:

1. Open the GCP Cloud Shell.
2. Run the following command to list all the default service accounts in your GCP project:

   ```
   gcloud iam service-accounts list
   ```

3. Identify the default service account that you want to disable.
4. Run the following command to disable the default service account:

   ```
   gcloud iam service-accounts disable [SERVICE_ACCOUNT_EMAIL]
   ```

   Replace `[SERVICE_ACCOUNT_EMAIL]` with the email address of the default service account that you want to disable.

5. Verify that the default service account has been disabled by running the following command:

   ```
   gcloud iam service-accounts describe [SERVICE_ACCOUNT_EMAIL]
   ```

   Replace `[SERVICE_ACCOUNT_EMAIL]` with the email address of the default service account that you disabled. The output should show that the account is disabled.

6. Repeat steps 4-5 for any other default service accounts that you want to disable.

By following these steps, you have successfully remediated the "Default Service Accounts Should Not Be Used" misconfiguration for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Default Service Accounts Should Not Be Used" in GCP using Python, you can follow these steps:

1. Identify the default service accounts that are currently being used in your GCP project. You can do this by running the following command in the Cloud Shell or in your local terminal with gcloud CLI installed:

```
gcloud iam service-accounts list
```

2. Create a new service account to replace the default service account. You can do this by running the following command:

```
gcloud iam service-accounts create [SA-NAME] --description="[SA-DESCRIPTION]"
```

Replace [SA-NAME] and [SA-DESCRIPTION] with your desired service account name and description.

3. Grant the necessary roles and permissions to the new service account. You can do this by running the following command:

```
gcloud projects add-iam-policy-binding [PROJECT-ID] --member="serviceAccount:[SA-EMAIL]" --role="[ROLE]"
```

Replace [PROJECT-ID], [SA-EMAIL], and [ROLE] with your project ID, new service account email, and the desired role to grant to the service account.

4. Update your application or service to use the new service account instead of the default service account. You can do this by setting the GOOGLE_APPLICATION_CREDENTIALS environment variable to the path of the new service account key file.

```
export GOOGLE_APPLICATION_CREDENTIALS="[PATH]"
```

Replace [PATH] with the path to the new service account key file.

5. Disable the default service account to prevent it from being used. You can do this by running the following command:

```
gcloud iam service-accounts disable [SA-EMAIL]
```

Replace [SA-EMAIL] with the email of the default service account.

By following these steps, you can remediate the misconfiguration "Default Service Accounts Should Not Be Used" in GCP using Python.


</Tab>
</Tabs>