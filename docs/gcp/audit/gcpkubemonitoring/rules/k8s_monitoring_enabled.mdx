---
slug: k8s_monitoring_enabled
title: Monitoring Should Be Enabled
sidebar_label: Monitoring Should Be Enabled
---

### More Info:

Ensures all Kubernetes clusters have monitoring enabled.

### Risk Level

Medium

### Address

Security, Operational maturity

### Compliance Standards

HITRUST, SOC2, NISTCSF



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your preferred web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access GCP resources.

2. Navigate to Kubernetes Engine: From the main dashboard of the Google Cloud Console, click on the hamburger menu (three horizontal lines) located at the top left corner of the page. From the drop-down menu, select "Kubernetes Engine" to access the Kubernetes clusters.

3. Select the Cluster: In the Kubernetes Engine page, you will see a list of all your Kubernetes clusters. Click on the name of the cluster you want to check for monitoring.

4. Check Monitoring Status: In the cluster details page, scroll down to the "Monitoring and Logging" section. Here, you can see whether monitoring is enabled or not. If it is enabled, it will show "Monitoring with Cloud Monitoring". If it is not enabled, it will show "No monitoring".

#### Using CLI

1. Install and configure Google Cloud SDK on your local machine. This will allow you to interact with your GCP resources using the command line interface. You can download it from the official Google Cloud website and install it following the instructions provided.

2. Once the SDK is installed, authenticate your account using the following command:
   ```
   gcloud auth login
   ```
   This will open a new window in your web browser asking you to log in with your Google account. Once you've logged in, you'll be able to interact with your GCP resources.

3. Set your project ID to the project you want to check. You can do this using the following command:
   ```
   gcloud config set project [PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with the ID of your project.

4. Now, you can check if monitoring is enabled in your Kubernetes clusters using the following command:
   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone [ZONE] | grep monitoringService
   ```
   Replace `[CLUSTER_NAME]` with the name of your cluster and `[ZONE]` with the zone your cluster is located in. This command will return the monitoring service used by your cluster. If it returns `monitoring.googleapis.com/kubernetes`, then monitoring is enabled. If it returns `none` or doesn't return anything, then monitoring is not enabled.

#### Using Python

Monitoring is a crucial aspect of maintaining the health, performance, and security of Kubernetes clusters. Here's how you can check if monitoring is enabled in Kubernetes using Python scripts:

1. **Use Kubernetes Python Client:**
   The Kubernetes Python client can be used to interact with the Kubernetes API. You can use it to fetch the details of the deployed services. Install it using pip:
   ```
   pip install kubernetes
   ```
   Then, use the following script to list all services:
   ```python
   from kubernetes import client, config

   config.load_kube_config()

   v1 = client.CoreV1Api()
   print("Listing services with their info:")
   ret = v1.list_service_for_all_namespaces(watch=False)
   for i in ret.items:
       print("%s\t%s\t%s\t%s" % (i.status.load_balancer.ingress, i.metadata.namespace, i.metadata.name, i.spec.ports))
   ```
   This script will list all the services running in all namespaces along with their details.

2. **Check for Monitoring Services:**
   In the list of services, look for monitoring services like Prometheus, Grafana, etc. If these services are running, it means monitoring is enabled. You can modify the above script to specifically look for these services:
   ```python
   from kubernetes import client, config

   config.load_kube_config()

   v1 = client.CoreV1Api()
   print("Listing services with their info:")
   ret = v1.list_service_for_all_namespaces(watch=False)
   for i in ret.items:
       if 'prometheus' in i.metadata.name or 'grafana' in i.metadata.name:
           print("%s\t%s\t%s\t%s" % (i.status.load_balancer.ingress, i.metadata.namespace, i.metadata.name, i.spec.ports))
   ```
   This script will list all the Prometheus and Grafana services running in all namespaces.

3. **Check for Monitoring Pods:**
   Similarly, you can check for monitoring pods. Modify the script to list all pods and look for monitoring pods:
   ```python
   from kubernetes import client, config

   config.load_kube_config()

   v1 = client.CoreV1Api()
   print("Listing pods with their info:")
   ret = v1.list_pod_for_all_namespaces(watch=False)
   for i in ret.items:
       if 'prometheus' in i.metadata.name or 'grafana' in i.metadata.name:
           print("%s\t%s\t%s" % (i.status.pod_ip, i.metadata.namespace, i.metadata.name))
   ```
   This script will list all the Prometheus and Grafana pods running in all namespaces.

4. **Check for Monitoring Configurations:**
   You can also check for the presence of monitoring configurations like alert rules, service monitors, etc. This can be done by listing all the ConfigMaps and looking for monitoring configurations. Modify the script to list all ConfigMaps:
   ```python
   from kubernetes import client, config

   config.load_kube_config()

   v1 = client.CoreV1Api()
   print("Listing ConfigMaps with their info:")
   ret = v1.list_config_map_for_all_namespaces(watch=False)
   for i in ret.items:
       if 'prometheus' in i.metadata.name or 'grafana' in i.metadata.name:
           print("%s\t%s\t%s" % (i.data, i.metadata.namespace, i.metadata.name))
   ```
   This script will list all the ConfigMaps related to Prometheus and Grafana in all namespaces.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Monitoring Should Be Enabled" in GCP using GCP console, follow these steps:

1. Open the GCP console and navigate to the project where monitoring needs to be enabled.

2. Click on the "Navigation menu" icon in the top-left corner of the console and select "Monitoring" from the "Operations" section.

3. If you see a message that says "You don't have any monitoring data yet," click on the "Get started" button.

4. If you see a message that says "You don't have any monitoring resources yet," click on the "Add chart" button.

5. In the "Create chart" dialog box that appears, select the resource type that you want to monitor.

6. Select the metric that you want to monitor and configure the chart as per your requirement.

7. Once you have configured the chart, click on the "Save" button.

8. Repeat steps 5-7 for all the resources that you want to monitor.

9. Once you have configured monitoring for all the resources, you should see monitoring data in the GCP console.

By following these steps, you can remediate the misconfiguration "Monitoring Should Be Enabled" in GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Monitoring Should Be Enabled" for GCP using GCP CLI, follow the below steps:

1. Open the Google Cloud Console and select your project.

2. Open the Cloud Shell by clicking on the icon on the top right corner of the console.

3. Run the following command to enable monitoring for all resources in your project:

   ```
   gcloud services enable monitoring.googleapis.com
   ```

4. Once the monitoring service is enabled, you can create a monitoring dashboard to view the metrics and logs of your resources. Run the following command to create a new dashboard:

   ```
   gcloud monitoring dashboards create --config-from-file=mydashboard.json
   ```

   Note: Replace "mydashboard.json" with the name of your JSON file containing the dashboard configuration.

5. Open the newly created dashboard in the Cloud Console and customize it to fit your monitoring needs.

6. Finally, set up alerts for your resources to be notified of any issues. You can do this by creating an alerting policy in the Cloud Console or by using the GCP CLI. Here is an example command to create an alerting policy:

   ```
   gcloud alpha monitoring policies create --policy-from-file=policy.yaml
   ```

   Note: Replace "policy.yaml" with the name of your YAML file containing the alerting policy configuration.

By following these steps, you can remediate the misconfiguration "Monitoring Should Be Enabled" for GCP using GCP CLI.

#### Using Python

To remediate the "monitoring should be enabled" misconfiguration in GCP using Python, you can use the following steps:

1. Import the required libraries:

```python
from google.cloud import monitoring_v3
from google.oauth2 import service_account
```

2. Set up authentication using a service account:

```python
credentials = service_account.Credentials.from_service_account_file('<PATH_TO_SERVICE_ACCOUNT_KEY_FILE>')
client = monitoring_v3.MetricServiceClient(credentials=credentials)
```

3. Define the project ID and the resource type:

```python
project_id = '<YOUR_PROJECT_ID>'
resource_type = 'gce_instance'
```

4. Define the monitoring configuration for the resource:

```python
resource_name = f'projects/{project_id}/instances/{instance_id}'
monitoring_config = monitoring_v3.types.MonitoringConfig(
    metrics=[
        monitoring_v3.types.MetricDescriptor(
            type_='compute.googleapis.com/instance/cpu/utilization',
            labels=[
                monitoring_v3.types.LabelDescriptor(
                    key='instance_name',
                    value_type=monitoring_v3.enums.LabelDescriptor.ValueType.STRING
                )
            ]
        )
    ]
)
```

5. Enable monitoring for the resource:

```python
client.update_monitored_resource(
    request={
        'name': resource_name,
        'resource': {
            'type': resource_type,
            'labels': {
                'instance_id': instance_id,
                'zone': zone
            }
        },
        'monitoring_config': monitoring_config
    }
)
```

Make sure to replace `<PATH_TO_SERVICE_ACCOUNT_KEY_FILE>` with the actual path to your service account key file, `<YOUR_PROJECT_ID>` with your GCP project ID, `instance_id` with the ID of the instance you want to enable monitoring for, and `zone` with the zone of the instance.


### Additional Reading:

- [https://cloud.google.com/monitoring/kubernetes-engine/](https://cloud.google.com/monitoring/kubernetes-engine/) 


</Tab>
</Tabs>