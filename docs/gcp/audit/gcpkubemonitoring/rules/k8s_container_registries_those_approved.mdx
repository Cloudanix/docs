---
slug: k8s_container_registries_those_approved
title: Minimize Container Registries To Only Approved Ones
sidebar_label: Minimize Container Registries To Only Approved Ones
---

### More Info:

Use Binary Authorization to allowlist (whitelist) only approved container registries

### Risk Level

Medium

### Address

Security, Operational Excellence, Best Practice

### Compliance Standards

CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. Here, you will find a list of all your Kubernetes clusters.

3. Select the cluster you want to inspect and click on it to view its details.

4. In the cluster details page, navigate to the "Workloads" tab. Here, you can see all the running pods and their respective images. Check the image registries of these pods. If there are any registries that are not approved, it indicates a misconfiguration.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK. You can download it from the official Google Cloud website. After downloading, install it and authenticate it with your Google Cloud account using the command `gcloud auth login`.

2. Get the list of all the clusters: Use the following command to get the list of all the clusters in your GCP account.

    ```
    gcloud container clusters list
    ```

3. Get the details of each cluster: For each cluster, you can get the detailed configuration using the following command. Replace `[CLUSTER_NAME]` with the name of your cluster.

    ```
    gcloud container clusters describe [CLUSTER_NAME]
    ```

4. Check the image policy: In the output of the above command, look for the `imagePolicyConfig` field. If it is not present or if it allows all registries, then the cluster is misconfigured. The `imagePolicyConfig` should only allow approved registries.

#### Using Python

1. Import the necessary libraries: You will need the Kubernetes Python client to interact with the Kubernetes API. You can install it using pip:

```python
pip install kubernetes
```

2. Connect to the Kubernetes API: Use the `config.load_kube_config()` function to load your kubeconfig file and connect to the Kubernetes API.

```python
from kubernetes import client, config

config.load_kube_config()
```

3. Get a list of all pods: Use the `list_pod_for_all_namespaces()` function to get a list of all pods in all namespaces.

```python
v1 = client.CoreV1Api()
pods = v1.list_pod_for_all_namespaces().items
```

4. Check the image registries: For each pod, check the image registry of each container. If the registry is not in the list of approved registries, print a warning.

```python
approved_registries = ['approved-registry.com']

for pod in pods:
    for container in pod.spec.containers:
        image_registry = container.image.split('/')[0]
        if image_registry not in approved_registries:
            print(f'Warning: Pod {pod.metadata.name} in namespace {pod.metadata.namespace} is using an unapproved image registry: {image_registry}')
```

This script will print a warning for each pod that is using an image from an unapproved registry. You can modify the list of approved registries to fit your organization's needs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Minimize Container Registries To Only Approved Ones" for GCP using GCP console, please follow the below steps:

1. Login to the GCP console (https://console.cloud.google.com/).
2. Navigate to the Container Registry page by clicking on "Navigation menu > Container Registry".
3. Click on the Registry that you want to modify.
4. Click on the "Permissions" tab.
5. Click on the "Add Member" button.
6. In the "New members" field, enter the email address of the user or group that you want to grant permissions to.
7. In the "Select a role" field, choose the appropriate role that you want to grant to the user or group. For example, you can choose "Storage Object Viewer" to allow users to view the images in the registry.
8. Click on the "Add" button to add the user or group to the registry with the selected role.

Repeat steps 5-8 for all the users or groups that need access to the registry. By doing this, you are minimizing the container registries to only approved ones.

#### Using CLI

To remediate the misconfiguration "Minimize Container Registries To Only Approved Ones" in GCP using GCP CLI, you can follow the below steps:

1. Open the terminal and authenticate into your GCP account using the following command:
   
   ```
   gcloud auth login
   ```
   
2. Once you are authenticated, set the project where the container registry is located using the following command:

   ```
   gcloud config set project [PROJECT_ID]
   ```

3. Now, list all the container registries in the project using the following command:

   ```
   gcloud container images list
   ```

4. Identify the container registries that are not approved and need to be minimized.

5. Delete the unwanted container registry using the following command:

   ```
   gcloud container images delete [IMAGE_NAME] --force-delete-tags --quiet
   ```

   Replace `[IMAGE_NAME]` with the name of the container image that you want to delete.

6. Repeat the above step for all the unwanted container registries.

7. Once you have deleted all the unwanted container registries, verify that only approved container registries are present using the following command:

   ```
   gcloud container images list
   ```

   This will list all the container registries present in the project.

By following the above steps, you can remediate the misconfiguration "Minimize Container Registries To Only Approved Ones" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Minimize Container Registries To Only Approved Ones" in GCP using Python, you can follow the below steps:

1. First, you need to get the list of all the container registries in your GCP project using the Google Cloud SDK and Python. You can use the following command to get the list of container registries:

```
gcloud container images list
```

2. Next, you need to create a list of approved container registries that are allowed in your GCP project.

3. Then, you can loop through the list of container registries and check if each registry is in the approved list or not. If it is not in the approved list, then you can delete that container registry using the following command:

```
gcloud container images delete [IMAGE_NAME] --force-delete-tags
```

4. You can write a Python script to automate this process. Here is an example script:

```
import subprocess

# List of approved container registries
approved_registries = ['gcr.io/my-project']

# Get the list of all container registries
registries = subprocess.check_output(['gcloud', 'container', 'images', 'list']).splitlines()

# Loop through the list of container registries
for registry in registries:
    # Check if the registry is in the approved list
    if registry not in approved_registries:
        # Delete the container registry
        subprocess.call(['gcloud', 'container', 'images', 'delete', registry, '--force-delete-tags'])
```

5. You can run this script periodically to ensure that only approved container registries are present in your GCP project.


### Additional Reading:

- [https://cloud.google.com/binary-authorization/docs/policy-yaml-reference](https://cloud.google.com/binary-authorization/docs/policy-yaml-reference) 


</Tab>
</Tabs>