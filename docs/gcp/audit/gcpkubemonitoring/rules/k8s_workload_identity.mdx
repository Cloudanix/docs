---
slug: k8s_workload_identity
title: Workload Identity Should Be Enabled
sidebar_label: Workload Identity Should Be Enabled
---

### More Info:

GKE cluster should have Workload Identity enabled

### Risk Level

Critical

### Address

Security, Reliability, Best Practice

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your preferred web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access GCP resources.

2. Navigate to Kubernetes Engine: From the main dashboard of the Google Cloud Console, click on the hamburger menu (three horizontal lines) located at the top left corner of the page. From the drop-down menu, navigate to "Kubernetes Engine" under the "Compute" section.

3. Select the Cluster: In the Kubernetes Engine page, you will see a list of all your Kubernetes clusters. Click on the name of the cluster you want to check for Workload Identity configuration.

4. Check Workload Identity Configuration: In the cluster details page, scroll down to the "Security" section. Here, you will find the "Workload Identity" option. If it is enabled, it will show "Enabled". If it is not enabled, it will show "Disabled". This will help you detect if Workload Identity is enabled or not in your Kubernetes cluster.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Once the SDK is installed, authenticate your account by running the following command in your terminal:
   ```
   gcloud auth login
   ```
   Follow the prompts to log in with your Google account.

3. Set your project ID to the project you want to check. Replace `YOUR_PROJECT_ID` with your actual project ID.
   ```
   gcloud config set project YOUR_PROJECT_ID
   ```

4. Now, you can check if Workload Identity is enabled in your Kubernetes clusters. Run the following command, replacing `CLUSTER_NAME` and `ZONE` with your actual cluster name and zone:
   ```
   gcloud container clusters describe CLUSTER_NAME --zone=ZONE --format='value(workloadIdentityConfig.workloadPool)'
   ```
   If the output is your project ID, then Workload Identity is enabled. If the output is empty, then Workload Identity is not enabled.

#### Using Python

To check if Workload Identity is enabled in Kubernetes using Python scripts, you can follow these steps:

1. **Install Google Cloud SDK and Python Client for Google Cloud**: Before you start, make sure you have installed the Google Cloud SDK and the Python client for Google Cloud. You can install the SDK by following the instructions here: https://cloud.google.com/sdk/docs/install and the Python client using pip: `pip install google-cloud`.

2. **Authenticate and Set Project**: Authenticate your SDK using the command `gcloud auth login` and set your project using `gcloud config set project PROJECT_ID`.

3. **Python Script to Check Workload Identity**: Use the Python client for Google Cloud to interact with the Kubernetes API and check if Workload Identity is enabled. Here is a sample script:

```python
from google.cloud import container_v1

def check_workload_identity(project_id, zone, cluster_id):
    client = container_v1.ClusterManagerClient()

    # Get the cluster
    cluster = client.get_cluster(project_id, zone, cluster_id)

    # Check if Workload Identity is enabled
    if cluster.workload_identity_config:
        if cluster.workload_identity_config.identity_namespace:
            print("Workload Identity is enabled.")
        else:
            print("Workload Identity is not enabled.")
    else:
        print("Workload Identity is not enabled.")

# Replace with your project id, zone and cluster id
check_workload_identity('my-project-id', 'us-central1-a', 'my-cluster-id')
```

4. **Run the Python Script**: Run the Python script using the command `python script_name.py`. If Workload Identity is enabled, it will print "Workload Identity is enabled." Otherwise, it will print "Workload Identity is not enabled."

Remember to replace 'my-project-id', 'us-central1-a', and 'my-cluster-id' with your actual project ID, zone, and cluster ID.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Workload Identity Should Be Enabled" for GCP using GCP console, please follow the below steps:

1. Open the GCP console and select the project for which you want to enable the Workload Identity.

2. Go to the "IAM & Admin" section from the left-hand side menu.

3. Click on "Service Accounts" from the IAM menu.

4. Select the service account for which you want to enable Workload Identity.

5. Click on "Edit" from the top menu bar.

6. Scroll down to the "Identity and API access" section.

7. Click on the "Enable Workload Identity" checkbox.

8. Click on "Save" to enable the Workload Identity for the selected service account.

9. Repeat the above steps for all the service accounts in your GCP project.

Enabling Workload Identity for all the service accounts in your GCP project ensures that your applications running on GCP can securely access other Google Cloud services without the need for managing and storing service account keys.

#### Using CLI

To remediate the misconfiguration "Workload Identity Should Be Enabled" in GCP using GCP CLI, follow the below steps:

1. Open the Cloud Shell in GCP console.
2. Run the following command to enable the Workload Identity API:

```
gcloud services enable iamcredentials.googleapis.com
```

3. Create a Kubernetes service account:

```
gcloud iam service-accounts create [SA-NAME] --description "[SA-DESCRIPTION]" --display-name "[SA-DISPLAY-NAME]"
```

Replace the [SA-NAME], [SA-DESCRIPTION], and [SA-DISPLAY-NAME] with the desired values.

4. Bind the Kubernetes service account to the GCP service account:

```
gcloud iam service-accounts add-iam-policy-binding [SA-NAME] --member "serviceAccount:[PROJECT-ID].svc.id.goog[namespace/[NAMESPACE]/sa/[SA-NAME]]" --role "roles/iam.workloadIdentityUser"
```

Replace the [SA-NAME], [PROJECT-ID], and [NAMESPACE] with the desired values.

5. Annotate the Kubernetes service account to use the GCP service account:

```
kubectl annotate serviceaccount --namespace [NAMESPACE] [SA-NAME] iam.gke.io/gcp-service-account=[SA-NAME]@[PROJECT-ID].iam.gserviceaccount.com
```

Replace the [NAMESPACE], [SA-NAME], and [PROJECT-ID] with the desired values.

6. Verify that the workload identity is enabled by running the following command:

```
kubectl run --rm -i --tty workload-identity-test --image google/cloud-sdk --restart Never -- /bin/bash
```

7. Run the following command to authenticate using the Kubernetes service account:

```
gcloud auth activate-service-account --key-file=/var/run/secrets/kubernetes.io/serviceaccount/token
```

8. Run the following command to verify that the authentication was successful:

```
gcloud auth list
```

If the authentication was successful, you should see the Kubernetes service account listed.

These steps should remediate the misconfiguration "Workload Identity Should Be Enabled" for GCP using GCP CLI.

#### Using Python

To remediate the "Workload Identity Should Be Enabled" misconfiguration in GCP using Python, follow these steps:

1. Install the necessary libraries: 

   ```
   pip install google-auth google-auth-httplib2 google-auth-oauthlib google-cloud-storage
   ```

2. Set up an authentication method for your GCP account. You can either use a service account or your own user credentials. 

3. Create a Python script that will enable Workload Identity for your GCP project. Here's an example script that you can modify according to your needs:

   ```
   from google.oauth2 import service_account
   from googleapiclient.discovery import build

   # Set up authentication
   credentials = service_account.Credentials.from_service_account_file(
       'path/to/service_account.json')

   # Set up the Cloud IAM API client
   service = build('iam', 'v1', credentials=credentials)

   # Set up the request body
   body = {
       'projectId': 'your-project-id',
       'enabled': True
   }

   # Send the request to enable Workload Identity
   response = service.projects().setWorkloadIdentityPoolConfig(
       name='projects/your-project-id',
       body=body
   ).execute()

   # Print the response
   print(response)
   ```

4. Replace `'path/to/service_account.json'` with the path to your service account file. 

5. Replace `'your-project-id'` with the ID of the GCP project that you want to enable Workload Identity for. 

6. Save the Python script and run it using the command `python script_name.py`. 

7. Verify that Workload Identity has been enabled for your GCP project by checking the Cloud IAM page in the GCP console.




</Tab>
</Tabs>