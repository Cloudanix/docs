---
slug: k8s_sandbox_running_untrusted
title: Consider GKE Sandbox For Running Untrusted Workloads
sidebar_label: Consider GKE Sandbox For Running Untrusted Workloads
---

### More Info:

Use GKE Sandbox to restrict untrusted workloads as an additional layer of protection when running in a multi-tenant environment.

### Risk Level

High

### Address

Security, Reliability, Operational Excellence, Performance Efficiency

### Compliance Standards

CISGKE



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. Here, you will find a list of all your Kubernetes clusters.

3. Click on the specific cluster you want to inspect. This will open the cluster's details page.

4. Look for the "GKE Sandbox" option in the details page. If it's enabled, it means that the GKE Sandbox is being used for running untrusted workloads. If it's not enabled, it means that the GKE Sandbox is not being used for running untrusted workloads.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, authenticate your Google Cloud account by running the following command in your terminal:

   ```
   gcloud auth login
   ```

2. After successful authentication, you need to list all the clusters in your GCP project. Run the following command to do so:

   ```
   gcloud container clusters list
   ```

3. Now, for each cluster, you need to check if the GKE Sandbox is enabled or not. You can do this by describing the cluster and checking the 'gkeSandboxEnabled' field. Run the following command to describe a cluster:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone=[ZONE]
   ```

   Replace '[CLUSTER_NAME]' with the name of your cluster and '[ZONE]' with the zone of your cluster.

4. In the output of the above command, look for the 'gkeSandboxEnabled' field. If it is set to 'true', then the GKE Sandbox is enabled for running untrusted workloads. If it is 'false' or not present, then the GKE Sandbox is not enabled.

Please note that the GKE Sandbox is a feature of GKE's Node Configurations and it might not be available in all regions and zones.

#### Using Python

To check if GKE Sandbox is enabled for running untrusted workloads in Kubernetes, you can use the Google Cloud SDK (gcloud) or the Kubernetes Python client. Here are the steps:

1. **Install the necessary libraries and SDKs:**
   You need to install the Google Cloud SDK and the Kubernetes Python client. You can install them using pip:

   ```python
   pip install --upgrade google-cloud-sdk
   pip install kubernetes
   ```

2. **Authenticate with Google Cloud:**
   Before you can interact with your GCP resources, you need to authenticate. You can do this using the `gcloud auth login` command, which will open a new browser window for you to log in.

3. **List the clusters:**
   You can list all the clusters in your project using the `gcloud container clusters list` command. You can also do this using the Kubernetes Python client:

   ```python
   from kubernetes import client, config

   # Load the kube config from the file
   config.load_kube_config()

   v1 = client.CoreV1Api()
   print("Listing clusters with their info:")
   for cluster in v1.list_cluster().items:
       print(cluster.metadata.name)
   ```

4. **Check if GKE Sandbox is enabled:**
   You can check if GKE Sandbox is enabled for each cluster by checking the `gke.gcr.io/gvisor` annotation. If this annotation is present and set to `true`, then GKE Sandbox is enabled. Here's how you can do this using the Kubernetes Python client:

   ```python
   from kubernetes import client, config

   # Load the kube config from the file
   config.load_kube_config()

   v1 = client.CoreV1Api()
   print("Listing clusters with their info:")
   for cluster in v1.list_cluster().items:
       if 'gke.gcr.io/gvisor' in cluster.metadata.annotations:
           print(f"GKE Sandbox is enabled for cluster {cluster.metadata.name}")
       else:
           print(f"GKE Sandbox is not enabled for cluster {cluster.metadata.name}")
   ```

Please note that the above scripts are just examples and might need to be adjusted based on your specific environment and requirements.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Consider GKE Sandbox For Running Untrusted Workloads" for GCP using the GCP console, you can follow these steps:

1. Open the Google Cloud Console and navigate to the GKE cluster that you want to remediate.

2. Click on the "Workloads" tab and select the workload that you want to run in the GKE Sandbox.

3. Click on the "Edit" button to open the workload configuration.

4. In the "Security" section of the configuration, enable the "Sandbox" option.

5. Click on the "Save" button to apply the changes.

6. Verify that the workload is now running in the GKE Sandbox by checking the "Status" column in the "Workloads" tab. The status should be "Running" with a green checkmark.

7. Repeat steps 2-6 for any other workloads that need to be remediated.

By enabling the GKE Sandbox for running untrusted workloads, you are providing an additional layer of security to your GKE cluster by running potentially malicious workloads in a secure, isolated environment.

#### Using CLI

The misconfiguration of using GKE Sandbox for running untrusted workloads can be remediated in GCP using the following steps through GCP CLI:

1. Firstly, check if there are any workloads running on GKE Sandbox that are untrusted. This can be done by running the following command in GCP CLI:

   ```
   gcloud alpha container node-pools describe [NODE_POOL_NAME] --cluster=[CLUSTER_NAME] --zone=[ZONE]
   ```

   Replace `[NODE_POOL_NAME]`, `[CLUSTER_NAME]` and `[ZONE]` with the corresponding values for your GKE Sandbox.

2. If there are any workloads running on GKE Sandbox that are untrusted, create a new node pool with the appropriate security settings. This can be done by running the following command in GCP CLI:

   ```
   gcloud beta container node-pools create [NEW_NODE_POOL_NAME] --cluster=[CLUSTER_NAME] --zone=[ZONE] --sandbox=unconfined
   ```

   Replace `[NEW_NODE_POOL_NAME]`, `[CLUSTER_NAME]` and `[ZONE]` with the corresponding values for your GKE Sandbox. The `--sandbox=unconfined` flag will create a new node pool with unrestricted sandboxing, which is suitable for running untrusted workloads.

3. Migrate the workloads from the old node pool to the new node pool. This can be done by running the following command in GCP CLI:

   ```
   kubectl drain [NODE_NAME] --ignore-daemonsets --delete-local-data
   ```

   Replace `[NODE_NAME]` with the name of the node that is running the untrusted workload. This command will safely evict all the pods running on the node.

4. Delete the old node pool. This can be done by running the following command in GCP CLI:

   ```
   gcloud beta container node-pools delete [NODE_POOL_NAME] --cluster=[CLUSTER_NAME] --zone=[ZONE]
   ```

   Replace `[NODE_POOL_NAME]`, `[CLUSTER_NAME]` and `[ZONE]` with the corresponding values for your GKE Sandbox.

By following these steps, you can remediate the misconfiguration of using GKE Sandbox for running untrusted workloads in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Consider GKE Sandbox For Running Untrusted Workloads" for GCP using Python, follow the below steps:

1. Install the necessary libraries:
   
   ```
   pip install google-auth google-auth-oauthlib google-auth-httplib2 google-cloud-container
   ```

2. Set the project ID and cluster name for which you want to enable GKE Sandbox. 

   ```
   project_id = "your-project-id"
   cluster_name = "your-cluster-name"
   ```

3. Authenticate using your Google Cloud credentials:

   ```
   from google.oauth2 import service_account
   
   credentials = service_account.Credentials.from_service_account_file('path/to/your/credentials.json')
   ```

4. Enable GKE Sandbox for the cluster:

   ```
   from google.cloud import container_v1
   
   client = container_v1.ClusterManagerClient(credentials=credentials)
   
   cluster = client.get_cluster(project_id, "us-central1", cluster_name)
   
   if not cluster.sandbox_config:
       sandbox_config = container_v1.SandboxConfig(pod_sandbox_spec=container_v1.PodSandboxConfig())
       cluster.sandbox_config = sandbox_config
       update_request = container_v1.UpdateClusterRequest(cluster=cluster, update_mask={"paths": ["sandbox_config"]})
       operation = client.update_cluster(update_request)
       operation.result()
   ```

5. Verify that GKE Sandbox is enabled:

   ```
   cluster = client.get_cluster(project_id, "us-central1", cluster_name)
   
   if cluster.sandbox_config:
       print("GKE Sandbox is enabled for the cluster.")
   else:
       print("GKE Sandbox is not enabled for the cluster.")
   ```

By following these steps, you can remediate the misconfiguration "Consider GKE Sandbox For Running Untrusted Workloads" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods](https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods) 


</Tab>
</Tabs>