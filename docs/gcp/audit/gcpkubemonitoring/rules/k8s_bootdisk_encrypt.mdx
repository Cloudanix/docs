---
slug: k8s_bootdisk_encrypt
title: Kubernetes Boot Disk Should Be Encrypted With Customer Managed Keys
sidebar_label: Kubernetes Boot Disk Should Be Encrypted With Customer Managed Keys
---

### More Info:

Ensure that boot disk on k8 node pools are encrypted with CMK

### Risk Level

High

### Address

Security

### Compliance Standards

ISO27001



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your preferred web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access and manage your GCP resources.

2. Navigate to Kubernetes Engine: From the main dashboard of the Google Cloud Platform Console, click on the hamburger menu (three horizontal lines) located at the top left corner of the console. Scroll down and click on "Kubernetes Engine" under the "Compute" section.

3. Select the Kubernetes Cluster: In the Kubernetes Engine page, you will see a list of all your Kubernetes clusters. Click on the name of the cluster you want to inspect.

4. Check Boot Disk Encryption: In the cluster details page, scroll down to the "Node Pools" section. Click on the name of the node pool to expand its details. Look for the "Boot disk encryption" field. If it's set to "Google-managed key", then the boot disk is not encrypted with a customer-managed key. If it's set to a specific key, then the boot disk is encrypted with that customer-managed key.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Once the SDK is installed and configured, you can list all the disks in your project by running the following command in your terminal:

   ```
   gcloud compute disks list --format="table(name,zone,sourceImage)"
   ```

   This command will return a table with the names of all disks, their zones, and the source images they were created from.

3. To check if a specific disk is encrypted with a customer-managed key, you can use the following command:

   ```
   gcloud compute disks describe [DISK_NAME] --zone=[ZONE]
   ```

   Replace `[DISK_NAME]` with the name of the disk you want to check and `[ZONE]` with the zone where the disk is located. This command will return a description of the disk, including its encryption key information.

4. In the output of the previous command, look for the "diskEncryptionKey" field. If the disk is encrypted with a customer-managed key, this field will contain a "kmsKeyName" subfield with the name of the key. If the "diskEncryptionKey" field is not present or does not contain a "kmsKeyName" subfield, the disk is not encrypted with a customer-managed key.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the Google Cloud SDK and the Python client library for Google's API. You can do this using pip:

   ```bash
   pip install --upgrade google-cloud-sdk google-api-python-client
   ```

2. Authenticate your session: You need to authenticate your session with GCP. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file:

   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/service-account-file.json"
   ```

3. Write a Python script to check the encryption status of Kubernetes boot disks: Here's a simple script that uses the Google Cloud API to check the encryption status of all boot disks in a project:

   ```python
   from googleapiclient import discovery
   from googleapiclient.errors import HttpError

   def check_boot_disk_encryption(project_id):
       """Check the encryption status of all boot disks in a project."""
       compute = discovery.build('compute', 'v1')

       try:
           request = compute.disks().list(project=project_id)
           while request is not None:
               response = request.execute()

               for disk in response['items']:
                   # Check if the disk is a boot disk
                   if 'sourceImage' in disk and 'gce-uefi-images' in disk['sourceImage']:
                       # Check the encryption key
                       if 'diskEncryptionKey' in disk:
                           print(f"Disk {disk['name']} is encrypted with a customer-managed key.")
                       else:
                           print(f"Disk {disk['name']} is not encrypted with a customer-managed key.")

               request = compute.disks().list_next(previous_request=request, previous_response=response)
       except HttpError as err:
           print(f"An error occurred: {err}")

   if __name__ == "__main__":
       project_id = "your-project-id"  # replace with your project ID
       check_boot_disk_encryption(project_id)
   ```

4. Run the script: You can run the script from the command line like any other Python script. The script will print the encryption status of all boot disks in the specified project. If a disk is encrypted with a customer-managed key, the script will print a message saying so. If a disk is not encrypted with a customer-managed key, the script will print a message saying so.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration, follow these steps:

1. Open the Google Cloud Platform (GCP) Console and navigate to the Kubernetes Engine page.

2. Select the cluster that you want to remediate.

3. Click on the "Nodes" tab and select the node pool that you want to remediate.

4. Click on the "Edit" button to edit the node pool.

5. Scroll down to the "Security" section and click on the "Show" button next to "Boot disk encryption".

6. Select "Customer-managed encryption keys" from the drop-down menu.

7. Click on the "Select a key" button and choose the key that you want to use for encryption.

8. Click on the "Save" button to save the changes.

9. Repeat steps 4-8 for each node pool in the cluster.

10. Verify that the boot disk encryption has been configured correctly by checking the "Encryption" column in the nodes list. It should show "Customer-managed" for each node.

By following these steps, you have successfully remediated the misconfiguration by encrypting the Kubernetes boot disk with customer-managed keys in GCP using the GCP console.

#### Using CLI

To remediate the misconfiguration "Kubernetes Boot Disk Should Be Encrypted With Customer Managed Keys" for GCP using GCP CLI, follow the below steps:

1. Open the Cloud Shell or any terminal and ensure that you have the gcloud CLI installed and authenticated with your GCP account.

2. Run the following command to get the name of the boot disk of your Kubernetes cluster:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone [ZONE] | grep "bootDiskName"
   ```

   Replace `[CLUSTER_NAME]` with the name of your Kubernetes cluster and `[ZONE]` with the zone in which your cluster is running.

3. Run the following command to encrypt the boot disk with a customer-managed key:

   ```
   gcloud compute disks add-iam-policy-binding [DISK_NAME] --zone [ZONE] --member user:[USER_EMAIL] --role roles/compute.encrypterDecrypter
   ```

   Replace `[DISK_NAME]` with the name of the boot disk obtained from step 2, `[ZONE]` with the zone in which your cluster is running and `[USER_EMAIL]` with the email address of the user who will manage the key.

4. Run the following command to update the disk encryption key:

   ```
   gcloud compute disks update [DISK_NAME] --zone [ZONE] --customer-managed-key --customer-key-name [KEY_NAME] --source-key [KEY_RESOURCE_ID]
   ```

   Replace `[DISK_NAME]` with the name of the boot disk obtained from step 2, `[ZONE]` with the zone in which your cluster is running, `[KEY_NAME]` with the name of the customer-managed key and `[KEY_RESOURCE_ID]` with the ID of the key resource.

By following the above steps, you can remediate the misconfiguration "Kubernetes Boot Disk Should Be Encrypted With Customer Managed Keys" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Kubernetes Boot Disk Should Be Encrypted With Customer Managed Keys" in GCP using Python, you can follow the below steps:

1. First, you need to create a customer-managed encryption key in Cloud KMS using the following command:

```python
from google.cloud import kms_v1
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('path/to/your/credentials.json')
kms_client = kms_v1.KeyManagementServiceClient(credentials=credentials)

parent = kms_client.key_ring_path('project-id', 'location', 'key-ring')
key_id = 'my-key'
purpose = kms_v1.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT

response = kms_client.create_crypto_key(parent, key_id, {'purpose': purpose})
print(f'Created key: {response.name}')
```

Note: Replace the `path/to/your/credentials.json` with the actual path to your GCP service account credentials file, `project-id` with your GCP project ID, `location` with the location of your key ring, and `my-key` with the name of your encryption key.

2. Next, you need to update your Kubernetes cluster to use the customer-managed encryption key for boot disk encryption. You can use the following command to update the cluster:

```python
from google.cloud import container_v1
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('path/to/your/credentials.json')
container_client = container_v1.ClusterManagerClient(credentials=credentials)

cluster_id = 'my-cluster'
project_id = 'project-id'
zone = 'us-central1-a'
key_id = 'projects/project-id/locations/location/keyRings/key-ring/cryptoKeys/my-key'

cluster = container_client.get_cluster(project_id, zone, cluster_id)
cluster.spec.master_authorized_networks_config.encryption_config = {
    'state': 'ENCRYPTED',
    'key_name': key_id
}

update_request = container_client.update_cluster(project_id, zone, cluster_id, cluster)
print(f'Updated cluster: {update_request.name}')
```

Note: Replace the `path/to/your/credentials.json` with the actual path to your GCP service account credentials file, `project-id` with your GCP project ID, `location` with the location of your key ring, `my-key` with the name of your encryption key, and `my-cluster` with the name of your Kubernetes cluster.

3. Finally, you can verify that the boot disk encryption is using the customer-managed encryption key by checking the cluster details:

```python
cluster = container_client.get_cluster(project_id, zone, cluster_id)
print(f'Boot disk encryption key: {cluster.spec.master_authorized_networks_config.encryption_config.key_name}')
```

This will print the name of the encryption key used for boot disk encryption.


### Additional Reading:

- [https://cloud.google.com/blog/products/containers-kubernetes/exploring-container-security-use-your-own-keys-to-protect-your-data-on-gke](https://cloud.google.com/blog/products/containers-kubernetes/exploring-container-security-use-your-own-keys-to-protect-your-data-on-gke) 


</Tab>
</Tabs>