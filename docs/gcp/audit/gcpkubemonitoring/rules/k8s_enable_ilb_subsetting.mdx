---
slug: k8s_enable_ilb_subsetting
title: For Large Clusters L4 ILB Subsetting Should Be Used
sidebar_label: For Large Clusters L4 ILB Subsetting Should Be Used
---

### More Info:

GKE cluster should use GKE L4 ILB Subsetting if nodes > 250

### Risk Level

High

### Address

Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Console: Open your browser and navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your credentials.

2. Navigate to Kubernetes Engine: From the left-hand side menu, click on "Kubernetes Engine" and then "Clusters". This will display a list of all your Kubernetes clusters.

3. Check Cluster Size: Click on the name of the cluster you want to inspect. In the "Details" tab, look for the "Size" section. If the number of nodes is large (typically more than 500), it indicates that you are using a large cluster.

4. Check for L4 ILB Subsetting: Navigate to "Services & Ingress" under the "Kubernetes Engine". Look for any services that are of type "LoadBalancer". Click on the service to inspect its details. In the "Details" tab, look for the "Annotations" section. If the annotation "networking.gke.io/load-balancer-type" is not set to "Internal" and `"cloud.google.com/neg: '{"exposed_ports":{"PORT":{}}}'"` is not present, it indicates that L4 ILB Subsetting is not being used.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install and authenticate it.

2. Once the gcloud CLI is installed and authenticated, you can list all the clusters in your GCP project by running the following command:

   ```
   gcloud container clusters list
   ```
   This command will return a list of all the Kubernetes clusters in your GCP project.

3. To check if a specific cluster is using L4 ILB Subsetting, you need to describe the cluster and look for the "l4ilbSubsetting" field. You can do this by running the following command:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --zone=[CLUSTER_ZONE]
   ```
   Replace [CLUSTER_NAME] with the name of your cluster and [CLUSTER_ZONE] with the zone of your cluster. This command will return a detailed description of the cluster.

4. In the output of the previous command, look for the "l4ilbSubsetting" field. If it is set to "enabled", then the cluster is using L4 ILB Subsetting. If it is set to "disabled" or if the field is not present, then the cluster is not using L4 ILB Subsetting.

#### Using Python

1. Install the necessary Python libraries: You will need the Kubernetes Python client to interact with the Kubernetes API. You can install it using pip:

```python
pip install kubernetes
```

2. Connect to the Kubernetes API: You will need to authenticate with the Kubernetes API. This can be done using a kubeconfig file or by directly providing the API server address and a valid token.

```python
from kubernetes import client, config

# Load the kubeconfig file
config.load_kube_config()

# Create an API client
v1 = client.CoreV1Api()
```

3. Query the Kubernetes API for Services: You can use the list_service_for_all_namespaces method to get a list of all services in all namespaces. You will need to check the type of each service and whether it uses L4 ILB subsetting.

```python
services = v1.list_service_for_all_namespaces().items

for svc in services:
    if svc.spec.type == 'LoadBalancer':
        annotations = svc.metadata.annotations
        if annotations and 'networking.gke.io/load-balancer-type' in annotations:
            if annotations['networking.gke.io/load-balancer-type'] != 'Internal':
                print(f"Service {svc.metadata.name} in namespace {svc.metadata.namespace} is not using L4 ILB subsetting")
```

4. Analyze the results: The script will print out the names and namespaces of all services that are not using L4 ILB subsetting. You can use this information to identify the misconfigured services.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "For Large Clusters L4 ILB Subsetting Should Be Used" for GCP using GCP console, follow the below steps:

1. Log in to your GCP console and select the project where the misconfiguration exists.

2. Go to the "Kubernetes Engine" section from the main menu.

3. Click on the name of the cluster that you want to remediate.

4. Click on the "Edit" button.

5. Scroll down to the "Networking" section and click on "Advanced options".

6. Under "Load balancing", select "L4 Internal Load Balancer".

7. In the "Backend configuration" section, click on "Create a new backend configuration".

8. In the "Backend configuration" page, give a name to the backend configuration.

9. In the "Backend service" section, select the appropriate service from the dropdown.

10. In the "Backend instance group" section, select the instance group that you want to use.

11. In the "Health check" section, select the appropriate health check from the dropdown.

12. In the "Session affinity" section, select "None".

13. Click on the "Create" button to create the backend configuration.

14. Back in the "Load balancing" section, click on "Create a new load balancer".

15. In the "Create a Load Balancer" page, select "Internal" for the "Type" field.

16. Give a name to the load balancer.

17. In the "Backend configuration" section, select the backend configuration that you just created.

18. In the "Frontend configuration" section, select "HTTP(S)" for the "Protocol" field.

19. In the "IP address" section, select "Internal IP address".

20. Click on the "Create" button to create the load balancer.

21. Wait for a few minutes for the load balancer to be created.

22. Once the load balancer is created, go back to the "Kubernetes Engine" section and click on the name of the cluster.

23. Click on the "Edit" button.

24. Scroll down to the "Networking" section and click on "Advanced options".

25. Under "Load balancing", select the load balancer that you just created.

26. Click on the "Save" button to save the changes.

By following these steps, you can remediate the misconfiguration "For Large Clusters L4 ILB Subsetting Should Be Used" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "For Large Clusters L4 ILB Subsetting Should Be Used" for GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.
2. Check if you have the latest version of gcloud CLI by running the command: `gcloud components update`.
3. Run the command `gcloud config set project [PROJECT_ID]` to set the project where the misconfiguration exists.
4. Run the command `gcloud compute backend-services list` to list all the backend services in the project.
5. Identify the backend service for which you want to enable L4 ILB subsetting.
6. Run the command `gcloud compute backend-services update [BACKEND_SERVICE_NAME] --load-balancing-scheme internal --load-balancing-mode UTILIZATION --max-utilization 0.8 --connection-draining-timeout 300 --session-affinity NONE --health-checks [HEALTH_CHECK_NAME] --enable-logging --global --subnet [SUBNET_NAME] --database-subnet [DATABASE_SUBNET_NAME] --enable-cdn --l4-ilb-subsetting-enabled` to enable L4 ILB subsetting for the backend service.

Note: Replace the placeholders [PROJECT_ID], [BACKEND_SERVICE_NAME], [HEALTH_CHECK_NAME], [SUBNET_NAME], and [DATABASE_SUBNET_NAME] with the actual values specific to your project and backend service.

#### Using Python

To remediate the misconfiguration "For Large Clusters L4 ILB Subsetting Should Be Used" in GCP using Python, follow the steps below:

1. Import the necessary libraries:

```
from google.cloud import compute_v1
```

2. Define the project ID and the zone where the instance is located:

```
project_id = 'your-project-id'
zone = 'us-central1-a'
```

3. Create a Compute Engine client:

```
compute_client = compute_v1.InstancesClient()
```

4. Retrieve the instance resource:

```
instance_name = 'your-instance-name'
instance = compute_client.get(project_id=project_id, zone=zone, instance=instance_name)
```

5. Check if the instance has a network interface:

```
if instance.network_interfaces:
```

6. Retrieve the network interface:

```
network_interface = instance.network_interfaces[0]
```

7. Check if the network interface has an attached network endpoint group:

```
if network_interface.network_endpoint_groups:
```

8. Retrieve the network endpoint group:

```
network_endpoint_group = network_interface.network_endpoint_groups[0]
```

9. Check if the network endpoint group has a load balancing scheme of INTERNAL:

```
if network_endpoint_group.load_balancing_scheme == compute_v1.types.NetworkEndpointGroup.LoadBalancingScheme.INTERNAL:
```

10. Check if the network endpoint group has a load balancing scheme of INTERNAL_MANAGED:

```
if network_endpoint_group.load_balancing_scheme == compute_v1.types.NetworkEndpointGroup.LoadBalancingScheme.INTERNAL_MANAGED:
```

11. Check if the network endpoint group has a load balancing scheme of INTERNAL_SELF_MANAGED:

```
if network_endpoint_group.load_balancing_scheme == compute_v1.types.NetworkEndpointGroup.LoadBalancingScheme.INTERNAL_SELF_MANAGED:
```

12. Retrieve the health check:

```
health_check = network_endpoint_group.health_checks[0]
```

13. Update the L4 ILB Subsetting setting:

```
network_endpoint_group.l4_ilb_subsetting = True
network_endpoint_group.update_mask.add_field('l4_ilb_subsetting')
compute_client.update_network_endpoint_group(project=project_id, zone=zone, networkEndpointGroup=network_endpoint_group.name, body=network_endpoint_group)
```

14. Print a success message:

```
print('L4 ILB Subsetting has been enabled for the network endpoint group.')
```

By following these steps, you can remediate the "For Large Clusters L4 ILB Subsetting Should Be Used" misconfiguration in GCP using Python.




</Tab>
</Tabs>