---
slug: k8s_cluster_maintenance_window
title: Schedule Maintenance Windows And Exclusions
sidebar_label: Schedule Maintenance Windows And Exclusions
---

### More Info:

GKE cluster should schedule maintenance windows and exclusions to upgrade predictability and to align updates with off-peak business hours.

### Risk Level

Medium

### Address

Security, Reliability, Performance Efficiency

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the Kubernetes Engine section. Here, you will find a list of all your Kubernetes clusters.

3. Click on the specific Kubernetes cluster for which you want to check the Schedule Maintenance Windows and Exclusions. This will open the cluster details page.

4. In the cluster details page, scroll down to the 'Maintenance' section. Here, you can see the details of the scheduled maintenance windows and exclusions. If there are any misconfigurations, they will be visible here.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, you can authenticate your account by running the following command in your terminal:

   ```
   gcloud auth login
   ```

2. After successful authentication, you can set your project ID to the project you want to check. Replace `YOUR_PROJECT_ID` with your actual project ID in the following command:

   ```
   gcloud config set project YOUR_PROJECT_ID
   ```

3. Now, you can list all the clusters in your project by running the following command:

   ```
   gcloud container clusters list
   ```

   This command will return a list of all the clusters in your project along with their details.

4. To check the maintenance windows and exclusions of a specific cluster, you can describe the cluster using the following command. Replace `CLUSTER_NAME` with the name of your cluster:

   ```
   gcloud container clusters describe CLUSTER_NAME
   ```

   In the output, look for the `maintenancePolicy` field. This field contains the details about the maintenance windows and exclusions of the cluster. If this field is not present or is not configured correctly, it indicates a misconfiguration.

#### Using Python

1. **Import Required Libraries**: The first step is to import the required libraries. You will need the Kubernetes client library for Python. If you don't have it installed, you can do so using pip: `pip install kubernetes`. Here is how you import it:

```python
from kubernetes import client, config
```

2. **Configure Kubernetes Client**: The next step is to configure the Kubernetes client to connect to your cluster. If you are running this script from within a pod in the cluster, you can use the `load_incluster_config` function. If you are running it from your local machine, you can use the `load_kube_config` function:

```python
config.load_kube_config()
```

3. **Get List of All Namespaces**: Now, you can get a list of all namespaces in your cluster. You will need to check the maintenance windows and exclusions for each namespace:

```python
v1 = client.CoreV1Api()
namespaces = [ns.metadata.name for ns in v1.list_namespace().items]
```

4. **Check Maintenance Windows and Exclusions**: Finally, you can check the maintenance windows and exclusions for each namespace. This information is usually stored in the annotations of the namespace. You can access these annotations using the `metadata.annotations` property of the namespace:

```python
for namespace in namespaces:
    ns = v1.read_namespace(namespace)
    annotations = ns.metadata.annotations
    maintenance_window = annotations.get('maintenance_window')
    exclusions = annotations.get('exclusions')
    print(f'Namespace: {namespace}, Maintenance Window: {maintenance_window}, Exclusions: {exclusions}')
```

This script will print the maintenance windows and exclusions for each namespace in your cluster. If a namespace does not have these annotations, it will print `None`.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Schedule Maintenance Windows and Exclusions" misconfiguration in GCP using GCP console, follow these steps:

1. Go to the GCP Console and navigate to the Compute Engine page.

2. Select the VM instance that you want to remediate.

3. Click on the "Edit" button at the top of the page.

4. Scroll down to the "Maintenance" section.

5. Click on the "Edit" button next to "Maintenance window."

6. Set a maintenance window for the VM instance. This can be done by selecting a day and time range that works for you.

7. Click on the "Save" button to save your changes.

8. Scroll down to the "Exclusion" section.

9. Click on the "Add Exclusion" button.

10. In the "Exclusion" dialog box, select the type of exclusion you want to create. You can choose between "Instance", "Disks", and "Snapshots".

11. Set the parameters for the exclusion. For example, if you want to exclude a disk from maintenance, you can select the disk from the drop-down menu and set the exclusion period.

12. Click on the "Save" button to save your exclusion.

13. Repeat steps 9-12 for any additional exclusions you want to create.

14. Click on the "Save" button at the bottom of the page to save your changes.

By following these steps, you will have remediated the "Schedule Maintenance Windows and Exclusions" misconfiguration for the selected VM instance in GCP.

#### Using CLI

To remediate the misconfiguration of not scheduling maintenance windows and exclusions in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to set up the default project for the Cloud Shell session:

```
gcloud config set project [PROJECT_ID]
```

Replace `[PROJECT_ID]` with the ID of your GCP project.

3. Run the following command to create a maintenance policy for your GCP project:

```
gcloud alpha resource-manager org-policies set-policy maintenance-window \
--project=[PROJECT_ID] \
--policy-file=maintenance-policy.yaml
```

This command creates a maintenance policy for your GCP project, using the policy file `maintenance-policy.yaml`. You can modify this file to set up your desired maintenance window and exclusions.

4. Edit the `maintenance-policy.yaml` file to specify your desired maintenance window and exclusions. For example:

```
constraint: constraints/compute.maintenanceWindows
listPolicy:
  allow: [
    "Monday:03:00",
    "Tuesday:08:00",
    "Wednesday:15:00",
    "Thursday:20:00",
    "Friday:12:00"
  ]
  deny: [
    "2022-01-01T00:00:00Z/2022-01-01T01:00:00Z",
    "2022-12-25T00:00:00Z/2022-12-25T23:59:59Z"
  ]
```

This example sets a maintenance window for Monday at 3:00 AM, Tuesday at 8:00 AM, Wednesday at 3:00 PM, Thursday at 8:00 PM, and Friday at 12:00 PM. It also sets exclusions for January 1st, 2022 from 12:00 AM to 1:00 AM and for December 25th, 2022 for the entire day.

5. Save the `maintenance-policy.yaml` file.

6. Run the following command to update the maintenance policy for your GCP project:

```
gcloud alpha resource-manager org-policies set-policy maintenance-window \
--project=[PROJECT_ID] \
--policy-file=maintenance-policy.yaml
```

This command updates the maintenance policy for your GCP project with your desired maintenance window and exclusions.

7. Verify that the maintenance policy has been updated by running the following command:

```
gcloud alpha resource-manager org-policies describe maintenance-window \
--project=[PROJECT_ID]
```

This command displays the current maintenance policy for your GCP project.

By following these steps, you can remediate the misconfiguration of not scheduling maintenance windows and exclusions in GCP using GCP CLI.

#### Using Python

To remediate the "Schedule Maintenance Windows And Exclusions" misconfiguration in GCP using Python, you can follow the below steps:

1. First, you need to enable the Compute Engine API in your GCP project. You can do this by navigating to the APIs & Services page in the GCP console and searching for "Compute Engine API". Once you find it, click on the "Enable" button.

2. Next, you need to install the Google Cloud SDK and the Python client library for Compute Engine. You can do this by following the instructions in the GCP documentation.

3. Once you have installed the necessary tools, you can use the following Python code to create a maintenance window for a specific instance:

```
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials

credentials = GoogleCredentials.get_application_default()

compute = discovery.build('compute', 'v1', credentials=credentials)

project = 'my-project'
zone = 'us-central1-a'
instance = 'my-instance'
start_time = '2022-01-01T00:00:00Z'
end_time = '2022-01-02T00:00:00Z'

body = {
    'name': 'maintenance-window',
    'description': 'Scheduled maintenance window',
    'start_time': start_time,
    'end_time': end_time
}

response = compute.instances().setMaintenancePolicy(
    project=project,
    zone=zone,
    instance=instance,
    body=body
).execute()

print(response)
```

In the above code, you need to replace the `project`, `zone`, `instance`, `start_time`, and `end_time` variables with your own values. This will create a maintenance window for the specified instance.

4. To exclude an instance from all maintenance windows, you can use the following Python code:

```
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials

credentials = GoogleCredentials.get_application_default()

compute = discovery.build('compute', 'v1', credentials=credentials)

project = 'my-project'
zone = 'us-central1-a'
instance = 'my-instance'

body = {
    'exclusion': {
        'name': 'exclusion',
        'description': 'Exclude instance from all maintenance windows',
        'instanceFilters': {
            'instances': [
                'zones/{}/instances/{}'.format(zone, instance)
            ]
        }
    }
}

response = compute.projects().zones().instances().addMaintenancePolicies(
    project=project,
    zone=zone,
    body=body
).execute()

print(response)
```

In the above code, you need to replace the `project`, `zone`, and `instance` variables with your own values. This will exclude the specified instance from all maintenance windows.

By following the above steps, you can remediate the "Schedule Maintenance Windows And Exclusions" misconfiguration in GCP using Python.




</Tab>
</Tabs>