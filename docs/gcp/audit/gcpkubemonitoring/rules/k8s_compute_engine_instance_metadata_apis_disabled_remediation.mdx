

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your preferred web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Kubernetes Engine: From the left-hand side menu, select "Kubernetes Engine" to view all the Kubernetes clusters deployed within your GCP account.

3. Select the Kubernetes Cluster: From the list of Kubernetes clusters, select the cluster you want to inspect for the legacy Compute Engine instance metadata APIs.

4. Check the Metadata: In the cluster details page, navigate to the "Details" tab. Under the "Node Pools" section, click on the name of the node pool. In the node pool details page, check the "Cloud API access scopes" section. If the "Compute Engine Read/Write" scope (https://www.googleapis.com/auth/compute) is enabled, it means the legacy Compute Engine instance metadata APIs are not disabled.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, authenticate your Google Cloud account by running the following command in your terminal:

   ```
   gcloud auth login
   ```

2. List all the Kubernetes clusters in your project by running the following command:

   ```
   gcloud container clusters list
   ```

   This command will return a list of all the Kubernetes clusters in your project, along with their details.

3. For each cluster, check if the Legacy Compute Engine Instance Metadata APIs are disabled by running the following command:

   ```
   gcloud container clusters describe [CLUSTER_NAME] --format=json | grep legacyAbac
   ```

   Replace `[CLUSTER_NAME]` with the name of your cluster. This command will return the configuration of the specified cluster in JSON format and then search for the "legacyAbac" field in the output.

4. If the "legacyAbac" field is set to "true", then the Legacy Compute Engine Instance Metadata APIs are enabled, which is a misconfiguration. If it is set to "false", then the APIs are disabled, which is the correct configuration.

#### Using Python

1. Import the necessary libraries: You will need to import the Google Cloud client library in your Python script. This library allows you to interact with Google Cloud services including Google Compute Engine. Here is how you can import it:

```python
from google.cloud import compute_v1
```

2. Initialize the client: After importing the library, you need to initialize the client. This client will be used to interact with the Google Compute Engine. Here is how you can initialize it:

```python
client = compute_v1.InstancesClient()
```

3. Fetch the instances: Now, you can use the client to fetch all the instances in your project. You can do this by calling the `list_all()` method on the client. Here is how you can do it:

```python
instances = client.list_all(project='your_project_id')
```

4. Check the metadata: Now, you can iterate over all the instances and check if the legacy metadata APIs are enabled. You can do this by checking the `metadata` attribute of each instance. If the `metadata` attribute contains `enable-oslogin` key with value `FALSE`, it means that the legacy metadata APIs are enabled. Here is how you can do it:

```python
for instance in instances:
    metadata = instance.metadata
    if 'enable-oslogin' in metadata and metadata['enable-oslogin'] == 'FALSE':
        print(f'Legacy Compute Engine Instance Metadata APIs are enabled in instance {instance.name}')
```

This script will print the names of all instances where the legacy metadata APIs are enabled.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Ensure Legacy Compute Engine Instance Metadata APIs Are Disabled" for GCP using GCP console, follow the below steps:

1. Open the Google Cloud Console and select your project.
2. Navigate to the Compute Engine page from the left-hand menu.
3. From the Compute Engine page, select the "Metadata" tab.
4. Under the "Metadata" tab, click on the "Edit" button.
5. Scroll down to the "Legacy Metadata Access" section.
6. Select the "Disallow" option to disable the legacy metadata access.
7. Click on the "Save" button to save the changes.

Once you have completed these steps, the legacy Compute Engine instance metadata APIs will be disabled, and your GCP environment will be more secure.

#### Using CLI

To remediate the misconfiguration "Ensure Legacy Compute Engine Instance Metadata APIs Are Disabled" for GCP using GCP CLI, follow the below steps:

1. Open the GCP Cloud Shell and run the following command to disable the legacy metadata APIs:

```
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata=metadata-yaml-disable-legacy-endpoints=true
```

Here, replace [INSTANCE_NAME] with the name of the instance for which you want to disable the legacy metadata APIs.

2. Verify the change by running the following command:

```
gcloud compute instances describe [INSTANCE_NAME] --format="get(metadata.items['metadata-yaml-disable-legacy-endpoints'])"
```

This should output "true" which indicates that the legacy metadata APIs are now disabled.

3. Repeat the above steps for all the instances in your GCP project to ensure that the legacy metadata APIs are disabled for all instances.

Note: It is recommended to use the latest metadata APIs instead of the legacy ones for better security and performance.

#### Using Python

To remediate the misconfiguration "Ensure Legacy Compute Engine Instance Metadata APIs Are Disabled" for GCP using Python, you can use the following steps:

1. Import the necessary Python libraries:
```python
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials
```
2. Authenticate and authorize your credentials:
```python
credentials = GoogleCredentials.get_application_default()
service = discovery.build('compute', 'v1', credentials=credentials)
```
3. Get the project ID:
```python
project = 'YOUR_PROJECT_ID'
```
4. Get the instance name:
```python
instance = 'YOUR_INSTANCE_NAME'
```
5. Get the instance metadata:
```python
request = service.instances().get(project=project, zone=zone, instance=instance)
response = request.execute()
metadata = response['metadata']
```
6. Check if the legacy metadata APIs are enabled:
```python
if 'enable-guest-attributes' in metadata:
    if metadata['enable-guest-attributes'] == 'TRUE':
        metadata.pop('enable-guest-attributes')
        body = {'metadata': metadata}
        request = service.instances().setMetadata(project=project, zone=zone, instance=instance, body=body)
        response = request.execute()
        print('Legacy Compute Engine Instance Metadata APIs have been disabled.')
    else:
        print('Legacy Compute Engine Instance Metadata APIs are already disabled.')
else:
    print('Legacy Compute Engine Instance Metadata APIs are already disabled.')
```
7. If the legacy metadata APIs are enabled, remove the 'enable-guest-attributes' key from the metadata and update the instance metadata with the new metadata:
```python
metadata.pop('enable-guest-attributes')
body = {'metadata': metadata}
request = service.instances().setMetadata(project=project, zone=zone, instance=instance, body=body)
response = request.execute()
print('Legacy Compute Engine Instance Metadata APIs have been disabled.')
```
8. If the legacy metadata APIs are already disabled, print a message indicating that they are already disabled:
```python
print('Legacy Compute Engine Instance Metadata APIs are already disabled.')
```
Note: Replace YOUR_PROJECT_ID and YOUR_INSTANCE_NAME with your actual project ID and instance name respectively. Also, replace the zone variable with the appropriate zone for your instance.


</Tab>
</Tabs>