

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform (GCP) Console (https://console.cloud.google.com/) and sign in with your Google account.

2. Navigate to BigQuery: From the GCP Console dashboard, select the hamburger menu in the upper left-hand corner, scroll down and click on "BigQuery" under the "Big Data" section.

3. Check Dataset Details: In the BigQuery dashboard, you will see a list of your datasets. Click on the dataset that you want to check. This will open the "Dataset details" page.

4. Check Encryption: In the "Dataset details" page, scroll down to the "Encryption" section. If the dataset is encrypted with a customer-managed key, it will be listed here. If it says "Google-managed key", then the dataset is not encrypted with a customer-managed key.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine and authenticate it with your Google Cloud account. You can do this by following the instructions provided by Google Cloud.

2. List all BigQuery datasets in your project: Use the following command to list all the datasets in your current GCP project:

   ```
   bq ls --project_id=[PROJECT_ID]
   ```

   Replace `[PROJECT_ID]` with your actual project ID. This command will return a list of all datasets in your project.

3. Get details about a specific dataset: Use the following command to get details about a specific dataset:

   ```
   bq show --encryption_service_account=[SERVICE_ACCOUNT] [DATASET]
   ```

   Replace `[SERVICE_ACCOUNT]` with the email address of the service account that you want to use for encryption, and replace `[DATASET]` with the name of the dataset that you want to inspect. This command will return information about the specified dataset, including its encryption configuration.

4. Check the encryption configuration: In the output of the previous command, look for the `encryptionConfiguration` field. If this field is present and its `kmsKeyName` subfield is set to the name of a customer-managed key, then the dataset is encrypted with a customer-managed key. If the `encryptionConfiguration` field is not present or its `kmsKeyName` subfield is not set, then the dataset is not encrypted with a customer-managed key.

#### Using Python

1. Install the necessary Python libraries: Google Cloud BigQuery and Google Cloud KMS. You can install these libraries using pip:

```python
pip install google-cloud-bigquery
pip install google-cloud-kms
```

2. Import the necessary libraries and initialize the BigQuery and KMS clients:

```python
from google.cloud import bigquery
from google.cloud import kms

bigquery_client = bigquery.Client()
kms_client = kms.KeyManagementServiceClient()
```

3. Fetch all the datasets in the project and for each dataset, fetch all the tables. For each table, check if it is encrypted with a customer-managed key:

```python
datasets = list(bigquery_client.list_datasets())
for dataset in datasets:
    tables = list(bigquery_client.list_tables(dataset.dataset_id))
    for table in tables:
        table_ref = bigquery_client.dataset(dataset.dataset_id).table(table.table_id)
        table_obj = bigquery_client.get_table(table_ref)
        if table_obj.encryption_configuration is None or table_obj.encryption_configuration.kms_key_name is None:
            print(f"Table {table.table_id} in dataset {dataset.dataset_id} is not encrypted with a customer-managed key.")
```

4. If you want to check if the customer-managed key exists and is enabled, you can use the KMS client:

```python
        else:
            key_name = table_obj.encryption_configuration.kms_key_name
            key = kms_client.get_crypto_key(request={'name': key_name})
            if key.primary.state != kms.CryptoKeyVersion.CryptoKeyVersionState.ENABLED:
                print(f"Table {table.table_id} in dataset {dataset.dataset_id} is encrypted with a customer-managed key, but the key is not enabled.")
```

This script will print out the names of all tables that are not encrypted with a customer-managed key, or that are encrypted with a key that is not enabled.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "GCP BigQuery Tables Should Be Encrypted With Customer Managed Keys", you can follow the below steps:

1. Log in to your GCP console.

2. Navigate to the BigQuery section.

3. Select the dataset that contains the tables you want to encrypt.

4. Click on the "Show Info Panel" button (i) next to the dataset name.

5. In the "Encryption" section, click on the "Edit" button.

6. Select the "Customer-managed encryption keys" option.

7. Click on the "Create or select a key" button.

8. Choose an existing key or create a new one.

9. Click on the "Save" button.

10. Repeat the above steps for each table in the dataset.

By following these steps, you can remediate the misconfiguration "GCP BigQuery Tables Should Be Encrypted With Customer Managed Keys" and ensure that your BigQuery tables are encrypted with customer-managed keys.

#### Using CLI

To remediate the misconfiguration of GCP BigQuery tables not being encrypted with customer-managed keys, you can follow the below steps using GCP CLI:

1. Firstly, create a customer-managed encryption key in Cloud Key Management Service (KMS) using the following command:

```
gcloud kms keyrings create [KEYRING_NAME] --location [LOCATION]
gcloud kms keys create [KEY_NAME] --location [LOCATION] --keyring [KEYRING_NAME] --purpose encryption
```

Replace `[KEYRING_NAME]`, `[LOCATION]` and `[KEY_NAME]` with your preferred values.

2. Next, grant the BigQuery service account the necessary permissions to use the encryption key by running the following command:

```
gcloud kms keys add-iam-policy-binding [KEY_NAME] --location [LOCATION] --keyring [KEYRING_NAME] --member serviceAccount:[SERVICE_ACCOUNT_EMAIL] --role roles/cloudkms.cryptoKeyEncrypterDecrypter
```

Replace `[KEYRING_NAME]`, `[LOCATION]`, `[KEY_NAME]` and `[SERVICE_ACCOUNT_EMAIL]` with your preferred values.

3. Now, create a new BigQuery dataset or update an existing one to use the customer-managed encryption key by running the following command:

```
bq update --default_table_expiration [INTEGER_VALUE] --description [DESCRIPTION] --encryption_kms_key_name projects/[PROJECT_ID]/locations/[LOCATION]/keyRings/[KEYRING_NAME]/cryptoKeys/[KEY_NAME] [DATASET_NAME]
```

Replace `[INTEGER_VALUE]`, `[DESCRIPTION]`, `[PROJECT_ID]`, `[LOCATION]`, `[KEYRING_NAME]`, `[KEY_NAME]` and `[DATASET_NAME]` with your preferred values.

4. Finally, ensure that all existing tables in the dataset are encrypted with the customer-managed key by running the following command:

```
bq update --table_kms_key projects/[PROJECT_ID]/locations/[LOCATION]/keyRings/[KEYRING_NAME]/cryptoKeys/[KEY_NAME] [DATASET_NAME].[TABLE_NAME]
```

Replace `[PROJECT_ID]`, `[LOCATION]`, `[KEYRING_NAME]`, `[KEY_NAME]`, `[DATASET_NAME]` and `[TABLE_NAME]` with your preferred values.

By following the above steps, you can remediate the misconfiguration of GCP BigQuery tables not being encrypted with customer-managed keys.

#### Using Python

To remediate the misconfiguration of GCP BigQuery Tables not being encrypted with customer managed keys, you can follow the below steps using Python:

1. First, you need to create a customer-managed encryption key (CMEK) in the Google Cloud Key Management Service (KMS) using the following code:

```python
from google.cloud import kms_v1
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('<path-to-service-account-key-file>')
kms_client = kms_v1.KeyManagementServiceClient(credentials=credentials)

parent = kms_client.key_ring_path('<project-id>', '<location>', '<key-ring>')
purpose = kms_v1.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT

response = kms_client.create_crypto_key(parent=parent, crypto_key_id='<key-id>', crypto_key={'purpose': purpose})
print(f'Created CMEK: {response.name}')
```

2. Next, you need to update the BigQuery table to use the newly created CMEK for encryption using the following code:

```python
from google.cloud import bigquery
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('<path-to-service-account-key-file>')
bq_client = bigquery.Client(credentials=credentials, project='<project-id>')

dataset_ref = bq_client.dataset('<dataset-id>')
table_ref = dataset_ref.table('<table-id>')
table = bq_client.get_table(table_ref)

table.encryption_configuration = bigquery.EncryptionConfiguration(
    kms_key_name=f'projects/<project-id>/locations/<location>/keyRings/<key-ring>/cryptoKeys/<key-id>'
)

table = bq_client.update_table(table, ['encryption_configuration'])
print(f'Table {table.table_id} is now encrypted with CMEK')
```

Once you run the above two code snippets, the BigQuery table will be encrypted with the newly created CMEK.


</Tab>
</Tabs>