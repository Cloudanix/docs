### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration in GCP Console:

1. Open the GCP Console and navigate to the BigQuery section.

2. Select the dataset that contains the tables you want to encrypt.

3. Click on the "Encryption" tab.

4. Click on the "Edit" button.

5. Select "Customer-managed key" from the drop-down menu.

6. Choose the key you want to use for encryption. If you haven't created a key yet, you can do so by clicking on the "Create a key" button.

7. Click on the "Save" button.

8. Repeat these steps for each dataset that contains tables that need to be encrypted.

Once you have completed these steps, all tables in the selected datasets will be encrypted with customer-managed keys. This will help ensure that your data is protected and meets any compliance requirements that you may have.

#### Using CLI

To remediate this GCP misconfiguration, you need to follow the below steps in GCP CLI:

1. Create a new customer-managed encryption key (CMEK) in Cloud KMS. 

2. Grant BigQuery Service Account the necessary permissions to use the CMEK. 

3. Enable Customer-Managed Encryption Keys for BigQuery tables. 

Here are the detailed steps:

1. Create a new customer-managed encryption key (CMEK) in Cloud KMS:

   a. Open the Cloud KMS page in the Cloud Console.
   
   b. Select the project where you want to create the key.
   
   c. Click on "Create Keyring" to create a new keyring.
   
   d. Enter a name for the new keyring and click "Create".
   
   e. Click on the newly created keyring and then click on "Create Key".
   
   f. Enter a name for the new key and select "Customer-managed key" as the key type.
   
   g. Choose the key region and key algorithm and click "Create".

2. Grant BigQuery Service Account the necessary permissions to use the CMEK:

   a. Open the Cloud KMS page in the Cloud Console.
   
   b. Click on the key you created in step 1.
   
   c. Click on the "Permissions" tab and then click on "Add Member".
   
   d. Enter the email address of the BigQuery Service Account (this can be found in the BigQuery console under "IAM & Admin").
   
   e. Select the "Cloud KMS CryptoKey Encrypter/Decrypter" role and click "Save".

3. Enable Customer-Managed Encryption Keys for BigQuery tables:

   a. Open the BigQuery console in the Cloud Console.
   
   b. Click on the dataset that contains the table you want to encrypt.
   
   c. Click on the table you want to encrypt.
   
   d. Click on the "Details" tab and then click on "Edit Table".
   
   e. Under "Encryption", select "Customer-managed key" and choose the key you created in step 1.
   
   f. Click "Save" to enable encryption for the table.

Following these steps will remediate the misconfiguration and ensure that all BigQuery tables are encrypted with customer-managed keys.

#### Using Python

To remediate the misconfiguration of GCP BigQuery Tables not being encrypted with customer managed keys, you can use the following steps in Python:

1. First, you need to create a new Cloud KMS key ring and a new key in the same region as your BigQuery dataset. You can do this using the `google-cloud-kms` Python library and the following code:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()

# Replace [PROJECT_ID] with your GCP project ID
parent = client.location_path('[PROJECT_ID]', '[REGION]')

# Replace [KEY_RING_ID] with a unique name for your key ring
key_ring_id = '[KEY_RING_ID]'
key_ring = client.create_key_ring(parent, key_ring_id, {})

# Replace [KEY_ID] with a unique name for your key
key_id = '[KEY_ID]'
key = client.create_crypto_key(key_ring.name, key_id, kms_v1.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT, {})
```

2. Next, you need to update your BigQuery tables to use the new customer-managed key. You can do this using the `google-cloud-bigquery` Python library and the following code:

```python
from google.cloud import bigquery

# Replace [PROJECT_ID] with your GCP project ID
client = bigquery.Client(project='[PROJECT_ID]')

# Replace [DATASET_ID] with the ID of your BigQuery dataset
dataset_id = '[DATASET_ID]'
dataset = client.get_dataset(dataset_id)

# Replace [TABLE_ID] with the ID of your BigQuery table
table_id = '[TABLE_ID]'
table = client.get_table(dataset.table(table_id))

# Replace [KEY_RESOURCE_ID] with the resource ID of your new customer-managed key
key_resource_id = 'projects/[PROJECT_ID]/locations/[REGION]/keyRings/[KEY_RING_ID]/cryptoKeys/[KEY_ID]'

# Update the table to use the new customer-managed key
table.encryption_configuration = bigquery.EncryptionConfiguration(
    kms_key_name=key_resource_id
)
client.update_table(table, ['encryption_configuration'])
```

3. Finally, you need to verify that your BigQuery tables are now encrypted with the new customer-managed key. You can do this by checking the `encryption_configuration` property of each table using the `google-cloud-bigquery` Python library and the following code:

```python
from google.cloud import bigquery

# Replace [PROJECT_ID] with your GCP project ID
client = bigquery.Client(project='[PROJECT_ID]')

# Replace [DATASET_ID] with the ID of your BigQuery dataset
dataset_id = '[DATASET_ID]'
dataset = client.get_dataset(dataset_id)

# Replace [TABLE_ID] with the ID of your BigQuery table
table_id = '[TABLE_ID]'
table = client.get_table(dataset.table(table_id))

# Verify that the table is encrypted with the new customer-managed key
if table.encryption_configuration.kms_key_name != key_resource_id:
    raise Exception('Table encryption configuration is not set to the new customer-managed key')
```

By following these steps, you can remediate the misconfiguration of GCP BigQuery Tables not being encrypted with customer managed keys using Python.

