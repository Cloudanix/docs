---
slug: kms_cross_account_access
title: KMS Cross Account Access Must Not Be Present
sidebar_label: KMS Cross Account Access Must Not Be Present
---

### More Info:

Ensure that all KMS keys are configured to be accessed only by trusted accounts in order to prevent unauthorized access

### Risk Level

High

### Address

Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to KMS Service: From the left-hand side menu, navigate to "Security" > "Key Management". This will open the Key Management Service (KMS) dashboard where you can manage all your cryptographic keys.

3. Check Key Permissions: For each key ring and key, click on the three dots on the right side and select "Manage permissions". This will open a new page showing all the IAM roles associated with the key.

4. Review IAM Roles: In the IAM roles, look for any roles that are associated with accounts outside of your organization. If there are any, it means that cross-account access is present, which is a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and configured, you can list all the KMS keys in your project by running the following command in your terminal:

   ```
   gcloud kms keys list --location global --keyring [KEYRING_NAME]
   ```
   Replace `[KEYRING_NAME]` with the name of your keyring.

3. To check the IAM policies for each key, use the following command:

   ```
   gcloud kms keys get-iam-policy [KEY_NAME] --location global --keyring [KEYRING_NAME]
   ```
   Replace `[KEY_NAME]` and `[KEYRING_NAME]` with the name of your key and keyring respectively.

4. Review the output of the command. If there are any bindings with the role `roles/cloudkms.cryptoKeyEncrypterDecrypter` and the member is not part of your organization (i.e., the member's email address does not end with your organization's domain), then cross-account access is present.

#### Using Python

1. Import the necessary AWS SDK for Python (Boto3) modules and initialize a client for AWS Key Management Service (KMS):

```python
import boto3
kms_client = boto3.client('kms')
```

2. List all the KMS keys in your account:

```python
response = kms_client.list_keys()
keys = response['Keys']
```

3. For each key, get the key policy and check if there are any principals that are not in your account:

```python
for key in keys:
    key_id = key['KeyId']
    policy = kms_client.get_key_policy(KeyId=key_id, PolicyName='default')
```

4. Parse the policy and check for any principals that are not in your account. If there are any, print a warning message:

```python
import json
policy_document = json.loads(policy['Policy'])
for statement in policy_document['Statement']:
    principal = statement['Principal']
    if 'AWS' in principal:
        aws_account = principal['AWS'].split(':')[4]
        if aws_account != boto3.client('sts').get_caller_identity().get('Account'):
            print(f"Warning: KMS key {key_id} is accessible by account {aws_account}")
```

This script will print a warning for each KMS key that is accessible by a different AWS account. Note that this script only checks the default key policy. If you have custom key policies, you may need to modify the script to check those as well.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the KMS Cross Account Access misconfiguration in GCP using the GCP console, follow these steps:

1. Open the GCP Console and navigate to the Key Management Service (KMS) page.
2. Select the key ring that has cross-account access enabled.
3. Click on the key for which cross-account access is enabled.
4. Click on the "Permissions" tab.
5. Click the "Edit" button at the top of the page.
6. Find the member that has cross-account access and click the "X" to remove it.
7. Click "Save" to save the changes.

Once you have completed these steps, cross-account access will be disabled for the selected key. Ensure that you have reviewed all the other keys and key rings and disabled cross-account access for any other keys that may have it enabled.

#### Using CLI

To remediate the KMS Cross Account Access Misconfiguration in GCP using GCP CLI, you can follow these steps:

1. First, you need to identify the KMS keyring and cryptokey that has cross-account access. You can use the following command to list all the KMS keyrings in your GCP project:

   ```
   gcloud kms keyrings list
   ```

   Once you have identified the keyring, you can list all the cryptokeys in that keyring using the following command:

   ```
   gcloud kms keys list --keyring=<keyring-name>
   ```

   Identify the cryptokey that has cross-account access.

2. Once you have identified the cryptokey, you can remove the cross-account access by updating the IAM policy for that cryptokey. You can use the following command to remove all the members from the IAM policy for that cryptokey:

   ```
   gcloud kms keys set-iam-policy <key-name> /dev/null
   ```

   This command sets the IAM policy for the cryptokey to an empty policy, which effectively removes all the members from the policy.

3. Finally, you can verify that the cross-account access has been removed by listing the IAM policy for the cryptokey using the following command:

   ```
   gcloud kms keys get-iam-policy <key-name>
   ```

   This command should return an empty policy, indicating that there are no members with access to the cryptokey.

By following these steps, you can remediate the KMS Cross Account Access Misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the KMS Cross Account Access misconfiguration in GCP using Python, you can follow the below steps:

1. First, you need to identify the KMS key that has cross-account access enabled. You can use the following command to list all the KMS keys in your project:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()
parent = client.key_ring_path(project_id, location_id, key_ring_id)

response = client.list_crypto_keys(parent)

for crypto_key in response:
    print(crypto_key.name)
```

2. Once you have identified the KMS key, you can disable cross-account access by updating the IAM policy of the KMS key. You can use the following code to update the IAM policy:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()
resource = client.crypto_key_path(project_id, location_id, key_ring_id, crypto_key_id)

policy = client.get_iam_policy(resource)

for binding in policy.bindings:
    if binding.role == 'roles/cloudkms.cryptoKeyEncrypterDecrypter':
        binding.condition = None
        binding.members = [f'serviceAccount:{project_number}-compute@developer.gserviceaccount.com']

updated_policy = client.set_iam_policy(resource, policy)
```

In the above code, we are removing the condition that allows cross-account access and adding the service account of the Compute Engine instance in the same project as a member with the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role. This will allow the Compute Engine instance to access the KMS key but prevent cross-account access.

3. Finally, you can verify that cross-account access has been disabled for the KMS key by running the following command:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()
resource = client.crypto_key_path(project_id, location_id, key_ring_id, crypto_key_id)

policy = client.get_iam_policy(resource)

for binding in policy.bindings:
    if binding.role == 'roles/cloudkms.cryptoKeyEncrypterDecrypter' and binding.condition:
        print('Cross-account access is still enabled')
    else:
        print('Cross-account access has been disabled')
```

By following these steps, you can remediate the KMS Cross Account Access misconfiguration in GCP using Python.




</Tab>
</Tabs>