

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Console: Open your web browser, navigate to the Google Cloud Console (console.cloud.google.com), and sign in with your Google account.

2. Navigate to VPC Network: From the main dashboard, click on the navigation menu (three horizontal lines in the upper left-hand corner), scroll down and click on "VPC Network" under the "Networking" section.

3. Check Firewall Rules: In the VPC Network page, click on "Firewall rules" in the left-hand menu. This will display a list of all the firewall rules in your VPC network.

4. Inspect Rules for SMB Port: Look for any rules that have "tcp:445" (the port number for SMB) in the "Protocols / ports" column. If such a rule exists and its action is set to "Allow", then the Windows SMB port is open.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: The Google Cloud SDK includes the gcloud command-line tool, which is necessary to interact with your GCP resources. You can install it by following the instructions provided by Google Cloud. After installation, authenticate the SDK using the command `gcloud auth login`.

2. List all the firewall rules: Use the following command to list all the firewall rules in your GCP project. This will display a list of all firewall rules, including their associated network, source range, allowed protocols and ports, and other details.

    ```
    gcloud compute firewall-rules list
    ```

3. Filter the firewall rules: To check if the Windows SMB port (port 445) is open, you need to filter the firewall rules that allow traffic on this port. You can do this by using the following command:

    ```
    gcloud compute firewall-rules list --filter="allowed:445"
    ```

4. Review the output: If the command returns any firewall rules, it means that the Windows SMB port is open in your network. The output will include the name of the firewall rule, the network it is associated with, the source range, and the allowed protocols and ports. If no rules are returned, it means that the port is not open.

#### Using Python

1. Import Required Libraries: The first step is to import the required libraries in Python. We will need the 'socket' library to create a socket and connect to the server on the specific port.

```python
import socket
```

2. Define Function to Check Port: Next, we define a function that will take an IP address and a port number as input and will try to connect to the server on that port. If the connection is successful, it means the port is open; otherwise, it's closed.

```python
def check_port(ip, port):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    try:
        connection = sock.connect((ip, port))
        return True
    except:
        return False
    finally:
        sock.close()
```

3. Check SMB Port: Now, we can use the function to check if the SMB port (445) is open. Replace 'server_ip' with the IP address of your server.

```python
if check_port('server_ip', 445):
    print("SMB port is open")
else:
    print("SMB port is closed")
```

4. Iterate Over Multiple Servers: If you have multiple servers to check, you can put the IP addresses in a list and iterate over them using a for loop.

```python
servers = ['server1_ip', 'server2_ip', 'server3_ip']
for server in servers:
    if check_port(server, 445):
        print(f"SMB port is open on {server}")
    else:
        print(f"SMB port is closed on {server}")
```

This script will help you detect if the Windows SMB port is open on your servers. Please replace 'server_ip' with the actual IP address of your server.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Windows SMB Port Should Not Be Open" for GCP using GCP console, follow the below steps:

1. Open the Google Cloud Console and select the project for which you want to remediate the misconfiguration.

2. Navigate to the Compute Engine section and select the VM instance that has the open Windows SMB port.

3. Click on the Edit button at the top of the page.

4. Scroll down to the Firewall section and click on "Add Firewall Rule".

5. In the Name field, enter a name for the firewall rule.

6. In the Targets field, select "Specified target tags" and enter the tag that is associated with the VM instance.

7. In the Source filter field, select "IP ranges" and enter the IP range that you want to allow access to the Windows SMB port.

8. In the Protocols and ports field, select "Specified protocols and ports" and enter "tcp:445".

9. Click on the "Create" button to create the firewall rule.

10. Once the firewall rule is created, click on the Save button to save the changes to the VM instance.

11. Verify that the Windows SMB port is no longer open by running a port scan on the VM instance.

By following the above steps, you can remediate the misconfiguration "Windows SMB Port Should Not Be Open" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Windows SMB Port Should Not Be Open" for GCP using GCP CLI, you can follow these steps:

1. Login to your GCP console using your credentials.

2. Open the Cloud Shell by clicking on the icon located on the top right corner of the console.

3. Run the following command to list all the instances in your project:

```
gcloud compute instances list
```

4. Identify the instance which has the open SMB port.

5. Run the following command to SSH into the instance:

```
gcloud compute ssh [INSTANCE_NAME]
```

6. Once you are logged in to the instance, run the following command to check if the SMB port is open:

```
sudo netstat -tuln | grep 445
```

7. If the SMB port is open, run the following command to stop the SMB service:

```
sudo systemctl stop smbd
```

8. Run the following command to disable the SMB service from starting on boot:

```
sudo systemctl disable smbd
```

9. Finally, run the following command to confirm that the SMB port is no longer open:

```
sudo netstat -tuln | grep 445
```

10. Exit the SSH session by running the following command:

```
exit
```

By following these steps, you will have successfully remediated the misconfiguration "Windows SMB Port Should Not Be Open" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Windows SMB Port Should Not Be Open" on GCP using Python, you can follow the below steps:

1. Use the Google Cloud SDK to authenticate and authorize access to your GCP account.

2. Use the Python `google-cloud-compute` library to create a new firewall rule that blocks the Windows SMB port (TCP port 445) on all instances in your GCP project.

3. Here is the sample Python code to create a new firewall rule:

```python
from google.cloud import compute_v1

# Create a compute client
compute_client = compute_v1.InstancesClient()

# Get the project ID and zone
project_id = 'your-project-id'
zone = 'us-central1-a'

# Define the firewall rule
firewall_rule = {
    "name": "block-smb",
    "direction": "INGRESS",
    "priority": 1000,
    "targetTags": ["windows"],
    "allowed": [],
    "denied": [
        {
            "IPProtocol": "tcp",
            "ports": ["445"]
        }
    ],
    "sourceRanges": ["0.0.0.0/0"],
}

# Create the firewall rule
operation = compute_client.insert_firewall(project=project_id, firewall_resource=firewall_rule)
result = operation.result()
```

4. In the above code, replace `your-project-id` with your GCP project ID and `us-central1-a` with your preferred zone.

5. The above code creates a new firewall rule named "block-smb" that blocks TCP port 445 on all instances with the tag "windows". You can add this tag to your Windows instances to apply the firewall rule.

6. After running the above code, you should see a new firewall rule named "block-smb" in your GCP console.

7. Verify that the firewall rule is working as expected by testing the Windows SMB port from outside your GCP network.

By following the above steps, you can remediate the misconfiguration "Windows SMB Port Should Not Be Open" on GCP using Python.


</Tab>
</Tabs>