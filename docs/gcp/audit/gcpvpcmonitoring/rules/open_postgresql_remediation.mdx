

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Google Cloud Console: First, you need to log in to your Google Cloud Console. Make sure you have the necessary permissions to view and manage the network settings.

2. Navigate to VPC Network: From the main dashboard, navigate to the "VPC Network" section. This is where you can view and manage all your Virtual Private Cloud (VPC) networks.

3. Check Firewall Rules: In the VPC Network section, click on "Firewall rules". This will display a list of all the firewall rules that are currently in place for your VPC networks. Look for any rules that are allowing traffic to the PostgreSQL port (default is 5432).

4. Inspect Rule Details: If you find a rule that is allowing traffic to the PostgreSQL port, click on it to view more details. Check the "Source filter" and "Allowed protocols and ports" fields. If the source filter is set to "0.0.0.0/0" (which means any IP address) and the allowed protocol and port is set to "tcp:5432" (which means TCP traffic on port 5432), then your PostgreSQL port is open to the internet.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and authenticated, you can list all the firewall rules in your GCP project by running the following command in your terminal:

   ```
   gcloud compute firewall-rules list
   ```

3. To check if PostgreSQL port (5432) is open, you can filter the results by the port number. Run the following command:

   ```
   gcloud compute firewall-rules list --filter="allowed:tcp:5432"
   ```

4. Review the output of the command. If any firewall rules allow traffic to port 5432, they will be listed in the output. The presence of such rules indicates that the PostgreSQL port is open in the network.

#### Using Python

1. AWS:

You can use the boto3 library in Python to interact with AWS services. Here is a sample script to check if PostgreSQL port is open:

```python
import boto3

def check_security_group_rules():
    ec2 = boto3.resource('ec2')
    for security_group in ec2.security_groups.all():
        for rule in security_group.ip_permissions:
            for ip_range in rule['IpRanges']:
                if rule['FromPort'] == 5432 and '0.0.0.0/0' in ip_range['CidrIp']:
                    print(f"Security Group {security_group.id} has PostgreSQL port open to the world")

check_security_group_rules()
```

2. Azure:

You can use the azure-mgmt-network library in Python to interact with Azure services. Here is a sample script to check if PostgreSQL port is open:

```python
from azure.mgmt.network import NetworkManagementClient
from azure.identity import DefaultAzureCredential

def check_security_group_rules():
    credential = DefaultAzureCredential()
    network_client = NetworkManagementClient(credential, '<subscription_id>')
    for security_group in network_client.network_security_groups.list_all():
        for rule in security_group.security_rules:
            if rule.destination_port_range == '5432' and rule.source_address_prefix == '*':
                print(f"Security Group {security_group.name} has PostgreSQL port open to the world")

check_security_group_rules()
```

3. GCP:

You can use the google-cloud-securitycenter library in Python to interact with GCP services. Here is a sample script to check if PostgreSQL port is open:

```python
from google.cloud import securitycenter_v1

def check_security_group_rules():
    client = securitycenter_v1.SecurityCenterClient()
    organization_id = 'your-organization-id'
    source_properties = {
        "port": "5432",
        "ipProtocol": "tcp",
    }
    finding = client.list_findings(
        request={"parent": f"organizations/{organization_id}/sources/-", "filter": source_properties}
    )
    for i in finding:
        if i.finding.state == securitycenter_v1.Finding.State.ACTIVE:
            print(f"Security Group {i.finding.source_properties['project']} has PostgreSQL port open to the world")

check_security_group_rules()
```

Please replace 'your-organization-id' with your actual organization id in GCP.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the PostgreSQL port being open on GCP using the GCP console, follow these steps:

1. Open the GCP Console and navigate to the GCP project where the PostgreSQL instance is located.

2. In the left-hand menu, click on "SQL" to open the Cloud SQL Instances page.

3. Locate the PostgreSQL instance that has the open port and click on its name to open the instance details page.

4. Click on the "Edit" button at the top of the page to open the Edit instance page.

5. Scroll down to the "Connections" section and locate the "Authorized networks" field.

6. Click on the "Add network" button to add a new network.

7. In the "Network" field, enter the IP address range or CIDR block that you want to authorize to access the instance.

8. Click on the "Save" button to save the changes.

9. Repeat steps 6-8 for any additional networks that need to be authorized.

10. Scroll down to the bottom of the Edit instance page and click on the "Save" button to apply the changes.

By following the above steps, you have successfully remediated the PostgreSQL port being open on GCP using the GCP console.

#### Using CLI

The following are the step-by-step instructions to remediate the PostgreSQL port open misconfiguration for GCP using GCP CLI:

1. Open the Google Cloud Console and select the project where the PostgreSQL instance is running.

2. Open the Cloud Shell by clicking on the button located on the top right corner of the console.

3. Run the following command to list all the instances in the project:

   ```
   gcloud compute instances list
   ```

4. Identify the instance running PostgreSQL and note down its name.

5. Run the following command to SSH into the instance:

   ```
   gcloud compute ssh [INSTANCE_NAME]
   ```

   Replace [INSTANCE_NAME] with the name of the instance running PostgreSQL.

6. Once you are logged into the instance, open the PostgreSQL configuration file using the following command:

   ```
   sudo nano /etc/postgresql/[POSTGRESQL_VERSION]/main/postgresql.conf
   ```

   Replace [POSTGRESQL_VERSION] with the version of PostgreSQL installed on the instance.

7. Look for the following line in the configuration file:

   ```
   #listen_addresses = 'localhost'
   ```

   Uncomment the line by removing the '#' at the beginning and change the value to 'localhost' as shown below:

   ```
   listen_addresses = 'localhost'
   ```

8. Save the changes to the configuration file by pressing Ctrl+O and then exit the editor by pressing Ctrl+X.

9. Restart the PostgreSQL service using the following command:

   ```
   sudo service postgresql restart
   ```

10. Exit the SSH session by typing 'exit' in the terminal.

11. Finally, run the following command to verify that the PostgreSQL port is not open:

    ```
    nmap -p 5432 localhost
    ```

    The output should show that the port is closed.

By following these steps, you have successfully remediated the PostgreSQL port open misconfiguration for GCP using GCP CLI.

#### Using Python

To remediate the PostgreSQL port open misconfiguration in GCP using Python, you can use the following steps:

1. Import the necessary libraries:

   ```
   from google.cloud import compute_v1
   import google.auth
   ```

2. Authenticate with Google Cloud:

   ```
   credentials, project = google.auth.default()
   compute = compute_v1.InstancesClient(credentials=credentials)
   ```

3. Define the project ID, zone, and instance name:

   ```
   project_id = 'your_project_id'
   zone = 'us-central1-a'
   instance_name = 'your_instance_name'
   ```

4. Get the instance details:

   ```
   instance = compute.get(project=project_id, zone=zone, instance=instance_name)
   ```

5. Check if the PostgreSQL port is open:

   ```
   postgresql_open = False
   for firewall in instance['networkInterfaces'][0]['accessConfigs'][0]['natIP']:
       if firewall['name'] == 'postgresql':
           postgresql_open = True
           break
   ```

6. If the PostgreSQL port is open, delete the firewall rule:

   ```
   if postgresql_open:
       firewall_body = {
           "name": "postgresql",
           "network": "global/networks/default",
           "direction": "INGRESS",
           "priority": 1000,
           "sourceRanges": ["0.0.0.0/0"],
           "allowed": [{
               "IPProtocol": "tcp",
               "ports": ["5432"]
           }]
       }
       compute.firewalls().delete(project=project_id, firewall='postgresql').execute()
   ```

   This will delete the firewall rule named "postgresql" that allows traffic on port 5432.

7. If the PostgreSQL port is not open, no action is required.

   ```
   else:
       print("PostgreSQL port is not open.")
   ```

   This will print a message indicating that the PostgreSQL port is not open.

   The complete Python code to remediate the PostgreSQL port open misconfiguration in GCP is as follows:

   ```
   from google.cloud import compute_v1
   import google.auth

   credentials, project = google.auth.default()
   compute = compute_v1.InstancesClient(credentials=credentials)

   project_id = 'your_project_id'
   zone = 'us-central1-a'
   instance_name = 'your_instance_name'

   instance = compute.get(project=project_id, zone=zone, instance=instance_name)

   postgresql_open = False
   for firewall in instance['networkInterfaces'][0]['accessConfigs'][0]['natIP']:
       if firewall['name'] == 'postgresql':
           postgresql_open = True
           break

   if postgresql_open:
       firewall_body = {
           "name": "postgresql",
           "network": "global/networks/default",
           "direction": "INGRESS",
           "priority": 1000,
           "sourceRanges": ["0.0.0.0/0"],
           "allowed": [{
               "IPProtocol": "tcp",
               "ports": ["5432"]
           }]
       }
       compute.firewalls().delete(project=project_id, firewall='postgresql').execute()
   else:
       print("PostgreSQL port is not open.")
   ``` 

   Replace the `your_project_id` and `your_instance_name` placeholders with the appropriate values for your GCP project and instance.


</Tab>
</Tabs>