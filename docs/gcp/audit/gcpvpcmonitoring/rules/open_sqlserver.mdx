---
slug: open_sqlserver
title: SQL Server Port Should Not Be Open
sidebar_label: SQL Server Port Should Not Be Open
---

### More Info:

Determines if TCP port 1433 or UDP port 1434 for SQL Server is open to the public.

### Risk Level

Medium

### Address

Security

### Compliance Standards

SOC2, GDPR, HIPAA, HITRUST, NISTCSF, PCIDSS, FedRAMP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account credentials.

2. Navigate to the VPC network: From the main navigation menu, click on "VPC Network" and then select "Firewall rules". This will display a list of all the firewall rules that are currently configured in your Google Cloud environment.

3. Check for open SQL Server ports: Look for any firewall rules that have the "tcp:1433" (default SQL Server port) specified in the "Protocols and ports" column. If such a rule exists, it means that the SQL Server port is open.

4. Verify the source range: Check the "Source IP ranges" column for the rule identified in the previous step. If the source range is set to "0.0.0.0/0", it means that the SQL Server port is open to the entire internet, which is a misconfiguration.

#### Using CLI

1. Install and authenticate Google Cloud SDK: Before you can start using the GCP CLI, you need to install the Google Cloud SDK on your local machine and authenticate it. You can download the SDK from the official Google Cloud website and authenticate it using the command `gcloud auth login`.

2. List all the firewall rules: Once you have the SDK installed and authenticated, you can list all the firewall rules in your project using the command `gcloud compute firewall-rules list`. This command will display a list of all the firewall rules in your project.

3. Filter the firewall rules for SQL Server port: SQL Server typically uses port 1433 for connections. You can filter the list of firewall rules for this port using the command `gcloud compute firewall-rules list --filter="allowed:1433"`. This command will display a list of all the firewall rules that allow traffic on port 1433.

4. Check the source ranges: For each of the firewall rules that allow traffic on port 1433, check the source ranges. If any of the source ranges is set to 0.0.0.0/0, it means that the SQL Server port is open to the entire internet. You can check the source ranges using the command `gcloud compute firewall-rules describe [FIREWALL_RULE_NAME]`, replacing `[FIREWALL_RULE_NAME]` with the name of each firewall rule.

#### Using Python

1. Import the necessary libraries: You will need the 'requests' library to send HTTP requests and 'json' to handle the JSON responses. You may also need 'os' to interact with the operating system.

```python
import requests
import json
import os
```

2. Set up the necessary variables: You will need the subscription ID, resource group, and server name for the SQL Server you want to check. You will also need a token for authentication. This can be obtained using the Azure CLI.

```python
subscription_id = 'your-subscription-id'
resource_group = 'your-resource-group'
server_name = 'your-server-name'

# Get the token
token = os.popen('az account get-access-token --query accessToken --output tsv').read()
```

3. Send a GET request to the Azure REST API: The URL for the request should be in the format `https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Sql/servers/{serverName}/firewallRules?api-version=2015-05-01-preview`. You will need to include the token in the headers for authentication.

```python
url = f"https://management.azure.com/subscriptions/{subscription_id}/resourceGroups/{resource_group}/providers/Microsoft.Sql/servers/{server_name}/firewallRules?api-version=2015-05-01-preview"

headers = {
    'Authorization': f'Bearer {token}',
    'Content-Type': 'application/json'
}

response = requests.get(url, headers=headers)
```

4. Check the response: The response will be in JSON format and will contain a list of all the firewall rules for the SQL Server. You can parse this to check if the SQL Server port (usually 1433) is open.

```python
firewall_rules = json.loads(response.text)

for rule in firewall_rules['value']:
    if rule['properties']['startIpAddress'] <= '0.0.0.0' and rule['properties']['endIpAddress'] >= '255.255.255.255':
        print(f"SQL Server port is open in the rule: {rule['name']}")
```

This script will print a message for each firewall rule where the SQL Server port is open. If no such rules exist, it will not print anything.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the SQL Server Port Should Not Be Open misconfiguration in GCP using GCP console, follow these steps:

1. Go to the GCP console and select the project where the misconfiguration exists.
2. Navigate to the VPC network page and select the VPC network where the SQL Server instance is running.
3. Select the Firewall rules tab.
4. Identify the firewall rule that allows access to the SQL Server port (default port is 1433).
5. Click on the Edit button to modify the firewall rule.
6. In the Source filter section, select the IP ranges that are allowed to access the SQL Server port.
7. If the SQL Server instance is only accessed from within the VPC network, select the VPC network as the source filter.
8. If the SQL Server instance is accessed from outside the VPC network, select the appropriate IP ranges for the source filter.
9. Save the changes to the firewall rule.

By following these steps, you have successfully remediated the SQL Server Port Should Not Be Open misconfiguration in GCP using GCP console.

#### Using CLI

To remediate an SQL Server port being open in GCP using GCP CLI, follow these steps:

1. Open the Google Cloud Console and navigate to the Compute Engine page.

2. Identify the instance with the open SQL Server port.

3. Connect to the instance using SSH.

4. Run the following command to list the firewall rules:

   ```
   gcloud compute firewall-rules list
   ```

5. Identify the firewall rule that allows the SQL Server port to be open.

6. Run the following command to delete the firewall rule:

   ```
   gcloud compute firewall-rules delete [FIREWALL_RULE_NAME]
   ```

   Replace `[FIREWALL_RULE_NAME]` with the name of the firewall rule that allows the SQL Server port to be open.

7. Verify that the firewall rule has been deleted by running the following command:

   ```
   gcloud compute firewall-rules list
   ```

   The output should not include the firewall rule that allowed the SQL Server port to be open.

8. Once the firewall rule has been deleted, the SQL Server port will no longer be open. You can verify this by attempting to connect to the SQL Server port from a remote machine.

#### Using Python

To remediate the SQL Server Port Should Not Be Open misconfiguration in GCP using Python, you can follow these steps:

1. Connect to the Google Cloud Platform using the Google Cloud SDK.

2. Use the Google Cloud Python client library to create a firewall rule that blocks all incoming traffic to the SQL Server port. Here's an example code snippet to create a firewall rule:

```
from google.cloud import compute_v1

# Set the project ID and region
project_id = 'your-project-id'
region = 'your-region'

# Create the firewall rule
client = compute_v1.FirewallsClient()
firewall_rule_body = {
    "name": "block-sql-server-port",
    "network": f"projects/{project_id}/global/networks/default",
    "direction": "INGRESS",
    "priority": 1000,
    "action": "deny",
    "rules": [
        {
            "protocol": "tcp",
            "ports": ["1433"]
        }
    ],
    "target_tags": ["sql-server"]
}
response = client.insert(project=project_id, firewall_resource=firewall_rule_body)
```

In the above code snippet, replace `your-project-id` and `your-region` with your actual project ID and region. The `target_tags` field specifies the tags of the resources that should be blocked from accessing the SQL Server port.

3. Apply the `sql-server` tag to all the instances that are running SQL Server.

```
from google.cloud import compute_v1

# Set the project ID and region
project_id = 'your-project-id'
region = 'your-region'

# Set the instance name
instance_name = 'your-instance-name'

# Set the tags
tags = ["sql-server"]

# Update the tags for the instance
client = compute_v1.InstancesClient()
instance = client.get(project=project_id, zone=region + '-a', instance=instance_name)
instance.tags = tags
client.update(project=project_id, zone=region + '-a', instance=instance_name, instance_resource=instance)
```

In the above code snippet, replace `your-project-id`, `your-region`, and `your-instance-name` with your actual project ID, region, and instance name. The `tags` field specifies the tags that should be applied to the instance.

4. Verify that the firewall rule is working as expected by attempting to connect to the SQL Server port from a remote machine. The connection should be blocked.

These steps should remediate the SQL Server Port Should Not Be Open misconfiguration in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/vpc/docs/using-firewalls](https://cloud.google.com/vpc/docs/using-firewalls) 


</Tab>
</Tabs>