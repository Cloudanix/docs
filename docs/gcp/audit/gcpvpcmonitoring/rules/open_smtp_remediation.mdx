

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Google Cloud Console: Open your web browser and navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud credentials.

2. Navigate to VPC Network: From the left-hand side menu, click on "VPC Network" and then select "Firewall". This will display a list of all the firewall rules that are currently in place for your Google Cloud environment.

3. Check for SMTP Port: Look for any firewall rules that have "25" (the SMTP port) listed in the "ports and protocols" column. If such a rule exists, it means that the SMTP port is open.

4. Verify Source Range: Check the "Source IP ranges" column for the rule. If it is set to "0.0.0.0/0", it means that the SMTP port is open to the entire internet, which is a misconfiguration.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system. Once installed, authenticate it using the command:
   ```
   gcloud auth login
   ```
   This will open a new browser window where you can log in with your Google Cloud credentials.

2. List all the firewall rules in your project using the following command:
   ```
   gcloud compute firewall-rules list
   ```
   This command will return a list of all firewall rules in your project, including their names, network, direction of traffic, priority, source ranges, allowed protocols and ports, and if they are enabled or not.

3. Filter the list to only show rules that allow traffic on SMTP port (25) using the following command:
   ```
   gcloud compute firewall-rules list --filter="allowed:tcp:25"
   ```
   This command will return a list of all firewall rules that allow traffic on port 25. If no rules are returned, then the SMTP port is not open.

4. For each rule returned, check the source ranges to see if they include 0.0.0.0/0 (which means all IP addresses). You can do this by inspecting the 'source-ranges' column in the output of the previous command. If any rule allows traffic from 0.0.0.0/0 on port 25, then the SMTP port is open to the world.

#### Using Python

1. Import the necessary libraries: You will need the boto3 library for AWS, azure-mgmt-network for Azure, and google-cloud-network-connectivity for GCP. These libraries allow you to interact with the respective cloud services.

```python
import boto3
from azure.mgmt.network import NetworkManagementClient
from google.cloud import network_connectivity_v1
```

2. Create a function to check the security groups: For each cloud service, you will need to create a function that checks the security groups for open SMTP ports. Here's an example for AWS:

```python
def check_smtp_aws():
    ec2 = boto3.resource('ec2')
    for security_group in ec2.security_groups.all():
        for permission in security_group.ip_permissions:
            if permission['FromPort'] == 25 and permission['ToPort'] == 25:
                print(f"SMTP port is open in security group {security_group.id}")
```

3. Repeat the process for Azure and GCP: The process will be similar, but you will need to use the appropriate functions from the respective libraries. Here's an example for Azure:

```python
def check_smtp_azure():
    network_client = NetworkManagementClient(credentials, subscription_id)
    for security_group in network_client.network_security_groups.list_all():
        for rule in security_group.security_rules:
            if rule.destination_port_range == '25' and rule.access == 'Allow':
                print(f"SMTP port is open in security group {security_group.name}")
```

And for GCP:

```python
def check_smtp_gcp():
    client = network_connectivity_v1.NetworkManagementClient()
    for firewall in client.list_firewalls(project_id):
        for rule in firewall.allowed:
            if '25' in rule.ports and rule.IPProtocol == 'tcp':
                print(f"SMTP port is open in firewall {firewall.name}")
```

4. Run the functions: Finally, you can run these functions to check for open SMTP ports in all your cloud services.

```python
check_smtp_aws()
check_smtp_azure()
check_smtp_gcp()
```

This will print out any security groups or firewalls that have the SMTP port open.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the SMTP Port Should Not Be Open misconfiguration in GCP using the GCP console, follow these steps:

1. Log in to the GCP console (https://console.cloud.google.com/).
2. Navigate to the Cloud Console.
3. Select the project where the VM instance is running.
4. In the left-hand menu, click on "Compute Engine" and then "VM instances".
5. Locate the instance that has the open SMTP port and click on the name of the instance.
6. In the details pane, click on the "Edit" button at the top of the page.
7. Scroll down to the "Firewall" section and click on "Networking interfaces".
8. Locate the "default-allow-smtp" rule and click on the trash icon to delete the rule.
9. Click on the "Save" button at the bottom of the page to apply the changes.

Once you have completed these steps, the SMTP port should no longer be open on the VM instance.

#### Using CLI

To remediate the "SMTP Port Should Not Be Open" misconfiguration in GCP using GCP CLI, you can follow these steps:

1. Open the Cloud Shell in your GCP Console.
2. Run the following command to list all the firewall rules in your project: 

   ```gcloud compute firewall-rules list```
   
3. Identify the firewall rule that allows SMTP traffic. You can look for a rule that has a target tag that allows SMTP traffic, such as "allow-smtp".
4. Run the following command to delete the firewall rule:

   ```gcloud compute firewall-rules delete [FIREWALL_RULE_NAME]```
   
   Replace [FIREWALL_RULE_NAME] with the name of the firewall rule that allows SMTP traffic.
   
5. Confirm the deletion by typing "y" and pressing enter.
6. Verify that the firewall rule has been deleted by running the following command:

   ```gcloud compute firewall-rules list```
   
   You should no longer see the firewall rule that allows SMTP traffic.
   
By following these steps, you have successfully remediated the "SMTP Port Should Not Be Open" misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the SMTP Port Should Not Be Open misconfiguration in GCP using Python, follow the below steps:

1. First, you need to identify the instance(s) in your GCP project that has SMTP Port open. You can use the following command in the Cloud Shell to list all the instances in your project:

```
gcloud compute instances list
```

2. Once you have identified the instance(s) with open SMTP Port, you need to connect to the instance(s) using SSH. You can use the following command to connect to an instance:

```
gcloud compute ssh [INSTANCE_NAME]
```

3. After you have connected to the instance, you need to check if the SMTP service is running. You can use the following command to check the status of the SMTP service:

```
sudo systemctl status postfix
```

4. If the SMTP service is running, you need to stop it using the following command:

```
sudo systemctl stop postfix
```

5. After stopping the SMTP service, you need to disable it so that it does not start automatically on system startup. You can use the following command to disable the SMTP service:

```
sudo systemctl disable postfix
```

6. Finally, you need to close the SMTP port by modifying the firewall rules. You can use the following command to close the SMTP port:

```
gcloud compute firewall-rules update [FIREWALL_RULE_NAME] --action deny --rules tcp:25
```

Replace [FIREWALL_RULE_NAME] with the name of the firewall rule that allows SMTP traffic.

7. Once you have completed the above steps, you can exit the SSH session using the following command:

```
exit
```

By following the above steps, you can remediate the SMTP Port Should Not Be Open misconfiguration in GCP using Python.


</Tab>
</Tabs>