

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to your Google Cloud Platform (GCP) console.

2. Navigate to the "VPC network" section under the "Networking" category. Here, you will find all the VPC networks in your GCP environment.

3. Select the VPC network you want to inspect. Click on the "Firewall rules" tab to view all the firewall rules associated with the selected VPC network.

4. Look for any firewall rules that allow inbound traffic to port 22 (SSH). The "Protocols / ports" column will show you the ports that are open for each rule. If you find a rule that allows traffic to port 22 from any source (0.0.0.0/0), then the SSH port is open to the world, which is a misconfiguration.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and authenticated, you can list all the firewall rules in your project by running the following command in your terminal:

   ```
   gcloud compute firewall-rules list
   ```

3. To check if SSH port is open, you can filter the output of the above command for rules that allow traffic on port 22 (the default SSH port). You can do this by using the following command:

   ```
   gcloud compute firewall-rules list --format="table(name, network, direction, priority, sourceRanges.list(), allowed[].map().firewall_rule().list(), targetTags.list())" | grep 'tcp:22'
   ```

4. If the above command returns any rules, it means that the SSH port is open in your network. The details of the rules will give you more information about which networks and IP ranges have access to the SSH port.

#### Using Python

1. AWS:

- Install and configure AWS CLI and Boto3 Python SDK.
- Use the following Python script to check if SSH port is open:

```python
import boto3
ec2 = boto3.resource('ec2')
for security_group in ec2.security_groups.all():
    for permission in security_group.ip_permissions:
        if permission['FromPort'] == 22 and permission['ToPort'] == 22:
            print("Security Group: {} has SSH port 22 open".format(security_group.group_name))
```

2. Azure:

- Install and configure Azure CLI and Azure Python SDK.
- Use the following Python script to check if SSH port is open:

```python
from azure.mgmt.network import NetworkManagementClient
from azure.common.credentials import ServicePrincipalCredentials

credentials = ServicePrincipalCredentials(
    client_id = 'client_id',
    secret = 'secret',
    tenant = 'tenant'
)

network_client = NetworkManagementClient(credentials, 'subscription_id')

for item in network_client.network_security_groups.list_all():
    for rule in network_client.security_rules.list(item.resource_group, item.name):
        if rule.destination_port_range == '22':
            print("Security Group: {} has SSH port 22 open".format(item.name))
```

3. GCP:

- Install and configure GCP CLI and Google Cloud Python SDK.
- Use the following Python script to check if SSH port is open:

```python
from google.cloud import securitycenter_v1

client = securitycenter_v1.SecurityCenterClient()

organization_id = 'organization_id'
source_name = client.organization_source_path(organization_id, '-')

for finding in client.list_findings(source_name):
    if '22' in finding.finding.source_properties['network']:
        print("Security Group: {} has SSH port 22 open".format(finding.finding.source_properties['network']))
```

Please replace 'client_id', 'secret', 'tenant', 'subscription_id', and 'organization_id' with your actual credentials.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the SSH port open misconfiguration in GCP using the GCP console, follow the below steps:

1. Login to the GCP console (https://console.cloud.google.com/).
2. Navigate to the Compute Engine section.
3. Select the instance where the SSH port is open.
4. Click on the "Edit" button at the top of the page.
5. Scroll down to the "Firewall" section and click on "Management, security, disks, networking, sole tenancy".
6. Under the "Firewall" section, click on "Networking".
7. In the "Firewall rules" section, find the firewall rule that is allowing SSH access (usually named "default-allow-ssh").
8. Click on the checkbox next to the rule to select it.
9. Click on the "Delete" button at the top of the page.
10. Confirm the deletion by clicking on the "Delete" button in the confirmation dialog box.

Once the firewall rule allowing SSH access is deleted, the SSH port will no longer be open, and the misconfiguration will be remediated.

#### Using CLI

To remediate the SSH port open misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the GCP CLI and connect to your project.

2. Run the following command to list all the instances in your project:

   ```
   gcloud compute instances list
   ```

3. Identify the instance for which you want to remediate the misconfiguration.

4. Run the following command to get the details of the instance:

   ```
   gcloud compute instances describe [INSTANCE_NAME]
   ```

   Replace `[INSTANCE_NAME]` with the name of your instance.

5. Look for the `metadata` section in the output. If you see a `ssh-keys` entry, then SSH port is open. To remediate this, delete the `ssh-keys` entry.

6. Run the following command to delete the `ssh-keys` entry:

   ```
   gcloud compute instances remove-metadata [INSTANCE_NAME] --keys ssh-keys
   ```

   Replace `[INSTANCE_NAME]` with the name of your instance.

7. Verify that the `ssh-keys` entry has been deleted by running the `gcloud compute instances describe` command again.

   ```
   gcloud compute instances describe [INSTANCE_NAME]
   ```

   You should not see the `ssh-keys` entry in the output.

8. Repeat steps 4-7 for all the instances in your project to ensure that SSH port is not open on any of them.

By following these steps, you can remediate the SSH port open misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the SSH port being open misconfiguration in GCP using Python, you can follow these steps:

1. Import the necessary libraries:

```python
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials
```

2. Set up authentication credentials:

```python
credentials = GoogleCredentials.get_application_default()
service = discovery.build('compute', 'v1', credentials=credentials)
```

3. Retrieve the project ID:

```python
project = 'your-project-id'
```

4. Retrieve the list of instances:

```python
instances = service.instances().list(project=project, zone='us-central1-a').execute()
```

Note: Replace the zone with the appropriate zone for your instance.

5. Loop through the instances and update the firewall rules to restrict SSH access:

```python
for instance in instances['items']:
    instance_name = instance['name']
    instance_zone = instance['zone'].split('/')[-1]
    firewall_name = 'ssh-' + instance_name
    firewall_body = {
        'allowed': [],
        'description': 'Restrict SSH access to specified IP ranges',
        'name': firewall_name,
        'network': 'default',
        'priority': 1000,
        'sourceRanges': [
            '0.0.0.0/0'
        ],
        'targetTags': [
            instance_name
        ]
    }
    firewall = service.firewalls().insert(project=project, body=firewall_body).execute()
    print('Firewall rule created for instance {}: {}'.format(instance_name, firewall['id']))
```

Note: This code creates a new firewall rule for each instance to restrict SSH access to specified IP ranges. You can modify the `sourceRanges` parameter to specify the IP ranges that should be allowed to access SSH.

6. Remove the existing firewall rule that allows SSH access:

```python
firewall_name = 'default-allow-ssh'
firewall = service.firewalls().delete(project=project, firewall=firewall_name).execute()
print('Firewall rule deleted: {}'.format(firewall_name))
```

Note: This code removes the default firewall rule that allows SSH access from any IP address.

7. Verify that the firewall rules have been updated:

```python
firewalls = service.firewalls().list(project=project).execute()
for firewall in firewalls['items']:
    print(firewall['name'], firewall['sourceRanges'])
```

Note: This code lists all the firewall rules in the project and their associated source IP ranges. You should see that the new firewall rules restrict SSH access to specified IP ranges.


</Tab>
</Tabs>