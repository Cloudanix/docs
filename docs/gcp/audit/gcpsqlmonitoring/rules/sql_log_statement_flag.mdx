---
slug: sql_log_statement_flag
title: PostgreSQL Log Statement Flag Should Be Set Appropriately
sidebar_label: PostgreSQL Log Statement Flag Should Be Set Appropriately
---

### More Info:

The value of log_statement flag determined the SQL statements that are logged. Valid values are: • none • ddl • mod • all The value ddl logs all data definition statements. The value mod logs all ddl statements, plus data-modifying statements. The statements are logged after a basic parsing is done and statement type is determined, thus this does not logs statements with errors. When using extended query protocol, logging occurs after an Execute message is received and values of the Bind parameters are included. A value of 'ddl' is recommended unless otherwise directed by your organization's logging policy.

### Risk Level

Low

### Address

Reliability, Security

### Compliance Standards

CISGCP, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access the database resources.

2. Navigate to SQL Instances: From the main navigation menu, click on "SQL" under the "Storage" section. This will take you to the SQL instances page where you can see all your SQL databases.

3. Select the PostgreSQL Instance: From the list of SQL instances, click on the PostgreSQL instance for which you want to check the log statement flag.

4. Check the Log Statement Flag: Once you are in the instance details page, click on the "Configuration" tab. Scroll down to the "Flags" section. Here, look for the "log_statement" flag. If it is set to "all", it means that all SQL statements are being logged, which may not be appropriate depending on your use case. If it is set to "none", it means no statements are being logged, which could also be a misconfiguration. The appropriate setting is usually "ddl" or "mod", which logs only data definition language (DDL) or data modification language (DML) statements respectively.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK CLI. You can download it from the official Google Cloud website and follow the instructions to install it on your local machine. Once installed, you can authenticate your account using the command `gcloud auth login`.

2. After setting up the Google Cloud SDK CLI, you can list all the SQL instances in your GCP project using the following command: `gcloud sql instances list`. This command will return a list of all SQL instances along with their details.

3. To check the PostgreSQL Log Statement Flag for a specific instance, you need to describe the instance using the following command: `gcloud sql instances describe [INSTANCE_NAME]`. Replace `[INSTANCE_NAME]` with the name of your SQL instance. This command will return a detailed description of the SQL instance including its configuration.

4. In the output of the previous command, look for the `settings` section. Under this section, you should find a `databaseFlags` field. This field contains a list of all flags set for the SQL instance. Check if the `log_statement` flag is present in this list and note its value. The `log_statement` flag should be set to `ddl` or `mod` to log all data definition language (DDL) statements or data modification language (DML) statements respectively. If the flag is not present or set to a different value, then the PostgreSQL Log Statement Flag is not set appropriately.

#### Using Python

1. Connect to PostgreSQL Database:
   First, you need to connect to your PostgreSQL database. You can use the psycopg2 library in Python to connect to PostgreSQL. Here is a sample script to connect to the database:

   ```python
   import psycopg2
   try:
       connection = psycopg2.connect(user = "your_username",
                                     password = "your_password",
                                     host = "your_host",
                                     port = "your_port",
                                     database = "your_database")
       cursor = connection.cursor()
   except (Exception, psycopg2.Error) as error :
       print ("Error while connecting to PostgreSQL", error)
   ```

2. Check the Log Statement Flag:
   Once you are connected to the database, you can check the log_statement flag by executing the SHOW command. The log_statement flag can be set to 'all', 'mod', 'ddl', 'none'. If it is set to 'all', it means all statements are logged, which may not be appropriate due to the volume of logs generated and potential performance impact.

   ```python
   try:
       cursor.execute("SHOW log_statement;")
       record = cursor.fetchone()
       print("You are connected to - ", record,"\n")
   except (Exception, psycopg2.Error) as error:
       print("Error fetching data from PostgreSQL table", error)
   ```

3. Analyze the Result:
   The result of the above script will give you the current setting of the log_statement flag. If it is set to 'all', it means all statements are logged, which may not be appropriate due to the volume of logs generated and potential performance impact.

4. Close the Connection:
   Always remember to close the database connection once your work is done. Not closing the connection could lead to connection memory leakage. Here is how you can close the connection:

   ```python
   if(connection):
       cursor.close()
       connection.close()
       print("PostgreSQL connection is closed")
   ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the PostgreSQL Log Statement Flag misconfiguration in GCP using GCP console, please follow the steps below:

1. Login to your GCP console and select the project where the PostgreSQL instance is located.
2. In the navigation menu, select SQL under the Storage section.
3. Select the PostgreSQL instance where the misconfiguration exists.
4. Click on the Edit button at the top of the page.
5. Scroll down to the Flags section and look for the log_statement flag.
6. Set the log_statement flag to one of the following values based on your requirements:
   - none: Disables logging of all statements
   - ddl: Logs only data definition language (DDL) statements
   - mod: Logs only statements that modify data (INSERT, UPDATE, DELETE)
   - all: Logs all statements (default)
7. Once you have set the log_statement flag appropriately, click on the Save button at the bottom of the page.
8. Wait for a few minutes for the changes to take effect.

That's it! You have successfully remediated the PostgreSQL Log Statement Flag misconfiguration in GCP using GCP console.

#### Using CLI

To remediate the PostgreSQL log statement flag misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in your GCP console.
2. Run the following command to list all the instances in your project:
   ```
   gcloud sql instances list
   ```
3. Identify the instance that has the PostgreSQL log statement flag misconfiguration.
4. Run the following command to get the current flags of the instance:
   ```
   gcloud sql instances describe [INSTANCE_NAME]
   ```
   Replace [INSTANCE_NAME] with the name of the instance that you identified in step 3.
5. Look for the `databaseFlags` field in the output of the previous command. This field contains a list of flags that are currently set for the instance.
6. Check if the `log_statement` flag is set to `all`. If it is not set to `all`, then it is misconfigured.
7. To set the `log_statement` flag to `all`, run the following command:
   ```
   gcloud sql instances patch [INSTANCE_NAME] --database-flags log_statement=all
   ```
   Replace [INSTANCE_NAME] with the name of the instance that you identified in step 3.
8. Verify that the flag has been set correctly by running the `gcloud sql instances describe` command again and checking the `databaseFlags` field. The `log_statement` flag should now be set to `all`.

By following these steps, you should be able to remediate the PostgreSQL log statement flag misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the PostgreSQL Log Statement Flag misconfiguration in GCP using Python, follow these steps:

1. Install the `google-cloud-logging` library using pip: 

```
pip install google-cloud-logging
```

2. Create a service account with the necessary permissions to access the GCP project where the PostgreSQL instance is located. Download the JSON key file for the service account.

3. Set the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of the JSON key file:

```
export GOOGLE_APPLICATION_CREDENTIALS=/path/to/keyfile.json
```

4. Use the following Python code to set the PostgreSQL log_statement flag to `all`:

```python
from google.cloud import logging_v2
from google.oauth2 import service_account

# Set the PostgreSQL instance ID
instance_id = "my-postgres-instance"

# Set the log_statement flag to "all"
log_statement = "all"

# Authenticate using the service account key file
credentials = service_account.Credentials.from_service_account_file(
    "/path/to/keyfile.json"
)

# Create the Logging client
client = logging_v2.LoggingServiceV2Client(credentials=credentials)

# Create the log sink for the PostgreSQL instance
sink_name = f"projects/{client.project}/sinks/postgresql-{instance_id}"
sink = client.get_sink(sink_name)

# Update the sink's filter to include the log_statement flag
new_filter = f'resource.type="gce_instance" AND resource.labels.instance_id="{instance_id}" AND textPayload:"log_statement = {log_statement}"'
sink.filter = new_filter

# Update the sink in GCP
client.update_sink(sink=sink, update_mask={"paths": ["filter"]})
```

This code will update the log sink for the specified PostgreSQL instance to include the `log_statement = all` filter. This will ensure that all SQL statements executed on the instance are logged to the Cloud Logging service in GCP.




</Tab>
</Tabs>