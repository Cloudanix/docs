---
slug: sql_log_statement_stats_flag
title: PostgreSQL Log Statement Stats Flag Should Be Set Appropriately
sidebar_label: PostgreSQL Log Statement Stats Flag Should Be Set Appropriately
---

### More Info:

The log_statement_stats flag controls the inclusion of end to end performance statistics of a SQL query in the PostgreSQL logs for each query. This cannot be enabled with other module statistics (log_parser_stats, log_planner_stats, log_executor_stats). Default value for log_statement_stats flag is off. The log_statement_stats flag enables a crude profiling method for logging end to end performance statistics of a SQL query. This can be useful for troubleshooting but may increase the amount of logs significantly and have performance overhead.

### Risk Level

Low

### Address

Reliability, Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (https://console.cloud.google.com/) and sign in with your Google account credentials.

2. Navigate to SQL Instances: From the left-hand side menu, select "SQL" under the "Storage" section. This will display a list of all SQL instances in your GCP account.

3. Select the PostgreSQL Instance: Click on the name of the PostgreSQL instance for which you want to check the Log Statement Stats Flag.

4. Check the Flag Settings: In the instance details page, click on the "Configuration" tab. Scroll down to the "Flags" section. Here, you can see all the flags set for your PostgreSQL instance. Look for the "log_statement_stats" flag. If it is set to "on", it means that the Log Statement Stats Flag is set appropriately. If it is not present or set to "off", it indicates a misconfiguration.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, authenticate it using the command:
   ```
   gcloud auth login
   ```
   This will open a new browser window where you can log in with your Google Cloud credentials.

2. List all the SQL instances in your project using the following command:
   ```
   gcloud sql instances list
   ```
   This will display a list of all SQL instances in your project. Note down the INSTANCE_NAME of the PostgreSQL instance you want to check.

3. Get the details of the specific PostgreSQL instance using the following command:
   ```
   gcloud sql instances describe INSTANCE_NAME
   ```
   Replace INSTANCE_NAME with the name of your PostgreSQL instance. This will display the details of the instance including its configuration.

4. Check the "settings" section in the output of the above command. Look for the "databaseFlags" field. If the "log_statement_stats" flag is set to "on", then the PostgreSQL Log Statement Stats Flag is set appropriately. If it's not present or set to "off", then it's a misconfiguration.

#### Using Python

To check PostgreSQL Log Statement Stats Flag in SQL using python scripts, you can follow these steps:

1. **Connect to PostgreSQL Database:**
   First, you need to connect to your PostgreSQL database. You can use the `psycopg2` library in Python to do this. Here is a sample script:

   ```python
   import psycopg2

   try:
       connection = psycopg2.connect(user="sysadmin",
                                      password="pynative@#29",
                                      host="127.0.0.1",
                                      port="5432",
                                      database="postgres_db")

       cursor = connection.cursor()
       print("You are connected to - ", cursor.get_dsn_parameters(),"\n")

   except (Exception, psycopg2.Error) as error :
       print ("Error while connecting to PostgreSQL", error)
   ```

2. **Query the PostgreSQL Configuration:**
   Once you are connected to the database, you can query the PostgreSQL configuration to check the status of the Log Statement Stats Flag. You can use the `SHOW` command to do this. Here is a sample script:

   ```python
   cursor.execute("SHOW log_statement_stats;")
   record = cursor.fetchone()
   print("Log Statement Stats Flag - ", record,"\n")
   ```

3. **Check the Status of the Flag:**
   The `SHOW` command will return the current setting of the Log Statement Stats Flag. You can check this value to see if it is set appropriately. If the flag is set to 'on', it means that the stats are being logged. If it is set to 'off', it means that the stats are not being logged.

4. **Close the Connection:**
   After you have checked the status of the flag, you should close the connection to the database. Here is a sample script:

   ```python
   if(connection):
       cursor.close()
       connection.close()
       print("PostgreSQL connection is closed")
   ```

Remember to replace the connection parameters with your actual database credentials. Also, note that this script assumes that you have the necessary permissions to query the PostgreSQL configuration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "PostgreSQL Log Statement Stats Flag Should Be Set Appropriately" for GCP using GCP console, you can follow the below steps:

1. Open the Cloud SQL instances page in the GCP console.
2. Select the instance for which you want to remediate the misconfiguration.
3. Click on the "Edit" button at the top of the page.
4. In the "Flags" section, click on the "Add item" button.
5. Enter the flag name "log_statement_stats" and set its value to "on".
6. Click on the "Save" button to save the changes.

This will remediate the misconfiguration "PostgreSQL Log Statement Stats Flag Should Be Set Appropriately" for GCP using GCP console.

#### Using CLI

To remediate the PostgreSQL Log Statement Stats Flag misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in your GCP project.

2. Run the following command to list all the instances in your project:
   
   ```
   gcloud sql instances list
   ```

3. Identify the instance that has PostgreSQL database engine.

4. Run the following command to update the PostgreSQL flags for the identified instance:
   
   ```
   gcloud sql instances patch [INSTANCE_NAME] --database-flags log_statement_stats=on
   ```
   
   Replace `[INSTANCE_NAME]` with the name of the identified instance.

5. Verify the PostgreSQL flags by running the following command:
   
   ```
   gcloud sql instances describe [INSTANCE_NAME]
   ```
   
   Replace `[INSTANCE_NAME]` with the name of the identified instance.

   The output of the command should show that the `log_statement_stats` flag is set to `on`.

By following these steps, you have successfully remediated the PostgreSQL Log Statement Stats Flag misconfiguration for GCP using GCP CLI.

#### Using Python

To remediate the PostgreSQL Log Statement Stats Flag misconfiguration in GCP using Python, follow these steps:

1. Install the `google-cloud-secret-manager` and `google-cloud-secret-manager` libraries using pip:

```
pip install google-cloud-secret-manager google-auth
```

2. Authenticate to GCP using a service account:

```
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('/path/to/service_account.json')
```

3. Retrieve the PostgreSQL instance connection string and credentials from GCP Secret Manager:

```
from google.cloud import secretmanager

client = secretmanager.SecretManagerServiceClient(credentials=credentials)
name = client.secret_version_path('<project-id>', '<secret-name>', '<version>')
response = client.access_secret_version(name)
secrets = response.payload.data.decode('UTF-8')

# Extract the connection string and credentials from the secrets
connection_string = secrets['connection_string']
username = secrets['username']
password = secrets['password']
```

4. Connect to the PostgreSQL instance using the `psycopg2` library:

```
import psycopg2

conn = psycopg2.connect(connection_string, user=username, password=password)
```

5. Set the `log_statement_stats` parameter to `on`:

```
cur = conn.cursor()
cur.execute("SET log_statement_stats TO on;")
conn.commit()
```

6. Close the database connection:

```
cur.close()
conn.close()
```

By following these steps, you will have successfully remediated the PostgreSQL Log Statement Stats Flag misconfiguration in GCP using Python.




</Tab>
</Tabs>