

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to your browser and enter the GCP console URL. Enter your login credentials to access your GCP account.

2. Navigate to SQL Instances: From the GCP console dashboard, click on the navigation menu (three horizontal lines on the top left corner of the screen). Scroll down and click on "SQL" under the "Storage" section. This will display all the SQL instances in your GCP account.

3. Select the PostgreSQL instance: From the list of SQL instances, select the PostgreSQL instance you want to check for the misconfiguration. Click on the instance name to open its details.

4. Check the flag status: In the instance details page, click on the "Flags" tab. Look for the "external scripts enabled" flag. If the flag is set to "ON", it indicates that the PostgreSQL external scripts are enabled, which is a misconfiguration. If the flag is not present or set to "OFF", it means the external scripts are not enabled.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system. Once installed, authenticate it using the following command:

   ```
   gcloud auth login
   ```

2. Set your project ID to the project you want to check. Replace `your-project-id` with your actual project ID:

   ```
   gcloud config set project your-project-id
   ```

3. List all the SQL instances in your project using the following command:

   ```
   gcloud sql instances list
   ```

4. For each instance, check the PostgreSQL external scripts enabled flag. Replace `your-instance-name` with the name of your instance:

   ```
   gcloud sql instances describe your-instance-name
   ```

   In the output, look for the `databaseFlags` section. If the `external scripts enabled` flag is set to `on`, then it is misconfigured. If it is not present or set to `off`, then it is correctly configured.

#### Using Python

1. Install the necessary Python libraries: To interact with Azure SQL Database, you need to install the `pyodbc` and `azure-identity` libraries. You can install these using pip:

```python
pip install pyodbc azure-identity
```

2. Establish a connection to the Azure SQL Database: Use the `pyodbc` library to establish a connection. You'll need your database's server name, database name, and your Azure AD credentials.

```python
import pyodbc
from azure.identity import DefaultAzureCredential

credential = DefaultAzureCredential()

conn = pyodbc.connect(
    "Driver={ODBC Driver 17 for SQL Server};"
    "Server=tcp:your_server_name.database.windows.net,1433;"
    "Database=your_database_name;"
    "Authentication=ActiveDirectoryDeviceCodeFlow;"
    "UID=your_username;"
    "PWD=your_password;"
)
```

3. Query the database for the external scripts enabled flag: You can use the `sp_configure` stored procedure to check the value of the 'external scripts enabled' configuration. If the value is 1, then external scripts are enabled.

```python
cursor = conn.cursor()
cursor.execute("EXEC sp_configure 'external scripts enabled'")
row = cursor.fetchone()
while row:
    print(row)
    row = cursor.fetchone()
```

4. Analyze the output: The output of the above script will be a row for each configuration setting. The 'external scripts enabled' row will have a 'value' column. If the value is 1, then external scripts are enabled, which is a misconfiguration. If the value is 0, then external scripts are disabled, which is the correct configuration.

Note: Replace 'your_server_name', 'your_database_name', 'your_username', and 'your_password' with your actual Azure SQL Database server name, database name, username, and password.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the PostgreSQL External Scripts Enabled Flag Should Be Off misconfiguration for GCP using GCP console, follow these steps:

1. Open the GCP Console and navigate to the Cloud SQL instances page.
2. Select the PostgreSQL instance you want to remediate.
3. Click on the "Edit" button at the top of the page.
4. Scroll down to the "Flags" section.
5. Locate the "external-scripts-enabled" flag and set it to "off".
6. Click on the "Save" button at the bottom of the page to save the changes.

After completing these steps, the PostgreSQL External Scripts Enabled Flag will be turned off, and the misconfiguration will be remediated.

#### Using CLI

To remediate the PostgreSQL External Scripts Enabled Flag misconfiguration for GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to list all the Cloud SQL instances in your GCP project:

   ```
   gcloud sql instances list
   ```

3. Identify the instance for which you want to remediate the PostgreSQL External Scripts Enabled Flag misconfiguration.

4. Run the following command to update the instance configuration:

   ```
   gcloud sql instances patch [INSTANCE_NAME] --database-flags=external_scripting=false
   ```

   Replace [INSTANCE_NAME] with the name of your Cloud SQL instance.

5. Confirm the update by running the following command:

   ```
   gcloud sql instances describe [INSTANCE_NAME]
   ```

   This will display the details of your Cloud SQL instance, including the updated configuration.

By following these steps, you can remediate the PostgreSQL External Scripts Enabled Flag misconfiguration for GCP using GCP CLI.

#### Using Python

To remediate the PostgreSQL External Scripts Enabled Flag misconfiguration on GCP using Python, you can follow the below steps:

1. Connect to the GCP project using the `google-auth` and `google-cloud-secret-manager` libraries. 

```python
from google.auth import credentials
from google.cloud import secretmanager

# Set up credentials
credentials, project_id = google.auth.default()
client = secretmanager.SecretManagerServiceClient(credentials=credentials)
```

2. Retrieve the PostgreSQL instance name and configuration details from the GCP Secret Manager.

```python
# Retrieve PostgreSQL instance name and configuration details from Secret Manager
name = "projects/{project_id}/secrets/{secret_name}/versions/latest".format(
    project_id=project_id,
    secret_name="postgres-config"
)
response = client.access_secret_version(name=name)
config = json.loads(response.payload.data.decode("UTF-8"))
```

3. Connect to the PostgreSQL instance using the `psycopg2` library.

```python
import psycopg2

# Connect to PostgreSQL instance
conn = psycopg2.connect(
    host=config["host"],
    port=config["port"],
    dbname=config["dbname"],
    user=config["user"],
    password=config["password"]
)
```

4. Disable the External Scripts Enabled flag by updating the `postgresql.conf` file.

```python
# Disable External Scripts Enabled flag
with conn.cursor() as cursor:
    cursor.execute("ALTER SYSTEM SET external_scripts_enabled TO off;")
    conn.commit()
```

5. Restart the PostgreSQL instance for the changes to take effect.

```python
# Restart PostgreSQL instance
with conn.cursor() as cursor:
    cursor.execute("SELECT pg_reload_conf();")
    conn.commit()
```

By following these steps, you can remediate the PostgreSQL External Scripts Enabled Flag misconfiguration on GCP using Python.


</Tab>
</Tabs>