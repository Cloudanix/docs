---
slug: sql_log_min_messages_flag
title: PostgreSQL Log Min Messages Flag Should Be Disabled
sidebar_label: PostgreSQL Log Min Messages Flag Should Be Disabled
---

### More Info:

Ensure that the log_min_messages database flag for Cloud SQL PostgreSQL instance is set appropriately.

### Risk Level

Low

### Address

Security

### Compliance Standards

CISGCP, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to the GCP console (console.cloud.google.com) and sign in with your Google account that has the necessary permissions to access the database services.

2. Navigate to SQL instances: From the GCP console dashboard, click on the hamburger menu on the top left corner. Scroll down and click on "SQL" under the "Storage" section. This will take you to the SQL instances page where you can see all your SQL instances.

3. Select the PostgreSQL instance: From the list of SQL instances, click on the PostgreSQL instance for which you want to check the Log Min Messages Flag.

4. Check the flag: Once you are in the instance details page, click on the "Configuration" tab. Scroll down to the "Flags" section. Here, look for the "log_min_messages" flag. If it is set to a value other than "DISABLED", then the flag is not disabled.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install and authenticate it.

2. Once the Google Cloud SDK is installed and configured, you can list all the SQL instances in your GCP project by running the following command in your terminal:

   ```
   gcloud sql instances list
   ```

   This command will return a list of all SQL instances in your project, including their names, regions, and other details.

3. To check the configuration of a specific SQL instance, you can use the following command:

   ```
   gcloud sql instances describe [INSTANCE_NAME]
   ```

   Replace `[INSTANCE_NAME]` with the name of the SQL instance you want to check. This command will return a detailed description of the SQL instance, including its configuration.

4. In the output of the previous command, look for the `settings.databaseFlags.log_min_messages` field. If this field is set to a value other than `ERROR`, `FATAL`, or `PANIC`, then the PostgreSQL Log Min Messages flag is not disabled.

#### Using Python

To check if the PostgreSQL Log Min Messages Flag is disabled in SQL using Python scripts, you can follow these steps:

1. **Connect to PostgreSQL Database:**
   First, you need to connect to your PostgreSQL database. You can use the `psycopg2` library in Python to do this. Here is a sample script:

   ```python
   import psycopg2

   try:
       connection = psycopg2.connect(user = "your_username",
                                     password = "your_password",
                                     host = "your_host",
                                     port = "your_port",
                                     database = "your_database")

       cursor = connection.cursor()
   except (Exception, psycopg2.Error) as error :
       print ("Error while connecting to PostgreSQL", error)
   ```

2. **Execute SQL Query:**
   After successfully connecting to the database, you can execute an SQL query to check the status of the `log_min_messages` configuration. Here is a sample script:

   ```python
   try:
       postgreSQL_select_Query = "SHOW log_min_messages;"

       cursor.execute(postgreSQL_select_Query)
       print("Selecting rows from mobile table using cursor.fetchall")
       mobile_records = cursor.fetchall() 
   
       print("Print each row and it's columns values")
       for row in mobile_records:
           print("Value = ", row[0], "\n")
   
   except (Exception, psycopg2.Error) as error :
       print ("Error while fetching data from PostgreSQL", error)
   ```

3. **Check the Value:**
   The value of `log_min_messages` should be `ERROR`, `FATAL`, or `PANIC` to be considered as disabled. You can add a condition in your script to check this:

   ```python
   if mobile_records[0][0] in ['ERROR', 'FATAL', 'PANIC']:
       print("PostgreSQL Log Min Messages Flag is disabled.")
   else:
       print("PostgreSQL Log Min Messages Flag is enabled.")
   ```

4. **Close the Connection:**
   Finally, don't forget to close the connection to the database once you're done:

   ```python
   if(connection):
       cursor.close()
       connection.close()
       print("PostgreSQL connection is closed")
   ```

This script will help you detect if the PostgreSQL Log Min Messages Flag is disabled in SQL.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the PostgreSQL log_min_messages flag misconfiguration in GCP, you can follow the below steps using the GCP console:

1. Open the Cloud SQL instances page in the GCP console.
2. Select the instance that you want to remediate.
3. Click on the "Edit" button at the top of the page.
4. Scroll down to the "Flags" section and click on "Add item".
5. In the "Flag name" field, enter "log_min_messages".
6. In the "Flag value" field, enter "WARNING".
7. Click on the "Save" button at the bottom of the page to save the changes.

This will set the log_min_messages flag to "WARNING" which will ensure that only warning messages and above are logged in the PostgreSQL logs.

#### Using CLI

To remediate the PostgreSQL Log Min Messages Flag Should Be Disabled misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in your GCP Console.

2. Connect to your GCP instance that has PostgreSQL installed using the following command:
```
gcloud compute ssh [INSTANCE_NAME]
```
Replace [INSTANCE_NAME] with the name of your instance.

3. Run the following command to open the PostgreSQL configuration file:
```
sudo nano /etc/postgresql/[POSTGRESQL_VERSION]/main/postgresql.conf
```
Replace [POSTGRESQL_VERSION] with the version of PostgreSQL installed on your instance.

4. Locate the line that starts with `log_min_messages` in the configuration file.

5. Change the value of `log_min_messages` to `WARNING` or higher. This will disable the flag and ensure that only warning messages or higher are logged.

6. Save the changes to the configuration file by pressing `CTRL + X`, then `Y`, then `ENTER`.

7. Restart the PostgreSQL service using the following command:
```
sudo service postgresql restart
```

8. Verify that the PostgreSQL Log Min Messages flag has been disabled by running the following command:
```
sudo su - postgres -c "psql -c 'SHOW log_min_messages;'"
```
This should return the new value of `log_min_messages`.

9. Exit the SSH session by running the following command:
```
exit
```

Your PostgreSQL Log Min Messages flag is now disabled and your instance is secured.

#### Using Python

To remediate the PostgreSQL Log Min Messages Flag misconfiguration in GCP using Python, you can follow the below steps:

1. First, you need to connect to the GCP project where the PostgreSQL instance is running. You can use the `google-cloud-sdk` and `google-auth` Python packages to authenticate and connect to the GCP project. 

```python
from google.oauth2 import service_account
from google.cloud import sql_v1beta4

# Authenticate using a service account key file
credentials = service_account.Credentials.from_service_account_file(
    '/path/to/service_account_key.json')

# Connect to the GCP project and get the SQL admin client
project_id = 'your-project-id'
location = 'us-central1'
client = sql_v1beta4.SqlAdminClient(credentials=credentials)
instance_name = 'your-instance-name'
instance_path = f"projects/{project_id}/locations/{location}/instances/{instance_name}"
```

2. Once you have connected to the GCP project and fetched the SQL admin client, you can get the current PostgreSQL instance configuration using the `get` method of the `instances` resource.

```python
# Get the current instance configuration
instance = client.instances().get(instance=instance_path).execute()
```

3. Check if the `log_min_messages` flag is enabled or not. If it is enabled, you need to update the instance configuration to disable it. 

```python
# Check if the log_min_messages flag is enabled
if 'postgresqlConf' in instance and 'log_min_messages' in instance['postgresqlConf']:
    if instance['postgresqlConf']['log_min_messages'] != 'ERROR':
        # Disable the log_min_messages flag
        instance['postgresqlConf']['log_min_messages'] = 'ERROR'
        # Update the instance configuration
        operation = client.instances().patch(
            instance=instance_path,
            body={'settings': instance['settings']}
        ).execute()
        # Wait for the operation to complete
        client.operations().wait(operation=operation['name']).execute()
        print(f"Successfully disabled log_min_messages flag for instance {instance_name}")
    else:
        print(f"log_min_messages flag is already disabled for instance {instance_name}")
else:
    print(f"log_min_messages flag is not set for instance {instance_name}")
```

4. After updating the instance configuration, you can verify if the `log_min_messages` flag is disabled or not by fetching the instance configuration again and checking the value of the flag.

```python
# Fetch the instance configuration again
instance = client.instances().get(instance=instance_path).execute()
# Check if the log_min_messages flag is disabled
if 'postgresqlConf' in instance and 'log_min_messages' in instance['postgresqlConf']:
    if instance['postgresqlConf']['log_min_messages'] == 'ERROR':
        print(f"log_min_messages flag is now disabled for instance {instance_name}")
    else:
        print(f"Failed to disable log_min_messages flag for instance {instance_name}")
else:
    print(f"log_min_messages flag is not set for instance {instance_name}")
```

By following the above steps, you can remediate the PostgreSQL Log Min Messages Flag misconfiguration in GCP using Python.




</Tab>
</Tabs>