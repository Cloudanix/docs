---
slug: sql_log_lock_waits_flag
title: PostgreSQL Log Lock Waits Flag Should Be Disabled
sidebar_label: PostgreSQL Log Lock Waits Flag Should Be Disabled
---

### More Info:

Ensure that the log_lock_waits database flag for Cloud SQL PostgreSQL instance is set to on.

### Risk Level

Medium

### Address

Security

### Compliance Standards

SOC2


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) Console: Open your web browser, navigate to the GCP Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to SQL Instances: From the GCP Console dashboard, click on the navigation menu (three horizontal lines in the upper left-hand corner), scroll down and click on "SQL" under the "Storage" section. This will take you to the SQL instances page where you can see all your SQL instances.

3. Select the PostgreSQL Instance: From the list of SQL instances, click on the PostgreSQL instance for which you want to check the Log Lock Waits flag. This will take you to the instance details page.

4. Check the Flags: In the instance details page, click on the "Configuration" tab. Scroll down to the "Flags" section. Here, you can see all the flags that are set for your PostgreSQL instance. Look for the "log_lock_waits" flag. If it is enabled, it means that the PostgreSQL Log Lock Waits flag is not disabled.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Once the SDK is installed and configured, you can list all the SQL instances in your GCP project by running the following command in your terminal:

   ```
   gcloud sql instances list
   ```

   This command will return a list of all SQL instances, including their names, project IDs, and other details.

3. To check the configuration of a specific SQL instance, you can use the following command:

   ```
   gcloud sql instances describe [INSTANCE_NAME]
   ```

   Replace `[INSTANCE_NAME]` with the name of the SQL instance you want to check. This command will return a detailed description of the instance, including its configuration.

4. In the output of the previous command, look for the `settings.databaseFlags` field. This field contains a list of all the flags that are set for the SQL instance. If the `log_lock_waits` flag is present and set to `on`, then the PostgreSQL Log Lock Waits flag is enabled. If the flag is not present or set to `off`, then it is disabled.

#### Using Python

To detect if the PostgreSQL Log Lock Waits flag is enabled or disabled in SQL using Python scripts, you can follow these steps:

1. **Connect to PostgreSQL Database:**
   First, you need to connect to your PostgreSQL database. You can use the `psycopg2` library in Python to do this. Here is a sample script:

   ```python
   import psycopg2

   try:
       connection = psycopg2.connect(user="sysadmin",
                                     password="pynative@#29",
                                     host="127.0.0.1",
                                     port="5432",
                                     database="postgres_db")

       cursor = connection.cursor()
       # Print PostgreSQL Connection properties
       print(connection.get_dsn_parameters(), "\n")

   except (Exception, psycopg2.Error) as error:
       print("Error while connecting to PostgreSQL", error)
   ```

2. **Execute SQL Query to Check the Flag:**
   Once connected, you can execute a SQL query to check the status of the `log_lock_waits` configuration parameter. Here is a sample script:

   ```python
   try:
       cursor.execute("SHOW log_lock_waits;")
       record = cursor.fetchone()
       print("You are connected to - ", record, "\n")

   except (Exception, psycopg2.Error) as error:
       print("Error while connecting to PostgreSQL", error)
   ```

3. **Analyze the Result:**
   The result of the query will be either `on` or `off`. If the result is `on`, it means the Log Lock Waits flag is enabled. If it's `off`, it means the flag is disabled.

4. **Close the Connection:**
   Don't forget to close the database connection after you're done. Here is a sample script:

   ```python
   finally:
       # closing database connection.
       if connection:
           cursor.close()
           connection.close()
           print("PostgreSQL connection is closed")
   ```

Remember to replace the connection parameters with your actual database credentials.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the PostgreSQL Log Lock Waits Flag Should Be Disabled misconfiguration in GCP using GCP console, please follow these steps:

1. Open the GCP Console and navigate to the Cloud SQL instances page.

2. Select the instance that you want to remediate.

3. Click on the Edit button at the top of the page.

4. Scroll down to the Flags section and click on the Add database flag button.

5. In the Name field, enter `log_lock_waits` and in the Value field, enter `off`.

6. Click on the Save button at the bottom of the page to save the changes.

7. Wait for a few minutes for the changes to take effect.

Once the changes have been applied, the PostgreSQL Log Lock Waits Flag will be disabled and the misconfiguration will be remediated.

#### Using CLI

To remediate the PostgreSQL Log Lock Waits Flag misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in your GCP console.

2. Connect to your instance using the following command:

   ```
   gcloud sql connect [INSTANCE_NAME] --user=[USER_NAME]
   ```

   Replace `[INSTANCE_NAME]` with the name of your Cloud SQL instance and `[USER_NAME]` with the name of the user you want to connect as.

3. Enter the user's password when prompted.

4. Run the following command to disable the log_lock_waits flag:

   ```
   ALTER SYSTEM SET log_lock_waits = off;
   ```

5. Restart your instance to apply the changes:

   ```
   gcloud sql instances restart [INSTANCE_NAME]
   ```

   Replace `[INSTANCE_NAME]` with the name of your Cloud SQL instance.

6. Verify that the flag has been disabled by running the following command:

   ```
   SHOW log_lock_waits;
   ```

   If the output is `off`, then the flag has been successfully disabled.

Congratulations! You have successfully remediated the PostgreSQL Log Lock Waits Flag misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the "PostgreSQL Log Lock Waits Flag Should Be Disabled" misconfiguration in GCP using Python, follow these steps:

1. First, you need to authenticate and set up the GCP client library for Python. You can follow the instructions provided in the [official documentation](https://cloud.google.com/docs/authentication/getting-started) to do this.

2. Next, you need to create a connection to your PostgreSQL instance using the `google-cloud-sql` library. You can use the following code to do this:

```python
from google.cloud import sql
from google.oauth2 import service_account

# Set up the credentials
credentials = service_account.Credentials.from_service_account_file(
    'path/to/credentials.json')

# Create a client object
client = sql.Client(project='project-id', credentials=credentials)

# Get a reference to your instance
instance = client.instance('instance-id')
```

Make sure to replace `path/to/credentials.json`, `project-id`, and `instance-id` with the appropriate values for your setup.

3. Once you have a reference to your instance, you can disable the `log_lock_waits` flag by updating the instance settings. You can use the following code to do this:

```python
# Get the current settings
settings = instance.database_flags().get()

# Disable the log_lock_waits flag
settings['log_lock_waits'] = False

# Update the settings
operation = instance.update_database_flags(settings)
result = operation.result()
```

This code gets the current database settings, disables the `log_lock_waits` flag, and updates the settings. The `update_database_flags` method returns an operation object, which you can use to check the status of the update.

4. Finally, you can check that the flag has been disabled by querying the instance settings again:

```python
# Get the updated settings
settings = instance.database_flags().get()

# Print the log_lock_waits flag value
print(settings['log_lock_waits'])
```

This code gets the updated database settings and prints the value of the `log_lock_waits` flag. It should be `False` if the remediation was successful.

That's it! You have successfully remediated the "PostgreSQL Log Lock Waits Flag Should Be Disabled" misconfiguration in GCP using Python.




</Tab>
</Tabs>