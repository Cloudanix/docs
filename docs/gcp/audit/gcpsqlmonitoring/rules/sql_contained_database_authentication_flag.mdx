---
slug: sql_contained_database_authentication_flag
title: Database Authentication Flag Should Be Disabled
sidebar_label: Database Authentication Flag Should Be Disabled
---

### More Info:

Ensure that the contained database authentication database flag for Cloud SQL on the SQL Server instance is set to off.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISGCP, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the SQL section: From the navigation menu, select "SQL" under the "Storage" section. This will display a list of all SQL instances in your project.

3. Select the SQL instance you want to check: Click on the name of the SQL instance you want to inspect. This will open the instance details page.

4. Check the Database Authentication Flag: In the instance details page, navigate to the "Flags" tab. Look for the flag named "cloud_sql_auth". If this flag is enabled, it means that the Database Authentication is not disabled.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI: You need to have the Google Cloud SDK installed on your local machine. Once installed, authenticate it using the command `gcloud auth login`. This will open a new browser window for you to log in to your Google account.

2. List all SQL instances: Use the command `gcloud sql instances list` to list all the SQL instances in your project. This will give you a list of all the SQL instances along with their details.

3. Describe the SQL instance: To check the configuration of a specific SQL instance, use the command `gcloud sql instances describe [INSTANCE_NAME]`. Replace `[INSTANCE_NAME]` with the name of your SQL instance. This will give you a detailed description of your SQL instance.

4. Check the Database Authentication Flag: In the output of the previous command, look for the `databaseFlags` section. If the `cloudSqlJdbcBackdoor` flag is present and set to `on`, this means that the Database Authentication Flag is enabled. If it is not present or set to `off`, then it is disabled.

#### Using Python

1. Install the necessary Python libraries: Before you can start, you need to install the necessary Python libraries. For AWS, you would need boto3, for Azure, you would need azure-mgmt-sql, and for GCP, you would need google-cloud-sql. You can install these libraries using pip.

```python
pip install boto3 azure-mgmt-sql google-cloud-sql
```

2. Connect to the cloud service: The next step is to connect to the cloud service. You would need to authenticate your script with the cloud service. Here is how you can do it for each service:

AWS:
```python
import boto3
client = boto3.client('rds')
```

Azure:
```python
from azure.mgmt.sql import SqlManagementClient
from azure.common.credentials import ServicePrincipalCredentials

credentials = ServicePrincipalCredentials(
    client_id = 'your_client_id',
    secret = 'your_secret',
    tenant = 'your_tenant_id'
)

client = SqlManagementClient(credentials, 'your_subscription_id')
```

GCP:
```python
from google.cloud import sql
client = sql.SqlInstancesServiceClient()
```

3. Check the database authentication flag: Now that you are connected to the cloud service, you can check the database authentication flag. Here is how you can do it for each service:

AWS:
```python
response = client.describe_db_instances()
for instance in response['DBInstances']:
    if instance['Engine'] == 'mysql' and instance['EngineVersion'].startswith('5.7'):
        print(f"Instance {instance['DBInstanceIdentifier']} has authentication plugin flag set to {instance['IAMDatabaseAuthenticationEnabled']}")
```

Azure:
```python
for server in client.servers.list():
    for database in client.databases.list_by_server(server.resource_group, server.name):
        if database.kind == 'v12.0,user':
            print(f"Database {database.name} on server {server.name} has authentication plugin flag set to {database.sql_server_credential}")
```

GCP:
```python
for instance in client.list_instances():
    if instance.database_version == sql.enums.SqlDatabaseVersion.SQL_DATABASE_VERSION_UNSPECIFIED:
        print(f"Instance {instance.name} has authentication plugin flag set to {instance.settings.ip_configuration.require_ssl}")
```

4. Analyze the results: The scripts will print out the instances/databases that have the authentication plugin flag set. You can then analyze these results to detect any misconfigurations.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Database Authentication Flag Should Be Disabled" misconfiguration for GCP using GCP console, follow these steps:

1. Open the Google Cloud Console and navigate to the Cloud SQL instances page.
2. Select the instance you want to remediate.
3. Click on the Edit button at the top of the page.
4. Scroll down to the "Authorization" section.
5. In the "Authorized networks" section, click on the "Add network" button.
6. Add your IP address or the IP address range that should be authorized to access the instance.
7. In the "Database flags" section, click on the "Add database flag" button.
8. Add the flag "skip_grant_tables" and set its value to "on".
9. Click on the "Save" button to save the changes.

By following these steps, you have disabled the database authentication flag and added the authorized network to access the instance.

#### Using CLI

To remediate the "Database Authentication Flag Should Be Disabled" misconfiguration in GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to check the current status of the database authentication flag:

   ```
   gcloud sql instances describe [INSTANCE_NAME] --format="get(settings.authorizedNetworks)"
   ```

   Replace [INSTANCE_NAME] with the name of your SQL instance.

3. If the output of the above command contains "requireSsl: true", it means that the database authentication flag is enabled and needs to be disabled.

4. Run the following command to disable the database authentication flag:

   ```
   gcloud sql instances patch [INSTANCE_NAME] --clear settings.requireSsl
   ```

   Replace [INSTANCE_NAME] with the name of your SQL instance.

5. Confirm the change by running the following command:

   ```
   gcloud sql instances describe [INSTANCE_NAME] --format="get(settings.requireSsl)"
   ```

   The output should be "False", indicating that the database authentication flag has been successfully disabled.

6. Verify that the change has been applied by checking the authorized networks again:

   ```
   gcloud sql instances describe [INSTANCE_NAME] --format="get(settings.authorizedNetworks)"
   ```

   The output should not contain "requireSsl: true" anymore.

By following these steps, you should be able to remediate the "Database Authentication Flag Should Be Disabled" misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Database Authentication Flag Should be Disabled" in GCP using python, follow the below steps:

Step 1: Install the necessary libraries

```
pip install google-auth google-auth-oauthlib google-auth-httplib2 google-cloud-secret-manager
```

Step 2: Authenticate to GCP

```
from google.oauth2 import service_account
from google.cloud import secretmanager

# Replace [PROJECT_ID] with your GCP project ID
project_id = '[PROJECT_ID]'

# Replace [SECRET_NAME] with the name of the secret containing the database authentication flag
secret_name = '[SECRET_NAME]'

# Replace [VERSION] with the version of the secret containing the database authentication flag
version = '[VERSION]'

# Authenticate to GCP using a service account
credentials = service_account.Credentials.from_service_account_file('path/to/service/account/key.json')

# Create a Secret Manager client
client = secretmanager.SecretManagerServiceClient(credentials=credentials)

# Access the secret containing the database authentication flag
name = f"projects/{project_id}/secrets/{secret_name}/versions/{version}"
response = client.access_secret_version(name=name)

# Get the value of the database authentication flag
database_auth_flag = response.payload.data.decode('UTF-8')
```

Step 3: Remediate the misconfiguration

```
from google.cloud import secretmanager

# Replace [PROJECT_ID] with your GCP project ID
project_id = '[PROJECT_ID]'

# Replace [SECRET_NAME] with the name of the secret containing the database authentication flag
secret_name = '[SECRET_NAME]'

# Replace [VERSION] with the version of the secret containing the database authentication flag
version = '[VERSION]'

# Replace [DATABASE_AUTH_FLAG_VALUE] with the desired value of the database authentication flag (0 or 1)
database_auth_flag_value = '0'

# Create a Secret Manager client
client = secretmanager.SecretManagerServiceClient()

# Access the secret containing the database authentication flag
name = f"projects/{project_id}/secrets/{secret_name}/versions/{version}"
response = client.access_secret_version(name=name)

# Update the value of the database authentication flag
payload = response.payload
payload.data = database_auth_flag_value.encode('UTF-8')
response = client.update_secret_version(name=name, payload=payload, update_mask={'paths': ['data']})
```

Note: This code assumes that the database authentication flag is stored in GCP Secret Manager. If the flag is stored elsewhere, such as in a configuration file or environment variable, the code will need to be modified accordingly.




</Tab>
</Tabs>