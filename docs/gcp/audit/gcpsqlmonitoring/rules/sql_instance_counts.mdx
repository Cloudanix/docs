---
slug: sql_instance_counts
title: Provisioned Instances Should Not Exceed Set Threshold
sidebar_label: Provisioned Instances Should Not Exceed Set Threshold
---

### More Info:

Ensure that total number of SQL Instances does not exceed the threshold set by the organization.

### Risk Level

Medium

### Address

Operational Maturity, Reliability

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Console: Navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud credentials.

2. Navigate to SQL Instances: From the left-hand side menu, select "SQL" under the "Storage" section. This will take you to the SQL instances page where you can see all the SQL instances provisioned in your project.

3. Check Instance Details: Click on the name of the SQL instance you want to check. This will take you to the instance details page. Here, you can see the current configuration of the instance including the provisioned resources.

4. Compare with Threshold: Compare the provisioned resources (CPU, Memory, Storage) with your set threshold. If the provisioned resources exceed the set threshold, then there is a misconfiguration.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: The Google Cloud SDK includes the gcloud command-line tool, which you can use to manage your Google Cloud resources. You can download and install the SDK on your local machine and then authenticate it with your Google Cloud account.

    ```
    curl https://sdk.cloud.google.com | bash
    exec -l $SHELL
    gcloud init
    ```

2. List all SQL instances: Use the `gcloud sql instances list` command to list all SQL instances in your Google Cloud project. This command will return a list of all SQL instances, along with their project ID, region, and other details.

    ```
    gcloud sql instances list
    ```

3. Check the provisioned instances: For each instance, use the `gcloud sql instances describe` command followed by the instance ID to get detailed information about the instance. Look for the "settings" section in the output, which includes information about the instance's tier and the number of CPUs and memory it has provisioned.

    ```
    gcloud sql instances describe [INSTANCE_ID]
    ```

4. Compare the provisioned instances with the set threshold: After getting the details of all instances, you can compare the number of provisioned instances with the set threshold. If the number of provisioned instances exceeds the set threshold, it indicates a misconfiguration. This step might require a custom script or manual comparison, depending on the number of instances and the complexity of your environment.

#### Using Python

Detecting whether provisioned instances exceed a set threshold in SQL can be done using Python scripts. Here's how you can do it:

1. **Install Necessary Libraries**: First, you need to install the necessary libraries. You will need the `boto3` library for AWS, `azure-mgmt-sql` for Azure, and `google-cloud-sql` for GCP. You can install these libraries using pip:
   ```python
   pip install boto3 azure-mgmt-sql google-cloud-sql
   ```

2. **Set Up Cloud Credentials**: You need to set up your cloud credentials to access your cloud resources. For AWS, you can configure your credentials using the AWS CLI. For Azure and GCP, you can set up your credentials using the Azure CLI and Google Cloud SDK respectively.

3. **Fetch the List of SQL Instances**: Next, you need to fetch the list of SQL instances in your cloud. Here's how you can do it for each cloud:

   - AWS:
     ```python
     import boto3

     client = boto3.client('rds')
     response = client.describe_db_instances()
     instances = response['DBInstances']
     ```

   - Azure:
     ```python
     from azure.mgmt.sql import SqlManagementClient
     from azure.identity import DefaultAzureCredential

     credential = DefaultAzureCredential()
     sql_client = SqlManagementClient(credential, "<subscription_id>")
     instances = sql_client.servers.list()
     ```

   - GCP:
     ```python
     from google.cloud import sql

     client = sql.SqlInstancesServiceClient()
     instances = client.list(project="<project_id>")
     ```

4. **Check If Instances Exceed Threshold**: Finally, you can check if the number of instances exceeds your set threshold. Here's how you can do it:
   ```python
   threshold = 10  # Set your threshold here

   if len(instances) > threshold:
       print("Number of provisioned instances exceeds set threshold")
   else:
       print("Number of provisioned instances is within set threshold")
   ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Provisioned Instances Should Not Exceed Set Threshold" for GCP using GCP console, follow the below steps:

1. Login to the GCP console (https://console.cloud.google.com/).
2. Navigate to the "Compute Engine" service from the navigation menu on the left-hand side.
3. Click on the "Instance Groups" option from the sub-menu.
4. Select the instance group that has exceeded the set threshold.
5. Click on the "Edit Group" button at the top of the page.
6. In the "Autoscaling" section, adjust the maximum number of instances to the desired threshold.
7. Click on the "Save" button to apply the changes.

Once the above steps are completed, the instance group will be remediated and the number of provisioned instances will be within the set threshold.

#### Using CLI

To remediate the issue of Provisioned Instances Should Not Exceed Set Threshold in GCP using GCP CLI, follow the below steps:

Step 1: Open the Cloud Shell in your GCP console.

Step 2: Run the following command in your Cloud Shell to get the list of all the instances running in your GCP project:

```
gcloud compute instances list
```

Step 3: Check the number of instances running and compare it with the set threshold. If the number of instances is exceeding the set threshold, then you need to delete some of the instances.

Step 4: To delete an instance, run the following command:

```
gcloud compute instances delete [INSTANCE_NAME]
```

Replace [INSTANCE_NAME] with the actual name of the instance you want to delete.

Step 5: Confirm the deletion by typing "Y" when prompted.

Step 6: Repeat Step 4 and Step 5 for all the instances you want to delete.

Step 7: Once you have deleted the required number of instances, re-run the command in Step 2 to verify that the number of instances is now within the set threshold.

By following the above steps, you can remediate the issue of Provisioned Instances Should Not Exceed Set Threshold in GCP using GCP CLI.

#### Using Python

To remediate the "Provisioned Instances Should Not Exceed Set Threshold" misconfiguration in GCP using Python, you can use the following steps:

1. Define the set threshold for the number of provisioned instances.
2. Use the GCP Python SDK to retrieve a list of all the instances currently provisioned in the project.
3. Count the number of instances in the list.
4. If the number of instances exceeds the set threshold, use the GCP Python SDK to delete the excess instances.

Here's some sample Python code that can be used to remediate this misconfiguration:

```python
# Import the required libraries
from google.cloud import compute_v1

# Define the set threshold for the number of provisioned instances
threshold = 10

# Create a Compute Engine client using the GCP Python SDK
client = compute_v1.InstancesClient()

# Retrieve a list of all the instances currently provisioned in the project
project = "my-gcp-project"
zone = "us-central1-a"
instances = client.list(project=project, zone=zone).items

# Count the number of instances in the list
num_instances = len(instances)

# If the number of instances exceeds the set threshold, delete the excess instances
if num_instances > threshold:
    excess_instances = instances[threshold:]
    for instance in excess_instances:
        client.delete(project=project, zone=zone, instance=instance.name)
```

Note that you will need to replace the `my-gcp-project` and `us-central1-a` placeholders in the code with your own GCP project and zone information. Additionally, you may need to authenticate with GCP using a service account key before running this code.




</Tab>
</Tabs>