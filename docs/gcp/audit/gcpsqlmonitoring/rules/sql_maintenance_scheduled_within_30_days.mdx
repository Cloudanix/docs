---
slug: sql_maintenance_scheduled_within_30_days
title: SQL Instances Should Have Maintenance Scheduled Within the Next 30 Day
sidebar_label: SQL Instances Should Have Maintenance Scheduled Within the Next 30 Day
---

### More Info:

Ensure that SQL Instances have Maintenance scheduled within the next 30 days

### Risk Level

Low

### Address

Security, Operational Maturity

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to SQL Instances: From the left-hand side menu, navigate to "SQL" under the "Storage" section. This will open up a list of all your SQL instances.

3. Check Maintenance Window: For each SQL instance, click on the instance name to open its details. In the details page, navigate to the "Maintenance" tab. Here, you can see the maintenance window and the next scheduled maintenance.

4. Verify Maintenance Schedule: Check if the next scheduled maintenance is within the next 30 days. If it's not, then it's a misconfiguration. Repeat this process for all SQL instances in your GCP account.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: The Google Cloud SDK includes the gcloud command-line tool, which is necessary to interact with Google Cloud resources. You can install it by following the instructions provided by Google Cloud. After installation, authenticate the SDK using the command `gcloud auth login`.

2. List all SQL instances: Use the `gcloud sql instances list` command to list all SQL instances in your project. This command will return a list of all SQL instances, including their project ID, name, region, and other details.

   Command: `gcloud sql instances list`

3. Get the details of each SQL instance: For each SQL instance, use the `gcloud sql instances describe` command followed by the instance name to get detailed information about the instance. This will return a lot of information, including the maintenance window for the instance.

   Command: `gcloud sql instances describe [INSTANCE_NAME]`

4. Check the maintenance schedule: In the output of the previous command, look for the "maintenanceWindow" field. This field contains the day of the week and hour of the day when maintenance will be performed. If the maintenance window is not within the next 30 days, the instance is misconfigured.

   Note: This process needs to be repeated for each SQL instance in your project. If you have many instances, you may want to automate this process using a script.

#### Using Python

1. **Setup and Authentication:**
   First, you need to set up your environment and authenticate your script with Google Cloud. You can use the `google-auth` library for this. You need to have the `GOOGLE_APPLICATION_CREDENTIALS` environment variable set to the path of your service account key JSON file.

   ```python
   import google.auth
   from google.cloud import sql

   credentials, project = google.auth.default()
   service = sql.SqlInstancesService(credentials=credentials)
   ```

2. **List SQL Instances:**
   Next, you need to list all the SQL instances in your project. You can do this using the `list` method of the `SqlInstancesService` class.

   ```python
   instances = service.list(project=project).execute()
   ```

3. **Check Maintenance Window:**
   For each instance, you need to check the maintenance window. This information is available in the `settings.maintenanceWindow` field of the instance resource.

   ```python
   for instance in instances['items']:
       maintenance_window = instance['settings']['maintenanceWindow']
       print(f"Instance: {instance['name']}, Maintenance Window: {maintenance_window}")
   ```

4. **Check if Maintenance is Scheduled Within the Next 30 Days:**
   The maintenance window is specified as a day of the week and an hour of the day. You need to calculate the next occurrence of this time and check if it is within the next 30 days.

   ```python
   import datetime
   from dateutil.relativedelta import relativedelta

   for instance in instances['items']:
       maintenance_window = instance['settings']['maintenanceWindow']
       day_of_week = maintenance_window['day']
       hour_of_day = maintenance_window['hour']

       now = datetime.datetime.now()
       next_maintenance = now + relativedelta(weekday=day_of_week, hour=hour_of_day)

       if next_maintenance - now <= datetime.timedelta(days=30):
           print(f"Instance: {instance['name']} has maintenance scheduled within the next 30 days.")
       else:
           print(f"Instance: {instance['name']} does not have maintenance scheduled within the next 30 days.")
   ```

Please note that this is a simplified example and does not handle all possible edge cases. For example, it assumes that the maintenance window is always specified and that the day of the week and hour of the day are always valid. You may need to add additional error checking and handling code for a production environment.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the SQL Instances should have maintenance scheduled within the next 30 days misconfiguration in GCP using GCP console, follow the below steps:

1. Login to your GCP console.

2. Navigate to the Cloud SQL Instances page.

3. Identify the SQL instance that needs maintenance scheduling and click on its name to open its details page.

4. Click on the "Edit" button at the top of the page.

5. Scroll down to the "Maintenance" section.

6. Click on the "Edit" button next to the "Maintenance window" option.

7. In the "Maintenance window" dialog box, select the preferred day and time for maintenance scheduling.

8. Click on the "Save" button to save the changes.

9. Verify that the maintenance scheduling has been successfully updated by checking the "Maintenance" section on the SQL instance details page.

10. Repeat the above steps for all the SQL instances that need maintenance scheduling.

By following the above steps, you can remediate the SQL Instances should have maintenance scheduled within the next 30 days misconfiguration in GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "SQL Instances Should Have Maintenance Scheduled Within the Next 30 Day" for GCP using GCP CLI, you can follow the below steps:

1. Open the GCP Cloud Shell from the GCP Console.

2. Run the following command to list all the SQL instances in your project:
   
   `gcloud sql instances list`

3. Select the SQL instance for which you want to schedule maintenance.

4. Run the following command to schedule maintenance for the selected SQL instance:

   `gcloud sql instances patch [INSTANCE_NAME] --maintenance-window-day [DAY_OF_WEEK] --maintenance-window-hour [HOUR_OF_DAY]`

   Replace [INSTANCE_NAME] with the name of your SQL instance, [DAY_OF_WEEK] with the day of the week on which you want to schedule maintenance, and [HOUR_OF_DAY] with the hour of the day on which you want to schedule maintenance.

   For example, to schedule maintenance for an instance named "my-sql-instance" every Sunday at 2:00 AM UTC, run the following command:

   `gcloud sql instances patch my-sql-instance --maintenance-window-day SUN --maintenance-window-hour 02:00`

5. Verify that the maintenance is scheduled by running the following command:

   `gcloud sql instances describe [INSTANCE_NAME]`

   Replace [INSTANCE_NAME] with the name of your SQL instance. The output will show the maintenance window details.

By following these steps, you can remediate the misconfiguration "SQL Instances Should Have Maintenance Scheduled Within the Next 30 Day" for GCP using GCP CLI.

#### Using Python

To remediate the SQL Instances Should Have Maintenance Scheduled Within the Next 30 Day misconfiguration in GCP using Python, you can follow the below steps:

1. Import the required libraries and authenticate to GCP using the service account credentials.

```
from google.oauth2 import service_account
from google.cloud import sql_v1beta4
from datetime import date, timedelta

# Authenticate using service account credentials
credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_key_file>')
client = sql_v1beta4.SqlBackupRunsServiceClient(credentials=credentials)
```

2. Get the list of all the SQL instances in your GCP project.

```
project_id = '<your_project_id>'
instances = client.list_instances(project_id)
```

3. For each SQL instance, check if the maintenance window is not already set and if the instance is not in the process of being deleted.

```
for instance in instances:
    if instance.settings.maintenance_window.start_time is None and instance.lifecycle_state != sql_v1beta4.SqlInstance.LifecycleStateValueValuesEnum.DELETING:
        # Set the maintenance window start time to 30 days from now
        start_time = (date.today() + timedelta(days=30)).strftime('%Y-%m-%dT%H:%M:%S.%fZ')
        maintenance_window = sql_v1beta4.MaintenanceWindow(start_time=start_time)
        operation = client.patch_instance(project_id, instance.name, {'settings': {'maintenance_window': maintenance_window}})
        operation.result()
```

4. The above code will set the maintenance window start time for all the SQL instances that do not have it already set and are not in the process of being deleted.

Note: Make sure to replace `<path_to_service_account_key_file>` and `<your_project_id>` with the actual values for your GCP project.




</Tab>
</Tabs>