---
slug: sql_replicas_encrypted
title: SQL Read Replica Instances Should Be Encrypted Using Customer Managed Keys (CMKs)
sidebar_label: SQL Read Replica Instances Should Be Encrypted Using Customer Managed Keys (CMKs)
---

### More Info:

Ensure that SQL Read Replica Instances are encrypted using Customer Managed Keys (CMKs).

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, GDPR, SOC2, NISTCSF, PCIDSS


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform (GCP) Console (https://console.cloud.google.com/) and sign in with your Google account that has the necessary permissions to view and manage Google Cloud SQL instances.

2. Navigate to SQL Instances: From the GCP Console dashboard, select the project that you want to examine from the project drop-down list available in the top navigation bar. Then, navigate to SQL by choosing "Navigation Menu > SQL".

3. Check Encryption Settings: In the SQL instances page, click on the name of the database instance that you want to examine. In the instance details page, click on the "Configuration" tab. Under the "Encryption" section, check the "Customer-managed key" field. If the field is set to "Google-managed key", it means the SQL Read Replica instance is not encrypted using a Customer Managed Key (CMK).

4. Repeat the process: Repeat steps 3 for each SQL instance available within the selected project. Remember to change the GCP project from the project drop-down list at the top of the page and repeat the process for all other projects available in your GCP account.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and configured, you can list all the SQL instances in your project by running the following command in your terminal:

   ```
   gcloud sql instances list
   ```

   This command will return a list of all SQL instances in your project, along with some basic information about each instance.

3. To check if a specific SQL instance is encrypted with a Customer Managed Key (CMK), you can run the following command:

   ```
   gcloud sql instances describe [INSTANCE_NAME]
   ```

   Replace `[INSTANCE_NAME]` with the name of the SQL instance you want to check. This command will return detailed information about the specified SQL instance.

4. In the output of the previous command, look for the `diskEncryptionConfiguration` field. If the instance is encrypted with a CMK, this field will contain a `kmsKeyName` subfield with the name of the CMK. If the `diskEncryptionConfiguration` field is not present or does not contain a `kmsKeyName` subfield, the instance is not encrypted with a CMK.

#### Using Python

1. Import the necessary libraries: You will need the `google.cloud` library to interact with Google Cloud Platform (GCP). You can install it using pip: `pip install google-cloud`. Then, import the necessary modules in your Python script:

```python
from google.cloud import sql
```

2. Establish a client connection: You will need to authenticate your client and establish a connection to the SQL service. Replace `project_id` with your actual project ID.

```python
client = sql.SqlInstancesServiceClient()
project_id = 'your-project-id'
```

3. List and check all SQL instances: You can list all SQL instances in your project and check if they are encrypted with Customer Managed Keys (CMKs). 

```python
def list_instances(project_id):
    instances = client.list(project=project_id)
    for instance in instances:
        if instance.disk_encryption_configuration.kind != 'sql#diskEncryptionConfiguration':
            print(f"Instance {instance.name} is not encrypted with CMKs.")
```

4. Call the function: Finally, call the `list_instances` function with your `project_id` as the argument to check all SQL instances in your project.

```python
list_instances(project_id)
```

This script will print out the names of all SQL instances that are not encrypted with CMKs. If no instances are printed, then all your SQL instances are encrypted with CMKs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, I can help you with that. Here are the step-by-step instructions to remediate the issue of SQL Read Replica Instances not being encrypted using Customer Managed Keys (CMKs) in GCP Console:

1. Open the GCP Console and navigate to the Cloud SQL instances page.

2. Select the read replica instance that you want to encrypt.

3. Click on the "Edit" button at the top of the page.

4. Scroll down to the "Encryption" section and select "Customer-managed key" from the dropdown menu.

5. Click on the "Select a key" button and choose the desired key from the list of available keys.

6. If you don't have a key yet, click on the "Create a key" button and follow the instructions to create a new key.

7. Once you have selected or created the key, click on the "Save" button to apply the changes.

8. Wait for the encryption to complete. This may take some time depending on the size of your database.

9. Once the encryption is complete, verify that the replica is now using customer-managed encryption keys by checking the "Encryption" section of the instance details page.

Congratulations! You have successfully remediated the issue of SQL Read Replica Instances not being encrypted using Customer Managed Keys (CMKs) in GCP Console.

#### Using CLI

To remediate this misconfiguration in GCP using GCP CLI, please follow the below steps:

1. Firstly, identify the SQL Read Replica instance that needs to be encrypted using CMKs. You can use the following command to list all the SQL instances in your GCP project:

```bash
gcloud sql instances list
```

2. Once you have identified the SQL Read Replica instance, you can enable encryption using the following command:

```bash
gcloud sql instances patch [INSTANCE_NAME] --backup-encryption-key [KEY_NAME] --backup-encryption-key-path [KEY_PATH]
```

Replace `[INSTANCE_NAME]` with the name of your SQL Read Replica instance, `[KEY_NAME]` with the name of the CMK that you want to use for encryption, and `[KEY_PATH]` with the path to the CMK.

For example:

```bash
gcloud sql instances patch my-sql-replica --backup-encryption-key my-cmk --backup-encryption-key-path projects/my-project/locations/global/keyRings/my-key-ring/cryptoKeys/my-cmk
```

3. Verify that the encryption has been enabled for the SQL Read Replica instance using the following command:

```bash
gcloud sql instances describe [INSTANCE_NAME] --format="get(settings.backupConfiguration.enabled)"
```

Replace `[INSTANCE_NAME]` with the name of your SQL Read Replica instance.

The output of the above command should be `True`, indicating that encryption has been enabled for the SQL Read Replica instance using CMKs.

By following the above steps, you can remediate the misconfiguration of SQL Read Replica Instances not being encrypted using Customer Managed Keys (CMKs) in GCP.

#### Using Python

To remediate this misconfiguration for GCP using Python, you can follow the below steps:

1. First, you need to ensure that you have enabled the Cloud KMS API for your GCP project.

2. Next, you need to create a new customer-managed key (CMK) in the Cloud KMS service. You can use the following Python code to do this:

```python
from google.cloud import kms_v1
from google.cloud.kms_v1 import enums

def create_key(project_id, location_id, key_ring_id, key_id):
    client = kms_v1.KeyManagementServiceClient()
    parent = client.key_ring_path(project_id, location_id, key_ring_id)
    purpose = enums.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT
    response = client.create_crypto_key(parent, key_id, {'purpose': purpose})
    print('Created key: {}'.format(response.name))

create_key('project-id', 'global', 'my-key-ring', 'my-key-id')
```

3. Once you have created the CMK, you can use it to encrypt the read replica instance. To do this, you can use the `google-cloud-sql` Python library. First, install the library using pip:

```
pip install google-cloud-sql
```

4. Then, you can use the following Python code to encrypt the read replica instance:

```python
from google.cloud.sql_v1beta4 import SqlInstancesServiceClient
from google.cloud.sql_v1beta4.types import SqlInstancesSetRootPasswordRequest

def encrypt_instance(project_id, instance_name, cmk_path):
    client = SqlInstancesServiceClient()
    instance_path = client.instance_path(project_id, 'us-central1', instance_name)
    request = SqlInstancesSetRootPasswordRequest()
    request.instance = instance_path
    request.root_password = 'new-root-password'
    request.encryption_config = {'kind': 'sql#encryptionConfig',
                                 'kms_key_name': cmk_path}
    response = client.instances_service.set_root_password(request)
    print('Encrypted instance: {}'.format(response.name))

encrypt_instance('project-id', 'my-instance', 'projects/project-id/locations/global/keyRings/my-key-ring/cryptoKeys/my-key-id')
```

In the above code, replace `'project-id'` with your GCP project ID, `'my-instance'` with the name of your read replica instance, and `'projects/project-id/locations/global/keyRings/my-key-ring/cryptoKeys/my-key-id'` with the path to your CMK.




</Tab>
</Tabs>