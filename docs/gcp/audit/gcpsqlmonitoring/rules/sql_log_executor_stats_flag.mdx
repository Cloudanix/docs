---
slug: sql_log_executor_stats_flag
title: PostgreSQL Log Executor Stats Flag Should Be Off
sidebar_label: PostgreSQL Log Executor Stats Flag Should Be Off
---

### More Info:

Ensure that the log_executor_stats database flag for a Cloud SQL PostgreSQL instance is set to off.

### Risk Level

Low

### Address

Reliability, Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console: Navigate to the GCP console (console.cloud.google.com) and sign in with your Google account that has the necessary permissions to access the database services.

2. Navigate to SQL Instances: From the GCP console dashboard, click on the hamburger menu on the top left corner. Scroll down and click on "SQL" under the "Storage" section. This will take you to the SQL instances page where you can see all your SQL instances.

3. Select the PostgreSQL instance: From the list of SQL instances, click on the PostgreSQL instance for which you want to check the Log Executor Stats flag.

4. Check the flag status: Once you are in the instance details page, click on the "Configuration" tab. Scroll down to the "Flags" section. Here, look for the "log_executor_stats" flag. If it is set to "on", then the PostgreSQL Log Executor Stats flag is not off. If it does not exist or is set to "off", then the flag is off.

#### Using CLI

1. Install and authenticate the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system. Once installed, authenticate it using the following command:

   ```
   gcloud auth login
   ```

2. Set your project ID to the project you want to inspect. Replace `your-project-id` with your actual project ID:

   ```
   gcloud config set project your-project-id
   ```

3. List all the SQL instances in your project using the following command:

   ```
   gcloud sql instances list
   ```

4. For each instance, check the PostgreSQL Log Executor Stats flag using the following command. Replace `your-instance-name` with the name of your instance:

   ```
   gcloud sql instances describe your-instance-name | grep log_executor_stats
   ```
   
   If the output of this command is `log_executor_stats: on`, then the PostgreSQL Log Executor Stats flag is on. If it is `log_executor_stats: off`, then the flag is off.

#### Using Python

To check if the PostgreSQL Log Executor Stats flag is off in SQL using Python scripts, you can follow these steps:

1. **Connect to the PostgreSQL Database:**
   First, you need to connect to the PostgreSQL database. You can use the `psycopg2` library in Python to establish this connection. Here is a sample script:

   ```python
   import psycopg2

   try:
       connection = psycopg2.connect(user="sysadmin",
                                      password="pynative@#29",
                                      host="127.0.0.1",
                                      port="5432",
                                      database="postgres_db")

       cursor = connection.cursor()
       # Print PostgreSQL Connection properties
       print(connection.get_dsn_parameters(), "\n")

   except (Exception, psycopg2.Error) as error:
       print("Error while connecting to PostgreSQL", error)
   ```

2. **Query the Database:**
   Once the connection is established, you can query the database to check the status of the Log Executor Stats flag. The flag's status can be checked by querying the `pg_settings` table.

   ```python
   cursor.execute("SELECT setting FROM pg_settings WHERE name = 'log_executor_stats'")
   record = cursor.fetchone()
   print("Log Executor Stats: ", record, "\n")
   ```

3. **Check the Flag Status:**
   The query will return the current setting of the Log Executor Stats flag. If the flag is off, the setting will be 'off'. You can check this in your Python script.

   ```python
   if record[0] == 'off':
       print("Log Executor Stats flag is off")
   else:
       print("Log Executor Stats flag is on")
   ```

4. **Close the Connection:**
   After you have checked the flag status, remember to close the connection to the database.

   ```python
   if(connection):
       cursor.close()
       connection.close()
       print("PostgreSQL connection is closed")
   ```

Remember to replace the connection parameters in the first step with your actual database credentials.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the PostgreSQL Log Executor Stats flag issue for GCP using the GCP console, follow these steps:

1. Open the GCP console and go to the Cloud SQL Instances page.
2. Select the instance that you want to remediate.
3. Click on the Edit button at the top of the page.
4. Scroll down to the Flags section and locate the `log_executor_stats` flag.
5. If the flag is set to `on`, click on the X button to remove it.
6. Click on the Save button at the bottom of the page to apply the changes.

After following these steps, the PostgreSQL Log Executor Stats flag will be turned off, and the misconfiguration will be remediated.

#### Using CLI

To remediate the PostgreSQL Log Executor Stats flag being on in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to connect to your instance: 

   `gcloud sql connect [INSTANCE_NAME] --user=postgres`

   Replace [INSTANCE_NAME] with the name of your PostgreSQL instance.

3. Enter the password for the postgres user when prompted.

4. Once connected, run the following command to check the current value of the log_executor_stats flag: 

   `SHOW log_executor_stats;`

5. If the value is "on", run the following command to turn it off: 

   `ALTER SYSTEM SET log_executor_stats = off;`

6. Finally, run the following command to reload the configuration: 

   `SELECT pg_reload_conf();`

7. Verify that the log_executor_stats flag is now off by running the following command: 

   `SHOW log_executor_stats;`

   The output should show "off".

You have now successfully remediated the PostgreSQL Log Executor Stats flag being on in GCP using GCP CLI.

#### Using Python

To remediate the PostgreSQL Log Executor Stats Flag Should Be Off misconfiguration in GCP using python, you can follow the below steps:

1. First, you need to authenticate and authorize your python script to access the GCP project where the PostgreSQL instance is running. You can use the `google-auth` and `google-cloud-secret-manager` packages to achieve this.

2. Once you have authenticated and authorized your script, you can use the `google-cloud-sql` package to get the list of all the PostgreSQL instances in the project.

3. After getting the list of instances, you can iterate through each instance and check if the `log_executor_stats` flag is set to `on` or not. You can use the `psycopg2` package to connect to the instance and execute the following SQL query to get the value of the flag:

```
SELECT name, setting FROM pg_settings WHERE name = 'log_executor_stats';
```

4. If the flag is set to `on`, you can execute the following SQL query to turn it off:

```
ALTER SYSTEM SET log_executor_stats = off;
```

5. Once you have turned off the flag, you need to reload the PostgreSQL configuration by executing the following SQL query:

```
SELECT pg_reload_conf();
```

6. Finally, you can log the remediation action and move on to the next instance.

Here's a sample python script that you can use to remediate the PostgreSQL Log Executor Stats Flag Should Be Off misconfiguration in GCP:

```
from google.cloud import secretmanager
from google.cloud import sql
import psycopg2

# Authenticate and authorize the script to access the GCP project
# ...

# Get the list of all PostgreSQL instances in the project
client = sql.Client()
instances = client.list_instances()

# Iterate through each instance and remediate the misconfiguration
for instance in instances:
    if instance.database_version.startswith('POSTGRES'):
        # Connect to the instance and get the value of the log_executor_stats flag
        conn = psycopg2.connect(
            host=instance.ip_addresses[0].ip_address,
            user=instance.service_account_email,
            password=instance.database_password,
            database='postgres'
        )
        cur = conn.cursor()
        cur.execute("SELECT name, setting FROM pg_settings WHERE name = 'log_executor_stats';")
        name, setting = cur.fetchone()

        # If the flag is set to on, turn it off and reload the configuration
        if setting == 'on':
            cur.execute("ALTER SYSTEM SET log_executor_stats = off;")
            cur.execute("SELECT pg_reload_conf();")
            conn.commit()

            # Log the remediation action
            print(f"Remediated log_executor_stats flag for instance {instance.name}")
        
        cur.close()
        conn.close()
```

Note: This script assumes that you have the necessary permissions to access the PostgreSQL instances and modify their configurations. Please make sure to test the script in a non-production environment before running it in production.




</Tab>
</Tabs>