

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (https://console.cloud.google.com/) and sign in with your Google account credentials.

2. Navigate to Compute Engine: From the left-hand side menu, select "Compute Engine" and then "Disks". This will display a list of all the disks associated with your GCP account.

3. Check Disk Encryption: For each disk, under the "Encryption" column, check the type of encryption used. If it says "Google-managed key", it means that the disk is not using a customer-supplied encryption key.

4. Repeat for All Disks: Repeat the above step for all the disks listed in the console. If any disk is not using a customer-supplied encryption key, it indicates a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your GCP account using the following command. This will open a new window in your web browser asking you to log in to your Google Cloud account.
   ```
   gcloud auth login
   ```

3. Set your project ID to the project you want to check. Replace 'your-project-id' with the ID of your project.
   ```
   gcloud config set project your-project-id
   ```

4. Run the following command to list all the disks in your project and check if Customer-Supplied Encryption Key is enabled. If the "diskEncryptionKey" field is empty for any disk, it means that Customer-Supplied Encryption Key is not enabled for that disk.
   ```
   gcloud compute disks list --format='table(name, diskEncryptionKey)'
   ```

#### Using Python

To check if Customer Supplied Encryption Key (CSEK) is enabled for disks in Google Cloud Platform (GCP) Compute Engine, you can use the Google Cloud SDK (gcloud) or the Google Cloud Client Libraries for Python. Here are the steps:

1. **Setup Google Cloud SDK and Authenticate:**
   Before you can interact with GCP resources, you need to authenticate your SDK. You can do this by running the command `gcloud auth login` and following the prompts. This will authenticate your SDK with your Google account.

2. **Install Google Cloud Client Libraries for Python:**
   You can install the Google Cloud Client Libraries for Python by running the command `pip install --upgrade google-cloud-storage`. This will allow you to interact with GCP resources using Python.

3. **List Disks and Check for CSEK:**
   You can list all the disks in a project and check if CSEK is enabled using the following Python script:

```python
from google.cloud import storage

def list_disks_with_csek():
    client = storage.Client()
    buckets = client.list_buckets()

    for bucket in buckets:
        for blob in bucket.list_blobs():
            if 'customerEncryption' in blob.metadata:
                print(f"Disk {blob.name} in bucket {bucket.name} is encrypted with a customer-supplied encryption key.")
            else:
                print(f"Disk {blob.name} in bucket {bucket.name} is not encrypted with a customer-supplied encryption key.")

list_disks_with_csek()
```

4. **Interpret the Results:**
   The script will print out the names of all the disks in all the buckets in the project, and whether or not they are encrypted with a customer-supplied encryption key. If a disk is not encrypted with a CSEK, it may be a misconfiguration.

Please note that this script assumes that you have the necessary permissions to list the buckets and blobs in the project. If you do not, you will need to grant them before you can run the script.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Customer Supplied Encryption Key Should Be Enabled For Disks" for GCP using GCP console, please follow the below steps:

1. Open the GCP Console and select the project for which you want to enable Customer Supplied Encryption Key.
2. In the left navigation menu, select "Compute Engine" and then select "Disks".
3. Select the disk for which you want to enable Customer Supplied Encryption Key.
4. Click on "Edit" at the top of the page.
5. In the Encryption section, select "Customer-supplied encryption key".
6. Enter the 256-bit encryption key in the "Key" field.
7. Click on "Save" to save the changes.

Once you have completed the above steps, the disk will be encrypted using the customer-supplied encryption key. It is recommended to create a backup of the encryption key and store it in a secure location, as it will be required to access the data on the disk.

#### Using CLI

To remediate the "Customer Supplied Encryption Key Should Be Enabled For Disks" misconfiguration in GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to check if the customer-supplied encryption key is enabled for the disks:

   ```
   gcloud compute disks describe [DISK_NAME] --zone=[ZONE] --format="value(satisfiesPzs)"
   ```

   Replace [DISK_NAME] with the name of the disk that you want to check and [ZONE] with the zone in which the disk is located.

3. If the output of the previous command is "False", then the customer-supplied encryption key is not enabled for the disk. To enable it, run the following command:

   ```
   gcloud compute disks add-iam-policy-binding [DISK_NAME] --zone=[ZONE] --member user:[USER_EMAIL] --role roles/compute.diskEncrypterDecrypter
   ```

   Replace [DISK_NAME] with the name of the disk that you want to encrypt and [ZONE] with the zone in which the disk is located. Replace [USER_EMAIL] with the email address of the user who will be able to encrypt and decrypt the disk.

4. After running the above command, the customer-supplied encryption key will be enabled for the disk. You can verify it by running the following command:

   ```
   gcloud compute disks describe [DISK_NAME] --zone=[ZONE] --format="value(satisfiesPzs)"
   ```

   The output of the above command should be "True", indicating that the customer-supplied encryption key is enabled for the disk.

By following the above steps, you can remediate the "Customer Supplied Encryption Key Should Be Enabled For Disks" misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Customer Supplied Encryption Key Should Be Enabled For Disks" in GCP using Python, you can follow the below steps:

Step 1: Install the required packages

```
!pip install google-cloud-storage google-auth google-auth-oauthlib google-auth-httplib2
```

Step 2: Authenticate to GCP

```
from google.colab import auth
auth.authenticate_user()
```

Step 3: Import the required libraries

```
from google.cloud import storage
from google.oauth2 import service_account
```

Step 4: Create a service account and grant it the required permissions

```
credentials = service_account.Credentials.from_service_account_file('<path-to-service-account-key>')
```

Step 5: Create a function to enable customer-supplied encryption key for disks

```
def enable_csek(project_id, zone, instance_name, disk_name, encryption_key):
    """
    This function enables customer-supplied encryption key for a disk in a GCP VM instance.
    """
    # Create the compute client
    compute_client = compute_v1.InstancesClient(credentials=credentials)
    
    # Get the instance resource URL
    instance_url = f'/projects/{project_id}/zones/{zone}/instances/{instance_name}'
    
    # Get the disk resource URL
    disk_url = f'/compute/v1/projects/{project_id}/zones/{zone}/disks/{disk_name}'
    
    # Create the disk encryption key resource
    disk_encryption_key_resource = {
        "rawKey": encryption_key,
        "rsaEncryptedKey": None,
        "kmsKeyName": None
    }
    
    # Create the disk resource with the customer-supplied encryption key
    disk_resource = {
        "sourceDisk": disk_url,
        "diskEncryptionKey": disk_encryption_key_resource,
        "autoDelete": False,
        "boot": False,
        "interface": "SCSI",
        "mode": "READ_WRITE",
        "autoResize": False,
        "sizeGb": None,
        "type": None
    }
    
    # Create the update mask
    update_mask = 'diskEncryptionKey'
    
    # Update the instance to enable customer-supplied encryption key for the disk
    operation = compute_client.attach_disk(instance=instance_url, disk=disk_resource, update_mask=update_mask)
    
    # Wait for the operation to complete
    operation.result()
    
    print(f'Successfully enabled customer-supplied encryption key for disk {disk_name} in instance {instance_name}.')
```

Step 6: Call the function to enable customer-supplied encryption key for the disk

```
enable_csek(project_id='<project-id>', zone='<zone>', instance_name='<instance-name>', disk_name='<disk-name>', encryption_key='<encryption-key>')
```

Note: Replace the placeholders `<project-id>`, `<zone>`, `<instance-name>`, `<disk-name>`, and `<encryption-key>` with the actual values for your GCP project.


</Tab>
</Tabs>