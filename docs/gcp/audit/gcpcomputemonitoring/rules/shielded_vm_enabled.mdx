---
slug: shielded_vm_enabled
title: Shielded VM Should Be Enabled For Compute Instances
sidebar_label: Shielded VM Should Be Enabled For Compute Instances
---

### More Info:

Ensure Compute instances are launched with Shielded VM enabled.

### Risk Level

High

### Address

Security, Reliability

### Compliance Standards

CISGCP, CBP, SOC2, NISTCSF


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Compute Engine: From the left-hand side menu, click on "Navigation Menu" (three horizontal lines at the top-left corner of the screen), then scroll down and click on "Compute Engine".

3. Check the VM Instances: In the Compute Engine page, click on "VM Instances". This will display a list of all the VM instances in your project.

4. Check Shielded VM Status: For each VM instance, check the "Shielded VM" status under the "Security" section. If the status is not "Enabled", then Shielded VM is not enabled for that compute instance.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions for your specific operating system.

2. Authenticate your GCP account using the following command. This will open a new browser window where you can log in to your Google Cloud account.
   ```
   gcloud auth login
   ```
3. Set your project ID to the project you want to check for Shielded VM misconfigurations. Replace 'your-project-id' with your actual project ID.
   ```
   gcloud config set project your-project-id
   ```
4. Run the following command to list all the compute instances in your project and their shielded VM status. This command will return a list of instances and whether they have the 'shieldedInstanceConfig' enabled or not.
   ```
   gcloud compute instances describe [INSTANCE_NAME] --format='value(shieldedInstanceConfig.enableSecureBoot,shieldedInstanceConfig.enableVtpm,shieldedInstanceConfig.enableIntegrityMonitoring)'
   ```
   Replace '[INSTANCE_NAME]' with the name of your instance. If the shieldedInstanceConfig is not enabled, it means that the Shielded VM is not enabled for that compute instance.

#### Using Python

Shielded VMs are virtual machines (VMs) on Google Cloud Platform hardened by a set of security controls that help defend against rootkits and bootkits. Using Python scripts, you can check if Shielded VMs are enabled for Compute Instances. Here are the steps:

1. **Set up Google Cloud SDK and Python Environment:**
   Before you start, make sure you have Google Cloud SDK installed and initialized and also Python environment set up. You can install Google Cloud SDK by following the instructions here: https://cloud.google.com/sdk/docs/install. For Python, you can use pip to install the necessary libraries: `pip install google-cloud-sdk`.

2. **Authentication:**
   Authenticate your SDK to access the Google Cloud resources. You can do this by running the command `gcloud auth application-default login` in your terminal. Follow the prompts and log in with your Google Cloud account.

3. **Use Python Script to Check Shielded VM Status:**
   Use the Google Cloud Client Libraries for Python to interact with the Compute Engine API. Here is a sample script:

```python
from google.cloud import compute_v1

def list_instances(project_id, zone):
    instances_client = compute_v1.InstancesClient()
    instances = instances_client.list(project=project_id, zone=zone)

    for instance in instances:
        shielded_instance_config = instance.shielded_instance_config
        if shielded_instance_config:
            print(f"Instance {instance.name} has Shielded VM enabled.")
        else:
            print(f"Instance {instance.name} does not have Shielded VM enabled.")

# Replace 'your-project-id' and 'your-zone' with your Project ID and Zone respectively.
list_instances('your-project-id', 'your-zone')
```

This script lists all the instances in the specified project and zone, and checks if each instance has Shielded VM enabled.

4. **Run the Script:**
   Save the script in a Python file (e.g., `check_shielded_vm.py`) and run it using the command `python check_shielded_vm.py`. The script will print out the status of Shielded VM for each instance in the specified project and zone.

Remember to replace 'your-project-id' and 'your-zone' with your actual Project ID and Zone.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Shielded VM Should Be Enabled For Compute Instances" misconfiguration for GCP using GCP console, please follow the below steps:

1. Login to the GCP Console using your credentials.
2. Go to the GCP Compute Engine page by clicking on the Navigation menu and selecting "Compute Engine" under the "Compute" section.
3. Select the instance for which you want to enable Shielded VM.
4. Click on the "Edit" button at the top of the page.
5. Under the "Security" section, select "Enable Shielded VM".
6. Click on the "Save" button at the bottom of the page to enable Shielded VM for the selected instance.

Once you have completed these steps, Shielded VM will be enabled for the selected instance. Repeat the above steps for all instances that are not configured with Shielded VM to remediate this misconfiguration.

#### Using CLI

To remediate the "Shielded VM Should Be Enabled For Compute Instances" misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP Console.

2. Run the following command to check the current status of shielded VM for all instances in your project:
   
   `gcloud compute instances list --format="table(name, shielded-vm-integrity-enabled)"`

   This will list all the compute instances in your project along with their shielded VM integrity status.

3. Identify the instances which have "false" in the "shielded-vm-integrity-enabled" column. These are the instances that need to be remediated.

4. Run the following command to enable shielded VM for the identified instances:

   `gcloud compute instances update INSTANCE_NAME --shielded-vm-integrity-enabled`

   Replace INSTANCE_NAME with the name of the instance that needs to be remediated.

5. Repeat step 4 for all the instances that need to be remediated.

6. Run the following command to verify that shielded VM is enabled for all instances:

   `gcloud compute instances list --format="table(name, shielded-vm-integrity-enabled)"`

   This will list all the compute instances in your project along with their shielded VM integrity status. All instances should now have "true" in the "shielded-vm-integrity-enabled" column.

7. Once you have verified that all instances have shielded VM enabled, you have successfully remediated the misconfiguration.

#### Using Python

To remediate the misconfiguration of Shielded VM not being enabled for Compute Instances in GCP, you can use the following Python script:

```python
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials

credentials = GoogleCredentials.get_application_default()
compute = discovery.build('compute', 'v1', credentials=credentials)

project = 'your-project-id'
zone = 'your-zone'

def enable_shielded_vm(compute, project, zone, instance_name):
    instance = compute.instances().get(project=project, zone=zone, instance=instance_name).execute()
    if 'shieldedInstanceConfig' not in instance:
        instance['shieldedInstanceConfig'] = {}
    instance['shieldedInstanceConfig']['enableSecureBoot'] = True
    instance['shieldedInstanceConfig']['enableVtpm'] = True
    instance['shieldedInstanceConfig']['enableIntegrityMonitoring'] = True
    request = compute.instances().update(project=project, zone=zone, instance=instance_name, body=instance)
    response = request.execute()
    return response

instance_name = 'your-instance-name'
response = enable_shielded_vm(compute, project, zone, instance_name)
print(response)
```

This script uses the Google Cloud Python Client Library to enable Shielded VM for a specific Compute Instance in GCP. It first checks if the instance already has a Shielded Instance Config, and if not, creates one. It then sets the enableSecureBoot, enableVtpm, and enableIntegrityMonitoring properties to True and sends a request to update the instance with the new configuration.

To use this script, replace "your-project-id", "your-zone", and "your-instance-name" with the appropriate values for your GCP project and instance. Then run the script in a Python environment with the Google Cloud Python Client Library installed.




</Tab>
</Tabs>