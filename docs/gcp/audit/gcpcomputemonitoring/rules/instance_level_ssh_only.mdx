---
slug: instance_level_ssh_only
title: SSH Keys Should Be Instance Specific
sidebar_label: SSH Keys Should Be Instance Specific
---

### More Info:

Instances should not be configured to allow project-wide SSH keys. To support the principle of least privilege and prevent potential privilege escalation, instances should not be given access to project-wide SSH keys.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISGCP, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your browser, navigate to the Google Cloud Platform Console (console.cloud.google.com) and sign in with your Google account credentials.

2. Navigate to Compute Engine: From the left-hand side menu, select "Compute Engine" and then "VM instances". This will display a list of all your virtual machine instances.

3. Check SSH Keys: For each instance, click on the instance name to open its details. Scroll down to the "SSH Keys" section. If there are any SSH keys listed that are not instance-specific, this indicates a misconfiguration.

4. Cross-Verify with Metadata: Go back to the Compute Engine menu and select "Metadata" from the left-hand side menu. Click on the "SSH Keys" tab. If there are any SSH keys listed here, it means they are not instance-specific and this is a misconfiguration. 

Remember, SSH keys should be instance-specific for better security. If SSH keys are added at the project level (Metadata), they can be used to connect to all instances within the project, which is not a recommended practice.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the gcloud CLI is set up, you can list all the Compute Engine instances in your project by running the following command:

   ```
   gcloud compute instances list
   ```

   This command will return a list of all the instances in your project, along with their details such as name, zone, machine type, internal IP, external IP, and status.

3. To check the SSH keys for a specific instance, you can use the following command:

   ```
   gcloud compute instances describe [INSTANCE_NAME] --format='value(metadata.items)'
   ```

   Replace `[INSTANCE_NAME]` with the name of the instance you want to check. This command will return the metadata of the instance, including the SSH keys.

4. To check if the SSH keys are instance-specific, you need to compare the SSH keys of all instances. If the same SSH key is used in more than one instance, then it is not instance-specific. You can do this manually by comparing the SSH keys of each instance, or you can write a script to automate this process.

#### Using Python

Detecting whether SSH keys are instance-specific in Compute across AWS, Azure, and GCP can be done using Python scripts. Here's how you can do it:

1. AWS:
   - Use the Boto3 library in Python to interact with AWS services.
   - Use the `describe_instances()` function to get a list of all instances.
   - For each instance, check the `KeyName` attribute. If the same `KeyName` is used across multiple instances, it's not instance-specific.
   - Python script example:
     ```python
     import boto3
     ec2 = boto3.resource('ec2')
     instances = ec2.instances.all()
     key_names = []
     for instance in instances:
         key_names.append(instance.key_name)
     if len(key_names) != len(set(key_names)):
         print("SSH keys are not instance-specific")
     ```

2. Azure:
   - Use the Azure SDK for Python to interact with Azure services.
   - Use the `list_all()` function to get a list of all virtual machines.
   - For each virtual machine, check the `os_profile.linux_configuration.ssh.public_keys.key_data` attribute. If the same key data is used across multiple virtual machines, it's not instance-specific.
   - Python script example:
     ```python
     from azure.mgmt.compute import ComputeManagementClient
     compute_client = ComputeManagementClient(credentials, subscription_id)
     vms = compute_client.virtual_machines.list_all()
     key_data = []
     for vm in vms:
         key_data.append(vm.os_profile.linux_configuration.ssh.public_keys.key_data)
     if len(key_data) != len(set(key_data)):
         print("SSH keys are not instance-specific")
     ```

3. GCP:
   - Use the Google Cloud Client Library for Python to interact with GCP services.
   - Use the `list()` function to get a list of all instances.
   - For each instance, check the `metadata.items` attribute for SSH keys. If the same SSH key is used across multiple instances, it's not instance-specific.
   - Python script example:
     ```python
     from google.cloud import compute_v1
     client = compute_v1.InstancesClient()
     instances = client.list(project=project, zone=zone)
     ssh_keys = []
     for instance in instances:
         for item in instance.metadata.items:
             if item.key == 'ssh-keys':
                 ssh_keys.append(item.value)
     if len(ssh_keys) != len(set(ssh_keys)):
         print("SSH keys are not instance-specific")
     ```

Please note that you need to replace `credentials`, `subscription_id`, `project`, and `zone` with your actual values. Also, these scripts assume that you have the necessary permissions to list instances and their details.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "SSH Keys Should Be Instance Specific" for GCP using GCP console, you can follow the below steps:

1. Login to the GCP console and select the project where the instance is running.
2. In the left navigation menu, select "Compute Engine" and then click on "VM instances".
3. Select the instance for which you want to remediate the misconfiguration.
4. Click on "Edit" button at the top of the page.
5. Scroll down to the "SSH Keys" section and click on "Show and edit".
6. Remove any public SSH keys that are not specific to the instance.
7. Add new SSH keys that are specific to the instance by clicking on "Add item" and pasting the public key in the text box.
8. Click on "Save" to save the changes.

By following these steps, you have successfully remediated the misconfiguration "SSH Keys Should Be Instance Specific" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration of SSH keys not being instance-specific in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP console.

2. Check the current SSH keys in your project using the following command:
```
gcloud compute os-login ssh-keys list
```

3. Identify the SSH keys that are not instance-specific and remove them using the following command:
```
gcloud compute os-login ssh-keys remove --key-file=<path-to-key-file>
```

4. Create a new instance-specific SSH key using the following command:
```
ssh-keygen -t rsa -f ~/.ssh/<key-file-name> -C <comment>
```

5. Add the new SSH key to your project using the following command:
```
gcloud compute os-login ssh-keys add --key-file=<path-to-key-file>
```

6. Create a new instance in GCP and specify the new SSH key as the metadata for the instance.

7. Connect to the new instance using the new instance-specific SSH key.

By following these steps, you can remediate the misconfiguration of SSH keys not being instance-specific in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "SSH Keys Should Be Instance Specific" for GCP using Python, you can follow the below steps:

1. First, you need to create a new SSH key pair for the instance. You can use the `paramiko` library in Python to generate an SSH key pair. 

   ```
   import paramiko

   ssh = paramiko.SSHClient()
   ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
   ssh.connect('instance-ip-address', username='username', password='password')
   ssh.exec_command('ssh-keygen -t rsa')
   ```

2. Once you have generated the SSH key pair, you need to add the public key to the instance's metadata. You can use the `google-auth` and `google-api-python-client` libraries in Python to interact with GCP APIs.

   ```
   from google.oauth2 import service_account
   from googleapiclient.discovery import build

   credentials = service_account.Credentials.from_service_account_file('path/to/credentials.json')

   compute = build('compute', 'v1', credentials=credentials)

   project_id = 'your-project-id'
   zone = 'instance-zone'
   instance_name = 'instance-name'

   instance = compute.instances().get(project=project_id, zone=zone, instance=instance_name).execute()

   metadata = instance['metadata']
   items = metadata.get('items', [])

   # Remove any existing SSH keys
   items = [item for item in items if item['key'] != 'ssh-keys']

   # Add the new SSH key
   ssh_key = 'ssh-rsa <public-key> instance-specific-key'
   items.append({'key': 'ssh-keys', 'value': ssh_key})

   # Update the instance metadata
   metadata['items'] = items
   compute.instances().setMetadata(project=project_id, zone=zone, instance=instance_name, body={'metadata': metadata}).execute()
   ```

3. Finally, you can test the new SSH key by connecting to the instance using the private key.

   ```
   ssh.connect('instance-ip-address', username='username', key_filename='/path/to/private/key')
   ```

By following these steps, you can remediate the misconfiguration "SSH Keys Should Be Instance Specific" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys) 


</Tab>
</Tabs>