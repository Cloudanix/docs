---
slug: vm_instances_least_privilege
title: VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs
sidebar_label: VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs
---

### More Info:

Instances should not be configured to use the default service account with full access to all cloud APIs. The principle of least privilege should be used to prevent potential privilege escalation.

### Risk Level

High

### Address

Security

### Compliance Standards

CISGCP, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform (GCP) Console (https://console.cloud.google.com/) and sign in with your GCP account. If you don't have an account, you'll need to create one.

2. Navigate to the VM Instances: From the GCP Console dashboard, select the project that you want to examine. In the left navigation panel, click on "Compute Engine" and then "VM instances". This will display a list of all the VM instances that are currently running in your selected project.

3. Check the Service Account: For each VM instance, click on the instance name to open its "Instance details" page. Scroll down to the "Cloud API access scopes" section. Here, you can see the service account associated with the VM instance and the access scopes it has. If the service account is the default one (PROJECT_NUMBER-compute@developer.gserviceaccount.com) and the access scope is set to "Allow full access to all Cloud APIs", then the VM instance is using the default service account with full access to Cloud APIs.

4. Repeat the Process: Repeat the process for all the VM instances in your project. If you have multiple projects, you'll need to check each one individually.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: Before you can use the Google Cloud CLI, you need to install it on your local machine and authenticate it with your Google Cloud account. You can download the SDK from the official Google Cloud website and follow the instructions to install it. Once installed, you can authenticate it by running the following command in your terminal:

   ```
   gcloud auth login
   ```

2. List all the VM instances: Once the SDK is authenticated, you can list all the VM instances in your project by running the following command:

   ```
   gcloud compute instances list
   ```

3. Check the service account for each VM instance: For each VM instance, you can check the service account it's using by running the following command:

   ```
   gcloud compute instances describe [INSTANCE_NAME] --format='value(serviceAccounts[].email)'
   ```

   Replace `[INSTANCE_NAME]` with the name of your VM instance. This command will return the email of the service account that the VM instance is using.

4. Check the permissions of the service account: For each service account, you can check its permissions by running the following command:

   ```
   gcloud iam service-accounts get-iam-policy [SERVICE_ACCOUNT_EMAIL] --format='value(bindings[].role)'
   ```

   Replace `[SERVICE_ACCOUNT_EMAIL]` with the email of your service account. This command will return the roles that the service account has. If the service account has the role `roles/editor`, it means it has full access to all Cloud APIs, which is a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: You will need the `google-auth`, `google-auth-httplib2`, `google-auth-oauthlib`, `google-auth-urllib3`, and `google-api-python-client` libraries. You can install these using pip:

```python
pip install --upgrade google-auth google-auth-httplib2 google-auth-oauthlib google-auth-urllib3 google-api-python-client
```

2. Authenticate and create a service client: Before you can interact with the GCP APIs, you need to authenticate your client. Here's how you can do it:

```python
from google.oauth2 import service_account
from googleapiclient import discovery

# Load the credentials from the service account key file
credentials = service_account.Credentials.from_service_account_file('path/to/keyfile.json')

# Build the service
compute = discovery.build('compute', 'v1', credentials=credentials)
```

3. List all instances and check their service accounts: Now that you have a service client, you can use it to list all instances and check their service accounts. Here's how you can do it:

```python
# Get the project ID
project_id = 'your-project-id'

# List all instances
request = compute.instances().aggregatedList(project=project_id)
while request is not None:
    response = request.execute()

    # Iterate over all instances
    for name, instances_scoped_list in response['items'].items():
        # Check if there are any instances in this zone
        if 'instances' in instances_scoped_list:
            # Iterate over all instances in this zone
            for instance in instances_scoped_list['instances']:
                # Check the service account
                if 'serviceAccounts' in instance:
                    for service_account in instance['serviceAccounts']:
                        # Check if the service account is the default one and has full access
                        if service_account['email'] == 'default' and 'https://www.googleapis.com/auth/cloud-platform' in service_account['scopes']:
                            print(f"Instance {instance['name']} in project {project_id} is using the default service account with full access to all Cloud APIs.")

    # Get the next list of instances
    request = compute.instances().aggregatedList_next(previous_request=request, previous_response=response)
```

4. Analyze the output: The script will print out the names of all instances that are using the default service account with full access to all Cloud APIs. You can use this information to identify misconfigurations.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs" for GCP using GCP console, follow these steps:

1. Go to the Google Cloud Console and select the project that contains the VM instances with default service accounts.

2. Click on the "Compute Engine" option from the left-hand side menu.

3. From the Compute Engine menu, select the "VM instances" option.

4. Select the VM instance that is using the default service account with full access to Cloud APIs.

5. Click on the "Edit" button at the top of the page.

6. Scroll down to the "Service account" section and click on the "Change" button.

7. Select "Create a new service account" from the dropdown menu.

8. Give the new service account a name and description.

9. Under "Role", select the appropriate role for the service account based on the permissions required for the VM instance.

10. Click on the "Save" button to create the new service account.

11. Once the new service account is created, select it from the "Service account" dropdown menu.

12. Click on the "Save" button to apply the changes.

13. Repeat these steps for all VM instances that are using the default service account with full access to Cloud APIs.

By following these steps, you will remediate the misconfiguration "VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs" for GCP using GCP CLI, please follow the steps below:

1. List all the VM instances in your GCP project using the following command:
```
gcloud compute instances list
```

2. For each VM instance that is using the default service account, create a new service account with limited access using the following command:
```
gcloud iam service-accounts create [SA-NAME] --description="[SA-DESCRIPTION]"
```
Replace [SA-NAME] with the name of your new service account and [SA-DESCRIPTION] with a brief description of the account.

3. Grant the new service account the minimum required permissions using the following command:
```
gcloud projects add-iam-policy-binding [PROJECT-ID] --member="serviceAccount:[SA-EMAIL]" --role="[ROLE]"
```
Replace [PROJECT-ID] with your GCP project ID, [SA-EMAIL] with the email address of your new service account, and [ROLE] with the minimum required role for your VM instance.

4. Update your VM instance to use the new service account using the following command:
```
gcloud compute instances set-service-account [INSTANCE-NAME] --service-account=[SA-EMAIL]
```
Replace [INSTANCE-NAME] with the name of your VM instance and [SA-EMAIL] with the email address of your new service account.

5. Verify that your VM instance is now using the new service account by running the following command:
```
gcloud compute instances describe [INSTANCE-NAME] --format="get(serviceAccounts.email)"
```
Replace [INSTANCE-NAME] with the name of your VM instance.

Repeat steps 2-5 for each VM instance that is using the default service account. This will ensure that your VM instances are not using the default service account with full access to Cloud APIs.

#### Using Python

To remediate the misconfiguration "VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs" for GCP using Python, follow the below steps:

1. First, identify the VM instances that are using the default service accounts with full access to Cloud APIs. You can use the following command to get the list of VM instances:

```python
from google.cloud import compute_v1

compute_client = compute_v1.InstancesClient()
project = "your-project-id"

instances = compute_client.list(project=project)
for instance in instances:
    for access_config in instance.service_accounts:
        if access_config.email.endswith('gserviceaccount.com') and 'Editor' in access_config.scopes:
            print(f"Instance {instance.name} is using the default service account with full access to Cloud APIs.")
```

2. Once you have identified the VM instances, create a new service account with the necessary permissions and grant it to the instances. You can use the following code to create a new service account:

```python
from google.cloud import iam_v1

iam_client = iam_v1.IAMClient()
project_id = "your-project-id"
service_account_name = "your-service-account-name"
display_name = "your-display-name"

parent = f"projects/{project_id}"
service_account = iam_client.create_service_account(
    request={
        "name": f"{parent}/serviceAccounts/{service_account_name}",
        "accountId": service_account_name,
        "service_account": {
            "display_name": display_name
        }
    }
)

print(f"Created service account with name: {service_account.name}")
```

3. After creating the new service account, grant it the necessary permissions. You can use the following code to grant the necessary roles to the service account:

```python
from google.cloud import iam_v1

iam_client = iam_v1.IAMClient()
project_id = "your-project-id"
service_account_email = "your-service-account-email"
roles = ["roles/logging.logWriter", "roles/monitoring.metricWriter"]

policy = iam_client.get_policy(request={"resource": f"projects/{project_id}"})
bindings = policy.bindings

for role in roles:
    binding = next((b for b in bindings if b.role == role), None)
    if binding is None:
        binding = policy.bindings.add(role=role)
    binding.members.append(f"serviceAccount:{service_account_email}")

iam_client.set_iam_policy(request={"resource": f"projects/{project_id}", "policy": policy})
print(f"Granted roles to service account {service_account_email}")
```

4. Finally, update the VM instances to use the newly created service account. You can use the following code to update the VM instances:

```python
from google.cloud import compute_v1

compute_client = compute_v1.InstancesClient()
project = "your-project-id"
zone = "your-zone"
instance_name = "your-instance-name"
service_account_email = "your-service-account-email"

instance = compute_client.get(project=project, zone=zone, instance=instance_name)
instance.service_accounts = [
    {
        "email": service_account_email,
        "scopes": ["https://www.googleapis.com/auth/cloud-platform"]
    }
]
update_mask = ["service_accounts"]

operation = compute_client.update(project=project, zone=zone, instance=instance_name, instance_resource=instance, update_mask=update_mask)
print(f"Updated instance {instance_name} with new service account.")
```

By following the above steps, you can remediate the misconfiguration "VM Instances Should Not Use Default Service Accounts With Full Access To Cloud APIs" for GCP using Python.


### Additional Reading:

- [https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances](https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances) 


</Tab>
</Tabs>