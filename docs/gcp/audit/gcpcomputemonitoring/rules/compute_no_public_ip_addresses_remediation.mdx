

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the "Compute Engine" section. You can do this by clicking on the navigation menu (three horizontal lines at the top-left corner), then scroll down and click on "Compute Engine".

3. In the Compute Engine section, click on "VM instances". This will display a list of all your virtual machine (VM) instances.

4. For each VM instance, check the "External IP" column. If any VM instance has a public IP address listed, it means that the instance has a public IP.

#### Using CLI

1. Install and authenticate Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine and authenticate it. You can download the SDK from the official Google Cloud website and follow the instructions to install it. After installation, authenticate the SDK using the command `gcloud auth login`.

2. List all the instances: Use the `gcloud compute instances list` command to list all the instances in your GCP project. This command will return a table that includes the instance name, zone, machine type, internal IP, and external IP.

3. Filter instances with public IPs: To find instances with public IPs, you can look at the 'EXTERNAL_IP' column of the table. If an instance has a public IP, it will be listed in this column. 

4. Use a script to automate the process: If you have a large number of instances, it might be more efficient to use a script to automate this process. Here is a simple Python script that uses the GCP CLI to find instances with public IPs:

```python
import subprocess

# Run the gcloud command to list instances
output = subprocess.check_output("gcloud compute instances list", shell=True)

# Split the output into lines
lines = output.split('\n')

# For each line, check if there is an external IP
for line in lines:
    parts = line.split()
    if len(parts) > 4 and parts[4] != 'None':
        print("Instance with public IP found: " + parts[0])
```

This script runs the `gcloud compute instances list` command, splits the output into lines, and checks each line to see if there is an external IP. If it finds an instance with a public IP, it prints the name of the instance.

#### Using Python

1. AWS:
   - Install and configure AWS SDK for Python (Boto3).
   - Use the `describe_instances()` function to retrieve all EC2 instances.
   - Check the `PublicIpAddress` attribute for each instance. If it's not `None`, the instance has a public IP.
   - Python script:
     ```python
     import boto3
     ec2 = boto3.resource('ec2')
     for instance in ec2.instances.all():
         if instance.public_ip_address:
             print(f"Instance {instance.id} has a public IP address.")
     ```

2. Azure:
   - Install and configure Azure SDK for Python.
   - Use the `list_all()` function to retrieve all VMs.
   - Check the `ip_configurations` attribute for each VM. If `public_ip_address` is not `None`, the VM has a public IP.
   - Python script:
     ```python
     from azure.mgmt.compute import ComputeManagementClient
     compute_client = ComputeManagementClient(credentials, subscription_id)
     for vm in compute_client.virtual_machines.list_all():
         for nic in vm.network_profile.network_interfaces:
             for ip_config in nic.ip_configurations:
                 if ip_config.public_ip_address:
                     print(f"VM {vm.name} has a public IP address.")
     ```

3. GCP:
   - Install and configure Google Cloud SDK for Python.
   - Use the `list()` function to retrieve all Compute Engine instances.
   - Check the `networkInterfaces` attribute for each instance. If `accessConfigs` contains a `natIP`, the instance has a public IP.
   - Python script:
     ```python
     from google.cloud import compute_v1
     client = compute_v1.InstancesClient()
     for instance in client.list(project=project, zone=zone):
         for interface in instance.network_interfaces:
             for access_config in interface.access_configs:
                 if access_config.nat_ip:
                     print(f"Instance {instance.name} has a public IP address.")
     ```

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Compute Instances Should Not Have Public IPs" in GCP using GCP console, please follow the below steps:

1. Login to GCP console (https://console.cloud.google.com/).
2. In the navigation menu, click on "Compute Engine".
3. Click on "VM instances".
4. Select the instance for which you want to remove the public IP.
5. Click on "Edit" button at the top of the page.
6. Scroll down to the "Network interfaces" section.
7. Under "External IP", select "None" from the dropdown menu.
8. Click on "Save" to save the changes.

Once the changes are saved, the public IP will be removed from the instance and it will no longer be accessible publicly.

#### Using CLI

To remediate the misconfiguration of compute instances having public IPs in GCP using GCP CLI, follow these steps:

1. Open the GCP CLI and authenticate with your GCP account credentials.

2. Identify the instances that have public IPs assigned to them. You can use the following command to list all the instances in your project:

   ```
   gcloud compute instances list
   ```

   This will list all the instances in your project along with their details, including their public IPs.

3. Remove the public IP address from each instance using the following command:

   ```
   gcloud compute instances delete-access-config [INSTANCE_NAME] \
   --access-config-name "External NAT"
   ```

   Replace [INSTANCE_NAME] with the name of the instance that you want to remove the public IP from. This command will delete the external NAT access configuration from the instance, which will remove the public IP address.

4. Repeat the above step for all the instances that have public IPs assigned to them until all the instances have their public IPs removed.

5. Verify that the instances no longer have public IPs assigned to them using the following command:

   ```
   gcloud compute instances list
   ```

   This will list all the instances in your project along with their details, including their IP addresses. Verify that the instances no longer have public IPs assigned to them.

By following these steps, you can remediate the misconfiguration of compute instances having public IPs in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Compute Instances Should Not Have Public IPs" in GCP using Python, you can follow the below steps:

Step 1: Get a list of all the Compute Instances with Public IPs. This can be done by using the Google Cloud SDK and running the following command:

```
gcloud compute instances list --filter="networkInterfaces.accessConfigs.natIP:*"
```

This command will return a list of all the Compute Instances that have a Public IP associated with them.

Step 2: Use the Google Cloud Python Client Library to update the instances and remove the Public IP. You can use the following Python script:

```python
from google.cloud import compute_v1

# Create a Compute Engine client object
compute_client = compute_v1.InstancesClient()

# Project ID for this request.
project = 'your-project-id'  # TODO: Update placeholder value.

# Zone name for this request.
zone = 'us-central1-a'  # TODO: Update placeholder value.

# Get the list of instances with public IPs
instances = compute_client.list(project=project, zone=zone, filter="networkInterfaces.accessConfigs.natIP:*")

for instance in instances:
    # Remove the Public IP from the instance
    instance.network_interfaces[0].access_configs[0].nat_ip = None

    # Update the instance
    operation = compute_client.update(project=project, zone=zone, instance=instance.name, instance=instance)

    # Wait for the operation to complete
    result = operation.result()

    print(f"Public IP removed from instance {instance.name}")
```

This script will loop through all the instances with Public IPs and remove the Public IP from them. It will then print a message for each instance that has been updated.

Step 3: Run the Python script to remediate the misconfiguration. 

Note: Before running the script, make sure you have set up the Google Cloud SDK and installed the Google Cloud Python Client Library.


</Tab>
</Tabs>