

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Compute Engine: From the left-hand side menu, select "Compute Engine" and then "VM instances". This will display a list of all the VM instances in your project.

3. Check Service Account: For each VM instance, under the "Details" tab, look for the "Cloud API access scopes" section. If the service account is set to "Default", then the VM instance is using the default service account.

4. Repeat for all VM Instances: Repeat the above step for all VM instances in your project. If any VM instance is using the default service account, it indicates a misconfiguration.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: Before you can use the Google Cloud CLI, you need to install it on your local machine and authenticate it with your Google Cloud account. You can download the SDK from the official Google Cloud website and follow the instructions to install it. Once installed, you can authenticate it by running the following command in your terminal:

   ```
   gcloud auth login
   ```

   This will open a new window in your web browser asking you to log in with your Google account. Once logged in, the CLI will be authenticated and ready to use.

2. Set your project ID: Before you can run any commands related to your Google Cloud resources, you need to set the project ID that you want to work with. You can do this by running the following command:

   ```
   gcloud config set project [PROJECT_ID]
   ```

   Replace `[PROJECT_ID]` with the ID of your Google Cloud project.

3. List all VM instances: You can list all the VM instances in your project by running the following command:

   ```
   gcloud compute instances list
   ```

   This will return a list of all the VM instances in your project, along with some basic information about them.

4. Check the service account for each VM instance: For each VM instance, you can check the service account it's using by running the following command:

   ```
   gcloud compute instances describe [INSTANCE_NAME] --format='value(serviceAccounts[].email)'
   ```

   Replace `[INSTANCE_NAME]` with the name of the VM instance. This command will return the email address of the service account that the VM instance is using. If the email address ends with `@developer.gserviceaccount.com`, then the VM instance is using the default service account.

#### Using Python

1. Install the necessary Python libraries: You will need the `google-auth`, `google-auth-httplib2`, `google-auth-oauthlib`, `google-auth-urllib3`, `google-api-python-client`, and `oauthlib` libraries. You can install these using pip:

```python
pip install --upgrade google-auth google-auth-httplib2 google-auth-oauthlib google-auth-urllib3 google-api-python-client oauthlib
```

2. Authenticate to Google Cloud: Before you can interact with the Google Cloud APIs, you need to authenticate. You can do this using a service account key file:

```python
from google.oauth2 import service_account

# Load the service account key file
credentials = service_account.Credentials.from_service_account_file(
    '/path/to/keyfile.json')

# Specify the project ID
project_id = 'my-project'
```

3. Connect to the Compute Engine API: Once you're authenticated, you can connect to the Compute Engine API:

```python
from googleapiclient import discovery

# Build the service
service = discovery.build('compute', 'v1', credentials=credentials)
```

4. Check for VM instances using the default service account: You can now use the Compute Engine API to list all VM instances and check if they're using the default service account:

```python
# Get the list of instances
request = service.instances().list(project=project_id, zone='us-central1-a')
response = request.execute()

# Check each instance
for instance in response['items']:
    if 'serviceAccounts' in instance:
        for service_account in instance['serviceAccounts']:
            if service_account['email'] == 'default':
                print(f"Instance {instance['name']} is using the default service account.")
```

This script will print the names of all instances that are using the default service account. If no instances are using the default service account, it will not print anything.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration "VM Instances Should Not Use Default Service Account" for GCP using GCP console:

1. Open the GCP console and navigate to the Compute Engine page.

2. Select the VM instance that is using the default service account.

3. Click on the "Edit" button at the top of the page.

4. Scroll down to the "Cloud API access scopes" section.

5. Click on the "Set access for each API" link.

6. Uncheck the box next to "Allow default access to all Cloud APIs".

7. Select the specific API access scopes that are required for the VM instance.

8. Click on the "Save" button at the bottom of the page.

9. Repeat steps 2-8 for all VM instances that are using the default service account.

By following these steps, you will remediate the misconfiguration "VM Instances Should Not Use Default Service Account" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "VM Instances Should Not Use Default Service Account" in GCP using GCP CLI, you can follow the below steps:

Step 1: List all the instances that are using the default service account by running the following command:

```
gcloud compute instances list --filter="serviceAccounts.email:[PROJECT_NUMBER]-compute@developer.gserviceaccount.com"
```

Note: Replace [PROJECT_NUMBER] with your GCP project number.

Step 2: For each instance that is using the default service account, create a new service account and assign the required IAM roles to it by running the following commands:

```
gcloud iam service-accounts create [NEW_SERVICE_ACCOUNT_NAME] --display-name "[NEW_SERVICE_ACCOUNT_DISPLAY_NAME]"

gcloud projects add-iam-policy-binding [PROJECT_ID] --member="serviceAccount:[NEW_SERVICE_ACCOUNT_NAME]@[PROJECT_ID].iam.gserviceaccount.com" --role="[REQUIRED_IAM_ROLE]"
```

Note: Replace [NEW_SERVICE_ACCOUNT_NAME] and [NEW_SERVICE_ACCOUNT_DISPLAY_NAME] with the desired name and display name for the new service account, [PROJECT_ID] with your GCP project ID and [REQUIRED_IAM_ROLE] with the required IAM role for the instance.

Step 3: Update the instance to use the new service account by running the following command:

```
gcloud compute instances set-service-account [INSTANCE_NAME] --service-account [NEW_SERVICE_ACCOUNT_NAME]@[PROJECT_ID].iam.gserviceaccount.com
```

Note: Replace [INSTANCE_NAME] with the name of the instance that needs to be updated and [NEW_SERVICE_ACCOUNT_NAME]@[PROJECT_ID].iam.gserviceaccount.com with the name of the new service account created in Step 2.

Step 4: Verify that the instance is now using the new service account by running the following command:

```
gcloud compute instances describe [INSTANCE_NAME] --format="get(serviceAccounts.email)"
```

Note: Replace [INSTANCE_NAME] with the name of the instance that was updated in Step 3.

Repeat the above steps for all the instances that are using the default service account to remediate the misconfiguration.

#### Using Python

To remediate the issue "VM Instances Should Not Use Default Service Account" for GCP using Python, you can follow the below steps:

1. First, we need to identify the list of all VM instances that are using the default service account. This can be achieved by using the Google Cloud Python SDK's `googleapiclient` library.

```python
from googleapiclient import discovery
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('path/to/credentials.json')

compute = discovery.build('compute', 'v1', credentials=credentials)

project = 'project-id'

instances = compute.instances().list(project=project).execute()

for instance in instances['items']:
    if instance['serviceAccounts'][0]['email'].endswith('gserviceaccount.com'):
        print(f"Instance {instance['name']} is using the default service account.")
```

2. Once we have identified the instances that are using the default service account, we need to update the service account for each instance. This can be done using the `instances().setServiceAccount` method.

```python
for instance in instances['items']:
    if instance['serviceAccounts'][0]['email'].endswith('gserviceaccount.com'):
        print(f"Instance {instance['name']} is using the default service account.")
        updated_instance = compute.instances().setServiceAccount(
            project=project,
            zone=instance['zone'].split('/')[-1],
            instance=instance['name'],
            body={
                "serviceAccounts": [
                    {
                        "email": "new-service-account@project-id.iam.gserviceaccount.com",
                        "scopes": [
                            "https://www.googleapis.com/auth/cloud-platform"
                        ]
                    }
                ]
            }
        ).execute()
        print(f"Updated service account for instance {instance['name']} to new-service-account@project-id.iam.gserviceaccount.com.")
```

In the above code, we are updating the service account for each instance to a new service account `new-service-account@project-id.iam.gserviceaccount.com` with `cloud-platform` scope. You can replace this with the appropriate service account and scopes as per your requirements.

3. Finally, you can verify that the instances are no longer using the default service account by running the code in step 1 again.


</Tab>
</Tabs>