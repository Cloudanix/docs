---
slug: storage_disallow_public_reads
title: Buckets Should Not Allow All Users Reads
sidebar_label: Buckets Should Not Allow All Users Reads
---

### More Info:

Ensure that cloud Storage buckets do not allow All Users to Read ("allUsers" must not have "READER" roles)

### Risk Level

Critical

### Address

Security

### Compliance Standards

NIST


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the "Storage" section. This can be found under the "Storage" option in the left-hand side menu.

3. Once you are in the "Storage" section, you will see a list of all your storage buckets. Click on the name of the bucket that you want to check.

4. In the bucket details page, navigate to the "Permissions" tab. Here, you can see all the permissions that are currently set for the bucket. If you see "allUsers" or "allAuthenticatedUsers" with the role of "Storage Object Viewer" or "Storage Legacy Bucket Reader", it means that the bucket allows all users to read its content.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: The Google Cloud SDK includes the gcloud command-line tool, which is necessary to interact with your GCP resources. You can install it by following the instructions provided by Google Cloud. After installation, authenticate the SDK using the command `gcloud auth login`.

2. List all the buckets in your project: Use the `gsutil ls` command to list all the buckets in your project. The command is as follows:
   ```
   gsutil ls
   ```
   This command will return a list of all the buckets in your project.

3. Check the IAM policies for each bucket: For each bucket, you can check the IAM policies to see if they allow all users read access. The command to check the IAM policies is as follows:
   ```
   gsutil iam get gs://[BUCKET_NAME]
   ```
   Replace `[BUCKET_NAME]` with the name of your bucket. This command will return the IAM policy for the specified bucket.

4. Look for AllUsers in the IAM policy: If the IAM policy includes "allUsers" in the "members" field, then the bucket allows all users read access. This is a misconfiguration because it allows anyone on the internet to read the bucket's contents. You can manually look for "allUsers" in the IAM policy, or you can use a command like the following to automatically search for it:
   ```
   gsutil iam get gs://[BUCKET_NAME] | grep allUsers
   ```
   If this command returns any output, then the bucket allows all users read access.

#### Using Python

1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. For AWS, you would need boto3, for Azure, you would need azure-storage-blob, and for GCP, you would need google-cloud-storage. You can install these libraries using pip.

```python
pip install boto3 azure-storage-blob google-cloud-storage
```

2. Connect to the cloud service: The next step is to connect to the cloud service. You would need to authenticate your script with the cloud service. Here is how you can do it for each service:

AWS:
```python
import boto3
s3 = boto3.resource('s3')
```

Azure:
```python
from azure.storage.blob import BlobServiceClient
blob_service_client = BlobServiceClient.from_connection_string("my_connection_string")
```

GCP:
```python
from google.cloud import storage
client = storage.Client()
```

3. List all the buckets: Once you are connected to the service, you can list all the buckets. Here is how you can do it:

AWS:
```python
for bucket in s3.buckets.all():
    print(bucket.name)
```

Azure:
```python
for container in blob_service_client.list_containers():
    print(container.name)
```

GCP:
```python
for bucket in client.list_buckets():
    print(bucket.name)
```

4. Check the permissions: The final step is to check the permissions of each bucket. If a bucket allows all users to read, it is a misconfiguration. Here is how you can check it:

AWS:
```python
for bucket in s3.buckets.all():
    acl = bucket.Acl()
    for grant in acl.grants:
        if grant['Grantee']['Type'] == 'Group' and 'AllUsers' in grant['Grantee']['URI']:
            print(f"Bucket {bucket.name} allows all users to read")
```

Azure:
```python
for container in blob_service_client.list_containers():
    acl = blob_service_client.get_container_access_policy(container.name)
    if acl and 'publicAccess' in acl and acl['publicAccess'] != 'None':
        print(f"Container {container.name} allows all users to read")
```

GCP:
```python
for bucket in client.list_buckets():
    policy = bucket.get_iam_policy()
    for role in policy:
        if role == 'roles/storage.objectViewer':
            for member in policy[role]:
                if member == 'allUsers':
                    print(f"Bucket {bucket.name} allows all users to read")
```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of "Buckets should not allow all users reads" for GCP using GCP console, you can follow these steps:

1. Open the GCP Console and go to the Cloud Storage section.

2. Select the bucket that you want to remediate.

3. Click on the "Permissions" tab.

4. Under the "Members" section, find the "allUsers" entry.

5. Click on the "Edit" button next to "allUsers".

6. In the "Select a role" dropdown, select "Storage Object Viewer".

7. Click on the "Save" button to save the changes.

8. Verify that the "allUsers" entry now has the "Storage Object Viewer" role assigned to it.

By following these steps, you have successfully remediated the issue of "Buckets should not allow all users reads" for the selected bucket in GCP using GCP console.

#### Using CLI

To remediate the issue of buckets allowing all users reads in GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP console.

2. Run the following command to list all the buckets in your project: 

```
gsutil ls
```

3. Identify the bucket that is allowing all users to read.

4. Run the following command to revoke the permissions for all users to read the bucket:

```
gsutil iam ch -d allUsers:objectViewer gs://[BUCKET_NAME]
```

Replace [BUCKET_NAME] with the name of the bucket that you identified in step 3.

5. Verify that the permissions have been revoked by running the following command:

```
gsutil iam get gs://[BUCKET_NAME]
```

This command will display the current IAM policy for the bucket.

6. Check the IAM policy to ensure that only authorized users have access to the bucket. 

7. Repeat the above steps for all the buckets in your project that are allowing all users to read. 

By following these steps, you can remediate the issue of buckets allowing all users reads in GCP using GCP CLI.

#### Using Python

To remediate the issue of allowing all users to read buckets in GCP using Python, you can follow the below steps:

1. First, you need to authenticate with GCP using the service account key. You can create a service account and download the JSON key file from the GCP console.

```python
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('<path/to/service_account_key.json>')
```

2. Next, you need to import the necessary libraries to interact with GCP Storage.

```python
from google.cloud import storage
from google.cloud.storage import Bucket
```

3. Now, create a client object to interact with GCP Storage.

```python
client = storage.Client(credentials=credentials)
```

4. Get a list of all the buckets in the project.

```python
buckets = client.list_buckets()
```

5. For each bucket, check if the `allUsers` entity has the `storage.objects.get` permission. If it does, remove the permission.

```python
for bucket in buckets:
    bucket: Bucket
    if bucket.acl.all_authenticated().grant('storage.objects.get') is not None:
        bucket.acl.all_authenticated().revoke('storage.objects.get')
```

6. Finally, confirm that the `allUsers` entity does not have the `storage.objects.get` permission.

```python
for bucket in buckets:
    bucket: Bucket
    print(bucket.acl.all_authenticated().has_permission('storage.objects.get'))
```

This Python script will remediate the issue of allowing all users to read buckets in GCP by removing the `storage.objects.get` permission for the `allUsers` entity.




</Tab>
</Tabs>