

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to view and manage storage buckets.

2. Navigate to Storage: From the main dashboard of the Google Cloud Platform Console, click on the navigation menu (three horizontal lines) located at the top left corner of the page. Scroll down and click on "Storage" under the "STORAGE" section. This will take you to the "Browser" page where you can see all your storage buckets.

3. Check Retention Policy: Click on the name of the bucket for which you want to check the retention policy. This will take you to the bucket details page. Click on the "Retention" tab. Here, you can see the current retention policy settings for the bucket. If the retention policy is not locked or the minimum duration is not specified, then it is a misconfiguration.

4. Use Cloud Shell for Verification: For further verification, you can use the Cloud Shell feature in the GCP console. Click on the Cloud Shell icon at the top right corner of the console. In the Cloud Shell command line, type the following command: `gsutil retention get gs://[BUCKET_NAME]`. Replace `[BUCKET_NAME]` with the name of your bucket. This command will display the current retention policy settings for the bucket. If the policy is not locked or the minimum duration is not specified, then it is a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and configured, you can list all the buckets in your project by running the following command in your terminal:
   ```
   gsutil ls
   ```
   This command will return a list of all the buckets in your project.

3. To check the retention policy of a specific bucket, use the following command:
   ```
   gsutil retention get gs://[BUCKET_NAME]
   ```
   Replace `[BUCKET_NAME]` with the name of the bucket you want to check. This command will return the retention policy of the specified bucket.

4. To check if the retention policy is locked, use the following command:
   ```
   gsutil retention info gs://[BUCKET_NAME]
   ```
   Replace `[BUCKET_NAME]` with the name of the bucket you want to check. This command will return information about the retention policy of the specified bucket, including whether or not it is locked. If the policy is locked, the output will include "isLocked: true". If the policy is not locked, the output will include "isLocked: false".

#### Using Python

1. **Import Necessary Libraries**: The first step is to import the necessary libraries in your Python script. You will need the 'google.cloud' library for interacting with GCP, 'boto3' for AWS, and 'azure-storage-blob' for Azure. 

```python
from google.cloud import storage
import boto3
from azure.storage.blob import BlobServiceClient
```

2. **Create Connection to the Cloud Service**: The next step is to create a connection to the respective cloud service. 

For GCP:
```python
def create_connection_gcp():
    storage_client = storage.Client()
    return storage_client
```
For AWS:
```python
def create_connection_aws():
    s3 = boto3.resource('s3')
    return s3
```
For Azure:
```python
def create_connection_azure():
    blob_service_client = BlobServiceClient.from_connection_string(my_connection_string)
    return blob_service_client
```

3. **Check Retention Policy**: Now, you can check the retention policy of the storage buckets. 

For GCP:
```python
def check_retention_policy_gcp(storage_client):
    buckets = storage_client.list_buckets()
    for bucket in buckets:
        if bucket.retention_period is None or bucket.retention_period < MIN_RETENTION_PERIOD:
            print(f"Bucket {bucket.name} has a misconfigured retention policy.")
```
For AWS:
```python
def check_retention_policy_aws(s3):
    for bucket in s3.buckets.all():
        try:
            retention = bucket.get_bucket_lifecycle_configuration()
            if 'Rules' not in retention or any(rule['Status'] == 'Disabled' or rule['Expiration']['Days'] < MIN_RETENTION_PERIOD for rule in retention['Rules']):
                print(f"Bucket {bucket.name} has a misconfigured retention policy.")
        except:
            print(f"Bucket {bucket.name} has a misconfigured retention policy.")
```
For Azure:
```python
def check_retention_policy_azure(blob_service_client):
    all_containers = blob_service_client.list_containers(include_metadata=True)
    for container in all_containers:
        properties = blob_service_client.get_container_properties(container.name)
        if 'hasImmutabilityPolicy' in properties and properties['hasImmutabilityPolicy'] is True:
            policy = blob_service_client.get_container_immutability_policy(container.name)
            if policy.immutabilityPeriodSinceCreationInDays < MIN_RETENTION_PERIOD:
                print(f"Container {container.name} has a misconfigured retention policy.")
        else:
            print(f"Container {container.name} has a misconfigured retention policy.")
```

4. **Run the Checks**: Finally, you can run the checks by calling the functions.

```python
MIN_RETENTION_PERIOD = 30  # Set your minimum retention period

# GCP
storage_client = create_connection_gcp()
check_retention_policy_gcp(storage_client)

# AWS
s3 = create_connection_aws()
check_retention_policy_aws(s3)

# Azure
blob_service_client = create_connection_azure()
check_retention_policy_azure(blob_service_client)
```

This script will print out the names of all the storage buckets or containers that have a misconfigured retention policy.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the retention policy misconfiguration in GCP using the GCP console, follow these steps:

1. Open the GCP console and navigate to the Cloud Storage section.

2. Click on the bucket that you want to remediate.

3. Click on the "Edit Bucket" button at the top of the page.

4. Scroll down to the "Retention Policy" section.

5. Click on the "Add Retention Policy" button.

6. Set the "Minimum retention period" to the desired duration.

7. Check the "Locked" checkbox to prevent any changes to the retention policy.

8. Click on the "Save" button to apply the changes.

9. Verify that the retention policy has been successfully applied by checking the "Retention Policy" section.

By following these steps, the retention policy misconfiguration will be remediated for the selected GCP bucket.

#### Using CLI

To remediate the retention policy misconfiguration for GCP using GCP CLI, follow these steps:

1. Open the GCP console and go to the Cloud Storage section.
2. Identify the bucket that has the misconfigured retention policy.
3. Open the Cloud Shell from the top right corner of the GCP console.
4. Run the following command to set the retention policy for the identified bucket:
   
   ```
   gsutil retention set <duration> gs://<bucket-name>
   ```
   
   Replace `<duration>` with the minimum duration for which the retention policy must be locked, and `<bucket-name>` with the name of the bucket that needs to be remediated.
   
5. Verify that the retention policy has been set correctly by running the following command:

   ```
   gsutil retention get gs://<bucket-name>
   ```
   
   This command should return the minimum duration for which the retention policy has been set.
   
6. If required, repeat the above steps for any other buckets that have the same misconfiguration.

By following these steps, you can remediate the retention policy misconfiguration for GCP using GCP CLI.

#### Using Python

To remediate the retention policy misconfiguration for GCP using Python, follow these steps:

1. Import the necessary libraries:

```
from google.cloud import logging_v2
from google.protobuf.duration_pb2 import Duration
```

2. Set the project ID and log name:

```
project_id = "<your-project-id>"
log_name = "<your-log-name>"
```

3. Create a Logging client:

```
logging_client = logging_v2.LoggingServiceV2Client()
```

4. Get the current retention policy for the log:

```
log_path = logging_client.log_path(project_id, log_name)
log = logging_client.get_log(log_path)
```

5. Set the minimum retention duration:

```
min_duration = Duration(seconds=604800) # 1 week
```

6. Check if the current retention duration is less than the minimum duration:

```
if log.retention_days < min_duration.seconds // 86400:
    # Update the retention policy
    retention_policy = logging_v2.types.RetentionPolicy(
        retention_days=min_duration.seconds // 86400
    )
    update_mask = logging_v2.types.UpdateLogMetricRequest.UpdateMask(
        paths=["retention_days"]
    )
    logging_client.update_log(log_path, retention_policy, update_mask)
```

7. If the retention duration is already greater than or equal to the minimum duration, no action is needed.

```
else:
    print("Retention duration is already greater than or equal to the minimum duration.")
```

This code will check the current retention policy for the specified log, and update it if necessary to ensure that the retention policy is locked with a specified minimum duration of 1 week (604800 seconds).


</Tab>
</Tabs>