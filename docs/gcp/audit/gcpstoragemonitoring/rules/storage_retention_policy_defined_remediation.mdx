

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to Google Cloud Console: Open your web browser, navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud account credentials.

2. Navigate to Cloud Storage: From the left-hand side menu, select "Storage" under the "Storage" section. This will open the "Browser" page where you can see all your storage buckets.

3. Check for Retention Policy: Click on the name of the bucket for which you want to check the retention policy. This will open the bucket details page. Here, click on the "Retention" tab. If a retention policy is defined, you will see the details here.

4. Verify Retention Policy: If there is no information under the "Retention" tab, it means that no retention policy is defined for that particular bucket. Repeat this process for all the buckets in your GCP account to ensure that all have a retention policy defined.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your GCP account using the following command. This will open a new window in your web browser asking you to log in with your Google account.
   ```
   gcloud auth login
   ```

3. List all the buckets in your project using the following command. Replace `PROJECT_ID` with your actual project ID.
   ```
   gsutil ls -p PROJECT_ID
   ```
   This command will return a list of all the buckets in your project.

4. For each bucket, check if it has a retention policy defined using the following command. Replace `BUCKET_NAME` with the name of your bucket.
   ```
   gsutil retention get gs://BUCKET_NAME
   ```
   If the bucket has a retention policy, this command will return the details of the policy. If the bucket does not have a retention policy, this command will return an error message.

#### Using Python

1. AWS S3:
   - Install the AWS SDK (boto3) for Python using pip: `pip install boto3`
   - Use the following Python script to check if a bucket has a retention policy:

```python
import boto3

s3 = boto3.client('s3')
response = s3.get_bucket_lifecycle_configuration(Bucket='my-bucket')

if 'Rules' in response:
    for rule in response['Rules']:
        if 'Expiration' in rule and 'Days' in rule['Expiration']:
            print("Bucket has a retention policy")
else:
    print("Bucket does not have a retention policy")
```

2. Azure Blob Storage:
   - Install the Azure SDK for Python using pip: `pip install azure-storage-blob`
   - Use the following Python script to check if a blob storage has a retention policy:

```python
from azure.storage.blob import BlobServiceClient

blob_service_client = BlobServiceClient.from_connection_string("my_connection_string")
container_client = blob_service_client.get_container_client("my_container")

properties = container_client.get_container_properties()

if properties.has_immutability_policy:
    print("Blob storage has a retention policy")
else:
    print("Blob storage does not have a retention policy")
```

3. Google Cloud Storage (GCS):
   - Install the Google Cloud SDK for Python using pip: `pip install google-cloud-storage`
   - Use the following Python script to check if a GCS bucket has a retention policy:

```python
from google.cloud import storage

client = storage.Client()
bucket = client.get_bucket('my-bucket')

if bucket.retention_period is not None:
    print("Bucket has a retention policy")
else:
    print("Bucket does not have a retention policy")
```

Please replace 'my-bucket', 'my_connection_string', and 'my_container' with your actual bucket names, connection string, and container name.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step by step instructions to remediate the storage bucket retention policy misconfiguration in GCP using the GCP console:

1. Open the GCP console and navigate to the Cloud Storage section.
2. Select the bucket for which you want to set the retention policy.
3. Click on the "Edit bucket retention" button at the top of the page.
4. In the "Retention period" section, select the desired retention period for the bucket. 
   Note: The retention period specifies how long objects in the bucket must be retained before they can be deleted. 
5. Select the "Locked" option to prevent the retention policy from being removed or reduced.
   Note: This is an optional step, but it is recommended to prevent accidental removal of the retention policy. 
6. Click the "Save" button to apply the retention policy to the bucket.

That's it! You have now remediated the storage bucket retention policy misconfiguration in GCP using the GCP console.

#### Using CLI

To remediate the misconfiguration "Storage Buckets Should Have A Retention Policy Defined" in GCP using GCP CLI, follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to list all the storage buckets in your GCP project:

   ```
   gsutil ls
   ```

3. Identify the bucket for which you want to define the retention policy.

4. Run the following command to set the retention policy for the identified bucket:

   ```
   gsutil retention set <retention_period> gs://<bucket_name>
   ```

   Replace `<retention_period>` with the duration for which you want to retain the objects in the bucket. For example, if you want to retain the objects in the bucket for 365 days, then you can set the retention period to 1 year. You can specify the retention period in seconds, minutes, hours, days, months, or years. For example, to set the retention period to 1 year, you can use the following command:

   ```
   gsutil retention set 1y gs://<bucket_name>
   ```

   Replace `<bucket_name>` with the name of the bucket for which you want to set the retention policy.

5. Verify the retention policy by running the following command:

   ```
   gsutil retention get gs://<bucket_name>
   ```

   This command will display the retention policy for the specified bucket.

6. Repeat the above steps for all the storage buckets in your GCP project to ensure that all the buckets have a retention policy defined.

By following the above steps, you can remediate the misconfiguration "Storage Buckets Should Have A Retention Policy Defined" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of storage buckets not having a retention policy defined in GCP using Python, you can follow the below steps:

1. First, you need to install the Google Cloud Storage module for Python. You can install it using the following command:

   ```
   pip install google-cloud-storage
   ```

2. Next, you need to authenticate with GCP using a service account. You can create a service account and download its JSON key file from the GCP console. Then, you can set the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of the JSON key file.

   ```
   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/keyfile.json
   ```

3. After that, you need to list all the buckets in your GCP project. You can do this using the following code:

   ```
   from google.cloud import storage

   storage_client = storage.Client()

   buckets = storage_client.list_buckets()

   for bucket in buckets:
       print(bucket.name)
   ```

4. Once you have the list of all the buckets, you can set a retention policy for each bucket using the `Bucket` class in the `google-cloud-storage` module. You can set the retention policy to a specific number of days using the `retention_period` parameter.

   ```
   from google.cloud import storage

   storage_client = storage.Client()

   buckets = storage_client.list_buckets()

   for bucket in buckets:
       bucket.retention_period = 30
       bucket.patch()
   ```

   In the above example, the retention policy is set to 30 days for all the buckets. You can change the value of `retention_period` as per your requirement.

5. Finally, you can verify that the retention policy has been set for each bucket by listing the bucket metadata and checking the `retentionPolicy` field.

   ```
   from google.cloud import storage

   storage_client = storage.Client()

   buckets = storage_client.list_buckets()

   for bucket in buckets:
       metadata = bucket.get_iam_policy()
       print(metadata.retentionPolicy)
   ```

   The above code will print the retention policy for each bucket.

By following the above steps, you can remediate the misconfiguration of storage buckets not having a retention policy defined in GCP using Python.


</Tab>
</Tabs>