

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Cloud Storage: From the main navigation menu, select "Storage" > "Browser". This will take you to the "Cloud Storage" page where you can see all your existing storage buckets.

3. Check Bucket Encryption: Click on the name of the bucket you want to check. This will take you to the bucket details page. From there, click on the "Encryption" tab. This will show you the current encryption settings for the bucket.

4. Verify Encryption Key: Under the "Encryption" tab, look for the "Default KMS key" section. If the bucket is encrypted using a Customer Managed Key (CMK), you will see the name of the key listed here. If the field is empty or if it says "Google-managed key", then the bucket is not encrypted using a CMK.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and configured, you can list all the buckets in your project by running the following command in your terminal:

   ```
   gsutil ls -p [PROJECT_ID]
   ```

   Replace `[PROJECT_ID]` with your actual project ID. This command will return a list of all the buckets in your project.

3. To check the encryption settings of a bucket, use the following command:

   ```
   gsutil kms encryption -k [KEY_NAME] gs://[BUCKET_NAME]
   ```

   Replace `[KEY_NAME]` with the name of your customer-managed key and `[BUCKET_NAME]` with the name of the bucket you want to check. This command will return the encryption settings of the specified bucket.

4. If the bucket is encrypted with a customer-managed key, the output of the previous command will include the name of the key. If the bucket is not encrypted with a customer-managed key, the output will not include a key name.

#### Using Python

1. Install the necessary Python libraries: Before you can start, you need to install the necessary Python libraries. You can do this by running the following command in your terminal:

```python
pip install google-cloud-storage
```

2. Import the necessary libraries and initialize the client: In your Python script, you need to import the necessary libraries and initialize the client. Here is how you can do it:

```python
from google.cloud import storage

def create_storage_client():
    return storage.Client()
```

3. Get the list of all buckets: Now, you can get the list of all buckets in your GCP project. Here is how you can do it:

```python
def list_buckets(storage_client):
    return storage_client.list_buckets()
```

4. Check the encryption configuration of each bucket: Finally, you can check the encryption configuration of each bucket. If a bucket is not encrypted using a customer-managed key, you can print a warning message. Here is how you can do it:

```python
def check_bucket_encryption(storage_client):
    buckets = list_buckets(storage_client)
    for bucket in buckets:
        encryption = bucket.get_encryption_config()
        if encryption is None or encryption.default_kms_key_name is None:
            print(f'Bucket {bucket.name} is not encrypted using a customer-managed key.')
```

5. Run the script: Now, you can run the script. It will print a warning message for each bucket that is not encrypted using a customer-managed key. Here is how you can do it:

```python
def main():
    storage_client = create_storage_client()
    check_bucket_encryption(storage_client)

if __name__ == '__main__':
    main()
```

This script will help you detect buckets that are not encrypted using customer-managed keys. However, it will not fix the misconfiguration. You will need to manually encrypt the buckets using customer-managed keys.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate this misconfiguration for GCP using GCP console, follow these steps:

1. Log in to the Google Cloud Console.

2. Navigate to the Cloud Storage page.

3. Select the bucket that needs to be encrypted.

4. Click on the "Edit bucket details" button.

5. Scroll down to the "Encryption" section.

6. Select "Customer-managed key" from the drop-down menu.

7. Choose the key that you want to use to encrypt the bucket.

8. Click on the "Save" button to apply the changes.

9. Repeat the above steps for all the buckets that need to be encrypted using customer-managed keys.

By following these steps, you can remediate the misconfiguration of not encrypting the buckets using customer-managed keys in GCP using the GCP console.

#### Using CLI

To remediate the bucket encryption misconfiguration in GCP using GCP CLI, follow these steps:

1. Open the Google Cloud Console and select the project containing the bucket that needs to be encrypted using a customer-managed key.

2. Open the Cloud Shell by clicking on the icon in the top right corner of the console.

3. In the Cloud Shell, run the following command to enable the Cloud KMS API:

   ```
   gcloud services enable cloudkms.googleapis.com
   ```

4. Next, create a new customer-managed key (CMK) by running the following command:

   ```
   gcloud kms keyrings create [KEYRING-NAME] --location [LOCATION]
   gcloud kms keys create [KEY-NAME] --location [LOCATION] --keyring [KEYRING-NAME] --purpose encryption
   ```

   Replace `[KEYRING-NAME]` with a name for your keyring, `[LOCATION]` with the location where you want to create the key, and `[KEY-NAME]` with a name for your key.

5. Now, update the bucket to use the newly created CMK by running the following command:

   ```
   gsutil kms set [KEY-NAME] gs://[BUCKET-NAME]
   ```

   Replace `[KEY-NAME]` with the name of the CMK you created in step 4 and `[BUCKET-NAME]` with the name of the bucket that needs to be encrypted.

6. Finally, verify that the bucket is encrypted using the CMK by running the following command:

   ```
   gsutil ls -L -b gs://[BUCKET-NAME]
   ```

   Look for the `kms_key_name` field in the output to confirm that the bucket is encrypted using the CMK you created.

By following these steps, you can remediate the bucket encryption misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate this misconfiguration for GCP using Python, you can follow these steps:

1. Install the `google-cloud-storage` library using pip.

2. Authenticate with your GCP account using the following command:
```python
from google.cloud import storage

storage_client = storage.Client()
```

3. List all the buckets in your project using the following command:
```python
buckets = list(storage_client.list_buckets())

for bucket in buckets:
    print(bucket.name)
```

4. For each bucket, check if it is encrypted using a customer-managed key (CMK) by checking the bucket's `encryption` property:
```python
if bucket.encryption_algorithm == "AES256":
    print(f"{bucket.name} is encrypted with default encryption.")
elif bucket.encryption_algorithm == "Google-managed":
    print(f"{bucket.name} is encrypted with Google-managed encryption.")
elif bucket.encryption_algorithm == "CUSTOMER_MANAGED_ENCRYPTION":
    print(f"{bucket.name} is encrypted with customer-managed encryption.")
```

5. If the bucket is not encrypted with a customer-managed key, create a new key using the following command:
```python
key_name = "my-cmk"
location = "us-central1"
key_ring_name = "my-keyring"

kms_client = storage_client._credentials.create_scoped(
    ["https://www.googleapis.com/auth/cloudkms"]
)

kms_client = googleapiclient.discovery.build("cloudkms", "v1", credentials=kms_client)

parent = f"projects/{project_id}/locations/{location}/keyRings/{key_ring_name}"

response = kms_client.create_crypto_key(
    parent=parent,
    cryptoKeyId=key_name,
    cryptoKey={
        "purpose": "ENCRYPT_DECRYPT",
        "nextRotationTime": "2025-01-01T00:00:00Z",
    },
)
```
Note: Replace `my-cmk`, `us-central1`, and `my-keyring` with your own values.

6. Enable encryption with the new CMK for the bucket using the following command:
```python
bucket.default_event_based_hold = True
bucket.patch()

bucket.reload()

bucket.encryption_algorithm = "CUSTOMER_MANAGED_ENCRYPTION"
bucket.default_kms_key_name = f"projects/{project_id}/locations/{location}/keyRings/{key_ring_name}/cryptoKeys/{key_name}"
bucket.patch()
```

7. Verify that the bucket is now encrypted with a customer-managed key:
```python
if bucket.encryption_algorithm == "CUSTOMER_MANAGED_ENCRYPTION":
    print(f"{bucket.name} is now encrypted with customer-managed encryption.")
else:
    print(f"{bucket.name} encryption is still not customer-managed.")
```

By following these steps, you can remediate the misconfiguration of GCP buckets not being encrypted with customer-managed keys.


</Tab>
</Tabs>