---
slug: allowed_external_ips_for_vm_org_policy
title: Define Allowed External IPs for VM Instances
sidebar_label: Define Allowed External IPs for VM Instances
---

### More Info:

Ensure that "Define Allowed External IPs for VM Instances" constraint policy is enforced at the GCP organization level in order to enable you to define the set of virtual machine (VM) instances that are allowed to use external IP addresses. This constraint helps you to minimize your instance's exposure to the Internet.

### Risk Level

Medium

### Address

Security, Operational Maturity

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to your Google Cloud Platform (GCP) console.
2. Navigate to the "Compute Engine" section from the left-hand side menu.
3. In the Compute Engine section, click on "VM Instances". This will display a list of all your VM instances.
4. For each VM instance, click on the instance name to view its details. In the details page, check the "External IP" field. If the field is set to any value other than "None", it means that the VM instance is allowed to have external IPs, which could be a misconfiguration if it's not intended.

#### Using CLI

1. First, you need to install and initialize the Google Cloud SDK if you haven't done so already. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, you can initialize it by running the command `gcloud init` and follow the prompts to authorize the SDK and set your default project, compute region and zone.

2. Once the SDK is set up, you can list all the VM instances in your project by running the following command: `gcloud compute instances list`. This will display a list of all your VM instances along with their details such as name, zone, machine type, internal IP, and external IP.

3. To check the allowed external IPs for a specific VM instance, you can use the following command: `gcloud compute instances describe [INSTANCE_NAME] --format='get(networkInterfaces)'`. Replace `[INSTANCE_NAME]` with the name of your VM instance. This command will display the network interfaces of the VM instance, including the external IP if one is assigned.

4. If the external IP is not in the allowed list, then there is a misconfiguration. You can check the allowed list by looking at the firewall rules in your VPC network. You can list all the firewall rules by running the following command: `gcloud compute firewall-rules list`. The allowed IPs will be listed in the "sourceRanges" column. If the external IP of the VM instance is not in this list, then it is not allowed.

#### Using Python

To check the allowed external IPs for VM instances in IAM using Python scripts, you can follow these steps:

1. **Setup Google Cloud SDK and Python Environment:**
   Before you start, make sure you have installed Google Cloud SDK and Python on your local machine. You can download Google Cloud SDK from the official Google Cloud website and install Python from the official Python website. After installation, authenticate your SDK using the command `gcloud auth login`.

2. **Install Required Python Libraries:**
   You will need the `google-auth` and `google-auth-httplib2` libraries to authenticate and make HTTP requests, and the `google-api-python-client` library to interact with Google Cloud APIs. You can install these libraries using pip:
   ```
   pip install --upgrade google-auth google-auth-httplib2 google-api-python-client
   ```

3. **Create a Python Script:**
   Create a Python script to fetch the list of all VM instances and their associated external IPs. Here is a sample script:

   ```python
   from googleapiclient import discovery
   from google.oauth2 import service_account

   # Load the credentials
   credentials = service_account.Credentials.from_service_account_file(
       '/path/to/your/service-account-file.json')

   # Build the service
   service = discovery.build('compute', 'v1', credentials=credentials)

   # Project ID for this request.
   project = 'my-project'  # TODO: Update placeholder value.

   # The name of the zone for this request.
   zone = 'my-zone'  # TODO: Update placeholder value.

   request = service.instances().list(project=project, zone=zone)

   while request is not None:
       response = request.execute()

       for instance in response['items']:
           # TODO: Change code below to process each `instance` resource:
           print(instance)

       request = service.instances().list_next(previous_request=request, previous_response=response)
   ```

4. **Analyze the Output:**
   Run the script and analyze the output. The script will print the details of each VM instance in the specified project and zone. Look for the `networkInterfaces` field in the output. This field contains the details of the network interfaces attached to the VM. If the `accessConfigs` field under `networkInterfaces` contains an `external IP`, then the VM instance is allowed to have external IPs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

"Allowed External IPs for VM Instances" is a firewall rule in GCP that allows traffic from specific external IP addresses to reach the VM instances. This misconfiguration can be a security risk as it may allow unauthorized access to the VM instances.

To remediate this misconfiguration in GCP using the GCP console, follow these steps:

1. Go to the GCP console and select the project containing the affected VM instances.

2. In the navigation menu, click on "VPC Network" and then click on "Firewall rules".

3. Find the firewall rule that allows external IPs and click on it to edit it.

4. In the "Source IP ranges" field, remove the specific IP addresses that are not authorized to access the VM instances.

5. If necessary, add a new firewall rule to restrict access to the VM instances to specific IP addresses or IP ranges that are authorized to access them.

6. Click on "Save" to apply the changes.

7. Verify that the firewall rule has been updated by checking the "Firewall rules" page in the GCP console.

By following these steps, you can remediate the "Allowed External IPs for VM Instances" misconfiguration in GCP using the GCP console.

#### Using CLI

The "Allowed External IPs for VM Instances" misconfiguration in GCP means that the firewall rules for the virtual machine instances allow traffic from external IP addresses that are not authorized. To remediate this, you can follow these steps using the GCP CLI:

1. Open the Cloud Shell in the GCP Console.

2. Run the following command to list the firewall rules for the project:

```
gcloud compute firewall-rules list
```

3. Identify the firewall rule that needs to be updated to restrict the allowed external IPs.

4. Run the following command to update the firewall rule:

```
gcloud compute firewall-rules update [FIREWALL_RULE_NAME] --source-ranges=[AUTHORIZED_IP_RANGES]
```

Replace `[FIREWALL_RULE_NAME]` with the name of the firewall rule that needs to be updated, and `[AUTHORIZED_IP_RANGES]` with the comma-separated list of authorized IP ranges.

For example, if the firewall rule name is `allow-http` and the authorized IP ranges are `10.0.0.0/8,172.16.0.0/12,192.168.0.0/16`, the command would be:

```
gcloud compute firewall-rules update allow-http --source-ranges=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
```

5. Verify that the firewall rule was updated by running the `gcloud compute firewall-rules list` command again and checking the `sourceRanges` field for the updated rule.

By following these steps, you can remediate the "Allowed External IPs for VM Instances" misconfiguration in GCP using the GCP CLI.

#### Using Python

The "Allowed External IPs" configuration in GCP allows network traffic only from specific external IP addresses. To remediate this misconfiguration, you can follow these steps using Python:

1. Import the necessary libraries:

```
from google.cloud import compute_v1
from google.oauth2 import service_account
```

2. Set up the credentials:

```
credentials = service_account.Credentials.from_service_account_file('path/to/your/credentials.json')
```

3. Set up the client:

```
client = compute_v1.InstancesClient(credentials=credentials)
```

4. Define the project ID and zone where the instance is located:

```
project = 'your-project-id'
zone = 'your-zone'
```

5. Define the instance name:

```
instance_name = 'your-instance-name'
```

6. Get the instance:

```
instance = client.get(project=project, zone=zone, instance=instance_name)
```

7. Define the new list of allowed external IPs:

```
new_allowed_ips = [
    {
        "value": "x.x.x.x",
        "name": "ip-1"
    },
    {
        "value": "y.y.y.y",
        "name": "ip-2"
    }
]
```
where `x.x.x.x` and `y.y.y.y` are the IP addresses that you want to allow.

8. Update the instance with the new list of allowed external IPs:

```
access_configs = instance.network_interfaces[0].access_configs[0]
access_configs.nat_ip = None
access_configs.external_ip = None
access_configs.allowed = new_allowed_ips

request = {
    "project": project,
    "zone": zone,
    "instance": instance_name,
    "instance_resource": instance
}

response = client.update(**request)
```

This will update the instance with the new list of allowed external IPs. Note that this assumes that the instance has only one network interface and one access config. If there are multiple network interfaces or access configs, you will need to modify the code accordingly.




</Tab>
</Tabs>