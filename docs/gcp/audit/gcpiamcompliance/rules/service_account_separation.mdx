---
slug: service_account_separation
title: Service Accounts Admin And User Permissions Should Not Be Assigned At The Same Time
sidebar_label: Service Accounts Admin And User Permissions Should Not Be Assigned At The Same Time
---

### More Info:

Ensuring that no service accounts have admin privileges.

### Risk Level

Critical

### Address

Security

### Compliance Standards

CISGCP, CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to IAM & Admin: Once you're logged in, click on the navigation menu (three horizontal lines) in the top left corner of the console. Scroll down and click on "IAM & Admin".

3. View IAM Policies: In the IAM & Admin page, click on "IAM" in the left-hand menu. This will display a list of all the IAM policies in your GCP project.

4. Check Service Account Permissions: In the IAM policies list, look for any service accounts that have both "Service Account User" and "Service Account Admin" roles assigned at the same time. This is a misconfiguration as it gives excessive permissions to the service account, which can be a security risk.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the SDK is installed and configured, open your terminal and use the following command to list all the IAM policies for your project:

   ```
   gcloud projects get-iam-policy [PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your actual project ID.

3. This command will return a list of all IAM policies for your project. Each policy will have a `role` and a `members` field. The `role` field indicates the role assigned to the member, and the `members` field indicates the member the role is assigned to.

4. To detect if Service Accounts Admin and User Permissions are assigned at the same time, you need to look for policies where the `role` is `roles/iam.serviceAccountAdmin` and `roles/iam.serviceAccountUser` for the same member. You can do this manually by looking through the list, or you can use a script to automate the process. Here is a simple Python script that uses the `json` module to parse the output and check for the misconfiguration:

   ```python
   import json
   import subprocess

   # Run the gcloud command and get the output
   output = subprocess.check_output(["gcloud", "projects", "get-iam-policy", "[PROJECT_ID]"])
   policies = json.loads(output)

   # Check each policy
   for policy in policies:
       roles = policy['role']
       members = policy['members']
       if 'roles/iam.serviceAccountAdmin' in roles and 'roles/iam.serviceAccountUser' in roles:
           print(f"Service Accounts Admin and User Permissions are assigned at the same time for member: {members}")
   ```
   Replace `[PROJECT_ID]` with your actual project ID in the script. If the script prints any output, it means the misconfiguration is present.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the Google Cloud SDK and the Google Auth, Google Auth Oauthlib, Google Auth HTTPLib2, and Google API Client libraries. You can do this using pip:

   ```
   pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
   ```

2. Authenticate your application: To interact with the Google Cloud, your application needs to be authenticated. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key JSON file.

   ```python
   import os
   os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/path/to/your/service-account-file.json"
   ```

3. Use the IAM API to list all service accounts: You can use the `projects().serviceAccounts().list()` method to get a list of all service accounts in your project. 

   ```python
   from googleapiclient import discovery
   service = discovery.build('iam', 'v1')
   request = service.projects().serviceAccounts().list(name='projects/my-project-id')
   response = request.execute()
   ```

4. Check for service accounts with both admin and user permissions: For each service account, you can use the `projects().serviceAccounts().getIamPolicy()` method to get the IAM policy for the service account. You can then check if the policy includes both admin and user roles.

   ```python
   for account in response['accounts']:
       policy_request = service.projects().serviceAccounts().getIamPolicy(resource=account['name'])
       policy_response = policy_request.execute()
       for binding in policy_response['bindings']:
           if 'roles/admin' in binding['role'] and 'roles/user' in binding['role']:
               print(f"Service account {account['email']} has both admin and user permissions.")
   ```
   
This script will print out the email addresses of any service accounts that have both admin and user permissions.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Service Accounts Admin And User Permissions Should Not Be Assigned At The Same Time" for GCP using GCP console, follow the below steps:

1. Login to the GCP console (https://console.cloud.google.com/).
2. Navigate to the IAM & Admin page by clicking on the hamburger menu on the top left corner and selecting "IAM & Admin" from the menu.
3. Select "Service accounts" from the left-hand menu.
4. Locate the service account that has both admin and user permissions assigned to it.
5. Click on the service account to view its details.
6. Click on the "Permissions" tab to view the permissions assigned to the service account.
7. Remove the admin permissions from the service account by clicking on the "Edit" button next to the role that has admin permissions assigned to it.
8. Deselect the admin role and click "Save" to remove the admin permissions.
9. Verify that the service account now only has user permissions assigned to it.

By following these steps, the misconfiguration "Service Accounts Admin And User Permissions Should Not Be Assigned At The Same Time" will be remediated for GCP.

#### Using CLI

To remediate the misconfiguration of assigning both Service Accounts Admin and User permissions at the same time in GCP using GCP CLI, follow these steps:

1. Open the Google Cloud Shell from the GCP console.

2. Run the following command to list all the IAM policies of the project:

```
gcloud projects get-iam-policy <PROJECT_ID>
```

Replace `<PROJECT_ID>` with the actual project ID.

3. Identify the service account that has both Service Accounts Admin and User permissions assigned to it.

4. Run the following command to remove the Service Accounts Admin role from the service account:

```
gcloud projects remove-iam-policy-binding <PROJECT_ID> --member=serviceAccount:<SERVICE_ACCOUNT_EMAIL> --role=roles/iam.serviceAccountAdmin
```

Replace `<PROJECT_ID>` with the actual project ID and `<SERVICE_ACCOUNT_EMAIL>` with the email address of the service account.

5. Verify that the Service Accounts Admin role has been removed from the service account by running the following command:

```
gcloud projects get-iam-policy <PROJECT_ID> --flatten="bindings[].members" --format="table(bindings.role, bindings.members)" --filter="bindings.members:<SERVICE_ACCOUNT_EMAIL>"
```

Replace `<PROJECT_ID>` with the actual project ID and `<SERVICE_ACCOUNT_EMAIL>` with the email address of the service account.

6. If the User role is still assigned to the service account, run the following command to remove it:

```
gcloud projects remove-iam-policy-binding <PROJECT_ID> --member=serviceAccount:<SERVICE_ACCOUNT_EMAIL> --role=roles/iam.serviceAccountUser
```

Replace `<PROJECT_ID>` with the actual project ID and `<SERVICE_ACCOUNT_EMAIL>` with the email address of the service account.

7. Verify that the User role has been removed from the service account by running the following command:

```
gcloud projects get-iam-policy <PROJECT_ID> --flatten="bindings[].members" --format="table(bindings.role, bindings.members)" --filter="bindings.members:<SERVICE_ACCOUNT_EMAIL>"
```

Replace `<PROJECT_ID>` with the actual project ID and `<SERVICE_ACCOUNT_EMAIL>` with the email address of the service account.

8. Repeat steps 3-7 for any other service accounts that have both Service Accounts Admin and User permissions assigned to them.

By following these steps, you will successfully remediate the misconfiguration of assigning both Service Accounts Admin and User permissions at the same time for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Service Accounts Admin And User Permissions Should Not Be Assigned At The Same Time" in GCP using Python, follow these steps:

1. Create a list of all the service accounts in your GCP project using the following code:

```python
from google.oauth2 import service_account
from googleapiclient.discovery import build

credentials = service_account.Credentials.from_service_account_file(
    'path/to/your/credentials.json'
)

service = build('iam', 'v1', credentials=credentials)

response = service.projects().serviceAccounts().list(name='projects/your-project-id').execute()

service_account_emails = [account['email'] for account in response['accounts']]
```

2. For each service account in the list, check if it has both admin and user permissions assigned to it using the following code:

```python
for email in service_account_emails:
    response = service.projects().serviceAccounts().get(name=f'projects/your-project-id/serviceAccounts/{email}').execute()
    for role in response['iam_roles']:
        if 'admin' in role.lower() and 'user' in role.lower():
            print(f'Service account {email} has both admin and user permissions assigned to it.')
```

3. If any service account has both admin and user permissions assigned to it, remove the user permissions using the following code:

```python
for email in service_account_emails:
    response = service.projects().serviceAccounts().get(name=f'projects/your-project-id/serviceAccounts/{email}').execute()
    roles_to_remove = []
    for role in response['iam_roles']:
        if 'admin' in role.lower() and 'user' in role.lower():
            roles_to_remove.append(role)
    if roles_to_remove:
        body = {
            'updateMask': 'iam_roles',
            'iam_roles': [role for role in response['iam_roles'] if role not in roles_to_remove]
        }
        service.projects().serviceAccounts().patch(name=f'projects/your-project-id/serviceAccounts/{email}', body=body).execute()
        print(f'Removed user permissions from service account {email}.')
```

Note: Replace "your-project-id" with the ID of your GCP project and "path/to/your/credentials.json" with the path to your GCP service account credentials file. Also, make sure that the credentials have the necessary permissions to manage service accounts in your GCP project.


### Additional Reading:



</Tab>
</Tabs>