---
slug: kms_user_separation
title: KMS Admin Roles Should Not Have CryptoKey Role
sidebar_label: KMS Admin Roles Should Not Have CryptoKey Role
---

### More Info:

Ensure that no users have the KMS admin role and any one of the CryptoKey roles follows separation of duties, where no user have access to resources out of the scope of duty.

### Risk Level

Critical

### Address

Security

### Compliance Standards

CISGCP, CBP, ISO27001



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to IAM & Admin: Once you're logged in, locate the navigation menu in the top left corner of the console. Click on it and scroll down to find "IAM & Admin". Click on it to open the IAM & Admin dashboard.

3. View IAM Roles: In the IAM & Admin dashboard, click on "IAM" in the left-hand menu. This will display a list of all IAM roles in your GCP environment. 

4. Check for CryptoKey Role: In the list of IAM roles, look for any roles that have "roles/cloudkms.cryptoKeyEncrypterDecrypter" assigned to them. If you find any, check if they are assigned to KMS Admin roles. If they are, this is a misconfiguration as KMS Admin roles should not have the CryptoKey role.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the SDK is installed and configured, open your terminal and run the following command to list all the IAM policies for your project:

   ```
   gcloud projects get-iam-policy [PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your actual project ID. This command will return a list of all IAM policies for your project.

3. To check if KMS Admin roles have the CryptoKey role, you need to look for the `roles/cloudkms.admin` and `roles/cloudkms.cryptoKeyEncrypterDecrypter` in the output of the previous command. You can use the following command to filter the output:

   ```
   gcloud projects get-iam-policy [PROJECT_ID] --flatten="bindings[].members" --format='table(bindings.role)' --filter="bindings.role:roles/cloudkms.admin OR bindings.role:roles/cloudkms.cryptoKeyEncrypterDecrypter"
   ```
   This command will return a table with the roles that match the filter.

4. If the `roles/cloudkms.admin` and `roles/cloudkms.cryptoKeyEncrypterDecrypter` roles are assigned to the same member, it means that the KMS Admin role has the CryptoKey role, which is a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the Google Cloud SDK and the Google Auth, Google Auth OAuthlib, Google Auth HTTPLib2, Google API Client, and Google Cloud KMS libraries for Python. You can do this using pip:

```python
pip install --upgrade google-cloud-sdk google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client google-cloud-kms
```

2. Authenticate your session: You need to authenticate your session with GCP. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file.

```python
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/path/to/your/service-account-file.json"
```

3. Connect to the IAM service: Now you can connect to the IAM service and get a list of all roles in your project.

```python
from googleapiclient import discovery
from googleapiclient.errors import HttpError

def get_roles(project_id):
    """Lists all roles in a project."""
    try:
        service = discovery.build('iam', 'v1', cache_discovery=False)
        request = service.roles().list(parent='projects/' + project_id)
        response = request.execute()
        return response.get('roles', [])
    except HttpError as error:
        print(f'An error occurred: {error}')
        return []
```

4. Check for CryptoKey roles: Now you can iterate over the roles and check if any of them have the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role.

```python
def check_cryptokey_roles(roles):
    """Checks if any role has the CryptoKey role."""
    for role in roles:
        if 'roles/cloudkms.cryptoKeyEncrypterDecrypter' in role['includedPermissions']:
            print(f'Role {role["name"]} has the CryptoKey role')

roles = get_roles('your-project-id')
check_cryptokey_roles(roles)
```

This script will print out the names of any roles that have the CryptoKey role. If no roles have this role, it will not print anything.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "KMS Admin Roles Should Not Have CryptoKey Role" in GCP using GCP console, you can follow the below steps:

1. Login to your GCP console and navigate to the IAM & Admin page.
2. In the IAM & Admin page, select the "Roles" tab.
3. Search for the "Cloud KMS Admin" role and click on it.
4. Under the "Permissions" tab, search for the "cloudkms.cryptoKeyRoles.*" permission.
5. Click on the pencil icon next to the "cloudkms.cryptoKeyRoles.*" permission to edit it.
6. Uncheck the "cloudkms.cryptoKeyRoles.*" permission and click on the "Save" button.
7. Verify that the "cloudkms.cryptoKeyRoles.*" permission is no longer present under the "Permissions" tab for the "Cloud KMS Admin" role.

By following the above steps, you have successfully remediated the misconfiguration "KMS Admin Roles Should Not Have CryptoKey Role" in GCP using GCP console.

#### Using CLI

To remediate this issue in GCP using GCP CLI, you can follow the below steps:

1. Open the Google Cloud Console and go to the Cloud Shell.

2. Run the following command to list all the KMS admin roles in your project:

   ```
   gcloud kms roles list
   ```

3. Identify the KMS admin role that has the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role.

4. Run the following command to remove the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role from the KMS admin role:

   ```
   gcloud kms roles revoke [KMS_ADMIN_ROLE] --permission=cloudkms.cryptoKeyEncrypterDecrypter
   ```

   Replace `[KMS_ADMIN_ROLE]` with the name of the KMS admin role that you identified in step 3.

5. Verify that the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role has been removed from the KMS admin role by running the following command:

   ```
   gcloud kms roles describe [KMS_ADMIN_ROLE]
   ```

   Replace `[KMS_ADMIN_ROLE]` with the name of the KMS admin role that you identified in step 3.

   This command should output the details of the KMS admin role, which should not include the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role.

By following these steps, you should be able to remediate the issue of KMS admin roles having the `roles/cloudkms.cryptoKeyEncrypterDecrypter` role in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "KMS Admin Roles Should Not Have CryptoKey Role" in GCP using Python, you can follow the below steps:

Step 1: Create a list of all the KMS admin roles that have CryptoKey role.

```
from google.oauth2 import service_account
from googleapiclient.discovery import build

# Set the credentials
credentials = service_account.Credentials.from_service_account_file(
    'path/to/service_account.json')

# Set the project id
project_id = 'your_project_id'

# Create the KMS client
kms_client = build('cloudkms', 'v1', credentials=credentials)

# Get the list of all the KMS admin roles
roles_list = kms_client.projects().locations().keyRings().cryptoKeys().getIamPolicy(resource='projects/{}/locations/{}/keyRings/{}/cryptoKeys/{}'.format(project_id, location, keyring_name, cryptokey_name)).execute()

# Create a list of all the KMS admin roles that have CryptoKey role
kms_admin_cryptokey_roles = []

for role in roles_list['bindings']:
    if 'roles/cloudkms.admin' in role['role']:
        for member in role['members']:
            if 'cryptoKey' in member:
                kms_admin_cryptokey_roles.append(role['role'])
```

Step 2: Remove the CryptoKey role from all the KMS admin roles.

```
from google.oauth2 import service_account
from googleapiclient.discovery import build

# Set the credentials
credentials = service_account.Credentials.from_service_account_file(
    'path/to/service_account.json')

# Set the project id
project_id = 'your_project_id'

# Create the KMS client
kms_client = build('cloudkms', 'v1', credentials=credentials)

# Remove the CryptoKey role from all the KMS admin roles
for role in kms_admin_cryptokey_roles:
    policy = kms_client.projects().locations().keyRings().cryptoKeys().getIamPolicy(resource='projects/{}/locations/{}/keyRings/{}/cryptoKeys/{}'.format(project_id, location, keyring_name, cryptokey_name)).execute()
    for binding in policy['bindings']:
        if binding['role'] == role:
            binding['members'] = [member for member in binding['members'] if 'cryptoKey' not in member]
    kms_client.projects().locations().keyRings().cryptoKeys().setIamPolicy(resource='projects/{}/locations/{}/keyRings/{}/cryptoKeys/{}'.format(project_id, location, keyring_name, cryptokey_name), body={'policy': policy}).execute()
```

Note: Replace the `path/to/service_account.json`, `your_project_id`, `location`, `keyring_name`, and `cryptokey_name` with the actual values in your GCP environment.


### Additional Reading:



</Tab>
</Tabs>