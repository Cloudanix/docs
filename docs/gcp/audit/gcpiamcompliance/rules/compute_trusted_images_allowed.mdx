---
slug: compute_trusted_images_allowed
title: Restricting the Use of Images
sidebar_label: Restricting the Use of Images
---

### More Info:

Ensure that only images from trusted Google Cloud Platform (GCP) projects are allowed as the source for boot disks for new virtual machine instances. To enforce this constraint, enable and configure the "Define Trusted Image Projects" policy at the GCP organization level.

### Risk Level

Medium

### Address

Operational Maturity, Reliability, Security

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser and navigate to the Google Cloud Platform Console (console.cloud.google.com). Use your Google account credentials to log in.

2. Navigate to IAM & Admin: Once you're logged in, look for the navigation menu on the top left corner of the console. Click on it and scroll down to find "IAM & Admin". Click on it to open the IAM & Admin dashboard.

3. Check IAM Policies: In the IAM & Admin dashboard, click on "IAM" in the left-hand menu. This will open a list of all IAM roles and permissions in your GCP environment. Look for any roles that have the "compute.images.useReadOnly" permission. This permission allows a user to use an image to create a disk or a machine instance.

4. Review User Permissions: If you find any roles with the "compute.images.useReadOnly" permission, click on the role to see which users or service accounts are assigned to it. If there are any users or service accounts that shouldn't have this permission, it indicates a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your GCP account using the following command:
   ```
   gcloud auth login
   ```
   This command will open a new window in your web browser asking you to log in with your Google account. After successful login, your CLI will be authenticated with your GCP account.

3. Set your project ID to the project you want to inspect. You can do this with the following command:
   ```
   gcloud config set project [YOUR_PROJECT_ID]
   ```
   Replace `[YOUR_PROJECT_ID]` with the ID of your project.

4. Now, you can list all the IAM policies for your project using the following command:
   ```
   gcloud projects get-iam-policy [YOUR_PROJECT_ID]
   ```
   Replace `[YOUR_PROJECT_ID]` with the ID of your project. This command will return a list of all IAM policies for your project. You can inspect this list to check if there are any policies that allow unrestricted use of images.

#### Using Python

To detect the use of unrestricted images in IAM, you can use the Boto3 library in Python, which allows you to directly interact with AWS services, including IAM. Here are the steps:

1. **Setup AWS SDK for Python (Boto3):**
   First, you need to install and configure Boto3. You can install it using pip:
   ```
   pip install boto3
   ```
   Then, configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config. In the credentials file, add:
   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```
   In the config file, add:
   ```
   [default]
   region=us-east-1
   ```

2. **Create a Python Script to List IAM Policies:**
   You can use Boto3 to list all IAM policies and check if any of them allows unrestricted access to images. Here is a sample script:
   ```python
   import boto3

   # Create IAM client
   iam = boto3.client('iam')

   # List policies
   response = iam.list_policies(Scope='All')
   for policy in response['Policies']:
       print(policy['Arn'])
   ```
   This script will print the ARN of all policies. You can then use these ARNs to get the policy details.

3. **Get Policy Details:**
   You can use the get_policy_version method to get the details of a policy. Here is a sample script:
   ```python
   import boto3

   # Create IAM client
   iam = boto3.client('iam')

   # Get policy version
   response = iam.get_policy_version(
       PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess',
       VersionId='v1'
   )
   print(response['PolicyVersion']['Document'])
   ```
   This script will print the policy document of the specified policy. You can replace 'arn:aws:iam::aws:policy/AdministratorAccess' and 'v1' with the ARN and version ID of the policy you want to check.

4. **Check the Policy Document:**
   The policy document is a JSON object that describes the permissions of the policy. You need to check if this document allows unrestricted access to images. This can be done by checking if the "Action" field contains "iam:PassRole" and the "Resource" field contains "*". If this is the case, then the policy allows unrestricted access to images. You can add this check to the previous script:
   ```python
   import boto3
   import json

   # Create IAM client
   iam = boto3.client('iam')

   # Get policy version
   response = iam.get_policy_version(
       PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess',
       VersionId='v1'
   )
   policy_document = response['PolicyVersion']['Document']

   # Check if the policy allows unrestricted access to images
   for statement in policy_document['Statement']:
       if statement['Action'] == 'iam:PassRole' and statement['Resource'] == '*':
           print('Unrestricted access to images detected')
   ```
   This script will print a warning if unrestricted access to images is detected.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of restricting the use of images in GCP using GCP console, follow these steps:

1. Open the GCP console and select the project where the misconfiguration exists.
2. Click on the "Navigation menu" button (â˜°) in the top-left corner of the console.
3. Navigate to the "Compute Engine" section and click on "Images".
4. Select the image that needs to be restricted and click on the "Edit" button at the top of the page.
5. In the "Permissions" section, click on the "Add item" button.
6. In the "New permission" window, enter the email address of the user or group that should have access to the image.
7. Select the "Compute Image User" role from the "Select a role" dropdown menu.
8. Click on the "Save" button to add the new permission.
9. Repeat steps 5-8 for each user or group that should have access to the image.
10. Click on the "Save" button at the bottom of the page to save the changes.

By following these steps, you have successfully restricted the use of images in GCP by granting access to only authorized users or groups.

#### Using CLI

To remediate the misconfiguration of restricting the use of images in GCP, you can follow the below steps using GCP CLI:

1. Open the Cloud Shell from the GCP console.

2. Run the following command to list all the images in your project:

```
gcloud compute images list
```

3. Identify the images that are not required and need to be deleted.

4. Run the following command to delete the image:

```
gcloud compute images delete [IMAGE-NAME] --project=[PROJECT-ID]
```

Replace [IMAGE-NAME] with the name of the image that you want to delete and [PROJECT-ID] with the ID of your GCP project.

5. Repeat step 4 for all the images that you want to delete.

6. Once all the unnecessary images are deleted, you can create a policy to restrict the use of images. Run the following command to create a policy:

```
gcloud beta resource-manager org-policies create-enforcer iam.allowedImageTypes --organization [ORGANIZATION-ID] --policy boolean_policy.yaml
```

Replace [ORGANIZATION-ID] with the ID of your GCP organization.

7. In the above command, the policy is created using a YAML file named boolean_policy.yaml. Create this file with the following content:

```
enforce: true
constraint: constraints/compute.allowedImageTypes
```

Save the file.

8. Run the following command to update the policy:

```
gcloud beta resource-manager org-policies set-policy iam.allowedImageTypes --policy boolean_policy.yaml
```

9. The policy is now enforced and any user who tries to use an image that is not allowed will receive an error message.

By following the above steps, you can remediate the misconfiguration of restricting the use of images in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of restricting the use of images in GCP using Python, you can follow the below steps:

1. Firstly, you need to create a service account in the GCP project with the required permissions to manage the images. You can use the following command to create a service account:

```
gcloud iam service-accounts create [SA-NAME] --description "[SA-DESCRIPTION]" --display-name "[SA-DISPLAY-NAME]"
```

2. After creating the service account, you need to grant it the required permissions to manage the images. You can use the following command to grant the required permissions:

```
gcloud projects add-iam-policy-binding [PROJECT-ID] --member serviceAccount:[SA-EMAIL] --role roles/compute.imageUser
```

3. Next, you need to create a custom IAM role that restricts the use of images. You can use the following Python code to create a custom IAM role:

```python
from google.cloud import iam

client = iam.IAMClient()

# Define the permissions for the custom role
permissions = [
    "compute.images.get",
    "compute.images.list",
    "compute.images.useReadOnly"
]

# Create the custom role
response = client.create_role(
    parent="projects/[PROJECT-ID]",
    role_id="[ROLE-ID]",
    role={
        "title": "[ROLE-TITLE]",
        "description": "[ROLE-DESCRIPTION]",
        "included_permissions": permissions
    }
)
```

4. After creating the custom IAM role, you need to assign it to the service account that you created in step 1. You can use the following Python code to assign the custom IAM role to the service account:

```python
from google.cloud import iam

client = iam.IAMClient()

# Assign the custom role to the service account
response = client.set_iam_policy(
    resource="[RESOURCE-ID]",
    policy={
        "bindings": [
            {
                "role": "projects/[PROJECT-ID]/roles/[ROLE-ID]",
                "members": [
                    "serviceAccount:[SA-EMAIL]"
                ]
            }
        ]
    }
)
```

5. Finally, you need to verify that the custom IAM role has been assigned to the service account and that the service account has the required permissions to manage the images. You can use the following command to verify the same:

```
gcloud projects get-iam-policy [PROJECT-ID] --flatten="bindings[].members" --format="table(bindings.role, bindings.members)"
```

By following the above steps, you can remediate the misconfiguration of restricting the use of images in GCP using Python.




</Tab>
</Tabs>