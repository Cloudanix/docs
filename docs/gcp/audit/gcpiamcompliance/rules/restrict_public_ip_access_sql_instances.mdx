---
slug: restrict_public_ip_access_sql_instances
title: Restrict Public IP Access for Cloud SQL Instances at Organization Level
sidebar_label: Restrict Public IP Access for Cloud SQL Instances at Organization Level
---

### More Info:

Ensure that "Restrict Public IP access on Cloud SQL instances" policy is enforced for your Google Cloud organizations. Due to strict security and compliance regulations, you can't allow GCP members to configure security-critical database instances with public IPs.

### Risk Level

Medium

### Address

Security, Operational Maturity

### Compliance Standards

CISGCP, CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to your Google Cloud Platform (GCP) console.

2. Navigate to the IAM & Admin page. Here, you can view all the IAM policies that are currently in place for your organization.

3. In the IAM & Admin page, select the "Policy Intelligence" option from the left-hand side menu. This will open up a new page where you can analyze and understand the effects of your IAM policies.

4. In the Policy Intelligence page, use the "Policy Simulator" tool to simulate the effect of restricting public IP access for Cloud SQL instances at the organization level. This tool allows you to see what would happen if you applied a certain policy, without actually applying it. You can use this tool to check if the policy of restricting public IP access for Cloud SQL instances is currently in place or not.

#### Using CLI

1. First, you need to install and initialize the Google Cloud SDK (Software Development Kit) if you haven't done so already. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, you can initialize it by running the command `gcloud init` and follow the prompts to authorize the SDK and set the default project, compute region, and zone.

2. Once the SDK is installed and initialized, you can use the `gcloud` command-line tool to list all the Cloud SQL instances in your project. Run the following command:

   ```
   gcloud sql instances list
   ```

   This command will return a list of all Cloud SQL instances in your project, along with their details.

3. To check the public IP access for a specific Cloud SQL instance, you can use the `gcloud sql instances describe` command followed by the instance ID. This command will return a detailed description of the instance, including its IP configuration. Run the following command:

   ```
   gcloud sql instances describe [INSTANCE_ID]
   ```

   Replace `[INSTANCE_ID]` with the ID of the instance you want to check. Look for the `ipAddresses` field in the output. If the `type` is `PRIMARY` and `ipAddress` is not empty, then the instance has a public IP address.

4. To check this for all instances at the organization level, you would need to script this process, looping over all projects in the organization, and then all instances in each project. This could be done in a bash script or a Python script using the `subprocess` module to run the `gcloud` commands.

#### Using Python

1. **Setup Google Cloud SDK and Python Environment:**
   First, you need to set up the Google Cloud SDK and Python environment. You can do this by installing the Google Cloud SDK and setting up the Python environment with the necessary libraries. Here is a sample script to install the Google Cloud SDK:

   ```python
   import os
   os.system('curl https://sdk.cloud.google.com | bash')
   os.system('exec -l $SHELL')
   os.system('gcloud init')
   ```

2. **Import Google Cloud Libraries:**
   Import the necessary Google Cloud libraries in your Python script. You will need the `google-auth`, `google-auth-httplib2`, `google-auth-oauthlib`, `google-api-python-client`, and `oauthlib` libraries. You can install these using pip:

   ```python
   import os
   os.system('pip install --upgrade google-auth google-auth-httplib2 google-auth-oauthlib google-api-python-client oauthlib')
   ```

3. **Authenticate and Initialize Cloud SQL Service:**
   Authenticate your script with Google Cloud and initialize the Cloud SQL service. You can do this using the `google.auth` and `googleapiclient.discovery` libraries:

   ```python
   from google.oauth2 import service_account
   from googleapiclient import discovery

   credentials = service_account.Credentials.from_service_account_file(
       '/path/to/your/service-account-file.json')
   service = discovery.build('sqladmin', 'v1beta4', credentials=credentials)
   ```

4. **Check Public IP Access for Cloud SQL Instances:**
   Now, you can check the public IP access for all Cloud SQL instances in your organization. You can do this by listing all instances and checking the `ipConfiguration` field for each instance:

   ```python
   project = 'your-project-id'  # replace with your project ID
   instances = service.instances().list(project=project).execute()

   for instance in instances['items']:
       settings = instance['settings']
       ip_config = settings['ipConfiguration']
       if 'authorizedNetworks' in ip_config:
           print(f"Instance {instance['name']} has public IP access.")
       else:
           print(f"Instance {instance['name']} does not have public IP access.")
   ```

   This script will print out whether each Cloud SQL instance in your project has public IP access or not.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Restricting Public IP Access for Cloud SQL Instances at Organization Level in GCP, follow these steps:

1. Open the GCP console and select the organization that you want to remediate the misconfiguration for.

2. Go to the Cloud SQL Instances page by clicking on the hamburger menu on the top left corner of the console and selecting SQL under the Storage section.

3. Click on the instance that you want to remediate the misconfiguration for.

4. Click on the Edit button at the top of the instance details page.

5. Scroll down to the Connectivity section and click on the Private IP button.

6. Under the Private IP section, select the checkbox for "Enable Private IP" to allow the instance to be accessed only through private IP addresses.

7. Click on the Save button at the bottom of the page to apply the changes.

8. Repeat steps 3-7 for all the Cloud SQL instances in the organization to ensure that they are only accessible through private IP addresses.

By following these steps, you have successfully remediated the misconfiguration of Restricting Public IP Access for Cloud SQL Instances at Organization Level in GCP.

#### Using CLI

To remediate the misconfiguration of allowing public IP access for Cloud SQL instances at the organization level in GCP using GCP CLI, you can follow these steps:

1. Open the Cloud Shell in the GCP console.

2. Run the following command to check if any Cloud SQL instances have public IP addresses:

   ```
   gcloud sql instances list
   ```

3. If any instances have public IP addresses, note down their names.

4. Run the following command to update the instances to not allow public IP access:

   ```
   gcloud sql instances patch INSTANCE_NAME --no-assign-ip
   ```

   Replace INSTANCE_NAME with the name of the instance that you want to update.

5. Repeat step 4 for all instances that have public IP addresses.

6. Verify that the instances no longer have public IP addresses by running the following command:

   ```
   gcloud sql instances describe INSTANCE_NAME | grep ipAddress
   ```

   Replace INSTANCE_NAME with the name of the instance that you want to verify.

   If the output shows `ipAddress: <unset>`, then the instance no longer has a public IP address.

7. Repeat step 6 for all instances that you updated.

By following these steps, you can remediate the misconfiguration of allowing public IP access for Cloud SQL instances at the organization level in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of Restricting Public IP Access for Cloud SQL Instances at the organization level in GCP using Python, you can follow the below steps:

1. First, you need to identify all the Cloud SQL instances that have public IP access enabled in your organization. You can use the Google Cloud SDK to list all the instances with public IP access enabled using the following command:

   ```
   gcloud sql instances list --filter "settings.ipConfiguration.authorizedNetworks.cidrBlock='0.0.0.0/0'"
   ```

2. Once you have identified the instances that have public IP access enabled, you need to update their network configuration to restrict public IP access. You can use the Google Cloud Python SDK to update the network configuration of the instances using the following code:

   ```
   from google.cloud import sql_v1beta4
   from google.protobuf.field_mask_pb2 import FieldMask

   client = sql_v1beta4.CloudSqlInstancesServiceClient()

   instance_name = "projects/{project_id}/instances/{instance_id}".format(
       project_id="your-project-id", instance_id="your-instance-id"
   )

   instance = client.get_instance(name=instance_name)

   # Update the authorized networks to restrict public IP access
   instance.settings.ip_configuration.authorized_networks = []

   # Update the instance with the new network configuration
   update_mask = FieldMask(paths=["settings.ip_configuration.authorized_networks"])
   updated_instance = client.update_instance(instance=instance, update_mask=update_mask)
   ```

3. You can run the above code for all the instances that have public IP access enabled to update their network configuration and restrict public IP access.

By following the above steps, you can remediate the misconfiguration of Restricting Public IP Access for Cloud SQL Instances at the organization level in GCP using Python.




</Tab>
</Tabs>