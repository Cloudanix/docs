

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser and navigate to the Google Cloud Platform Console (console.cloud.google.com). Use your Google account credentials to log in.

2. Navigate to IAM & Admin: Once you're logged in, look for the navigation menu on the left-hand side of the console. Click on the menu icon (three horizontal lines), then scroll down and click on "IAM & Admin".

3. View IAM Members: In the IAM & Admin page, click on "IAM" in the left-hand menu. This will bring up a list of all IAM members associated with your GCP project. 

4. Check Email Addresses: In the IAM members list, you can see the email addresses associated with each member. Check these email addresses to ensure that they are work emails. If a personal email address is being used, this is a misconfiguration.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the SDK is installed and configured, you can use the `gcloud` command to interact with your Google Cloud resources. To list all the IAM policies in your project, use the following command:

    ```
    gcloud projects get-iam-policy [PROJECT_ID]
    ```

    Replace `[PROJECT_ID]` with your project ID.

3. This command will return a JSON object that contains all the IAM policies in your project. Each policy will have a `members` field that lists the email addresses of the users who have that policy.

4. To check if users are using their work email for access, you can write a script that parses this JSON object and checks if the email addresses in the `members` field are work emails. This can be done using a regular expression that matches the domain of your work email. For example, if your work email domain is `example.com`, the regular expression could be `@example\.com$`. If any email address does not match this regular expression, it means that the user is not using their work email for access.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) to interact with AWS services. You can install it using pip:

   ```
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config:

   ~/.aws/credentials:
   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

   ~/.aws/config:
   ```
   [default]
   region=us-east-1
   ```

3. Write a Python script to list all IAM users and their email addresses: The following script uses the Boto3 library to list all IAM users and their email addresses. It checks if the email address is a work email address by checking if it contains the company's domain.

   ```python
   import boto3

   # Create an IAM client
   iam = boto3.client('iam')

   # List all users
   users = iam.list_users()
   for user in users['Users']:
       # Get user details
       user_details = iam.get_user(UserName=user['UserName'])
       # Check if the user has an email address
       if 'Email' in user_details['User']:
           email = user_details['User']['Email']
           # Check if the email address is a work email address
           if '@yourcompany.com' not in email:
               print(f"User {user['UserName']} is not using a work email address.")
   ```

4. Run the Python script: You can run the Python script using the following command:

   ```
   python check_email.py
   ```

   This will print out the usernames of all users who are not using a work email address.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Users Should Use Work Email For Access" in GCP using GCP console, you can follow these steps:

1. Go to the GCP Console and select the project for which you need to remediate the misconfiguration.
2. Click on the "IAM & Admin" menu from the left-hand side navigation menu.
3. Click on the "IAM" tab to view the list of IAM roles and members.
4. Select the user for whom you want to remediate the misconfiguration.
5. Click on the "Edit" button next to the user's email address.
6. In the "Edit member" dialog box, scroll down to the "Role" section.
7. Click on the "Add Another Role" button to add a new role.
8. In the "Select a Role" dialog box, search for the "Organization Policy User" role and select it.
9. Click on the "Save" button to add the new role to the user.
10. Repeat the above steps for all the users who have access to the project.

By adding the "Organization Policy User" role to the users, you are enforcing the organization policy that requires users to use their work email for access. This will ensure that only authorized users with valid work emails can access the GCP resources.

#### Using CLI

To remediate the misconfiguration "Users Should Use Work Email For Access" in GCP using GCP CLI, you can follow the below steps:

1. Open the Cloud Shell in the GCP Console.

2. Run the following command to check if the G Suite domain is set for the organization:

   ```
   gcloud organizations describe ORGANIZATION_ID
   ```

   Replace `ORGANIZATION_ID` with your organization ID.

3. If the G Suite domain is not set for the organization, follow the instructions given in the following link to set up a G Suite domain: 

   https://cloud.google.com/resource-manager/docs/creating-managing-organization#setup_a_g_suite_domain

4. Once the G Suite domain is set up, run the following command to enable domain-restricted sharing:

   ```
   gcloud beta identity organizational-settings domains update DOMAIN_NAME --allow-unrestricted-sharing=false --force
   ```

   Replace `DOMAIN_NAME` with your G Suite domain name.

   This command restricts sharing of GCP resources to only users with email addresses in the specified G Suite domain.

5. Run the following command to verify that the domain-restricted sharing is enabled:

   ```
   gcloud beta identity organizational-settings domains describe DOMAIN_NAME
   ```

   Replace `DOMAIN_NAME` with your G Suite domain name.

   This command should return the following output:

   ```
   allowUnrestrictedSharing: false
   ```

   This confirms that the domain-restricted sharing is enabled.

6. Finally, you can check the users who have access to your GCP resources using the following command:

   ```
   gcloud projects get-iam-policy PROJECT_ID
   ```

   Replace `PROJECT_ID` with your GCP project ID.

   This command lists all the users who have access to your GCP resources. Make sure that all the users have email addresses in the specified G Suite domain. If any user does not have an email address in the specified G Suite domain, remove their access to the GCP resources using the following command:

   ```
   gcloud projects remove-iam-policy-binding PROJECT_ID --member=user:EMAIL_ADDRESS --role=ROLE
   ```

   Replace `PROJECT_ID` with your GCP project ID, `EMAIL_ADDRESS` with the email address of the user, and `ROLE` with the role that the user has been assigned.

   This command removes the user's access to the specified GCP resources.

#### Using Python

To remediate the misconfiguration "Users Should Use Work Email For Access" in GCP, we can use the following steps using Python:

1. First, we need to identify the users who are not using their work email for access to GCP. We can do this by using the `google-auth` and `google-api-python-client` libraries to authenticate and make API requests to the GCP Admin SDK.

2. Once we have identified the users, we can update their email addresses to their work email using the `googleapiclient.discovery` module. We can use the `users().update()` method to update the email address of the user.

3. We can also set up a notification system to alert users who are not using their work email for access to update their email address.

Here is a sample Python code to remediate the misconfiguration "Users Should Use Work Email For Access" in GCP:

```python
from google.oauth2 import service_account
from googleapiclient.discovery import build

# Replace with the path to your service account key file
KEY_FILE_LOCATION = '/path/to/keyfile.json'

# Replace with your GCP project ID
PROJECT_ID = 'your-project-id'

# Replace with the domain of your organization
DOMAIN = 'your-domain.com'

# Authenticate using a service account key file
creds = service_account.Credentials.from_service_account_file(
    KEY_FILE_LOCATION,
    scopes=['https://www.googleapis.com/auth/admin.directory.user']
)

# Create the Admin SDK API client
service = build('admin', 'directory_v1', credentials=creds)

# Get a list of all users in the domain
users = service.users().list(domain=DOMAIN).execute()

# Loop through the users and update their email address if it is not their work email
for user in users['users']:
    if user['primaryEmail'].endswith('@gmail.com'):
        # Update the user's email address to their work email
        new_email = user['primaryEmail'].replace('@gmail.com', '@your-domain.com')
        service.users().update(userKey=user['id'], body={'primaryEmail': new_email}).execute()

        # Send a notification to the user to update their email address
        print(f"Updated email address for user {user['primaryEmail']}. Please update your email address to your work email.")
```

Note: This code assumes that all users in the domain have a work email address with the same domain as the organization. If this is not the case, you may need to modify the code to handle different email domains.


</Tab>
</Tabs>