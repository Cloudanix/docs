

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser and navigate to the GCP Console (console.cloud.google.com) and sign in with your Google account credentials.

2. Navigate to IAM & Admin: Once you're logged in, locate the navigation menu on the top left corner of the console. Click on it and scroll down to "IAM & Admin" and click on it.

3. View IAM Roles: In the IAM & Admin page, you will see a list of all the IAM roles in your GCP project. Look for any user-managed service accounts.

4. Check Privileges: Click on the service account to view its details. In the "Role" column, check if the service account has been assigned any 'Admin' roles. If it has, then it's a misconfiguration as user-managed service accounts should not have admin privileges.

#### Using CLI

1. First, you need to install and initialize the Google Cloud SDK (if not already done). You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, you can initialize it using the command `gcloud init`.

2. List all the IAM policies in your GCP project using the following command:
   ```
   gcloud projects get-iam-policy [PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your actual project ID. This command will return a list of all IAM policies in your project.

3. Filter the output to find user-managed service accounts with admin privileges. You can do this by looking for roles that include "admin" in their name. You can use the following command:
   ```
   gcloud projects get-iam-policy [PROJECT_ID] --flatten="bindings[].members" --format='table(bindings.role,bindings.members)' | grep 'admin'
   ```
   This command will return a table with two columns: the role and the member. If a user-managed service account has an admin role, it will appear in this list.

4. To further filter the output to only show user-managed service accounts, you can add another `grep` command to the pipeline:
   ```
   gcloud projects get-iam-policy [PROJECT_ID] --flatten="bindings[].members" --format='table(bindings.role,bindings.members)' | grep 'admin' | grep 'user'
   ```
   This command will only return user-managed service accounts with admin roles. If this command returns any results, it means that there are user-managed service accounts with admin privileges in your GCP project.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the Google Cloud SDK and the Google Auth, Google Auth OAuthlib, Google Auth HTTPLib2, Google API Client, and Google Cloud IAM libraries for Python. You can do this using pip:

   ```
   pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client google-cloud-iam
   ```

2. Authenticate your session: You need to authenticate your session with GCP. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key JSON file.

   ```python
   import os
   os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/path/to/your/service-account-file.json"
   ```

3. Get the IAM policy for the service account: You can use the `get_iam_policy` method of the `google.cloud.iam` library to get the IAM policy for the service account. This will return a `Policy` object that contains the bindings for the service account.

   ```python
   from google.cloud import iam
   from google.api_core.exceptions import NotFound

   client = iam.ServiceAccountManagerClient()
   service_account_name = client.service_account_path('[PROJECT]', '[SERVICE_ACCOUNT]')

   try:
       policy = client.get_iam_policy(service_account_name)
   except NotFound:
       print('Service account not found.')
   ```

4. Check the roles of the service account: You can iterate over the bindings in the policy and check if the service account has the 'roles/owner' or 'roles/editor' role. If it does, then it has admin privileges.

   ```python
   for binding in policy.bindings:
       if 'roles/owner' in binding.role or 'roles/editor' in binding.role:
           for member in binding.members:
               if service_account_name in member:
                   print('Service account has admin privileges.')
   ```
   
Remember to replace '[PROJECT]' and '[SERVICE_ACCOUNT]' with your actual project ID and service account ID.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "User Managed Service Account Should Not Have Admin Privileges" in GCP using GCP console, follow the below steps:

1. Login to the Google Cloud Console with your credentials.
2. Navigate to the "IAM & Admin" section of the console.
3. Select "Service Accounts" from the left-hand menu.
4. Locate the user-managed service account that has admin privileges.
5. Click on the service account to open its details page.
6. Click on the "Permissions" tab.
7. Scroll down to the "Role" section and click the "Edit" button.
8. Remove the admin role from the service account by unchecking the box next to the role.
9. Click "Save" to save the changes.
10. Verify that the service account no longer has admin privileges by checking the "Permissions" tab.

By following these steps, you have successfully remediated the misconfiguration "User Managed Service Account Should Not Have Admin Privileges" in GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "User Managed Service Account Should Not Have Admin Privileges" in GCP using GCP CLI, follow the below steps:

1. Identify the user-managed service account that has admin privileges using the following command:

```
gcloud iam service-accounts list
```

2. Once you have identified the service account, remove the admin role from the service account using the following command:

```
gcloud projects remove-iam-policy-binding [PROJECT_ID] --member=serviceAccount:[SERVICE_ACCOUNT_EMAIL] --role=roles/owner
```

Replace `[PROJECT_ID]` with your project ID and `[SERVICE_ACCOUNT_EMAIL]` with the email address of the service account.

3. Verify that the admin role has been removed from the service account using the following command:

```
gcloud projects get-iam-policy [PROJECT_ID] --flatten="bindings[].members" --format='table(bindings.role)' --filter="bindings.members:serviceAccount:[SERVICE_ACCOUNT_EMAIL]"
```

Replace `[PROJECT_ID]` with your project ID and `[SERVICE_ACCOUNT_EMAIL]` with the email address of the service account.

This should remediate the misconfiguration "User Managed Service Account Should Not Have Admin Privileges" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "User Managed Service Account Should Not Have Admin Privileges" in GCP using Python, you can follow the below steps:

1. First, you need to identify all the user-managed service accounts that have admin privileges. You can use the following code to do this:

```
from google.oauth2 import service_account
from googleapiclient.discovery import build

# Set the required scopes
SCOPES = ['https://www.googleapis.com/auth/cloud-platform']

# Set the credentials using the service account key file
credentials = service_account.Credentials.from_service_account_file(
    'path/to/service_account_key.json', scopes=SCOPES)

# Build the IAM Service client object
iam_service = build('iam', 'v1', credentials=credentials)

# Get all the IAM policies for the project
policy = iam_service.projects().getIamPolicy(resource='projects/PROJECT_ID').execute()

# Get all the user-managed service accounts with admin privileges
for binding in policy['bindings']:
    if 'roles/owner' in binding['role']:
        for member in binding['members']:
            if 'user-managed' in member:
                print(f"{member} has admin privileges")
```

Replace `path/to/service_account_key.json` with the path to your service account key file and `PROJECT_ID` with your GCP project ID.

2. Once you have identified the user-managed service accounts with admin privileges, you can remove the admin role from them using the following code:

```
from googleapiclient.errors import HttpError

# Set the user-managed service account email
user_managed_service_account = 'user-managed-service-account@PROJECT_ID.iam.gserviceaccount.com'

# Set the role to be removed
role = 'roles/owner'

# Build the IAM Service client object
iam_service = build('iam', 'v1', credentials=credentials)

# Get the current IAM policy for the project
policy = iam_service.projects().getIamPolicy(resource='projects/PROJECT_ID').execute()

# Remove the role from the user-managed service account
for binding in policy['bindings']:
    if role in binding['role'] and user_managed_service_account in binding['members']:
        binding['members'].remove(user_managed_service_account)

# Update the IAM policy for the project
try:
    updated_policy = iam_service.projects().setIamPolicy(resource='projects/PROJECT_ID', body={'policy': policy}).execute()
    print(f"{user_managed_service_account} no longer has admin privileges")
except HttpError as e:
    print(f"Error updating IAM policy: {e}")
```

Replace `PROJECT_ID` with your GCP project ID and set the `user_managed_service_account` variable to the email address of the user-managed service account that you want to remove the admin role from.

These steps will remediate the misconfiguration "User Managed Service Account Should Not Have Admin Privileges" in GCP using Python.


</Tab>
</Tabs>