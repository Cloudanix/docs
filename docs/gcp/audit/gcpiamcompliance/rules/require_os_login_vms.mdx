---
slug: require_os_login_vms
title: Require OS Login
sidebar_label: Require OS Login
---

### More Info:

Ensure that "Require OS Login" constraint policy is enforced at the GCP organization level in order to enable OS Login feature on all newly created Google Cloud projects within your organization. The OS Login provides you with centralized and automated SSH key pair management.

### Risk Level

Medium

### Address

Operational Maturity, Reliability, Security

### Compliance Standards

CISGCP, CBP, ISO27001, HIPAA


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the Google Cloud Console: Open your web browser, navigate to the Google Cloud Console page and sign in with your Google Cloud account credentials.

2. Navigate to the IAM & Admin page: From the Google Cloud Console dashboard, click on the navigation menu (three horizontal lines in the upper left corner of the screen). Scroll down and click on "IAM & Admin".

3. Check the IAM policy: On the IAM & Admin page, click on "IAM" in the left-hand menu. This will bring up a list of all the IAM roles and permissions in your Google Cloud project. Look for the "OS Login" role. If it's not there, then OS Login is not required.

4. Check the metadata: Go back to the navigation menu and click on "Compute Engine", then "Metadata" in the left-hand menu. Look for an entry with the key "enable-oslogin". If the value is "TRUE", then OS Login is required. If the key doesn't exist or the value is "FALSE", then OS Login is not required.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the SDK is installed and configured, open your terminal or command prompt and run the following command to authenticate your SDK with your Google Cloud account:

   ```
   gcloud auth login
   ```
   Follow the prompts to log in with your Google account.

3. Now, you can list all the instances in your project by running the following command:

   ```
   gcloud compute instances list
   ```
   This command will return a list of all the instances in your project, along with their details.

4. To check if the 'Require OS Login' feature is enabled for an instance, you need to describe the instance and look for the 'enable-oslogin' metadata key. You can do this by running the following command:

   ```
   gcloud compute instances describe [INSTANCE_NAME] --format='get(metadata.items)'
   ```
   Replace '[INSTANCE_NAME]' with the name of the instance you want to check. If the 'enable-oslogin' key is present and set to 'TRUE', then the 'Require OS Login' feature is enabled for that instance. If the key is not present or set to 'FALSE', then the feature is not enabled.

#### Using Python

To check the "Require OS Login" setting in Google Cloud Platform (GCP) using Python scripts, you can use the Google Cloud SDK and the Google Auth and IAM API. Here are the steps:

1. **Install the necessary libraries**: You need to install the Google Cloud SDK, Google Auth, and Google IAM libraries for Python. You can do this using pip:

```python
pip install --upgrade google-cloud-sdk google-auth google-auth-httplib2 google-auth-oauthlib google-api-python-client google-cloud-iam
```

2. **Authenticate your script**: Before you can interact with GCP resources, you need to authenticate your script. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key JSON file:

```python
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "/path/to/your/service-account-key.json"
```

3. **Initialize the IAM client**: You can use the IAM client to interact with IAM resources. Initialize it like this:

```python
from google.cloud import iam
client = iam.IAMClient()
```

4. **Check the "Require OS Login" setting**: You can check the "Require OS Login" setting for a specific instance by calling the `get_iam_policy` method on the client and checking the `bindings` attribute of the returned policy:

```python
instance_name = "projects/my-project/zones/my-zone/instances/my-instance"
policy = client.get_iam_policy(resource=instance_name)
for binding in policy.bindings:
    if binding.role == 'roles/compute.osLogin' and 'user:my-user@example.com' in binding.members:
        print("Require OS Login is enabled for this instance.")
    else:
        print("Require OS Login is not enabled for this instance.")
```

This script will print whether the "Require OS Login" setting is enabled for the specified instance.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

The "Require OS Login" misconfiguration in GCP means that instances in your project do not require OS Login to access the instance. OS Login is a feature that lets you use your Google Cloud identity to manage access to Linux instances running on Compute Engine. 

To remediate this misconfiguration, you can follow these steps:

1. Open the Google Cloud Console and select your project.
2. In the left-hand menu, click on "Compute Engine" and then "VM instances".
3. Select the instance for which you want to enable OS Login.
4. Click on "Edit" at the top of the page.
5. Scroll down to the "Cloud API access scopes" section.
6. Click on "Change" next to "Access scopes".
7. In the "Access scopes" dialog box, select "Allow full access to all Cloud APIs" and click "Save".
8. Scroll down to the "OS Login" section and select "Enable OS Login".
9. Click "Save" at the bottom of the page.

After completing these steps, OS Login will be enabled for the selected instance, and users will need to authenticate with their Google Cloud identity to access the instance.

#### Using CLI

The "Require OS Login" feature in GCP ensures that all users who need to access an instance must have a valid user account on the instance. It can be remediated using the following steps:

1. Open the Cloud Shell in GCP console.

2. Run the following command to enable the "Require OS Login" feature for all instances in the project:

   ```
   gcloud compute project-info add-metadata \
   --metadata enable-oslogin=TRUE
   ```

3. Run the following command to update all existing instances in the project to use the "Require OS Login" feature:

   ```
   gcloud compute instances add-metadata \
   --metadata enable-oslogin=TRUE --all
   ```

4. If you create a new instance, the "Require OS Login" feature will be enabled by default. However, if you want to disable it for a specific instance, you can do so by running the following command:

   ```
   gcloud compute instances add-metadata INSTANCE_NAME \
   --metadata enable-oslogin=FALSE
   ```

   Replace INSTANCE_NAME with the name of the instance you want to disable the feature for.

By following the above steps, you can remediate the "Require OS Login" misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the "Require OS Login" misconfiguration in GCP using Python, you can follow the below steps:

Step 1: Import the required libraries and authenticate the user credentials using Google Cloud SDK.

```
from google.oauth2 import service_account
from googleapiclient.discovery import build

# Authenticate the user credentials
credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_file>')
service = build('compute', 'v1', credentials=credentials)
```

Step 2: Get the list of all instances in the project.

```
project = '<project_id>'
zone = '<zone>'

# Get the list of all instances
instances = service.instances().list(project=project, zone=zone).execute()
```

Step 3: Iterate through the list of instances and update the metadata to enable "Require OS Login".

```
for instance in instances['items']:
    instance_name = instance['name']
    instance_zone = instance['zone'].split('/')[-1]

    # Get the current metadata of the instance
    metadata = service.instances().get(project=project, zone=instance_zone, instance=instance_name).execute()['metadata']

    # Update the metadata to enable "Require OS Login"
    metadata['items'].append({'key': 'enable-oslogin', 'value': 'TRUE'})

    # Set the updated metadata to the instance
    request = service.instances().setMetadata(project=project, zone=instance_zone, instance=instance_name, body=metadata)
    response = request.execute()
```

Step 4: Verify if the "Require OS Login" is enabled for all instances.

```
for instance in instances['items']:
    instance_name = instance['name']
    instance_zone = instance['zone'].split('/')[-1]

    # Get the current metadata of the instance
    metadata = service.instances().get(project=project, zone=instance_zone, instance=instance_name).execute()['metadata']

    # Verify if the "Require OS Login" is enabled
    for item in metadata['items']:
        if item['key'] == 'enable-oslogin' and item['value'] == 'TRUE':
            print(f"Require OS Login is enabled for instance {instance_name}")
            break
    else:
        print(f"Require OS Login is not enabled for instance {instance_name}")
```

Note: Make sure to replace the `<path_to_service_account_file>`, `<project_id>` and `<zone>` with the actual values in the code.




</Tab>
</Tabs>