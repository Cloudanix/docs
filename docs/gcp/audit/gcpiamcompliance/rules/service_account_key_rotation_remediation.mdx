

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to IAM & Admin: Once you're logged in, locate the navigation menu on the left-hand side of the console. Click on the menu icon (three horizontal lines), then scroll down and click on "IAM & Admin".

3. Access Service Accounts: In the IAM & Admin page, click on "Service Accounts" in the left-hand side menu. This will display a list of all service accounts associated with your Google Cloud Platform project.

4. Check Key Rotation: For each service account, check the "Keys" column. If a key has not been rotated in a long time (e.g., more than 90 days), it's a sign of potential misconfiguration. Google Cloud Platform does not automatically rotate keys, so this needs to be done manually.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and configured, you can list all the service accounts in your project by running the following command in your terminal:

   ```
   gcloud iam service-accounts list --project=[PROJECT_ID]
   ```
   Replace `[PROJECT_ID]` with your project ID. This command will return a list of all service accounts in your project.

3. For each service account, you can list all the keys associated with it by running the following command:

   ```
   gcloud iam service-accounts keys list --iam-account=[SERVICE_ACCOUNT_EMAIL]
   ```
   Replace `[SERVICE_ACCOUNT_EMAIL]` with the email of the service account. This command will return a list of all keys associated with the service account.

4. For each key, check the `validAfterTime` and `validBeforeTime` fields. These fields indicate the time period during which the key is valid. If the key has been valid for a long time (for example, more than 90 days), it may need to be rotated.

#### Using Python

1. **Import necessary libraries and establish a connection:**
   First, you need to import the necessary libraries in your Python script. You will need the `google.auth` library to authenticate your script with GCP and the `googleapiclient.discovery` library to interact with the IAM API. Here is an example of how to do this:

   ```python
   import google.auth
   from googleapiclient.discovery import build
   ```

   Then, you need to establish a connection to the GCP IAM service. Here is an example of how to do this:

   ```python
   credentials, project = google.auth.default()
   service = build('iam', 'v1', credentials=credentials)
   ```

2. **List all service accounts:**
   Next, you need to list all service accounts in your GCP project. You can do this using the `projects().serviceAccounts().list()` method. Here is an example of how to do this:

   ```python
   request = service.projects().serviceAccounts().list(name='projects/' + project)
   response = request.execute()
   service_accounts = response['accounts']
   ```

3. **Check the keys of each service account:**
   For each service account, you need to check the keys. You can do this using the `projects().serviceAccounts().keys().list()` method. Here is an example of how to do this:

   ```python
   for account in service_accounts:
       request = service.projects().serviceAccounts().keys().list(name=account['name'])
       response = request.execute()
       keys = response['keys']
   ```

4. **Check the age of each key:**
   For each key, you need to check the age. If the age is more than 90 days, then the key is considered old and should be rotated. Here is an example of how to do this:

   ```python
   from datetime import datetime, timedelta
   for key in keys:
       created_at = datetime.strptime(key['validAfterTime'], '%Y-%m-%dT%H:%M:%S.%fZ')
       if datetime.now() - created_at > timedelta(days=90):
           print(f"Key {key['name']} is old and should be rotated")
   ```
   
This script will print out the names of all keys that are old and should be rotated.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Service Account Keys Should Be Rotated" for GCP using GCP console, follow the steps below:

1. Login to the Google Cloud Console using your credentials.
2. Navigate to the IAM & Admin page from the left-hand menu.
3. Click on Service Accounts from the list of options.
4. Select the service account for which you want to rotate the keys.
5. Click on the Edit button for the selected service account.
6. Scroll down to the Keys section and click on the Add Key button.
7. Select the type of key you want to add from the dropdown list.
8. Click on the Create button to generate the new key.
9. Once the new key is created, download it and store it securely.
10. Delete the old key(s) that are no longer required.

By following these steps, you have successfully rotated the service account keys for your GCP project. Make sure to repeat this process periodically to keep your service account keys up to date.

#### Using CLI

To remediate the misconfiguration "Service Account Keys Should Be Rotated" for GCP using GCP CLI, you can follow the below steps:

1. First, you need to identify the Service Account Keys that need to be rotated. You can use the below command to list all the Service Accounts in your project:

```
gcloud iam service-accounts list
```

2. Once you have identified the Service Account that needs to be rotated, you can create a new key for that Service Account using the below command:

```
gcloud iam service-accounts keys create [FILE_NAME].json --iam-account [SERVICE_ACCOUNT_EMAIL]
```

Replace [FILE_NAME] with the name of the file you want to create for the new key and replace [SERVICE_ACCOUNT_EMAIL] with the email of the Service Account that needs to be rotated.

3. After creating the new key, you need to delete the old key. You can use the below command to list all the keys for a Service Account:

```
gcloud iam service-accounts keys list --iam-account [SERVICE_ACCOUNT_EMAIL]
```

4. Once you have identified the old key that needs to be deleted, you can use the below command to delete it:

```
gcloud iam service-accounts keys delete [KEY_ID] --iam-account [SERVICE_ACCOUNT_EMAIL]
```

Replace [KEY_ID] with the ID of the key that needs to be deleted and replace [SERVICE_ACCOUNT_EMAIL] with the email of the Service Account.

5. Finally, you need to ensure that the new key is being used by all the applications that were using the old key. You can update the applications with the new key manually or by using automation tools like Ansible or Terraform.

By following the above steps, you can remediate the misconfiguration "Service Account Keys Should Be Rotated" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Service Account Keys Should Be Rotated" in GCP using Python, you can follow the below steps:

Step 1: Install the required libraries

Install the Google Cloud SDK and the Python client library using pip.

```
!pip install google-cloud-storage
```

Step 2: Authenticate the client

Authenticate the client using the service account key that you want to rotate.

```
from google.oauth2 import service_account
from google.cloud import storage

key_path = 'path/to/service_account_key.json'
credentials = service_account.Credentials.from_service_account_file(key_path)
client = storage.Client(credentials=credentials)
```

Step 3: Rotate the service account key

Create a new service account key and delete the old one.

```
from google.cloud import iam

iam_client = iam.IAMClient(credentials=credentials)

# Get the service account ID
service_account_email = 'service-account@project-id.iam.gserviceaccount.com'
service_account_id = service_account_email.split('@')[0]

# Create a new service account key
new_key = iam_client.create_service_account_key(name=f'projects/-/serviceAccounts/{service_account_email}')['privateKeyData']

# Delete the old service account key
keys = iam_client.list_service_account_keys(name=f'projects/-/serviceAccounts/{service_account_email}')
for key in keys:
    if key.key_id != 'latest':
        iam_client.delete_service_account_key(name=key.name)
```

Step 4: Save the new service account key

Save the new service account key to a file.

```
import base64

new_key = base64.b64decode(new_key).decode('utf-8')
with open('path/to/new_service_account_key.json', 'w') as f:
    f.write(new_key)
```

Step 5: Update the service account key in the application

Update the service account key in the application with the new key that you have generated.

Note: Make sure to update the service account key in all the places where it is being used.

By following these steps, you can remediate the misconfiguration "Service Account Keys Should Be Rotated" in GCP using Python.


</Tab>
</Tabs>