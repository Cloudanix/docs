

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to IAM & Admin: Once you're logged in, locate the navigation menu in the top left corner of the console. Click on it and scroll down to find "IAM & Admin". Click on it to open the IAM & Admin dashboard.

3. Access IAM Policy: In the IAM & Admin dashboard, click on "IAM" in the left-hand menu. This will open the IAM policy for your GCP project. Here, you can see all the IAM roles and permissions assigned to your project.

4. Check KMS Cryptokeys Permissions: In the IAM policy, look for any roles or users that have the "cloudkms.cryptoKeyVersions.useToEncrypt" permission. This permission allows a user or service to use a CryptoKey to encrypt data. If this permission is assigned to "allUsers" or "allAuthenticatedUsers", then your KMS CryptoKeys are public, which is a misconfiguration.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud CLI) on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Once the Google Cloud SDK is installed and configured, open your terminal and run the following command to list all the projects in your GCP account:

   ```
   gcloud projects list
   ```

   This command will return a list of all the projects in your GCP account. Note down the PROJECT_ID of the project you want to check.

3. Now, you need to list all the KMS Cryptokeys in the project. Run the following command:

   ```
   gcloud kms keys list --location global --keyring [KEYRING_NAME] --project [PROJECT_ID]
   ```

   Replace [KEYRING_NAME] with the name of your keyring and [PROJECT_ID] with the project id you noted down in the previous step. This command will return a list of all the KMS Cryptokeys in the specified keyring and project.

4. Finally, you need to check the IAM policy for each KMS Cryptokey. Run the following command:

   ```
   gcloud kms keys get-iam-policy [KEY_NAME] --location global --keyring [KEYRING_NAME] --project [PROJECT_ID]
   ```

   Replace [KEY_NAME] with the name of the KMS Cryptokey you want to check, [KEYRING_NAME] with the name of your keyring, and [PROJECT_ID] with the project id. This command will return the IAM policy for the specified KMS Cryptokey. If the IAM policy includes "allUsers" or "allAuthenticatedUsers" in its members, then the KMS Cryptokey is public.

#### Using Python

1. Install the necessary Python libraries: You will need the `google-cloud-iam` and `google-cloud-kms` libraries to interact with Google Cloud IAM and KMS services. You can install these libraries using pip:

```python
pip install --upgrade google-cloud-iam google-cloud-kms
```

2. Import the necessary modules and initialize the KMS client:

```python
from google.cloud import kms_v1
from google.cloud.kms_v1 import enums

# Creates an API client for the KMS service.
client = kms_v1.KeyManagementServiceClient()
```

3. Define a function to list all the crypto keys and their IAM policies:

```python
def list_keys_and_policies(project_id, location_id, key_ring_id):
    parent = client.key_ring_path(project_id, location_id, key_ring_id)

    # Lists crypto keys
    crypto_keys = client.list_crypto_keys(parent)

    for crypto_key in crypto_keys:
        policy = client.get_iam_policy(crypto_key.name)
        yield crypto_key, policy
```

4. Check the IAM policies of each crypto key to see if they are public:

```python
def check_public_keys(project_id, location_id, key_ring_id):
    for crypto_key, policy in list_keys_and_policies(project_id, location_id, key_ring_id):
        for binding in policy.bindings:
            # If the role is 'roles/cloudkms.cryptoKeyEncrypterDecrypter' and the member is 'allUsers' or 'allAuthenticatedUsers', then the key is public.
            if binding.role == 'roles/cloudkms.cryptoKeyEncrypterDecrypter' and ('allUsers' in binding.members or 'allAuthenticatedUsers' in binding.members):
                print(f'The crypto key {crypto_key.name} is public.')
```

You can call the `check_public_keys` function with your project ID, location ID, and key ring ID to check if any of your KMS crypto keys are public.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the "KMS Cryptokeys Should Not Be Public" misconfiguration in GCP using the GCP console:

1. Open the GCP console and navigate to the "Cloud KMS" page.

2. Select the key ring that contains the public key that needs to be remediated.

3. Click on the key that contains the public key that needs to be remediated.

4. Click on the "Permissions" tab.

5. Under the "Members" section, locate the user or group that has public access to the key.

6. Click on the drop-down menu next to the user or group and select "Remove".

7. Click on the "Save" button to save the changes.

8. Repeat steps 5-7 for any other users or groups that have public access to the key.

9. Once all public access has been removed, click on the "IAM" tab.

10. Check the IAM policies for the key and ensure that only authorized users or groups have access.

11. Remove any unnecessary or overly permissive IAM policies.

12. Click on the "Save" button to save the changes.

By following these steps, you will have successfully remediated the "KMS Cryptokeys Should Not Be Public" misconfiguration in GCP using the GCP console.

#### Using CLI

To remediate the KMS Cryptokeys Should Not Be Public issue for GCP using GCP CLI, please follow these steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to list all the KMS keys in your project:

   ```
   gcloud kms keys list --location=global --keyring=<keyring-name>
   ```

   Replace `<keyring-name>` with the name of the keyring containing the keys you want to check.

3. Identify the key(s) that have the `public` key policy set.

4. Run the following command to remove the `public` key policy from the identified key(s):

   ```
   gcloud kms keys set-iam-policy <key-name> <path-to-iam-policy-file>
   ```

   Replace `<key-name>` with the name of the identified key and `<path-to-iam-policy-file>` with the path to a file containing the new IAM policy for the key.

   Here's an example of a new IAM policy that removes the `public` key policy:

   ```
   {
       "bindings": [
           {
               "role": "roles/cloudkms.cryptoKeyEncrypterDecrypter",
               "members": [
                   "serviceAccount:<service-account-email>"
               ]
           }
       ]
   }
   ```

   Replace `<service-account-email>` with the email address of a service account that needs access to the key.

5. Verify that the `public` key policy has been removed from the identified key(s) by running the following command:

   ```
   gcloud kms keys get-iam-policy <key-name>
   ```

   Replace `<key-name>` with the name of the identified key.

   This should return the new IAM policy that you set in step 4 without the `public` key policy.

6. Repeat steps 3-5 for any other identified keys that have the `public` key policy set.

Once you have completed these steps, your KMS Cryptokeys should no longer be public.

#### Using Python

To remediate the misconfiguration "KMS Cryptokeys Should Not Be Public" in GCP using Python, you can follow the below steps:

1. First, you need to check if there are any publicly exposed KMS Cryptokeys in your GCP project. You can use the following Python code to list all the KMS Cryptokeys in your project:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()

project_id = 'your-project-id'

parent = f'projects/{project_id}'

# List all the KMS Cryptokeys in the project
response = client.list_crypto_keys(parent)

for crypto_key in response.crypto_keys:
    print(crypto_key.name)
```

2. Once you have the list of all the KMS Cryptokeys in your project, you need to check if any of them are public. You can use the following Python code to check if a KMS Cryptokey is public:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()

key_name = 'projects/your-project-id/locations/global/keyRings/your-keyring/cryptoKeys/your-cryptokey'

# Get the KMS Cryptokey IAM policy
response = client.get_iam_policy(key_name)

# Check if any member has 'roles/cloudkms.cryptoKeyEncrypterDecrypter' role
for binding in response.bindings:
    if 'roles/cloudkms.cryptoKeyEncrypterDecrypter' in binding['role']:
        if 'allUsers' in binding['members'] or 'allAuthenticatedUsers' in binding['members']:
            print(f"The KMS Cryptokey {key_name} is public.")
```

3. If you find any publicly exposed KMS Cryptokeys, you need to remove the public access. You can use the following Python code to remove public access from a KMS Cryptokey:

```python
from google.cloud import kms_v1

client = kms_v1.KeyManagementServiceClient()

key_name = 'projects/your-project-id/locations/global/keyRings/your-keyring/cryptoKeys/your-cryptokey'

# Get the KMS Cryptokey IAM policy
policy = client.get_iam_policy(key_name)

# Remove the 'roles/cloudkms.cryptoKeyEncrypterDecrypter' role from 'allUsers' and 'allAuthenticatedUsers'
for binding in policy.bindings:
    if 'roles/cloudkms.cryptoKeyEncrypterDecrypter' in binding['role']:
        if 'allUsers' in binding['members']:
            binding['members'].remove('allUsers')
        if 'allAuthenticatedUsers' in binding['members']:
            binding['members'].remove('allAuthenticatedUsers')

# Update the KMS Cryptokey IAM policy
update_mask = {'paths': ['bindings']}
client.set_iam_policy(key_name, policy, update_mask)
```

By following the above steps, you can remediate the misconfiguration "KMS Cryptokeys Should Not Be Public" in GCP using Python.


</Tab>
</Tabs>