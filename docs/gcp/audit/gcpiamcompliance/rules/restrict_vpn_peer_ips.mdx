---
slug: restrict_vpn_peer_ips
title: Restrict VPN Peer IPs
sidebar_label: Restrict VPN Peer IPs
---

### More Info:

Ensure that only trusted IPv4 addresses can be configured as VPN peer IPs within your Google Cloud organization. Each trusted IP address must be defined explicitly in the conformity rule settings, on the Trend Micro Cloud One™ – Conformity account console.

### Risk Level

Medium

### Address

Security, Operational Maturity

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Select your project: From the project drop-down, select the project that contains the VPN you want to inspect.

3. Navigate to VPN: On the left side menu, click on "Hybrid Connectivity" and then "VPN". This will display a list of all VPNs in your project.

4. Check VPN Peer IPs: Click on the name of the VPN you want to inspect. In the VPN details page, look for the "Peer IP" field under the "Tunnel Details" section. If the Peer IP is not restricted to specific IPs, then there is a misconfiguration.

#### Using CLI

1. First, you need to install and initialize the Google Cloud SDK (if not already done). You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, you can initialize it using the following command:
   ```
   gcloud init
   ```
2. After initializing the Google Cloud SDK, you can list all the VPN gateways in your project using the following command:
   ```
   gcloud compute vpn-gateways list
   ```
   This command will list all the VPN gateways along with their details like name, network, region, etc.

3. To check the configuration of a specific VPN gateway, you can use the following command:
   ```
   gcloud compute vpn-gateways describe [VPN_GATEWAY_NAME]
   ```
   Replace `[VPN_GATEWAY_NAME]` with the name of your VPN gateway. This command will display the configuration of the specified VPN gateway.

4. To check the peer IPs of the VPN gateway, look for the `peerIp` field in the output of the above command. If the `peerIp` field is not restricted to specific IPs, then it is a misconfiguration.

#### Using Python

To check for the restriction of VPN Peer IPs in IAM using Python scripts, you can use the Boto3 library for AWS, Azure SDK for Python for Azure, and Google Cloud Client Library for Python for GCP. Here are the steps:

1. AWS:
   - Import the Boto3 library in your Python script.
   - Create a session using your AWS credentials.
   - Use the `describe_vpn_connections` method to get a list of all VPN connections.
   - Iterate over the list and check the `VpnGatewayConfiguration` for each VPN connection. If the `VpnGatewayConfiguration` does not restrict the VPN Peer IPs, flag it.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)

ec2 = session.resource('ec2')
for vpn_connection in ec2.vpn_connections.all():
    if 'VpnGatewayConfiguration' in vpn_connection and 'VpnTunnelOptionsSpecifications' in vpn_connection['VpnGatewayConfiguration']:
        for tunnel_option in vpn_connection['VpnGatewayConfiguration']['VpnTunnelOptionsSpecifications']:
            if 'TunnelInsideCidr' not in tunnel_option or tunnel_option['TunnelInsideCidr'] == '0.0.0.0/0':
                print(f"VPN connection {vpn_connection['VpnConnectionId']} does not restrict VPN Peer IPs")
```

2. Azure:
   - Import the Azure SDK in your Python script.
   - Authenticate with your Azure credentials.
   - Use the `list_all` method from the `NetworkManagementClient` to get a list of all VPN connections.
   - Iterate over the list and check the `VpnClientConfiguration` for each VPN connection. If the `VpnClientConfiguration` does not restrict the VPN Peer IPs, flag it.

```python
from azure.mgmt.network import NetworkManagementClient
from azure.identity import DefaultAzureCredential

credential = DefaultAzureCredential()
subscription_id = 'YOUR_SUBSCRIPTION_ID'
network_client = NetworkManagementClient(credential, subscription_id)

for vpn_gateway in network_client.vpn_gateways.list_all():
    if 'VpnClientConfiguration' in vpn_gateway and 'VpnClientAddressPool' in vpn_gateway['VpnClientConfiguration']:
        if 'addressPrefixes' not in vpn_gateway['VpnClientConfiguration']['VpnClientAddressPool'] or '0.0.0.0/0' in vpn_gateway['VpnClientConfiguration']['VpnClientAddressPool']['addressPrefixes']:
            print(f"VPN gateway {vpn_gateway['name']} does not restrict VPN Peer IPs")
```

3. GCP:
   - Import the Google Cloud Client Library in your Python script.
   - Authenticate with your GCP credentials.
   - Use the `list` method from the `VpnGatewaysClient` to get a list of all VPN gateways.
   - Iterate over the list and check the `VpnTunnel` for each VPN gateway. If the `VpnTunnel` does not restrict the VPN Peer IPs, flag it.

```python
from google.cloud import compute_v1

client = compute_v1.VpnGatewaysClient()

for vpn_gateway in client.list(project='YOUR_PROJECT_ID', region='YOUR_REGION'):
    for vpn_tunnel in vpn_gateway.vpn_tunnels:
        if 'remoteTrafficSelector' not in vpn_tunnel or '0.0.0.0/0' in vpn_tunnel['remoteTrafficSelector']:
            print(f"VPN gateway {vpn_gateway['name']} does not restrict VPN Peer IPs")
```

Please replace 'YOUR_ACCESS_KEY', 'YOUR_SECRET_KEY', 'YOUR_SUBSCRIPTION_ID', 'YOUR_PROJECT_ID', and 'YOUR_REGION' with your actual AWS, Azure, and GCP credentials and settings.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Restrict VPN Peer IPs" misconfiguration in GCP using the GCP console, follow these steps:

1. Open the GCP console and navigate to the VPC network that contains the VPN gateway that needs to be remediated.

2. Click on the VPN gateway that needs to be remediated.

3. In the VPN gateway details page, click on the "Edit" button at the top of the page.

4. In the "Edit VPN gateway" page, scroll down to the "Peer IP addresses" section.

5. In the "Peer IP addresses" section, click on the "Add IP range" button.

6. In the "Add IP range" dialog box, enter the IP address range of the VPN peer that needs to be allowed access to the VPN gateway.

7. Click on the "Save" button to save the changes.

8. Repeat steps 5-7 for each VPN peer that needs to be allowed access to the VPN gateway.

9. Once all the necessary VPN peers have been added to the "Peer IP addresses" section, click on the "Save" button at the bottom of the page to save the changes to the VPN gateway.

By following these steps, you will remediate the "Restrict VPN Peer IPs" misconfiguration in GCP using the GCP console.

#### Using CLI

To remediate the "Restrict VPN Peer IPs" misconfiguration in GCP using GCP CLI, you can follow the below steps:

Step 1: Open the Cloud Shell in GCP Console.

Step 2: Run the following command to list all the VPN tunnels in your project:

```
gcloud compute vpn-tunnels list
```

Step 3: Identify the VPN tunnel that needs to be remediated and note down its name.

Step 4: Run the following command to update the VPN tunnel configuration to restrict the peer IP addresses:

```
gcloud compute vpn-tunnels update [VPN_TUNNEL_NAME] --peer-authorized-networks=[CIDR_RANGE]
```

Replace [VPN_TUNNEL_NAME] with the name of the VPN tunnel identified in step 3 and [CIDR_RANGE] with the CIDR range of the peer IP addresses that should be allowed to connect to the VPN tunnel.

For example, if the VPN tunnel name is "my-vpn-tunnel" and the allowed CIDR range is "10.0.0.0/24", the command will be:

```
gcloud compute vpn-tunnels update my-vpn-tunnel --peer-authorized-networks=10.0.0.0/24
```

Step 5: Verify the configuration by running the following command:

```
gcloud compute vpn-tunnels describe [VPN_TUNNEL_NAME]
```

This will display the details of the VPN tunnel, including the updated peer-authorized-networks configuration.

By following these steps, you can remediate the "Restrict VPN Peer IPs" misconfiguration in GCP using GCP CLI.

#### Using Python

To remediate the "Restrict VPN Peer IPs" misconfiguration in GCP using Python, you can follow these steps:

1. First, you need to identify the VPN gateway that has the misconfiguration. You can use the GCP Python SDK to list all the VPN gateways in your project and identify the one that has unrestricted VPN peer IPs.

```python
from google.cloud import compute_v1

compute_client = compute_v1.ComputeClient()

# List all VPN gateways in the project
vpn_gateways = compute_client.vpn_gateways().list(project='your-project-id').execute()

# Identify the VPN gateway that has unrestricted VPN peer IPs
for vpn_gateway in vpn_gateways['items']:
    if vpn_gateway.get('vpnInterfaces'):
        for vpn_interface in vpn_gateway['vpnInterfaces']:
            if not vpn_interface.get('ipRange', {}).get('value'):
                print(f"VPN gateway {vpn_gateway['name']} has unrestricted VPN peer IPs.")
```

2. Once you have identified the VPN gateway, you need to update its configuration to restrict the VPN peer IPs. You can use the same GCP Python SDK to update the VPN gateway configuration.

```python
from google.cloud import compute_v1

compute_client = compute_v1.ComputeClient()

# Identify the VPN gateway that has unrestricted VPN peer IPs
vpn_gateway_name = 'your-vpn-gateway-name'
vpn_gateway = compute_client.vpn_gateways().get(project='your-project-id', region='your-region', vpnGateway=vpn_gateway_name).execute()

# Restrict VPN peer IPs to a specific range
new_vpn_interface = {
    'ipRange': {
        'value': '10.0.0.0/24'
    }
}
vpn_gateway['vpnInterfaces'][0] = new_vpn_interface

# Update the VPN gateway configuration
operation = compute_client.vpn_gateways().update(project='your-project-id', region='your-region', vpnGateway=vpn_gateway_name, body=vpn_gateway).execute()
```

3. Finally, you should verify that the VPN gateway configuration has been updated successfully. You can use the same GCP Python SDK to retrieve the VPN gateway configuration and check that the VPN peer IPs are now restricted.

```python
from google.cloud import compute_v1

compute_client = compute_v1.ComputeClient()

# Retrieve the VPN gateway configuration
vpn_gateway_name = 'your-vpn-gateway-name'
vpn_gateway = compute_client.vpn_gateways().get(project='your-project-id', region='your-region', vpnGateway=vpn_gateway_name).execute()

# Check that the VPN peer IPs are now restricted
if vpn_gateway.get('vpnInterfaces'):
    for vpn_interface in vpn_gateway['vpnInterfaces']:
        if vpn_interface.get('ipRange', {}).get('value'):
            print(f"VPN gateway {vpn_gateway['name']} has restricted VPN peer IPs to {vpn_interface['ipRange']['value']}.")
```




</Tab>
</Tabs>