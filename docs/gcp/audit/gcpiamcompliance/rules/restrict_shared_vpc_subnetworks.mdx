---
slug: restrict_shared_vpc_subnetworks
title: Restrict Shared VPC Subnetworks
sidebar_label: Restrict Shared VPC Subnetworks
---

### More Info:

Ensure that "Restrict Shared VPC Subnetworks" policy is enforced for your GCP organizations.

### Risk Level

Medium

### Address

Security, Operational Maturity

### Compliance Standards

CBP


<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the Google Cloud Console: Open your web browser, navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud account credentials.

2. Select your project: From the project drop-down (My First Project), select the project that contains the resources you want to inspect for misconfigurations.

3. Navigate to IAM & Admin: On the left side navigation menu, click on "IAM & Admin". This will open the Identity and Access Management (IAM) page for your project.

4. Check the IAM policies: On the IAM page, you can see a list of all the IAM policies associated with your project. Look for any policies that have the role "Compute Network User" and check if they are associated with any service accounts. If a service account has this role, it means that it has permissions to use resources from the Shared VPC, which could be a potential misconfiguration if the service account is not supposed to have these permissions.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your GCP account using the following command. This will open a new window in your web browser asking you to log in to your Google Cloud account.
   ```
   gcloud auth login
   ```

3. Set your project ID to the project you want to check. Replace `your-project-id` with your actual project ID.
   ```
   gcloud config set project your-project-id
   ```

4. Run the following command to list all the IAM policies for your project. This will return a JSON object containing all the IAM policies. You can then manually check if the "compute.subnetworks.use" permission is restricted to the necessary service accounts.
   ```
   gcloud projects get-iam-policy your-project-id
   ```
   If the "compute.subnetworks.use" permission is not restricted, it means that the Shared VPC Subnetworks are not restricted in IAM, which is a misconfiguration.

#### Using Python

To check for the restriction of Shared VPC Subnetworks in IAM using Python scripts, you can use the Google Cloud SDK (gcloud) or Google Cloud Client Libraries. Here are the steps:

1. **Install Google Cloud SDK and Python Client Libraries:**
   First, you need to install the Google Cloud SDK and Python Client Libraries on your local machine. You can do this by following the instructions provided in the official Google Cloud documentation.

   ```bash
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
   ```

2. **Authenticate your SDK:**
   Use the `gcloud auth application-default login` command to authenticate your SDK. This command will open a new browser window for you to log in to your Google account. After logging in, your SDK will be authenticated.

   ```bash
   gcloud auth application-default login
   ```

3. **List all the Shared VPC Subnetworks:**
   Use the `compute networks subnets list` command to list all the Shared VPC Subnetworks. This command will return a list of all the Shared VPC Subnetworks in your project.

   ```python
   from googleapiclient import discovery
   from googleapiclient.errors import HttpError
   from oauth2client.client import GoogleCredentials

   credentials = GoogleCredentials.get_application_default()
   service = discovery.build('compute', 'v1', credentials=credentials)

   request = service.subnetworks().list(project='my-project', region='us-central1')
   response = request.execute()

   for subnet in response['items']:
       print(subnet['name'])
   ```

4. **Check the IAM policies for each Shared VPC Subnetwork:**
   For each Shared VPC Subnetwork, use the `compute networks subnets getIamPolicy` command to get the IAM policy. If the IAM policy allows all users to access the Shared VPC Subnetwork, then it is a misconfiguration.

   ```python
   for subnet in response['items']:
       request = service.subnetworks().getIamPolicy(project='my-project', region='us-central1', resource=subnet['name'])
       policy = request.execute()

       for binding in policy['bindings']:
           if 'allUsers' in binding['members']:
               print(f"Misconfiguration detected: {subnet['name']} is accessible by all users.")
   ```

This script will print the names of all Shared VPC Subnetworks that are accessible by all users, indicating a misconfiguration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Restrict Shared VPC Subnetworks" misconfiguration in GCP using GCP console, you can follow these steps:

1. Open the GCP console and go to the VPC network page.
2. Select the shared VPC network for which you want to restrict subnetworks.
3. In the "Subnetworks" section, click on the "Edit" button.
4. In the "Subnetworks" dialog box, uncheck the "Allow new subnetworks in this VPC network" option.
5. Click on the "Save" button to apply the changes.

By following these steps, you have successfully restricted the creation of new subnetworks in the shared VPC network, which will help in preventing unauthorized access and potential security threats.

#### Using CLI

To remediate the misconfiguration of "Restrict Shared VPC Subnetworks" in GCP using GCP CLI, you can follow the below steps:

Step 1: Open the Cloud Shell

Step 2: Run the below command to list all the subnetworks in the shared VPC:

```
gcloud compute shared-vpc list-associated-resources [SHARED_VPC_NAME] --project=[HOST_PROJECT_ID] --subnet
```
Note: Replace [SHARED_VPC_NAME] and [HOST_PROJECT_ID] with the actual shared VPC name and host project ID.

Step 3: Run the below command to restrict the subnetworks in the shared VPC:

```
gcloud compute shared-vpc update [SHARED_VPC_NAME] --project=[HOST_PROJECT_ID] --no-enable-flow-logs --no-enable-private-google-access --no-enable-intra-host-mtls --no-enable-intra-host-visibility --no-enable-routes-without-logs --no-enable-vpc-flow-logs --no-enable-private-endpoint
```
Note: Replace [SHARED_VPC_NAME] and [HOST_PROJECT_ID] with the actual shared VPC name and host project ID.

This command will disable all the shared VPC features which can be enabled on subnetworks. 

Step 4: Run the below command to verify the changes:

```
gcloud compute shared-vpc describe [SHARED_VPC_NAME] --project=[HOST_PROJECT_ID]
```
Note: Replace [SHARED_VPC_NAME] and [HOST_PROJECT_ID] with the actual shared VPC name and host project ID.

This command will display the details of the shared VPC and confirm that the subnetworks are restricted.

By following these steps, you can remediate the misconfiguration of "Restrict Shared VPC Subnetworks" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of "Restrict Shared VPC Subnetworks" for GCP using Python, follow the below steps:

1. First, you need to create a service account and download the JSON key for authentication.

2. Install the Google Cloud SDK and the necessary Python libraries.

3. Use the following Python code to remediate the misconfiguration:

```python
from google.cloud import compute_v1

# Authenticate using the service account key
client = compute_v1.SubnetworksClient.from_service_account_json('path/to/service_account_key.json')

# Set the project ID and the name of the subnetwork to restrict
project_id = 'your_project_id'
subnetwork_name = 'your_subnetwork_name'

# Get the subnetwork
subnetwork = client.get(project=project_id, region='global', subnetwork=subnetwork_name)

# Set the private IP Google access to "false"
subnetwork.private_ip_google_access = False

# Update the subnetwork
response = client.update(project=project_id, region='global', subnetwork=subnetwork_name, subnetwork_resource=subnetwork)
print('Subnetwork updated:', response)
```

This code will set the "private_ip_google_access" property of the subnetwork to "false", which will restrict shared VPC subnetworks. 

Note: Make sure to replace the "path/to/service_account_key.json", "your_project_id", and "your_subnetwork_name" with the actual values.




</Tab>
</Tabs>