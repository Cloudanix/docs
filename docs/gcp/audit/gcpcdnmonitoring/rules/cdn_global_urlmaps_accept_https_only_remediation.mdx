

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account credentials.

2. Navigate to Cloud CDN: From the main navigation menu, click on "Networking" and then select "Cloud CDN". This will take you to the Cloud CDN dashboard where you can view all your CDN resources.

3. Check Urlmaps settings: In the Cloud CDN dashboard, locate the Urlmaps section. Here, you will find a list of all your Urlmaps. Click on the name of the Urlmap you want to inspect to open its settings.

4. Inspect HTTPS settings: In the Urlmap settings, look for the "HTTPS" section. If the "Accept HTTPS connections only" option is not enabled, then the Urlmap is misconfigured and is accepting HTTP connections. This is a security risk as HTTP connections are not encrypted and can be intercepted by malicious actors.

#### Using CLI

1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your CLI with your GCP account using the following command:
   ```
   gcloud auth login
   ```
   Follow the instructions and log in with your GCP account credentials.

3. List all the URL maps in your project using the following command:
   ```
   gcloud compute url-maps list
   ```
   This command will return a list of all URL maps in your project.

4. For each URL map, check the protocol used by the backend services. You can do this using the following command:
   ```
   gcloud compute url-maps describe [URL_MAP_NAME]
   ```
   Replace `[URL_MAP_NAME]` with the name of your URL map. This command will return a description of the URL map, including the backend services and their protocols. If any of the backend services use the HTTP protocol, then the URL map does not accept HTTPS connections only.

#### Using Python

1. Install Google Cloud SDK and Python Client for Google Cloud CDN: Before you start, make sure you have installed Google Cloud SDK and authenticated it with your GCP account. Also, install the Python client for Google Cloud CDN using pip:

   ```
   pip install --upgrade google-cloud-cdn
   ```

2. Import Required Libraries: Import the necessary libraries in your Python script:

   ```python
   from google.cloud import cdn
   ```

3. Initialize CDN Client: Initialize the CDN client in your Python script:

   ```python
   client = cdn.CdnServiceClient()
   ```

4. Check for Https Connections: Now, iterate over all the Urlmaps in your CDN and check if they accept HTTPS connections only. If any Urlmap is found that accepts HTTP connections, print it:

   ```python
   for urlmap in client.list_url_maps(project='your-project-id', location='global'):
       if urlmap.default_service is not None:
           if 'https' not in urlmap.default_service:
               print(f"Urlmap {urlmap.name} accepts HTTP connections.")
   ```

   This script will print all the Urlmaps that accept HTTP connections. If no such Urlmap is found, it means all your Urlmaps accept HTTPS connections only.

Please note that the Python Client for Google Cloud CDN is currently in alpha and its interface might change in the future. Also, replace 'your-project-id' with your actual GCP project ID.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate this misconfiguration for GCP using the GCP console, follow these steps:

1. Open the GCP console and navigate to the Cloud CDN page.
2. Select the Global URL Maps tab.
3. Click on the name of the URL map that you want to modify.
4. Click on the Edit button at the top of the page.
5. In the Edit URL map page, scroll down to the Host and Path Rules section.
6. Click on the Add Host and Path Rule button.
7. In the new rule, set the Host to "*" to match all hosts.
8. Set the Path to "/*" to match all paths.
9. Set the Backend service to the appropriate backend service for your application.
10. Under the Protocol section, select HTTPS from the dropdown menu.
11. Click on the Save button to save the changes.

Once you have completed these steps, your Global URL Map will only accept HTTPS connections. Any HTTP connections will be rejected.

#### Using CLI

To remediate the misconfiguration of Cloud CDN Global Urlmaps accepting only HTTPS connections in GCP using GCP CLI, follow the below steps:

Step 1: Open the Google Cloud Console and select the project where the Cloud CDN is configured.

Step 2: Open the Cloud Shell by clicking on the icon in the top right corner of the console.

Step 3: Run the following command to list all the existing URL maps in the project:

```
gcloud compute url-maps list
```

Step 4: Identify the URL map that needs to be remediated.

Step 5: Run the following command to update the URL map to accept only HTTPS connections:

```
gcloud compute url-maps update [URL_MAP_NAME] --default-service [BACKEND_SERVICE_NAME] --ssl-policy=global-ssl-policy
```

Replace [URL_MAP_NAME] with the name of the URL map that needs to be updated and [BACKEND_SERVICE_NAME] with the name of the backend service associated with the URL map.

Step 6: Verify that the URL map has been updated successfully by running the following command:

```
gcloud compute url-maps describe [URL_MAP_NAME]
```

This command should return the updated URL map configuration, which should include the "sslPolicy" field set to "global-ssl-policy".

By following these steps, you can remediate the misconfiguration of Cloud CDN Global Urlmaps accepting only HTTPS connections in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Cloud CDN Global Urlmaps Should Accept Https Connections Only" for GCP using Python, you can follow the below steps:

1. Install the required packages:

```python
!pip install google-cloud-cdn
!pip install google-auth google-auth-oauthlib google-auth-httplib2
```

2. Authenticate with GCP:

```python
from google.oauth2 import service_account
from google.cloud import cdn_v1beta1

credentials = service_account.Credentials.from_service_account_file('path/to/service_account.json')
client = cdn_v1beta1.GlobalForwardingRulesClient(credentials=credentials)
```

3. Get the list of existing global URL maps:

```python
project_id = 'your-project-id'
location = 'global'

parent = f'projects/{project_id}/locations/{location}'
url_maps = client.list_url_maps(parent=parent)
```

4. For each URL map, check if it has an HTTPS forwarding rule:

```python
for url_map in url_maps:
    https_forwarding_rule = None
    for forwarding_rule in url_map.host_rules[0].path_matchers[0].route_rules[0].forward_action.https_redirect.action:
        if forwarding_rule.https_redirect:
            https_forwarding_rule = forwarding_rule
            break
    if not https_forwarding_rule:
        print(f'URL map "{url_map.name}" does not have an HTTPS forwarding rule')
```

5. If a URL map does not have an HTTPS forwarding rule, update it:

```python
for url_map in url_maps:
    https_forwarding_rule = None
    for forwarding_rule in url_map.host_rules[0].path_matchers[0].route_rules[0].forward_action.https_redirect.action:
        if forwarding_rule.https_redirect:
            https_forwarding_rule = forwarding_rule
            break
    if not https_forwarding_rule:
        url_map.host_rules[0].path_matchers[0].route_rules[0].forward_action.https_redirect.action.append(
                cdn_v1beta1.HttpsRedirectAction())
        client.update_url_map(url_map=url_map, update_mask=['host_rules.path_matchers.route_rules.forward_action.https_redirect.action'])
        print(f'URL map "{url_map.name}" has been updated to only accept HTTPS connections')
```

By following these steps, you can remediate the misconfiguration "Cloud CDN Global Urlmaps Should Accept Https Connections Only" for GCP using Python.


</Tab>
</Tabs>