---
slug: cdn_regional_backend_services_have_session_affinity
title: Cloud CDN Regional Backend Services Should Have Session Affinity
sidebar_label: Cloud CDN Regional Backend Services Should Have Session Affinity
---

### More Info:

Cloud CDN regional backend services should have session affinity enabled.

### Risk Level

Medium

### Address

Operational Maturity, Performance Efficiency, Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Google Cloud Console: Open your web browser, navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud credentials.

2. Navigate to Cloud CDN: From the main dashboard, click on the navigation menu (three horizontal lines in the upper left-hand corner), scroll down and click on "Network Services", then select "Cloud CDN".

3. Check Backend Services: In the Cloud CDN page, click on the "Backend services" tab. This will display a list of all the backend services associated with your Cloud CDN.

4. Check Session Affinity: For each backend service, click on its name to view its details. In the details page, look for the "Session affinity" field. If the value is set to "None", it means that the backend service does not have session affinity enabled.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (Software Development Kit) on your local machine. This SDK includes the GCP (Google Cloud Platform) CLI (Command Line Interface) tool `gcloud` which is used to interact with your GCP resources.

2. Once the SDK is installed and configured, open your terminal or command prompt and run the following command to list all the backend services in your GCP project:

   ```
   gcloud compute backend-services list --global
   ```

   This command will return a list of all the global backend services in your GCP project.

3. To check the session affinity for a specific backend service, use the following command:

   ```
   gcloud compute backend-services describe [BACKEND_SERVICE_NAME] --global
   ```

   Replace `[BACKEND_SERVICE_NAME]` with the name of the backend service you want to check. This command will return a detailed description of the specified backend service, including its session affinity setting.

4. Look for the `sessionAffinity` field in the output. If the value of this field is `NONE`, it means that the backend service does not have session affinity enabled. If the value is `CLIENT_IP` or `CLIENT_IP_PROTO`, it means that the backend service has session affinity enabled.

#### Using Python

1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. The Google Cloud SDK and Google Auth libraries are required for this task. You can install them using pip:

```python
pip install google-cloud-sdk
pip install google-auth
```

2. Import the necessary libraries and authenticate: After installing the necessary libraries, you need to import them into your Python script. You also need to authenticate your script with your Google Cloud account. Here's how you can do it:

```python
from google.cloud import storage
from google.auth import compute_engine

# Authenticate with Google Cloud
credentials = compute_engine.Credentials()
```

3. Get the list of backend services: Now, you need to get the list of all backend services in your Google Cloud account. You can do this using the `list()` method of the `BackendService` class:

```python
# Create a client for the storage service
client = storage.Client(credentials=credentials)

# Get the list of backend services
backend_services = client.list_backend_services()
```

4. Check the session affinity of each backend service: Finally, you need to check the session affinity of each backend service. If the session affinity is not set to `CLIENT_IP`, then the backend service is misconfigured:

```python
# Check the session affinity of each backend service
for backend_service in backend_services:
    if backend_service.session_affinity != 'CLIENT_IP':
        print(f"Backend service {backend_service.name} is misconfigured.")
```

This script will print the names of all backend services that are misconfigured.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of "Cloud CDN Regional Backend Services Should Have Session Affinity" for GCP using GCP console, follow the below steps:

1. Open the Google Cloud Console and navigate to the Cloud CDN page.

2. In the left-hand navigation menu, select "Backend Services".

3. Select the Backend Service that you want to configure session affinity for.

4. Click on the "Edit" button at the top of the page to edit the Backend Service.

5. Scroll down to the "Session Affinity" section and select "Client IP" from the dropdown menu.

6. Click on the "Save" button at the bottom of the page to save the changes.

7. Verify the configuration by checking the "Session Affinity" column in the list of Backend Services. It should now show "Client IP".

By following the above steps, you have successfully remediated the misconfiguration of "Cloud CDN Regional Backend Services Should Have Session Affinity" for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Cloud CDN Regional Backend Services Should Have Session Affinity" in GCP using GCP CLI, please follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to list all the backend services:

   ```
   gcloud compute backend-services list
   ```

3. Choose the backend service that you want to enable session affinity for and note down its name.

4. Run the following command to enable session affinity for the chosen backend service:

   ```
   gcloud compute backend-services update [BACKEND_SERVICE_NAME] --session-affinity CLIENT_IP
   ```

   Note: Replace [BACKEND_SERVICE_NAME] with the name of your backend service.

5. Verify that session affinity is enabled for the backend service by running the following command:

   ```
   gcloud compute backend-services describe [BACKEND_SERVICE_NAME] | grep sessionAffinity
   ```

   The output should show "sessionAffinity: CLIENT_IP".

   With these steps, you have successfully remediated the misconfiguration "Cloud CDN Regional Backend Services Should Have Session Affinity" in GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of Cloud CDN Regional Backend Services Should Have Session Affinity for GCP using Python, you can follow the below steps:

1. Open the Cloud Console and go to the Cloud CDN page.
2. Select the CDN resource that you want to remediate.
3. In the left navigation menu, select the Backend services option.
4. Select the backend service that you want to remediate.
5. In the left navigation menu, select the Session affinity option.
6. Select the option Enable session affinity.
7. Click Save to apply the changes.

To perform these steps programmatically using Python, you can use the Google Cloud Client Library for Python. Here's an example code snippet:

```python
from google.cloud import compute_v1

# Replace [PROJECT_ID], [REGION], and [BACKEND_SERVICE_NAME] with the appropriate values
project_id = '[PROJECT_ID]'
region = '[REGION]'
backend_service_name = '[BACKEND_SERVICE_NAME]'

# Create the client object
client = compute_v1.BackendServicesClient()

# Get the backend service object
backend_service = client.get(project=project_id, region=region, backend_service=backend_service_name)

# Enable session affinity
backend_service.session_affinity = compute_v1.BackendServiceSessionAffinity.CLIENT_IP

# Update the backend service
update_mask = compute_v1.field_mask.FieldMask(paths=['session_affinity'])
response = client.update(project=project_id, region=region, backend_service=backend_service_name, backend_service_resource=backend_service, update_mask=update_mask)
```

This code snippet uses the Google Cloud Client Library for Python to get the backend service object, enable session affinity, and update the backend service. Replace the placeholders [PROJECT_ID], [REGION], and [BACKEND_SERVICE_NAME] with the appropriate values for your environment.


### Additional Reading:

- [https://cloud.google.com/load-balancing/docs/backend-service#session_affinity](https://cloud.google.com/load-balancing/docs/backend-service#session_affinity) 


</Tab>
</Tabs>