---
slug: cdn_regional_backend_services_have_session_affinity
title: Cloud CDN Regional Backend Services Should Have Session Affinity
sidebar_label: Cloud CDN Regional Backend Services Should Have Session Affinity
---

### More Info:

Cloud CDN regional backend services should have session affinity enabled.

### Risk Level

Medium

### Address

Operational Maturity, Performance Efficiency, Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Login to Google Cloud Console: Open your web browser, navigate to the Google Cloud Console (console.cloud.google.com) and sign in with your Google Cloud credentials.

2. Navigation to Cloud CDN: From the main dashboard, click on the navigation menu (three horizontal lines in the upper left-hand corner). Scroll down and click on "Network Services" and then select "Cloud CDN".

3. Check Backend Services: In the Cloud CDN page, you will see a list of your CDN configurations. Click on the name of the CDN configuration you want to check. This will take you to the details page of the CDN configuration. Here, under the "Backend services & backend buckets" section, you can see the backend services associated with the CDN.

4. Check Session Affinity: Click on the name of the backend service to go to its details page. Here, under the "Session affinity" section, you can see the type of session affinity configured for the backend service. If it is set to "None", then the backend service does not have session affinity configured.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure the Google Cloud SDK (Software Development Kit) on your local machine. This SDK includes the GCP (Google Cloud Platform) CLI (Command Line Interface) tool `gcloud` which allows you to manage resources on Google Cloud.

2. Once the SDK is installed and configured, open your terminal or command prompt and run the following command to list all the backend services in your project:

   ```
   gcloud compute backend-services list
   ```
   This command will return a list of all backend services along with their details.

3. To check the session affinity for each backend service, you need to describe each backend service individually. You can do this by running the following command:

   ```
   gcloud compute backend-services describe [BACKEND_SERVICE_NAME]
   ```
   Replace `[BACKEND_SERVICE_NAME]` with the name of your backend service. This command will return a detailed description of the backend service including the session affinity.

4. Look for the `sessionAffinity` field in the output. If the value of this field is not `CLIENT_IP` or `GENERATED_COOKIE`, then the backend service does not have session affinity enabled.
</Accordion>

<Accordion title='Using Python'>
1. Install Google Cloud SDK and Python Client for Google Cloud CDN: Before you start, make sure you have installed Google Cloud SDK and Python Client for Google Cloud CDN. You can install the Python client using pip:

   ```bash
   pip install --upgrade google-cloud-cdn
   ```

2. Authenticate with Google Cloud: Use the `gcloud auth application-default login` command to get your credentials for the application:

   ```bash
   gcloud auth application-default login
   ```

3. Write a Python script to list all the backend services and check their session affinity:

   ```python
   from google.cloud import compute_v1

   def list_backend_services():
       client = compute_v1.BackendServicesClient()
       project = '[PROJECT_ID]'  # replace with your project ID

       # List all backend services
       response = client.list(project=project)

       for backend_service in response:
           print(f"Backend Service: {backend_service.name}")
           print(f"Session Affinity: {backend_service.session_affinity}")
           if backend_service.session_affinity != 'GENERATED_COOKIE':
               print(f"Warning: {backend_service.name} does not have session affinity set to GENERATED_COOKIE")

   if __name__ == "__main__":
       list_backend_services()
   ```

   Replace '[PROJECT_ID]' with your actual project ID. This script will list all the backend services in your project and print a warning message for those services that do not have session affinity set to 'GENERATED_COOKIE'.

4. Run the Python script: Save the script to a file, for example `check_session_affinity.py`, and run it using Python:

   ```bash
   python check_session_affinity.py
   ```

   The script will print the name and session affinity of each backend service, and a warning message for those services that do not have the correct session affinity setting.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of "Cloud CDN Regional Backend Services Should Have Session Affinity" for GCP using GCP console, follow the below steps:

1. Open the Google Cloud Console and navigate to the Cloud CDN page.

2. In the left-hand navigation menu, select "Backend Services".

3. Select the Backend Service that you want to configure session affinity for.

4. Click on the "Edit" button at the top of the page to edit the Backend Service.

5. Scroll down to the "Session Affinity" section and select "Client IP" from the dropdown menu.

6. Click on the "Save" button at the bottom of the page to save the changes.

7. Verify the configuration by checking the "Session Affinity" column in the list of Backend Services. It should now show "Client IP".

By following the above steps, you have successfully remediated the misconfiguration of "Cloud CDN Regional Backend Services Should Have Session Affinity" for GCP using GCP console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Cloud CDN Regional Backend Services Should Have Session Affinity" in GCP using GCP CLI, please follow the below steps:

1. Open the Cloud Shell in your GCP console.

2. Run the following command to list all the backend services:

   ```
   gcloud compute backend-services list
   ```

3. Choose the backend service that you want to enable session affinity for and note down its name.

4. Run the following command to enable session affinity for the chosen backend service:

   ```
   gcloud compute backend-services update [BACKEND_SERVICE_NAME] --session-affinity CLIENT_IP
   ```

   Note: Replace [BACKEND_SERVICE_NAME] with the name of your backend service.

5. Verify that session affinity is enabled for the backend service by running the following command:

   ```
   gcloud compute backend-services describe [BACKEND_SERVICE_NAME] | grep sessionAffinity
   ```

   The output should show "sessionAffinity: CLIENT_IP".

   With these steps, you have successfully remediated the misconfiguration "Cloud CDN Regional Backend Services Should Have Session Affinity" in GCP using GCP CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of Cloud CDN Regional Backend Services Should Have Session Affinity for GCP using Python, you can follow the below steps:

1. Open the Cloud Console and go to the Cloud CDN page.
2. Select the CDN resource that you want to remediate.
3. In the left navigation menu, select the Backend services option.
4. Select the backend service that you want to remediate.
5. In the left navigation menu, select the Session affinity option.
6. Select the option Enable session affinity.
7. Click Save to apply the changes.

To perform these steps programmatically using Python, you can use the Google Cloud Client Library for Python. Here's an example code snippet:

```python
from google.cloud import compute_v1

# Replace [PROJECT_ID], [REGION], and [BACKEND_SERVICE_NAME] with the appropriate values
project_id = '[PROJECT_ID]'
region = '[REGION]'
backend_service_name = '[BACKEND_SERVICE_NAME]'

# Create the client object
client = compute_v1.BackendServicesClient()

# Get the backend service object
backend_service = client.get(project=project_id, region=region, backend_service=backend_service_name)

# Enable session affinity
backend_service.session_affinity = compute_v1.BackendServiceSessionAffinity.CLIENT_IP

# Update the backend service
update_mask = compute_v1.field_mask.FieldMask(paths=['session_affinity'])
response = client.update(project=project_id, region=region, backend_service=backend_service_name, backend_service_resource=backend_service, update_mask=update_mask)
```

This code snippet uses the Google Cloud Client Library for Python to get the backend service object, enable session affinity, and update the backend service. Replace the placeholders [PROJECT_ID], [REGION], and [BACKEND_SERVICE_NAME] with the appropriate values for your environment.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://cloud.google.com/load-balancing/docs/backend-service#session_affinity](https://cloud.google.com/load-balancing/docs/backend-service#session_affinity) 

