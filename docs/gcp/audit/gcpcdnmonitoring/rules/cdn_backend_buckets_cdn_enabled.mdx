---
slug: cdn_backend_buckets_cdn_enabled
title: Cloud CDN Backend Buckets CDN Should Be Enabled
sidebar_label: Cloud CDN Backend Buckets CDN Should Be Enabled
---

### More Info:

Ensure Cloud CDN backend buckets have CDN enabled.

### Risk Level

High

### Address

Operational Maturity, Performance Efficiency, Reliability, Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform Console (console.cloud.google.com), and sign in with your Google account credentials.

2. Navigate to Cloud Storage: From the main dashboard, click on the navigation menu (three horizontal lines in the upper left-hand corner), scroll down and click on "Storage" under the "Storage" section. This will take you to the Cloud Storage browser.

3. Check Backend Buckets: In the Cloud Storage browser, you will see a list of all your storage buckets. Click on the name of the bucket you want to check. This will take you to the bucket details page.

4. Check CDN Settings: In the bucket details page, click on the "Edit" button next to "Cloud CDN". If the checkbox next to "Enable Cloud CDN" is checked, then Cloud CDN is enabled for this bucket. If it is not checked, then Cloud CDN is not enabled.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your GCP account using the following command. This will open a new window in your web browser asking you to log in to your Google Cloud account.
   ```
   gcloud auth login
   ```

3. Set your project ID to the project you want to check. Replace 'your-project-id' with the ID of your project.
   ```
   gcloud config set project your-project-id
   ```

4. Run the following command to list all the backend buckets and check if Cloud CDN is enabled or not. If the "enableCdn" field is set to "false", then Cloud CDN is not enabled for that backend bucket.
   ```
   gcloud compute backend-buckets describe bucket-name
   ```
   Replace 'bucket-name' with the name of your backend bucket. Repeat this step for each backend bucket in your project.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: To interact with Google Cloud Platform (GCP), you need to install the Google Cloud SDK and the Python client library. You can install these using pip:

   ```bash
   pip install --upgrade google-cloud-storage
   pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
   ```

2. Authenticate your SDK: Before you can interact with GCP, you need to authenticate your SDK. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key JSON file.

   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your/service-account-file.json"
   ```

3. Write a Python script to check the CDN configuration: The following script retrieves all backend buckets and checks if the `enableCdn` property is set to `True`.

   ```python
   from google.cloud import storage

   def check_cdn_enabled():
       client = storage.Client()
       buckets = client.list_buckets()

       for bucket in buckets:
           bucket_metadata = client.get_bucket(bucket.name)
           if not bucket_metadata.cdn_policy:
               print(f"CDN is not enabled for bucket: {bucket.name}")
           else:
               print(f"CDN is enabled for bucket: {bucket.name}")

   if __name__ == "__main__":
       check_cdn_enabled()
   ```

4. Run the script: You can run the script using the Python interpreter. The script will print out the names of all buckets and whether or not CDN is enabled for each one.

   ```bash
   python check_cdn_enabled.py
   ```
   
Please note that this script only checks if CDN is enabled or not. It does not remediate any misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "Cloud CDN Backend Buckets CDN Should Be Enabled" in GCP, you can follow the below steps using GCP Console:

1. Open the GCP Console and navigate to the Cloud Storage page.
2. Click on the name of the bucket that you want to enable for Cloud CDN.
3. Click on the "Edit bucket details" button at the top of the page.
4. Scroll down to the "Cloud CDN" section and click on the "Enable Cloud CDN" checkbox.
5. Click on the "Save" button at the bottom of the page to save the changes.

Once you have enabled Cloud CDN for the backend bucket, you can verify the configuration by checking the Cloud CDN page in the GCP Console. The backend bucket should now be listed as a resource in the Cloud CDN page.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Cloud CDN Backend Buckets CDN Should Be Enabled" for GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP console.
2. Run the following command to enable the Cloud CDN API:

   ```
   gcloud services enable cdn.googleapis.com
   ```

3. Run the following command to create a Cloud Storage bucket:

   ```
   gsutil mb -c standard -l <location> gs://<bucket-name>
   ```
   Replace `<location>` with the location where you want to create the bucket (e.g. us-central1) and `<bucket-name>` with the name of your bucket.

4. Run the following command to enable the Cloud CDN for the bucket:

   ```
   gsutil web set -m index.html -e 404.html gs://<bucket-name>
   ```

   This command sets up the bucket as a static website and enables the Cloud CDN for it.

5. Verify that the Cloud CDN is enabled for the bucket by running the following command:

   ```
   gcloud compute backend-buckets describe <backend-bucket-name>
   ```

   Replace `<backend-bucket-name>` with the name of your backend bucket. Look for the `cdnPolicy` field in the output. It should show `"cacheMode": "CACHE_ALL_STATIC"` which confirms that the Cloud CDN is enabled for the bucket.

6. Repeat steps 3-5 for each backend bucket that needs the Cloud CDN enabled.

By following these steps, you have successfully remediated the misconfiguration "Cloud CDN Backend Buckets CDN Should Be Enabled" for GCP using GCP CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "Cloud CDN Backend Buckets CDN Should Be Enabled" in GCP using Python, you can follow these steps:

1. Import the necessary libraries:

```python
from google.cloud import compute_v1
from google.protobuf.field_mask_pb2 import FieldMask
```

2. Set up the GCP credentials:

```python
# Replace [PATH_TO_YOUR_CREDENTIALS_JSON] with the path to your GCP credentials JSON file.
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "[PATH_TO_YOUR_CREDENTIALS_JSON]"
```

3. Initialize the Compute Engine client:

```python
client = compute_v1.ComputeClient()
```

4. Get the current configuration of the backend bucket:

```python
# Replace [BACKEND_BUCKET_NAME] with the name of the backend bucket.
backend_bucket_name = "[BACKEND_BUCKET_NAME]"
backend_bucket = client.backend_buckets.get(project="[PROJECT_ID]", backend_bucket=backend_bucket_name)
```

5. Update the configuration to enable CDN:

```python
# Set the CDN configuration.
backend_bucket.cdn_policy.cache_key_policy.include_host = True
backend_bucket.cdn_policy.cache_mode = compute_v1.BackendBucketCdnPolicy.CacheMode.CACHE_ALL_STATIC
backend_bucket.cdn_policy.signed_url_key_names.append("my-key-name")

# Update the backend bucket.
update_mask = FieldMask(paths=["cdn_policy"])
updated_backend_bucket = client.backend_buckets.update(project="[PROJECT_ID]", backend_bucket=backend_bucket_name, backend_bucket_resource=backend_bucket, update_mask=update_mask)
```

6. Verify that CDN is enabled:

```python
print(updated_backend_bucket.cdn_policy.cache_mode)
```

This should output "CACHE_ALL_STATIC", indicating that CDN is enabled for the backend bucket.

Note: You will need to replace [PROJECT_ID], [BACKEND_BUCKET_NAME], and "my-key-name" with the appropriate values for your GCP project and backend bucket.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://cloud.google.com/cdn/docs/using-cdn](https://cloud.google.com/cdn/docs/using-cdn) 

