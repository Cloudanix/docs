---
slug: cdn_backend_buckets_cache_static_content
title: Cloud CDN Backend Buckets Should Cache Only Static Content
sidebar_label: Cloud CDN Backend Buckets Should Cache Only Static Content
---

### More Info:

Ensure Cloud CDN backend buckets cache only static content for better caching performance.

### Risk Level

Medium

### Address

Operational Maturity, Reliability, Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Login to Google Cloud Console: First, you need to log in to your Google Cloud Console. Make sure you have the necessary permissions to access and manage Cloud CDN and backend services.

2. Navigation to Cloud CDN: From the main dashboard of the Google Cloud Console, navigate to the "Networking" section. Under the "Networking" section, click on "Network Services" and then select "Cloud CDN".

3. Check Backend Services: In the Cloud CDN page, you will see a list of all your CDN configurations. Click on the name of the CDN configuration you want to check. This will take you to the "Backend services" page.

4. Inspect Cache Settings: In the "Backend services" page, look for the "Cache modes" section. This section will tell you what kind of content is being cached by your CDN. If it's set to "Cache static content", then your CDN is correctly configured to cache only static content. If it's set to "Cache dynamic content", then your CDN is misconfigured and is caching dynamic content as well.

#### Using CLI

1. First, you need to install and configure the Google Cloud SDK (gcloud) on your local machine. You can download it from the official Google Cloud website and follow the instructions to install it. Once installed, authenticate your account using the command: 
```
gcloud auth login
```

2. List all the backend buckets in your project using the following command:
```
gcloud compute backend-buckets list
```
This command will return a list of all backend buckets in your project. 

3. For each backend bucket, you can check its caching mode using the following command:
```
gcloud compute backend-buckets describe [BACKEND_BUCKET_NAME]
```
Replace [BACKEND_BUCKET_NAME] with the name of your backend bucket. This command will return a description of the backend bucket, including its caching mode.

4. Check the "enableCdn" field in the output. If it's set to true, it means that the backend bucket is using Cloud CDN. Then, check the "cdnPolicy" field. If the "cacheMode" is not set to "CACHE_ALL_STATIC" or if the "defaultTtl" or "maxTtl" values are too high, it means that the backend bucket is not properly configured to cache only static content.

#### Using Python

1. **Import necessary libraries and set up the environment:**

    First, you need to import the necessary libraries in your Python script. You will need the `googleapiclient` library to interact with Google Cloud Platform (GCP). If you haven't installed it yet, you can do so using pip: `pip install google-api-python-client`. Then, set up the environment for GCP in your Python script.

    ```python
    from googleapiclient import discovery
    from oauth2client.client import GoogleCredentials
    ```

2. **Authenticate and create a service client:**

    Next, authenticate your script with GCP using the credentials of the account. Then, create a service client for Cloud CDN.

    ```python
    credentials = GoogleCredentials.get_application_default()
    service = discovery.build('compute', 'v1', credentials=credentials)
    ```

3. **List all backend buckets:**

    Now, list all the backend buckets in your GCP project. You can do this by calling the `backendBuckets().list()` method on the service client.

    ```python
    project = 'your_project_id'  # replace with your project id
    request = service.backendBuckets().list(project=project)
    ```

4. **Check the cache policy of each backend bucket:**

    Finally, iterate over each backend bucket and check its cache policy. If the `enableCdn` field is set to `True` and the `cacheMode` field is not set to `CACHE_ALL_STATIC`, then the backend bucket is misconfigured.

    ```python
    while request is not None:
        response = request.execute()

        for backend_bucket in response['items']:
            if 'enableCdn' in backend_bucket and backend_bucket['enableCdn']:
                if 'cdnPolicy' in backend_bucket and 'cacheMode' in backend_bucket['cdnPolicy']:
                    if backend_bucket['cdnPolicy']['cacheMode'] != 'CACHE_ALL_STATIC':
                        print(f"Backend bucket {backend_bucket['name']} is misconfigured.")

        request = service.backendBuckets().list_next(previous_request=request, previous_response=response)
    ```
    This script will print the names of all backend buckets that are misconfigured.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the issue of Cloud CDN Backend Buckets caching only static content in GCP using GCP Console:

1. Open the GCP Console and navigate to the Cloud Storage section.
2. Click on the checkbox next to the name of the bucket that you want to configure.
3. Click on the "Edit bucket permissions" button at the top of the page.
4. Under the "Bucket Policy Only" section, click on the "Add members" button.
5. In the "New members" field, enter the email address of the service account that you want to use for your Cloud CDN backend bucket.
6. In the "Select a role" drop-down menu, select "Storage Object Viewer".
7. Click on the "Add" button to add the service account to the bucket's IAM policy.
8. Navigate to the Cloud CDN section of the GCP Console.
9. Click on the checkbox next to the name of the Cloud CDN backend bucket that you want to configure.
10. Click on the "Edit" button at the top of the page.
11. Under the "Cache settings" section, select the "Cache everything" option.
12. Under the "Cache control" section, select the "Override" option.
13. Under the "Static content caching" section, select the "Custom" option.
14. In the "Static content caching" field, enter the file extensions for the static content that you want to cache (e.g., .html, .css, .js, .jpg, .png).
15. Click on the "Save" button to save the changes.

After following these steps, your Cloud CDN backend bucket will cache only static content as required.

#### Using CLI

To remediate the misconfiguration "Cloud CDN Backend Buckets Should Cache Only Static Content" for GCP using GCP CLI, follow the below steps:

1. Open the GCP console and navigate to the Cloud Storage page.
2. Select the bucket that you want to configure for static content caching.
3. Click on the "Edit bucket permissions" button.
4. In the "Add members" section, add the Cloud CDN service account by typing "cloud-cdn@google.com".
5. Select the "Storage Object Viewer" role from the dropdown list.
6. Click on the "Add" button to save the changes.
7. Open the Cloud CDN page and select the CDN resource that is associated with the bucket.
8. Click on the "Edit" button to open the configuration page.
9. In the "Backend configuration" section, click on the "Edit backend" button.
10. In the "Backend bucket" section, select the bucket that you want to configure for static content caching.
11. Scroll down to the "Cache settings" section and select the "Static content only" option.
12. Click on the "Save" button to apply the changes.

By following these steps, you have successfully remediated the misconfiguration "Cloud CDN Backend Buckets Should Cache Only Static Content" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration "Cloud CDN Backend Buckets Should Cache Only Static Content" for GCP using Python, you can follow the below steps:

Step 1: Install the required Python libraries

```python
!pip install google-cloud-storage google-auth google-auth-oauthlib google-auth-httplib2
```

Step 2: Authenticate to GCP

```python
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('path/to/service_account.json')
```

Step 3: Import the required libraries

```python
from google.cloud import storage
```

Step 4: Create a function to check if an object in the bucket is static or not

```python
def is_static_object(bucket_name, object_name):
    """Check if an object in the bucket is static or not"""
    static_extensions = ['.html', '.css', '.js', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.ico', '.pdf', '.svg', '.woff', '.woff2', '.ttf', '.eot', '.json']
    extension = object_name.split('.')[-1]
    if extension in static_extensions:
        return True
    else:
        return False
```

Step 5: Create a function to update the bucket's default cache control policy

```python
def update_cache_control_policy(bucket_name):
    """Update the bucket's default cache control policy"""
    storage_client = storage.Client(credentials=credentials)
    bucket = storage_client.get_bucket(bucket_name)
    bucket.default_object_acl.loaded = False
    bucket.default_object_acl.save()
    for blob in bucket.list_blobs():
        if is_static_object(bucket_name, blob.name):
            blob.cache_control = 'public, max-age=31536000'
        else:
            blob.cache_control = 'no-cache, no-store, must-revalidate'
        blob.patch()
```

Step 6: Call the function to update the cache control policy for the bucket

```python
update_cache_control_policy('your-bucket-name')
```

Note: Replace 'your-bucket-name' with the name of your GCP bucket.


### Additional Reading:

- [https://cloud.google.com/cdn/docs/caching#cache-modes](https://cloud.google.com/cdn/docs/caching#cache-modes) 


</Tab>
</Tabs>