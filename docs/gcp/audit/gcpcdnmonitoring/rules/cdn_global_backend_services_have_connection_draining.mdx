---
slug: cdn_global_backend_services_have_connection_draining
title: Cloud CDN Global Backend Services Should Have Connection Draining
sidebar_label: Cloud CDN Global Backend Services Should Have Connection Draining
---

### More Info:

Cloud CDN should not send any new requests to the unhealthy instance if an compute instance fails health checks

### Risk Level

Medium

### Address

Reliability, Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access the GCP resources.

2. Navigate to the Load Balancing page: From the GCP Console, click on the Navigation Menu (three horizontal lines in the upper left-hand corner), then scroll down and click on "Network Services", and then select "Load balancing".

3. Check the Backend Services: On the Load balancing page, click on the name of the load balancer that you want to check. Then, click on the "Backend configuration" tab. Here, you will see a list of all the backend services associated with the selected load balancer.

4. Check Connection Draining: For each backend service, check the "Connection Draining Timeout" setting. If the Connection Draining Timeout is set to 0, it means that the backend service does not have connection draining enabled.

#### Using CLI

1. Install and authenticate the Google Cloud SDK: Before you can use the Google Cloud CLI, you need to install it on your local machine and authenticate it with your Google Cloud account. You can download the SDK from the official Google Cloud website and follow the instructions to install it. Once installed, you can authenticate it by running the following command in your terminal:

   ```
   gcloud auth login
   ```

2. Set your project: You need to set the project that you want to check. You can do this by running the following command in your terminal:

   ```
   gcloud config set project [PROJECT_ID]
   ```

   Replace `[PROJECT_ID]` with the ID of your project.

3. List all backend services: You can list all the backend services in your project by running the following command in your terminal:

   ```
   gcloud compute backend-services list
   ```

4. Check the connection draining settings: For each backend service, you can check the connection draining settings by running the following command in your terminal:

   ```
   gcloud compute backend-services describe [BACKEND_SERVICE] --global
   ```

   Replace `[BACKEND_SERVICE]` with the name of your backend service. In the output, look for the `connectionDraining` field. If it's not present or set to `0`, then connection draining is not enabled for that backend service.

#### Using Python

1. Install Google Cloud SDK and Python Client for Google Cloud Compute:
   You need to install the Google Cloud SDK and Python Client for Google Cloud Compute to interact with GCP services. You can install them using pip (Python package installer).

   ```
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-cloud-compute
   ```

2. Authenticate your SDK:
   Use the `gcloud auth application-default login` command to authenticate your SDK. This command will open your web browser for you to log in using your Google account.

3. Write a Python script to list all the backend services:
   You can use the `google.cloud.compute_v1.BackendServicesClient` class to interact with backend services. Here is a sample script to list all the backend services:

   ```python
   from google.cloud import compute_v1

   def list_backend_services():
       client = compute_v1.BackendServicesClient()
       response = client.list(project='your_project_id')
       for backend_service in response:
           print(backend_service)

   list_backend_services()
   ```

4. Check the connection draining policy:
   The `connection_draining` attribute of a backend service object represents its connection draining policy. If this attribute is `None`, it means the backend service does not have a connection draining policy. You can modify the above script to check the connection draining policy:

   ```python
   from google.cloud import compute_v1

   def list_backend_services():
       client = compute_v1.BackendServicesClient()
       response = client.list(project='your_project_id')
       for backend_service in response:
           if backend_service.connection_draining is None:
               print(f"Backend service {backend_service.name} does not have a connection draining policy.")
           else:
               print(f"Backend service {backend_service.name} has a connection draining policy.")

   list_backend_services()
   ```

This script will print the names of all backend services and whether they have a connection draining policy.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Cloud CDN Global Backend Services should have Connection Draining for GCP using GCP console, follow these steps:

1. Open the GCP console and select the project where the misconfiguration exists.
2. Navigate to the Cloud CDN page in the console.
3. Select the name of the CDN that you want to remediate.
4. In the left-hand navigation menu, click on "Backend Services."
5. Click on the name of the backend service that you want to remediate.
6. In the "Backend Configuration" section, click on "Edit."
7. Scroll down to the "Connection Draining" section and toggle the switch to "On."
8. Set the "Draining Timeout" to the desired value in seconds.
9. Click on "Save" to apply the changes.

With these steps, you have successfully remediated the misconfiguration of Cloud CDN Global Backend Services should have Connection Draining for GCP using GCP console.

#### Using CLI

To remediate the misconfiguration "Cloud CDN Global Backend Services Should Have Connection Draining" for GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP Console.
2. Run the following command to list all the backend services in your GCP project:
```
gcloud compute backend-services list
```
3. Identify the global backend service that you want to remediate.
4. Run the following command to enable connection draining for the identified global backend service:
```
gcloud compute backend-services update [BACKEND_SERVICE_NAME] --connection-draining-timeout [TIMEOUT_IN_SECONDS]
```
Replace [BACKEND_SERVICE_NAME] with the name of the identified global backend service, and [TIMEOUT_IN_SECONDS] with the desired connection draining timeout in seconds. For example:
```
gcloud compute backend-services update my-global-backend-service --connection-draining-timeout 300
```
This command will enable connection draining for the identified global backend service with a timeout of 300 seconds (5 minutes).
5. Verify that the connection draining configuration has been applied by running the following command:
```
gcloud compute backend-services describe [BACKEND_SERVICE_NAME] | grep connectionDraining
```
Replace [BACKEND_SERVICE_NAME] with the name of the identified global backend service. This command should return the connection draining configuration for the identified global backend service.

With these steps, you have successfully remediated the misconfiguration "Cloud CDN Global Backend Services Should Have Connection Draining" for GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of Cloud CDN Global Backend Services not having connection draining in GCP using Python, follow these steps:

1. Import the necessary libraries:

```
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials
```

2. Set up authentication:

```
credentials = GoogleCredentials.get_application_default()
service = discovery.build('compute', 'v1', credentials=credentials)
```

3. Define the project ID, region, and backend service name:

```
project = 'your-project-id'
region = 'your-region'
backend_service_name = 'your-backend-service-name'
```

4. Get the current backend service configuration:

```
backend_service = service.backendServices().get(project=project, backendService=backend_service_name).execute()
```

5. Check if connection draining is enabled:

```
if 'connectionDraining' not in backend_service:
    backend_service['connectionDraining'] = {}
if 'enabled' not in backend_service['connectionDraining'] or not backend_service['connectionDraining']['enabled']:
    backend_service['connectionDraining']['enabled'] = True
```

6. Update the backend service configuration:

```
request = service.backendServices().update(project=project, backendService=backend_service_name, body=backend_service)
response = request.execute()
```

7. Verify that connection draining is enabled:

```
if 'connectionDraining' in response and 'enabled' in response['connectionDraining'] and response['connectionDraining']['enabled']:
    print('Connection draining is now enabled for the backend service.')
else:
    print('Failed to enable connection draining for the backend service.')
```

By following these steps, you can remediate the misconfiguration of Cloud CDN Global Backend Services not having connection draining in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/load-balancing/docs/enabling-connection-draining](https://cloud.google.com/load-balancing/docs/enabling-connection-draining) 


</Tab>
</Tabs>