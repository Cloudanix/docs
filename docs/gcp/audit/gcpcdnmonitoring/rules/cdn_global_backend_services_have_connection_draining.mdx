---
slug: cdn_global_backend_services_have_connection_draining
title: Cloud CDN Global Backend Services Should Have Connection Draining
sidebar_label: Cloud CDN Global Backend Services Should Have Connection Draining
---

### More Info:

Cloud CDN should not send any new requests to the unhealthy instance if an compute instance fails health checks

### Risk Level

Medium

### Address

Reliability, Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account that has the necessary permissions to access the GCP resources.

2. Navigate to the Load Balancing page: From the GCP Console, click on the Navigation Menu (three horizontal lines in the upper left-hand corner), scroll down and click on "Network Services", then select "Load balancing".

3. Check the Backend Services: On the Load balancing page, click on the "Backend services" tab. This will display a list of all the backend services associated with your GCP project.

4. Check Connection Draining: For each backend service, click on its name to open its details page. Look for the "Connection Draining Timeout" setting. If this setting is not enabled or set to 0, it means that the backend service does not have connection draining enabled.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure the Google Cloud SDK CLI on your local machine. You can do this by following the instructions provided by Google Cloud at https://cloud.google.com/sdk/docs/install.

2. Once the SDK is installed and configured, open your terminal or command prompt.

3. Run the following command to list all the backend services in your project:

   ```
   gcloud compute backend-services list
   ```

4. For each backend service, run the following command to check if connection draining is enabled:

   ```
   gcloud compute backend-services describe [BACKEND_SERVICE_NAME] --global
   ```

   Replace `[BACKEND_SERVICE_NAME]` with the name of your backend service. If connection draining is enabled, you will see a `connectionDraining` field in the output with a `drainingTimeoutSec` value greater than 0. If this field is not present or the `drainingTimeoutSec` value is 0, then connection draining is not enabled for that backend service.
</Accordion>

<Accordion title='Using Python'>
1. Install Google Cloud SDK and Python Client for Compute Engine: Before you start, make sure you have installed the Google Cloud SDK and authenticated it with your GCP account. Also, install the Python client for Google Compute Engine using pip.

```bash
pip install --upgrade google-api-python-client
```

2. Import the necessary libraries and establish a connection: Import the Google Compute Engine library and authenticate it using your credentials. Also, establish a connection with the Compute Engine.

```python
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials

credentials = GoogleCredentials.get_application_default()
compute = discovery.build('compute', 'v1', credentials=credentials)
```

3. Get the list of backend services: Use the `backendServices().list()` method to get the list of all backend services in your project.

```python
project = 'your_project_id'
request = compute.backendServices().list(project=project)
```

4. Check the connection draining policy: Iterate over the list of backend services and check the `connectionDraining` attribute. If the `drainingTimeoutSec` is 0, it means the connection draining is not enabled.

```python
while request is not None:
    response = request.execute()

    for backend_service in response['items']:
        if 'connectionDraining' in backend_service:
            if backend_service['connectionDraining']['drainingTimeoutSec'] == 0:
                print('Backend service', backend_service['name'], 'does not have connection draining enabled.')
        else:
            print('Backend service', backend_service['name'], 'does not have connection draining enabled.')

    request = compute.backendServices().list_next(previous_request=request, previous_response=response)
```

This script will print the names of all backend services that do not have connection draining enabled.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of Cloud CDN Global Backend Services should have Connection Draining for GCP using GCP console, follow these steps:

1. Open the GCP console and select the project where the misconfiguration exists.
2. Navigate to the Cloud CDN page in the console.
3. Select the name of the CDN that you want to remediate.
4. In the left-hand navigation menu, click on "Backend Services."
5. Click on the name of the backend service that you want to remediate.
6. In the "Backend Configuration" section, click on "Edit."
7. Scroll down to the "Connection Draining" section and toggle the switch to "On."
8. Set the "Draining Timeout" to the desired value in seconds.
9. Click on "Save" to apply the changes.

With these steps, you have successfully remediated the misconfiguration of Cloud CDN Global Backend Services should have Connection Draining for GCP using GCP console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Cloud CDN Global Backend Services Should Have Connection Draining" for GCP using GCP CLI, follow these steps:

1. Open the Cloud Shell in the GCP Console.
2. Run the following command to list all the backend services in your GCP project:
```
gcloud compute backend-services list
```
3. Identify the global backend service that you want to remediate.
4. Run the following command to enable connection draining for the identified global backend service:
```
gcloud compute backend-services update [BACKEND_SERVICE_NAME] --connection-draining-timeout [TIMEOUT_IN_SECONDS]
```
Replace [BACKEND_SERVICE_NAME] with the name of the identified global backend service, and [TIMEOUT_IN_SECONDS] with the desired connection draining timeout in seconds. For example:
```
gcloud compute backend-services update my-global-backend-service --connection-draining-timeout 300
```
This command will enable connection draining for the identified global backend service with a timeout of 300 seconds (5 minutes).
5. Verify that the connection draining configuration has been applied by running the following command:
```
gcloud compute backend-services describe [BACKEND_SERVICE_NAME] | grep connectionDraining
```
Replace [BACKEND_SERVICE_NAME] with the name of the identified global backend service. This command should return the connection draining configuration for the identified global backend service.

With these steps, you have successfully remediated the misconfiguration "Cloud CDN Global Backend Services Should Have Connection Draining" for GCP using GCP CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of Cloud CDN Global Backend Services not having connection draining in GCP using Python, follow these steps:

1. Import the necessary libraries:

```
from googleapiclient import discovery
from oauth2client.client import GoogleCredentials
```

2. Set up authentication:

```
credentials = GoogleCredentials.get_application_default()
service = discovery.build('compute', 'v1', credentials=credentials)
```

3. Define the project ID, region, and backend service name:

```
project = 'your-project-id'
region = 'your-region'
backend_service_name = 'your-backend-service-name'
```

4. Get the current backend service configuration:

```
backend_service = service.backendServices().get(project=project, backendService=backend_service_name).execute()
```

5. Check if connection draining is enabled:

```
if 'connectionDraining' not in backend_service:
    backend_service['connectionDraining'] = {}
if 'enabled' not in backend_service['connectionDraining'] or not backend_service['connectionDraining']['enabled']:
    backend_service['connectionDraining']['enabled'] = True
```

6. Update the backend service configuration:

```
request = service.backendServices().update(project=project, backendService=backend_service_name, body=backend_service)
response = request.execute()
```

7. Verify that connection draining is enabled:

```
if 'connectionDraining' in response and 'enabled' in response['connectionDraining'] and response['connectionDraining']['enabled']:
    print('Connection draining is now enabled for the backend service.')
else:
    print('Failed to enable connection draining for the backend service.')
```

By following these steps, you can remediate the misconfiguration of Cloud CDN Global Backend Services not having connection draining in GCP using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://cloud.google.com/load-balancing/docs/enabling-connection-draining](https://cloud.google.com/load-balancing/docs/enabling-connection-draining) 

