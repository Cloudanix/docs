---
slug: cdn_regional_urlmaps_accept_https_only
title: Cloud CDN Regional Urlmaps Should Accept Https Connections Only
sidebar_label: Cloud CDN Regional Urlmaps Should Accept Https Connections Only
---

### More Info:

Cloud CDN regional url maps should be configured to block HTTP connection and allow only HTTPS connections.

### Risk Level

High

### Address

Security

### Compliance Standards

GDPR, PCIDSS, NIST, HITRUST, SOC2, NISTCSF


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account credentials.

2. Navigate to Cloud CDN: From the main navigation menu, click on "Networking" and then select "Cloud CDN". This will take you to the Cloud CDN dashboard where you can view all your CDN configurations.

3. Check Urlmaps settings: In the Cloud CDN dashboard, locate the "Urlmaps" section. Here, you will find a list of all your Urlmaps. Click on the name of the Urlmap you want to inspect.

4. Inspect HTTPS settings: In the Urlmap details page, look for the "HTTPS settings" section. Here, you should be able to see whether the Urlmap is configured to accept HTTPS connections only. If it is not, then this is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure the Google Cloud SDK CLI on your local machine. You can download it from the official Google Cloud website and follow the instructions to set it up.

2. Authenticate your GCP account using the following command. This will open a new window in your web browser asking you to log in to your Google Cloud account.
   ```
   gcloud auth login
   ```

3. Set your project ID to the project you want to check. Replace `your-project-id` with your actual project ID.
   ```
   gcloud config set project your-project-id
   ```

4. Run the following command to list all the URL maps and their details in the Cloud CDN. Look for the `defaultService` field in the output. If the `defaultService` field starts with `https://`, it means that the URL map accepts HTTPS connections only. If it starts with `http://`, it means that the URL map accepts HTTP connections.
   ```
   gcloud compute url-maps describe your-url-map-name
   ```
   Replace `your-url-map-name` with the name of your URL map.
</Accordion>

<Accordion title='Using Python'>
1. Install Google Cloud SDK and Python Client for Google Cloud CDN: Before you start, make sure you have installed Google Cloud SDK and Python Client for Google Cloud CDN on your local machine. You can install it using pip:

   ```bash
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-cloud-cdn
   ```

2. Authenticate your SDK: Use the following command to authenticate your SDK:

   ```bash
   gcloud auth application-default login
   ```

3. Write a Python script to list all the URL maps: You can use the following Python script to list all the URL maps in your Google Cloud CDN:

   ```python
   from google.cloud import compute_v1

   def list_url_maps(project_id):
       client = compute_v1.UrlMapsClient()
       response = client.list(project=project_id)
       return response

   project_id = 'your-project-id'
   url_maps = list_url_maps(project_id)
   for url_map in url_maps:
       print(url_map)
   ```

4. Check if the URL maps accept HTTPS connections only: You can modify the above script to check if the URL maps accept HTTPS connections only. If the 'defaultUrlRedirect.httpsRedirect' field is set to False, it means the URL map accepts HTTP connections, which is a misconfiguration.

   ```python
   from google.cloud import compute_v1

   def list_url_maps(project_id):
       client = compute_v1.UrlMapsClient()
       response = client.list(project=project_id)
       return response

   def check_https_only(url_maps):
       for url_map in url_maps:
           if not url_map.default_url_redirect.https_redirect:
               print(f"URL map {url_map.name} accepts HTTP connections")

   project_id = 'your-project-id'
   url_maps = list_url_maps(project_id)
   check_https_only(url_maps)
   ```

This script will print the names of all URL maps that accept HTTP connections. If no names are printed, it means all your URL maps accept HTTPS connections only.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate this misconfiguration in GCP using GCP console, you can follow the below steps:

1. Open the GCP console and navigate to the Cloud CDN page.

2. Click on the name of the CDN you want to remediate.

3. Click on the "Url maps" tab.

4. Select the URL map which you want to remediate.

5. Click on the "Edit" button at the top of the page.

6. In the "Host and path rules" section, select the rule which you want to remediate.

7. In the "Backend service" section, click on the "Advanced" dropdown.

8. Under "Frontend protocol", select "HTTPS only".

9. Click on the "Save" button to save the changes.

10. Repeat steps 6-9 for all the rules in the URL map.

11. Verify that the CDN regional URL maps are now accepting HTTPS connections only by testing it.

By following these steps, you can remediate the misconfiguration of accepting HTTP connections in Cloud CDN regional URL maps in GCP using GCP console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the Cloud CDN Regional Urlmaps to accept HTTPS connections only on GCP using GCP CLI, you can follow these steps:

1. Open the Cloud Shell in the GCP Console.

2. Run the following command to list all the existing Cloud CDN UrlMaps:

```
gcloud compute url-maps list
```

3. Identify the name of the UrlMap that needs to be updated and run the following command to describe the details of the UrlMap:

```
gcloud compute url-maps describe [URL_MAP_NAME]
```

4. Identify the name of the backend service associated with the UrlMap and run the following command to describe the details of the backend service:

```
gcloud compute backend-services describe [BACKEND_SERVICE_NAME]
```

5. Identify the name of the health check associated with the backend service and run the following command to describe the details of the health check:

```
gcloud compute health-checks describe [HEALTH_CHECK_NAME]
```

6. If the health check is not already configured to use HTTPS, update the health check to use HTTPS by running the following command:

```
gcloud compute health-checks update [HEALTH_CHECK_NAME] --use-https
```

7. Update the UrlMap to accept HTTPS connections only by running the following command:

```
gcloud compute url-maps update [URL_MAP_NAME] --default-service [BACKEND_SERVICE_NAME] --ssl-policy=global-ssl-policy
```

Note: The `global-ssl-policy` is a built-in SSL policy that enforces HTTPS connections only.

8. Verify that the changes have been applied by running the following command:

```
gcloud compute url-maps describe [URL_MAP_NAME]
```

The output should show that the `sslPolicy` is set to `global-ssl-policy`.

That's it! You have successfully remediated the Cloud CDN Regional Urlmaps to accept HTTPS connections only on GCP using GCP CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of Cloud CDN Regional Urlmaps accepting only HTTPS connections in GCP using Python, you can follow the below steps:

1. First, you need to install the Google Cloud SDK and authenticate to your GCP project using the command:

```
gcloud auth login
```

2. Next, you need to install the required Python libraries using the command:

```
pip install google-cloud-cdn
```

3. After that, you can use the following Python code to remediate the misconfiguration:

```python
from google.cloud import cdn_v1beta1
from google.protobuf.field_mask_pb2 import FieldMask

client = cdn_v1beta1.UrlMapsClient()

# Replace [PROJECT_ID] with your GCP project ID
project_id = '[PROJECT_ID]'

# Replace [REGION] with the region where the urlmap is located
region = '[REGION]'

# Replace [URLMAP_NAME] with the name of the urlmap
urlmap_name = '[URLMAP_NAME]'

urlmap = client.get_url_map(request={'project_id': project_id, 'region': region, 'url_map': urlmap_name})

# Update the urlmap to accept only HTTPS connections
urlmap.default_url_redirect.https_redirect = True

# Update the urlmap using the FieldMask to only modify the https_redirect field
field_mask = FieldMask(paths=['default_url_redirect.https_redirect'])
client.update_url_map(request={'url_map': urlmap, 'update_mask': field_mask})
```

4. Finally, you can run the above Python code to remediate the misconfiguration of Cloud CDN Regional Urlmaps accepting only HTTPS connections in GCP.

Note: You need to replace the placeholders [PROJECT_ID], [REGION], and [URLMAP_NAME] with your GCP project ID, the region where the urlmap is located, and the name of the urlmap, respectively.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://cloud.google.com/cdn/docs/setting-up-http-https-redirect](https://cloud.google.com/cdn/docs/setting-up-http-https-redirect) 

