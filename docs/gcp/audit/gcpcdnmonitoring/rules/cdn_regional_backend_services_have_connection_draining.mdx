---
slug: cdn_regional_backend_services_have_connection_draining
title: Cloud CDN Regional Backend Services Should Have Connection Draining
sidebar_label: Cloud CDN Regional Backend Services Should Have Connection Draining
---

### More Info:

Cloud CDN should not send any new requests to the unhealthy instance if an compute instance fails health checks

### Risk Level

Medium

### Address

Reliability, Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the Google Cloud Platform Console: Open your web browser, navigate to the Google Cloud Platform web console and sign in with your Google account credentials.

2. Navigate to the Load Balancing page: From the main navigation menu, click on the "Networking" option, then select "Load balancing" from the dropdown menu. This will take you to the Load Balancing page where you can view and manage all your load balancers.

3. Check the Backend Services: On the Load Balancing page, click on the name of the load balancer you want to check. This will take you to the load balancer's details page. Here, click on the "Backend services & backend buckets" tab to view the backend services associated with the load balancer.

4. Check Connection Draining: For each backend service, check the "Connection Draining Timeout" setting. If the timeout is set to 0, it means that connection draining is not enabled for that backend service. If the timeout is set to a value greater than 0, it means that connection draining is enabled and the value represents the maximum amount of time, in seconds, that the load balancer should wait before forcefully closing active connections.

#### Using CLI

1. Install and configure Google Cloud SDK: Before you can use the GCP CLI, you need to install the Google Cloud SDK on your local machine. You can download it from the official Google Cloud website. After downloading, you can install it by following the instructions provided by Google. Once installed, you need to authenticate your Google Cloud account by running the command `gcloud auth login`.

2. List all the backend services: Once you have the Google Cloud SDK installed and configured, you can list all the backend services in your project by running the following command in your terminal: `gcloud compute backend-services list`. This command will return a list of all the backend services in your project.

3. Get the details of each backend service: For each backend service in your project, you can get its details by running the following command: `gcloud compute backend-services describe [BACKEND_SERVICE_NAME] --region [REGION_NAME]`. Replace `[BACKEND_SERVICE_NAME]` with the name of your backend service and `[REGION_NAME]` with the name of the region where your backend service is located. This command will return the details of the specified backend service.

4. Check the connection draining timeout: In the details of each backend service, look for the `connectionDraining` field. This field indicates whether connection draining is enabled for the backend service and what the timeout is. If the `connectionDraining` field is not present or the `drainingTimeoutSec` is set to 0, then connection draining is not enabled for the backend service.

#### Using Python

To check if Cloud CDN Regional Backend Services have connection draining enabled using Python scripts, you can follow these steps:

1. **Set up Google Cloud SDK and Python Environment:**
   Before you start, make sure you have the Google Cloud SDK installed and initialized and also have Python installed on your system. You can download Google Cloud SDK from the official Google Cloud website and Python from the official Python website. After installing, initialize the Google Cloud SDK by running `gcloud init` in your terminal.

2. **Install Google Cloud Python Libraries:**
   You will need the Google Cloud Python libraries to interact with Google Cloud services. You can install it using pip, the Python package installer. Run the following command in your terminal to install:
   ```
   pip install google-cloud
   ```

3. **Authenticate your SDK:**
   Use the following command to authenticate your SDK. This will open a new window in your web browser asking you to log in with your Google account and allow the Google Cloud SDK to access your Google Cloud resources.
   ```
   gcloud auth application-default login
   ```

4. **Python Script to Check Connection Draining:**
   Use the following Python script to check if connection draining is enabled for all regional backend services in your Google Cloud project:

   ```python
   from google.cloud import compute_v1

   def check_connection_draining():
       client = compute_v1.BackendServicesClient()

       # Replace 'my-project' with your project ID
       project = 'my-project'

       # List all regional backend services in the project
       for backend_service in client.list(project=project):
           # Check if connection draining is enabled
           if backend_service.connection_draining is not None and backend_service.connection_draining.draining_timeout_sec > 0:
               print(f"Connection draining is enabled for {backend_service.name}")
           else:
               print(f"Connection draining is NOT enabled for {backend_service.name}")

   if __name__ == "__main__":
       check_connection_draining()
   ```

   This script lists all the regional backend services in your Google Cloud project and checks if connection draining is enabled for each of them. If connection draining is enabled, it prints a message saying so. If it's not enabled, it prints a different message.

Please note that you need to replace `'my-project'` with your actual Google Cloud project ID.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration of Cloud CDN Regional Backend Services not having Connection Draining in GCP using the GCP console:

1. Open the GCP Console and log in to your account.
2. Navigate to the Cloud CDN page by selecting the "Navigation menu > Network Services > Cloud CDN".
3. From the Cloud CDN page, select the name of the CDN that you want to configure the connection draining for.
4. In the CDN details page, select the "Backend Configuration" tab.
5. In the Backend Configuration page, select the "Edit" button located at the top of the page.
6. In the "Edit Backend Configuration" page, scroll down to the "Backend Service" section and select the name of the backend service that you want to configure connection draining for.
7. In the "Backend Service" page, select the "Edit" button located at the top of the page.
8. Scroll down to the "Connection Draining" section and select the "Enable" checkbox.
9. In the "Connection Draining Timeout" field, specify the amount of time (in seconds) that you want to wait for the existing connections to complete before shutting down the backend service. The recommended value is 300 seconds.
10. Select the "Save" button to save the changes.

After following these steps, the connection draining feature will be enabled for the selected backend service in your GCP Cloud CDN.

#### Using CLI

To remediate the misconfiguration of Cloud CDN Regional Backend Services not having connection draining on GCP using GCP CLI, follow the below steps:

1. Open the Google Cloud Console and go to the Cloud Shell.

2. Run the following command to list all the backend services in your project:

```
gcloud compute backend-services list
```

3. Choose the backend service that you want to update and run the following command to describe the backend service:

```
gcloud compute backend-services describe [BACKEND_SERVICE_NAME] --region [REGION]
```

4. Check if the connection draining configuration is set for the backend service. If not, add the connection draining configuration by running the following command:

```
gcloud compute backend-services update [BACKEND_SERVICE_NAME] --region [REGION] --connection-draining-timeout [TIMEOUT_SECONDS]
```

Replace [BACKEND_SERVICE_NAME] with the name of the backend service you want to update, [REGION] with the region where the backend service is located, and [TIMEOUT_SECONDS] with the number of seconds that you want to set for the connection draining timeout.

For example, to set the connection draining timeout to 60 seconds for a backend service named "my-backend-service" located in the "us-central1" region, run the following command:

```
gcloud compute backend-services update my-backend-service --region us-central1 --connection-draining-timeout 60
```

5. Verify that the connection draining configuration is set for the backend service by running the following command:

```
gcloud compute backend-services describe [BACKEND_SERVICE_NAME] --region [REGION]
```

Make sure that the "connectionDraining" field shows the correct value for the connection draining configuration.

By following these steps, you can remediate the misconfiguration of Cloud CDN Regional Backend Services not having connection draining on GCP using GCP CLI.

#### Using Python

To remediate the misconfiguration of Cloud CDN Regional Backend Services not having connection draining in GCP using Python, you can follow the below steps:

1. Install the necessary Python libraries:

```
pip install google-cloud-cdn
pip install google-auth google-auth-oauthlib google-auth-httplib2
```

2. Set up authentication:

```
from google.oauth2 import service_account
from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials

creds = None
creds = service_account.Credentials.from_service_account_file(
        'path/to/service_account.json')
creds = creds.with_scopes(
        ['https://www.googleapis.com/auth/cloud-platform'])
creds = creds.with_subject('user@example.com')
```

3. Retrieve the list of backend services:

```
from google.cloud import cdn_v1beta1

client = cdn_v1beta1.CloudCDNClient(credentials=creds)
project_number = '1234567890'
location = 'us-central1'
parent = f'projects/{project_number}/locations/{location}'

backend_services = client.list_backend_services(parent=parent)
```

4. For each backend service, check if connection draining is enabled:

```
for backend_service in backend_services:
    backend_service_name = backend_service.name
    backend_service = client.get_backend_service(name=backend_service_name)
    if backend_service.connection_draining.draining_timeout_sec == 0:
        print(f'Connection draining is not enabled for backend service {backend_service_name}')
```

5. If connection draining is not enabled, update the backend service to enable it:

```
for backend_service in backend_services:
    backend_service_name = backend_service.name
    backend_service = client.get_backend_service(name=backend_service_name)
    if backend_service.connection_draining.draining_timeout_sec == 0:
        backend_service.connection_draining.draining_timeout_sec = 300
        update_mask = {'paths': ['connection_draining']}
        client.update_backend_service(backend_service=backend_service, update_mask=update_mask)
        print(f'Connection draining has been enabled for backend service {backend_service_name}')
```

By following these steps, you can remediate the misconfiguration of Cloud CDN Regional Backend Services not having connection draining in GCP using Python.


### Additional Reading:

- [https://cloud.google.com/load-balancing/docs/enabling-connection-draining](https://cloud.google.com/load-balancing/docs/enabling-connection-draining) 


</Tab>
</Tabs>