--- 
slug: CreateRegexMatchSet
eventname: CreateRegexMatchSet
title: CreateRegexMatchSet
sidebar_label: CreateRegexMatchSet
---
                       
### Event Information

- The CreateRegexMatchSet event in AWS WAF refers to the creation of a regular expression (regex) match set. 
- A regex match set is a collection of regex patterns that are used to match against web request data in order to identify and block malicious or unwanted traffic. 
- This event indicates that a new regex match set has been created, which can then be associated with a web access control list (ACL) or a rule to protect against specific types of attacks or vulnerabilities.


### Examples

- Example 1: Insufficient validation of user input: If the regular expression used in CreateRegexMatchSet is not properly validated, it can lead to security vulnerabilities such as allowing malicious input to bypass the WAF rules. It is important to thoroughly validate and sanitize user input to prevent potential attacks like SQL injection or cross-site scripting (XSS).

- Example 2: Inadequate rule configuration: If the regular expression used in CreateRegexMatchSet is not properly configured, it can result in false positives or false negatives. False positives can lead to legitimate traffic being blocked, causing inconvenience to users, while false negatives can allow malicious traffic to pass through undetected. It is crucial to carefully define and test the regular expression to ensure accurate and effective rule enforcement.

- Example 3: Lack of monitoring and alerting: If the security events generated by the CreateRegexMatchSet are not properly monitored and alerted, it can result in delayed or missed detection of potential security threats. It is important to set up appropriate monitoring and alerting mechanisms to promptly identify and respond to any security incidents or suspicious activities detected by the WAF.

### Remediation

#### Using Console

1. Identify the specific AWS WAF rule that needs to be remediated based on the examples provided.
   - Log in to the AWS Management Console.
   - Navigate to the AWS WAF service.
   - Select the appropriate WebACL that contains the rule that needs to be remediated.

2. Modify the AWS WAF rule to address the identified issue.
   - Within the selected WebACL, locate the rule that needs to be remediated.
   - Click on the rule to access its configuration settings.
   - Adjust the rule's conditions, filters, or actions as necessary to address the issue.
   - Save the changes made to the rule.

3. Test and monitor the remediated AWS WAF rule.
   - Deploy the updated WebACL to the appropriate AWS resources (e.g., CloudFront distribution, Application Load Balancer).
   - Monitor the traffic and logs to ensure that the remediated rule is functioning as expected.
   - Continuously monitor and analyze the logs and metrics to identify any potential issues or anomalies.
   - Make further adjustments to the rule if necessary based on the observed behavior.

#### Using CLI

1. To remediate a specific rule in AWS WAF using AWS CLI, you can use the `update-rule` command. For example, if you want to update a rule with the ID `12345678-1234-1234-1234-123456789012` in a WebACL named `MyWebACL`, you can use the following command:

   ```
   aws wafv2 update-rule --name MyWebACL --scope REGIONAL --id 12345678-1234-1234-1234-123456789012 --action ALLOW --override-action NONE
   ```

   This command updates the specified rule in the WebACL, setting the action to `ALLOW` and overriding any previous actions.

2. To remediate a rate-based rule in AWS WAF using AWS CLI, you can use the `update-rate-based-rule` command. For example, if you want to update a rate-based rule with the ID `12345678-1234-1234-1234-123456789012` in a WebACL named `MyWebACL`, you can use the following command:

   ```
   aws wafv2 update-rate-based-rule --name MyWebACL --scope REGIONAL --id 12345678-1234-1234-1234-123456789012 --rate-limit 1000
   ```

   This command updates the specified rate-based rule in the WebACL, setting the rate limit to `1000` requests per 5 minutes.

3. To remediate a managed rule group in AWS WAF using AWS CLI, you can use the `update-managed-rule-set-version` command. For example, if you want to update a managed rule group with the ARN `arn:aws:wafv2:us-west-2:123456789012:managed-rule-set/aws-managed/gbqj2j5k5k-owasp-top-10` to the latest available version, you can use the following command:

   ```
   aws wafv2 update-managed-rule-set-version --name gbqj2j5k5k-owasp-top-10 --scope REGIONAL --vendor-name aws-managed
   ```

   This command updates the specified managed rule group to the latest available version, ensuring that you have the latest security protections in place.

#### Using Python

1. Example 1: Blocking IP addresses with AWS WAF using Python:
   - Use the AWS SDK for Python (Boto3) to interact with AWS WAF.
   - Write a Python script to retrieve the IP addresses that need to be blocked.
   - Use the `create_ip_set` method to create an IP set in AWS WAF.
   - Use the `update_ip_set` method to add the retrieved IP addresses to the IP set.
   - Use the `update_web_acl` method to associate the IP set with the desired web ACL.

```python
import boto3

# Create AWS WAF client
waf_client = boto3.client('waf')

# Retrieve IP addresses to block
ip_addresses = ['192.0.2.1', '203.0.113.2']

# Create IP set
response = waf_client.create_ip_set(
    Name='BlockedIPSet',
    ChangeToken='CHANGE_TOKEN'
)

# Add IP addresses to IP set
response = waf_client.update_ip_set(
    IPSetId='IP_SET_ID',
    ChangeToken='CHANGE_TOKEN',
    Updates=[
        {
            'Action': 'INSERT',
            'IPSetDescriptor': {
                'Type': 'IPV4',
                'Value': ip_address
            }
        }
        for ip_address in ip_addresses
    ]
)

# Associate IP set with web ACL
response = waf_client.update_web_acl(
    WebACLId='WEB_ACL_ID',
    ChangeToken='CHANGE_TOKEN',
    Updates=[
        {
            'Action': 'INSERT',
            'ActivatedRule': {
                'Priority': 1,
                'RuleId': 'BLOCK_RULE_ID',
                'Action': {
                    'Type': 'BLOCK'
                }
            }
        }
    ]
)
```

2. Example 2: Creating rate-based rules with AWS WAF using Python:
   - Use the AWS SDK for Python (Boto3) to interact with AWS WAF.
   - Write a Python script to define the rate-based rule parameters, such as the threshold and time window.
   - Use the `create_rate_based_rule` method to create a rate-based rule in AWS WAF.
   - Use the `update_web_acl` method to associate the rate-based rule with the desired web ACL.

```python
import boto3

# Create AWS WAF client
waf_client = boto3.client('waf')

# Define rate-based rule parameters
threshold = 100
time_window = 60

# Create rate-based rule
response = waf_client.create_rate_based_rule(
    Name='RateBasedRule',
    MetricName='RateBasedRule',
    RateKey='IP',
    RateLimit=threshold,
    ChangeToken='CHANGE_TOKEN'
)

# Associate rate-based rule with web ACL
response = waf_client.update_web_acl(
    WebACLId='WEB_ACL_ID',
    ChangeToken='CHANGE_TOKEN',
    Updates=[
        {
            'Action': 'INSERT',
            'ActivatedRule': {
                'Priority': 1,
                'RuleId': 'RATE_BASED_RULE_ID',
                'Action': {
                    'Type': 'BLOCK'
                }
            }
        }
    ]
)
```

3. Example 3: Creating custom rules with AWS WAF using Python:
   - Use the AWS SDK for Python (Boto3) to interact with AWS WAF.
   - Write a Python script to define the custom rule parameters, such as the match conditions and actions.
   - Use the `create_rule` method to create a custom rule in AWS WAF.
   - Use the `update_web_acl` method to associate the custom rule with the desired web ACL.

```python
import boto3

# Create AWS WAF client
waf_client = boto3.client('waf')

# Define custom rule parameters
match_conditions = [
    {
        'FieldToMatch': {
            'Type': 'HEADER',
            'Data': 'User-Agent'
        },
        'TextTransformation': 'NONE',
        'ComparisonOperator': 'CONTAINS',
        'Value': 'bad_user_agent'
    }
]

# Create custom rule
response = waf_client.create_rule(
    Name='CustomRule',
    MetricName='CustomRule',
    ChangeToken='CHANGE_TOKEN',
    Predicates=[
        {
            'DataId': 'WEB_ACL_ID',
            'Negated': False,
            'Type': 'IPMatch',
            'Type': 'ByteMatch',
            'DataId': 'WEB_ACL_ID',
            'Negated': False,
            'Type': 'ByteMatch',
            'FieldToMatch': {
                'Type': 'HEADER',
                'Data': 'User-Agent'
            },
            'TextTransformation': 'NONE',
            'ComparisonOperator': 'CONTAINS',
            'Value': 'bad_user_agent'
        }
    ]
)

# Associate custom rule with web ACL
response = waf_client.update_web_acl(
    WebACLId='WEB_ACL_ID',
    ChangeToken='CHANGE_TOKEN',
    Updates=[
        {
            'Action': 'INSERT',
            'ActivatedRule': {
                'Priority': 1,
                'RuleId': 'CUSTOM_RULE_ID',
                'Action': {
                    'Type': 'BLOCK'
                }
            }
        }
    ]
)
```


 