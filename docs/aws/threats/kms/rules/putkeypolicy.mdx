--- 
slug: PutKeyPolicy
eventname: PutKeyPolicy
title: PutKeyPolicy
sidebar_label: PutKeyPolicy
---
                       
### Event Information

#### Meaning

- The PutKeyPolicy event in AWS Key Management Service (KMS) refers to an action where a key policy is updated or created for a KMS key.
- This event signifies that a user or an application has modified the permissions associated with a specific KMS key.
- The PutKeyPolicy event is important for auditing and compliance purposes, as it allows tracking and monitoring of changes made to the key policies, ensuring that only authorized entities have the necessary permissions to access and manage the KMS key.

### Remediation

#### Using Console

- Example: If security is impacted with PutKeyPolicy in AWS KMS, an example could be an unauthorized user gaining access to the AWS KMS service and modifying the key policy to grant themselves additional permissions or remove existing restrictions.

To remediate this issue for AWS KMS using the AWS console, follow these steps:

1. Identify the impacted key: Go to the AWS Management Console and navigate to the AWS KMS service. Select "Customer managed keys" from the left-hand menu and locate the key for which the key policy was modified.

2. Review the key policy: Select the key and click on the "Key policy" tab. Review the current key policy to understand the unauthorized changes made.

3. Restore the key policy: Click on the "Edit" button next to the key policy. In the key policy editor, either revert the policy to a previous version or manually modify it to remove the unauthorized changes. Ensure that the key policy grants appropriate permissions to authorized users and restricts access to unauthorized users.

Note: It is recommended to regularly monitor key policies and enable AWS CloudTrail to capture API calls related to key policy modifications for better security and auditing.

#### Using CLI

- Example: If security is impacted with PutKeyPolicy in AWS KMS, an attacker with sufficient permissions could modify the key policy to grant themselves unauthorized access to the key. For example, they could add their own IAM user or role to the key policy with decrypt permissions.

- Remediation steps using AWS CLI:
  1. Identify the affected key by its key ID or alias.
  2. Retrieve the current key policy using the `aws kms get-key-policy` command.
  3. Review the key policy to identify any unauthorized changes.
  4. If unauthorized changes are found, remove the unauthorized entries from the key policy using the `aws kms put-key-policy` command, specifying the updated policy without the unauthorized entries.

Example CLI commands:
```
aws kms get-key-policy --key-id <key-id-or-alias> --policy-name default > key-policy.json
```
```
# Edit the key-policy.json file to remove unauthorized entries
```
```
aws kms put-key-policy --key-id <key-id-or-alias> --policy-name default --policy file://key-policy.json
```

Note: Replace `<key-id-or-alias>` with the actual key ID or alias of the affected key.

#### Using Python

- Example: If security is impacted with PutKeyPolicy in AWS KMS, an attacker with sufficient permissions could modify the key policy to grant themselves unauthorized access to the key. For example, they could add their own IAM user or role to the key policy with decrypt permissions, allowing them to decrypt data encrypted with the key.

- Remediation: To remediate this issue for AWS KMS using Python, you can implement the following steps:

1. Retrieve the existing key policy using the `get_key_policy` API in the AWS SDK for Python (Boto3).
```python
import boto3

def get_key_policy(key_id):
    client = boto3.client('kms')
    response = client.get_key_policy(
        KeyId=key_id,
        PolicyName='default'
    )
    return response['Policy']

key_id = 'your_key_id'
existing_policy = get_key_policy(key_id)
```

2. Validate the existing policy to ensure it meets your security requirements. You can use a JSON schema or custom logic to validate the policy against your security standards.

3. If the existing policy is found to be non-compliant, update the key policy using the `put_key_policy` API in Boto3, providing the updated policy.
```python
def update_key_policy(key_id, policy):
    client = boto3.client('kms')
    response = client.put_key_policy(
        KeyId=key_id,
        PolicyName='default',
        Policy=policy
    )
    return response

updated_policy = {
    # Updated policy JSON
}

response = update_key_policy(key_id, updated_policy)
```

Note: It is important to ensure that the IAM credentials used to execute the Python script have the necessary permissions to interact with AWS KMS and modify key policies.


 