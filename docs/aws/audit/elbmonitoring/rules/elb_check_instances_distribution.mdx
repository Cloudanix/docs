---
slug: elb_check_instances_distribution
title: ELBs Should Be Evenly Distributed over AZs
sidebar_label: ELBs Should Be Evenly Distributed over AZs
---

### More Info:

EC2 instances registered to your Amazon Elastic Load Balancing (ELB) should be evenly distributed across all Availability Zones (AZs) in order to improve the ELBs configuration reliability.

### Risk Level

Low

### Address

Reliability, Security

### Compliance Standards

CBP



### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.
   
2. In the navigation pane, under LOAD BALANCING, choose Load Balancers.

3. Select the load balancer that you want to check.

4. In the bottom panel, select the "Availability Zones" tab. Here you can see the distribution of your Elastic Load Balancer across different Availability Zones.

5. Check if the instances are evenly distributed across all the Availability Zones. If there is an uneven distribution, it indicates a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. **Install and Configure AWS CLI**: Before you can start, make sure you have AWS CLI installed and configured on your system. You can install it using pip (Python package installer). The command to install AWS CLI is `pip install awscli`. After installing, you need to configure it using `aws configure` command. You will be asked to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. **List all Load Balancers**: Use the following AWS CLI command to list all the load balancers in your account:

    ```
    aws elbv2 describe-load-balancers
    ```

    This command will return a JSON output with details of all the load balancers.

3. **Check Availability Zones for each Load Balancer**: For each load balancer, you need to check the availability zones. You can do this using the following command:

    ```
    aws elbv2 describe-load-balancer-attributes --load-balancer-arn <Load_Balancer_Arn>
    ```

    Replace `<Load_Balancer_Arn>` with the ARN of your load balancer. This command will return a JSON output with the attributes of the load balancer, including the availability zones.

4. **Analyze the Output**: Now, you need to analyze the output of the above command. If the load balancer is evenly distributed over the availability zones, then the number of availability zones should be equal to the number of subnets. If not, then there is a misconfiguration. You can use a Python script to automate this process. The script will parse the JSON output, count the number of availability zones and subnets, and compare them. If they are not equal, the script will print a message indicating the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Configure AWS Credentials: You need to configure your AWS credentials. You can do this in several ways, but the simplest is to use the AWS CLI. Run `aws configure` and then enter your access key, secret access key, and default region when prompted.

3. Python Script: Below is a Python script that uses the boto3 library to check if ELBs are evenly distributed over AZs.

   ```python
   import boto3

   def check_elb_distribution():
       client = boto3.client('elbv2')
       elbs = client.describe_load_balancers()
       for elb in elbs['LoadBalancers']:
           azs = client.describe_availability_zones(LoadBalancerArn=elb['LoadBalancerArn'])
           if len(set(az['ZoneName'] for az in azs['AvailabilityZones'])) < 2:
               print(f"ELB {elb['LoadBalancerName']} is not evenly distributed over AZs")

   if __name__ == "__main__":
       check_elb_distribution()
   ```
   
   This script retrieves all the ELBs in your account and checks the availability zones for each one. If an ELB is found to be in less than two different availability zones, it prints a message indicating that the ELB is not evenly distributed.

4. Run the Python Script: Save the script in a file, for example, `check_elb_distribution.py`, and then run it using Python:

   ```bash
   python check_elb_distribution.py
   ```

   This will print out the names of any ELBs that are not evenly distributed over at least two availability zones.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of ELBs not being evenly distributed over Availability Zones (AZs) in AWS, you can follow these steps:

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.

2. Click on the Load Balancers option in the navigation pane.

3. Select the ELB that you want to remediate and click on the Edit button.

4. In the Availability Zones section, select the AZs that are not currently being used by the ELB.

5. Click on the Add button to add the selected AZs to the ELB.

6. Once the AZs have been added, click on the Remove button next to any AZs that are currently being used by the ELB but are not evenly distributed.

7. Click on the Save button to save the changes.

8. Verify that the ELB is now evenly distributed over all selected AZs by checking the Availability Zones section.

9. Repeat the above steps for any other ELBs that are not evenly distributed over AZs.

By following these steps, you can remediate the misconfiguration of ELBs not being evenly distributed over AZs in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of ELBs not being evenly distributed over AZs in AWS using AWS CLI, follow the below steps:

1. First, check the availability zones in which the ELB is currently running using the following command:

```
aws elb describe-load-balancers --load-balancer-name <ELB-Name> --query 'LoadBalancerDescriptions[].AvailabilityZones'
```

2. If the ELB is not evenly distributed over the AZs, then you need to modify the ELB configuration to distribute it evenly over the AZs. You can use the following command to modify the ELB configuration:

```
aws elb modify-load-balancer-attributes --load-balancer-name <ELB-Name> --load-balancer-attributes '{"CrossZoneLoadBalancing":{"Enabled":true}}'
```

This command enables cross-zone load balancing for the ELB, which ensures that the traffic is evenly distributed across all the AZs.

3. Once the modification is done, you can verify that the ELB is now evenly distributed over all AZs by running the command in step 1 again.

By following these steps, you can remediate the issue of ELBs not being evenly distributed over AZs in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate this misconfiguration in AWS, you can use the following steps using Python:

1. Get a list of all the Elastic Load Balancers (ELBs) in your AWS account using the boto3 library.

```
import boto3

elb_client = boto3.client('elbv2')
elbs = elb_client.describe_load_balancers()['LoadBalancers']
```

2. For each ELB, get the list of Availability Zones (AZs) it is currently deployed in.

```
for elb in elbs:
    azs = elb_client.describe_load_balancer_attributes(LoadBalancerArn=elb['LoadBalancerArn'])['Attributes'][0]['Value'].split(',')
```

3. Check if the number of AZs the ELB is deployed in is less than the total number of AZs available in the region.

```
    if len(azs) < len(elb_client.describe_account_attributes(AttributeNames=['supported-availability-zones'])['AccountAttributes'][0]['AttributeValues']):
```

4. If the number of AZs is less than the total number of AZs available in the region, evenly distribute the ELB across all the AZs.

```
        new_azs = elb_client.describe_account_attributes(AttributeNames=['supported-availability-zones'])['AccountAttributes'][0]['AttributeValues']
        elb_client.modify_load_balancer_attributes(LoadBalancerArn=elb['LoadBalancerArn'], Attributes=[{'Key': 'AvailabilityZones', 'Value': ','.join(new_azs)}])
```

5. Once you have updated all the ELBs, verify that they are now evenly distributed across all the AZs in the region.

Note: Make sure you have the necessary permissions to modify the ELB attributes.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/enable-disable-az.html](https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/enable-disable-az.html) 

