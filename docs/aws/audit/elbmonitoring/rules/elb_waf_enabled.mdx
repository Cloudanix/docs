---
slug: elb_waf_enabled
title: ELB Should Have WAF Enabled
sidebar_label: ELB Should Have WAF Enabled
---

### More Info:

WAF should be enabled so that this firewall will prevent malicious attackers to intrude into your system.

### Risk Level

Low

### Address

Security

### Compliance Standards

SOC2, HITRUST, NISTCSF, PCIDSS




<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.
   
2. In the navigation pane, under LOAD BALANCING, choose Load Balancers.

3. Select the load balancer that you want to check.

4. In the bottom panel, select the "Listeners" tab.

5. Check if there is a column named "WAF WebACL". If the column is not present, it means that the WAF is not enabled for the selected load balancer. If the column is present and it shows a name of a WebACL, it means that the WAF is enabled for the selected load balancer.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the Elastic Load Balancer (ELB) and Web Application Firewall (WAF) services.

2. Once the AWS CLI is set up, you can list all your load balancers using the following command:

   ```
   aws elbv2 describe-load-balancers
   ```

   This command will return a JSON object with details about all your load balancers.

3. To check if a load balancer has WAF enabled, you need to list the WAF web ACLs associated with the load balancer. You can do this using the following command:

   ```
   aws wafv2 list-web-acls
   ```

   This command will return a JSON object with details about all your web ACLs. 

4. Now, you need to check if the ARN of your load balancer is present in the list of resources for any of the web ACLs. You can do this by parsing the JSON output using a tool like jq or a scripting language like Python. If the ARN of your load balancer is not present in the list of resources for any web ACL, then the load balancer does not have WAF enabled.

#### Using Python

1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. The AWS SDK for Python (Boto3) allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Import the necessary libraries and set up AWS credentials: You need to import the Boto3 library and set up your AWS credentials (Access key ID and Secret access key). You can set up your credentials in the AWS credentials file located by default at `~/.aws/credentials`.

   ```python
   import boto3

   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='us-west-2'
   )
   ```

3. Create a function to check if WAF is enabled: Now, you can create a function that will check if WAF is enabled for each ELB. You can use the `describe_web_acls` method from the `WAFV2` client to get information about the WebACLs for a resource.

   ```python
   def check_waf_enabled():
       client = session.client('wafv2')
       elbv2 = session.client('elbv2')

       # Get all load balancers
       load_balancers = elbv2.describe_load_balancers()['LoadBalancers']

       for lb in load_balancers:
           response = client.describe_web_acls(
               Scope='REGIONAL',
               Filters=[
                   {
                       'Name': 'ASSOCIATED_RESOURCE',
                       'Values': [
                           lb['LoadBalancerArn'],
                       ]
                   },
               ]
           )

           # If the WebACLs list is empty, WAF is not enabled
           if not response['WebACLs']:
               print(f"WAF is not enabled for ELB: {lb['LoadBalancerName']}")
   ```

4. Call the function: Finally, you can call the function to check if WAF is enabled for all ELBs.

   ```python
   check_waf_enabled()
   ```

This script will print the names of all ELBs that do not have WAF enabled.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "ELB Should Have WAF Enabled" in AWS using the AWS console, you can follow the below steps:

1. Login to the AWS console.
2. Navigate to the EC2 dashboard.
3. Click on the Load Balancers option from the left-hand menu.
4. Select the ELB for which you want to enable the WAF.
5. Click on the Listeners tab.
6. Click on the Edit button next to the listener for which you want to enable the WAF.
7. In the Edit Listener dialog box, click on the Add Rule button.
8. Select the AWS WAF option from the dropdown menu.
9. Choose the WebACL that you want to associate with the ELB.
10. Click on the Save button to save the changes.

Once you have completed the above steps, the WAF will be enabled for your ELB in AWS.

#### Using CLI

To remediate the misconfiguration of ELB not having WAF enabled in AWS using AWS CLI, follow the below steps:

1. Open AWS CLI on your local machine and run the following command to list all the AWS Elastic Load Balancers:

```
aws elbv2 describe-load-balancers
```

2. From the response, identify the ARN of the ELB that you want to enable WAF for.

3. Run the following command to create an AWS WAF WebACL:

```
aws wafv2 create-web-acl --name MyWebACL --scope REGIONAL
```

Note: Replace "MyWebACL" with a name of your choice for the WebACL.

4. From the response, note down the ARN of the newly created WebACL.

5. Run the following command to associate the WebACL with the ELB:

```
aws wafv2 associate-web-acl --web-acl-arn arn:aws:wafv2:us-west-2:123456789012:regional/webacl/MyWebACL --resource-arn arn:aws:elasticloadbalancing:us-west-2:123456789012:loadbalancer/app/my-load-balancer/1234567890abcdef
```

Note: Replace the WebACL ARN and ELB ARN with the ARNs that you noted down in the previous steps.

6. Finally, verify that the WAF is enabled for the ELB by running the following command:

```
aws elbv2 describe-load-balancers --load-balancer-arns arn:aws:elasticloadbalancing:us-west-2:123456789012:loadbalancer/app/my-load-balancer/1234567890abcdef
```

Note: Replace the ELB ARN with the ARN of the ELB that you enabled WAF for.

Once you have completed these steps, WAF will be enabled for the specified ELB in your AWS environment.

#### Using Python

To remediate the misconfiguration of ELB not having WAF enabled in AWS using Python, follow these steps:

1. Import the necessary libraries:

```
import boto3
```

2. Create a boto3 client for AWS WAF:

```
waf = boto3.client('waf')
```

3. Create a boto3 client for AWS ELB:

```
elbv2 = boto3.client('elbv2')
```

4. Get a list of all the ELBs in the region:

```
elbs = elbv2.describe_load_balancers()
```

5. Loop through each ELB and check if WAF is enabled:

```
for elb in elbs['LoadBalancers']:
    elb_arn = elb['LoadBalancerArn']
    waf_associations = elbv2.describe_load_balancer_waf_enabling_ip_sets(LoadBalancerArn=elb_arn)
    if len(waf_associations['WebACLs']) == 0:
        # WAF is not enabled for this ELB
        # Enable WAF for this ELB
        waf.create_web_acl(
            Name='MyWebACL',
            MetricName='MyWebACLMetric',
            DefaultAction={
                'Type': 'ALLOW'
            }
        )
        waf_rules = waf.list_rules()
        rule_id = None
        for rule in waf_rules['Rules']:
            if rule['Name'] == 'AWS-AWSManagedRulesCommonRuleSet':
                rule_id = rule['RuleId']
                break
        if rule_id is None:
            # No rule found
            # Exit the loop
            break
        waf.update_web_acl(
            WebACLId=web_acl_id,
            ChangeToken=waf.get_change_token()['ChangeToken'],
            Updates=[
                {
                    'Action': 'INSERT',
                    'ActivatedRule': {
                        'Priority': 1,
                        'RuleId': rule_id,
                        'Action': {
                            'Type': 'BLOCK'
                        }
                    }
                }
            ]
        )
        elbv2.associate_web_acl(
            WebACLArn=waf_arn,
            ResourceArns=[elb_arn]
        )
```

6. If WAF is not enabled for an ELB, create a new web ACL, add a rule to it, and associate it with the ELB.

7. The final code will look like this:

```
import boto3

# Create a boto3 client for AWS WAF
waf = boto3.client('waf')

# Create a boto3 client for AWS ELB
elbv2 = boto3.client('elbv2')

# Get a list of all the ELBs in the region
elbs = elbv2.describe_load_balancers()

# Loop through each ELB and check if WAF is enabled
for elb in elbs['LoadBalancers']:
    elb_arn = elb['LoadBalancerArn']
    waf_associations = elbv2.describe_load_balancer_waf_enabling_ip_sets(LoadBalancerArn=elb_arn)
    if len(waf_associations['WebACLs']) == 0:
        # WAF is not enabled for this ELB
        # Enable WAF for this ELB
        waf.create_web_acl(
            Name='MyWebACL',
            MetricName='MyWebACLMetric',
            DefaultAction={
                'Type': 'ALLOW'
            }
        )
        waf_rules = waf.list_rules()
        rule_id = None
        for rule in waf_rules['Rules']:
            if rule['Name'] == 'AWS-AWSManagedRulesCommonRuleSet':
                rule_id = rule['RuleId']
                break
        if rule_id is None:
            # No rule found
            # Exit the loop
            break
        waf.update_web_acl(
            WebACLId=web_acl_id,
            ChangeToken=waf.get_change_token()['ChangeToken'],
            Updates=[
                {
                    'Action': 'INSERT',
                    'ActivatedRule': {
                        'Priority': 1,
                        'RuleId': rule_id,
                        'Action': {
                            'Type': 'BLOCK'
                        }
                    }
                }
            ]
        )
        elbv2.associate_web_acl(
            WebACLArn=waf_arn,
            ResourceArns=[elb_arn]
        )
```

Note: This code is just an example. You may need to modify it according to your specific requirements.


### Additional Reading:

- [https://aws.amazon.com/blogs/aws/aws-web-application-firewall-waf-for-application-load-balancers/](https://aws.amazon.com/blogs/aws/aws-web-application-firewall-waf-for-application-load-balancers/) 


</Tab>
</Tabs>