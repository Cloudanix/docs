
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent an Elastic Load Balancer (ELB) from accepting non-HTTPS connections using the AWS Management Console, follow these steps:

1. **Navigate to the Load Balancers Section:**
   - Open the AWS Management Console.
   - In the navigation pane, choose "EC2" to open the Amazon EC2 console.
   - In the left-hand menu, under "Load Balancing," choose "Load Balancers."

2. **Select the Target Load Balancer:**
   - From the list of load balancers, select the load balancer you want to configure.
   - Click on the "Listeners" tab to view the current listener configuration.

3. **Add HTTPS Listener:**
   - If an HTTPS listener is not already configured, click on the "Add listener" button.
   - Choose "HTTPS" from the protocol dropdown.
   - Specify the appropriate port (typically 443 for HTTPS).
   - Configure the SSL certificate and security policy as required.
   - Click "Save" to add the HTTPS listener.

4. **Remove HTTP Listener:**
   - If an HTTP listener (port 80) is currently configured, select it from the list of listeners.
   - Click on the "Actions" dropdown and choose "Delete."
   - Confirm the deletion to ensure that the load balancer only accepts HTTPS connections.

By following these steps, you ensure that your ELB is configured to accept only HTTPS connections, enhancing the security of your application.
</Accordion>

<Accordion title='Using CLI'>
To ensure that your Elastic Load Balancer (ELB) in AWS only accepts HTTPS connections, you can follow these steps using the AWS CLI:

1. **Create a Security Group for HTTPS:**
   Ensure you have a security group that allows inbound traffic on port 443 (HTTPS).

   ```sh
   aws ec2 create-security-group --group-name my-https-sg --description "Security group for HTTPS traffic"
   aws ec2 authorize-security-group-ingress --group-name my-https-sg --protocol tcp --port 443 --cidr 0.0.0.0/0
   ```

2. **Create an HTTPS Listener for the ELB:**
   Create an HTTPS listener for your ELB. You will need an SSL certificate for this step.

   ```sh
   aws elb create-load-balancer-listeners --load-balancer-name my-load-balancer --listeners "Protocol=HTTPS,LoadBalancerPort=443,InstanceProtocol=HTTP,InstancePort=80,SSLCertificateId=arn:aws:iam::123456789012:server-certificate/my-server-cert"
   ```

3. **Remove the HTTP Listener (if it exists):**
   Ensure that the ELB does not have an HTTP listener on port 80.

   ```sh
   aws elb delete-load-balancer-listeners --load-balancer-name my-load-balancer --load-balancer-ports 80
   ```

4. **Update the ELB Security Group:**
   Attach the security group created in step 1 to your ELB.

   ```sh
   aws elb apply-security-groups-to-load-balancer --load-balancer-name my-load-balancer --security-groups sg-12345678
   ```

By following these steps, you ensure that your ELB only accepts HTTPS connections, thereby enhancing the security of your application.
</Accordion>

<Accordion title='Using Python'>
To prevent an Elastic Load Balancer (ELB) from accepting non-HTTPS connections using Python scripts, you can use the AWS SDK for Python, also known as Boto3. Below are the steps to ensure that your ELB only accepts HTTPS connections:

1. **Install Boto3**:
   Ensure you have Boto3 installed in your Python environment. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by directly configuring the `~/.aws/credentials` file.

3. **Create a Python Script**:
   Write a Python script to modify the ELB listener to only accept HTTPS connections. Below is an example script:

   ```python
   import boto3

   # Initialize a session using Amazon ELB
   client = boto3.client('elbv2')  # For Application Load Balancer (ALB) and Network Load Balancer (NLB)
   # client = boto3.client('elb')  # For Classic Load Balancer (CLB)

   # Replace with your load balancer ARN
   load_balancer_arn = 'arn:aws:elasticloadbalancing:region:account-id:loadbalancer/app/load-balancer-name/load-balancer-id'

   # Describe the listeners for the load balancer
   response = client.describe_listeners(LoadBalancerArn=load_balancer_arn)

   # Iterate through the listeners and modify them to use HTTPS only
   for listener in response['Listeners']:
       if listener['Protocol'] == 'HTTP':
           # Modify the listener to use HTTPS
           client.modify_listener(
               ListenerArn=listener['ListenerArn'],
               Protocol='HTTPS',
               Port=443,
               SslPolicy='ELBSecurityPolicy-2016-08',  # You can choose a different SSL policy if needed
               Certificates=[
                   {
                       'CertificateArn': 'arn:aws:acm:region:account-id:certificate/certificate-id'
                   }
               ]
           )
           print(f"Modified listener {listener['ListenerArn']} to use HTTPS")

   print("All HTTP listeners have been modified to HTTPS.")
   ```

4. **Run the Script**:
   Execute the script in your Python environment:
   ```bash
   python modify_elb_to_https.py
   ```

This script will iterate through all the listeners of the specified ELB and modify any HTTP listeners to use HTTPS, ensuring that the ELB only accepts HTTPS connections. Make sure to replace placeholders like `load_balancer_arn` and `CertificateArn` with your actual values.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.
   
2. In the navigation pane, under LOAD BALANCING, choose Load Balancers.

3. Select the load balancer you want to inspect.

4. In the bottom panel, select the "Listeners" tab. This tab displays the protocols and ports configured for your load balancer.

5. Check the protocols of the listeners. If any listener is using HTTP instead of HTTPS, then the Elastic Load Balancer is not configured to accept HTTPS connections only.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, default region name, and default output format.

2. List all the load balancers: Use the following command to list all the load balancers in your AWS account:

   ```
   aws elbv2 describe-load-balancers
   ```
   This command will return a JSON object that contains information about all the load balancers.

3. Check the listeners for each load balancer: For each load balancer, you need to check the listeners to see if they accept HTTPS connections. You can do this by running the following command:

   ```
   aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
   ```
   Replace `<load_balancer_arn>` with the ARN of the load balancer you want to check. This command will return a JSON object that contains information about the listeners of the specified load balancer.

4. Parse the output: You need to parse the output of the previous command to check if the listeners accept HTTPS connections. You can do this by checking the `Protocol` field of each listener. If the `Protocol` field is `HTTPS`, then the load balancer accepts HTTPS connections. If not, then it doesn't. You can use a tool like `jq` to parse the JSON output:

   ```
   aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn> | jq -r '.Listeners[] | select(.Protocol=="HTTPS")'
   ```
   If this command returns any output, then the load balancer accepts HTTPS connections. If it doesn't return any output, then the load balancer doesn't accept HTTPS connections.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can set your credentials via the AWS CLI, or by manually creating the credentials file yourself. The default location for the file is `~/.aws/credentials`. At a minimum, the credentials file should look like this:

   ```bash
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. Write a Python script to check ELB HTTPS configuration: The following Python script uses the boto3 library to check if the Elastic Load Balancer (ELB) is configured to accept HTTPS connections only.

   ```python
   import boto3

   def check_elb_https_only():
       elb = boto3.client('elbv2')
       load_balancers = elb.describe_load_balancers()
       for lb in load_balancers['LoadBalancers']:
           lb_arn = lb['LoadBalancerArn']
           lb_listeners = elb.describe_listeners(LoadBalancerArn=lb_arn)
           for listener in lb_listeners['Listeners']:
               if listener['Protocol'] == 'HTTP':
                   print(f"ELB {lb['LoadBalancerName']} accepts HTTP connections")

   check_elb_https_only()
   ```

4. Run the Python script: You can run the Python script from your terminal. If any ELB is found that accepts HTTP connections, it will be printed out. If no output is produced, it means all your ELBs are correctly configured to accept HTTPS connections only.

   ```bash
   python check_elb_https.py
   ```
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "ELB Should Accept HTTPS Connections Only" in AWS using AWS console, follow these steps:

1. Open the AWS Management Console and navigate to the EC2 Dashboard.
2. Click on Load Balancers from the left-hand menu.
3. Select the load balancer that you want to configure to accept HTTPS connections only.
4. Click on the Listeners tab.
5. Click on Edit in the Actions column for the HTTPS listener.
6. In the Edit Listener dialog box, select HTTPS as the Protocol.
7. In the SSL Certificate drop-down menu, select the SSL certificate that you want to use for the HTTPS listener.
8. In the Default Actions section, click on the X icon next to the existing action to remove it.
9. Click on Add Action and select Forward to from the drop-down menu.
10. In the Forward to drop-down menu, select the target group that you want to forward traffic to.
11. Click on Save.

After following these steps, your ELB will be configured to accept HTTPS connections only. Any HTTP traffic will be automatically redirected to HTTPS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the ELB accepting only HTTPS connections in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.
2. Run the following command to describe the current configuration of the ELB:

```
aws elb describe-load-balancers --load-balancer-name <ELB_NAME>
```

Replace `<ELB_NAME>` with the name of your ELB.

3. Check if the ELB is currently accepting both HTTP and HTTPS connections. If it is, you need to modify the listener to accept HTTPS connections only.

4. Run the following command to modify the listener to accept HTTPS connections only:

```
aws elb modify-load-balancer-attributes --load-balancer-name <ELB_NAME> --load-balancer-attributes "{\"LoadBalancerAttributes\":{\"ConnectionSettings\":{\"IdleTimeout\":3600},\"AccessLog\":{\"Enabled\":false},\"ConnectionDraining\":{\"Enabled\":false},\"CrossZoneLoadBalancing\":{\"Enabled\":false},\"SecurityGroups\":[\"<SECURITY_GROUP_ID>\"],\"AdditionalAttributes\":[{\"Key\":\"listener.sslPolicy\",\"Value\":\"ELBSecurityPolicy-2016-08\"}],\"Listeners\":[{\"Protocol\":\"HTTPS\",\"LoadBalancerPort\":443,\"InstanceProtocol\":\"HTTP\",\"InstancePort\":80}]}}"
```

Replace `<ELB_NAME>` with the name of your ELB and `<SECURITY_GROUP_ID>` with the ID of the security group that the ELB should use.

5. Verify that the ELB is now accepting HTTPS connections only by running the following command:

```
aws elb describe-load-balancers --load-balancer-name <ELB_NAME>
```

The output should show that the listener is now configured to accept HTTPS connections only.

Note: Make sure to replace `<ELB_NAME>` and `<SECURITY_GROUP_ID>` with the appropriate values for your ELB.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "ELB Should Accept HTTPS Connections Only" for AWS using python, you can follow the below steps:

1. Import the necessary libraries:

```
import boto3
```

2. Create an AWS ELB client:

```
elb_client = boto3.client('elbv2')
```

3. Get the list of all the load balancers:

```
lb_list = elb_client.describe_load_balancers()
```

4. Iterate through the list of load balancers and update the listener protocol to HTTPS:

```
for lb in lb_list['LoadBalancers']:
    lb_arn = lb['LoadBalancerArn']
    listener_list = elb_client.describe_listeners(LoadBalancerArn=lb_arn)
    for listener in listener_list['Listeners']:
        if listener['Protocol'] != 'HTTPS':
            elb_client.modify_listener(
                ListenerArn=listener['ListenerArn'],
                Protocol='HTTPS'
            )
```

5. Verify that the listener protocol has been updated to HTTPS:

```
listener_list = elb_client.describe_listeners(LoadBalancerArn=lb_arn)
for listener in listener_list['Listeners']:
    if listener['Protocol'] != 'HTTPS':
        print('Listener protocol not updated to HTTPS')
    else:
        print('Listener protocol updated to HTTPS')
```

By following the above steps, the misconfiguration "ELB Should Accept HTTPS Connections Only" can be remediated for AWS using python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
