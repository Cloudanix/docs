---
slug: alb_desync_mode_check
title: ALB With Desync Mitigation Mode Should Be Set
sidebar_label: ALB With Desync Mitigation Mode Should Be Set
---

### More Info:

This rule checks an Application Load Balancer (ALB) is configured with a user defined desync mitigation mode. The rule is NON_COMPLIANT if ALB desync mitigation mode does not match with the user defined desync mitigation mode.

### Risk Level

Medium

### Address

Configuration

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 Dashboard. 

2. In the left navigation pane, under the "Load Balancing" section, click on "Load Balancers".

3. Select the Application Load Balancer (ALB) that you want to check.

4. In the bottom panel, click on the "Attributes" tab. Here, you can see the "Desync Mitigation Mode" attribute. If it's not set, then it's a misconfiguration.

#### Using CLI

1. **Install and Configure AWS CLI**: Before you can start, make sure you have AWS CLI installed and configured on your system. You can install it using pip (Python package installer). The command to install AWS CLI is `pip install awscli`. After installation, you can configure it using `aws configure` command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. **List all Load Balancers**: Use the following AWS CLI command to list all the Application Load Balancers (ALB) in your account.

   ```
   aws elbv2 describe-load-balancers
   ```

   This command will return a JSON output with details of all the load balancers.

3. **Check Desync Mitigation Mode**: For each load balancer, check the attribute `DesyncMitigationMode`. You can do this by using the following command:

   ```
   aws elbv2 describe-load-balancer-attributes --load-balancer-arn <your-load-balancer-arn>
   ```

   Replace `<your-load-balancer-arn>` with the ARN of your load balancer. This command will return a JSON output with the attributes of the specified load balancer.

4. **Parse the Output**: You can parse the output using a tool like `jq` or a scripting language like Python to check if the `DesyncMitigationMode` is set. If the `DesyncMitigationMode` is not set or set to `disabled`, then it is a misconfiguration.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3): Before you can start writing Python scripts to check the ALB Desync Mitigation Mode, you need to install and configure Boto3. You can install it using pip:

   ```
   pip install boto3
   ```
   Then, configure your AWS credentials either by setting up environment variables or by using the AWS CLI.

2. Import necessary modules and create a client for ELB: In your Python script, you need to import Boto3 and create a client for Elastic Load Balancer (ELB).

   ```python
   import boto3

   # Create ELB client
   client = boto3.client('elbv2')
   ```

3. Retrieve all the load balancers and check the Desync Mitigation Mode: You can use the `describe_load_balancers` method to retrieve all the load balancers. Then, for each load balancer, you can use the `describe_load_balancer_attributes` method to get its attributes and check the Desync Mitigation Mode.

   ```python
   # Get all load balancers
   load_balancers = client.describe_load_balancers()

   for lb in load_balancers['LoadBalancers']:
       # Get load balancer attributes
       attributes = client.describe_load_balancer_attributes(LoadBalancerArn=lb['LoadBalancerArn'])

       # Check Desync Mitigation Mode
       for attr in attributes['Attributes']:
           if attr['Key'] == 'routing.http.desync_mitigation_mode':
               print(f"Load Balancer: {lb['LoadBalancerName']}, Desync Mitigation Mode: {attr['Value']}")
   ```

4. Analyze the output: The script will print the name of each load balancer and its Desync Mitigation Mode. If the Desync Mitigation Mode is not set or is set to 'disabled', then it's a misconfiguration. You should manually check these load balancers in the AWS console.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of ALB with Desync Mitigation Mode in AWS Elastic Load Balancer using the AWS console, follow these step-by-step instructions:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/console/) and log in to your account.

2. **Navigate to EC2 Dashboard**: Click on the "Services" dropdown menu at the top of the page, select "EC2" under the "Compute" section.

3. **Go to Load Balancers**: In the EC2 Dashboard, under the "Load Balancing" section in the navigation pane, click on "Load Balancers".

4. **Select the ALB**: Select the Application Load Balancer (ALB) that you want to remediate with Desync Mitigation Mode.

5. **Edit Attributes**: In the description tab of the selected ALB, click on the "Attributes" tab.

6. **Enable Desync Mitigation Mode**: Scroll down to find the "Desync Mitigation Mode" attribute and click on the "Edit" button next to it.

7. **Set Desync Mitigation Mode**: In the dropdown menu that appears, select the appropriate option for Desync Mitigation Mode. You can choose between "Defensive" and "Strict" mode based on your requirements. 

8. **Save Changes**: After selecting the desired Desync Mitigation Mode, click on the "Save" button to apply the changes.

9. **Review Configuration**: Verify that the Desync Mitigation Mode has been successfully set for the ALB by checking the attribute settings.

10. **Test the ALB**: It is recommended to perform thorough testing of your ALB after making configuration changes to ensure that the Desync Mitigation Mode is functioning as expected.

By following these steps, you can successfully remediate the misconfiguration of ALB with Desync Mitigation Mode in AWS Elastic Load Balancer using the AWS console.

#### Using CLI

To remediate the misconfiguration of ALB with Desync Mitigation Mode not being set in AWS Elastic Load Balancer using AWS CLI, follow these steps:

1. Open your terminal and ensure that you have the AWS CLI installed and configured with the necessary permissions to modify Elastic Load Balancers.

2. Run the following AWS CLI command to enable Desync Mitigation Mode for your Application Load Balancer (ALB):
   
```bash
aws elbv2 modify-load-balancer-attributes --load-balancer-arn <YOUR_ALB_ARN> --attributes Key=deletion_protection.enabled,Value=true Key=desync-mitigation-mode.enabled,Value=true
```

Replace `<YOUR_ALB_ARN>` with the ARN of your ALB.

3. Verify that the Desync Mitigation Mode has been successfully enabled by describing the load balancer attributes using the following AWS CLI command:

```bash
aws elbv2 describe-load-balancer-attributes --load-balancer-arn <YOUR_ALB_ARN>
```

Ensure that the `desync-mitigation-mode.enabled` attribute is set to `true` in the output.

By following these steps, you can remediate the misconfiguration of ALB with Desync Mitigation Mode not being set in AWS Elastic Load Balancer using AWS CLI.

#### Using Python

To remediate the misconfiguration of ALB with Desync Mitigation Mode not being set in AWS Elastic Load Balancer using Python, you can use the AWS SDK for Python (Boto3) to update the ALB settings. Here are the step-by-step instructions to remediate this issue:

1. Install Boto3:
Ensure you have Boto3 installed in your Python environment. You can install it using pip:
```bash
pip install boto3
```

2. Configure AWS Credentials:
Make sure you have configured AWS credentials with the necessary permissions to update the ALB settings. You can do this by setting up the AWS CLI or by setting environment variables with access key and secret key.

3. Write Python Script:
Create a Python script with the following code to update the ALB settings with Desync Mitigation Mode enabled:

```python
import boto3

# Define the ALB ARN and Desync Mitigation Mode
alb_arn = 'YOUR_ALB_ARN'
desync_mode = 'monitor'  # Options: monitor | defensive | strict

# Create a Boto3 client for Elastic Load Balancing
elbv2_client = boto3.client('elbv2')

# Update the ALB settings with Desync Mitigation Mode
response = elbv2_client.modify_load_balancer_attributes(
    LoadBalancerArn=alb_arn,
    Attributes=[
        {
            'Key': 'routing.http.desyncmitigationmode',
            'Value': desync_mode
        },
    ]
)

print("ALB Desync Mitigation Mode set to:", desync_mode)
```

4. Replace 'YOUR_ALB_ARN' with the actual ARN of your ALB.
You can find the ARN of your ALB in the AWS Management Console or by using the describe_load_balancers() method in Boto3.

5. Run the Script:
Save the Python script and run it using Python. This will update the ALB settings with the Desync Mitigation Mode enabled.

By following these steps, you can remediate the misconfiguration of ALB with Desync Mitigation Mode not being set in AWS Elastic Load Balancer using Python.


</Tab>
</Tabs>