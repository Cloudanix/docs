

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the S3 service by typing 'S3' in the search bar and selecting 'S3' from the dropdown menu.
3. In the S3 dashboard, you will see a list of all your S3 buckets. Click on the name of the bucket you want to check.
4. Once inside the bucket, click on the 'Properties' tab. Under the 'Properties' tab, look for the 'Default encryption' section. If the bucket is encrypted with a customer-provided CMK, it will be indicated here.

#### Using CLI

1. First, you need to list all the S3 buckets in your AWS account. You can do this by using the following AWS CLI command:

   ```
   aws s3api list-buckets --query 'Buckets[].Name'
   ```

2. Once you have the list of all S3 buckets, you need to check the encryption configuration for each bucket. You can do this by using the following AWS CLI command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

   Replace `<bucket-name>` with the name of your S3 bucket.

3. The above command will return the encryption configuration for the specified S3 bucket. You need to check if the `SSEAlgorithm` is set to `aws:kms` and `KMSMasterKeyID` is not `aws/s3`. If it is, then the bucket is encrypted with a customer-provided CMK.

4. Repeat the above steps for each S3 bucket in your AWS account. If any bucket is not encrypted with a customer-provided CMK, then it is a misconfiguration.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3. You can install it using pip:

```python
pip install boto3
```
After installation, you need to configure it with your AWS credentials. You can do this in several ways, but the simplest is to use the AWS CLI:

```bash
aws configure
```

2. Import the necessary modules and create a session using your credentials:

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Create a S3 client and get the list of all S3 buckets:

```python
s3 = session.client('s3')
response = s3.list_buckets()
```

4. Check each bucket for encryption configuration and specifically for customer-provided CMKs:

```python
for bucket in response['Buckets']:
    try:
        enc = s3.get_bucket_encryption(Bucket=bucket['Name'])
        rules = enc['ServerSideEncryptionConfiguration']['Rules']
        for rule in rules:
            if 'SSEKMS' in rule['ApplyServerSideEncryptionByDefault']['SSEAlgorithm']:
                print(f"Bucket {bucket['Name']} is encrypted with customer-provided CMKs")
            else:
                print(f"Bucket {bucket['Name']} is not encrypted with customer-provided CMKs")
    except Exception as e:
        print(f"Bucket {bucket['Name']} does not have an encryption policy")
```

This script will print out the names of all S3 buckets and whether they are encrypted with customer-provided CMKs or not. If a bucket does not have an encryption policy, it will also be printed out.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of S3 Buckets not being encrypted with Customer-Provided CMKs in AWS, follow these step-by-step instructions:

1. Log in to the AWS Management Console.
2. Go to the S3 service.
3. Select the bucket that needs to be encrypted with a Customer-Provided CMK.
4. Click on the "Properties" tab.
5. Scroll down to the "Default encryption" section and click on "Edit".
6. Select "AWS-KMS" as the encryption type.
7. Choose "Customer managed CMK" for the master key.
8. Select the CMK that you want to use for encryption from the drop-down menu.
9. Click on "Save changes".

Once you have completed these steps, all objects in the selected S3 bucket will be encrypted with the Customer-Provided CMK that you have chosen. It is important to note that you will need to ensure that the appropriate IAM policies are in place to allow access to the CMK for the appropriate users or roles.

#### Using CLI

To remediate S3 Buckets not being encrypted with Customer-Provided CMKs in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your computer.

2. Identify the S3 bucket that needs to be remediated.

3. Check if the S3 bucket is encrypted with a Customer-Provided CMK by running the following command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

4. If the output of the above command shows that the S3 bucket is not encrypted with a Customer-Provided CMK, proceed with the following steps.

5. Create a Customer-Provided CMK in AWS Key Management Service (KMS) by running the following command:

   ```
   aws kms create-key --description "Customer-Provided CMK for S3 Bucket Encryption"
   ```

6. Take note of the `KeyId` value returned by the above command, as it will be used in the next step.

7. Create a new bucket policy for the S3 bucket by running the following command:

   ```
   aws s3api put-bucket-policy --bucket <bucket-name> --policy '{
     "Version": "2012-10-17",
     "Id": "PutEncryptedBucketPolicy",
     "Statement": [
       {
         "Sid": "DenyUnEncryptedObjectUploads",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "StringNotEquals": {
             "s3:x-amz-server-side-encryption": "aws:kms"
           }
         }
       },
       {
         "Sid": "RequireCustomerProvidedCMK",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "Null": {
             "s3:x-amz-server-side-encryption-aws-kms-key-id": "true"
           }
         }
       },
       {
         "Sid": "AllowEncryptedObjectUploads",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "StringEquals": {
             "s3:x-amz-server-side-encryption": "aws:kms"
           },
           "StringEquals": {
             "s3:x-amz-server-side-encryption-aws-kms-key-id": "<KeyId>"
           }
         }
       }
     ]
   }'
   ```

   Replace `<bucket-name>` with the name of the S3 bucket and `<KeyId>` with the `KeyId` value obtained in step 6.

8. Verify that the S3 bucket is now encrypted with the Customer-Provided CMK by running the following command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

   The output of the above command should show that the S3 bucket is now encrypted with the Customer-Provided CMK.

9. Repeat the above steps for any other S3 buckets that need to be remediated.

#### Using Python

To remediate the S3 Buckets should be encrypted with customer-provided CMKs misconfiguration in AWS using Python, follow these steps:

1. Identify the S3 buckets that are not encrypted with customer-provided CMKs. You can use the following Python code to list all the S3 buckets in your AWS account:

```
import boto3

s3 = boto3.client('s3')

response = s3.list_buckets()

for bucket in response['Buckets']:
    print(bucket['Name'])
```

2. For each S3 bucket that is not encrypted with customer-provided CMKs, enable default encryption with a customer-provided CMK. You can use the following Python code to enable default encryption for an S3 bucket:

```
import boto3

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'
kms_key_id = 'your-kms-key-id'

s3.put_bucket_encryption(
    Bucket=bucket_name,
    ServerSideEncryptionConfiguration={
        'Rules': [
            {
                'ApplyServerSideEncryptionByDefault': {
                    'SSEAlgorithm': 'aws:kms',
                    'KMSMasterKeyID': kms_key_id
                }
            }
        ]
    }
)
```

Replace `your-bucket-name` with the name of the S3 bucket and `your-kms-key-id` with the ID of the customer-provided CMK.

3. Verify that the S3 bucket is now encrypted with the customer-provided CMK. You can use the following Python code to check the encryption status of an S3 bucket:

```
import boto3

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'

response = s3.get_bucket_encryption(
    Bucket=bucket_name
)

print(response)
```

This will print the encryption configuration for the S3 bucket, including the customer-provided CMK ID.

Repeat these steps for all the S3 buckets that are not encrypted with customer-provided CMKs.


</Tab>
</Tabs>