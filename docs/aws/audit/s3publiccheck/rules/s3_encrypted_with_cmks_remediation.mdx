
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the S3 service by typing 'S3' in the search bar and selecting 'S3' from the dropdown menu.
3. In the S3 dashboard, click on the name of the bucket you want to check.
4. Under the 'Properties' tab, scroll down to the 'Default encryption' section. If the bucket is encrypted with a customer-provided CMK, it will display 'AWS-KMS' along with the ARN of the CMK. If it does not, then the bucket is not encrypted with a customer-provided CMK.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the S3 buckets and KMS keys.

2. Once the AWS CLI is set up, you can list all the S3 buckets in your account using the following command:
   ```
   aws s3api list-buckets --query 'Buckets[].Name'
   ```
   This command will return a list of all the bucket names in your account.

3. For each bucket, you can check the default encryption configuration using the following command:
   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```
   Replace `<bucket-name>` with the name of the bucket you want to check. This command will return the default encryption configuration for the specified bucket.

4. To check if the bucket is encrypted with a customer-provided CMK, you need to look for the `SSEKMS` value in the `SSEAlgorithm` field and the `KMSMasterKeyID` field in the output of the previous command. If the `SSEAlgorithm` field is `SSEKMS` and the `KMSMasterKeyID` field is not empty, then the bucket is encrypted with a customer-provided CMK. If not, then the bucket is not encrypted with a customer-provided CMK.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3. You can install it using pip:

```python
pip install boto3
```
After installation, you need to configure it with your AWS credentials. You can do this in several ways, but the simplest is to use the AWS CLI:

```bash
aws configure
```

2. Import the necessary modules and create a session: In your Python script, you'll need to import Boto3 and create a session using your AWS credentials.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. List all S3 buckets and check their encryption configuration: You can use the `list_buckets` method to get a list of all your S3 buckets, and then use the `get_bucket_encryption` method to check the encryption configuration of each bucket.

```python
s3 = session.resource('s3')

for bucket in s3.buckets.all():
    try:
        encryption = bucket.BucketEncryption()
        rules = encryption.server_side_encryption_configuration['Rules']
        for rule in rules:
            if 'SSEAlgorithm' in rule['ApplyServerSideEncryptionByDefault']:
                if rule['ApplyServerSideEncryptionByDefault']['SSEAlgorithm'] != 'aws:kms':
                    print(f"Bucket {bucket.name} is not encrypted with a customer-provided CMK.")
    except Exception as e:
        print(f"Bucket {bucket.name} does not have an encryption policy.")
```

4. Analyze the output: The script will print the names of all buckets that are not encrypted with a customer-provided CMK. If a bucket does not have an encryption policy, this will also be printed. This way, you can easily identify misconfigurations in your S3 buckets.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of S3 Buckets not being encrypted with Customer-Provided CMKs in AWS, follow these step-by-step instructions:

1. Log in to the AWS Management Console.
2. Go to the S3 service.
3. Select the bucket that needs to be encrypted with a Customer-Provided CMK.
4. Click on the "Properties" tab.
5. Scroll down to the "Default encryption" section and click on "Edit".
6. Select "AWS-KMS" as the encryption type.
7. Choose "Customer managed CMK" for the master key.
8. Select the CMK that you want to use for encryption from the drop-down menu.
9. Click on "Save changes".

Once you have completed these steps, all objects in the selected S3 bucket will be encrypted with the Customer-Provided CMK that you have chosen. It is important to note that you will need to ensure that the appropriate IAM policies are in place to allow access to the CMK for the appropriate users or roles.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate S3 Buckets not being encrypted with Customer-Provided CMKs in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your computer.

2. Identify the S3 bucket that needs to be remediated.

3. Check if the S3 bucket is encrypted with a Customer-Provided CMK by running the following command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

4. If the output of the above command shows that the S3 bucket is not encrypted with a Customer-Provided CMK, proceed with the following steps.

5. Create a Customer-Provided CMK in AWS Key Management Service (KMS) by running the following command:

   ```
   aws kms create-key --description "Customer-Provided CMK for S3 Bucket Encryption"
   ```

6. Take note of the `KeyId` value returned by the above command, as it will be used in the next step.

7. Create a new bucket policy for the S3 bucket by running the following command:

   ```
   aws s3api put-bucket-policy --bucket <bucket-name> --policy '{
     "Version": "2012-10-17",
     "Id": "PutEncryptedBucketPolicy",
     "Statement": [
       {
         "Sid": "DenyUnEncryptedObjectUploads",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "StringNotEquals": {
             "s3:x-amz-server-side-encryption": "aws:kms"
           }
         }
       },
       {
         "Sid": "RequireCustomerProvidedCMK",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "Null": {
             "s3:x-amz-server-side-encryption-aws-kms-key-id": "true"
           }
         }
       },
       {
         "Sid": "AllowEncryptedObjectUploads",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "StringEquals": {
             "s3:x-amz-server-side-encryption": "aws:kms"
           },
           "StringEquals": {
             "s3:x-amz-server-side-encryption-aws-kms-key-id": "<KeyId>"
           }
         }
       }
     ]
   }'
   ```

   Replace `<bucket-name>` with the name of the S3 bucket and `<KeyId>` with the `KeyId` value obtained in step 6.

8. Verify that the S3 bucket is now encrypted with the Customer-Provided CMK by running the following command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

   The output of the above command should show that the S3 bucket is now encrypted with the Customer-Provided CMK.

9. Repeat the above steps for any other S3 buckets that need to be remediated.
</Accordion>

<Accordion title='Using Python'>
To remediate the S3 Buckets should be encrypted with customer-provided CMKs misconfiguration in AWS using Python, follow these steps:

1. Identify the S3 buckets that are not encrypted with customer-provided CMKs. You can use the following Python code to list all the S3 buckets in your AWS account:

```
import boto3

s3 = boto3.client('s3')

response = s3.list_buckets()

for bucket in response['Buckets']:
    print(bucket['Name'])
```

2. For each S3 bucket that is not encrypted with customer-provided CMKs, enable default encryption with a customer-provided CMK. You can use the following Python code to enable default encryption for an S3 bucket:

```
import boto3

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'
kms_key_id = 'your-kms-key-id'

s3.put_bucket_encryption(
    Bucket=bucket_name,
    ServerSideEncryptionConfiguration={
        'Rules': [
            {
                'ApplyServerSideEncryptionByDefault': {
                    'SSEAlgorithm': 'aws:kms',
                    'KMSMasterKeyID': kms_key_id
                }
            }
        ]
    }
)
```

Replace `your-bucket-name` with the name of the S3 bucket and `your-kms-key-id` with the ID of the customer-provided CMK.

3. Verify that the S3 bucket is now encrypted with the customer-provided CMK. You can use the following Python code to check the encryption status of an S3 bucket:

```
import boto3

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'

response = s3.get_bucket_encryption(
    Bucket=bucket_name
)

print(response)
```

This will print the encryption configuration for the S3 bucket, including the customer-provided CMK ID.

Repeat these steps for all the S3 buckets that are not encrypted with customer-provided CMKs.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
