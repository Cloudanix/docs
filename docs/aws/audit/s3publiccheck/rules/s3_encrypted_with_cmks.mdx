---
slug: s3_encrypted_with_cmks
title: S3 Buckets Should Be Encrypted with Customer-Provided CMKs
sidebar_label: S3 Buckets Should Be Encrypted with Customer-Provided CMKs
---

### More Info:

AWS S3 buckets should be configured to use Server-Side Encryption with customer managed CMKs instead of S3-Managed Keys (SSE-S3) in order to obtain a fine-grained control over Amazon S3 data-at-rest encryption and decryption process.

### Risk Level

Low

### Address

Security

### Compliance Standards

NIST, AWSWAF, HITRUST, SOC2, NISTCSF, PCIDSS


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent S3 buckets from being unencrypted with Customer-Provided CMKs (Customer Master Keys) in AWS using the AWS Management Console, follow these steps:

1. **Navigate to S3 Service:**
   - Open the AWS Management Console.
   - In the Services menu, select "S3" to go to the Amazon S3 dashboard.

2. **Select the Bucket:**
   - In the S3 dashboard, locate and click on the name of the bucket you want to configure.

3. **Enable Default Encryption:**
   - In the bucket's settings, go to the "Properties" tab.
   - Scroll down to the "Default encryption" section.
   - Click on "Edit" and select "AWS-KMS" as the encryption method.
   - Choose the Customer Master Key (CMK) you want to use from the dropdown menu or enter the ARN of the CMK.

4. **Save Changes:**
   - After selecting the appropriate CMK, click "Save changes" to apply the encryption settings to the bucket.

By following these steps, you ensure that all objects stored in the S3 bucket are encrypted using the specified Customer-Provided CMK.
</Accordion>

<Accordion title='Using CLI'>
To ensure that your S3 buckets are encrypted with Customer-Provided CMKs (Customer Master Keys) using the AWS CLI, follow these steps:

1. **Create a Customer Master Key (CMK) in AWS KMS:**
   First, you need to create a CMK in AWS Key Management Service (KMS) if you don't already have one.
   ```sh
   aws kms create-key --description "My CMK for S3 encryption"
   ```

2. **Get the Key ID or ARN of the CMK:**
   Retrieve the Key ID or Amazon Resource Name (ARN) of the CMK you just created.
   ```sh
   aws kms list-keys
   ```

3. **Enable Default Encryption on the S3 Bucket:**
   Apply the default encryption configuration to your S3 bucket using the CMK.
   ```sh
   aws s3api put-bucket-encryption --bucket your-bucket-name --server-side-encryption-configuration '{
       "Rules": [
           {
               "ApplyServerSideEncryptionByDefault": {
                   "SSEAlgorithm": "aws:kms",
                   "KMSMasterKeyID": "your-cmk-key-id-or-arn"
               }
           }
       ]
   }'
   ```

4. **Verify the Encryption Configuration:**
   Confirm that the encryption settings have been applied correctly to your S3 bucket.
   ```sh
   aws s3api get-bucket-encryption --bucket your-bucket-name
   ```

By following these steps, you can ensure that your S3 buckets are encrypted with Customer-Provided CMKs using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent S3 buckets from being created without encryption using Customer-Provided CMKs (Customer Master Keys) in AWS, you can use Python scripts with the Boto3 library. Here are the steps:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Create a KMS Key**:
   First, create a Customer Master Key (CMK) in AWS KMS (Key Management Service). This key will be used to encrypt your S3 buckets.
   ```python
   import boto3

   kms_client = boto3.client('kms')

   response = kms_client.create_key(
       Description='My CMK for S3 bucket encryption',
       KeyUsage='ENCRYPT_DECRYPT',
       Origin='AWS_KMS'
   )

   cmk_id = response['KeyMetadata']['KeyId']
   print(f"Created CMK with ID: {cmk_id}")
   ```

3. **Create an S3 Bucket with Encryption**:
   Use the created CMK to set up default encryption for your S3 bucket.
   ```python
   import boto3

   s3_client = boto3.client('s3')

   bucket_name = 'my-secure-bucket'

   # Create the S3 bucket
   s3_client.create_bucket(Bucket=bucket_name)

   # Apply the bucket encryption using the CMK
   encryption_configuration = {
       'Rules': [
           {
               'ApplyServerSideEncryptionByDefault': {
                   'SSEAlgorithm': 'aws:kms',
                   'KMSMasterKeyID': cmk_id
               }
           }
       ]
   }

   s3_client.put_bucket_encryption(
       Bucket=bucket_name,
       ServerSideEncryptionConfiguration=encryption_configuration
   )

   print(f"Bucket {bucket_name} created with encryption using CMK {cmk_id}")
   ```

4. **Enforce Bucket Policy to Require Encryption**:
   To ensure that all objects uploaded to the bucket are encrypted with the specified CMK, you can enforce a bucket policy.
   ```python
   import json

   bucket_policy = {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Sid": "RequireKMSEncryption",
               "Effect": "Deny",
               "Principal": "*",
               "Action": "s3:PutObject",
               "Resource": f"arn:aws:s3:::{bucket_name}/*",
               "Condition": {
                   "StringNotEquals": {
                       "s3:x-amz-server-side-encryption": "aws:kms"
                   },
                   "StringNotEqualsIfExists": {
                       "s3:x-amz-server-side-encryption-aws-kms-key-id": cmk_id
                   }
               }
           }
       ]
   }

   s3_client.put_bucket_policy(
       Bucket=bucket_name,
       Policy=json.dumps(bucket_policy)
   )

   print(f"Bucket policy applied to {bucket_name} to enforce encryption with CMK {cmk_id}")
   ```

By following these steps, you ensure that your S3 buckets are created with encryption using Customer-Provided CMKs and enforce policies to prevent misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the S3 service by typing 'S3' in the search bar and selecting 'S3' from the dropdown menu.
3. In the S3 dashboard, click on the name of the bucket you want to check.
4. Under the 'Properties' tab, scroll down to the 'Default encryption' section. If the bucket is encrypted with a customer-provided CMK, it will display 'AWS-KMS' along with the ARN of the CMK. If it does not, then the bucket is not encrypted with a customer-provided CMK.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the S3 buckets and KMS keys.

2. Once the AWS CLI is set up, you can list all the S3 buckets in your account using the following command:
   ```
   aws s3api list-buckets --query 'Buckets[].Name'
   ```
   This command will return a list of all the bucket names in your account.

3. For each bucket, you can check the default encryption configuration using the following command:
   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```
   Replace `<bucket-name>` with the name of the bucket you want to check. This command will return the default encryption configuration for the specified bucket.

4. To check if the bucket is encrypted with a customer-provided CMK, you need to look for the `SSEKMS` value in the `SSEAlgorithm` field and the `KMSMasterKeyID` field in the output of the previous command. If the `SSEAlgorithm` field is `SSEKMS` and the `KMSMasterKeyID` field is not empty, then the bucket is encrypted with a customer-provided CMK. If not, then the bucket is not encrypted with a customer-provided CMK.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3. You can install it using pip:

```python
pip install boto3
```
After installation, you need to configure it with your AWS credentials. You can do this in several ways, but the simplest is to use the AWS CLI:

```bash
aws configure
```

2. Import the necessary modules and create a session: In your Python script, you'll need to import Boto3 and create a session using your AWS credentials.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. List all S3 buckets and check their encryption configuration: You can use the `list_buckets` method to get a list of all your S3 buckets, and then use the `get_bucket_encryption` method to check the encryption configuration of each bucket.

```python
s3 = session.resource('s3')

for bucket in s3.buckets.all():
    try:
        encryption = bucket.BucketEncryption()
        rules = encryption.server_side_encryption_configuration['Rules']
        for rule in rules:
            if 'SSEAlgorithm' in rule['ApplyServerSideEncryptionByDefault']:
                if rule['ApplyServerSideEncryptionByDefault']['SSEAlgorithm'] != 'aws:kms':
                    print(f"Bucket {bucket.name} is not encrypted with a customer-provided CMK.")
    except Exception as e:
        print(f"Bucket {bucket.name} does not have an encryption policy.")
```

4. Analyze the output: The script will print the names of all buckets that are not encrypted with a customer-provided CMK. If a bucket does not have an encryption policy, this will also be printed. This way, you can easily identify misconfigurations in your S3 buckets.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of S3 Buckets not being encrypted with Customer-Provided CMKs in AWS, follow these step-by-step instructions:

1. Log in to the AWS Management Console.
2. Go to the S3 service.
3. Select the bucket that needs to be encrypted with a Customer-Provided CMK.
4. Click on the "Properties" tab.
5. Scroll down to the "Default encryption" section and click on "Edit".
6. Select "AWS-KMS" as the encryption type.
7. Choose "Customer managed CMK" for the master key.
8. Select the CMK that you want to use for encryption from the drop-down menu.
9. Click on "Save changes".

Once you have completed these steps, all objects in the selected S3 bucket will be encrypted with the Customer-Provided CMK that you have chosen. It is important to note that you will need to ensure that the appropriate IAM policies are in place to allow access to the CMK for the appropriate users or roles.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate S3 Buckets not being encrypted with Customer-Provided CMKs in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your computer.

2. Identify the S3 bucket that needs to be remediated.

3. Check if the S3 bucket is encrypted with a Customer-Provided CMK by running the following command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

4. If the output of the above command shows that the S3 bucket is not encrypted with a Customer-Provided CMK, proceed with the following steps.

5. Create a Customer-Provided CMK in AWS Key Management Service (KMS) by running the following command:

   ```
   aws kms create-key --description "Customer-Provided CMK for S3 Bucket Encryption"
   ```

6. Take note of the `KeyId` value returned by the above command, as it will be used in the next step.

7. Create a new bucket policy for the S3 bucket by running the following command:

   ```
   aws s3api put-bucket-policy --bucket <bucket-name> --policy '{
     "Version": "2012-10-17",
     "Id": "PutEncryptedBucketPolicy",
     "Statement": [
       {
         "Sid": "DenyUnEncryptedObjectUploads",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "StringNotEquals": {
             "s3:x-amz-server-side-encryption": "aws:kms"
           }
         }
       },
       {
         "Sid": "RequireCustomerProvidedCMK",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "Null": {
             "s3:x-amz-server-side-encryption-aws-kms-key-id": "true"
           }
         }
       },
       {
         "Sid": "AllowEncryptedObjectUploads",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:PutObject",
         "Resource": "arn:aws:s3:::<bucket-name>/*",
         "Condition": {
           "StringEquals": {
             "s3:x-amz-server-side-encryption": "aws:kms"
           },
           "StringEquals": {
             "s3:x-amz-server-side-encryption-aws-kms-key-id": "<KeyId>"
           }
         }
       }
     ]
   }'
   ```

   Replace `<bucket-name>` with the name of the S3 bucket and `<KeyId>` with the `KeyId` value obtained in step 6.

8. Verify that the S3 bucket is now encrypted with the Customer-Provided CMK by running the following command:

   ```
   aws s3api get-bucket-encryption --bucket <bucket-name>
   ```

   The output of the above command should show that the S3 bucket is now encrypted with the Customer-Provided CMK.

9. Repeat the above steps for any other S3 buckets that need to be remediated.
</Accordion>

<Accordion title='Using Python'>
To remediate the S3 Buckets should be encrypted with customer-provided CMKs misconfiguration in AWS using Python, follow these steps:

1. Identify the S3 buckets that are not encrypted with customer-provided CMKs. You can use the following Python code to list all the S3 buckets in your AWS account:

```
import boto3

s3 = boto3.client('s3')

response = s3.list_buckets()

for bucket in response['Buckets']:
    print(bucket['Name'])
```

2. For each S3 bucket that is not encrypted with customer-provided CMKs, enable default encryption with a customer-provided CMK. You can use the following Python code to enable default encryption for an S3 bucket:

```
import boto3

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'
kms_key_id = 'your-kms-key-id'

s3.put_bucket_encryption(
    Bucket=bucket_name,
    ServerSideEncryptionConfiguration={
        'Rules': [
            {
                'ApplyServerSideEncryptionByDefault': {
                    'SSEAlgorithm': 'aws:kms',
                    'KMSMasterKeyID': kms_key_id
                }
            }
        ]
    }
)
```

Replace `your-bucket-name` with the name of the S3 bucket and `your-kms-key-id` with the ID of the customer-provided CMK.

3. Verify that the S3 bucket is now encrypted with the customer-provided CMK. You can use the following Python code to check the encryption status of an S3 bucket:

```
import boto3

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'

response = s3.get_bucket_encryption(
    Bucket=bucket_name
)

print(response)
```

This will print the encryption configuration for the S3 bucket, including the customer-provided CMK ID.

Repeat these steps for all the S3 buckets that are not encrypted with customer-provided CMKs.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingKMSEncryption.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingKMSEncryption.html) 

