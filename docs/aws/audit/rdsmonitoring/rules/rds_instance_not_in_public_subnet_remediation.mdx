
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the RDS dashboard by selecting "Services" then "RDS" from the drop-down menu.
3. In the navigation pane, click on "Databases".
4. Select the RDS DB instance that you want to examine.
5. In the "Connectivity & security" tab, under "VPC and subnet information", check the "Subnet group" details. Click on the link to the subnet group.
6. In the subnet group details page, under "Subnets", check the "Availability Zone and Subnet" section. If the "Publicly accessible" attribute is set to "Yes", then the selected Amazon RDS DB instance is running within a VPC and is using a subnet that is not configured as a private subnet.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all the DB instances in your AWS account. You can do this by using the AWS CLI command `aws rds describe-db-instances`. This command will return a JSON output with all the DB instances.

2. Next, you need to list all the subnets in your VPC. You can do this by using the AWS CLI command `aws ec2 describe-subnets`. This command will return a JSON output with all the subnets in your VPC.

3. Now, you need to check if any of the DB instances are in a public subnet. You can do this by checking the 'MapPublicIpOnLaunch' attribute of each subnet. If this attribute is set to 'true', then the subnet is public. You can use the following command to check this: `aws ec2 describe-subnets --query 'Subnets[?MapPublicIpOnLaunch==`true`]'`.

4. Finally, you need to check if any of the DB instances are in these public subnets. You can do this by comparing the 'DBSubnetGroup' attribute of each DB instance with the 'SubnetId' attribute of each public subnet. If there is a match, then the DB instance is in a public subnet. You can use a Python script to do this comparison.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary libraries: You will need the boto3 library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
from botocore.exceptions import BotoCoreError, ClientError
```

2. Create a session using your AWS credentials. You can configure your credentials in the AWS credentials file. The default location for the file is `~/.aws/credentials`.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    aws_session_token='SESSION_TOKEN',
)
```

3. Create a client for 'rds' and 'ec2' to fetch the RDS instances and VPC details.

```python
rds = session.client('rds')
ec2 = session.client('ec2')
```

4. Now, fetch all the DB instances and check if they are in a VPC. If they are, check if the subnet they are in is a public subnet. A subnet is considered public if it has a route to an Internet Gateway.

```python
try:
    dbs = rds.describe_db_instances()
    for db in dbs['DBInstances']:
        if 'DBSubnetGroup' in db:
            subnet_group = db['DBSubnetGroup']
            for subnet in subnet_group['Subnets']:
                subnet_id = subnet['SubnetIdentifier']
                subnet_details = ec2.describe_subnets(SubnetIds=[subnet_id])
                for route_table in subnet_details['Subnets'][0]['RouteTable']['Routes']:
                    if 'GatewayId' in route_table and 'igw' in route_table['GatewayId']:
                        print(f"DB instance {db['DBInstanceIdentifier']} is in a public subnet")
except BotoCoreError as e:
    print(e)
except ClientError as e:
    print(e)
```

This script will print out the identifiers of all DB instances that are in a public subnet.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of having RDS DB instances provisioned in VPC public subnets in AWS, follow these steps using the AWS Management Console:

1. **Identify RDS Instances in Public Subnets:**
   - Go to the AWS Management Console and navigate to the RDS service.
   - Click on "Databases" from the left-hand menu to view all your RDS instances.
   - Identify the RDS instances that are provisioned in VPC public subnets.

2. **Create New Private Subnet:**
   - Go to the VPC service in the AWS Management Console.
   - Click on "Subnets" from the left-hand menu.
   - Create a new private subnet within the same VPC where the RDS instances are located. Ensure that this subnet is not associated with a route table that has an internet gateway.

3. **Modify RDS Instance:**
   - Go back to the RDS service in the AWS Management Console.
   - Select the RDS instance that you want to move to the private subnet.
   - Click on the "Modify" button to change the subnet group.
   - In the "Network & Security" section, select the newly created private subnet from the "Subnet group" dropdown.
   - Click "Continue" and then "Modify DB Instance" to apply the changes.

4. **Verify the Changes:**
   - Wait for the modification process to complete. This may take a few minutes.
   - Once the modification is complete, verify that the RDS instance is now running in the private subnet.

5. **Update Security Group Rules:**
   - Update the security group associated with the RDS instance to allow necessary inbound and outbound traffic from other resources within the VPC.

By following these steps, you can remediate the misconfiguration of having RDS DB instances provisioned in VPC public subnets in AWS and ensure that they are running in private subnets for improved security.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of having RDS DB Instances provisioned in VPC public subnets in AWS using AWS CLI, follow these steps:

1. Identify the RDS DB Instances that are provisioned in VPC public subnets:
   
   Run the following AWS CLI command to list all RDS DB Instances in your AWS account:
   ```
   aws rds describe-db-instances
   ```
   Identify the RDS DB Instances that are provisioned in VPC public subnets by checking their `DBSubnetGroup` and `DBSubnetGroup.Subnets` values.

2. Create a new DB subnet group with private subnets:

   Create a new DB subnet group containing only private subnets where you want to move the RDS DB Instances. Replace `subnet-xxxxxxxxxxxxxx` with the IDs of your private subnets.
   ```
   aws rds create-db-subnet-group --db-subnet-group-name private-subnet-group --db-subnet-group-description "DB Subnet Group with Private Subnets" --subnet-ids subnet-xxxxxxxxxxxxxx subnet-xxxxxxxxxxxxxx
   ```

3. Modify the RDS DB Instances to use the new DB subnet group:

   Modify each RDS DB Instance to use the newly created DB subnet group. Replace `db-instance-identifier` with the identifier of the RDS DB Instance and `private-subnet-group` with the name of the new DB subnet group.
   ```
   aws rds modify-db-instance --db-instance-identifier db-instance-identifier --db-subnet-group-name private-subnet-group
   ```

4. Verify the changes:

   Run the following AWS CLI command to describe the modified RDS DB Instance and ensure that it is now using the new DB subnet group:
   ```
   aws rds describe-db-instances --db-instance-identifier db-instance-identifier
   ```

By following these steps, you can remediate the misconfiguration of having RDS DB Instances provisioned in VPC public subnets in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of having RDS DB Instances provisioned in VPC public subnets in AWS using Python, you can follow these steps:

1. Identify the RDS instances that are provisioned in the public subnets:
   
   ```python
   import boto3

   client = boto3.client('rds')

   response = client.describe_db_instances()

   for db_instance in response['DBInstances']:
       db_instance_id = db_instance['DBInstanceIdentifier']
       db_subnet_group = db_instance['DBSubnetGroup']['VpcId']
       db_instance_public = db_instance['PubliclyAccessible']

       if db_instance_public and db_subnet_group:
           print(f"RDS instance {db_instance_id} is provisioned in a public subnet.")
   ```

2. Modify the RDS instance to remove the public accessibility and move it to a private subnet:

   ```python
   db_instance_id = 'your_rds_instance_id'

   response = client.modify_db_instance(
       DBInstanceIdentifier=db_instance_id,
       PubliclyAccessible=False,
       ApplyImmediately=True
   )

   print(f"RDS instance {db_instance_id} has been modified to not be publicly accessible.")
   ```

3. Verify that the RDS instance is now in a private subnet:

   ```python
   response = client.describe_db_instances(DBInstanceIdentifier=db_instance_id)

   db_instance_public = response['DBInstances'][0]['PubliclyAccessible']
   db_subnet_group = response['DBInstances'][0]['DBSubnetGroup']['VpcId']

   if not db_instance_public and db_subnet_group:
       print(f"RDS instance {db_instance_id} is now in a private subnet.")
   ```

By following these steps and running the Python script, you can remediate the misconfiguration of having RDS DB Instances provisioned in VPC public subnets in AWS.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
