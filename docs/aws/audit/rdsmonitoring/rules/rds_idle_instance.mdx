---
slug: rds_idle_instance
title: RDS instances Should Not Be Idle
sidebar_label: RDS instances Should Not Be Idle
---

### More Info:

Identify any Amazon RDS database instances that appear to be idle and delete them to help lower the cost of your monthly AWS bill

### Risk Level

High

### Address

Reliability, Security

### Compliance Standards

HITRUST, SOC2, NISTCSF


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the RDS dashboard. 

2. In the navigation pane, choose "Databases". This will display a list of all your RDS instances.

3. Select the RDS instance you want to check. In the instance details section, look for the "Monitoring" tab.

4. In the Monitoring tab, check the "CPU Utilization" and "Database Connections" metrics. If the CPU Utilization is consistently low (near 0%) and there are no database connections over a prolonged period, the RDS instance might be idle.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all RDS instances: Use the following AWS CLI command to list all the RDS instances in your AWS account:

   ```
   aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier]'
   ```

   This command will return a list of all RDS instances in your AWS account.

3. Check the connection count: For each RDS instance, you can check the number of connections to it using the following AWS CLI command:

   ```
   aws cloudwatch get-metric-statistics --namespace AWS/RDS --metric-name DatabaseConnections --dimensions Name=DBInstanceIdentifier,Value=<DBInstanceIdentifier> --start-time <start-time> --end-time <end-time> --period 3600 --statistics Maximum
   ```

   Replace `<DBInstanceIdentifier>` with the identifier of the RDS instance you want to check, and `<start-time>` and `<end-time>` with the time period you want to check. This command will return the maximum number of connections to the RDS instance during the specified time period.

4. Analyze the results: If the maximum number of connections to an RDS instance is consistently low (or zero) over a long period of time, it indicates that the RDS instance is idle. You can then decide whether to keep it running or stop it to save costs.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary libraries: You will need the boto3 library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. 

```python
import boto3
from botocore.exceptions import BotoCoreError, ClientError
```

2. Create a session using your AWS credentials. You can configure credentials in several ways. You can load them from a .aws/credentials file, or from environment variables. 

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    aws_session_token='SESSION_TOKEN',
)
```

3. Create a client for RDS and get the list of all RDS instances.

```python
rds = session.client('rds')
try:
    response = rds.describe_db_instances()
except ClientError as e:
    print("Error in getting RDS instances: ", e)
```

4. Check the CPUUtilization and DatabaseConnections CloudWatch metrics for each RDS instance. If these metrics are consistently low over a significant period of time, the RDS instance might be idle. 

```python
cloudwatch = session.client('cloudwatch')

for instance in response['DBInstances']:
    instance_id = instance['DBInstanceIdentifier']
    metrics = ['CPUUtilization', 'DatabaseConnections']
    for metric in metrics:
        response = cloudwatch.get_metric_statistics(
            Namespace='AWS/RDS',
            MetricName=metric,
            Dimensions=[
                {
                    'Name': 'DBInstanceIdentifier',
                    'Value': instance_id
                },
            ],
            StartTime=datetime.datetime.utcnow() - datetime.timedelta(seconds=600),
            EndTime=datetime.datetime.utcnow(),
            Period=60,
            Statistics=['Average'],
        )
        if response['Datapoints']:
            avg_metric = response['Datapoints'][0]['Average']
            if avg_metric < 1:
                print(f"RDS instance {instance_id} might be idle. Average {metric} in the last 10 minutes: {avg_metric}")
```

This script will print out the IDs of the RDS instances that might be idle. You can adjust the threshold for the metrics and the time period as per your requirements.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of idle RDS instances in AWS using the AWS Management Console, follow these steps:

1. **Identify Idle RDS Instances**:
   - Log in to your AWS Management Console.
   - Go to the RDS service.
   - Click on "Databases" from the left-hand menu.
   - Identify the RDS instances that have been idle for a long time.

2. **Modify the Instance to Prevent Idleness**:
   - Select the idle RDS instance that you want to modify.
   - Click on the instance name to view its details.
   - Click on the "Modify" button.

3. **Adjust the Instance Settings**:
   - Increase the "Backup Retention Period" to ensure regular backups are taken.
   - Enable "Auto Minor Version Upgrade" to keep the instance updated.
   - Modify the "Maintenance Window" to schedule regular maintenance activities.

4. **Enable Enhanced Monitoring**:
   - Enable Enhanced Monitoring to collect metrics on the instance's performance.
   - This can help you identify any issues that may be causing idleness.

5. **Set up Alarms**:
   - Create CloudWatch Alarms to monitor the instance's CPU utilization, storage, and other metrics.
   - Set up notifications to alert you when the instance is idle or underutilized.

6. **Implement Database Activity Monitoring**:
   - Use AWS services like Amazon CloudWatch Logs or Amazon RDS Performance Insights to monitor database activity.
   - Analyze the data to identify any patterns of idleness and take necessary actions.

7. **Implement Automation**:
   - Utilize AWS Lambda functions or AWS Systems Manager Automation to automate tasks like stopping or resizing idle instances.
   - Set up a schedule to run these automation tasks regularly.

8. **Review and Optimize**:
   - Regularly review the performance metrics and logs of your RDS instances.
   - Optimize the instance configurations based on the usage patterns to prevent idleness.

By following these steps, you can remediate the issue of idle RDS instances in AWS and ensure that your resources are utilized efficiently.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of idle RDS instances in AWS using AWS CLI, you can set up a CloudWatch alarm to monitor the CPU utilization of the RDS instances and then take action when the CPU utilization falls below a certain threshold. Here are the step-by-step instructions:

1. **Create a CloudWatch Alarm**:
   - Use the following AWS CLI command to create a CloudWatch alarm that monitors the CPU utilization of the RDS instances:
     ```
     aws cloudwatch put-metric-alarm --alarm-name IdleRDSInstanceAlarm --alarm-description "Alarm for idle RDS instances" --metric-name CPUUtilization --namespace AWS/RDS --statistic Average --period 300 --threshold 10 --comparison-operator LessThanThreshold --evaluation-periods 1 --alarm-actions <ARN_of_SNS_Topic>
     ```
     - Replace `<ARN_of_SNS_Topic>` with the ARN of the SNS topic to which you want to send the alarm notifications.

2. **Modify the Alarm Actions**:
   - Modify the alarm actions to perform the necessary action when the alarm is triggered. For example, you can stop or delete the idle RDS instances. You can use the following AWS CLI command to update the alarm actions:
     ```
     aws cloudwatch put-metric-alarm --alarm-name IdleRDSInstanceAlarm --actions-enabled --alarm-actions <ARN_of_AWS_Lambda_Function>
     ```
     - Replace `<ARN_of_AWS_Lambda_Function>` with the ARN of the AWS Lambda function that performs the action on the RDS instances.

3. **Create an AWS Lambda Function** (if not already created):
   - Create an AWS Lambda function that stops or deletes the idle RDS instances. You can use the following AWS CLI command to create a Lambda function:
     ```
     aws lambda create-function --function-name StopIdleRDSInstances --runtime python3.8 --role <IAM_Role_for_Lambda_Function> --handler lambda_function.lambda_handler --code S3Bucket=<Bucket_Name>,S3Key=<Lambda_Zip_File>
     ```
     - Replace `<IAM_Role_for_Lambda_Function>` with the IAM role assigned to the Lambda function and `<Bucket_Name>` and `<Lambda_Zip_File>` with the S3 bucket name and Lambda zip file respectively.

4. **Update the Lambda Function**:
   - Update the Lambda function code to stop or delete the idle RDS instances based on the CloudWatch alarm triggers.

By following these steps, you can remediate the misconfiguration of idle RDS instances in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of idle RDS instances in AWS using Python, you can create a Lambda function that will check the status of RDS instances and stop the idle instances. Here are the step-by-step instructions to remediate this issue:

1. **Create an IAM Role**:
   - Create an IAM role with the necessary permissions to describe and stop RDS instances. Attach the following policies to the role:
     - `AmazonRDSReadOnlyAccess`: Allows read-only access to RDS instances.
     - `AmazonRDSFullAccess`: Allows full access to RDS instances (for stopping them).

2. **Create a Lambda Function**:
   - Go to the AWS Lambda console and create a new Lambda function.
   - Choose "Author from scratch" and configure the basic settings.
   - Under "Permissions", choose the IAM role created in step 1.
   - Write the Python code to describe RDS instances and stop the idle ones. Here's a sample code snippet:

   ```python
   import boto3

   def lambda_handler(event, context):
       rds = boto3.client('rds')
       instances = rds.describe_db_instances()

       for instance in instances['DBInstances']:
           if instance['DBInstanceStatus'] == 'available' and instance['DBInstanceIdentifier'] != 'your-excluded-instance':
               # Check for idle time and stop the instance if idle
               # Add your logic here to determine idle time

               rds.stop_db_instance(DBInstanceIdentifier=instance['DBInstanceIdentifier'])
   ```

3. **Set Up CloudWatch Event**:
   - Create a CloudWatch Event rule to trigger the Lambda function at a specific interval (e.g., every hour).
   - Configure the event rule to trigger the Lambda function.

4. **Test the Solution**:
   - Manually trigger the Lambda function to test if it stops the idle RDS instances successfully.

By following these steps, you can create a Python-based solution using AWS Lambda to remediate the issue of idle RDS instances in AWS. Make sure to customize the code to suit your specific requirements and include error handling to manage any unforeseen issues.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://aws.amazon.com/premiumsupport/technology/trusted-advisor/best-practice-checklist/](https://aws.amazon.com/premiumsupport/technology/trusted-advisor/best-practice-checklist/) 

