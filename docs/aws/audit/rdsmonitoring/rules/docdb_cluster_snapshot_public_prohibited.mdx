---
slug: docdb_cluster_snapshot_public_prohibited
title: DocumentDB Custer Snapshots Should Not Be Public
sidebar_label: DocumentDB Custer Snapshots Should Not Be Public
---
### More Info:

Checks if Amazon DocumentDB manual cluster snapshots are public. The rule is NON_COMPLIANT if any Amazon DocumentDB manual cluster snapshots are public.


### Risk Level

Medium

### Address

Observability

### Compliance Standards

CBP,SEBI


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent DocumentDB Cluster Snapshots from being public in Amazon RDS using the AWS Management Console, follow these steps:

1. **Navigate to the RDS Dashboard:**
   - Sign in to the AWS Management Console.
   - In the search bar, type "RDS" and select "RDS" from the dropdown to go to the Amazon RDS dashboard.

2. **Access Snapshots:**
   - In the left-hand navigation pane, click on "Snapshots" under the "Snapshots" section.

3. **Modify Snapshot Settings:**
   - Locate the DocumentDB cluster snapshot you want to check.
   - Select the snapshot by clicking the checkbox next to it.
   - Click on the "Actions" dropdown menu and select "Modify."

4. **Ensure Snapshot is Private:**
   - In the "Modify Snapshot" dialog, ensure that the "Public" option is not selected.
   - Confirm the changes by clicking the "Save" or "Modify" button.

By following these steps, you can ensure that your DocumentDB cluster snapshots are not publicly accessible, thereby enhancing the security of your data.
</Accordion>

<Accordion title='Using CLI'>
To prevent DocumentDB Cluster Snapshots from being public in Amazon RDS using the AWS CLI, you can follow these steps:

1. **Describe Snapshots to Identify Public Snapshots:**
   Use the `describe-db-cluster-snapshots` command to list all your DocumentDB cluster snapshots and identify any that are public.

   ```sh
   aws rds describe-db-cluster-snapshots --query 'DBClusterSnapshots[?PublicSnapshot==`true`].DBClusterSnapshotIdentifier'
   ```

2. **Modify Snapshot Attributes to Remove Public Access:**
   For each public snapshot identified in the previous step, use the `modify-db-cluster-snapshot-attribute` command to remove the `all` attribute, which makes the snapshot public.

   ```sh
   aws rds modify-db-cluster-snapshot-attribute --db-cluster-snapshot-identifier <snapshot-identifier> --attribute-name restore --values-to-remove all
   ```

3. **Automate the Process with a Script:**
   Create a script to automate the process of identifying and modifying public snapshots. Here is an example in Bash:

   ```sh
   #!/bin/bash

   # Get all public DocumentDB cluster snapshots
   public_snapshots=$(aws rds describe-db-cluster-snapshots --query 'DBClusterSnapshots[?PublicSnapshot==`true`].DBClusterSnapshotIdentifier' --output text)

   # Loop through each public snapshot and remove public access
   for snapshot in $public_snapshots; do
       aws rds modify-db-cluster-snapshot-attribute --db-cluster-snapshot-identifier $snapshot --attribute-name restore --values-to-remove all
       echo "Removed public access from snapshot: $snapshot"
   done
   ```

4. **Verify Changes:**
   After modifying the snapshot attributes, verify that there are no public snapshots remaining.

   ```sh
   aws rds describe-db-cluster-snapshots --query 'DBClusterSnapshots[?PublicSnapshot==`true`].DBClusterSnapshotIdentifier'
   ```

By following these steps, you can ensure that your DocumentDB cluster snapshots are not publicly accessible using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent DocumentDB Cluster Snapshots from being public in Amazon RDS using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps:

1. **Install Boto3**:
   Ensure you have Boto3 installed in your Python environment. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Initialize Boto3 Client**:
   Initialize the Boto3 client for RDS.
   ```python
   import boto3

   rds_client = boto3.client('rds')
   ```

3. **Describe DB Cluster Snapshots**:
   Retrieve the list of all DB cluster snapshots.
   ```python
   def get_db_cluster_snapshots():
       response = rds_client.describe_db_cluster_snapshots()
       return response['DBClusterSnapshots']
   ```

4. **Check and Modify Snapshot Attributes**:
   Check the attributes of each snapshot to ensure they are not public and modify them if necessary.
   ```python
   def ensure_snapshots_not_public():
       snapshots = get_db_cluster_snapshots()
       for snapshot in snapshots:
           snapshot_arn = snapshot['DBClusterSnapshotArn']
           attributes = rds_client.describe_db_cluster_snapshot_attributes(
               DBClusterSnapshotIdentifier=snapshot['DBClusterSnapshotIdentifier']
           )
           for attribute in attributes['DBClusterSnapshotAttributesResult']['DBClusterSnapshotAttributes']:
               if attribute['AttributeName'] == 'restore' and 'all' in attribute['AttributeValues']:
                   # Remove 'all' from the attribute values to make it private
                   rds_client.modify_db_cluster_snapshot_attribute(
                       DBClusterSnapshotIdentifier=snapshot['DBClusterSnapshotIdentifier'],
                       AttributeName='restore',
                       ValuesToRemove=['all']
                   )
                   print(f"Snapshot {snapshot['DBClusterSnapshotIdentifier']} is now private.")

   ensure_snapshots_not_public()
   ```

This script will ensure that all DocumentDB cluster snapshots are not public by removing the 'all' value from the 'restore' attribute, which makes the snapshot private.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon RDS console at https://console.aws.amazon.com/rds/.

2. In the navigation pane, choose "Snapshots". This will display a list of all the snapshots available in your AWS account.

3. Select the snapshot that you want to check. In the "Snapshot Details" section, look for the "Public" attribute. If the value of this attribute is "Yes", then the DocumentDB Cluster Snapshot is public.

4. To check all snapshots, repeat the process for each snapshot in the list. If any snapshot has the "Public" attribute set to "Yes", then it is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all DocumentDB Clusters: Use the following AWS CLI command to list all the DocumentDB clusters in your AWS account:

   ```
   aws docdb describe-db-clusters --query 'DBClusters[*].[DBClusterIdentifier]'
   ```
   This command will return a list of all DocumentDB cluster identifiers.

3. Check the Public Accessibility of each DocumentDB Cluster: For each DocumentDB cluster, check if it is publicly accessible by running the following command:

   ```
   aws docdb describe-db-clusters --db-cluster-identifier <DBClusterIdentifier> --query 'DBClusters[*].[DBClusterIdentifier,PubliclyAccessible]'
   ```
   Replace `<DBClusterIdentifier>` with the identifier of the DocumentDB cluster you want to check. This command will return the identifier of the cluster and a boolean value indicating whether the cluster is publicly accessible or not.

4. Identify Publicly Accessible Clusters: If the `PubliclyAccessible` field is `true`, then the DocumentDB cluster is publicly accessible, which is a misconfiguration. You should repeat step 3 for each DocumentDB cluster in your AWS account to ensure none of them are publicly accessible.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3):
   You need to install and configure Boto3 to interact with AWS services. You can install it using pip:
   ```
   pip install boto3
   ```
   Then, configure your AWS credentials to allow Boto3 to interact with AWS services on your behalf. You can do this by setting the following environment variables:
   ```
   AWS_ACCESS_KEY_ID='your_access_key'
   AWS_SECRET_ACCESS_KEY='your_secret_key'
   ```

2. Import necessary libraries and establish a session with AWS:
   You need to import Boto3 and establish a session with AWS. Here's how you can do it:
   ```python
   import boto3

   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='us-west-2'  # specify the region you are interested in
   )
   ```

3. Get a list of all DocumentDB clusters and their snapshots:
   You can use the `describe_db_clusters` and `describe_db_cluster_snapshots` methods to get a list of all DocumentDB clusters and their snapshots. Here's how you can do it:
   ```python
   client = session.client('rds')

   clusters = client.describe_db_clusters()
   for cluster in clusters['DBClusters']:
       snapshots = client.describe_db_cluster_snapshots(
           DBClusterIdentifier=cluster['DBClusterIdentifier']
       )
       for snapshot in snapshots['DBClusterSnapshots']:
           print(snapshot)
   ```

4. Check if the snapshots are public:
   You can use the `describe_db_snapshot_attributes` method to check if a snapshot is public. If the `PubliclyAccessible` attribute is set to `True`, then the snapshot is public. Here's how you can do it:
   ```python
   for snapshot in snapshots['DBClusterSnapshots']:
       attributes = client.describe_db_snapshot_attributes(
           DBSnapshotIdentifier=snapshot['DBClusterSnapshotIdentifier']
       )
       for attribute in attributes['DBSnapshotAttributesResult']['DBSnapshotAttributes']:
           if attribute['AttributeName'] == 'publicly_accessible':
               if attribute['AttributeValues'][0] == 'true':
                   print(f"Snapshot {snapshot['DBClusterSnapshotIdentifier']} is public")
   ```
   This script will print the identifiers of all public DocumentDB cluster snapshots.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of DocumentDB Cluster Snapshots being public in AWS RDS using the AWS Management Console, follow these steps:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/console/) and log in with your credentials.

2. **Navigate to DocumentDB Service**: Click on the "Services" dropdown menu at the top left corner of the console, then select "DocumentDB" under the Database category.

3. **Select DocumentDB Cluster**: From the DocumentDB dashboard, select the DocumentDB cluster for which you want to remediate the public snapshot issue.

4. **Modify Snapshot Settings**:
   - In the left-hand navigation pane, click on "Snapshots" to view the list of snapshots associated with the selected cluster.
   - Identify the public snapshot(s) that need to be remediated.
   - Select the public snapshot by clicking on the checkbox next to it.

5. **Update Snapshot Permissions**:
   - Click on the "Actions" dropdown menu above the list of snapshots.
   - Select "Modify Snapshot Attribute" from the dropdown menu.
   - In the Modify Snapshot Attribute window, uncheck the option for "Public" to make the snapshot private.
   - Click on the "Modify Snapshot Attribute" button to save the changes.

6. **Verify Changes**:
   - Once the modification is complete, verify that the snapshot is no longer public by checking the snapshot permissions.
   - You can also try accessing the snapshot URL to confirm that it is no longer accessible publicly.

7. **Repeat for Other Public Snapshots**: If there are multiple public snapshots across different clusters, repeat the above steps for each affected snapshot to ensure all snapshots are private.

By following these steps, you can remediate the issue of DocumentDB Cluster Snapshots being public in AWS RDS using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of DocumentDB Cluster Snapshots being public in AWS RDS, you can follow these steps using the AWS CLI:

Step 1: List all the DocumentDB Cluster Snapshots
```bash
aws rds describe-db-cluster-snapshots --query 'DBClusterSnapshots[*].[DBClusterSnapshotIdentifier]' --output text
```

Step 2: Modify the permissions of the DocumentDB Cluster Snapshots to make them private
```bash
aws rds modify-db-cluster-snapshot-attribute --db-cluster-snapshot-identifier <snapshot-identifier> --attribute-name restore --values-to-add all
```

Replace `<snapshot-identifier>` with the identifier of the DocumentDB Cluster Snapshot you want to modify.

Step 3: Verify that the permissions have been modified successfully
```bash
aws rds describe-db-cluster-snapshot-attributes --db-cluster-snapshot-identifier <snapshot-identifier>
```

Repeat steps 2 and 3 for each DocumentDB Cluster Snapshot that needs to be remediated.

By following these steps, you can ensure that your DocumentDB Cluster Snapshots are no longer public and have the appropriate permissions set to maintain the security of your AWS RDS resources.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of DocumentDB cluster snapshots being public in AWS RDS using Python, you can follow these steps:

1. **Identify the Public Snapshots**: Use the AWS SDK for Python (Boto3) to list all the DocumentDB cluster snapshots in your account and identify which snapshots are public.

2. **Modify Snapshot Permissions**: For each public snapshot identified, modify the permissions to make them private. You can do this by removing the "all" permission grants and adding specific AWS account IDs or IAM roles that should have access to the snapshots.

Here is a sample Python script to help you achieve this:

```python
import boto3

def remediate_public_snapshots():
    client = boto3.client('rds')

    # List all DocumentDB cluster snapshots
    response = client.describe_db_cluster_snapshots()

    for snapshot in response['DBClusterSnapshots']:
        snapshot_identifier = snapshot['DBClusterSnapshotIdentifier']
        snapshot_arn = snapshot['DBClusterSnapshotArn']
        
        # Check if the snapshot is public
        if snapshot['PubliclyAccessible']:
            print(f"Snapshot {snapshot_identifier} is public. Modifying permissions...")
            
            # Revoke public access
            response = client.modify_db_cluster_snapshot_attribute(
                DBClusterSnapshotIdentifier=snapshot_identifier,
                AttributeName='restore',
                ValuesToRemove=['all']
            )
            
            print(f"Snapshot {snapshot_identifier} permissions updated.")
        else:
            print(f"Snapshot {snapshot_identifier} is private.")

if __name__ == '__main__':
    remediate_public_snapshots()
```

Make sure to install the `boto3` library by running `pip install boto3` before executing the script.

This script will identify all public DocumentDB cluster snapshots and modify their permissions to make them private. Make sure to run this script with appropriate AWS credentials and permissions to modify the snapshot attributes.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

