---
slug: rds_encrypted_with_kms_cmks
title: Use Customer-Managed Keys instead of AWS-managed Keys
sidebar_label: Use Customer-Managed Keys instead of AWS-managed Keys
---

### More Info:

Your RDS database instances should be using KMS CMK customer-managed keys rather than AWS managed-keys in order to have more granular control over your data-at-rest encryption/decryption process.

### Risk Level

Medium

### Address

Security

### Compliance Standards

GDPR, NIST, AWSWAF, HITRUST, SOC2, NISTCSF, PCIDSS, FedRAMP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the RDS dashboard.

2. In the navigation pane, choose "Databases" to open the list of your RDS instances.

3. Select the RDS instance that you want to check. In the instance details section, look for the "KMS key" attribute. 

4. If the "KMS key" attribute value is "aws/rds", it means that the RDS instance is using AWS-managed keys. If it is a custom value, it means that the RDS instance is using customer-managed keys.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the RDS instances.

2. Once the AWS CLI is set up, you can list all the RDS instances in your account using the following command:

   ```
   aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier,KmsKeyId]'
   ```

   This command will return a list of all RDS instances along with their KMS key IDs. If the KMS key ID starts with 'arn:aws:kms', it means that the RDS instance is using a customer-managed key. If it starts with 'arn:aws:rds', it means that the RDS instance is using an AWS-managed key.

3. To check a specific RDS instance, you can use the following command:

   ```
   aws rds describe-db-instances --db-instance-identifier <your-db-instance-identifier> --query 'DBInstances[*].[DBInstanceIdentifier,KmsKeyId]'
   ```

   Replace `<your-db-instance-identifier>` with the identifier of your RDS instance. This command will return the KMS key ID of the specified RDS instance.

4. If you want to automate this process, you can write a Python script using the boto3 library, which is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python. This script can iterate over all RDS instances in your account and check their KMS key IDs.

#### Using Python

1. **Import necessary libraries**: The first step is to import the necessary libraries in your Python script. You will need the `boto3` library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
```

2. **Create a session**: The next step is to create a session using your AWS credentials. You can do this by using the `Session` function in the `boto3` library.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. **List all RDS instances**: Now, you can use the `client` function to create a low-level service client by the service name which is 'rds' in this case. Then, use the `describe_db_instances` function to get a list of all RDS instances.

```python
rds = session.client('rds')
response = rds.describe_db_instances()
```

4. **Check the key management**: Finally, iterate over each RDS instance and check the `KmsKeyId` attribute. If the `KmsKeyId` starts with `arn:aws:kms:`, it means that the RDS instance is using a customer-managed key. If it starts with `arn:aws:rds:`, it means that the RDS instance is using an AWS-managed key.

```python
for instance in response['DBInstances']:
    if instance['KmsKeyId'].startswith('arn:aws:kms:'):
        print(f"RDS instance {instance['DBInstanceIdentifier']} is using a customer-managed key.")
    else:
        print(f"RDS instance {instance['DBInstanceIdentifier']} is using an AWS-managed key.")
```

This script will print out the identifiers of all RDS instances and whether they are using a customer-managed key or an AWS-managed key.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of using AWS-managed keys instead of Customer-Managed Keys for AWS RDS using the AWS console, follow these steps:

1. **Create a Customer-Managed Key (CMK)**:
   - Go to the AWS Key Management Service (KMS) console.
   - Click on "Create key" to create a new CMK.
   - Choose the key creation method (Symmetric key or Asymmetric key) based on your requirements.
   - Define key administrative permissions and key usage permissions.
   - Click on "Finish" to create the CMK.

2. **Update the RDS Instance to use the Customer-Managed Key**:
   - Go to the Amazon RDS console.
   - Select the RDS instance for which you want to update the encryption key.
   - Click on "Modify" to modify the instance settings.
   - In the "Encryption" section, choose the option to encrypt using a Customer-Managed Key.
   - Select the Customer-Managed Key (CMK) that you created in step 1.
   - Click on "Continue" and review the changes.
   - Click on "Modify DB Instance" to apply the changes.

3. **Monitor the Encryption Key Update**:
   - Once you have modified the RDS instance to use the Customer-Managed Key, monitor the instance to ensure that the encryption key update is successful.
   - Check the RDS instance status and logs for any errors related to the encryption key update.
   - Verify that the RDS instance is using the Customer-Managed Key for encryption.

By following these steps, you can remediate the misconfiguration of using AWS-managed keys instead of Customer-Managed Keys for AWS RDS using the AWS console.

#### Using CLI

To remediate the misconfiguration of using AWS-managed keys for AWS RDS instances and switch to using Customer-Managed Keys, you can follow these steps using the AWS CLI:

1. **Create a Customer Managed Key (CMK)**:
   - Use the AWS Key Management Service (KMS) to create a new Customer Managed Key (CMK) if you don't already have one.
   - Run the following command to create a CMK:
     ```
     aws kms create-key --description "Customer Managed Key for RDS Encryption"
     ```
   - Note down the `KeyId` value from the output, as you will need it in the next steps.

2. **Enable encryption with the Customer Managed Key for the RDS instance**:
   - Modify the RDS instance to use the newly created CMK for encryption.
   - Run the following command to modify the RDS instance to use the Customer Managed Key:
     ```
     aws rds modify-db-instance --db-instance-identifier YOUR_DB_INSTANCE_IDENTIFIER --kms-key-id YOUR_CMK_KEY_ID
     ```
   - Replace `YOUR_DB_INSTANCE_IDENTIFIER` with the identifier of your RDS instance and `YOUR_CMK_KEY_ID` with the `KeyId` of the Customer Managed Key created in step 1.

3. **Verify the encryption settings**:
   - Confirm that the RDS instance is now using the Customer Managed Key for encryption.
   - Run the following command to describe the RDS instance and verify the encryption settings:
     ```
     aws rds describe-db-instances --db-instance-identifier YOUR_DB_INSTANCE_IDENTIFIER --query "DBInstances[*].KmsKeyId"
     ```
   - Ensure that the `KmsKeyId` returned in the output matches the `KeyId` of the Customer Managed Key.

4. **Monitor the RDS instance**:
   - Monitor the RDS instance to ensure that there are no issues after switching to Customer Managed Key encryption.
   - Check the RDS instance logs and performance metrics to ensure everything is functioning as expected.

By following these steps, you can remediate the misconfiguration of using AWS-managed keys for AWS RDS instances and switch to using Customer-Managed Keys successfully using the AWS CLI.

#### Using Python

To remediate this misconfiguration for AWS RDS using Python, you can follow these steps:

1. **Create a Customer-Managed Key (CMK) in AWS Key Management Service (KMS)**:
   - Use the `boto3` library in Python to create a new CMK in AWS KMS. Here is an example code snippet to create a CMK:

   ```python
   import boto3

   kms_client = boto3.client('kms')

   response = kms_client.create_key(
       Description='My Customer-Managed Key',
       KeyUsage='ENCRYPT_DECRYPT',
       Origin='AWS_KMS',
   )

   cmk_id = response['KeyMetadata']['KeyId']
   ```

2. **Update the RDS instance to use the Customer-Managed Key**:
   - Use the `boto3` library to modify the RDS instance to use the newly created CMK. Here is an example code snippet to update the RDS instance to use the CMK:

   ```python
   rds_client = boto3.client('rds')

   response = rds_client.modify_db_instance(
       DBInstanceIdentifier='your-rds-instance-id',
       KmsKeyId=cmk_id,
   )
   ```

3. **Verify the changes**:
   - You can verify that the RDS instance is now using the Customer-Managed Key by describing the RDS instance and checking the `KmsKeyId` attribute. Here is an example code snippet to describe the RDS instance:

   ```python
   response = rds_client.describe_db_instances(
       DBInstanceIdentifier='your-rds-instance-id',
   )

   kms_key_id = response['DBInstances'][0]['KmsKeyId']
   print(f"KMS Key ID used by RDS instance: {kms_key_id}")
   ```

By following these steps and running the Python code, you can remediate the misconfiguration by using a Customer-Managed Key instead of AWS-managed Keys for your AWS RDS instance.

### Additional Reading:

- [https://aws.amazon.com/blogs/database/securing-data-in-amazon-rds-using-aws-kms-encryption/](https://aws.amazon.com/blogs/database/securing-data-in-amazon-rds-using-aws-kms-encryption/) 


</Tab>
</Tabs>