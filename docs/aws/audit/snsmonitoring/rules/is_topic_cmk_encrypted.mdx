---
slug: is_topic_cmk_encrypted
title: SNS Topics Should Be Encrypted Using KMS CMKs
sidebar_label: SNS Topics Should Be Encrypted Using KMS CMKs
---

### More Info:

SNS Topics should be encrypted with Customer managed keys (CMK) instead of AWS managed keys in order to have a more granular control over the SNS data-at-rest encryption and decryption process.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HIPAA, HITRUST, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the Simple Notification Service (SNS) dashboard by selecting "Services" from the top menu, then typing "SNS" in the search box and selecting "Simple Notification Service".
3. In the SNS dashboard, select "Topics" from the left-hand navigation pane. This will display a list of all the SNS topics available within your AWS account.
4. For each topic in the list, check the "KMS master key" column. If the column is empty or displays "Default master key", it means the SNS topic is not encrypted using a KMS CMK, indicating a misconfiguration.

#### Using CLI

1. First, you need to list all the SNS topics in your AWS account. You can do this by using the following AWS CLI command:

   ```
   aws sns list-topics
   ```
   This command will return a list of all SNS topics in your AWS account.

2. Once you have the list of SNS topics, you can describe the attributes of each topic to check if they are encrypted using KMS CMKs. You can do this by using the following AWS CLI command:

   ```
   aws sns get-topic-attributes --topic-arn <TopicARN>
   ```
   Replace `<TopicARN>` with the ARN of the SNS topic you want to check. This command will return the attributes of the specified SNS topic.

3. From the output of the above command, check the `KmsMasterKeyId` attribute. If this attribute is present and has a value, it means that the SNS topic is encrypted using a KMS CMK.

4. Repeat steps 2 and 3 for each SNS topic in your AWS account. If any SNS topic does not have the `KmsMasterKeyId` attribute or if this attribute does not have a value, it means that the SNS topic is not encrypted using a KMS CMK.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3) on your local system. This will allow you to interact with AWS services including SNS.

```python
pip install boto3
aws configure
```

2. Create a Python script that lists all the SNS topics in your AWS account. Use the `list_topics` method from the SNS client in Boto3.

```python
import boto3

sns = boto3.client('sns')
response = sns.list_topics()
topics = response['Topics']
```

3. For each SNS topic, get the topic attributes using the `get_topic_attributes` method. This will return a dictionary with various attributes including the KMSMasterKeyId which indicates if the topic is encrypted with a KMS CMK.

```python
for topic in topics:
    topic_arn = topic['TopicArn']
    attributes = sns.get_topic_attributes(TopicArn=topic_arn)
    kms_key_id = attributes['Attributes'].get('KmsMasterKeyId')
    print(f'Topic ARN: {topic_arn}, KMS Key ID: {kms_key_id}')
```

4. If the KMSMasterKeyId is None or not present, then the SNS topic is not encrypted with a KMS CMK. You can add a check in your script to print a message or raise an exception when this is the case.

```python
for topic in topics:
    topic_arn = topic['TopicArn']
    attributes = sns.get_topic_attributes(TopicArn=topic_arn)
    kms_key_id = attributes['Attributes'].get('KmsMasterKeyId')
    if kms_key_id is None:
        print(f'Topic {topic_arn} is not encrypted with a KMS CMK.')
    else:
        print(f'Topic ARN: {topic_arn}, KMS Key ID: {kms_key_id}')
```

This script will help you detect SNS topics that are not encrypted with KMS CMKs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration in AWS:

1. Log in to your AWS Management Console.
2. Navigate to the Amazon SNS console.
3. Click on the SNS topic that you want to remediate.
4. Click on the "Encryption" tab.
5. Select "Enable encryption" option.
6. Select the KMS key that you want to use to encrypt the topic.
7. Click on "Update" to save the changes.

After following these steps, your SNS topic will be encrypted using the KMS CMKs.

#### Using CLI

To remediate this misconfiguration in AWS, you can follow these steps using AWS CLI:

1. Identify the SNS topics that are not encrypted using KMS CMKs by running the following command:
```
aws sns list-topics --query "Topics[?KmsMasterKeyId == null].TopicArn" --output text
```

2. For each topic identified in step 1, create a new KMS CMK or use an existing one.

3. Enable server-side encryption for the SNS topic by updating its properties with the following command:
```
aws sns set-topic-attributes --topic-arn <topic-arn> --attribute-name KmsMasterKeyId --attribute-value <kms-key-id>
```
Replace `<topic-arn>` with the ARN of the SNS topic and `<kms-key-id>` with the ARN of the KMS CMK created in step 2.

4. Verify that the SNS topic is now encrypted using KMS CMKs by running the following command:
```
aws sns list-topics --query "Topics[?KmsMasterKeyId != null].TopicArn" --output text
```
This command should return the ARN of the SNS topic that was just updated.

5. Repeat steps 3-4 for all the SNS topics that were identified in step 1.

By following these steps, you can remediate the misconfiguration of SNS topics not being encrypted using KMS CMKs in AWS.

#### Using Python

To remediate the misconfiguration of SNS Topics not being encrypted using KMS CMKs in AWS using Python, you can follow these steps:

1. First, you need to identify the SNS topic(s) that are not encrypted using KMS CMKs. You can use the AWS CLI or Boto3 library in Python to list all the SNS topics and their encryption status.

   ```python
   import boto3

   # Create an SNS client
   sns = boto3.client('sns')

   # List all SNS topics
   response = sns.list_topics()

   # Check encryption status for each topic
   for topic_arn in response['Topics']:
       topic_attributes = sns.get_topic_attributes(TopicArn=topic_arn['TopicArn'])
       if 'KmsMasterKeyId' not in topic_attributes['Attributes']:
           print(f"SNS topic {topic_arn['TopicArn']} is not encrypted using KMS CMKs")
   ```

2. Once you have identified the SNS topic(s) that are not encrypted using KMS CMKs, you can update their encryption settings using the `set_topic_attributes()` method in Boto3.

   ```python
   import boto3

   # Create an SNS client
   sns = boto3.client('sns')

   # Update encryption settings for a specific topic
   topic_arn = 'arn:aws:sns:us-east-1:123456789012:my-topic'
   response = sns.set_topic_attributes(
       TopicArn=topic_arn,
       AttributeName='KmsMasterKeyId',
       AttributeValue='arn:aws:kms:us-east-1:123456789012:key/abcd1234-5678-90ab-cdef-1234567890ab'
   )

   print(f"Encryption settings updated for SNS topic {topic_arn}")
   ```

   Note: Replace the `topic_arn` and `AttributeValue` with the appropriate values for your AWS account.

3. Finally, you can verify that the SNS topic(s) are now encrypted using KMS CMKs by running the first code snippet again and checking the encryption status for each topic.

   ```python
   import boto3

   # Create an SNS client
   sns = boto3.client('sns')

   # List all SNS topics
   response = sns.list_topics()

   # Check encryption status for each topic
   for topic_arn in response['Topics']:
       topic_attributes = sns.get_topic_attributes(TopicArn=topic_arn['TopicArn'])
       if 'KmsMasterKeyId' not in topic_attributes['Attributes']:
           print(f"SNS topic {topic_arn['TopicArn']} is not encrypted using KMS CMKs")
       else:
           print(f"SNS topic {topic_arn['TopicArn']} is encrypted using KMS CMKs")
   ```

   This should return a list of all SNS topics and their encryption status.

### Additional Reading:

- [https://docs.aws.amazon.com/sns/latest/dg/sns-server-side-encryption.html](https://docs.aws.amazon.com/sns/latest/dg/sns-server-side-encryption.html) 


</Tab>
</Tabs>