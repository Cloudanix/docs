---
slug: cmk_disabled_or_scheduled_for_deletion_alarm
title: CMK Disabled or Scheduled for Deletion Alarm
sidebar_label: CMK Disabled or Scheduled for Deletion Alarm
---

### More Info:

AWS CMK configuration changes should be monitored using CloudWatch alarms.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HIPAA, ISO27001, CISAWS, CBP, NISTCSF


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.

2. In the navigation pane, click on "Alarms".

3. In the "Alarms" dashboard, you can see all the alarms that have been set up. Look for the CMK Disabled or Scheduled for Deletion Alarm. If it's not there, it means it hasn't been set up.

4. To confirm the status of the alarm, click on the alarm name. In the "Alarm details" section, you can see the state of the alarm. If the state is "INSUFFICIENT_DATA", it means the alarm has not been triggered. If the state is "ALARM", it means the alarm has been triggered. If the state is "OK", it means the alarm is set up correctly and the condition it's monitoring is within the defined threshold.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all CloudWatch alarms: Use the following AWS CLI command to list all the CloudWatch alarms in your AWS account:

   ```
   aws cloudwatch describe-alarms
   ```
   This command will return a list of all the alarms along with their details.

3. Filter CMK Disabled or Scheduled for Deletion alarms: You can filter the list of alarms to only show the ones related to CMK Disabled or Scheduled for Deletion. This can be done by using the `--query` parameter in the AWS CLI command:

   ```
   aws cloudwatch describe-alarms --query 'MetricAlarms[?AlarmName==`CMK Disabled` || AlarmName==`CMK Scheduled for Deletion`]'
   ```
   This command will return a list of alarms with the names 'CMK Disabled' or 'CMK Scheduled for Deletion'.

4. Check the state of the alarms: The state of the alarms can tell you whether the CMK is disabled or scheduled for deletion. You can check the state of the alarms by looking at the 'StateValue' field in the output of the previous command. If the 'StateValue' is 'ALARM', it means that the CMK is either disabled or scheduled for deletion.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary AWS SDK for Python (Boto3) if you haven't done so already. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials:

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. Use the CloudWatch client from the session to list all the alarms:

```python
cloudwatch = session.client('cloudwatch')

def list_alarms():
    alarms = cloudwatch.describe_alarms()
    return alarms['MetricAlarms']
```

4. Check each alarm to see if it's for a CMK that's disabled or scheduled for deletion:

```python
def check_cmk_alarms():
    alarms = list_alarms()
    for alarm in alarms:
        if 'CMK' in alarm['AlarmName'] and ('Disabled' in alarm['AlarmName'] or 'ScheduledForDeletion' in alarm['AlarmName']):
            print(f"Alarm {alarm['AlarmName']} is set for a CMK that's disabled or scheduled for deletion.")
```

This script will print out the names of any alarms that are set for a CMK that's either disabled or scheduled for deletion. Note that this script assumes that the alarm names include the string 'CMK' and either 'Disabled' or 'ScheduledForDeletion'. If your alarm names are different, you'll need to adjust the script accordingly.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the CMK Disabled or Scheduled for Deletion alarm in AWS using the AWS console, you can follow the below steps:

1. Login to your AWS account and navigate to the AWS KMS console.

2. Click on the "Customer managed keys" option from the left-hand side menu.

3. Identify the key that is disabled or scheduled for deletion.

4. To enable a disabled key, select the key and click on the "Enable" button from the top menu. 

5. To cancel the scheduled deletion of a key, select the key and click on the "Cancel key deletion" button from the top menu.

6. After completing the above steps, verify that the key status has changed to "Enabled" or "Pending import" and the alarm should automatically clear.

7. If the alarm does not clear, check the SNS topic that is associated with the alarm to ensure that it is configured correctly.

By following these steps, you can remediate the CMK Disabled or Scheduled for Deletion alarm in AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
The CMK (Customer Master Key) Disabled or Scheduled for Deletion alarm indicates that a CMK in AWS has been disabled or scheduled for deletion. This misconfiguration can lead to data loss or unauthorized access to encrypted data. Here are the steps to remediate this issue using AWS CLI:

1. Identify the CMK that has been disabled or scheduled for deletion. You can use the following command to list all the CMKs in your AWS account:

```
aws kms list-keys
```

2. Check the status of each CMK to identify the one that has been disabled or scheduled for deletion. You can use the following command to describe the key state of a CMK:

```
aws kms describe-key --key-id <key-id>
```

Replace `<key-id>` with the ID of the CMK that you want to check.

3. Reactivate the disabled CMK or cancel the scheduled deletion of the CMK. You can use the following command to enable a disabled CMK:

```
aws kms enable-key --key-id <key-id>
```

Replace `<key-id>` with the ID of the disabled CMK that you want to enable.

4. If the CMK has been scheduled for deletion, you can cancel the deletion using the following command:

```
aws kms cancel-key-deletion --key-id <key-id>
```

Replace `<key-id>` with the ID of the CMK that you want to cancel the deletion for.

5. Verify that the CMK is active and not scheduled for deletion. You can use the following command to describe the key state of the CMK again:

```
aws kms describe-key --key-id <key-id>
```

Replace `<key-id>` with the ID of the CMK that you want to verify.

Once you have completed these steps, the CMK Disabled or Scheduled for Deletion alarm should be resolved. It is recommended to regularly monitor your AWS account for this type of misconfiguration and take necessary actions to remediate it.
</Accordion>

<Accordion title='Using Python'>
To remediate the CMK Disabled or Scheduled for Deletion Alarm in AWS using Python, you can follow the below steps:

1. First, you need to check the status of the CMK using the `describe_key` method of the AWS KMS client. This method returns the metadata for the specified customer master key (CMK).

   ```python
   import boto3

   # Create a KMS client
   kms = boto3.client('kms')

   # Get the CMK metadata
   key_id = 'your-cmk-id'
   key_metadata = kms.describe_key(KeyId=key_id)
   ```

2. Check the `KeyState` attribute of the CMK metadata. If it is set to `Disabled` or `PendingDeletion`, then the CMK is disabled or scheduled for deletion.

   ```python
   key_state = key_metadata['KeyMetadata']['KeyState']

   if key_state == 'Disabled':
       # Enable the CMK
       kms.enable_key(KeyId=key_id)
       print('CMK enabled successfully.')
   elif key_state == 'PendingDeletion':
       # Cancel the scheduled deletion of the CMK
       kms.cancel_key_deletion(KeyId=key_id)
       print('Scheduled deletion of CMK cancelled successfully.')
   else:
       print('CMK is already enabled and not scheduled for deletion.')
   ```

3. If the `KeyState` attribute is not set to `Disabled` or `PendingDeletion`, then the CMK is already enabled and not scheduled for deletion.

   ```python
   else:
       print('CMK is already enabled and not scheduled for deletion.')
   ```

By following these steps, you can remediate the CMK Disabled or Scheduled for Deletion Alarm in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/deleting-keys-creating-cloudwatch-alarm.html](https://docs.aws.amazon.com/kms/latest/developerguide/deleting-keys-creating-cloudwatch-alarm.html) 

