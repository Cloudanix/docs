---
slug: metric_filter_for_vpc_flow_logs
title: Metric Filter for VPC Flow Logs CloudWatch Log Group
sidebar_label: Metric Filter for VPC Flow Logs CloudWatch Log Group
---

### More Info:

A log metric filter for the CloudWatch group assigned to the VPC Flow Logs should be created.

### Risk Level

High

### Address

Security

### Compliance Standards

GDPR



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.

2. In the navigation pane, click on 'Log groups'. This will display a list of all your log groups.

3. Search for the log group that corresponds to your VPC Flow Logs. The name of this log group usually follows the format '/aws/vpc/flow-logs'.

4. Once you've selected the appropriate log group, click on it to view its details. Here, you can check for any existing metric filters. If there are any metric filters applied to the log group, they will be listed under the 'Metric Filters' tab. If there are no metric filters, this area will be blank.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is set up, you can use the `describe-log-groups` command to list all the CloudWatch Log Groups. The command is as follows:

   ```
   aws logs describe-log-groups
   ```
   This command will return a list of all your log groups. Look for the VPC Flow Logs CloudWatch Log Group in the output.

3. After identifying the VPC Flow Logs CloudWatch Log Group, you can use the `describe-metric-filters` command to list all the metric filters associated with this log group. Replace 'log-group-name' with the name of your VPC Flow Logs CloudWatch Log Group:

   ```
   aws logs describe-metric-filters --log-group-name 'log-group-name'
   ```
   This command will return a list of all the metric filters associated with the specified log group.

4. Review the output of the `describe-metric-filters` command. If there are no metric filters for the VPC Flow Logs CloudWatch Log Group, it means that the metric filter for VPC Flow Logs is not configured. If there are metric filters, check their configurations to ensure they are set up correctly.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3) on your local system. This will allow you to interact with AWS services using Python.

```python
pip install boto3
aws configure
```

2. Create a Python script that uses Boto3 to interact with CloudWatch. The script will list all the log groups and then check if there is a metric filter associated with the VPC Flow Logs log group.

```python
import boto3

# Create CloudWatch client
cloudwatch = boto3.client('logs')

# List all log groups
response = cloudwatch.describe_log_groups()

# Check for metric filter in each log group
for log_group in response['logGroups']:
    if 'vpc' in log_group['logGroupName'].lower():
        metric_filters = cloudwatch.describe_metric_filters(
            logGroupName=log_group['logGroupName']
        )
        if not metric_filters['metricFilters']:
            print(f"No metric filter found for {log_group['logGroupName']}")
```

3. Run the Python script. If there are any log groups related to VPC Flow Logs that do not have a metric filter, they will be printed out.

```python
python check_metric_filter.py
```

4. Review the output. If the script prints out any log groups, this indicates a misconfiguration. You should have a metric filter associated with your VPC Flow Logs log group in CloudWatch. If no log groups are printed, this means all your VPC Flow Logs log groups have a metric filter, which is the correct configuration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, Here are the step-by-step instructions to remediate a Metric Filter for VPC Flow Logs CloudWatch Log Group misconfiguration in AWS:

1. Open the AWS Management Console and navigate to the CloudWatch service.

2. In the CloudWatch dashboard, click on the "Log groups" option from the left-hand side menu.

3. Locate the VPC Flow Logs log group that has the misconfigured metric filter and click on it.

4. From the list of log streams, identify the stream(s) that have the misconfigured metric filter.

5. Click on the "Actions" button and select "Delete metric filter" from the dropdown menu.

6. In the confirmation window, click on the "Delete" button to remove the metric filter.

7. To create a new metric filter, click on the "Create metric filter" button.

8. In the "Create metric filter" window, enter a name for the new metric filter and specify the filter pattern that matches the log events you want to track.

9. Under "Metric details", select the "Create new metric" option and enter a name for the metric.

10. Specify the metric namespace, metric name, and metric value.

11. Click on the "Create filter" button to save the new metric filter.

12. Verify that the new metric filter is working correctly by checking the CloudWatch Metrics dashboard for the specified metric.

By following these steps, you can remediate the Metric Filter for VPC Flow Logs CloudWatch Log Group misconfiguration in AWS using the AWS console.

#### Using CLI

To remediate the misconfiguration of Metric Filter for VPC Flow Logs CloudWatch Log Group in AWS, you can follow these steps using AWS CLI:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the existing metric filters for the specified CloudWatch log group:

   ```
   aws logs describe-metric-filters --log-group-name <log-group-name>
   ```

   Replace `<log-group-name>` with the name of the CloudWatch log group that contains the VPC flow logs.

3. Identify the metric filter that is misconfigured and note down its filter name.

4. Run the following command to delete the misconfigured metric filter:

   ```
   aws logs delete-metric-filter --log-group-name <log-group-name> --filter-name <filter-name>
   ```

   Replace `<log-group-name>` with the name of the CloudWatch log group that contains the VPC flow logs and `<filter-name>` with the name of the misconfigured metric filter.

5. Run the following command to create a new metric filter for the VPC flow logs:

   ```
   aws logs put-metric-filter --log-group-name <log-group-name> --filter-name <filter-name> --metric-transformations metricName=<metric-name>,metricNamespace=<metric-namespace>,metricValue=1 --filter-pattern '{ ($.eventSource = "vpc-flow") }'
   ```

   Replace `<log-group-name>` with the name of the CloudWatch log group that contains the VPC flow logs, `<filter-name>` with a name for the new metric filter, `<metric-name>` with a name for the metric, `<metric-namespace>` with a namespace for the metric, and `{ ($.eventSource = "vpc-flow") }` with the filter pattern for the VPC flow logs.

6. Verify that the new metric filter is created by running the following command:

   ```
   aws logs describe-metric-filters --log-group-name <log-group-name>
   ```

   Replace `<log-group-name>` with the name of the CloudWatch log group that contains the VPC flow logs. You should see the new metric filter listed in the output. 

Your misconfiguration of Metric Filter for VPC Flow Logs CloudWatch Log Group in AWS is now remediated.

#### Using Python

To remediate the misconfiguration of a missing metric filter for VPC Flow Logs CloudWatch Log Group in AWS using Python, you can follow these steps:

1. First, you need to import the Boto3 library for Python to interact with AWS services. You can do this by running the following command:

```python
import boto3
```

2. Next, you need to create a CloudWatch Logs client using the Boto3 library. You can do this by running the following command:

```python
client = boto3.client('logs')
```

3. Then, you need to check if there is a metric filter for the VPC Flow Logs CloudWatch Log Group. You can do this by running the following command:

```python
response = client.describe_metric_filters(
    logGroupName='/aws/vpc/flowlogs/<YOUR_FLOW_LOG_GROUP>',
    filterNamePrefix='<YOUR_METRIC_FILTER_NAME>'
)
```

Replace `<YOUR_FLOW_LOG_GROUP>` with the name of your VPC Flow Logs CloudWatch Log Group and `<YOUR_METRIC_FILTER_NAME>` with the name of your metric filter.

4. If the response returns an empty `metricFilters` list, it means that there is no metric filter for the VPC Flow Logs CloudWatch Log Group. In this case, you need to create a metric filter. You can do this by running the following command:

```python
response = client.put_metric_filter(
    logGroupName='/aws/vpc/flowlogs/<YOUR_FLOW_LOG_GROUP>',
    filterName='<YOUR_METRIC_FILTER_NAME>',
    filterPattern='<YOUR_FILTER_PATTERN>',
    metricTransformations=[
        {
            'metricName': '<YOUR_METRIC_NAME>',
            'metricNamespace': '<YOUR_METRIC_NAMESPACE>',
            'metricValue': '<YOUR_METRIC_VALUE>'
        }
    ]
)
```

Replace `<YOUR_FLOW_LOG_GROUP>` with the name of your VPC Flow Logs CloudWatch Log Group, `<YOUR_METRIC_FILTER_NAME>` with the name of your metric filter, `<YOUR_FILTER_PATTERN>` with the filter pattern that you want to use, `<YOUR_METRIC_NAME>` with the name of the metric that you want to create, `<YOUR_METRIC_NAMESPACE>` with the namespace for the metric, and `<YOUR_METRIC_VALUE>` with the value for the metric.

5. Finally, you can verify that the metric filter has been created by running the `describe_metric_filters` command again and checking that the `metricFilters` list is not empty.

By following these steps, you can remediate the missing metric filter for VPC Flow Logs CloudWatch Log Group in AWS using Python.

### Additional Reading:

- [https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-cwl.html) 


</Tab>
</Tabs>