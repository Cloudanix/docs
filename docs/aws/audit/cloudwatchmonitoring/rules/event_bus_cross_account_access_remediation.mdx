
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EventBus from allowing cross-account access in CloudWatch using the AWS Management Console, follow these steps:

1. **Navigate to CloudWatch:**
   - Open the AWS Management Console.
   - In the search bar, type "CloudWatch" and select it from the list of services.

2. **Access Event Buses:**
   - In the CloudWatch dashboard, on the left-hand side, click on "Events" or "EventBridge" (depending on the AWS region and interface updates).
   - Select "Event buses" from the submenu.

3. **Review Permissions:**
   - Click on the name of the EventBus you want to review.
   - Go to the "Permissions" tab to see the current permissions set for the EventBus.

4. **Modify Policy:**
   - If there are any policies that allow cross-account access, click on the "Edit" button.
   - Remove or modify any statements that grant permissions to other AWS accounts.
   - Ensure that only trusted accounts or specific IAM roles within your account have access.

By following these steps, you can ensure that your EventBus does not allow cross-account access, thereby enhancing the security of your CloudWatch events.
</Accordion>

<Accordion title='Using CLI'>
To prevent an EventBus from allowing cross-account access in AWS CloudWatch using the AWS CLI, you can follow these steps:

1. **Describe the Current EventBus Policy:**
   First, you need to check the current policy attached to your EventBus to understand its current permissions.
   ```sh
   aws events describe-event-bus --name <EventBusName>
   ```

2. **Create a Secure Policy:**
   Create a JSON file (e.g., `secure-policy.json`) with a policy that restricts cross-account access. Ensure that the policy only allows access from trusted accounts or specific IAM roles within your account.
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": "arn:aws:iam::<YourAccountID>:root"
         },
         "Action": "events:PutEvents",
         "Resource": "arn:aws:events:<Region>:<YourAccountID>:event-bus/<EventBusName>"
       }
     ]
   }
   ```

3. **Apply the Secure Policy to the EventBus:**
   Use the `put-permission` command to apply the new policy to your EventBus.
   ```sh
   aws events put-permission --event-bus-name <EventBusName> --policy file://secure-policy.json
   ```

4. **Verify the Policy Update:**
   Finally, verify that the new policy has been applied correctly by describing the EventBus again.
   ```sh
   aws events describe-event-bus --name <EventBusName>
   ```

By following these steps, you can ensure that your EventBus does not allow cross-account access, thereby enhancing the security of your AWS CloudWatch setup.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of allowing cross-account access to an EventBus in AWS CloudWatch using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   Ensure you have Boto3 installed and configured with the necessary permissions to manage CloudWatch EventBuses.

   ```bash
   pip install boto3
   ```

2. **Create a Python Script to Describe EventBuses:**
   Use Boto3 to list and describe the EventBuses in your account. This will help you identify any EventBuses that might have cross-account permissions.

   ```python
   import boto3

   client = boto3.client('events')

   def list_event_buses():
       response = client.list_event_buses()
       return response['EventBuses']

   event_buses = list_event_buses()
   for bus in event_buses:
       print(bus['Name'])
   ```

3. **Check and Update EventBus Policy:**
   Write a function to check the policy of each EventBus and ensure it does not allow cross-account access. If it does, update the policy to restrict access.

   ```python
   def get_event_bus_policy(event_bus_name):
       try:
           response = client.describe_event_bus(Name=event_bus_name)
           return response.get('Policy', None)
       except client.exceptions.ResourceNotFoundException:
           return None

   def update_event_bus_policy(event_bus_name):
       policy = {
           "Version": "2012-10-17",
           "Statement": [
               {
                   "Effect": "Allow",
                   "Principal": {
                       "AWS": "arn:aws:iam::YOUR_ACCOUNT_ID:root"
                   },
                   "Action": "events:PutEvents",
                   "Resource": f"arn:aws:events:YOUR_REGION:YOUR_ACCOUNT_ID:event-bus/{event_bus_name}"
               }
           ]
       }
       client.put_permission(
           EventBusName=event_bus_name,
           Action='events:PutEvents',
           Principal='arn:aws:iam::YOUR_ACCOUNT_ID:root',
           StatementId='ID-1'
       )

   for bus in event_buses:
       policy = get_event_bus_policy(bus['Name'])
       if policy:
           # Check if the policy allows cross-account access
           # If it does, update the policy
           update_event_bus_policy(bus['Name'])
   ```

4. **Automate the Script Execution:**
   Schedule the script to run periodically using a cron job or AWS Lambda to ensure continuous compliance.

   ```python
   import boto3
   import json

   client = boto3.client('events')

   def list_event_buses():
       response = client.list_event_buses()
       return response['EventBuses']

   def get_event_bus_policy(event_bus_name):
       try:
           response = client.describe_event_bus(Name=event_bus_name)
           return response.get('Policy', None)
       except client.exceptions.ResourceNotFoundException:
           return None

   def update_event_bus_policy(event_bus_name):
       policy = {
           "Version": "2012-10-17",
           "Statement": [
               {
                   "Effect": "Allow",
                   "Principal": {
                       "AWS": "arn:aws:iam::YOUR_ACCOUNT_ID:root"
                   },
                   "Action": "events:PutEvents",
                   "Resource": f"arn:aws:events:YOUR_REGION:YOUR_ACCOUNT_ID:event-bus/{event_bus_name}"
               }
           ]
       }
       client.put_permission(
           EventBusName=event_bus_name,
           Action='events:PutEvents',
           Principal='arn:aws:iam::YOUR_ACCOUNT_ID:root',
           StatementId='ID-1'
       )

   def main():
       event_buses = list_event_buses()
       for bus in event_buses:
           policy = get_event_bus_policy(bus['Name'])
           if policy:
               # Check if the policy allows cross-account access
               # If it does, update the policy
               update_event_bus_policy(bus['Name'])

   if __name__ == "__main__":
       main()
   ```

Replace `YOUR_ACCOUNT_ID` and `YOUR_REGION` with your actual AWS account ID and region. This script will help ensure that your EventBuses do not allow cross-account access by updating their policies accordingly.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.

2. In the navigation pane, choose "Events", then "Event buses".

3. In the Event buses list, select the event bus that you want to check.

4. In the Permissions tab, check the "Cross-account principals" section. If there are any AWS accounts or AWS organizations listed here, it means the event bus allows cross-account access.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account details. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, default region name, and default output format.

2. List all the Event Buses: Use the following AWS CLI command to list all the Event Buses in your account:

   ```
   aws events list-event-buses
   ```
   This command will return a list of all the Event Buses in your account.

3. Check the policy of each Event Bus: For each Event Bus, you need to check its policy to see if it allows cross-account access. You can do this by running the following command:

   ```
   aws events describe-event-bus --name <event-bus-name>
   ```
   Replace `<event-bus-name>` with the name of your Event Bus. This command will return the details of the specified Event Bus, including its policy.

4. Analyze the policy: The policy of the Event Bus is returned in JSON format. You need to analyze this policy to see if it allows cross-account access. Specifically, you need to look for any statements in the policy that have `"Effect": "Allow"` and `"Principal": {"AWS": "*"}`. If such statements exist, it means that the Event Bus allows cross-account access.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) in your environment. This can be done using pip:

   ```bash
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can do this by setting the following environment variables:

   ```bash
   export AWS_ACCESS_KEY_ID='your_access_key'
   export AWS_SECRET_ACCESS_KEY='your_secret_key'
   ```

3. Write a Python script to check EventBus permissions: The following Python script uses Boto3 to retrieve all the EventBus policies and checks if any of them allow cross-account access.

   ```python
   import boto3

   def check_eventbus_cross_account_access():
       client = boto3.client('events')
       response = client.list_event_buses()
       for event_bus in response['EventBuses']:
           policy = event_bus.get('Policy')
           if policy:
               policy = json.loads(policy)
               for statement in policy['Statement']:
                   if 'AWS' in statement['Principal'] and statement['Principal']['AWS'] != 'arn:aws:iam::' + account_id + ':root':
                       print(f"EventBus {event_bus['Name']} allows cross-account access")

   check_eventbus_cross_account_access()
   ```

4. Run the Python script: You can run the Python script from your terminal. If there are any EventBus that allow cross-account access, they will be printed out.

   ```bash
   python check_eventbus_cross_account_access.py
   ```

Please replace 'your_access_key' and 'your_secret_key' with your actual AWS access key and secret key. Also, replace 'account_id' with your actual AWS account ID.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the "EventBus Should Not Allow Cross Account Access" misconfiguration in AWS using the AWS console, follow these steps:

1. Login to the AWS Management Console.
2. Navigate to the Amazon EventBridge service.
3. Select the Event Bus that is allowing cross-account access.
4. Click on the "Permissions" tab.
5. In the "Event bus policies" section, click on the "Edit" button.
6. Remove any statements that grant cross-account access to the Event Bus.
7. Add a new statement that only allows access from the AWS account(s) that require access to the Event Bus.
8. Click on the "Save" button to apply the changes.

After following these steps, the Event Bus will no longer allow cross-account access and will only allow access from the specified AWS account(s).

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the "EventBus Should Not Allow Cross Account Access" misconfiguration in AWS using AWS CLI, follow these steps:

1. Open your terminal or command prompt and ensure that you have the AWS CLI installed and configured with the appropriate credentials.

2. Run the following command to list all the Amazon EventBridge event buses in your AWS account:

   ```
   aws events list-event-buses
   ```

3. Identify the event bus that is allowing cross-account access.

4. Run the following command to modify the event bus policy and restrict cross-account access:

   ```
   aws events put-policy --event-bus-name <event-bus-name> --policy '{"Statement":[{"Sid":"RestrictCrossAccountAccess","Effect":"Deny","Principal":"*","Action":"events:PutEvents","Resource":"arn:aws:events:<region>:<account-id>:event-bus/<event-bus-name>"}]}'
   ```

   Replace `<event-bus-name>` with the name of the event bus that is allowing cross-account access, `<region>` with the AWS region where the event bus is located, and `<account-id>` with your AWS account ID.

5. Verify that the policy has been updated by running the following command:

   ```
   aws events describe-event-bus --name <event-bus-name>
   ```

   The output should show the updated policy with the `Deny` statement.

6. Repeat steps 3-5 for any other event buses that are allowing cross-account access.

By following these steps, you have successfully remediated the "EventBus Should Not Allow Cross Account Access" misconfiguration in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "EventBus Should Not Allow Cross Account Access" in AWS, you can follow the below steps in Python:

1. Create a new EventBridge event bus policy that allows access only to the specific AWS account that should have access to the event bus. 

```python
import boto3
import json

eventbridge = boto3.client('events')

account_id = boto3.client('sts').get_caller_identity().get('Account')

policy = {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowAccountAccess",
            "Effect": "Allow",
            "Principal": {
                "AWS": f"arn:aws:iam::{account_id}:root"
            },
            "Action": "events:*",
            "Resource": "arn:aws:events:us-east-1:<account_id>:event-bus/default"
        }
    ]
}

policy_json = json.dumps(policy)

eventbridge.put_permission(
    Action='events:PutEvents',
    Principal='*',
    StatementId='AllowAccountAccess',
    Condition={
        'ArnEquals': {
            'aws:SourceArn': f'arn:aws:events:us-east-1:<account_id>:event-bus/default'
        }
    }
)

eventbridge.put_event_bus_policy(
    EventBusName='default',
    Policy=policy_json
)
```

2. Remove any existing event bus policies that allow cross-account access. 

```python
policy = {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DenyCrossAccountAccess",
            "Effect": "Deny",
            "Principal": "*",
            "Action": "events:*",
            "Resource": "arn:aws:events:us-east-1:<account_id>:event-bus/default",
            "Condition": {
                "StringNotEquals": {
                    "aws:PrincipalAccount": "<account_id>"
                }
            }
        }
    ]
}

policy_json = json.dumps(policy)

eventbridge.put_event_bus_policy(
    EventBusName='default',
    Policy=policy_json
)
```

3. Verify that the event bus policy now only allows access to the specific AWS account that should have access to the event bus.

```python
policy = eventbridge.describe_event_bus(
    Name='default'
)['Policy']

print(policy)
```

This should remediate the "EventBus Should Not Allow Cross Account Access" misconfiguration in AWS.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
