
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the AWS Firewall Manager service.

2. In the Firewall Manager dashboard, click on "AWS Shield Advanced" on the left-hand side menu.

3. In the AWS Shield Advanced page, click on "Resource policies". 

4. Here, you can see all the resource policies. Check if the FMS Shield Resource Policy is enabled or not. If it's not enabled, it indicates a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local system. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all policies: Use the following AWS CLI command to list all the policies in your AWS account.

   ```
   aws fms list-policies --region your-region-name
   ```

   Replace 'your-region-name' with the name of your AWS region. This command will return a list of all FMS policies in your account.

3. Check for Shield Resource Policy: Look for a policy with the name "AWSManagedRulesShieldAdvancedProtectorsRuleSet". This is the AWS Shield Resource policy. If this policy is not present in the list, it means that the FMS Shield Resource Policy is not enabled.

4. Check policy status: If the policy is present, you can check its status using the following command:

   ```
   aws fms get-policy --policy-id your-policy-id --region your-region-name
   ```

   Replace 'your-policy-id' with the ID of the Shield Resource policy and 'your-region-name' with the name of your AWS region. This command will return the details of the policy, including its status. If the status is 'ENABLED', it means that the FMS Shield Resource Policy is enabled. If the status is 'DISABLED', it means that the policy is not enabled.
</Accordion>

<Accordion title='Using Python'>
To check if FMS Shield Resource Policy is enabled in CloudWatch using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps:

1. **Setup AWS SDK for Python (Boto3):**
   First, you need to install and configure Boto3. You can install it using pip:

   ```
   pip install boto3
   ```

   Then, configure your AWS credentials. You can do this by setting the following environment variables:

   ```
   AWS_ACCESS_KEY_ID = 'your_access_key'
   AWS_SECRET_ACCESS_KEY = 'your_secret_key'
   ```

2. **Create a Python Script to List All Policies:**
   You can use the `list_policies` method of the FMS client in Boto3 to list all FMS policies. Here is a sample script:

   ```python
   import boto3

   def list_policies():
       client = boto3.client('fms')
       response = client.list_policies()
       return response['PolicySummaryList']

   policies = list_policies()
   for policy in policies:
       print(policy)
   ```

3. **Check if FMS Shield Resource Policy is Enabled:**
   The `list_policies` method returns a list of policy summaries. You can check if the FMS Shield Resource Policy is enabled by checking the `PolicyType` and `RemediationEnabled` fields of each policy summary. Here is a sample script:

   ```python
   import boto3

   def is_shield_resource_policy_enabled():
       client = boto3.client('fms')
       response = client.list_policies()
       for policy in response['PolicySummaryList']:
           if policy['PolicyType'] == 'AWS_SHIELD_ADVANCED' and policy['RemediationEnabled']:
               return True
       return False

   print(is_shield_resource_policy_enabled())
   ```

4. **Handle Exceptions:**
   You should also handle any exceptions that might occur when calling the `list_policies` method. For example, you might get a `NoCredentialsError` if your AWS credentials are not properly configured. Here is a sample script:

   ```python
   import boto3
   from botocore.exceptions import NoCredentialsError

   def is_shield_resource_policy_enabled():
       try:
           client = boto3.client('fms')
           response = client.list_policies()
           for policy in response['PolicySummaryList']:
               if policy['PolicyType'] == 'AWS_SHIELD_ADVANCED' and policy['RemediationEnabled']:
                   return True
       except NoCredentialsError:
           print("AWS credentials not configured properly.")
       return False

   print(is_shield_resource_policy_enabled())
   ```

This script will print `True` if the FMS Shield Resource Policy is enabled and `False` otherwise. It will also print an error message if your AWS credentials are not configured properly.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of not having FMS Shield Resource Policy enabled for AWS CloudWatch using the AWS Management Console, follow these steps:

1. **Sign in to the AWS Management Console**: Go to https://aws.amazon.com/ and sign in to your AWS account.

2. **Navigate to AWS CloudWatch**: Click on the "Services" dropdown at the top of the page, then select "CloudWatch" under the Management & Governance section.

3. **Enable FMS Shield Resource Policy**:
   - In the CloudWatch console, click on "Alarms" in the left-hand navigation pane.
   - Click on the alarm that you want to enable FMS Shield Resource Policy for.
   - In the alarm details page, click on the "Actions" dropdown and select "Edit".
   - Scroll down to the "FMS Shield Resource Policy" section.
   - Click on the toggle button to enable the FMS Shield Resource Policy.
   - Click on the "Save" button to apply the changes.

4. **Verify the FMS Shield Resource Policy is enabled**:
   - Once you have enabled the FMS Shield Resource Policy for the alarm, you can verify that it is enabled by checking the alarm details and ensuring that the FMS Shield Resource Policy toggle is set to enabled.

By following these steps, you should be able to remediate the misconfiguration of not having FMS Shield Resource Policy enabled for AWS CloudWatch using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To enable FMS Shield Resource Policy for AWS CloudWatch using AWS CLI, follow these steps:

1. Open your terminal and ensure that you have the AWS CLI installed and configured with the necessary permissions to make changes to AWS resources.

2. Run the following AWS CLI command to enable FMS Shield Resource Policy for AWS CloudWatch:

```
aws fms put-policy --policy-id AWSManagedRulesCommonFWRuleSet --resource-type RESOURCE_TYPE --resource-id RESOURCE_ID
```

Replace `RESOURCE_TYPE` with the type of AWS resource you want to protect (e.g., `AWS::CloudWatch::Alarm`) and `RESOURCE_ID` with the specific resource ID you want to apply the policy to.

3. Verify that the FMS Shield Resource Policy has been successfully enabled for AWS CloudWatch by running the following command:

```
aws fms list-policies
```

You should see the newly created policy in the list of policies returned by this command.

By following these steps, you should be able to remediate the misconfiguration and enable FMS Shield Resource Policy for AWS CloudWatch using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of FMS Shield Resource Policy not being enabled for AWS CloudWatch using Python, you can use the AWS SDK for Python (Boto3) to update the resource policy. Here are the step-by-step instructions:

1. Install Boto3:
   If you haven't already installed Boto3, you can install it using pip:
   ```
   pip install boto3
   ```

2. Create a Python script with the following code to enable the FMS Shield Resource Policy for CloudWatch:

```python
import boto3

def enable_fms_shield_policy():
    # Create a CloudWatch client
    cloudwatch_client = boto3.client('cloudwatch')

    # Enable the FMS Shield Resource Policy for CloudWatch
    response = cloudwatch_client.put_metric_policy(
        PolicyName='FMS-Shield-Policy',
        PolicyDocument='{"Version": "2012-10-17","Statement": [{"Effect": "Allow","Principal": {"Service": "shield.amazonaws.com"},"Action": "cloudwatch:PutMetricData","Resource": "*"}]}'
    )

    print('FMS Shield Resource Policy has been enabled for CloudWatch.')

if __name__ == '__main__':
    enable_fms_shield_policy()
```

3. Run the Python script:
   Save the Python script with a `.py` extension and run it using the Python interpreter. Make sure your AWS credentials are properly configured on your system.

   ```
   python enable_fms_shield_policy.py
   ```

4. Verify the policy:
   After running the script, verify that the FMS Shield Resource Policy has been successfully enabled for CloudWatch by checking the CloudWatch console or by listing the CloudWatch resource policies using the AWS CLI:

   ```
   aws cloudwatch list-metric-policies
   ```

By following these steps, you can remediate the misconfiguration of the FMS Shield Resource Policy not being enabled for AWS CloudWatch using Python and Boto3.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
