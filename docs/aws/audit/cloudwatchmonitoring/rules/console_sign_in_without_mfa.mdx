---
slug: console_sign_in_without_mfa
title: AWS Console Sign In Without MFA Should Be Monitored
sidebar_label: AWS Console Sign In Without MFA Should Be Monitored
---

### More Info:

AWS Console Sign-In Requests Without MFA should be monitored using CloudWatch Events.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CISAWSF, PCI, GDPR, APRA, MAS, NIST4, CISAWS, CBP, SOC2, HIPAA, ISO27001, HITRUST, NISTCSF, PCIDSS

### Triage and Remediation

<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the CloudWatch console at https://console.aws.amazon.com/cloudwatch/.

2. In the navigation pane, click on "Alarms" and then "Create Alarm".

3. In the "Create Alarm" wizard, select "Select metric". Under the "AWS Namespaces" section, select "CloudTrail" and then "Event count". 

4. Configure the alarm properties. Under "Conditions", set the "Threshold type" to "Static". For "Whenever: CloudTrail Event count", set "is" to "Greater/Equal" and ": than" to "1". Under "Additional configuration", set "Datapoints to alarm" to "1 out of 1". This will trigger the alarm if any single data point is above the threshold. 

Note: This alarm will only trigger if AWS CloudTrail is configured to log console sign-in events and if MFA is not used for sign-in.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Once you have AWS CLI installed and configured, you can proceed to the next steps.

2. Use the following AWS CLI command to list all the users in your AWS account:

   ```
   aws iam list-users
   ```

   This command will return a list of all the users in your AWS account.

3. For each user, you need to check if they have MFA enabled. You can do this by using the following AWS CLI command:

   ```
   aws iam list-mfa-devices --user-name <username>
   ```

   Replace `<username>` with the name of the user. This command will return a list of all the MFA devices associated with the user. If the list is empty, it means that the user does not have MFA enabled.

4. To monitor AWS Console Sign In Without MFA, you can use AWS CloudWatch. You can create a CloudWatch alarm that triggers whenever a user signs in without MFA. You can do this by using the following AWS CLI command:

   ```
   aws cloudwatch put-metric-alarm --alarm-name "SignInWithoutMFA" --metric-name "ConsoleSignInsWithoutMFA" --namespace "AWS/SignIn" --statistic "SampleCount" --period 300 --threshold 1 --comparison-operator "GreaterThanOrEqualToThreshold" --evaluation-periods 1 --alarm-actions <arn-of-sns-topic>
   ```

   Replace `<arn-of-sns-topic>` with the ARN of the SNS topic where you want to receive the alarm notifications. This command will create a CloudWatch alarm that triggers whenever a user signs in without MFA.
</Accordion>

<Accordion title='Using Python'>
1. **Set up AWS SDK and Boto3 in Python Environment:**
   First, you need to set up your Python environment with AWS SDK and Boto3. Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:
   ```
   pip install boto3
   ```
   After installing, configure your AWS credentials either by setting up environment variables or by using the AWS CLI.

2. **Import Necessary Libraries and Establish a CloudWatch Client:**
   Import the necessary libraries and establish a connection to AWS CloudWatch. Here's a basic example:
   ```python
   import boto3

   # Create CloudWatch client
   cloudwatch = boto3.client('cloudwatch')
   ```

3. **Create a Metric Filter:**
   You need to create a metric filter in CloudWatch logs that matches the event of a console sign-in without MFA. The filter pattern for this event is `{ $.eventName = "ConsoleLogin" && $.additionalEventData.MFAUsed = "No" }`. Here's how you can create a metric filter using Boto3:
   ```python
   response = cloudwatch.put_metric_filter(
       logGroupName='log_group_name',
       filterName='ConsoleSignInWithoutMFA',
       filterPattern='{ $.eventName = "ConsoleLogin" && $.additionalEventData.MFAUsed = "No" }',
       metricTransformations=[
           {
               'metricName': 'ConsoleSignInWithoutMFA',
               'metricNamespace': 'YourNamespace',
               'metricValue': '1'
           },
       ]
   )
   ```
   Replace `'log_group_name'` with the name of your CloudTrail log group, and `'YourNamespace'` with a namespace for your metric.

4. **Check the Metric Data:**
   Now, you can check the metric data to detect if there has been a console sign-in without MFA. Here's how you can do it:
   ```python
   response = cloudwatch.get_metric_statistics(
       Namespace='YourNamespace',
       MetricName='ConsoleSignInWithoutMFA',
       StartTime=datetime.datetime.utcnow() - datetime.timedelta(seconds=600),
       EndTime=datetime.datetime.utcnow(),
       Period=60,
       Statistics=[
           'SampleCount',
       ]
   )
   ```
   This will return the number of console sign-ins without MFA in the last 10 minutes. If the 'SampleCount' is greater than 0, it means there has been a console sign-in without MFA.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate "AWS Console Sign In Without MFA" using the AWS Console, follow these steps:

1. Sign in to the AWS Management Console.

2. Navigate to the [CloudWatch dashboard](https://console.aws.amazon.com/cloudwatch/).

3. In the left navigation panel, select **Logs**.

4. Select the log group created for your CloudTrail trail event logs and click **Create Metric Filter**.

5. On the **Define Logs Metric Filter** page, paste the following pattern inside the **Filter Pattern** box:

```bash
    { $.eventName = "ConsoleLogin" && $.additionalEventData.MFAUsed = "No" }
```

6. Review the metric filter details and click **Assign Metric**.

7. On the **Create Metric Filter and Assign a Metric** page:

   - Filter Name: `ConsoleSignInWithoutMfa`
   - Metric Namespace: `CloudTrailMetrics`
   - Metric Name: `ConsoleSignInWithoutMfaCount`
   - Metric Value: `1`
   - Click **Create Filter**.

8. After creating the filter, click **Create Alarm** from the top-right menu.

9. Configure the alarm:

   - Alarm Name: `ConsoleSignInWithoutMfaAlarm`
   - Threshold: `>= 1` (to trigger on every sign-in without MFA)
   - Notification: Select the SNS topic to receive alerts.
   - Period: `5 Minutes`
   - Statistic: `Sum`

10. Review and click **Create Alarm** to finalize.

#

</Accordion>

<Accordion title='Using CLI'>
To remediate "AWS Console Sign In Without MFA" using AWS CLI, follow these steps:

1. Run the following command to create a CloudWatch metric filter:

```bash
aws logs put-metric-filter \
    --region us-east-1 \
    --log-group-name CloudTrail/CloudWatchLogGroup \
    --filter-name ConsoleSignInWithoutMfaCount \
    --filter-pattern '{ $.eventName = "ConsoleLogin" && $.additionalEventData.MFAUsed = "No" }' \
    --metric-transformations metricName=ConsoleSignInWithoutMfaCount,metricNamespace=CloudTrailMetrics,metricValue=1
```

2. Run the following command to create a CloudWatch alarm:

```bash
aws cloudwatch put-metric-alarm \
    --region us-east-1 \
    --alarm-name ConsoleSignInWithoutMfaAlarm \
    --alarm-description "Triggered by sign-in requests made without MFA." \
    --metric-name ConsoleSignInWithoutMfaCount \
    --namespace CloudTrailMetrics \
    --statistic Sum \
    --comparison-operator GreaterThanOrEqualToThreshold \
    --evaluation-periods 1 \
    --period 300 \
    --threshold 1 \
    --alarm-actions arn:aws:sns:us-east-1:123456789012:SignInWithoutMfaAlarmSNSTopic
```

</Accordion>

<Accordion title='Using Python'>
To monitor and remediate this using Python, follow these steps:

1. **Create an AWS CloudTrail Trail** to log sign-in events as described in the original documentation.

2. Use AWS Lambda with Python to scan for sign-in events without MFA and trigger alerts via SNS:

```python
import boto3
import json

sns = boto3.client('sns')
topic_arn = 'arn:aws:sns:us-east-1:123456789012:signin-alerts'

def lambda_handler(event, context):
    for record in event['Records']:
        if record['eventName'] == 'ConsoleLogin':
            event_data = json.loads(record['CloudTrailEvent'])
            user_identity = event_data['userIdentity']
            if 'sessionContext' in user_identity and 'attributes' in user_identity['sessionContext']:
                attributes = user_identity['sessionContext']['attributes']
                if 'mfaAuthenticated' in attributes and attributes['mfaAuthenticated'] == 'false':
                    message = 'User signed in without MFA: {}'.format(user_identity['userName'])
                    sns.publish(TopicArn=topic_arn, Message=message)
```

3. Test the Lambda function.

   - Use the "Test" button in the Lambda function console to test the function.
   - Verify that you receive an email or text message when a sign-in event without MFA is detected.

By following these steps, you can remediate the issue of AWS Console Sign In Without MFA Should Be Monitored using Python.

</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-aws-console-sign-in-events.html](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-aws-console-sign-in-events.html)
- [https://www.trendmicro.com/cloudoneconformity-staging/knowledge-base/aws/CloudWatchLogs/console-sign-in-without-mfa.html](https://www.trendmicro.com/cloudoneconformity-staging/knowledge-base/aws/CloudWatchLogs/console-sign-in-without-mfa.html)
