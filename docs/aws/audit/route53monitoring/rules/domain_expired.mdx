---
slug: domain_expired
title: Route 53 Should Identify Any Expired Domains
sidebar_label: Route 53 Should Identify Any Expired Domains
---

### More Info:

Any expired domain names registered with AWS Route 53 should be identified and restored. The restoration fee will be charged to your AWS account and you will get a confirmation email once the registration process is completed.

### Risk Level

High

### Address

Reliability, Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the Route 53 dashboard.
2. In the navigation pane, select "Hosted zones". This will display a list of all the domains that are currently managed by Route 53.
3. Click on the domain name that you want to check. This will open the domain details page.
4. On the domain details page, check the "Domain Registration" section. If the domain is expired, the "Expiration Date" will be in the past.

#### Using CLI

1. Install and configure AWS CLI: Before you can run any AWS CLI commands, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```

   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format. These details can be obtained from your AWS account.

2. List Hosted Zones: The first step to identify any expired domains is to list all the hosted zones in your AWS account. You can do this by running the following command:

   ```
   aws route53 list-hosted-zones
   ```

   This command will return a list of all the hosted zones in your AWS account.

3. List Resource Record Sets: For each hosted zone, you need to list all the resource record sets. You can do this by running the following command:

   ```
   aws route53 list-resource-record-sets --hosted-zone-id <HostedZoneId>
   ```

   Replace `<HostedZoneId>` with the ID of the hosted zone you want to check. This command will return a list of all the resource record sets in the specified hosted zone.

4. Check Domain Expiry Date: For each resource record set of type `NS` (Name Server), you need to check the domain expiry date. Unfortunately, AWS CLI does not provide a direct way to do this. You would need to use a third-party tool or service to check the domain expiry date. If the domain has expired, you have identified a misconfiguration.

#### Using Python

1. **Setup AWS SDK (Boto3) in Python Environment:**
   First, you need to set up AWS SDK (Boto3) in your Python environment. You can install it using pip:
   ```
   pip install boto3
   ```
   After installing boto3, you need to configure your AWS credentials. You can configure it in the terminal or by creating a credentials file manually. The default location for the file is `~/.aws/credentials`. At a minimum, the credentials file should look like this:
   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

2. **Import Necessary Libraries and Initialize Route53 Client:**
   Now, you need to import the necessary libraries and initialize the Route53 client. Here is the Python script to do that:
   ```python
   import boto3
   from datetime import datetime

   # Initialize the Route53 client
   route53 = boto3.client('route53')
   ```

3. **Fetch All Hosted Zones and Domains:**
   Next, you need to fetch all the hosted zones and domains. Here is the Python script to do that:
   ```python
   # Fetch all hosted zones
   hosted_zones = route53.list_hosted_zones()

   # Loop through all hosted zones
   for zone in hosted_zones['HostedZones']:
       # Fetch all domains in the hosted zone
       domains = route53.list_resource_record_sets(HostedZoneId=zone['Id'])
   ```

4. **Check for Expired Domains:**
   Finally, you need to check for expired domains. Here is the Python script to do that:
   ```python
   # Current date
   current_date = datetime.now()

   # Loop through all domains
   for domain in domains['ResourceRecordSets']:
       # Check if the domain is expired
       if 'ResourceRecords' in domain:
           for record in domain['ResourceRecords']:
               if 'Value' in record:
                   # Get the domain expiration date
                   domain_expiration_date = datetime.strptime(record['Value'], '%Y-%m-%d')
                   # Check if the domain is expired
                   if domain_expiration_date < current_date:
                       print(f"Domain {domain['Name']} is expired.")
   ```
   This script will print all the expired domains.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Route 53 not identifying any expired domains in AWS, you can follow the below steps:

1. Log in to the AWS Management Console and navigate to the Route 53 service.
2. Click on the "Registered domains" option in the left-hand menu.
3. In the list of registered domains, identify the domain that is expired and select it.
4. Click on the "Renew domain registration" button in the top-right corner of the page.
5. Follow the on-screen instructions to complete the domain renewal process.
6. Once the domain is renewed, Route 53 will automatically start identifying it again.

It is important to note that if the domain is not renewed within a certain period of time, it may become permanently unavailable and cannot be renewed. Therefore, it is recommended to set up auto-renewal for domains in Route 53 to avoid such misconfigurations in the future.

#### Using CLI

To remediate the misconfiguration in AWS Route 53 using AWS CLI, follow these steps:

1. Open the AWS CLI on your local system or EC2 instance.

2. Run the following command to list all the hosted zones in your AWS account:
```
aws route53 list-hosted-zones
```

3. Identify the hosted zone that contains the expired domain.

4. Run the following command to get the details of the expired domain:
```
aws route53 list-resource-record-sets --hosted-zone-id <hosted-zone-id> --query "ResourceRecordSets[?Name == '<expired-domain-name>']"
```
Replace `<hosted-zone-id>` with the ID of the hosted zone that contains the expired domain and `<expired-domain-name>` with the name of the expired domain.

5. If the output of the above command returns any records for the expired domain, run the following command to delete those records:
```
aws route53 change-resource-record-sets --hosted-zone-id <hosted-zone-id> --change-batch '{"Changes":[{"Action":"DELETE","ResourceRecordSet":{"Name":"<expired-domain-name>","Type":"<record-type>","TTL":<ttl>,"ResourceRecords":[{"Value":"<record-value>"}]}}]}'
```
Replace `<hosted-zone-id>` with the ID of the hosted zone that contains the expired domain, `<expired-domain-name>` with the name of the expired domain, `<record-type>` with the type of record that needs to be deleted (e.g. A, CNAME, MX, etc.), `<ttl>` with the TTL value of the record, and `<record-value>` with the value of the record.

6. Verify that the expired domain records have been deleted by running the following command:
```
aws route53 list-resource-record-sets --hosted-zone-id <hosted-zone-id> --query "ResourceRecordSets[?Name == '<expired-domain-name>']"
```
This command should not return any records for the expired domain.

By following these steps, you can remediate the misconfiguration in AWS Route 53 and ensure that any expired domains are identified and deleted.

#### Using Python

To remediate the misconfiguration in AWS Route 53 using Python, follow the below steps:

Step 1: Install and configure the AWS CLI on your local machine.

Step 2: Create a Python script that uses the boto3 library to interact with AWS Route 53.

Step 3: Use the `list_hosted_zones()` method to get a list of all the hosted zones in your AWS account.

Step 4: Loop through the hosted zones and use the `list_resource_record_sets()` method to get a list of all the resource record sets in each hosted zone.

Step 5: Check the `Expiration` field of each resource record set to see if it is expired.

Step 6: If a resource record set is expired, use the `change_resource_record_sets()` method to delete the record set.

Step 7: Save and run the Python script.

Here is a sample Python script that you can use as a starting point:

```
import boto3
import datetime

# Create a Route 53 client
client = boto3.client('route53')

# Get a list of all the hosted zones
response = client.list_hosted_zones()
hosted_zones = response['HostedZones']

# Loop through the hosted zones
for zone in hosted_zones:
    zone_id = zone['Id']
    zone_name = zone['Name']

    # Get a list of all the resource record sets in the zone
    response = client.list_resource_record_sets(HostedZoneId=zone_id)
    record_sets = response['ResourceRecordSets']

    # Loop through the resource record sets
    for record_set in record_sets:
        # Check if the record set is expired
        if 'Expiration' in record_set and record_set['Expiration'] < datetime.datetime.now():
            # Delete the record set
            response = client.change_resource_record_sets(
                HostedZoneId=zone_id,
                ChangeBatch={
                    'Changes': [
                        {
                            'Action': 'DELETE',
                            'ResourceRecordSet': record_set
                        }
                    ]
                }
            )
            print(f"Deleted expired record set {record_set['Name']} in zone {zone_name}")
```

Note: This script assumes that the `Expiration` field is already set in the resource record sets. If it is not set, you may need to modify the script to check for other indicators of expiration.

### Additional Reading:

- [https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-restore-expired.html](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-restore-expired.html) 


</Tab>
</Tabs>