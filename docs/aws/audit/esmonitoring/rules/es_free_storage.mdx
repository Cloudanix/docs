---
slug: es_free_storage
title: Elasticsearch Should Have Free Storage Space
sidebar_label: Elasticsearch Should Have Free Storage Space
---

### More Info:

Scale up any Amazon ElasticSearch (ES) clusters that appear to run low on disk space to help mitigate any issues.

### Risk Level

Low

### Address

Reliability, Operational Maturity

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon Elasticsearch Service console at https://console.aws.amazon.com/es/.

2. In the navigation pane, choose "Domains". This will display a list of all your Elasticsearch domains.

3. Select the domain you want to check for free storage space. This will open the dashboard for that domain.

4. In the "Overview" tab, look for the "Free Storage Space" metric. This will show you the amount of free storage space available in your Elasticsearch domain. If the free storage space is less than 20%, it's a sign of misconfiguration as it could lead to performance issues or even data loss.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start, you need to install the AWS CLI on your local machine. You can do this by downloading the appropriate installer from the AWS CLI website. Once installed, you can configure it by running `aws configure` and providing your AWS access key ID, secret access key, default region name, and default output format.

2. List all Elasticsearch domains: Use the following command to list all the Elasticsearch domains in your AWS account.

   ```
   aws es list-domain-names
   ```

   This command will return a list of all Elasticsearch domains. Note down the domain names for which you want to check the free storage space.

3. Describe the Elasticsearch domain: Use the following command to get detailed information about a specific Elasticsearch domain.

   ```
   aws es describe-elasticsearch-domain --domain-name your_domain_name
   ```

   Replace 'your_domain_name' with the name of your Elasticsearch domain. This command will return a JSON object containing detailed information about the domain.

4. Check the free storage space: In the output of the previous command, look for the 'EBSOptions' field. This field contains information about the EBS volumes attached to the Elasticsearch domain. The 'VolumeSize' subfield shows the total size of the EBS volume, and the 'FreeStorageSpace' subfield shows the amount of free storage space. If the 'FreeStorageSpace' is low, it indicates that the Elasticsearch domain does not have enough free storage space.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries:
   You will need the `elasticsearch` and `boto3` libraries. You can install them using pip:
   ```
   pip install elasticsearch boto3
   ```

2. Connect to Elasticsearch:
   Use the `Elasticsearch` class from the `elasticsearch` library to connect to your Elasticsearch instance. You will need the endpoint of your Elasticsearch instance, which you can get from the AWS Management Console, and your AWS credentials, which you can get from the `boto3` library.
   ```python
   from elasticsearch import Elasticsearch
   import boto3

   session = boto3.Session()
   credentials = session.get_credentials()

   es = Elasticsearch(
       hosts=[{'host': 'my-elasticsearch-endpoint', 'port': 443}],
       http_auth=(credentials.access_key, credentials.secret_key),
       scheme="https",
       verify_certs=True
   )
   ```

3. Get the Elasticsearch cluster stats:
   Use the `cluster.stats` method from the `Elasticsearch` instance to get the stats of your Elasticsearch cluster. This will return a dictionary with the stats of your cluster.
   ```python
   stats = es.cluster.stats()
   ```

4. Check the free storage space:
   The `stats` dictionary contains a `nodes` key, which contains a `fs` key, which contains a `total` key, which contains a `free_in_bytes` key. This key contains the free storage space in bytes. You can check if this value is below a certain threshold to detect if there is not enough free storage space.
   ```python
   free_storage_space = stats['nodes']['fs']['total']['free_in_bytes']
   if free_storage_space < 10**9:  # less than 1 GB
       print("Not enough free storage space")
   else:
       print("Enough free storage space")
   ```
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the Elasticsearch free storage space issue in AWS, follow these steps:

1. Login to your AWS console and navigate to the Elasticsearch service.

2. Select the Elasticsearch domain that you want to remediate.

3. Click on the "Modify" button.

4. Scroll down to the "EBS Volume" section.

5. Increase the "EBS Volume Size" to provide more storage space.

6. Click on the "Save Changes" button.

7. Wait for the Elasticsearch domain to update and the new storage space to be available.

8. Verify that the Elasticsearch domain now has free storage space by checking the Elasticsearch dashboard or running a query.

Note: Increasing the EBS Volume Size will result in additional charges on your AWS bill.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the Elasticsearch misconfiguration of not having free storage space in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine or use the AWS CLI in the AWS Management Console.

2. Run the following command to list all the Elasticsearch domains in your AWS account:

```
aws es list-domain-names
```

3. Identify the Elasticsearch domain that has the misconfiguration of not having free storage space.

4. Run the following command to update the Elasticsearch domain configuration and set the storage type to EBS and the EBS volume size to a value greater than the current storage usage:

```
aws es update-elasticsearch-domain-config --domain-name <domain-name> --ebs-options EBSEnabled=true,VolumeSize=<new-volume-size>
```

Replace `<domain-name>` with the name of the Elasticsearch domain and `<new-volume-size>` with the desired EBS volume size in gigabytes.

5. Wait for the Elasticsearch domain to be updated. This may take several minutes.

6. Run the following command to verify that the Elasticsearch domain has free storage space:

```
aws es describe-elasticsearch-domain --domain-name <domain-name> --query 'DomainStatus.EBSOptions.VolumeSize'
```

This command should return a value greater than the current storage usage.

7. Repeat steps 4-6 for any other Elasticsearch domains that have the misconfiguration of not having free storage space.

By following these steps, you should be able to remediate the Elasticsearch misconfiguration of not having free storage space in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the Elasticsearch misconfiguration of not having free storage space in AWS using Python, you can follow these steps:

1. Import the necessary Python modules:

```python
import boto3
```

2. Initialize a boto3 Elasticsearch client:

```python
es = boto3.client('es')
```

3. Get the Elasticsearch domain name:

```python
domain_name = 'your_domain_name'
```

4. Get the Elasticsearch domain configuration:

```python
domain_config = es.describe_elasticsearch_domain(DomainName=domain_name)
```

5. Get the current storage space usage:

```python
storage_used = domain_config['DomainStatus']['EBSOptions']['VolumeSize'] - domain_config['DomainStatus']['EBSOptions']['FreeSpace']
```

6. Get the maximum storage space limit:

```python
storage_limit = domain_config['DomainStatus']['EBSOptions']['VolumeSize']
```

7. Calculate the required free storage space:

```python
required_free_space = int(storage_limit * 0.2) # 20% of total storage limit
```

8. If the current storage space usage is greater than or equal to the required free storage space, then increase the storage limit:

```python
if storage_used >= required_free_space:
    new_storage_limit = storage_limit + required_free_space
    es.update_elasticsearch_domain_config(DomainName=domain_name, EBSOptions={'EBSEnabled': True, 'VolumeSize': new_storage_limit})
```

9. Print a message indicating whether the storage limit was increased:

```python
if storage_used >= required_free_space:
    print(f"The storage limit for Elasticsearch domain {domain_name} has been increased to {new_storage_limit} GB.")
else:
    print(f"The Elasticsearch domain {domain_name} has sufficient free storage space.")
```

By following these steps, you can remediate the Elasticsearch misconfiguration of not having free storage space in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/sizing-domains.html](https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/sizing-domains.html) 

