
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Elasticsearch service.
2. In the Elasticsearch dashboard, select "Reserved Instances" from the left-hand side menu.
3. In the Reserved Instances page, you will see a list of all your reserved instances. Look for the "Expiration Date" column in the table.
4. Check the dates in the "Expiration Date" column. If any of the dates are within the next 30 days, then those Elasticsearch Reserved Instances are set to expire soon.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local system. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all Elasticsearch Reserved Instances: Use the following AWS CLI command to list all your Elasticsearch Reserved Instances:

   ```
   aws es describe-reserved-elasticsearch-instances
   ```

   This command will return a JSON output with details about all your Elasticsearch Reserved Instances.

3. Parse the output: You need to parse the output to get the details of the Reserved Instances that are about to expire in the next 30 days. You can do this using a tool like `jq`. Here is an example command:

   ```
   aws es describe-reserved-elasticsearch-instances | jq -r '.ReservedElasticsearchInstances[] | select(.State=="active" and .DurationRemainingInSeconds < 2592000) | .ReservedElasticsearchInstanceId'
   ```

   This command will return the IDs of the Reserved Instances that are about to expire in the next 30 days.

4. Check the details of the expiring Reserved Instances: You can then use the IDs returned by the previous command to check the details of the expiring Reserved Instances. Here is an example command:

   ```
   aws es describe-reserved-elasticsearch-instances --reserved-elasticsearch-instance-id <instance-id>
   ```

   Replace `<instance-id>` with the ID of the Reserved Instance you want to check. This command will return a JSON output with the details of the specified Reserved Instance.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: To interact with AWS services, you need to install the boto3 library. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Configure AWS credentials: Before you can interact with AWS services, you need to set up your AWS credentials. You can do this by creating a credentials file at ~/.aws/credentials. At a minimum, the credentials file should specify the access key and secret access key. To specify these for the default profile, you can use the following format:

   ```python
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. Write a Python script to check Elasticsearch Reserved Instance Lease Expiration: 

   ```python
   import boto3
   from datetime import datetime, timedelta

   # Create a client
   client = boto3.client('es')

   # Get the current date
   current_date = datetime.now()

   # Get the list of all reserved Elasticsearch instances
   response = client.describe_reserved_elasticsearch_instances()

   # Iterate over each reserved instance
   for reserved_instance in response['ReservedElasticsearchInstances']:
       # Get the end date of the reserved instance
       end_date = reserved_instance['ReservedElasticsearchInstanceEnd']

       # Calculate the difference between the current date and the end date
       difference = end_date - current_date

       # If the difference is less than or equal to 30 days, print a message
       if difference.days <= 30:
           print(f"The reserved instance {reserved_instance['ReservedElasticsearchInstanceId']} will expire in the next 30 days.")
   ```

4. Run the Python script: You can run the Python script using any Python interpreter. If the script is saved as a file named check_es_reserved_instances.py, you can run it using the following command:

   ```python
   python check_es_reserved_instances.py
   ```
   
This script will print a message for each Elasticsearch reserved instance that will expire in the next 30 days.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the Elasticsearch Reserved Instance Lease Expiration in the next 30 days issue for AWS using the AWS console, follow these steps:

1. Login to your AWS console.
2. Go to the Elasticsearch service.
3. Click on the "Reserved Instances" option in the left-hand menu.
4. Identify the Elasticsearch Reserved Instance that is expiring in the next 30 days.
5. Click on the "Modify Reserved Instance" button.
6. Select the "Extend the term of this Reserved Instance" option.
7. Choose the desired term length for the extension.
8. Review the changes and click on the "Purchase" button to complete the reservation extension.

By following these steps, you will have successfully remediated the Elasticsearch Reserved Instance Lease Expiration in the next 30 days issue on AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine or EC2 instance.
2. Run the following command to list all the Elasticsearch Reserved Instances in your AWS account:

   ```
   aws es describe-reserved-elasticsearch-instances
   ```

3. Identify the Reserved Instance that has an expiration date within the next 30 days.
4. Run the following command to modify the Reserved Instance:

   ```
   aws es modify-reserved-elasticsearch-instance --reserved-elasticsearch-instance-id <Reserved Instance ID> --reserved-elasticsearch-instance-offering-id <New Offering ID>
   ```

   Replace `<Reserved Instance ID>` with the ID of the Reserved Instance that needs to be modified, and `<New Offering ID>` with the ID of the new Elasticsearch Reserved Instance offering that you want to use.

   Note: You can use the `aws es describe-elasticsearch-instance-type-offerings` command to list all the Elasticsearch Reserved Instance offerings available in your account.

5. Verify that the Reserved Instance has been modified by running the following command:

   ```
   aws es describe-reserved-elasticsearch-instances --reserved-elasticsearch-instance-id <Reserved Instance ID>
   ```

   Replace `<Reserved Instance ID>` with the ID of the Reserved Instance that you modified.

6. Repeat steps 3 to 5 for all the Elasticsearch Reserved Instances that have an expiration date within the next 30 days.

By following these steps, you can remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the Elasticsearch Reserved Instance Lease Expiration in the next 30 days issue on AWS using Python, you can follow these steps:

1. Import the necessary AWS SDK modules in Python:

```python
import boto3
from datetime import datetime, timedelta
```

2. Set up the AWS credentials and region:

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. Create an Elasticsearch client:

```python
es_client = session.client('es')
```

4. Retrieve the list of Elasticsearch domains:

```python
domains = es_client.list_domain_names()['DomainNames']
```

5. Loop through each domain and check if there are any reserved instances expiring in the next 30 days:

```python
for domain in domains:
    domain_name = domain['DomainName']
    reserved_instances = es_client.list_reserved_elasticsearch_instances(
        ElasticsearchInstanceType='m4.large.elasticsearch',
        MaxResults=100,
        NextToken=''
    )['ReservedElasticsearchInstances']
    for ri in reserved_instances:
        expiration_date = ri['StartTime'] + timedelta(days=ri['Duration'])
        if expiration_date <= datetime.now() + timedelta(days=30):
            print(f"Reserved instance for {domain_name} is expiring on {expiration_date}.")
```

6. To remediate the issue, you can either renew the reserved instance or purchase a new one. To renew the reserved instance, use the following code:

```python
es_client.purchase_reserved_elasticsearch_instance_offering(
    ReservedElasticsearchInstanceOfferingId='OFFERING_ID',
    ReservationName='RESERVATION_NAME',
    InstanceCount=1
)
```

Replace `OFFERING_ID` with the ID of the reserved instance offering, and `RESERVATION_NAME` with a name for the reservation.

7. If you want to purchase a new reserved instance, use the following code:

```python
es_client.purchase_reserved_elasticsearch_instance_offering(
    ReservedElasticsearchInstanceOfferingId='OFFERING_ID',
    InstanceCount=1,
    ReservationName='RESERVATION_NAME'
)
```

Replace `OFFERING_ID` with the ID of the reserved instance offering, and `RESERVATION_NAME` with a name for the reservation.

By following these steps, you should be able to remediate the Elasticsearch Reserved Instance Lease Expiration in the next 30 days issue on AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
