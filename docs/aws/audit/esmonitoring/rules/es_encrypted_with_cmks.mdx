---
slug: es_encrypted_with_cmks
title: Elasticsearch Domain Should Be Encrypted with KMS CMKs
sidebar_label: Elasticsearch Domain Should Be Encrypted with KMS CMKs
---

### More Info:

Your Amazon ElasticSearch (ES) domains should be encrypted with KMS Customer Master Keys (CMKs) instead of AWS managed-keys

### Risk Level

High

### Address

Security

### Compliance Standards

HIPAA



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the Amazon Elasticsearch Service dashboard. You can do this by typing "Elasticsearch Service" into the search bar and selecting it from the dropdown menu.
3. In the Amazon Elasticsearch dashboard, you will see a list of your Elasticsearch domains. Click on the name of the domain you want to check.
4. In the domain dashboard, look for the "Encryption" section. If the "Node-to-node encryption" and "Encryption at rest" options are not enabled, or if they are not using KMS CMKs, then the Elasticsearch domain is not properly encrypted with KMS CMKs.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. Make sure you have the necessary permissions to access the Elasticsearch domains.

2. Use the following AWS CLI command to list all the Elasticsearch domains:

   ```
   aws es list-domain-names
   ```
   This command will return a list of all Elasticsearch domain names.

3. For each domain, use the following command to describe the Elasticsearch domain configuration:

   ```
   aws es describe-elasticsearch-domain --domain-name <your-domain-name>
   ```
   Replace `<your-domain-name>` with the name of your Elasticsearch domain. This command will return the configuration details of the specified Elasticsearch domain.

4. Check the output of the above command for the `EncryptionAtRestOptions` field. If the `Enabled` field under `EncryptionAtRestOptions` is `false`, or if the `KmsKeyId` field is not present or empty, then the Elasticsearch domain is not encrypted with KMS CMKs.

#### Using Python

1. Import the necessary libraries: You will need the boto3 library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
from botocore.exceptions import BotoCoreError, ClientError
```

2. Create a session using your AWS credentials. You can configure credentials in several ways. You can load them from a .aws/credentials file or from environment variables.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    aws_session_token='SESSION_TOKEN',
)
```

3. Create an Elasticsearch client:

```python
es_client = session.client('es')
```

4. Now, you can list all Elasticsearch domains and check if they are encrypted with KMS CMKs. If the KmsKeyId is None, it means that the Elasticsearch domain is not encrypted with KMS CMKs.

```python
def check_es_encryption():
    domains = es_client.list_domain_names()
    for domain in domains['DomainNames']:
        domain_name = domain['DomainName']
        domain_details = es_client.describe_elasticsearch_domain(DomainName=domain_name)
        domain_config = domain_details['DomainStatus']
        if 'EncryptionAtRestOptions' in domain_config:
            encryption_options = domain_config['EncryptionAtRestOptions']
            if not encryption_options['Enabled'] or encryption_options['KmsKeyId'] is None:
                print(f"Elasticsearch domain {domain_name} is not encrypted with KMS CMKs")
        else:
            print(f"Elasticsearch domain {domain_name} does not have encryption at rest options set")

check_es_encryption()
```

This script will print out the names of all Elasticsearch domains that are not encrypted with KMS CMKs.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step by step instructions to remediate the Elasticsearch Domain Should Be Encrypted with KMS CMKs on AWS:

1. Login to your AWS console and navigate to the Elasticsearch service.

2. Select the Elasticsearch domain that needs to be remediated.

3. Click on the "Configure" button in the "Security" section.

4. In the "Encryption" section, select the "KMS" option.

5. Select the appropriate KMS CMK from the list of available keys. If you don't have a KMS CMK, you can create one by clicking the "Create a new key" button.

6. Once you have selected the KMS CMK, click the "Save changes" button to apply the encryption.

7. Wait for the changes to take effect. This may take a few minutes.

8. Verify that the Elasticsearch domain is now encrypted with the selected KMS CMK. You can do this by checking the "Encryption" section in the Elasticsearch domain's configuration.

That's it! You have successfully remediated the Elasticsearch Domain Should Be Encrypted with KMS CMKs issue on AWS.

#### Using CLI

To remediate the Elasticsearch Domain misconfiguration in AWS using AWS CLI, you can follow these steps:

1. Identify the Elasticsearch domain that needs to be encrypted with KMS CMKs.

2. Create a KMS Customer Master Key (CMK) if you don't already have one.

3. Enable AWS Key Management Service (KMS) encryption for the Elasticsearch domain using the following command:

```
aws es update-elasticsearch-domain-config --domain-name <your-domain-name> --encryption-at-rest-options Enabled=true,KmsKeyId=<your-KMS-CMK-ARN>
```

Replace `<your-domain-name>` with the name of your Elasticsearch domain and `<your-KMS-CMK-ARN>` with the ARN of the KMS CMK you want to use for encryption.

4. Verify that the Elasticsearch domain is encrypted with KMS CMKs by running the following command:

```
aws es describe-elasticsearch-domain --domain-name <your-domain-name> --query 'DomainStatus.EncryptionAtRestOptions.Status'
```

If the output is `ENABLED`, it means that the Elasticsearch domain is encrypted with KMS CMKs.

5. Repeat the above steps for all Elasticsearch domains that need to be encrypted with KMS CMKs.

Note: Enabling KMS encryption for an Elasticsearch domain may cause a temporary outage as the domain is reconfigured. It is recommended to perform this during a maintenance window.

#### Using Python

To remediate the Elasticsearch Domain should be encrypted with KMS CMKs misconfiguration for AWS using python, you can follow the below steps:

1. First, you need to identify the Elasticsearch Domain that is not encrypted with KMS CMKs. You can use the following AWS CLI command to get the list of Elasticsearch domains:

```
aws es list-domain-names
```

2. Once you have identified the Elasticsearch Domain, you need to enable encryption using KMS CMKs. You can use the following AWS CLI command to enable encryption:

```
aws es update-elasticsearch-domain-config --domain-name <domain-name> --encryption-at-rest-options Enabled=true,KmsKeyId=<kms-key-id>
```

Replace `<domain-name>` with the name of your Elasticsearch Domain and `<kms-key-id>` with the ID of the KMS CMK that you want to use for encryption.

3. Verify that the Elasticsearch Domain is encrypted with KMS CMKs. You can use the following AWS CLI command to get the Elasticsearch Domain configuration:

```
aws es describe-elasticsearch-domain --domain-name <domain-name>
```

This command will return the Elasticsearch Domain configuration, which should include the `EncryptionAtRestOptions` parameter with the value `Enabled=true` and `KmsKeyId=<kms-key-id>`.

4. Finally, you can confirm that the Elasticsearch Domain is encrypted with KMS CMKs by checking the AWS KMS console. The KMS CMK that you specified in step 2 should have been used to encrypt the Elasticsearch Domain.

Note: You can use the AWS SDK for Python (Boto3) to automate these steps.

### Additional Reading:

- [https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/encryption-at-rest.html](https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/encryption-at-rest.html) 


</Tab>
</Tabs>