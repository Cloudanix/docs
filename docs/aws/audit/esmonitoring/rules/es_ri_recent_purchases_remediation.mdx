

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the Elasticsearch service. 

2. In the Elasticsearch dashboard, look for the "Reserved Instances" section. This is where you can see all the purchased reserved instances for Elasticsearch.

3. Check the "Purchase Date" column for each reserved instance. If there are any recent purchases, they will be listed here with the most recent date.

4. Review the details of the recent purchases, including the instance type, term, offering class, and payment option. Make sure these match your expected usage and budget. If there are any discrepancies or unexpected purchases, it could indicate a misconfiguration or unauthorized activity.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can use the "describe-reserved-elasticsearch-instances" command to list all the Elasticsearch reserved instances. The command is as follows:

   ```
   aws es describe-reserved-elasticsearch-instances
   ```

3. This command will return a JSON output with details of all the Elasticsearch reserved instances. You need to review the "ReservedElasticsearchInstances" section of the output. Look for the "ReservedElasticsearchInstanceOfferingId" and "ReservedElasticsearchInstances" fields. These fields provide information about the reserved instances that have been purchased recently.

4. To further filter out the recent purchases, you can use the "jq" command-line JSON processor. The following command will list all the reserved instances that have been purchased in the last 30 days:

   ```
   aws es describe-reserved-elasticsearch-instances | jq '.ReservedElasticsearchInstances[] | select(.StartTime > (now - 30*24*60*60))'
   ```

Remember, the above command assumes that your system has "jq" installed. If not, you can download it from the official "jq" website.

#### Using Python

To detect recent purchases of Elasticsearch Reserved Instances, you can use the AWS SDK for Python (Boto3). Here are the steps:

1. **Set up AWS SDK for Python (Boto3):**
   First, you need to install and configure Boto3. You can install it using pip:

   ```
   pip install boto3
   ```

   Then, configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config:

   ```
   ~/.aws/credentials:
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY

   ~/.aws/config:
   [default]
   region=us-east-1
   ```

2. **Create a Python script to list all Elasticsearch Reserved Instances:**
   Use the `describe_reserved_elasticsearch_instances` method of the Elasticsearch service client to get information about all Elasticsearch Reserved Instances:

   ```python
   import boto3

   def list_reserved_instances():
       client = boto3.client('es')
       response = client.describe_reserved_elasticsearch_instances()
       return response['ReservedElasticsearchInstances']

   reserved_instances = list_reserved_instances()
   for ri in reserved_instances:
       print(ri)
   ```

3. **Filter the instances based on the purchase date:**
   The response from the `describe_reserved_elasticsearch_instances` method includes the `StartTime` field, which indicates when the Reserved Instance was purchased. You can filter the instances based on this field to get the recent purchases:

   ```python
   from datetime import datetime, timedelta

   def list_recent_purchases(days):
       recent_purchases = []
       for ri in reserved_instances:
           if ri['StartTime'] > datetime.now() - timedelta(days=days):
               recent_purchases.append(ri)
       return recent_purchases

   recent_purchases = list_recent_purchases(30)
   for rp in recent_purchases:
       print(rp)
   ```

4. **Review the recent purchases:**
   Now that you have a list of recent purchases, you can review them. For example, you can check if the `ReservedElasticsearchInstanceOfferingType` is 'All Upfront', 'Partial Upfront', or 'No Upfront', and if the `ReservedElasticsearchInstances` is more than what is required.

   ```python
   for rp in recent_purchases:
       print(f"Offering Type: {rp['ReservedElasticsearchInstanceOfferingType']}")
       print(f"Instance Count: {rp['ReservedElasticsearchInstances']}")
   ```

This script will help you detect recent purchases of Elasticsearch Reserved Instances. You can modify it according to your needs.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

The issue "Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed" indicates that there have been recent purchases of Amazon Elasticsearch Reserved Instances, and these purchases should be reviewed to ensure that they align with your current usage and requirements. Here are the steps to remediate this issue in AWS using the AWS Console:

1. Log in to the AWS Management Console and navigate to the Amazon Elasticsearch Service console.
2. Click on the "Reserved Instances" tab in the left-hand menu.
3. Review the list of recently purchased Reserved Instances and identify any that are not aligned with your current usage or requirements.
4. Select the Reserved Instance(s) that need to be modified or canceled.
5. Click on the "Actions" dropdown menu and select "Modify Reserved Instances" or "Cancel Reserved Instances" as appropriate.
6. Follow the prompts to modify or cancel the Reserved Instance(s).
7. Once you have made any necessary changes, review the Reserved Instances again to ensure that they are aligned with your current usage and requirements.

By following these steps, you can remediate the issue of Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed in AWS.

#### Using CLI

The Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed misconfiguration in AWS occurs when there are recent purchases of Elasticsearch reserved instances that have not been reviewed for accuracy. To remediate this issue, follow these steps using AWS CLI:

1. Log in to your AWS account using the AWS CLI.

2. Run the following command to list all Elasticsearch reserved instances:

```
aws es describe-reserved-elasticsearch-instances
```

3. Review the output to identify any recent purchases that have not been reviewed.

4. Run the following command to modify the Elasticsearch reserved instance to match your current usage:

```
aws es modify-reserved-elasticsearch-instance --reserved-elasticsearch-instance-id <instance-id> --reserved-elasticsearch-instance-offering-id <offering-id> --elasticsearch-instance-count <instance-count>
```

Replace `<instance-id>` with the ID of the reserved instance that needs to be modified, `<offering-id>` with the ID of the offering that you want to use, and `<instance-count>` with the number of Elasticsearch instances that you want to reserve.

5. Review the output to ensure that the reserved instance has been modified correctly.

6. Run the following command to confirm that the reservation has been applied:

```
aws es describe-reserved-elasticsearch-instances --reserved-elasticsearch-instance-id <instance-id>
```

Replace `<instance-id>` with the ID of the reserved instance that you modified.

7. Review the output to ensure that the reservation has been applied correctly.

By following these steps, you can remediate the Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed misconfiguration in AWS using AWS CLI.

#### Using Python

The misconfiguration "Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed" means that there are unused or underutilized Elasticsearch reserved instances that were recently purchased. To remediate this issue, you can use the following steps in Python:

1. Get a list of all Elasticsearch reserved instances that are currently active and unused. You can use the `boto3` library to interact with AWS Elasticsearch service and retrieve the list of reserved instances. The following code snippet shows how to retrieve the list of reserved instances:

```
import boto3

client = boto3.client('es')

response = client.describe_reserved_elasticsearch_instances(
    ReservedElasticsearchInstanceId='string',
    MaxResults=123,
    NextToken='string'
)

reserved_instances = response['ReservedElasticsearchInstances']
```

2. Determine the utilization of each reserved instance. You can use CloudWatch metrics to determine the utilization of each reserved instance. The following code snippet shows how to retrieve the average CPU utilization metric for a reserved instance:

```
import boto3

cloudwatch = boto3.client('cloudwatch')

response = cloudwatch.get_metric_statistics(
    Namespace='AWS/ES',
    MetricName='CPUUtilization',
    Dimensions=[
        {
            'Name': 'ReservedElasticsearchInstanceId',
            'Value': 'string'
        },
    ],
    StartTime='datetime(2015, 1, 1)',
    EndTime='datetime(2015, 1, 2)',
    Period=123,
    Statistics=[
        'Average',
    ],
    Unit='Percent'
)

utilization = response['Datapoints'][0]['Average']
```

3. Identify the reserved instances that have low utilization. You can set a threshold for the utilization and identify the reserved instances that have utilization below the threshold. For example, if you set the threshold to 20%, you can identify the reserved instances that have utilization below 20%.

```
low_utilization_instances = []
threshold = 20

for instance in reserved_instances:
    instance_id = instance['ReservedElasticsearchInstanceId']
    utilization = get_utilization(instance_id)
    if utilization < threshold:
        low_utilization_instances.append(instance_id)
```

4. Review the list of reserved instances with low utilization and determine if they can be released or if the instance type can be changed to better match the workload. If the reserved instances can be released, you can use the `boto3` library to release the Elasticsearch reserved instances. The following code snippet shows how to release a reserved instance:

```
import boto3

client = boto3.client('es')

client.purchase_reserved_elasticsearch_instance_offering(
    ReservedElasticsearchInstanceId='string'
)
```

By following these steps, you can remediate the misconfiguration "Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed" for AWS using Python.


</Tab>
</Tabs>