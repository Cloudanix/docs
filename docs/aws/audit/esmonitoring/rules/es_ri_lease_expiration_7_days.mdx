---
slug: es_ri_lease_expiration_7_days
title: Elasticsearch Reserved Instance Lease Expiration In The Next 7 Days
sidebar_label: Elasticsearch Reserved Instance Lease Expiration In The Next 7 Days
---

### More Info:

Your AWS Elasticsearch Reserved Instances (RIs) should be renewed before expiration in order to get a significant discount on the hourly charges.

### Risk Level

Low

### Address

Cost Optimisation

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the Elasticsearch service.
2. In the Elasticsearch dashboard, select the "Reserved Instances" option from the left-hand side menu.
3. In the Reserved Instances page, you will see a list of all your reserved instances. Check the "Expiration Date" column for each of your instances.
4. If any of the instances have an expiration date within the next 7 days, it means that the Elasticsearch Reserved Instance lease is expiring soon.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account details. You can download AWS CLI from the official AWS website and configure it using the "aws configure" command.

2. List all Elasticsearch Reserved Instances: Use the following AWS CLI command to list all the Elasticsearch Reserved Instances in your AWS account.

   ```
   aws es describe-reserved-elasticsearch-instances
   ```

   This command will return a JSON output with details of all the Elasticsearch Reserved Instances.

3. Parse the output: You need to parse the JSON output to get the details of each Elasticsearch Reserved Instance. You can use a tool like jq to parse the JSON output. Here is an example command to parse the output and get the details of the Reserved Instances that will expire in the next 7 days.

   ```
   aws es describe-reserved-elasticsearch-instances | jq -r '.ReservedElasticsearchInstances[] | select(.State=="active" and .DurationRemainingInSeconds < 604800) | .ReservedElasticsearchInstanceId'
   ```

   This command will return the IDs of the Elasticsearch Reserved Instances that will expire in the next 7 days.

4. Check the output: If the above command returns any IDs, it means that there are Elasticsearch Reserved Instances that will expire in the next 7 days. If the command does not return any IDs, it means that there are no Elasticsearch Reserved Instances that will expire in the next 7 days.

#### Using Python

1. Install the necessary Python libraries: To interact with AWS services, you need to install the boto3 library. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Configure AWS credentials: Before you can interact with AWS services, you need to set up your AWS credentials. You can do this by creating a credentials file at ~/.aws/credentials. At a minimum, the credentials file should specify the access key and secret access key. To specify these for the default profile, you can use the following format:

   ```python
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. Write a Python script to check Elasticsearch Reserved Instance Lease Expiration:

   ```python
   import boto3
   from datetime import datetime, timedelta

   # Create a client
   client = boto3.client('es')

   # Get the current date
   current_date = datetime.now()

   # Get the date 7 days from now
   future_date = current_date + timedelta(days=7)

   # Get all reserved Elasticsearch instances
   response = client.describe_reserved_elasticsearch_instances()

   # Iterate over all reserved instances
   for reserved_instance in response['ReservedElasticsearchInstances']:
       # Get the end date of the reserved instance
       end_date = reserved_instance['ReservedElasticsearchInstanceOffering']['EndDate']

       # If the end date is within the next 7 days, print a warning
       if end_date <= future_date:
           print(f"Warning: Reserved instance {reserved_instance['ReservedElasticsearchInstanceId']} will expire on {end_date}")
   ```

4. Run the Python script: You can run the Python script using the Python interpreter. The script will print a warning for each Elasticsearch reserved instance that will expire within the next 7 days.

   ```python
   python check_es_reserved_instance_expiration.py
   ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the Elasticsearch Reserved Instance Lease Expiration in the next 7 Days issue in AWS, follow these steps:

1. Log in to the AWS Management Console.

2. Go to the Elasticsearch service.

3. Click on the "Reserved Instances" tab.

4. Look for the instance that has an expiration date in the next 7 days.

5. Click on the "Modify Reserved Instances" button.

6. Select the "Extend the reservation" option.

7. Choose the number of months to extend the reservation for.

8. Click on the "Purchase" button.

9. Review the details of the reservation extension and confirm the purchase.

10. Once the purchase is complete, the Elasticsearch Reserved Instance will be renewed and the expiration date will be extended.

11. Repeat the steps for any other Elasticsearch Reserved Instances that have an expiration date in the next 7 days.

By following these steps, you will be able to remediate the Elasticsearch Reserved Instance Lease Expiration in the next 7 Days issue in AWS.

#### Using CLI

To remediate the Elasticsearch Reserved Instance Lease Expiration in the next 7 days in AWS, follow these steps:

1. Open the AWS CLI on your local machine.

2. Check the Elasticsearch Reserved Instance Lease Expiration status by running the following command:

   ```
   aws es describe-reserved-elasticsearch-instance-offerings --query 'ReservedElasticsearchInstanceOfferings[?Duration == `31536000` && FixedPrice == `0.0` && State == `ACTIVE` && UsagePrice == `0.0` && PaymentOption == `AllUpfront` && OfferingType == `HeavyUtilization` && DurationUnits == `Seconds` && ElasticsearchInstanceType == `m4.large.elasticsearch` && ReservedElasticsearchInstanceOfferingId != `null` && Start == `null` && End != `null` && End < `'"$(date -v+7d +%Y-%m-%dT%H:%M:%SZ)"'`]' --output table
   ```

   This command will list all Elasticsearch Reserved Instances with lease expiration in the next 7 days.

3. To remediate this issue, you need to renew the lease of the Elasticsearch Reserved Instances. To do this, run the following command:

   ```
   aws es purchase-reserved-elasticsearch-instances-offering --reserved-elasticsearch-instance-offering-id <RESERVED_INSTANCE_ID> --instance-count <INSTANCE_COUNT> --payment-option AllUpfront
   ```

   Replace `<RESERVED_INSTANCE_ID>` with the ID of the Elasticsearch Reserved Instance that you want to renew, and `<INSTANCE_COUNT>` with the number of instances you want to reserve. This command will renew the lease of the Elasticsearch Reserved Instance for another year.

4. Verify that the Elasticsearch Reserved Instance Lease Expiration status is updated by running the command in step 2 again.

5. Repeat steps 3-4 for any other Elasticsearch Reserved Instances that have lease expiration in the next 7 days.

By following these steps, you can remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using AWS CLI.

#### Using Python

To remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using Python, you can follow the below steps:

1. Import the required AWS SDK libraries - Boto3 and Datetime.

```python
import boto3
from datetime import datetime, timedelta
```

2. Create a Boto3 client for Elasticsearch.

```python
es_client = boto3.client('es')
```

3. Get the list of Elasticsearch reserved instances.

```python
reserved_instances = es_client.describe_reserved_elasticsearch_instances()['ReservedElasticsearchInstances']
```

4. Iterate through the reserved instances and check if any of them are expiring in the next 7 days.

```python
for instance in reserved_instances:
    expiration_date = instance['EndTime']
    days_left = (expiration_date - datetime.now()).days
    if days_left <= 7:
        # Remediation steps go here.
```

5. If a reserved instance is expiring in the next 7 days, you can take remediation steps such as renewing the reservation or purchasing a new one. For example, to renew the reservation, you can use the `purchase_reserved_elasticsearch_instance_offering` method.

```python
es_client.purchase_reserved_elasticsearch_instance_offering(
    ReservedElasticsearchInstanceOfferingId='string',
    ReservationName='string',
    InstanceCount=123
)
```

6. Once the remediation steps are completed, you can update your ticketing system or log the remediation in a file.

```python
# Update ticketing system or log the remediation.
```

By following these steps, you can remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using Python.

### Additional Reading:

- [https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-ri.html](https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-ri.html) 


</Tab>
</Tabs>