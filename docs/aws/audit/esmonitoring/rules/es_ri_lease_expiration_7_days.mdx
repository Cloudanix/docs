---
slug: es_ri_lease_expiration_7_days
title: Elasticsearch Reserved Instance Lease Expiration In The Next 7 Days
sidebar_label: Elasticsearch Reserved Instance Lease Expiration In The Next 7 Days
---

### More Info:

Your AWS Elasticsearch Reserved Instances (RIs) should be renewed before expiration in order to get a significant discount on the hourly charges.

### Risk Level

Low

### Address

Cost Optimisation

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>



<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Elasticsearch Reserved Instance Lease Expiration in the next 7 days using the AWS Management Console, follow these steps:

1. **Monitor Reserved Instance Expiration:**
   - Navigate to the **Amazon Elasticsearch Service** in the AWS Management Console.
   - Go to the **Reserved Instances** section to view the list of your reserved instances and their expiration dates.
   - Regularly check this section to stay informed about upcoming expirations.

2. **Set Up CloudWatch Alarms:**
   - Go to the **Amazon CloudWatch** service in the AWS Management Console.
   - Create a new alarm that monitors the `ElasticsearchReservedInstanceLeaseExpiration` metric.
   - Configure the alarm to notify you via email or SMS when a reserved instance is about to expire within the next 7 days.

3. **Enable AWS Budgets:**
   - Navigate to the **AWS Budgets** service in the AWS Management Console.
   - Create a budget specifically for your Elasticsearch reserved instances.
   - Set up notifications to alert you when your reserved instance usage is nearing its expiration date.

4. **Automate Notifications with AWS Lambda:**
   - Create an AWS Lambda function that periodically checks the expiration dates of your Elasticsearch reserved instances.
   - Use the Lambda function to send notifications (e.g., via Amazon SNS) when an instance is within 7 days of expiration.
   - Schedule the Lambda function to run regularly using Amazon CloudWatch Events.

By following these steps, you can proactively monitor and receive alerts about your Elasticsearch reserved instance lease expirations, helping you to take timely action to prevent any disruptions.
</Accordion>

<Accordion title='Using CLI'>
To prevent Elasticsearch Reserved Instance Lease Expiration in the next 7 days using AWS CLI, you can follow these steps:

1. **Check Current Reserved Instances:**
   First, you need to list your current reserved instances to identify which ones are expiring soon.
   ```sh
   aws es describe-reserved-elasticsearch-instances
   ```

2. **Monitor Expiration Dates:**
   Extract and monitor the expiration dates of your reserved instances. You can use a script to filter instances expiring within the next 7 days.
   ```sh
   aws es describe-reserved-elasticsearch-instances --query 'ReservedElasticsearchInstances[?Duration<604800]' --output table
   ```

3. **Purchase New Reserved Instances:**
   If you identify instances that are expiring soon, you can purchase new reserved instances to replace them.
   ```sh
   aws es purchase-reserved-elasticsearch-instance-offering --reserved-elasticsearch-instance-offering-id <offering-id> --instance-count <count>
   ```

4. **Automate Monitoring and Purchasing:**
   To ensure continuous monitoring and automatic purchasing, you can create a Python script or use AWS Lambda to automate these steps. Here is a simple example of a Python script using Boto3:
   ```python
   import boto3
   from datetime import datetime, timedelta

   es_client = boto3.client('es')

   def check_and_purchase_reserved_instances():
       response = es_client.describe_reserved_elasticsearch_instances()
       for instance in response['ReservedElasticsearchInstances']:
           expiration_date = instance['EndTime']
           if expiration_date < datetime.now() + timedelta(days=7):
               offering_id = instance['ReservedElasticsearchInstanceOfferingId']
               es_client.purchase_reserved_elasticsearch_instance_offering(
                   ReservedElasticsearchInstanceOfferingId=offering_id,
                   InstanceCount=1
               )

   check_and_purchase_reserved_instances()
   ```

By following these steps, you can prevent your Elasticsearch Reserved Instance leases from expiring without replacement, ensuring continuous service and cost efficiency.
</Accordion>

<Accordion title='Using Python'>
To prevent Elasticsearch Reserved Instance Lease Expiration in the next 7 days using Python scripts, you can automate the monitoring and renewal process. Here are the steps:

1. **Set Up AWS SDK for Python (Boto3):**
   - Install Boto3 if you haven't already:
     ```bash
     pip install boto3
     ```

2. **Create a Python Script to Monitor Reserved Instances:**
   - Use Boto3 to connect to AWS and check the expiration dates of your Elasticsearch Reserved Instances.
   - Here's a sample script to get you started:
     ```python
     import boto3
     from datetime import datetime, timedelta

     # Initialize a session using Amazon ES
     client = boto3.client('es')

     # Get the current date and the date 7 days from now
     current_date = datetime.now()
     expiration_threshold = current_date + timedelta(days=7)

     # Describe reserved instances
     response = client.describe_reserved_elasticsearch_instances()

     # Check for instances expiring in the next 7 days
     for reserved_instance in response['ReservedElasticsearchInstances']:
         expiration_date = reserved_instance['EndTime']
         if expiration_date <= expiration_threshold:
             print(f"Reserved Instance {reserved_instance['ReservedElasticsearchInstanceId']} is expiring on {expiration_date}")

     ```

3. **Automate Notifications:**
   - Integrate with an email service or SNS (Simple Notification Service) to send alerts when an instance is about to expire.
   - Example using SNS:
     ```python
     import boto3

     sns_client = boto3.client('sns')
     topic_arn = 'arn:aws:sns:your-region:your-account-id:your-topic'

     def send_notification(instance_id, expiration_date):
         message = f"Reserved Instance {instance_id} is expiring on {expiration_date}"
         sns_client.publish(
             TopicArn=topic_arn,
             Message=message,
             Subject='Elasticsearch Reserved Instance Expiration Alert'
         )

     # Add this to the previous script where you check for expiration
     if expiration_date <= expiration_threshold:
         send_notification(reserved_instance['ReservedElasticsearchInstanceId'], expiration_date)
     ```

4. **Schedule the Script:**
   - Use a scheduling tool like cron (Linux) or Task Scheduler (Windows) to run the script daily.
   - Example cron job to run the script daily at midnight:
     ```bash
     0 0 * * * /usr/bin/python3 /path/to/your/script.py
     ```

By following these steps, you can automate the monitoring of your Elasticsearch Reserved Instances and receive timely notifications to prevent lease expiration.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Elasticsearch service.
2. In the Elasticsearch dashboard, select "Reserved Instances" from the left-hand side menu.
3. In the Reserved Instances page, you will see a list of all your reserved instances. Look for the "Expiration Date" column in the table.
4. Check the dates in the "Expiration Date" column. If any of the dates are within the next 7 days, then those Elasticsearch Reserved Instances are about to expire.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can use the "describe-reserved-elasticsearch-instances" command to list all your reserved Elasticsearch instances. The command is as follows:

   ```
   aws es describe-reserved-elasticsearch-instances
   ```

3. This command will return a JSON output with details about all your reserved Elasticsearch instances. You need to look for the "ReservedElasticsearchInstanceOfferingId" field in the output. This field contains the ID of the reserved instance offering.

4. To check if the lease of a reserved Elasticsearch instance will expire in the next 7 days, you need to parse the "End" field in the output. This field contains the date and time when the reserved instance expires. You can use a Python script to parse this field and compare it with the current date and time. If the difference is less than or equal to 7 days, then the lease of the reserved Elasticsearch instance will expire in the next 7 days. Here is a simple Python script that does this:

   ```python
   import json
   import subprocess
   from datetime import datetime, timedelta

   # Run the AWS CLI command and get the output
   output = subprocess.check_output(["aws", "es", "describe-reserved-elasticsearch-instances"])
   data = json.loads(output)

   # Get the current date and time
   now = datetime.now()

   # Check each reserved Elasticsearch instance
   for instance in data["ReservedElasticsearchInstances"]:
       # Parse the end date and time
       end = datetime.strptime(instance["End"], "%Y-%m-%dT%H:%M:%S.%fZ")
       # Check if the lease will expire in the next 7 days
       if now <= end <= now + timedelta(days=7):
           print(f"The lease of the reserved Elasticsearch instance {instance['ReservedElasticsearchInstanceId']} will expire in the next 7 days.")
   ```
   
Please note that the Python script assumes that the "End" field in the output is in the ISO 8601 date and time format. If it's in a different format, you need to adjust the script accordingly.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: To interact with AWS services, you need to install the boto3 library. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Configure AWS credentials: Before you can interact with AWS services, you need to set up your AWS credentials. You can do this by creating a credentials file at ~/.aws/credentials. At a minimum, the credentials file should specify the access key and secret access key. To specify these for the default profile, you can use the following format:

   ```python
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. Write a Python script to check Elasticsearch Reserved Instance Lease Expiration:

   ```python
   import boto3
   from datetime import datetime, timedelta

   # Create a client
   client = boto3.client('es')

   # Get the current date
   current_date = datetime.now()

   # Get all reserved Elasticsearch instances
   response = client.describe_reserved_elasticsearch_instances()

   # Iterate over all instances
   for instance in response['ReservedElasticsearchInstances']:
       # Get the end date of the instance
       end_date = instance['ReservedElasticsearchInstanceEnd']
       # Calculate the difference between the current date and the end date
       difference = end_date - current_date
       # If the difference is less than 7 days, print a warning
       if difference.days < 7:
           print(f"Warning: Elasticsearch Reserved Instance {instance['ReservedElasticsearchInstanceId']} will expire in the next 7 days.")
   ```

4. Run the Python script: You can run the Python script using the following command:

   ```python
   python check_es_lease_expiration.py
   ```

This script will print a warning for each Elasticsearch Reserved Instance that will expire in the next 7 days.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the Elasticsearch Reserved Instance Lease Expiration in the next 7 Days issue in AWS, follow these steps:

1. Log in to the AWS Management Console.

2. Go to the Elasticsearch service.

3. Click on the "Reserved Instances" tab.

4. Look for the instance that has an expiration date in the next 7 days.

5. Click on the "Modify Reserved Instances" button.

6. Select the "Extend the reservation" option.

7. Choose the number of months to extend the reservation for.

8. Click on the "Purchase" button.

9. Review the details of the reservation extension and confirm the purchase.

10. Once the purchase is complete, the Elasticsearch Reserved Instance will be renewed and the expiration date will be extended.

11. Repeat the steps for any other Elasticsearch Reserved Instances that have an expiration date in the next 7 days.

By following these steps, you will be able to remediate the Elasticsearch Reserved Instance Lease Expiration in the next 7 Days issue in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the Elasticsearch Reserved Instance Lease Expiration in the next 7 days in AWS, follow these steps:

1. Open the AWS CLI on your local machine.

2. Check the Elasticsearch Reserved Instance Lease Expiration status by running the following command:

   ```
   aws es describe-reserved-elasticsearch-instance-offerings --query 'ReservedElasticsearchInstanceOfferings[?Duration == `31536000` && FixedPrice == `0.0` && State == `ACTIVE` && UsagePrice == `0.0` && PaymentOption == `AllUpfront` && OfferingType == `HeavyUtilization` && DurationUnits == `Seconds` && ElasticsearchInstanceType == `m4.large.elasticsearch` && ReservedElasticsearchInstanceOfferingId != `null` && Start == `null` && End != `null` && End < `'"$(date -v+7d +%Y-%m-%dT%H:%M:%SZ)"'`]' --output table
   ```

   This command will list all Elasticsearch Reserved Instances with lease expiration in the next 7 days.

3. To remediate this issue, you need to renew the lease of the Elasticsearch Reserved Instances. To do this, run the following command:

   ```
   aws es purchase-reserved-elasticsearch-instances-offering --reserved-elasticsearch-instance-offering-id <RESERVED_INSTANCE_ID> --instance-count <INSTANCE_COUNT> --payment-option AllUpfront
   ```

   Replace `<RESERVED_INSTANCE_ID>` with the ID of the Elasticsearch Reserved Instance that you want to renew, and `<INSTANCE_COUNT>` with the number of instances you want to reserve. This command will renew the lease of the Elasticsearch Reserved Instance for another year.

4. Verify that the Elasticsearch Reserved Instance Lease Expiration status is updated by running the command in step 2 again.

5. Repeat steps 3-4 for any other Elasticsearch Reserved Instances that have lease expiration in the next 7 days.

By following these steps, you can remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using Python, you can follow the below steps:

1. Import the required AWS SDK libraries - Boto3 and Datetime.

```python
import boto3
from datetime import datetime, timedelta
```

2. Create a Boto3 client for Elasticsearch.

```python
es_client = boto3.client('es')
```

3. Get the list of Elasticsearch reserved instances.

```python
reserved_instances = es_client.describe_reserved_elasticsearch_instances()['ReservedElasticsearchInstances']
```

4. Iterate through the reserved instances and check if any of them are expiring in the next 7 days.

```python
for instance in reserved_instances:
    expiration_date = instance['EndTime']
    days_left = (expiration_date - datetime.now()).days
    if days_left <= 7:
        # Remediation steps go here.
```

5. If a reserved instance is expiring in the next 7 days, you can take remediation steps such as renewing the reservation or purchasing a new one. For example, to renew the reservation, you can use the `purchase_reserved_elasticsearch_instance_offering` method.

```python
es_client.purchase_reserved_elasticsearch_instance_offering(
    ReservedElasticsearchInstanceOfferingId='string',
    ReservationName='string',
    InstanceCount=123
)
```

6. Once the remediation steps are completed, you can update your ticketing system or log the remediation in a file.

```python
# Update ticketing system or log the remediation.
```

By following these steps, you can remediate the Elasticsearch Reserved Instance Lease Expiration issue in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-ri.html](https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-ri.html) 

