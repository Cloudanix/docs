---
slug: es_ri_recent_purchases
title: Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed
sidebar_label: Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed
---

### More Info:

All active Amazon Elasticsearch (ES) Reserved Instance purchases should be reviewed every 7 days to make sure that no unwanted RI purchase has been placed recently.

### Risk Level

Low

### Address

Cost Optimisation

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Elasticsearch service. 

2. In the Elasticsearch dashboard, look for the "Reserved Instances" section. This is where you can see all the purchased reserved instances for Elasticsearch.

3. Review the list of purchased reserved instances. Check the "Purchase Date" column to identify recent purchases. 

4. Evaluate the recent purchases based on your organization's usage patterns and needs. Check if the instance type, size, and term match your requirements. If there are any discrepancies or unusual purchases, it might indicate a misconfiguration or an oversight.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by following the instructions provided in the AWS CLI User Guide.

2. List all Elasticsearch domains: Use the following AWS CLI command to list all the Elasticsearch domains in your AWS account.

   ```
   aws es list-domain-names
   ```
   This command will return a list of all Elasticsearch domains in your AWS account.

3. Describe Elasticsearch domain: For each domain listed in the previous step, use the following AWS CLI command to get detailed information about the domain.

   ```
   aws es describe-elasticsearch-domain --domain-name <DomainName>
   ```
   Replace `<DomainName>` with the name of the Elasticsearch domain. This command will return detailed information about the specified Elasticsearch domain, including its configuration.

4. Review Reserved Instance purchases: In the output of the previous command, look for the `ReservedElasticsearchInstanceOfferingId` field. This field indicates the ID of the Reserved Instance offering that was used to purchase the domain. If this field is present and not empty, it means that a Reserved Instance was recently purchased for the domain. You should review this purchase to ensure that it was intentional and is cost-effective.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary libraries: You will need the boto3 library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
from datetime import datetime, timedelta
```

2. Create a session using your AWS credentials. Replace 'your_access_key', 'your_secret_access_key', and 'your_region' with your actual AWS credentials and region.

```python
session = boto3.Session(
    aws_access_key_id='your_access_key',
    aws_secret_access_key='your_secret_access_key',
    region_name='your_region'
)
```

3. Create an Elasticsearch client:

```python
es_client = session.client('es')
```

4. Now, you can use the `describe_reserved_elasticsearch_instances` method to get information about your reserved instances. You can filter the results to only include instances purchased in the last 30 days.

```python
response = es_client.describe_reserved_elasticsearch_instances()

recent_purchases = []
for instance in response['ReservedElasticsearchInstances']:
    purchase_date = instance['StartTime']
    if purchase_date >= datetime.now() - timedelta(days=30):
        recent_purchases.append(instance)

print(recent_purchases)
```

This script will print out information about all Elasticsearch reserved instances that were purchased in the last 30 days. You can review this information to check if there are any instances that need to be reviewed.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
The issue "Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed" indicates that there have been recent purchases of Amazon Elasticsearch Reserved Instances, and these purchases should be reviewed to ensure that they align with your current usage and requirements. Here are the steps to remediate this issue in AWS using the AWS Console:

1. Log in to the AWS Management Console and navigate to the Amazon Elasticsearch Service console.
2. Click on the "Reserved Instances" tab in the left-hand menu.
3. Review the list of recently purchased Reserved Instances and identify any that are not aligned with your current usage or requirements.
4. Select the Reserved Instance(s) that need to be modified or canceled.
5. Click on the "Actions" dropdown menu and select "Modify Reserved Instances" or "Cancel Reserved Instances" as appropriate.
6. Follow the prompts to modify or cancel the Reserved Instance(s).
7. Once you have made any necessary changes, review the Reserved Instances again to ensure that they are aligned with your current usage and requirements.

By following these steps, you can remediate the issue of Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
The Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed misconfiguration in AWS occurs when there are recent purchases of Elasticsearch reserved instances that have not been reviewed for accuracy. To remediate this issue, follow these steps using AWS CLI:

1. Log in to your AWS account using the AWS CLI.

2. Run the following command to list all Elasticsearch reserved instances:

```
aws es describe-reserved-elasticsearch-instances
```

3. Review the output to identify any recent purchases that have not been reviewed.

4. Run the following command to modify the Elasticsearch reserved instance to match your current usage:

```
aws es modify-reserved-elasticsearch-instance --reserved-elasticsearch-instance-id <instance-id> --reserved-elasticsearch-instance-offering-id <offering-id> --elasticsearch-instance-count <instance-count>
```

Replace `<instance-id>` with the ID of the reserved instance that needs to be modified, `<offering-id>` with the ID of the offering that you want to use, and `<instance-count>` with the number of Elasticsearch instances that you want to reserve.

5. Review the output to ensure that the reserved instance has been modified correctly.

6. Run the following command to confirm that the reservation has been applied:

```
aws es describe-reserved-elasticsearch-instances --reserved-elasticsearch-instance-id <instance-id>
```

Replace `<instance-id>` with the ID of the reserved instance that you modified.

7. Review the output to ensure that the reservation has been applied correctly.

By following these steps, you can remediate the Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed misconfiguration in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
The misconfiguration "Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed" means that there are unused or underutilized Elasticsearch reserved instances that were recently purchased. To remediate this issue, you can use the following steps in Python:

1. Get a list of all Elasticsearch reserved instances that are currently active and unused. You can use the `boto3` library to interact with AWS Elasticsearch service and retrieve the list of reserved instances. The following code snippet shows how to retrieve the list of reserved instances:

```
import boto3

client = boto3.client('es')

response = client.describe_reserved_elasticsearch_instances(
    ReservedElasticsearchInstanceId='string',
    MaxResults=123,
    NextToken='string'
)

reserved_instances = response['ReservedElasticsearchInstances']
```

2. Determine the utilization of each reserved instance. You can use CloudWatch metrics to determine the utilization of each reserved instance. The following code snippet shows how to retrieve the average CPU utilization metric for a reserved instance:

```
import boto3

cloudwatch = boto3.client('cloudwatch')

response = cloudwatch.get_metric_statistics(
    Namespace='AWS/ES',
    MetricName='CPUUtilization',
    Dimensions=[
        {
            'Name': 'ReservedElasticsearchInstanceId',
            'Value': 'string'
        },
    ],
    StartTime='datetime(2015, 1, 1)',
    EndTime='datetime(2015, 1, 2)',
    Period=123,
    Statistics=[
        'Average',
    ],
    Unit='Percent'
)

utilization = response['Datapoints'][0]['Average']
```

3. Identify the reserved instances that have low utilization. You can set a threshold for the utilization and identify the reserved instances that have utilization below the threshold. For example, if you set the threshold to 20%, you can identify the reserved instances that have utilization below 20%.

```
low_utilization_instances = []
threshold = 20

for instance in reserved_instances:
    instance_id = instance['ReservedElasticsearchInstanceId']
    utilization = get_utilization(instance_id)
    if utilization < threshold:
        low_utilization_instances.append(instance_id)
```

4. Review the list of reserved instances with low utilization and determine if they can be released or if the instance type can be changed to better match the workload. If the reserved instances can be released, you can use the `boto3` library to release the Elasticsearch reserved instances. The following code snippet shows how to release a reserved instance:

```
import boto3

client = boto3.client('es')

client.purchase_reserved_elasticsearch_instance_offering(
    ReservedElasticsearchInstanceId='string'
)
```

By following these steps, you can remediate the misconfiguration "Elasticsearch Reserved Instance Recent Purchases Should Be Reviewed" for AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-ri.html](https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/aes-ri.html) 

