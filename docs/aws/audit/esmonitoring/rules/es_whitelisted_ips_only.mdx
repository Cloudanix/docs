---
slug: es_whitelisted_ips_only
title: Elasticsearch Domains Should Be Accessible Only From Whitelisted IP Addresses
sidebar_label: Elasticsearch Domains Should Be Accessible Only From Whitelisted IP Addresses
---

### More Info:

The access to your Elasticsearch Service (ES) domains should be made based on whitelisted IP addresses only in order to protect them against unauthorized access

### Risk Level

High

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Amazon Elasticsearch Service dashboard. 
3. In the navigation pane, choose "Domains".
4. Select the Elasticsearch domain that you want to examine. In the "Access Policy" section, check if the policy allows access from IP addresses other than the ones that are whitelisted. If the policy allows access from any IP address (0.0.0.0/0), then the selected Elasticsearch domain is accessible from any IP, which is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI. Make sure you have the necessary permissions to access the Elasticsearch domains.

2. List all the Elasticsearch domains using the following command:
```
aws es list-domain-names
```
This command will return a list of all Elasticsearch domain names.

3. For each domain, you can describe the Elasticsearch domain configuration using the following command:
```
aws es describe-elasticsearch-domain-config --domain-name <your-domain-name>
```
Replace `<your-domain-name>` with the name of your Elasticsearch domain. This command will return the configuration information of the specified Elasticsearch domain.

4. Check the `AccessPolicies` in the output of the above command. This policy defines who can access the Elasticsearch domain and their permissions. If the `AccessPolicies` allows access from IP addresses that are not in your whitelist, then the Elasticsearch domain is misconfigured. The `AccessPolicies` should only allow access from whitelisted IP addresses.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary libraries and establish a connection with AWS using Boto3 in Python. Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
from botocore.exceptions import BotoCoreError, ClientError

# Create an AWS session
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)

# Create an Elasticsearch client
es_client = session.client('es')
```

2. List all the Elasticsearch domains using the `list_domain_names` function. Then, for each domain, get the access policy using the `describe_elasticsearch_domain_config` function.

```python
try:
    # List all Elasticsearch domains
    domains = es_client.list_domain_names()
except ClientError as e:
    print(f"Error: {e}")

for domain in domains['DomainNames']:
    try:
        # Get the access policy for each domain
        response = es_client.describe_elasticsearch_domain_config(DomainName=domain['DomainName'])
        access_policy = response['DomainConfig']['AccessPolicies']['Options']
    except ClientError as e:
        print(f"Error: {e}")
```

3. Parse the access policy to check if it allows access from IP addresses that are not in the whitelist. The access policy is in JSON format and can be parsed using the `json` library in Python. If the `Principal` field in the policy is set to `AWS: "*"`, it means that the domain is accessible from any IP address.

```python
import json

for domain in domains['DomainNames']:
    try:
        response = es_client.describe_elasticsearch_domain_config(DomainName=domain['DomainName'])
        access_policy = response['DomainConfig']['AccessPolicies']['Options']
        policy = json.loads(access_policy)

        for statement in policy['Statement']:
            if statement['Principal'] == {"AWS": "*"}:
                print(f"Domain {domain['DomainName']} is accessible from any IP address.")
    except ClientError as e:
        print(f"Error: {e}")
```

4. If the `Principal` field is not set to `AWS: "*"`, check the `IpAddress` field in the `Condition` section of the policy. If the IP address is not in the whitelist, print a message.

```python
whitelist = ['192.0.2.0/24', '203.0.113.0/24']  # Replace with your IP whitelist

for domain in domains['DomainNames']:
    try:
        response = es_client.describe_elasticsearch_domain_config(DomainName=domain['DomainName'])
        access_policy = response['DomainConfig']['AccessPolicies']['Options']
        policy = json.loads(access_policy)

        for statement in policy['Statement']:
            if 'IpAddress' in statement['Condition']['IpAddress']:
                ip_address = statement['Condition']['IpAddress']['aws:SourceIp']
                if ip_address not in whitelist:
                    print(f"Domain {domain['DomainName']} is accessible from a non-whitelisted IP address: {ip_address}")
    except ClientError as e:
        print(f"Error: {e}")
```

This script will print a message for each Elasticsearch domain that is accessible from a non-whitelisted IP address.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the Elasticsearch Domains Should Be Accessible Only From Whitelisted IP Addresses misconfiguration in AWS, follow these steps:

1. Login to your AWS console and navigate to the Elasticsearch service.

2. Select the Elasticsearch domain that you want to remediate.

3. Click on the "Modify access policy" button.

4. In the "Access policy" section, select the "Custom access policy" option.

5. Replace the existing policy with the following policy:

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "es:*",
      "Condition": {
        "IpAddress": {
          "aws:SourceIp": [
            "x.x.x.x/32",
            "y.y.y.y/32"
          ]
        }
      },
      "Resource": "arn:aws:es:us-west-2:123456789012:domain/my-domain/*"
    }
  ]
}
```

6. Replace the `x.x.x.x/32` and `y.y.y.y/32` with the IP addresses that you want to whitelist.

7. Click on the "Save changes" button to save the new access policy.

This will ensure that only the whitelisted IP addresses will be able to access the Elasticsearch domain.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of Elasticsearch domains being accessible only from whitelisted IP addresses in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to get the Elasticsearch domain endpoint:

```
aws es describe-elasticsearch-domain --domain-name <your-domain-name> --output text --query 'DomainStatus.Endpoint'
```

3. Run the following command to get the current access policy of the Elasticsearch domain:

```
aws es describe-elasticsearch-domain --domain-name <your-domain-name> --output text --query 'DomainStatus.AccessPolicies'
```

4. Copy the output of the above command to a text editor and edit the access policy to allow access only from the whitelisted IP addresses.

5. Run the following command to update the access policy of the Elasticsearch domain:

```
aws es update-elasticsearch-domain-config --domain-name <your-domain-name> --access-policies <path-to-edited-access-policy-file>
```

Replace `<path-to-edited-access-policy-file>` with the path to the file containing the edited access policy.

6. Verify that the access policy has been updated by running the following command:

```
aws es describe-elasticsearch-domain --domain-name <your-domain-name> --output text --query 'DomainStatus.AccessPolicies'
```

The output should show the updated access policy.

7. Test the Elasticsearch domain to ensure that it is accessible only from the whitelisted IP addresses.
</Accordion>

<Accordion title='Using Python'>
To remediate this misconfiguration for AWS Elasticsearch domains, you can use the AWS Python SDK, Boto3. Here are the steps to remediate:

1. Install Boto3: You can install Boto3 using pip. Run the following command in your terminal or command prompt:

   ```
   pip install boto3
   ```

2. Create a Boto3 client for Elasticsearch: In your Python script, create a Boto3 client for Elasticsearch using the following code:

   ```python
   import boto3

   es_client = boto3.client('es')
   ```

3. Get the Elasticsearch domain configuration: Use the `describe_elasticsearch_domain_config` method of the Elasticsearch client to get the current domain configuration. Here is an example code:

   ```python
   domain_name = 'your-domain-name'

   response = es_client.describe_elasticsearch_domain_config(
       DomainName=domain_name
   )

   domain_config = response['DomainConfig']
   ```

4. Update the Elasticsearch domain access policy: Update the access policy of the Elasticsearch domain to allow access only from whitelisted IP addresses. You can use the `update_elasticsearch_domain_config` method of the Elasticsearch client to update the access policy. Here is an example code:

   ```python
   # Whitelist IP addresses
   ip_addresses = ['1.2.3.4', '5.6.7.8']

   # Create the access policy
   access_policy = {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Principal": {
                   "AWS": "*"
               },
               "Action": "es:*",
               "Condition": {
                   "IpAddress": {
                       "aws:SourceIp": ip_addresses
                   }
               },
               "Resource": "arn:aws:es:us-east-1:123456789012:domain/your-domain-name/*"
           }
       ]
   }

   # Update the Elasticsearch domain configuration
   es_client.update_elasticsearch_domain_config(
       DomainName=domain_name,
       ElasticsearchClusterConfig=domain_config['ElasticsearchClusterConfig'],
       EBSOptions=domain_config['EBSOptions'],
       SnapshotOptions=domain_config['SnapshotOptions'],
       AdvancedOptions=domain_config['AdvancedOptions'],
       AccessPolicies=json.dumps(access_policy)
   )
   ```

   In the above code, replace `ip_addresses` with a list of the IP addresses that should be whitelisted.

5. Verify the Elasticsearch domain configuration: Use the `describe_elasticsearch_domain_config` method of the Elasticsearch client to verify that the access policy has been updated. Here is an example code:

   ```python
   response = es_client.describe_elasticsearch_domain_config(
       DomainName=domain_name
   )

   access_policies = json.loads(response['DomainConfig']['AccessPolicies'])

   print(access_policies)
   ```

   The above code will print the updated access policy. Verify that the IP addresses in the access policy match the whitelisted IP addresses.

That's it! The Elasticsearch domain is now accessible only from the whitelisted IP addresses.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://aws.amazon.com/blogs/security/how-to-control-access-to-your-amazon-elasticsearch-service-domain/](https://aws.amazon.com/blogs/security/how-to-control-access-to-your-amazon-elasticsearch-service-domain/) 

