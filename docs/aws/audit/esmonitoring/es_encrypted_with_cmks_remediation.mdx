### Remediation

How to encrypt an existing AWS ElasticSearch domain with your own KMS Customer Master Key?

#### Using AWS Console

- Step 1: In the left navigation panel click Encryption Keys. Select the appropriate AWS region from the Filter menu. (must match the region where your ES domain is provisioned).

- Step 2: Click Create Key button from the dashboard top menu. In the Alias and Description fields, enter a unique name (alias) and a description for the new CMK, then click the Next.

- Step 3: Under Key Administrators section, select which IAM users and/or roles can administer the new CMK, then click Next Step.

- Step 4: Under This Account section, select which IAM users and/or roles can use the new CMK to encrypt/decrypt the domain data with the AWS KMS API.

- Step 5: (Optional) Under External Accounts section, click Add an External Account and enter an external account ID in order to add another AWS account that can use this CMK to encrypt/decrypt the ES domain (cluster) data. The owners of the external AWS accounts must also provide access to this CMK by creating appropriate policies for their IAM users.

- Step 6: Click Next. Under the Preview Key Policy section, review the key policy generated by AWS then click Finish to create your new CMK. Once the key is created, the KMS dashboard displays a confirmation: “Your master key was created successfully. Alias: the CMK display name”.

- Step 7: Now that the KMS key has been created, navigate to ElasticSearch (ES) dashboard at https://console.aws.amazon.com/es/.

- Step 8: Choose the ES domain that you want to relaunch and click on the domain name (link) to access its configuration page.

- Step 9: On the domain configuration page, perform the following actions:
  A: Select the Overview tab and copy the domain configuration information such as Instance count, Instance type, Dedicated master instance type, Dedicated master instance count, Storage Type, EBS volume type, EBS volume size and so on.
  B: Select the VPC tab and copy the network configuration information such as VPC ID, Security groups ID(s), IAM role name and AZs and Subnets IDs.
  C: Click on Modify access policy button from the dashboard top menu and copy the policy document available in the Add or edit the access policy textbox.

- Step 10: Go back to the AWS ElasticSearch service dashboard and click Create new domain to launch a new ES domain. On the Define domain page, perform the following actions:
  A: Provide a unique name for the new ES domain in the Elasticsearch domain name box.
  B: Select the right version of the Elasticsearch engine from the Elasticsearch version dropdown list.
  C: Click Next to continue the setup process.

- Step 11: On the Configure cluster page, perform the following:
  A: Set the new domain parameters using the configuration details copied at step no. 14a.
  B: Select Enable encryption at rest checkbox to enable data-at-rest encryption feature for the new ES domain. From the KMS master key dropdown list choose your newly created AWS KMS Customer Master Key or select Enter a key ARN and paste the new CMK ARN into the ARN/ID box. Then click Next.

- Step 12: On the Set up access page, configure the network access to the new ES domain by using the same parameters copied at step no. 14 b. Also, paste the access policy copied at step no. 14 c. into the Add or edit the access policy textbox to use the same access policy as the source domain, then click the Next button to continue.

- Step 13: On the Review page, verify the domain configuration details then click Confirm to launch your new AWS ElasticSearch domain, encrypted with the custom KMS key.

- Step 14: Once the new AWS ES domain is created, upload the data from the source domain to the new (destination) ES cluster.

- Step 15: Now it’s safe to remove the source ElasticSearch domain from your AWS account to avoid further charges. To delete the required domain, perform the following:
  A: Click on the name of the domain that you want to remove (see Audit section part I to identify the right ElasticSearch resource).
  B: On the selected domain description page, click Delete domain to start the removal process.
  C: Within Delete domain dialog box, check Delete the domain <domain_name> then click the Delete button to confirm the action.
