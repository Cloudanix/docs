
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EKS Clusters from not having logging enabled in Kubernetes using the AWS Management Console, follow these steps:

1. **Navigate to the EKS Console:**
   - Open the AWS Management Console.
   - In the search bar, type "EKS" and select "Elastic Kubernetes Service" from the dropdown.

2. **Create or Select an EKS Cluster:**
   - If you are creating a new cluster, click on "Add cluster" and then "Create" to start the cluster creation process.
   - If you are modifying an existing cluster, select the cluster from the list.

3. **Configure Logging During Cluster Creation:**
   - During the cluster creation process, in the "Configure logging" section, enable the desired log types (API, Audit, Authenticator, ControllerManager, Scheduler).
   - Ensure that you select the appropriate log types that you want to enable for your cluster.

4. **Save and Review:**
   - Complete the remaining steps for cluster creation or modification.
   - Review your settings and ensure that logging is enabled as configured.
   - Click "Create" or "Update" to apply the changes.

By following these steps, you can ensure that logging is enabled for your EKS clusters, which helps in monitoring and troubleshooting your Kubernetes environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of EKS clusters not having logging enabled in Kubernetes using AWS CLI, follow these steps:

1. **Create an EKS Cluster with Logging Enabled:**
   When creating a new EKS cluster, you can specify the logging configuration to ensure that logging is enabled. Use the `--logging` parameter to specify the types of logs you want to enable.

   ```sh
   aws eks create-cluster \
     --name my-cluster \
     --role-arn arn:aws:iam::123456789012:role/EKS-Cluster-Role \
     --resources-vpc-config subnetIds=subnet-abc123,subnet-def456,securityGroupIds=sg-123abc \
     --logging '{"clusterLogging":[{"types":["api","audit","authenticator","controllerManager","scheduler"],"enabled":true}]}'
   ```

2. **Update Logging Configuration for an Existing EKS Cluster:**
   If you have an existing EKS cluster, you can update its logging configuration using the `update-cluster-config` command.

   ```sh
   aws eks update-cluster-config \
     --name my-cluster \
     --logging '{"clusterLogging":[{"types":["api","audit","authenticator","controllerManager","scheduler"],"enabled":true}]}'
   ```

3. **Verify Logging Configuration:**
   After creating or updating the cluster, verify that the logging configuration is correctly set by describing the cluster.

   ```sh
   aws eks describe-cluster --name my-cluster --query "cluster.logging"
   ```

4. **Automate Logging Configuration in Cluster Creation Scripts:**
   Ensure that any scripts or automation tools you use to create EKS clusters include the logging configuration. This can be done by embedding the `--logging` parameter in your cluster creation scripts.

   Example script snippet:
   ```sh
   #!/bin/bash
   CLUSTER_NAME="my-cluster"
   ROLE_ARN="arn:aws:iam::123456789012:role/EKS-Cluster-Role"
   SUBNET_IDS="subnet-abc123,subnet-def456"
   SECURITY_GROUP_IDS="sg-123abc"

   aws eks create-cluster \
     --name $CLUSTER_NAME \
     --role-arn $ROLE_ARN \
     --resources-vpc-config subnetIds=$SUBNET_IDS,securityGroupIds=$SECURITY_GROUP_IDS \
     --logging '{"clusterLogging":[{"types":["api","audit","authenticator","controllerManager","scheduler"],"enabled":true}]}'
   ```

By following these steps, you can ensure that logging is enabled for your EKS clusters, helping to prevent misconfigurations related to logging.
</Accordion>

<Accordion title='Using Python'>
To prevent EKS Clusters from being created without logging enabled using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps to ensure that logging is enabled when creating an EKS cluster:

1. **Install Boto3**:
   Ensure you have Boto3 installed. If not, you can install it using pip.
   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by setting environment variables.

3. **Create a Python Script to Enable Logging**:
   Use the following Python script to create an EKS cluster with logging enabled. This script ensures that all the necessary logging types are enabled during the cluster creation.

   ```python
   import boto3

   # Initialize a session using Amazon EKS
   session = boto3.Session(region_name='us-west-2')  # Replace with your desired region
   eks_client = session.client('eks')

   # Define the logging configuration
   logging_config = {
       'clusterLogging': [
           {
               'types': [
                   'api',
                   'audit',
                   'authenticator',
                   'controllerManager',
                   'scheduler'
               ],
               'enabled': True
           }
       ]
   }

   # Create the EKS cluster with logging enabled
   response = eks_client.create_cluster(
       name='my-eks-cluster',  # Replace with your desired cluster name
       version='1.21',  # Replace with your desired Kubernetes version
       roleArn='arn:aws:iam::123456789012:role/EKSClusterRole',  # Replace with your IAM role ARN
       resourcesVpcConfig={
           'subnetIds': [
               'subnet-abcde123',  # Replace with your subnet IDs
               'subnet-abcde456'
           ],
           'securityGroupIds': [
               'sg-abcde123'  # Replace with your security group IDs
           ]
       },
       logging=logging_config
   )

   print("Cluster creation initiated with logging enabled:", response)
   ```

4. **Run the Script**:
   Execute the script to create the EKS cluster with logging enabled.
   ```bash
   python create_eks_cluster_with_logging.py
   ```

This script ensures that the EKS cluster is created with logging enabled for API, audit, authenticator, controller manager, and scheduler logs. Adjust the parameters such as region, cluster name, Kubernetes version, IAM role ARN, subnet IDs, and security group IDs as per your requirements.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Amazon EKS console at https://console.aws.amazon.com/eks/home#/clusters.
3. Select the EKS cluster you want to check.
4. In the cluster details page, under the "Logging" section, check if the "CloudWatch Logs" are enabled. If the status is "Enabled", it means that logging is enabled for the EKS cluster. If the status is "Disabled", it means that logging is not enabled for the EKS cluster.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: To interact with AWS services, you need to install the boto3 library. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Configure AWS credentials: Before you can interact with AWS services, you need to set up your AWS credentials. You can do this by setting the following environment variables:

   ```bash
   export AWS_ACCESS_KEY_ID='your_access_key'
   export AWS_SECRET_ACCESS_KEY='your_secret_key'
   ```

3. Create a Python script to check the logging configuration of EKS clusters:

   ```python
   import boto3

   def check_eks_logging():
       client = boto3.client('eks')
       clusters = client.list_clusters()['clusters']
       for cluster in clusters:
           response = client.describe_cluster(name=cluster)
           logging = response['cluster']['logging']['clusterLogging']
           for log in logging:
               if log['enabled']:
                   print(f"Logging is enabled for {log['types']} in {cluster}")
               else:
                   print(f"Logging is not enabled for {log['types']} in {cluster}")

   if __name__ == '__main__':
       check_eks_logging()
   ```

4. Run the Python script: You can run the Python script from the command line using the python command:

   ```bash
   python check_eks_logging.py
   ```

This script will list all the EKS clusters in your AWS account and check if logging is enabled for each of them. If logging is enabled, it will print the types of logs that are enabled. If logging is not enabled, it will print the types of logs that are not enabled.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of EKS clusters not having logging enabled in AWS using the AWS console, please follow the below steps:

1. Log in to the AWS Management Console.
2. Navigate to the Amazon EKS console.
3. Select the EKS cluster that you want to enable logging for.
4. Click on the "Configuration" tab.
5. Under the "Logging" section, click on the "Edit" button.
6. Select the "Enable logging" checkbox.
7. Choose the "Create a new S3 bucket" option or select an existing S3 bucket from the dropdown menu.
8. Enter a unique name for the S3 bucket.
9. Click on the "Save" button to save the changes.

Once the above steps are completed, the EKS cluster will have logging enabled, and logs will be stored in the specified S3 bucket.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "EKS Clusters Should Have Logging Enabled" for AWS using AWS CLI, follow the below steps:

1. Open the AWS CLI on your local machine.

2. Check the current status of logging for your EKS cluster by running the following command:

   ```
   aws eks describe-cluster --name <cluster_name> --query "cluster.logging"
   ```

   This command will return the current logging status of your EKS cluster.

3. If the logging is not enabled, run the following command to update the logging status:

   ```
   aws eks update-cluster-config --name <cluster_name> --logging '{"clusterLogging":[{"types":["api","audit","authenticator","controllerManager","scheduler"],"enabled":true}]}'
   ```

   This command will enable logging for your EKS cluster.

4. Verify that the logging is enabled by running the following command again:

   ```
   aws eks describe-cluster --name <cluster_name> --query "cluster.logging"
   ```

   This command should return the updated logging status of your EKS cluster.

By following these steps, you can remediate the misconfiguration "EKS Clusters Should Have Logging Enabled" for AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of EKS clusters not having logging enabled, you can use the following steps in Python:

1. First, you need to import the necessary libraries for AWS SDK for Python (Boto3) and EKS service:

```
import boto3
from botocore.exceptions import ClientError
```

2. Next, you need to create an AWS session and EKS client:

```
session = boto3.session.Session(region_name='your_region')
eks_client = session.client('eks')
```

3. Then, you can use the `describe_cluster` function to get the logging configuration of the EKS cluster:

```
response = eks_client.describe_cluster(name='your_cluster_name')
logging_enabled = response['cluster']['logging']['clusterLogging'][0]['enabled']
```

4. If `logging_enabled` is `False`, you can use the `update_cluster_config` function to enable logging:

```
if not logging_enabled:
    logging_config = {
        'types': ['api', 'audit', 'authenticator', 'controllerManager', 'scheduler'],
        'enabled': True
    }
    update_config = {
        'logging': logging_config
    }
    eks_client.update_cluster_config(name='your_cluster_name', resourcesVpcConfig=update_config)
```

5. Finally, you can print a message to confirm that logging has been enabled:

```
print('Logging has been enabled for the EKS cluster.')
```

Note: Make sure you have the necessary permissions and credentials to access the EKS cluster and enable logging.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
