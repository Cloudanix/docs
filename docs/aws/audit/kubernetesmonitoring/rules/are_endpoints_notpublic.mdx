---
slug: are_endpoints_notpublic
title: Endpoints Should Not Be Publicly Accessible
sidebar_label: Endpoints Should Not Be Publicly Accessible
---

### More Info:

Your Amazon EKS cluster API server endpoints should not be publicly accessible from the Internet in order to avoid exposing private data and minimizing security risks. The level of access to your Kubernetes API server endpoints depends on your EKS application use cases. It is recommended that the API server endpoints should be accessible only from within your AWS VPC.

### Risk Level

Low

### Address

Security

### Compliance Standards

HITRUST, CISEKS, SOC2, NISTCSF, PCIDSS



### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Kubernetes endpoints from being publicly accessible in AWS using the AWS Management Console, follow these steps:

1. **Configure Security Groups:**
   - Navigate to the **EC2 Dashboard**.
   - Select **Security Groups** from the left-hand menu.
   - Identify the security group associated with your Kubernetes nodes and control plane.
   - Edit the inbound rules to restrict access. Remove any rules that allow public access (e.g., rules with a source of `0.0.0.0/0` or `::/0`).
   - Add specific IP ranges or CIDR blocks that are allowed to access the Kubernetes endpoints.

2. **Set Up Private Subnets:**
   - Go to the **VPC Dashboard**.
   - Select **Subnets** from the left-hand menu.
   - Ensure that your Kubernetes nodes and control plane are deployed in private subnets. Private subnets do not have a route to an Internet Gateway.
   - If necessary, create new private subnets and update your Kubernetes cluster configuration to use these subnets.

3. **Configure Network ACLs:**
   - In the **VPC Dashboard**, select **Network ACLs** from the left-hand menu.
   - Identify the Network ACL associated with the subnets where your Kubernetes cluster is deployed.
   - Edit the inbound and outbound rules to restrict access. Ensure that rules do not allow public access (e.g., rules with a source or destination of `0.0.0.0/0` or `::/0`).
   - Add specific IP ranges or CIDR blocks that are allowed to access the Kubernetes endpoints.

4. **Use AWS PrivateLink:**
   - Navigate to the **VPC Dashboard**.
   - Select **Endpoints** from the left-hand menu.
   - Create a new VPC endpoint for your Kubernetes API server using AWS PrivateLink.
   - Ensure that the endpoint is associated with the appropriate VPC and subnets.
   - Update your Kubernetes cluster configuration to use the VPC endpoint for API server communication, ensuring that traffic does not traverse the public internet.

By following these steps, you can ensure that your Kubernetes endpoints are not publicly accessible, thereby enhancing the security of your cluster.
</Accordion>

<Accordion title='Using CLI'>
To prevent Kubernetes endpoints from being publicly accessible in AWS using the AWS CLI, you can follow these steps:

1. **Create a Private VPC:**
   Ensure your Kubernetes cluster is deployed within a private VPC. This will prevent the endpoints from being publicly accessible.

   ```sh
   aws ec2 create-vpc --cidr-block 10.0.0.0/16
   ```

2. **Create Subnets:**
   Create private subnets within the VPC for your Kubernetes nodes.

   ```sh
   aws ec2 create-subnet --vpc-id <vpc-id> --cidr-block 10.0.1.0/24
   aws ec2 create-subnet --vpc-id <vpc-id> --cidr-block 10.0.2.0/24
   ```

3. **Configure Security Groups:**
   Set up security groups to restrict access to the Kubernetes API server. Only allow access from trusted IP addresses or internal networks.

   ```sh
   aws ec2 create-security-group --group-name k8s-sg --description "Kubernetes security group" --vpc-id <vpc-id>
   aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 6443 --cidr <trusted-ip-range>
   ```

4. **Update EKS Cluster Endpoint Access:**
   Modify the EKS cluster endpoint access to be private.

   ```sh
   aws eks update-cluster-config --name <cluster-name> --resources-vpc-config endpointPublicAccess=false,endpointPrivateAccess=true
   ```

By following these steps, you can ensure that your Kubernetes endpoints are not publicly accessible, thereby enhancing the security of your cluster.
</Accordion>

<Accordion title='Using Python'>
To prevent Kubernetes endpoints from being publicly accessible using Python scripts, you can follow these steps:

### 1. **Set Up Kubernetes Client in Python**
First, you need to install the Kubernetes client library for Python and set up the client to interact with your Kubernetes cluster.

```bash
pip install kubernetes
```

```python
from kubernetes import client, config

# Load kube config from default location
config.load_kube_config()
v1 = client.CoreV1Api()
```

### 2. **Restrict Service Type to ClusterIP**
Ensure that services are created with the `ClusterIP` type, which is only accessible within the cluster.

```python
def create_cluster_ip_service(namespace, service_name, labels, port):
    service = client.V1Service(
        metadata=client.V1ObjectMeta(name=service_name, labels=labels),
        spec=client.V1ServiceSpec(
            type="ClusterIP",
            ports=[client.V1ServicePort(port=port, target_port=port)],
            selector=labels
        )
    )
    v1.create_namespaced_service(namespace=namespace, body=service)

# Example usage
create_cluster_ip_service("default", "my-service", {"app": "my-app"}, 80)
```

### 3. **Update Existing Services to ClusterIP**
If there are existing services that are of type `LoadBalancer` or `NodePort`, update them to `ClusterIP`.

```python
def update_service_to_cluster_ip(namespace, service_name):
    service = v1.read_namespaced_service(name=service_name, namespace=namespace)
    service.spec.type = "ClusterIP"
    v1.patch_namespaced_service(name=service_name, namespace=namespace, body=service)

# Example usage
update_service_to_cluster_ip("default", "my-service")
```

### 4. **Ensure Network Policies are in Place**
Create network policies to restrict traffic to and from your services.

```python
def create_network_policy(namespace, policy_name, pod_selector, ingress_rules):
    policy = client.V1NetworkPolicy(
        metadata=client.V1ObjectMeta(name=policy_name),
        spec=client.V1NetworkPolicySpec(
            pod_selector=client.V1LabelSelector(match_labels=pod_selector),
            ingress=ingress_rules
        )
    )
    v1.create_namespaced_network_policy(namespace=namespace, body=policy)

# Example usage
ingress_rule = client.V1NetworkPolicyIngressRule(
    from_=[
        client.V1NetworkPolicyPeer(
            pod_selector=client.V1LabelSelector(match_labels={"app": "my-app"})
        )
    ]
)
create_network_policy("default", "restrict-access", {"app": "my-app"}, [ingress_rule])
```

By following these steps, you can ensure that your Kubernetes endpoints are not publicly accessible, thereby enhancing the security of your cluster.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Amazon EKS service.
2. In the left navigation pane, select "Clusters" to view all the existing Kubernetes clusters.
3. Click on the name of the cluster you want to inspect. This will open the cluster details page.
4. In the cluster details page, under the "Networking" section, check the "Endpoint Public Access" setting. If it is enabled, it means the Kubernetes API server endpoint is publicly accessible.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start, you need to install the AWS CLI on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```
   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all the Kubernetes clusters: Use the following command to list all the Kubernetes clusters in your AWS account:

   ```
   aws eks list-clusters
   ```
   This command will return a list of all the EKS clusters in your account.

3. Describe the Kubernetes cluster: For each cluster, use the following command to get detailed information about the cluster:

   ```
   aws eks describe-cluster --name <cluster-name>
   ```
   Replace `<cluster-name>` with the name of your cluster. This command will return a JSON object with detailed information about the cluster.

4. Check the endpoint accessibility: In the output of the previous command, look for the `endpointPublicAccess` field. If this field is set to `true`, then the Kubernetes API server endpoint is publicly accessible. If it's set to `false`, then the endpoint is not publicly accessible.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: You will need the Kubernetes Python client to interact with the Kubernetes API. You can install it using pip:

```python
pip install kubernetes
```

2. Connect to the Kubernetes API: Use the `config.load_kube_config()` function from the Kubernetes client to connect to the API. This will use your kubeconfig file to establish a connection.

```python
from kubernetes import client, config

config.load_kube_config()
v1 = client.CoreV1Api()
```

3. Get a list of all services: Use the `list_service_for_all_namespaces()` function to get a list of all services in all namespaces.

```python
services = v1.list_service_for_all_namespaces().items
```

4. Check each service for public endpoints: For each service, check the `spec.type` field. If it is set to `LoadBalancer`, the service is publicly accessible. You can print out the name and namespace of any such services.

```python
for svc in services:
    if svc.spec.type == 'LoadBalancer':
        print(f"Publicly accessible service: {svc.metadata.name} in namespace {svc.metadata.namespace}")
```

This script will print out the names and namespaces of all services that are publicly accessible. You can then take appropriate action to secure these services.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step-by-step instructions on how to remediate the "Endpoints Should Not Be Publicly Accessible" misconfiguration in AWS using the AWS console:

1. Log in to the AWS Management Console.
2. Go to the Amazon VPC service.
3. Click on "Endpoints" in the left navigation pane.
4. Select the endpoint that you want to remediate.
5. Click on the "Actions" button and select "Modify Endpoint".
6. In the "Modify Endpoint" dialog box, select the "Private" option for the endpoint.
7. Click "Save Changes" to apply the changes.

After following these steps, the endpoint will no longer be publicly accessible and will only be accessible through the VPC.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate this misconfiguration in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all VPC endpoints in your AWS account:

```
aws ec2 describe-vpc-endpoints
```

3. Identify the VPC endpoint that is publicly accessible.

4. Run the following command to modify the VPC endpoint to make it not publicly accessible:

```
aws ec2 modify-vpc-endpoint --vpc-endpoint-id <VPC_ENDPOINT_ID> --no-public-dns-enabled --policy-document '{"Statement":[{"Effect":"Deny","Principal":"*","Action":"*","Resource":"*"}],"Version":"2012-10-17"}'
```

Replace `<VPC_ENDPOINT_ID>` with the ID of the VPC endpoint that you identified in step 3.

5. Verify that the VPC endpoint is no longer publicly accessible by running the following command:

```
aws ec2 describe-vpc-endpoints --vpc-endpoint-ids <VPC_ENDPOINT_ID>
```

This command should return an output that includes `"PrivateDnsEnabled": true` and `"PolicyDocument": {"Statement": [{"Effect": "Deny", "Principal": "*", "Action": "*", "Resource": "*"}], "Version": "2012-10-17"}` for the VPC endpoint that you modified.

6. Repeat steps 3-5 for any other publicly accessible VPC endpoints in your AWS account.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "Endpoints Should Not Be Publicly Accessible" for AWS using Python, follow these steps:

1. Identify the endpoints that are publicly accessible. You can use the AWS CLI command `aws ec2 describe-security-groups` to list all security groups and their associated rules.

2. For each security group that has a rule allowing public access to an endpoint, you will need to remove the rule. You can use the AWS CLI command `aws ec2 revoke-security-group-ingress` to remove the rule.

3. To automate this process using Python, you can use the Boto3 library, which is the AWS SDK for Python. Here is an example code snippet that will remove all rules allowing public access to endpoints for a specific security group:

```python
import boto3

# Replace <security-group-id> with the actual ID of the security group
security_group_id = '<security-group-id>'

# Create an EC2 client
ec2 = boto3.client('ec2')

# Describe the security group to get its current rules
response = ec2.describe_security_groups(GroupIds=[security_group_id])
security_group = response['SecurityGroups'][0]

# Remove all rules allowing public access to endpoints
for rule in security_group['IpPermissions']:
    if rule['IpRanges'][0]['CidrIp'] == '0.0.0.0/0':
        ec2.revoke_security_group_ingress(
            GroupId=security_group_id,
            IpPermissions=[rule]
        )
```

4. You can run this Python script as a Lambda function and schedule it to run periodically to ensure that any new endpoints that are publicly accessible are remediated automatically. You can also modify the script to remediate all security groups in your AWS account, not just a specific one.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html](https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html) 

