

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the Amazon EKS service.
2. In the left navigation pane, select "Clusters" to view all the existing EKS clusters.
3. Click on the name of the cluster you want to inspect. This will open the cluster's details page.
4. In the cluster's details page, under the "Networking" section, check the "Security groups for your nodes". Click on the security group ID to open the security group settings. In the "Inbound rules" tab, verify if there is any rule that allows inbound traffic on ports other than 443. If such a rule exists, it indicates a misconfiguration.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can use the "aws eks describe-cluster" command to get the details of your EKS cluster. The command is as follows:

   ```
   aws eks describe-cluster --name <your-cluster-name>
   ```
   Replace `<your-cluster-name>` with the name of your EKS cluster. This command will return a JSON output with all the details of your EKS cluster.

3. From the JSON output, you can find the "resourcesVpcConfig" field. This field contains the security group IDs associated with your EKS cluster. Note down the security group ID.

4. Now, you can use the "aws ec2 describe-security-groups" command to get the details of the security group. The command is as follows:

   ```
   aws ec2 describe-security-groups --group-ids <your-security-group-id>
   ```
   Replace `<your-security-group-id>` with the security group ID you noted down in the previous step. This command will return a JSON output with all the details of the security group.

5. From the JSON output, you can find the "IpPermissions" field. This field contains the inbound rules of the security group. Check if there is a rule that allows inbound traffic from port 443. If there is no such rule, then your EKS cluster does not allow inbound traffic only from port 443.

#### Using Python

1. Install the necessary Python libraries: You will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. This allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Set up AWS credentials: Before you can start using Boto3, you need to set up authentication credentials. You can do this by creating a new IAM user in your AWS console, then set your credentials in the AWS credentials file, which is located by default at ~/.aws/credentials. At a minimum, the credentials file should specify the access key and secret access key. To specify these for the default profile, you can use the following format:

   ```python
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. Write a Python script to check the security group rules: You can use the describe_security_groups method in boto3 to retrieve the details of the security groups. Then, you can iterate over the inbound rules to check if any rule allows traffic other than port 443.

   ```python
   import boto3

   def check_security_group_rules():
       client = boto3.client('ec2')
       response = client.describe_security_groups()
       for security_group in response['SecurityGroups']:
           for rule in security_group['IpPermissions']:
               for ip_range in rule['IpRanges']:
                   if 'FromPort' in rule and rule['FromPort'] != 443:
                       print(f"Security group {security_group['GroupId']} allows traffic on port {rule['FromPort']} from {ip_range['CidrIp']}")

   check_security_group_rules()
   ```

4. Run the script: You can run the script using any Python interpreter. If any security group allows traffic on a port other than 443, it will print the security group ID, the port, and the IP range. If it doesn't print anything, it means all your security groups only allow traffic on port 443.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration in AWS, follow the steps below:

1. Login to the AWS console and navigate to the Amazon EKS service.

2. Select the EKS cluster that needs to be remediated.

3. Click on the "Configuration" tab in the left-hand menu.

4. Scroll down to the "Networking" section and click on the "Edit" button.

5. In the "Security group rules" section, locate the security group that is associated with your EKS cluster.

6. Click on the "Edit" button next to the security group.

7. In the "Inbound rules" section, locate the rule that allows inbound traffic on port 443.

8. If the rule is missing, click on the "Add rule" button and select "HTTPS" from the dropdown menu.

9. If the rule is present but allows traffic from other ports as well, click on the "Edit" button next to the rule and change the port range to only allow traffic on port 443.

10. Once the rule has been updated, click on the "Save rules" button to apply the changes.

11. Verify that the inbound traffic is now restricted to port 443 by checking the security group rules.

Your EKS cluster should now only allow inbound traffic on port 443, which will remediate the misconfiguration.

#### Using CLI

To remediate this misconfiguration for an EKS cluster in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the EKS clusters in your AWS account:

```
aws eks list-clusters
```

3. Choose the EKS cluster that you want to remediate and run the following command to update the cluster's security group:

```
aws eks update-cluster-config --name <cluster_name> --region <region_name> --resources-vpc-config securityGroupIds=<security_group_id>
```

Replace the `<cluster_name>` with the name of your EKS cluster, `<region_name>` with the AWS region where your cluster is located and `<security_group_id>` with the ID of the security group associated with your EKS cluster.

4. Run the following command to create a new security group rule that allows inbound traffic only from port 443:

```
aws ec2 authorize-security-group-ingress --group-id <security_group_id> --protocol tcp --port 443 --cidr 0.0.0.0/0
```

Replace the `<security_group_id>` with the ID of the security group associated with your EKS cluster.

5. Verify that the new security group rule has been added successfully by running the following command:

```
aws ec2 describe-security-groups --group-ids <security_group_id>
```

This should return a JSON object containing the details of the security group associated with your EKS cluster, including the new inbound rule for port 443.

Your EKS cluster is now configured to allow inbound traffic only from port 443.

#### Using Python

To remediate the misconfiguration of allowing inbound traffic only from port 443 for an EKS Cluster in AWS, you can follow the below steps using Python:

1. Install the AWS SDK for Python (Boto3) using the following command:

```python
pip install boto3
```

2. Create a Boto3 client for Amazon EKS using the following code:

```python
import boto3

eks_client = boto3.client('eks')
```

3. Get the details of the EKS cluster using the following code:

```python
cluster_name = 'your_cluster_name'
response = eks_client.describe_cluster(name=cluster_name)
```

4. Get the security group ID of the worker nodes using the following code:

```python
security_group_id = response['cluster']['resourcesVpcConfig']['clusterSecurityGroupId']
```

5. Get the details of the security group using the following code:

```python
ec2_client = boto3.client('ec2')

response = ec2_client.describe_security_groups(GroupIds=[security_group_id])
```

6. Update the inbound rules of the security group to allow traffic only from port 443 using the following code:

```python
ip_permissions = response['SecurityGroups'][0]['IpPermissions']
for permission in ip_permissions:
    if permission['IpProtocol'] == 'tcp' and permission['FromPort'] != 443:
        ec2_client.revoke_security_group_ingress(
            GroupId=security_group_id,
            IpPermissions=[
                {
                    'IpProtocol': 'tcp',
                    'FromPort': permission['FromPort'],
                    'ToPort': permission['ToPort'],
                    'IpRanges': permission['IpRanges'],
                    'Ipv6Ranges': permission['Ipv6Ranges'],
                    'PrefixListIds': permission['PrefixListIds'],
                    'UserIdGroupPairs': permission['UserIdGroupPairs']
                }
            ]
        )

ec2_client.authorize_security_group_ingress(
    GroupId=security_group_id,
    IpPermissions=[
        {
            'IpProtocol': 'tcp',
            'FromPort': 443,
            'ToPort': 443,
            'IpRanges': [
                {
                    'CidrIp': '0.0.0.0/0'
                }
            ]
        }
    ]
)
```

This code will remove all the existing inbound rules that allow traffic from ports other than 443 and add a new inbound rule that allows traffic only from port 443. 

Note: Replace 'your_cluster_name' with the actual name of your EKS cluster. Also, make sure you have the necessary permissions to modify the security group.


</Tab>
</Tabs>