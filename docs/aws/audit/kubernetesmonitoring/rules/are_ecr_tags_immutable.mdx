---
slug: are_ecr_tags_immutable
title: ECR Repository Tag Should Be Immutable
sidebar_label: ECR Repository Tag Should Be Immutable
---

### More Info:

Ensures ECR repository image tags cannot be overwritten. ECR repositories should be configured to prevent overwriting of image tags to avoid potentially-malicious images from being deployed to live environments.

### Risk Level

Medium

### Address

Security, Operational Maturity

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of ECR (Elastic Container Registry) repository tags being mutable in Kubernetes using the AWS Console, follow these steps:

1. **Navigate to the ECR Dashboard:**
   - Open the AWS Management Console.
   - In the search bar, type "ECR" and select "Elastic Container Registry" from the dropdown.

2. **Select the Repository:**
   - In the ECR dashboard, you will see a list of your repositories.
   - Click on the repository for which you want to set the tag immutability.

3. **Edit Repository Settings:**
   - Once inside the repository, click on the "Edit" button located at the top right corner of the repository details page.

4. **Enable Tag Immutability:**
   - In the "Edit repository" settings, find the "Image tag mutability" section.
   - Select the "Immutable" option.
   - Click on the "Save" button to apply the changes.

By following these steps, you ensure that the tags for your ECR repository are immutable, preventing any accidental or malicious overwriting of tagged images.
</Accordion>

<Accordion title='Using CLI'>
To prevent ECR (Elastic Container Registry) repository tags from being mutable in AWS using the AWS CLI, you can follow these steps:

1. **Create an ECR Repository with Tag Immutability Enabled:**
   When creating a new ECR repository, you can enable tag immutability by specifying the `--image-tag-mutability` parameter as `IMMUTABLE`.

   ```sh
   aws ecr create-repository --repository-name my-repo --image-tag-mutability IMMUTABLE
   ```

2. **Update an Existing ECR Repository to Enable Tag Immutability:**
   If you already have an existing ECR repository, you can update its tag mutability setting to `IMMUTABLE`.

   ```sh
   aws ecr put-image-tag-mutability --repository-name my-repo --image-tag-mutability IMMUTABLE
   ```

3. **Verify the Tag Immutability Setting:**
   To ensure that the tag immutability setting is correctly applied, you can describe the repository and check the `imageTagMutability` field.

   ```sh
   aws ecr describe-repositories --repository-names my-repo
   ```

   Look for the `imageTagMutability` field in the output to confirm it is set to `IMMUTABLE`.

4. **Automate Tag Immutability for New Repositories:**
   To ensure that all new repositories have tag immutability enabled by default, you can create a script or use AWS CloudFormation templates that include the `--image-tag-mutability IMMUTABLE` parameter when creating repositories.

   Example script snippet:
   ```sh
   REPO_NAME="new-repo"
   aws ecr create-repository --repository-name $REPO_NAME --image-tag-mutability IMMUTABLE
   ```

By following these steps, you can ensure that your ECR repository tags are immutable, preventing accidental or malicious overwrites of container images.
</Accordion>

<Accordion title='Using Python'>
To prevent ECR (Elastic Container Registry) repository tags from being mutable in Kubernetes using Python scripts, you can follow these steps:

1. **Install Required Libraries**:
   Ensure you have the `boto3` library installed, which is the AWS SDK for Python. You can install it using pip if you haven't already.

   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by setting environment variables.

   ```bash
   aws configure
   ```

3. **Create a Python Script to Make ECR Tags Immutable**:
   Write a Python script that uses the `boto3` library to set the tag immutability for your ECR repositories.

   ```python
   import boto3

   def make_ecr_tags_immutable(repository_name, region_name='us-west-2'):
       # Create a boto3 client for ECR
       ecr_client = boto3.client('ecr', region_name=region_name)

       # Set the image tag mutability to IMMUTABLE
       response = ecr_client.put_image_tag_mutability(
           repositoryName=repository_name,
           imageTagMutability='IMMUTABLE'
       )

       return response

   if __name__ == "__main__":
       # Replace 'your-repository-name' with your actual ECR repository name
       repository_name = 'your-repository-name'
       region_name = 'us-west-2'  # Replace with your desired AWS region

       response = make_ecr_tags_immutable(repository_name, region_name)
       print(response)
   ```

4. **Run the Script**:
   Execute the Python script to apply the immutability setting to your ECR repository tags.

   ```bash
   python make_ecr_tags_immutable.py
   ```

By following these steps, you can ensure that the tags in your ECR repositories are immutable, preventing any accidental or malicious changes to your container images.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Elastic Container Registry (ECR) service.
3. Select the repository you want to check.
4. In the repository details page, click on the "Edit" button next to "Repository settings".
5. Check the "Image tag mutability" setting. If it is set to "Mutable", then the ECR Repository Tag is not Immutable.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the ECR repositories.

2. Once the AWS CLI is installed and configured, you can list all the ECR repositories in your account by running the following command:

   ```
   aws ecr describe-repositories
   ```

   This command will return a JSON object with details about all your ECR repositories.

3. To check if a specific ECR repository is immutable or not, you can describe the repository policy by running the following command:

   ```
   aws ecr get-lifecycle-policy --repository-name <repository_name>
   ```

   Replace `<repository_name>` with the name of your ECR repository. This command will return a JSON object with the lifecycle policy of the repository.

4. In the returned JSON object, look for the `lifecyclePolicyText` field. This field contains the lifecycle policy of the repository in JSON format. If the repository is immutable, the policy should contain a rule with the `ruleAction` set to `expire` and the `selection` set to `tagStatus` with a value of `untagged`. If such a rule is not present, the repository is not immutable.
</Accordion>

<Accordion title='Using Python'>
To check if the ECR Repository Tag is Immutable in Kubernetes using Python scripts, you can follow these steps:

1. **AWS SDK for Python (Boto3):** First, you need to install and configure the AWS SDK for Python (Boto3). This will allow you to interact with AWS services, including ECR. You can install it using pip:

   ```python
   pip install boto3
   ```

2. **Create a Python Script:** Next, create a Python script that uses Boto3 to interact with ECR. The script should retrieve all ECR repositories and check the 'imageTagMutability' attribute of each repository. If the attribute is set to 'MUTABLE', it means the ECR Repository Tag is not Immutable.

   Here is a sample script:

   ```python
   import boto3

   def check_ecr_repository_tag_immutable():
       client = boto3.client('ecr')
       response = client.describe_repositories()
       for repository in response['repositories']:
           if repository['imageTagMutability'] == 'MUTABLE':
               print(f"Repository {repository['repositoryName']} has mutable tags")

   check_ecr_repository_tag_immutable()
   ```

3. **Run the Python Script:** Run the Python script using a Python interpreter. The script will print out the names of all ECR repositories that have mutable tags.

4. **Interpret the Results:** If the script prints out any repository names, it means those repositories have mutable tags, which is a misconfiguration. If the script doesn't print out any names, it means all ECR repositories have immutable tags, which is the correct configuration.

Remember to replace the AWS region, access key, and secret access key with your own details. Also, ensure that the IAM user associated with the access key has the necessary permissions to access ECR.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "ECR Repository Tag Should Be Immutable" for AWS using the AWS console, follow these steps:

1. Open the Amazon ECR console at https://console.aws.amazon.com/ecr/.
2. In the navigation pane, choose the repository that you want to remediate.
3. Choose the "Image tags" tab.
4. Choose the tag that you want to make immutable.
5. Choose "Actions", and then choose "Edit tag immutability".
6. Choose "Immutable", and then choose "Save".

By following these steps, you have successfully remediated the misconfiguration "ECR Repository Tag Should Be Immutable" for AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "ECR Repository Tag Should Be Immutable" in AWS using AWS CLI, you can follow the below steps:

1. First, you need to create a new ECR repository policy with the rule "ecr:PutImageTagMutability" set to "IMMUTABLE". You can use the following AWS CLI command to create a new ECR repository policy:

```
aws ecr set-repository-policy --repository-name <REPOSITORY_NAME> --policy-text '{"rules": [{"rulePriority": 1,"description": "ECR Repository Tag Should Be Immutable","selection": {"tagStatus": "tagged","tagPrefixList": ["latest"]},"action": {"type": "tagMutability","mutability": "IMMUTABLE"}}]}'
```

Note: Replace `<REPOSITORY_NAME>` with the name of the ECR repository you want to update.

2. Once the new ECR repository policy is created, you need to update the existing ECR repository with the new policy. You can use the following AWS CLI command to update the ECR repository:

```
aws ecr put-image-tag-mutability --repository-name <REPOSITORY_NAME> --image-tag-mutability IMMUTABLE
```

Note: Replace `<REPOSITORY_NAME>` with the name of the ECR repository you want to update.

3. After running the above commands, the ECR repository's tags will be immutable, and no new tags can be created or updated. Any attempt to create or update a tag will result in an error.

By following the above steps, you can remediate the misconfiguration "ECR Repository Tag Should Be Immutable" in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of ECR Repository Tag Should Be Immutable in AWS using Python, you can follow the below steps:

1. Install the AWS SDK for Python (Boto3) using pip:

```python
pip install boto3
```

2. Create a boto3 ECR client object:

```python
import boto3

ecr_client = boto3.client('ecr')
```

3. Get the list of images in the ECR repository:

```python
repository_name = 'my-ecr-repo'
image_list = ecr_client.list_images(repositoryName=repository_name)['imageIds']
```

4. Iterate through the image list and set the image tag as immutable:

```python
for image in image_list:
    image_digest = image['imageDigest']
    response = ecr_client.put_image_tag_mutability(
        repositoryName=repository_name,
        imageTag=image['imageTag'],
        imageDigest=image_digest,
        imageTagMutability='IMMUTABLE'
    )
```

5. Verify that the tag mutability is set to immutable:

```python
image_detail = ecr_client.describe_images(repositoryName=repository_name, imageIds=[{'imageDigest': image_digest}])['imageDetails'][0]
print(image_detail['imageTags'][0])
print(image_detail['imageTagMutability'])
```

By following these steps, you can remediate the issue of ECR Repository Tag Should Be Immutable in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-tag-mutability.html](https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-tag-mutability.html) 

