---
slug: ecs_containers_nonprivileged
title: ECS Tasks Should Be Configured To Run As Non-Privileged
sidebar_label: ECS Tasks Should Be Configured To Run As Non-Privileged
---

### More Info:

This rule checks whether containers within ECS Task Definitions are running as non-privileged users. Running containers as non-privileged users reduces the potential impact of security breaches by limiting the actions they can perform within the container.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the ECS (Elastic Container Service) section.

2. In the ECS section, select the cluster where your Kubernetes tasks are running. 

3. Once you've selected the cluster, navigate to the "Tasks" tab. Here, you'll see a list of all the tasks running in your cluster.

4. For each task, click on the task to view its details. In the task details, look for the "Task Definition" section. Here, you should see a "Container Definitions" section. Click on the container name to view its details. In the container details, look for the "Security" section. If the "Privileged" option is set to "true", then the task is running as privileged, which is a misconfiguration. It should be set to "false" for the task to run as non-privileged.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will need to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can list all the running ECS tasks in your AWS account using the following command:

   ```
   aws ecs list-tasks --cluster <cluster-name>
   ```

   Replace `<cluster-name>` with the name of your ECS cluster. This command will return a list of task ARNs for the tasks running in the specified cluster.

3. To get detailed information about a specific task, use the following command:

   ```
   aws ecs describe-tasks --cluster <cluster-name> --tasks <task-arn>
   ```

   Replace `<cluster-name>` with the name of your ECS cluster and `<task-arn>` with the ARN of the task you want to inspect. This command will return a JSON object containing detailed information about the specified task.

4. To check if the task is running as non-privileged, you need to inspect the "privileged" field in the "containerDefinitions" section of the task definition. If the "privileged" field is set to true, then the task is running as privileged. If the "privileged" field is not present or set to false, then the task is running as non-privileged. You can use the following command to check the "privileged" field:

   ```
   aws ecs describe-task-definition --task-definition <task-definition-arn> --query "taskDefinition.containerDefinitions[].privileged"
   ```

   Replace `<task-definition-arn>` with the ARN of the task definition you want to inspect. This command will return a list of boolean values indicating whether each container in the task definition is running as privileged.

#### Using Python

1. Import the necessary libraries in Python. You will need the Kubernetes client library to interact with the Kubernetes API.

```python
from kubernetes import client, config
```

2. Load the Kubernetes configuration. This can be done in two ways: either from a kubeconfig file or from within a Pod. The following code will try to load the configuration from inside a Pod first, and if it fails, it will load it from a kubeconfig file.

```python
try:
    config.load_incluster_config()
except:
    config.load_kube_config()
```

3. Instantiate the API class. You will use the AppsV1Api class, which provides methods to interact with the Kubernetes API.

```python
v1 = client.AppsV1Api()
```

4. Iterate over all the Pods in all the namespaces and check if any of them are running as privileged. If a Pod is running as privileged, it means that it has more permissions than it should, which is a misconfiguration.

```python
def check_privileged_pods():
    ret = v1.list_pod_for_all_namespaces(watch=False)
    for i in ret.items:
        for container in i.spec.containers:
            if container.security_context and container.security_context.privileged:
                print(f"Pod {i.metadata.name} in namespace {i.metadata.namespace} is running as privileged")

check_privileged_pods()
```

This script will print the names and namespaces of all the Pods that are running as privileged. If no Pods are running as privileged, it will not print anything.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of ECS tasks running as privileged in AWS Kubernetes using the AWS console, follow these steps:

1. **Access AWS Management Console**: Log in to your AWS account and access the AWS Management Console.

2. **Navigate to ECS Service**: Go to the ECS service by clicking on the "Services" dropdown in the top navigation bar and selecting "ECS".

3. **Select Cluster**: Choose the ECS cluster where the misconfigured task is running.

4. **Select Task Definition**: In the left-hand menu, click on "Task Definitions" and select the task definition that needs to be remediated.

5. **Update Task Definition**: Click on the task definition to open it for editing.

6. **Edit Container Definition**: In the task definition details, find the container definition that is running as privileged and click on it to edit.

7. **Modify Privileged Setting**: In the container definition settings, locate the "privileged" setting and set it to "false" to ensure that the container runs as non-privileged.

8. **Save Changes**: After updating the privileged setting, save the changes to the task definition.

9. **Update Service**: If the task is part of a service, update the service to use the modified task definition. Click on the "Services" menu on the left, select the service, and click "Update".

10. **Verify Changes**: Once the service has been updated with the modified task definition, verify that the task is now running as non-privileged by checking the task details.

By following these steps, you can remediate the misconfiguration of ECS tasks running as privileged in AWS Kubernetes using the AWS console.

#### Using CLI

To remediate the misconfiguration of ECS tasks running as privileged in AWS Kubernetes using AWS CLI, follow these steps:

1. List the ECS tasks that are running as privileged:
```
aws ecs list-tasks --cluster <cluster-name> --query 'taskArns[]' --output text | xargs -I {} aws ecs describe-tasks --cluster <cluster-name> --tasks {} --query 'tasks[?containers[?privileged==`true`]].taskArn' --output text
```

2. Update the ECS task definition to set the `privileged` parameter to `false` for each container in the task definition. You can do this by updating the task definition JSON file and then registering the new task definition.

3. Update the task definition JSON file to set `privileged` to `false`. Here is an example of how to update the JSON file:

```json
{
  "containerDefinitions": [
    {
      "name": "your-container-name",
      "image": "your-image",
      "privileged": false,
      ...
    }
  ]
}
```

4. Register the updated task definition:
```
aws ecs register-task-definition --cli-input-json file://updated-task-definition.json
```

5. Update the ECS service to use the new task definition:
```
aws ecs update-service --cluster <cluster-name> --service <service-name> --task-definition <new-task-definition-arn>
```

6. Verify that the ECS tasks are now running as non-privileged:
```
aws ecs list-tasks --cluster <cluster-name> --query 'taskArns[]' --output text | xargs -I {} aws ecs describe-tasks --cluster <cluster-name> --tasks {} --query 'tasks[?containers[?privileged==`true`]].taskArn' --output text
```

By following these steps, you can remediate the misconfiguration of ECS tasks running as privileged in AWS Kubernetes using AWS CLI.

#### Using Python

To remediate the misconfiguration of ECS tasks running as privileged in AWS using Python, you can follow these steps:

1. **Identify the ECS Task Definition**: First, you need to identify the ECS Task Definition that is running as privileged. You can do this by listing all the existing task definitions and inspecting their configurations.

2. **Update the Task Definition**: You will need to update the task definition to run as non-privileged. You can achieve this by modifying the task definition JSON and setting the `privileged` parameter to `false`.

3. **Use Boto3 Library**: Boto3 is the AWS SDK for Python, which allows you to interact with AWS services. You can use Boto3 to describe the existing task definitions, update the task definition, and register the updated task definition.

4. **Python Script**: Below is a sample Python script that demonstrates how to remediate the misconfiguration by updating the ECS task definition to run as non-privileged:

```python
import boto3

# Initialize the ECS client
ecs_client = boto3.client('ecs')

# Specify the task definition ARN that needs to be updated
task_definition_arn = 'YOUR_TASK_DEFINITION_ARN'

# Describe the task definition to get the current configuration
response = ecs_client.describe_task_definition(taskDefinition=task_definition_arn)
task_definition = response['taskDefinition']

# Update the task definition to run as non-privileged
task_definition['containerDefinitions'][0]['linuxParameters']['capabilities']['add'] = ['SYS_PTRACE']

# Register the updated task definition
response = ecs_client.register_task_definition(
    family=task_definition['family'],
    taskRoleArn=task_definition['taskRoleArn'],
    executionRoleArn=task_definition['executionRoleArn'],
    networkMode=task_definition['networkMode'],
    containerDefinitions=task_definition['containerDefinitions']
)

print("Task Definition updated successfully to run as non-privileged.")
```

5. **Execute the Script**: Save the above script in a Python file (e.g., `update_task_definition.py`) and execute it in your Python environment. Make sure you have the necessary AWS credentials configured for the Boto3 client to interact with ECS.

By following these steps and running the Python script, you can remediate the misconfiguration of ECS tasks running as privileged in AWS and update them to run as non-privileged.


</Tab>
</Tabs>