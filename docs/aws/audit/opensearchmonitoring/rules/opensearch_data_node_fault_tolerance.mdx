---
slug: opensearch_data_node_fault_tolerance
title: Opensearch Data Node Should Have Fault Tolerance
sidebar_label: Opensearch Data Node Should Have Fault Tolerance
---
### More Info:

This rule checks if Amazon OpenSearch Service domains are configured with at least three data nodes and zoneAwarenessEnabled is true. The rule is NON_COMPLIANT for an OpenSearch domain if 'instanceCount' is less than 3 or 'zoneAwarenessEnabled' is set to 'false'.

### Risk Level

Medium

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration where an OpenSearch data node should have fault tolerance in OpenSearch using the AWS Management Console, follow these steps:

1. **Access the OpenSearch Service Dashboard:**
   - Sign in to the AWS Management Console.
   - Navigate to the OpenSearch Service by searching for "OpenSearch" in the search bar and selecting "Amazon OpenSearch Service" from the results.

2. **Modify the Domain Configuration:**
   - In the OpenSearch Service dashboard, select the domain you want to configure for fault tolerance.
   - Click on the "Actions" button and choose "Modify domain" from the dropdown menu.

3. **Enable Zone Awareness:**
   - In the domain configuration settings, locate the "Cluster configuration" section.
   - Ensure that "Zone awareness" is enabled. This setting distributes the data nodes across multiple Availability Zones, providing fault tolerance.

4. **Adjust Instance Count and Types:**
   - Still in the "Cluster configuration" section, ensure that you have an appropriate number of data nodes to handle your workload and provide redundancy.
   - Choose instance types that are suitable for your use case and ensure that the number of data nodes is sufficient to maintain fault tolerance in case of node failure.

By following these steps, you can ensure that your OpenSearch data nodes are configured for fault tolerance, reducing the risk of data loss or downtime in the event of a failure.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration where an OpenSearch data node should have fault tolerance in AWS OpenSearch using the AWS CLI, you can follow these steps:

1. **Create a Multi-AZ Domain:**
   Ensure that your OpenSearch domain is configured to use multiple Availability Zones (AZs) to provide fault tolerance.

   ```sh
   aws opensearch create-domain --domain-name my-domain --engine-version OpenSearch_1.0 --cluster-config InstanceType=m5.large.search,InstanceCount=3,ZoneAwarenessEnabled=true
   ```

2. **Enable Zone Awareness:**
   If you already have an OpenSearch domain, you can update it to enable zone awareness, which distributes the nodes across multiple AZs.

   ```sh
   aws opensearch update-domain-config --domain-name my-domain --cluster-config ZoneAwarenessEnabled=true
   ```

3. **Configure Dedicated Master Nodes:**
   Ensure that you have dedicated master nodes to improve cluster stability and fault tolerance.

   ```sh
   aws opensearch update-domain-config --domain-name my-domain --cluster-config DedicatedMasterEnabled=true,DedicatedMasterType=m5.large.search,DedicatedMasterCount=3
   ```

4. **Set Up Automated Snapshots:**
   Configure automated snapshots to ensure data durability and quick recovery in case of node failure.

   ```sh
   aws opensearch update-domain-config --domain-name my-domain --snapshot-options AutomatedSnapshotStartHour=0
   ```

By following these steps, you can enhance the fault tolerance of your OpenSearch data nodes using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of OpenSearch Data Nodes lacking fault tolerance, you can use Python scripts to automate the setup and configuration of your OpenSearch cluster. Here are the steps to ensure fault tolerance:

### 1. **Set Up AWS SDK for Python (Boto3)**
First, ensure you have the AWS SDK for Python (Boto3) installed. You can install it using pip if you haven't already:

```bash
pip install boto3
```

### 2. **Create a Python Script to Configure OpenSearch Cluster**

Below is a Python script that demonstrates how to configure an OpenSearch cluster with fault-tolerant data nodes:

```python
import boto3

# Initialize a session using Amazon OpenSearch Service
session = boto3.Session(
    aws_access_key_id='YOUR_AWS_ACCESS_KEY',
    aws_secret_access_key='YOUR_AWS_SECRET_KEY',
    region_name='YOUR_AWS_REGION'
)

# Create an OpenSearch client
opensearch = session.client('opensearch')

# Define the cluster configuration
cluster_config = {
    'ClusterConfig': {
        'InstanceType': 'm5.large.search',  # Choose an appropriate instance type
        'InstanceCount': 3,  # Ensure you have at least 3 nodes for fault tolerance
        'DedicatedMasterEnabled': True,
        'ZoneAwarenessEnabled': True,  # Enable zone awareness for fault tolerance
        'ZoneAwarenessConfig': {
            'AvailabilityZoneCount': 3  # Distribute nodes across 3 AZs
        }
    }
}

# Create or update the OpenSearch domain with the specified configuration
response = opensearch.create_domain(
    DomainName='your-opensearch-domain',
    **cluster_config
)

print(response)
```

### 3. **Enable Zone Awareness**
Ensure that `ZoneAwarenessEnabled` is set to `True` and configure `ZoneAwarenessConfig` to distribute nodes across multiple Availability Zones. This ensures that your data nodes are fault-tolerant.

### 4. **Monitor and Validate Configuration**
After running the script, you should monitor the OpenSearch cluster to ensure that the nodes are distributed across the specified Availability Zones and that the fault tolerance is effectively in place. You can use AWS CloudWatch or other monitoring tools to validate the configuration.

```python
# Example to describe the domain and validate the configuration
response = opensearch.describe_domain(
    DomainName='your-opensearch-domain'
)

print(response['DomainStatus']['ClusterConfig'])
```

### Summary
1. Install and set up Boto3.
2. Create a Python script to configure the OpenSearch cluster with fault-tolerant settings.
3. Enable zone awareness and distribute nodes across multiple Availability Zones.
4. Monitor and validate the configuration to ensure fault tolerance.

By following these steps, you can automate the prevention of misconfigurations related to fault tolerance in OpenSearch data nodes using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Amazon OpenSearch Service dashboard. 
3. Select the OpenSearch domain that you want to check for fault tolerance.
4. In the domain dashboard, check the 'Instance count' under the 'Data nodes' section. If the instance count is less than 2, it means that the OpenSearch data node does not have fault tolerance.
</Accordion>

<Accordion title='Using CLI'>
1. **Install and Configure AWS CLI**: Before you can start, make sure you have AWS CLI installed and configured on your system. You can install it using pip (Python package installer). The command to install AWS CLI is `pip install awscli`. After installation, you can configure it using `aws configure` command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. **List OpenSearch Domains**: Use the `aws opensearch describe-domain` command to list all the OpenSearch domains. The command is as follows:

    ```
    aws opensearch describe-domain --domain-name <your_domain_name>
    ```

    Replace `<your_domain_name>` with the name of your OpenSearch domain. This command will return a JSON output with the configuration details of the specified domain.

3. **Check the Instance Count**: In the returned JSON output, look for the `InstanceCount` field under `ClusterConfig`. This field indicates the number of data nodes in the OpenSearch domain. If the `InstanceCount` is 1, it means there is no fault tolerance as there is only one data node.

4. **Check the Instance Type**: Also, check the `InstanceType` field under `ClusterConfig`. If the instance type is a single-node instance type (for example, `m3.medium.opensearch`), it means there is no fault tolerance.

Remember, to ensure fault tolerance, the OpenSearch domain should have more than one data node and should not use a single-node instance type.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries:
   You will need the `boto3` library to interact with AWS services. You can install it using pip:
   ```
   pip install boto3
   ```
2. Configure AWS credentials:
   You need to configure your AWS credentials. You can do this by creating the files `~/.aws/credentials` and `~/.aws/config`:
   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   region=us-west-2
   ```
3. Write a Python script to check the number of data nodes:
   Here is a sample script that checks the number of data nodes in an OpenSearch cluster:

   ```python
   import boto3

   def check_data_node_count(domain_name):
       client = boto3.client('opensearch')
       response = client.describe_elasticsearch_domain(DomainName=domain_name)
       data_node_count = response['DomainStatus']['ElasticsearchClusterConfig']['InstanceCount']
       return data_node_count

   domain_name = 'your_opensearch_domain'
   count = check_data_node_count(domain_name)
   if count < 2:
       print(f"OpenSearch domain {domain_name} does not have fault tolerance. It only has {count} data node.")
   else:
       print(f"OpenSearch domain {domain_name} has fault tolerance. It has {count} data nodes.")
   ```
   This script first creates a client for the OpenSearch service. It then calls the `describe_elasticsearch_domain` method to get the configuration of the specified domain. The number of data nodes is then extracted from the response and returned.

4. Run the script:
   You can run the script using the Python interpreter:
   ```
   python check_opensearch_data_nodes.py
   ```
   The script will print a message indicating whether the OpenSearch domain has fault tolerance or not. If the number of data nodes is less than 2, it means the domain does not have fault tolerance.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the lack of fault tolerance for an OpenSearch data node in AWS, you can follow these steps using the AWS Management Console:

1. **Navigate to Amazon OpenSearch Service Console:**
   - Go to the AWS Management Console (https://console.aws.amazon.com).
   - In the "Find services" search bar, type "OpenSearch Service" and click on it to open the OpenSearch dashboard.

2. **Select the OpenSearch Domain:**
   - From the list of OpenSearch domains, select the domain for which you want to enable fault tolerance.

3. **Modify the Domain Configuration:**
   - In the OpenSearch dashboard, locate and click on the domain name that you want to modify.
   - Click on the "Modify domain" button to update the domain configuration.

4. **Enable Zone Awareness:**
   - In the "Configure cluster" section, find the "Enable zone awareness" option and toggle it to enable fault tolerance.
   - Zone awareness ensures that each primary shard has at least one replica in a different Availability Zone.

5. **Select the Number of Availability Zones:**
   - Choose the number of Availability Zones you want to distribute your data across. It is recommended to select at least 2 Availability Zones for fault tolerance.

6. **Save the Configuration Changes:**
   - Review the other settings and configurations to ensure they are correct.
   - Click on the "Submit" button to save the changes and apply fault tolerance to your OpenSearch domain.

7. **Monitor the Domain:**
   - Once the configuration changes are saved, monitor the domain to ensure that the fault tolerance settings are applied correctly.
   - You can check the domain status and cluster health in the OpenSearch dashboard.

By following these steps, you can enable fault tolerance for an OpenSearch data node in AWS, ensuring high availability and resilience to failures in your OpenSearch domain.

#
</Accordion>

<Accordion title='Using CLI'>
To enable fault tolerance for OpenSearch data nodes in AWS, you can follow these steps using the AWS CLI:

1. Identify the OpenSearch domain: 
   Run the following AWS CLI command to list all the OpenSearch domains in your AWS account:
   ```
   aws opensearchservice list-domain-names
   ```

2. Get the configuration of the OpenSearch domain:
   Run the following AWS CLI command to get the configuration of the specific OpenSearch domain:
   ```
   aws opensearchservice describe-elasticsearch-domain --domain-name YOUR_DOMAIN_NAME
   ```

3. Update the domain configuration to enable fault tolerance:
   Run the following AWS CLI command to update the domain configuration and enable fault tolerance for data nodes:
   ```
   aws opensearchservice update-elasticsearch-domain-config --domain-name YOUR_DOMAIN_NAME --elasticsearch-cluster-config '{"InstanceType": "m5.large.search", "InstanceCount": 2, "DedicatedMasterEnabled": false, "ZoneAwarenessEnabled": true}'
   ```
   In this command:
   - Replace `YOUR_DOMAIN_NAME` with the name of your OpenSearch domain.
   - Adjust the `InstanceType` and `InstanceCount` values as per your requirements.
   - Set `ZoneAwarenessEnabled` to `true` to enable fault tolerance across Availability Zones.

4. Monitor the domain status:
   Run the following AWS CLI command to monitor the status of the OpenSearch domain until it is active:
   ```
   aws opensearchservice describe-elasticsearch-domain --domain-name YOUR_DOMAIN_NAME
   ```

By following these steps and using the AWS CLI commands provided, you can enable fault tolerance for OpenSearch data nodes in AWS.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of Opensearch Data Node not having fault tolerance in AWS OpenSearch using Python, follow these steps:

1. Define the AWS OpenSearch domain configuration using the AWS SDK for Python (Boto3). Ensure that the domain has multiple data nodes for fault tolerance.

```python
import boto3

client = boto3.client('es')

domain_name = 'your-opensearch-domain-name'

# Update the domain configuration to have multiple data nodes for fault tolerance
response = client.update_elasticsearch_domain_config(
    DomainName=domain_name,
    ElasticsearchClusterConfig={
        'InstanceType': 'm5.large.elasticsearch',
        'InstanceCount': 2,  # Set the number of data nodes for fault tolerance
        'DedicatedMasterEnabled': False,
        'ZoneAwarenessEnabled': True,
    }
)

print(response)
```

2. Run the Python script to update the AWS OpenSearch domain configuration with fault tolerance enabled for data nodes.

3. Verify the domain configuration in the AWS Management Console or by using the describe_elasticsearch_domain_config API to ensure that the fault tolerance settings have been applied successfully.

By following these steps, you can remediate the misconfiguration of Opensearch Data Node not having fault tolerance in AWS OpenSearch using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

