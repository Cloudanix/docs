---
slug: opensearch_logs_to_cloudwatch
title: Opensearch Should Export Logs To Cloudwatch
sidebar_label: Opensearch Should Export Logs To Cloudwatch
---
### More Info:

Ensure Opensearch logs are sent to cloudwatch

### Risk Level

Medium

### Address

Operational Maturity, Reliability, Security

### Compliance Standards

HIPAA,SOC2,HITRUST,NISTCSF,PCIDSS,SEBI,RBI_MD_ITF,RBI_UCB


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration where OpenSearch should export logs to CloudWatch in AWS using the AWS Management Console, follow these steps:

1. **Navigate to OpenSearch Service:**
   - Sign in to the AWS Management Console.
   - In the search bar, type "OpenSearch Service" and select it from the dropdown.

2. **Select Your OpenSearch Domain:**
   - In the OpenSearch Service dashboard, locate and click on the domain you want to configure.

3. **Configure Log Export:**
   - In the domain details page, find the "Logs" section.
   - Click on the "Edit" button next to the "Logs" section.

4. **Enable Log Export to CloudWatch:**
   - Enable the checkboxes for the types of logs you want to export (e.g., Index Slow Logs, Search Slow Logs, Error Logs).
   - For each log type, select the appropriate CloudWatch log group or create a new one.
   - Click "Save changes" to apply the configuration.

By following these steps, you ensure that your OpenSearch logs are exported to CloudWatch, which helps in monitoring and troubleshooting.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration where OpenSearch should export logs to CloudWatch using AWS CLI, follow these steps:

1. **Create a CloudWatch Log Group:**
   Ensure you have a CloudWatch Log Group where the OpenSearch logs will be exported.
   ```sh
   aws logs create-log-group --log-group-name /aws/aes/domains/your-domain-name
   ```

2. **Create an IAM Role for OpenSearch:**
   Create an IAM role that OpenSearch can assume to write logs to CloudWatch.
   ```sh
   aws iam create-role --role-name OpenSearchLoggingRole --assume-role-policy-document file://trust-policy.json
   ```

   The `trust-policy.json` should contain:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "Service": "es.amazonaws.com"
         },
         "Action": "sts:AssumeRole"
       }
     ]
   }
   ```

3. **Attach Policy to IAM Role:**
   Attach a policy to the IAM role that allows it to write logs to CloudWatch.
   ```sh
   aws iam put-role-policy --role-name OpenSearchLoggingRole --policy-name OpenSearchLoggingPolicy --policy-document file://logging-policy.json
   ```

   The `logging-policy.json` should contain:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "logs:PutLogEvents",
           "logs:CreateLogStream",
           "logs:CreateLogGroup"
         ],
         "Resource": "arn:aws:logs:your-region:your-account-id:log-group:/aws/aes/domains/your-domain-name*"
       }
     ]
   }
   ```

4. **Enable Logging for OpenSearch Domain:**
   Update your OpenSearch domain to enable logging and specify the CloudWatch log group and IAM role.
   ```sh
   aws opensearch update-domain-config --domain-name your-domain-name --log-publishing-options '{"INDEX_SLOW_LOGS": {"CloudWatchLogsLogGroupArn": "arn:aws:logs:your-region:your-account-id:log-group:/aws/aes/domains/your-domain-name", "Enabled": true}, "SEARCH_SLOW_LOGS": {"CloudWatchLogsLogGroupArn": "arn:aws:logs:your-region:your-account-id:log-group:/aws/aes/domains/your-domain-name", "Enabled": true}, "ES_APPLICATION_LOGS": {"CloudWatchLogsLogGroupArn": "arn:aws:logs:your-region:your-account-id:log-group:/aws/aes/domains/your-domain-name", "Enabled": true}}'
   ```

By following these steps, you ensure that your OpenSearch logs are properly exported to CloudWatch, preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration where OpenSearch should export logs to CloudWatch using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   Ensure you have the AWS SDK for Python (Boto3) installed. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Create a Boto3 Client for OpenSearch and CloudWatch Logs:**
   Initialize the Boto3 clients for OpenSearch and CloudWatch Logs.
   ```python
   import boto3

   # Initialize the OpenSearch client
   opensearch_client = boto3.client('opensearch')

   # Initialize the CloudWatch Logs client
   logs_client = boto3.client('logs')
   ```

3. **Create a CloudWatch Log Group:**
   Ensure that a CloudWatch Log Group exists where OpenSearch can export logs. If it doesn't exist, create it.
   ```python
   log_group_name = '/aws/opensearch/logs'

   # Check if the log group exists
   log_groups = logs_client.describe_log_groups(logGroupNamePrefix=log_group_name)
   if not any(group['logGroupName'] == log_group_name for group in log_groups['logGroups']):
       # Create the log group if it doesn't exist
       logs_client.create_log_group(logGroupName=log_group_name)
   ```

4. **Configure OpenSearch to Export Logs to CloudWatch:**
   Update the OpenSearch domain configuration to enable log publishing to CloudWatch Logs.
   ```python
   domain_name = 'your-opensearch-domain-name'

   # Update the OpenSearch domain to enable log publishing
   opensearch_client.update_domain_config(
       DomainName=domain_name,
       LogPublishingOptions={
           'INDEX_SLOW_LOGS': {
               'CloudWatchLogsLogGroupArn': f'arn:aws:logs:your-region:your-account-id:log-group:{log_group_name}',
               'Enabled': True
           },
           'SEARCH_SLOW_LOGS': {
               'CloudWatchLogsLogGroupArn': f'arn:aws:logs:your-region:your-account-id:log-group:{log_group_name}',
               'Enabled': True
           },
           'ES_APPLICATION_LOGS': {
               'CloudWatchLogsLogGroupArn': f'arn:aws:logs:your-region:your-account-id:log-group:{log_group_name}',
               'Enabled': True
           }
       }
   )
   ```

Replace `your-opensearch-domain-name`, `your-region`, and `your-account-id` with your actual OpenSearch domain name, AWS region, and AWS account ID, respectively.

By following these steps, you ensure that OpenSearch is configured to export logs to CloudWatch, thereby preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Amazon OpenSearch Service dashboard.

2. In the navigation pane, choose "Domain List". This will display a list of all your OpenSearch domains.

3. Click on the domain name you want to check. This will open the domain dashboard where you can see all the configurations related to the selected domain.

4. In the domain dashboard, navigate to the "Logs" section. Here, you can check if the "CloudWatch Logs" option is enabled or not. If it is enabled, it means that the OpenSearch logs are being exported to CloudWatch. If it is not enabled, it means that the logs are not being exported.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all OpenSearch domains: Use the following command to list all the OpenSearch domains in your AWS account:

   ```
   aws es list-domain-names
   ```
   This command will return a list of all OpenSearch domains. Note down the domain names for which you want to check the log export configuration.

3. Describe the OpenSearch domain: Use the following command to get the detailed configuration of a specific OpenSearch domain:

   ```
   aws es describe-elasticsearch-domain --domain-name <your-domain-name>
   ```
   Replace `<your-domain-name>` with the name of your OpenSearch domain. This command will return a JSON object containing the configuration of the specified domain.

4. Check the log export configuration: In the output of the previous command, look for the `LogPublishingOptions` field. If the `CloudWatchLogsLogGroupArn` field under `LogPublishingOptions` is empty or not present, it means that the OpenSearch domain is not configured to export logs to CloudWatch.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, you need to install the necessary Python libraries. You can use the pip package manager to install these libraries. The libraries you need are boto3 (for AWS), azure-mgmt-resource (for Azure), and google-cloud-resource-manager (for GCP).

   ```bash
   pip install boto3 azure-mgmt-resource google-cloud-resource-manager
   ```

2. Create a Python script to check the OpenSearch configuration: You can use the boto3 library to interact with AWS and check the OpenSearch configuration. Here is a sample script:

   ```python
   import boto3

   def check_opensearch_logs_export():
       client = boto3.client('es')
       domains = client.list_domain_names()
       for domain in domains['DomainNames']:
           domain_name = domain['DomainName']
           domain_config = client.describe_elasticsearch_domain(DomainName=domain_name)
           log_config = domain_config['DomainStatus']['LogPublishingOptions']
           if 'ES_APPLICATION_LOGS' not in log_config or log_config['ES_APPLICATION_LOGS']['CloudWatchLogsLogGroupArn'] == '':
               print(f"OpenSearch domain {domain_name} does not export logs to CloudWatch")

   check_opensearch_logs_export()
   ```

   This script lists all OpenSearch domains and checks if they have the 'ES_APPLICATION_LOGS' option enabled and if they have a CloudWatch Logs log group ARN set. If not, it prints a message indicating that the domain does not export logs to CloudWatch.

3. Run the Python script: You can run the Python script from the command line using the python command:

   ```bash
   python check_opensearch_logs_export.py
   ```

4. Review the output: The script will print a message for each OpenSearch domain that does not export logs to CloudWatch. You can use this information to identify the misconfigured domains.

Note: This script assumes that you have configured your AWS credentials correctly, either by setting the AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and AWS_SESSION_TOKEN environment variables, or by configuring them using the AWS CLI.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of OpenSearch not exporting logs to CloudWatch in AWS, you can follow these steps using the AWS Management Console:

1. **Sign in to the AWS Management Console**: Go to the AWS Management Console and sign in with your credentials.

2. **Navigate to the OpenSearch Service**: From the services dropdown, select "OpenSearch Service" under the Analytics section.

3. **Select the OpenSearch Domain**: Choose the OpenSearch domain that you want to configure to export logs to CloudWatch.

4. **Navigate to the CloudWatch Logs section**: In the left-hand navigation pane, click on the "Logs" section under the "Data" category.

5. **Enable CloudWatch Logs**: Click on the "Enable" button to enable the export of OpenSearch logs to CloudWatch.

6. **Configure Log Settings**: In the CloudWatch Logs configuration window, you can specify the log group name, log stream name, and the IAM role that has permission to write logs to CloudWatch.

7. **Review and Confirm**: Review the settings you have configured and click on the "Confirm" button to apply the changes.

8. **Verify Configuration**: After the configuration is applied, you can verify that the OpenSearch logs are now being exported to CloudWatch by checking the CloudWatch Logs console.

By following these steps, you can successfully remediate the misconfiguration of OpenSearch not exporting logs to CloudWatch in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration where OpenSearch should export logs to CloudWatch in AWS, you can follow these steps using the AWS CLI:

1. **Enable the Log Publishing Option**:
   Run the following AWS CLI command to enable the log publishing option for your OpenSearch domain. Replace `<domain-name>` with the name of your OpenSearch domain.
   ```bash
   aws opensearchservice update-domain-config --domain-name <domain-name> --advanced-security-options "AuditLogs: { CloudWatchLogs: { Enabled: true }}"
   ```

2. **Verify the Configuration**:
   You can verify that the log publishing option is enabled for your OpenSearch domain by describing the domain configuration using the following command:
   ```bash
   aws opensearchservice describe-elasticsearch-domain-config --domain-name <domain-name>
   ```

3. **Check CloudWatch Logs**:
   Once the configuration is updated, you should start seeing the OpenSearch logs in CloudWatch Logs. You can access these logs from the AWS Management Console or by using the CloudWatch Logs API.

By following these steps, you can remediate the misconfiguration and ensure that OpenSearch logs are exported to CloudWatch in AWS.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of OpenSearch not exporting logs to CloudWatch in AWS using Python, you can follow these steps:

1. **Install Boto3**: Boto3 is the AWS SDK for Python and will allow you to interact with AWS services from your Python script. You can install it using pip:
   ```bash
   pip install boto3
   ```

2. **Update OpenSearch Domain Policy**: Update the OpenSearch domain policy to allow the OpenSearch domain to publish logs to CloudWatch Logs. You can use the following Python script to update the domain policy:
   ```python
   import boto3

   # Define the OpenSearch domain name
   domain_name = 'your-opensearch-domain-name'

   # Create a CloudWatch Logs resource policy
   cloudwatch_policy = {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Principal": {
                   "Service": "es.amazonaws.com"
               },
               "Action": "logs:PutLogEvents",
               "Resource": "arn:aws:logs:*:*:log-group:/aws/opensearch-service/*"
           }
       ]
   }

   # Update the OpenSearch domain access policy
   client = boto3.client('es')
   response = client.update_elasticsearch_domain_config(
       DomainName=domain_name,
       ElasticsearchClusterConfig={
           'CloudWatchLogsLogGroupArn': 'arn:aws:logs:us-east-1:123456789012:log-group:/aws/opensearch-service/*',
           'CloudWatchLogsRoleArn': 'arn:aws:iam::123456789012:role/your-cloudwatch-role'
       },
       AccessPolicies=json.dumps(cloudwatch_policy)
   )

   print(response)
   ```

3. **Replace placeholders**: Replace the placeholder values in the script with your actual OpenSearch domain name, CloudWatch Logs Log Group ARN, and CloudWatch Logs Role ARN.

4. **Run the script**: Save the script in a Python file (e.g., `remediate_opensearch_logs.py`) and run it using the Python interpreter:
   ```bash
   python remediate_opensearch_logs.py
   ```

5. **Verify the configuration**: After running the script, verify that the OpenSearch domain is now exporting logs to CloudWatch Logs by checking the CloudWatch Logs console for log streams related to your OpenSearch domain.

By following these steps and running the Python script, you can remediate the misconfiguration of OpenSearch not exporting logs to CloudWatch in AWS.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

