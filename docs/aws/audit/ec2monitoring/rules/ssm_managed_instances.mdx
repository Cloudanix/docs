---
slug: ssm_managed_instances
title: EC2 Instances Should Be Managed By SSM
sidebar_label: EC2 Instances Should Be Managed By SSM
---

### More Info:

Ensure that all Amazon EC2 instances are managed by AWS Systems Manager (SSM). Systems Manager simplifies AWS cloud resource management, shortens the time to detect and resolve operational problems, and makes it easy to operate and manage your instances securely at scale. For Amazon EC2 instances to be monitored and managed with AWS Systems Manager service, they must be configured as managed instances. In order for EC2 instances to be managed by Systems Manager and be available in the list of managed instances, your instances have to meet 3 primary requirements:

### Risk Level

High

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 instances from not being managed by AWS Systems Manager (SSM) using the AWS Management Console, follow these steps:

1. **Enable SSM Agent on AMIs:**
   - Ensure that the Amazon Machine Images (AMIs) you use for launching EC2 instances have the SSM Agent pre-installed and running. AWS provides official AMIs with the SSM Agent pre-installed.

2. **Attach IAM Role with SSM Permissions:**
   - When launching an EC2 instance, attach an IAM role that has the necessary permissions for SSM. You can use the `AmazonEC2RoleforSSM` managed policy or create a custom policy with the required permissions.
     - Go to the EC2 Dashboard.
     - Click on "Launch Instance."
     - In the "Configure Instance" step, under "IAM role," select an IAM role that has SSM permissions.

3. **Configure VPC Endpoints for SSM:**
   - Ensure that your VPC has the necessary endpoints for SSM. This is especially important for instances in private subnets.
     - Go to the VPC Dashboard.
     - Click on "Endpoints" and then "Create Endpoint."
     - Select the SSM services (`com.amazonaws.<region>.ssm`, `com.amazonaws.<region>.ec2messages`, and `com.amazonaws.<region>.ssmmessages`) and associate them with the appropriate VPC and subnets.

4. **Enable SSM Agent on Running Instances:**
   - For existing instances, ensure the SSM Agent is installed and running.
     - Connect to the instance via SSH.
     - Install the SSM Agent if it is not already installed.
     - Start the SSM Agent service and ensure it is enabled to start on boot.

By following these steps, you can ensure that your EC2 instances are managed by AWS Systems Manager, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
To ensure that EC2 instances are managed by AWS Systems Manager (SSM) using the AWS CLI, you need to take the following steps:

1. **Attach the IAM Role with SSM Permissions to the EC2 Instance:**
   Ensure that your EC2 instance has an IAM role attached with the necessary SSM permissions. You can create an IAM role with the `AmazonSSMManagedInstanceCore` policy and attach it to your instance.

   ```sh
   aws iam create-role --role-name SSMRole --assume-role-policy-document file://trust-policy.json
   aws iam attach-role-policy --role-name SSMRole --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
   aws ec2 associate-iam-instance-profile --instance-id i-1234567890abcdef0 --iam-instance-profile Name=SSMRole
   ```

2. **Install the SSM Agent on the EC2 Instance:**
   Ensure that the SSM Agent is installed and running on your EC2 instance. For Amazon Linux and Amazon Linux 2, the SSM Agent is pre-installed, but for other operating systems, you may need to install it manually.

   ```sh
   aws ssm send-command --instance-ids "i-1234567890abcdef0" --document-name "AWS-RunShellScript" --comment "Install SSM Agent" --parameters commands="sudo yum install -y amazon-ssm-agent"
   ```

3. **Verify SSM Agent is Running:**
   Check that the SSM Agent is running on your EC2 instance. You can use the AWS CLI to send a command to the instance and verify its status.

   ```sh
   aws ssm describe-instance-information --filters "Key=InstanceIds,Values=i-1234567890abcdef0"
   ```

4. **Ensure EC2 Instance is in a Managed State:**
   Confirm that the EC2 instance is in a managed state by checking its status in Systems Manager.

   ```sh
   aws ssm describe-instance-information --query "InstanceInformationList[?InstanceId=='i-1234567890abcdef0']"
   ```

By following these steps, you can ensure that your EC2 instances are managed by AWS Systems Manager, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To ensure that EC2 instances are managed by AWS Systems Manager (SSM), you can take the following steps using Python scripts. These steps will help you automate the process of ensuring that your EC2 instances are properly configured to be managed by SSM.

### 1. Install Required Python Packages
First, ensure you have the `boto3` library installed, which is the AWS SDK for Python.

```bash
pip install boto3
```

### 2. Create an IAM Role for SSM
Create an IAM role with the necessary policies to allow SSM to manage your EC2 instances. This role should have the `AmazonEC2RoleforSSM` policy attached.

```python
import boto3

iam_client = boto3.client('iam')

role_name = 'EC2SSMRole'
assume_role_policy_document = {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "ec2.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}

# Create the role
role = iam_client.create_role(
    RoleName=role_name,
    AssumeRolePolicyDocument=json.dumps(assume_role_policy_document)
)

# Attach the AmazonEC2RoleforSSM policy to the role
iam_client.attach_role_policy(
    RoleName=role_name,
    PolicyArn='arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
)
```

### 3. Launch EC2 Instances with the SSM Role
When launching EC2 instances, ensure they are associated with the IAM role created in the previous step.

```python
ec2_client = boto3.client('ec2')

instance_params = {
    'ImageId': 'ami-0abcdef1234567890',  # Replace with your desired AMI ID
    'InstanceType': 't2.micro',
    'MinCount': 1,
    'MaxCount': 1,
    'IamInstanceProfile': {
        'Name': role_name
    },
    'TagSpecifications': [
        {
            'ResourceType': 'instance',
            'Tags': [
                {
                    'Key': 'Name',
                    'Value': 'SSMManagedInstance'
                }
            ]
        }
    ]
}

# Launch the instance
ec2_client.run_instances(**instance_params)
```

### 4. Verify SSM Agent Installation
Ensure that the SSM agent is installed and running on your EC2 instances. You can use the SSM API to check the status of the agent.

```python
ssm_client = boto3.client('ssm')

# List all managed instances
response = ssm_client.describe_instance_information()

for instance in response['InstanceInformationList']:
    print(f"Instance ID: {instance['InstanceId']}, Ping Status: {instance['PingStatus']}")
```

### Summary
1. **Install Required Python Packages**: Ensure `boto3` is installed.
2. **Create an IAM Role for SSM**: Create an IAM role with the `AmazonEC2RoleforSSM` policy.
3. **Launch EC2 Instances with the SSM Role**: Launch instances with the IAM role attached.
4. **Verify SSM Agent Installation**: Use the SSM API to verify that the SSM agent is installed and running.

By following these steps, you can automate the process of ensuring that your EC2 instances are managed by SSM using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, select "Instances" to view all the EC2 instances.
3. For each instance, check the "Tags" section. If the instance is managed by SSM, it should have a tag with the key "SSM-Managed" and the value "True". If such a tag is not present, the instance is not managed by SSM.
4. Alternatively, you can navigate to the Systems Manager dashboard and select "Managed Instances" in the navigation pane. If an EC2 instance is not listed here, it is not managed by SSM.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all EC2 instances: Use the AWS CLI command `describe-instances` to list all the EC2 instances in your account. This command will return a JSON output with the details of all your instances.

   ```
   aws ec2 describe-instances
   ```
3. List all managed instances: Use the AWS CLI command `describe-instance-information` to list all the instances that are managed by SSM. This command will return a JSON output with the details of all your managed instances.

   ```
   aws ssm describe-instance-information
   ```
4. Compare the instances: Now, you need to compare the instances from step 2 and step 3. If there are instances in step 2 that are not present in step 3, those instances are not managed by SSM. You can do this comparison using a Python script or any other method you prefer.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3):
   To interact with AWS services, you need to install Boto3. You can install it using pip:
   ```
   pip install boto3
   ```
   After installing Boto3, you need to configure it. You can do this by using the AWS CLI:
   ```
   aws configure
   ```
   You will be asked to provide your AWS Access Key ID and Secret Access Key, which you can get from your AWS Management Console.

2. Import the necessary modules and create an EC2 resource object:
   You need to import Boto3 and create an EC2 resource object to interact with your EC2 instances.
   ```python
   import boto3

   ec2 = boto3.resource('ec2')
   ```

3. Get the list of all EC2 instances and check if they are managed by SSM:
   You can get the list of all EC2 instances using the `instances.all()` method. Then, for each instance, you can check if it is managed by SSM by checking if the `SSM:ManagedInstance` tag is present.
   ```python
   for instance in ec2.instances.all():
       tags = instance.tags
       is_managed_by_ssm = False
       for tag in tags:
           if tag['Key'] == 'SSM:ManagedInstance':
               is_managed_by_ssm = True
               break
       if not is_managed_by_ssm:
           print(f"Instance {instance.id} is not managed by SSM")
   ```

4. Handle exceptions:
   It's a good practice to handle exceptions in your script. You can do this by using a try-except block. For example, you can catch the `botocore.exceptions.NoCredentialsError` exception which is raised when Boto3 can't find your AWS credentials.
   ```python
   try:
       for instance in ec2.instances.all():
           # ...
   except botocore.exceptions.NoCredentialsError:
       print("No AWS credentials found")
   ```
   This way, if your script can't find your AWS credentials, it will print a helpful error message instead of a traceback.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "EC2 Instances Should Be Managed By SSM" in AWS using the AWS console, follow the below steps:

1. Open the AWS Management Console and navigate to the EC2 dashboard.
2. Select the EC2 instance that needs to be managed by SSM.
3. Click on the "Actions" button and select "Instance Settings" and then click on "Attach/Replace IAM Role".
4. In the "Attach/Replace IAM Role" window, select the option "SSMManagedInstanceCore" in the "IAM Role" drop-down menu.
5. Click on "Apply" to attach the IAM role to the EC2 instance.
6. Once the IAM role is attached, navigate to the SSM dashboard.
7. Select "Managed Instances" from the left-hand menu.
8. Verify that the EC2 instance is listed as a managed instance. If it is not listed, select "Register instances" to add the EC2 instance to SSM.
9. After registering the instance, select the instance and click on "Actions" and then select "Run Command".
10. In the "Run a Command" window, select the "AWS-ConfigureAWSPackage" document.
11. In the "Command Parameters" section, select the "Install" option for the "action" parameter.
12. Click on "Run" to install the SSM agent on the EC2 instance.
13. Once the SSM agent is installed, the EC2 instance will be managed by SSM.

By following the above steps, the misconfiguration "EC2 Instances Should Be Managed By SSM" can be remediated for AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "EC2 Instances Should Be Managed By SSM" in AWS using AWS CLI, follow the below steps:

Step 1: Install and configure AWS CLI on your local machine.

Step 2: Run the following command to identify the EC2 instances that are not managed by SSM:

```
aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0], [not contains(Tags[?Key==`aws: ssm: managed`, Value==`true`)], InstanceId]]' --output text
```

Step 3: The above command will output a list of all EC2 instances that are not managed by SSM. Identify the instances that need to be remediated.

Step 4: Run the following command to enable SSM management for the identified EC2 instances:

```
aws ssm send-command --document-name "AWS-ConfigureAWSPackage" --document-version "1" --targets "Key=InstanceIds,Values=<Instance-ID>" --parameters '{"action":["Install"],"installationType":["Uninstall and reinstall"],"name":["AmazonCloudWatchAgent"],"version":["latest"]}' --timeout-seconds 600 --max-concurrency "50" --max-errors "0" --output-s3-bucket-name "<S3-Bucket-Name>" --output-s3-key-prefix "output" --region "<Region>"
```

Note: Replace `<Instance-ID>`, `<S3-Bucket-Name>`, and `<Region>` with the appropriate values.

Step 5: Repeat Step 4 for all the identified EC2 instances.

Step 6: Verify that SSM management is enabled for the EC2 instances by running the following command:

```
aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0], [not contains(Tags[?Key==`aws: ssm: managed`, Value==`true`)], InstanceId]]' --output text
```

The above command should not return any output, indicating that all EC2 instances are now managed by SSM.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "EC2 Instances Should Be Managed By SSM" in AWS using Python, you can follow these steps:

1. Install the AWS SDK for Python (Boto3) using pip: `pip install boto3`

2. Create an AWS SSM client object using the following code:

```python
import boto3

ssm_client = boto3.client('ssm')
```

3. Retrieve a list of all EC2 instances in the AWS account using the following code:

```python
import boto3

ec2_client = boto3.client('ec2')

response = ec2_client.describe_instances()
instances = []

for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        instances.append(instance['InstanceId'])
```

4. For each EC2 instance, check if it is already managed by SSM using the following code:

```python
import boto3

ssm_client = boto3.client('ssm')

response = ssm_client.describe_instance_information(
    InstanceInformationFilterList=[
        {
            'key': 'InstanceIds',
            'valueSet': [
                'INSTANCE_ID'
            ]
        },
    ]
)

if len(response['InstanceInformationList']) > 0:
    print('Instance is already managed by SSM')
else:
    print('Instance is not managed by SSM')
```

Replace `INSTANCE_ID` with the ID of the EC2 instance you want to check.

5. If the EC2 instance is not already managed by SSM, you can remediate the misconfiguration by running the following command:

```python
import boto3

ssm_client = boto3.client('ssm')

response = ssm_client.send_command(
    InstanceIds=[
        'INSTANCE_ID',
    ],
    DocumentName='AWS-ConfigureAWSPackage',
    Parameters={
        'action': ['Install'],
        'name': ['AmazonCloudWatchAgent'],
    }
)

command_id = response['Command']['CommandId']
```

Replace `INSTANCE_ID` with the ID of the EC2 instance you want to remediate.

This command will install the Amazon CloudWatch agent on the EC2 instance and configure it to be managed by SSM. You can monitor the progress of the command using the `command_id` returned by the `send_command` method.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/systems-manager/latest/userguide/managed_instances.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/managed_instances.html) 

