
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent SSM Parameters from being unencrypted in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to Systems Manager:**
   - Open the AWS Management Console.
   - In the Services menu, select "Systems Manager" under the "Management & Governance" category.

2. **Access Parameter Store:**
   - In the Systems Manager dashboard, scroll down to the "Application Management" section.
   - Click on "Parameter Store."

3. **Create or Modify a Parameter:**
   - To create a new parameter, click on the "Create parameter" button.
   - To modify an existing parameter, select the parameter from the list and click on its name to edit it.

4. **Enable Encryption:**
   - In the "Create parameter" or "Edit parameter" page, ensure that the "Type" is set to "SecureString."
   - Under the "KMS Key Source" section, select "AWS managed key (default)" or choose a custom KMS key from the dropdown list.
   - Click "Create parameter" or "Save changes" to apply the encryption settings.

By following these steps, you ensure that your SSM Parameters are encrypted, enhancing the security of sensitive data stored in AWS Systems Manager Parameter Store.
</Accordion>

<Accordion title='Using CLI'>
To ensure that SSM (Systems Manager) Parameters are encrypted in EC2 using AWS CLI, follow these steps:

1. **Create a KMS Key for Encryption:**
   First, create a KMS (Key Management Service) key that will be used to encrypt the SSM parameters.
   ```sh
   aws kms create-key --description "Key for encrypting SSM parameters" --key-usage ENCRYPT_DECRYPT --origin AWS_KMS
   ```

2. **Get the KMS Key ID:**
   Retrieve the Key ID of the newly created KMS key.
   ```sh
   aws kms list-keys
   ```

3. **Create an Encrypted SSM Parameter:**
   Use the KMS Key ID to create an SSM parameter with encryption enabled.
   ```sh
   aws ssm put-parameter --name "MySecureParameter" --value "MySecretValue" --type "SecureString" --key-id "alias/YourKMSKeyAlias"
   ```

4. **Verify the Parameter is Encrypted:**
   Confirm that the parameter is stored as a SecureString and is encrypted.
   ```sh
   aws ssm get-parameter --name "MySecureParameter" --with-decryption
   ```

By following these steps, you ensure that your SSM parameters are encrypted using AWS KMS, thereby preventing misconfigurations related to unencrypted parameters.
</Accordion>

<Accordion title='Using Python'>
To prevent SSM (Systems Manager) Parameters from being unencrypted in AWS EC2 using Python scripts, you can follow these steps:

1. **Install AWS SDK for Python (Boto3):**
   Ensure you have Boto3 installed in your environment. If not, you can install it using pip:
   ```bash
   pip install boto3
   ```

2. **Create a KMS Key:**
   Before creating encrypted SSM parameters, you need a KMS (Key Management Service) key. You can create a KMS key using Boto3:
   ```python
   import boto3

   kms_client = boto3.client('kms')

   response = kms_client.create_key(
       Description='Key for encrypting SSM parameters',
       KeyUsage='ENCRYPT_DECRYPT',
       Origin='AWS_KMS'
   )

   key_id = response['KeyMetadata']['KeyId']
   print(f"KMS Key ID: {key_id}")
   ```

3. **Create Encrypted SSM Parameters:**
   Use the KMS key to create encrypted SSM parameters. Hereâ€™s how you can do it:
   ```python
   import boto3

   ssm_client = boto3.client('ssm')

   parameter_name = '/my/secure/parameter'
   parameter_value = 'my_secure_value'
   key_id = 'your-kms-key-id'  # Replace with your actual KMS Key ID

   response = ssm_client.put_parameter(
       Name=parameter_name,
       Value=parameter_value,
       Type='SecureString',
       KeyId=key_id,
       Overwrite=True
   )

   print(f"Parameter {parameter_name} created with encryption.")
   ```

4. **Verify Encryption:**
   Ensure that the parameter is encrypted by retrieving its metadata:
   ```python
   import boto3

   ssm_client = boto3.client('ssm')

   parameter_name = '/my/secure/parameter'

   response = ssm_client.get_parameter(
       Name=parameter_name,
       WithDecryption=False
   )

   if response['Parameter']['Type'] == 'SecureString':
       print(f"Parameter {parameter_name} is encrypted.")
   else:
       print(f"Parameter {parameter_name} is not encrypted.")
   ```

By following these steps, you can ensure that your SSM parameters are encrypted using a KMS key, thereby preventing the misconfiguration of unencrypted parameters in AWS EC2.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Systems Manager service.

2. In the Systems Manager dashboard, select "Parameter Store" from the left-hand navigation pane.

3. In the Parameter Store page, you will see a list of all the parameters. Click on the name of the parameter you want to check.

4. In the parameter details page, check the "KMS Key ID" field. If this field is empty or not present, it means the parameter is not encrypted. If there is a value present, it means the parameter is encrypted with the specified KMS key.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all SSM parameters: Use the AWS CLI command `aws ssm describe-parameters` to list all the SSM parameters in your AWS account. This command will return a JSON output with details of all the SSM parameters.

3. Check encryption status: For each SSM parameter, check the 'KeyId' field in the JSON output. If the 'KeyId' field is null or not present, it means that the SSM parameter is not encrypted. You can use the following command to check the encryption status of a specific SSM parameter: `aws ssm get-parameter --name "parameter_name" --with-decryption`. Replace "parameter_name" with the name of the SSM parameter you want to check.

4. Automate the process with a script: You can write a Python script using the boto3 library to automate the process of checking the encryption status of all SSM parameters. The script should list all SSM parameters, check the encryption status of each parameter, and print out the names of parameters that are not encrypted.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary AWS SDK for Python (Boto3) if you haven't done so. You can install it using pip:
```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials:
```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. Use the SSM client from boto3 to get all the parameters:
```python
ssm = session.client('ssm')
parameters = ssm.describe_parameters()
```

4. Iterate over the parameters and check if they are encrypted. If the `KeyId` attribute is `None`, then the parameter is not encrypted:
```python
for parameter in parameters['Parameters']:
    if parameter['KeyId'] is None:
        print(f"Parameter {parameter['Name']} is not encrypted.")
```
This script will print out the names of all parameters that are not encrypted. You can modify it to suit your needs, for example by collecting the names in a list and returning it, or by raising an exception if any unencrypted parameters are found.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "SSM Parameters Should Be Encrypted" in AWS using the AWS console, you can follow the below steps:

1. Open the AWS Management Console and navigate to the AWS Systems Manager console.
2. Click on the "Parameter Store" option in the left-hand navigation menu.
3. Select the parameter you want to encrypt and click on its name.
4. Click on the "Edit" button at the top of the page.
5. Check the "SecureString" option to encrypt the parameter.
6. Click on the "Save changes" button.

After completing these steps, the selected parameter will be encrypted. You can repeat these steps for any other parameters that need to be encrypted.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of SSM parameters not being encrypted in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Check if the SSM parameters are encrypted or not using the following command:

```
aws ssm get-parameters --names "parameter-name" --with-decryption
```

Replace "parameter-name" with the name of the SSM parameter you want to check.

3. If the SSM parameter is not encrypted, encrypt it using the following command:

```
aws ssm put-parameter --name "parameter-name" --value "parameter-value" --type "SecureString" --key-id "alias/aws/ssm" --overwrite
```

Replace "parameter-name" with the name of the SSM parameter you want to encrypt, "parameter-value" with the value of the parameter, and "--key-id" with the KMS key ID to use for encryption. In this case, we are using the default AWS SSM KMS key.

4. Verify that the SSM parameter is now encrypted by running the "get-parameters" command again with the "--with-decryption" flag.

```
aws ssm get-parameters --names "parameter-name" --with-decryption
```

This should return the value of the encrypted SSM parameter.

5. Repeat steps 2-4 for all SSM parameters that are not encrypted.

By following these steps, you can remediate the misconfiguration of SSM parameters not being encrypted in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of SSM Parameters not being encrypted in AWS, you can follow these steps using Python:

1. Install the AWS SDK for Python (Boto3) using pip.

```
pip install boto3
```

2. Create an AWS session using the AWS access key and secret access key.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY'
)
```

3. Create a boto3 client for the SSM service.

```python
ssm_client = session.client('ssm')
```

4. Use the `describe_parameters()` method to get a list of all the SSM parameters in the AWS account.

```python
parameters = ssm_client.describe_parameters()
```

5. Loop through the list of parameters and check if the `KeyId` attribute is present. If it is not present, it means that the parameter is not encrypted.

```python
for parameter in parameters['Parameters']:
    if 'KeyId' not in parameter:
        # Parameter is not encrypted
```

6. Use the `update_parameter()` method to encrypt the parameter. Set the `KeyId` parameter to the ARN of the KMS key to be used for encryption.

```python
ssm_client.update_parameter(
    Name='PARAMETER_NAME',
    KeyId='KMS_KEY_ARN',
    Overwrite=True
)
```

7. Repeat steps 5 and 6 for all the SSM parameters that are not encrypted.

By following these steps, you can remediate the misconfiguration of SSM parameters not being encrypted in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
