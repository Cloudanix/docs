---
slug: unrestricted_smtp_access
title: Unrestricted SMTP Access Should Not Be Allowed
sidebar_label: Unrestricted SMTP Access Should Not Be Allowed
---

### More Info:

No security group should allow unrestricted inbound access to TCP port 25 (SMTP).

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, AWSWAF, GDPR, SOC2, NISTCSF, PCIDSS, FedRAMP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, choose 'Security Groups' under the 'Network & Security' section.
3. For each security group, look at the 'Inbound' tab in the details pane. Check if there are any rules that allow inbound traffic on port 25 (SMTP) from '0.0.0.0/0' or '::/0' (which represents all IPv4 and IPv6 addresses respectively).
4. If such rules exist, it means unrestricted SMTP access is allowed, which is a misconfiguration.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all security groups: The first step to detect unrestricted SMTP access is to list all the security groups in your AWS account. You can do this by running the following command: `aws ec2 describe-security-groups --query "SecurityGroups[*].[GroupId]" --output text`

3. Check security group rules: For each security group, you need to check the inbound rules to see if they allow unrestricted SMTP access. You can do this by running the following command for each security group: `aws ec2 describe-security-groups --group-ids <security-group-id> --query "SecurityGroups[*].IpPermissions[*]" --output json`

4. Analyze the output: The output of the above command will be a JSON object that contains all the inbound rules for the specified security group. You need to analyze this output to see if there are any rules that allow unrestricted SMTP access. Specifically, you need to look for rules where the `IpProtocol` is `tcp`, the `FromPort` is `25` (the port used by SMTP), and the `IpRanges` includes `0.0.0.0/0` (which represents all IP addresses). If such a rule exists, then unrestricted SMTP access is allowed.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3, AWS EC2, and more. You can install it using pip:

```python
pip install boto3
```
After installation, you need to configure it. You can do this in several ways, but the simplest is to use the AWS CLI:

```bash
aws configure
```
This will prompt you for your AWS Access Key ID, Secret Access Key, AWS Region, and output format. These will be stored in ~/.aws/credentials and ~/.aws/config respectively.

2. Use Boto3 to interact with AWS EC2: You can use Boto3 to create, configure, and manage AWS services. For example, you can start or stop EC2 instances, create security groups, and more. Here's a simple script to list all EC2 instances:

```python
import boto3

ec2 = boto3.resource('ec2')

for instance in ec2.instances.all():
    print(instance.id, instance.state)
```

3. Check for unrestricted SMTP access: You can use Boto3 to describe your security groups and check if they allow unrestricted SMTP access. Here's a script that does this:

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_security_groups()

for group in response['SecurityGroups']:
    for permission in group['IpPermissions']:
        if permission['FromPort'] == 25 and permission['ToPort'] == 25:
            for range in permission['IpRanges']:
                if range['CidrIp'] == '0.0.0.0/0':
                    print(f"Security Group {group['GroupId']} allows unrestricted SMTP access")
```

4. Interpret the results: If the script prints out any security group IDs, those security groups allow unrestricted SMTP access. You should review these security groups and consider restricting their access. If the script doesn't print anything, none of your security groups allow unrestricted SMTP access.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the unrestricted SMTP access issue in AWS, follow these steps:

1. Open the AWS Management Console and navigate to the EC2 service.
2. Select the EC2 instance that is allowing unrestricted SMTP access.
3. Click on the "Security" tab and scroll down to the "Security groups" section.
4. Click on the security group that is associated with the instance.
5. Click on the "Inbound rules" tab.
6. Locate the rule that allows SMTP traffic (port 25) with the source of "0.0.0.0/0" or "::/0".
7. Click on the "Edit" button next to the rule.
8. Change the source to a specific IP address range or security group that requires SMTP access.
9. Click the "Save" button to apply the changes.

By following these steps, you have successfully remediated the unrestricted SMTP access issue in AWS.

#### Using CLI

To remediate this issue in AWS, you can follow the below steps using AWS CLI:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to list all the active SMTP settings in the AWS account:

```
aws ses get-account-sending-enabled
```

3. If the command output shows that the "SendingEnabled" parameter is set to "true", then you need to disable it. Run the following command to disable SMTP access:

```
aws ses update-account-sending-enabled --no-sending-enabled
```

4. After running the above command, verify that the "SendingEnabled" parameter is set to "false" by running the following command:

```
aws ses get-account-sending-enabled
```

5. If the "SendingEnabled" parameter is set to "false", then SMTP access has been successfully restricted in your AWS account.

Note: This remediation will disable SMTP access for all users in your AWS account. If you need to enable SMTP access for specific users, you can create an IAM policy that allows SMTP access and attach it to their IAM user or role.

#### Using Python

To remediate unrestricted SMTP access in AWS using Python, you can follow the steps below:

1. Create a Python script to check for SMTP access:

```python
import boto3

client = boto3.client('ec2')
response = client.describe_security_groups()

for group in response['SecurityGroups']:
    for permission in group['IpPermissions']:
        if permission.get('FromPort') == 25 and permission.get('IpRanges') == [{'CidrIp': '0.0.0.0/0'}]:
            group_id = group['GroupId']
            print(f"Found unrestricted SMTP access in security group {group_id}")
```

2. Once you have identified the security group(s) with unrestricted SMTP access, you can update the security group rules to restrict SMTP access to specific IP addresses or ranges.

```python
import boto3

client = boto3.client('ec2')
response = client.authorize_security_group_ingress(
    GroupId='SECURITY_GROUP_ID',
    IpPermissions=[
        {
            'IpProtocol': 'tcp',
            'FromPort': 25,
            'ToPort': 25,
            'IpRanges': [
                {
                    'CidrIp': 'ALLOWED_IP_ADDRESS/32'
                }
            ]
        }
    ]
)
```

Replace `SECURITY_GROUP_ID` with the ID of the security group that needs to be updated and `ALLOWED_IP_ADDRESS` with the IP address or range that should be allowed to access SMTP.

3. Run the Python script to check for and remediate unrestricted SMTP access in AWS.

### Additional Reading:

- [https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#AddRemoveRules](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#AddRemoveRules) 


</Tab>
</Tabs>