---
slug: ec2_token_hop_limit_check
title: EC2 Hop Limit Check.  
sidebar_label: EC2 Hop Limit Check. 
---

### More Info:

This rule checks if an Amazon Elastic Compute Cloud (EC2) instance metadata has a specified token hop limit that is below the desired limit. The rule is NON_COMPLIANT for an instance if it has a hop limit value above the intended limit.

### Risk Level

Low

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and open the Amazon VPC console at https://console.aws.amazon.com/vpc/.

2. In the navigation pane, choose 'Your VPCs'.

3. Select the VPC you want to check and then click on 'Actions'.

4. In the dropdown menu, click on 'Edit Tenancy' and check the current setting. If it is set to 'default', it means that the EC2 instances in this VPC can be either dedicated instances or shared instances. If it is set to 'dedicated', it means that all EC2 instances launched in this VPC are dedicated instances, regardless of the tenancy assigned at the instance level.

5. To check the hop limit, go to the 'Route Tables' section in the VPC dashboard. Select the route table associated with your VPC and click on the 'Routes' tab. Here, you can see the hop limit for each route in your VPC. The hop limit for an IPv6 route must be 1 to prevent IP packets from being forwarded beyond the VPC.

Note: The hop limit cannot be checked directly from the AWS console. It is a property of the IP packets themselves and is used to prevent IP packets from circulating indefinitely due to routing errors. The hop limit is decremented by 1 each time the packet is forwarded by a router. When the hop limit reaches 0, the packet is discarded and an ICMPv6 Time Exceeded message is sent back to the sender.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI using pip (Python package manager) by running the command `pip install awscli`. After installation, you can configure it by running `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all VPCs: To check the EC2 hop limit, you need to first list all the VPCs in your AWS account. You can do this by running the command `aws ec2 describe-vpcs`. This will return a JSON output with details of all the VPCs.

3. List all route tables: Next, you need to list all the route tables associated with each VPC. You can do this by running the command `aws ec2 describe-route-tables --filters Name=vpc-id,Values=<VPC_ID>`. Replace `<VPC_ID>` with the ID of the VPC you want to check. This will return a JSON output with details of all the route tables associated with the specified VPC.

4. Check hop limit: Finally, you can check the hop limit for each route in the route tables. In the JSON output from the previous step, look for the `Routes` key. This is an array of routes, and each route has a `DestinationCidrBlock` and `GatewayId`. If the `GatewayId` is set to `local`, then the hop limit for that route is 1. If the `GatewayId` is set to the ID of an internet gateway, then the hop limit for that route is 100.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing your Python script, you need to install the necessary libraries. The Boto3 library is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of AWS services like Amazon S3, Amazon EC2, etc. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Configure AWS Credentials: Boto3 needs your AWS credentials (access key and secret access key) to call AWS services on your behalf. You can configure it in several ways, but the simplest is to use the AWS CLI:

   ```bash
   aws configure
   ```

   Then input your Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

3. Write the Python script: Now you can write a Python script to check the EC2 Hop Limit. Here is a simple script that lists all EC2 instances and their Source/Dest check attribute:

   ```python
   import boto3

   def check_hop_limit():
       ec2 = boto3.resource('ec2')
       for instance in ec2.instances.all():
           print('ID: {}, SourceDestCheck: {}'.format(instance.id, instance.source_dest_check))

   if __name__ == '__main__':
       check_hop_limit()
   ```

   This script uses the Boto3 EC2 resource to get all EC2 instances and then prints their ID and Source/Dest check attribute. If the Source/Dest check attribute is False, it means that the instance is configured to perform network address translation (NAT) for traffic that is not addressed to it, which could be a misconfiguration if not intended.

4. Run the Python script: Finally, you can run the Python script using the Python interpreter:

   ```bash
   python check_hop_limit.py
   ```

   This will print the ID and Source/Dest check attribute of all EC2 instances. You can then review this information to detect any misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using the AWS Management Console, follow these steps:

1. **Login to AWS Console**: Visit the AWS Management Console (https://aws.amazon.com/console/) and log in with your credentials.

2. **Navigate to EC2 Service**: Click on the "Services" dropdown menu at the top of the page and select "EC2" under the Compute section.

3. **Select the EC2 Instance**: In the EC2 Dashboard, locate the EC2 instance for which you want to remediate the Hop Limit Check misconfiguration.

4. **Modify Security Group**: Click on the "Security" link under the "Description" tab of the selected EC2 instance.

5. **Edit Inbound Rules**: In the Security Group settings, locate the inbound rule that allows traffic to the EC2 instance.

6. **Update Inbound Rule**: Edit the inbound rule to restrict the source IP addresses or CIDR range that can communicate with the EC2 instance. You can set the source IP address to a specific IP or CIDR block to limit the number of hops allowed.

7. **Save Changes**: After updating the inbound rule, click on the "Save" or "Apply" button to apply the changes.

8. **Verify Configuration**: Verify that the inbound rule has been updated successfully and that only authorized IP addresses or CIDR ranges can communicate with the EC2 instance.

By following these steps, you can remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using AWS CLI, you can follow these steps:

1. **Identify the affected EC2 instance**: First, identify the EC2 instance(s) that are affected by the Hop Limit Check misconfiguration.

2. **Update the Security Group**: You will need to update the security group associated with the affected EC2 instance(s) to allow the desired traffic. Specifically, you need to modify the inbound rules to allow traffic with the desired hop limit.

3. **Get the Security Group ID**: Use the following AWS CLI command to get the security group ID associated with the affected EC2 instance:
   ```
   aws ec2 describe-instances --instance-ids <instance-id> --query 'Reservations[*].Instances[*].SecurityGroups[*].[GroupId]' --output text
   ```

4. **Update the Security Group Inbound Rules**: Use the following AWS CLI command to update the inbound rules of the security group to allow traffic with the desired hop limit. Replace `<security-group-id>` with the security group ID obtained in the previous step and `<desired-hop-limit>` with the desired hop limit value.
   ```
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --ip-permissions '[{"IpProtocol": "icmp", "FromPort": <desired-hop-limit>, "ToPort": <desired-hop-limit>, "IpRanges": [{"CidrIp": "0.0.0.0/0"}]}]'
   ```

5. **Verify the Security Group Rules**: Run the following AWS CLI command to verify that the inbound rule has been updated successfully:
   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions'
   ```

6. **Test Connectivity**: Finally, test the connectivity to ensure that the hop limit check misconfiguration has been remediated successfully.

By following these steps and updating the security group inbound rules to allow traffic with the desired hop limit, you can remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the EC2 Hop Limit Check misconfiguration in AWS EC2 using Python, you can create a Lambda function that will periodically check the hop limit for all your EC2 instances and take appropriate actions. Here are the step-by-step instructions to remediate this misconfiguration:

1. **Create a Lambda Function**:
   - Go to the AWS Management Console and navigate to the Lambda service.
   - Click on "Create function" and choose the option to author from scratch.
   - Provide a name for your function, select Python as the runtime, and choose an existing role with necessary permissions or create a new role.
   - Click on "Create function" to create the Lambda function.

2. **Add Code to Check Hop Limit**:
   - In the Lambda function code editor, write Python code to describe instances and check the hop limit for each EC2 instance.
   - Use the Boto3 library to interact with AWS services. Install it using `pip install boto3` if not already installed.
   - Use the `describe_instances` method to get information about all EC2 instances.
   - Check the hop limit for each instance by inspecting the "InstanceType" attribute.

3. **Take Remediation Actions**:
   - If the hop limit is not compliant, you can modify the instance settings to comply with the desired hop limit.
   - Use the `modify_instance_attribute` method to update the hop limit for non-compliant instances.

4. **Set up Event Trigger**:
   - Create a CloudWatch Events rule to trigger the Lambda function at a regular interval (e.g., every hour).
   - Configure the rule to trigger the Lambda function and set the schedule expression.

5. **Testing**:
   - Test the Lambda function by manually triggering it and verifying that it correctly identifies and remediates the hop limit misconfigurations.

6. **Monitoring**:
   - Set up CloudWatch Alarms to monitor the execution of the Lambda function and receive notifications in case of failures.

7. **Logging**:
   - Implement logging within the Lambda function to track the hop limit checks and remediation actions taken for auditing purposes.

By following these steps, you can create a Python-based Lambda function that automatically remediates the EC2 Hop Limit Check misconfiguration in AWS EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

