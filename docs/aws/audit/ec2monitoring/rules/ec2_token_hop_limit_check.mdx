---
slug: ec2_token_hop_limit_check
title: EC2 Hop Limit Check.  
sidebar_label: EC2 Hop Limit Check. 
---

### More Info:

This rule checks if an Amazon Elastic Compute Cloud (EC2) instance metadata has a specified token hop limit that is below the desired limit. The rule is NON_COMPLIANT for an instance if it has a hop limit value above the intended limit.

### Risk Level

Low

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 Hop Limit Check in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to EC2 Dashboard:**
   - Open the AWS Management Console.
   - In the top navigation bar, select "Services" and then choose "EC2" under the "Compute" section.

2. **Select the Instance:**
   - In the EC2 Dashboard, click on "Instances" in the left-hand menu.
   - Select the instance for which you want to configure the hop limit.

3. **Modify Instance Metadata Options:**
   - With the instance selected, click on the "Actions" button at the top of the page.
   - Choose "Instance Settings" and then "Modify Instance Metadata Options."

4. **Set Hop Limit:**
   - In the "Modify Instance Metadata Options" dialog, find the "Hop limit" field.
   - Set the hop limit to a value that suits your security requirements (e.g., 1 to restrict access to the instance itself).
   - Click "Save" to apply the changes.

By following these steps, you can configure the hop limit for your EC2 instance to prevent unauthorized access through intermediate hops.
</Accordion>

<Accordion title='Using CLI'>
To prevent EC2 Hop Limit Check misconfiguration using AWS CLI, you need to ensure that the hop limit for your EC2 instances is set correctly. Here are the steps to do this:

1. **Describe the Instances to Check Current Hop Limit:**
   First, you need to check the current hop limit settings for your EC2 instances. Use the following command to describe your instances and check the hop limit:

   ```sh
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].{InstanceId:InstanceId,HopLimit:MetadataOptions.HttpPutResponseHopLimit}' --output table
   ```

2. **Modify the Hop Limit for an Instance:**
   If you find that the hop limit is not set correctly, you can modify it using the `modify-instance-metadata-options` command. Replace `<instance-id>` with your actual instance ID and set the desired hop limit (e.g., 2):

   ```sh
   aws ec2 modify-instance-metadata-options --instance-id <instance-id> --http-put-response-hop-limit 2
   ```

3. **Verify the Changes:**
   After modifying the hop limit, verify that the changes have been applied correctly by describing the instance again:

   ```sh
   aws ec2 describe-instances --instance-ids <instance-id> --query 'Reservations[*].Instances[*].{InstanceId:InstanceId,HopLimit:MetadataOptions.HttpPutResponseHopLimit}' --output table
   ```

4. **Automate the Process for Multiple Instances:**
   If you need to apply this change to multiple instances, you can use a loop in a shell script. For example, to set the hop limit for all instances in a specific region:

   ```sh
   INSTANCE_IDS=$(aws ec2 describe-instances --query 'Reservations[*].Instances[*].InstanceId' --output text)
   for INSTANCE_ID in $INSTANCE_IDS; do
       aws ec2 modify-instance-metadata-options --instance-id $INSTANCE_ID --http-put-response-hop-limit 2
   done
   ```

By following these steps, you can ensure that the hop limit for your EC2 instances is set correctly, thereby preventing the EC2 Hop Limit Check misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To prevent EC2 Hop Limit Check misconfiguration using Python scripts, you can follow these steps:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed, which is the AWS SDK for Python. You can install it using pip if you haven't already.

   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by directly configuring the `~/.aws/credentials` file.

3. **Create a Python Script to Configure Hop Limit**:
   Write a Python script to configure the hop limit for your EC2 instances. The hop limit is controlled by the `InstanceMetadataOptions` parameter.

   ```python
   import boto3

   # Initialize a session using Amazon EC2
   ec2 = boto3.client('ec2')

   # Define the instance ID and the desired hop limit
   instance_id = 'i-0abcd1234efgh5678'  # Replace with your instance ID
   hop_limit = 1  # Set the desired hop limit

   # Modify the instance metadata options
   response = ec2.modify_instance_metadata_options(
       InstanceId=instance_id,
       HttpPutResponseHopLimit=hop_limit
   )

   print(response)
   ```

4. **Run the Script**:
   Execute the script to apply the hop limit configuration to your EC2 instance.

   ```bash
   python configure_hop_limit.py
   ```

By following these steps, you can prevent EC2 Hop Limit Check misconfiguration using a Python script. This ensures that the hop limit is set correctly, enhancing the security of your EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and open the Amazon VPC console at https://console.aws.amazon.com/vpc/.

2. In the navigation pane, choose 'Your VPCs'.

3. Select the VPC you want to check and then click on 'Actions'.

4. In the dropdown menu, click on 'Edit Tenancy' and check the current setting. If it is set to 'default', it means that the EC2 instances in this VPC can be either dedicated instances or shared instances. If it is set to 'dedicated', it means that all EC2 instances launched in this VPC are dedicated instances, regardless of the tenancy assigned at the instance level.

5. To check the hop limit, go to the 'Route Tables' section in the VPC dashboard. Select the route table associated with your VPC and click on the 'Routes' tab. Here, you can see the hop limit for each route in your VPC. The hop limit for an IPv6 route must be 1 to prevent IP packets from being forwarded beyond the VPC.

Note: The hop limit cannot be checked directly from the AWS console. It is a property of the IP packets themselves and is used to prevent IP packets from circulating indefinitely due to routing errors. The hop limit is decremented by 1 each time the packet is forwarded by a router. When the hop limit reaches 0, the packet is discarded and an ICMPv6 Time Exceeded message is sent back to the sender.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI using pip (Python package manager) by running the command `pip install awscli`. After installation, you can configure it by running `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all VPCs: To check the EC2 hop limit, you need to first list all the VPCs in your AWS account. You can do this by running the command `aws ec2 describe-vpcs`. This will return a JSON output with details of all the VPCs.

3. List all route tables: Next, you need to list all the route tables associated with each VPC. You can do this by running the command `aws ec2 describe-route-tables --filters Name=vpc-id,Values=<VPC_ID>`. Replace `<VPC_ID>` with the ID of the VPC you want to check. This will return a JSON output with details of all the route tables associated with the specified VPC.

4. Check hop limit: Finally, you can check the hop limit for each route in the route tables. In the JSON output from the previous step, look for the `Routes` key. This is an array of routes, and each route has a `DestinationCidrBlock` and `GatewayId`. If the `GatewayId` is set to `local`, then the hop limit for that route is 1. If the `GatewayId` is set to the ID of an internet gateway, then the hop limit for that route is 100.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing your Python script, you need to install the necessary libraries. The Boto3 library is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of AWS services like Amazon S3, Amazon EC2, etc. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Configure AWS Credentials: Boto3 needs your AWS credentials (access key and secret access key) to call AWS services on your behalf. You can configure it in several ways, but the simplest is to use the AWS CLI:

   ```bash
   aws configure
   ```

   Then input your Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

3. Write the Python script: Now you can write a Python script to check the EC2 Hop Limit. Here is a simple script that lists all EC2 instances and their Source/Dest check attribute:

   ```python
   import boto3

   def check_hop_limit():
       ec2 = boto3.resource('ec2')
       for instance in ec2.instances.all():
           print('ID: {}, SourceDestCheck: {}'.format(instance.id, instance.source_dest_check))

   if __name__ == '__main__':
       check_hop_limit()
   ```

   This script uses the Boto3 EC2 resource to get all EC2 instances and then prints their ID and Source/Dest check attribute. If the Source/Dest check attribute is False, it means that the instance is configured to perform network address translation (NAT) for traffic that is not addressed to it, which could be a misconfiguration if not intended.

4. Run the Python script: Finally, you can run the Python script using the Python interpreter:

   ```bash
   python check_hop_limit.py
   ```

   This will print the ID and Source/Dest check attribute of all EC2 instances. You can then review this information to detect any misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using the AWS Management Console, follow these steps:

1. **Login to AWS Console**: Visit the AWS Management Console (https://aws.amazon.com/console/) and log in with your credentials.

2. **Navigate to EC2 Service**: Click on the "Services" dropdown menu at the top of the page and select "EC2" under the Compute section.

3. **Select the EC2 Instance**: In the EC2 Dashboard, locate the EC2 instance for which you want to remediate the Hop Limit Check misconfiguration.

4. **Modify Security Group**: Click on the "Security" link under the "Description" tab of the selected EC2 instance.

5. **Edit Inbound Rules**: In the Security Group settings, locate the inbound rule that allows traffic to the EC2 instance.

6. **Update Inbound Rule**: Edit the inbound rule to restrict the source IP addresses or CIDR range that can communicate with the EC2 instance. You can set the source IP address to a specific IP or CIDR block to limit the number of hops allowed.

7. **Save Changes**: After updating the inbound rule, click on the "Save" or "Apply" button to apply the changes.

8. **Verify Configuration**: Verify that the inbound rule has been updated successfully and that only authorized IP addresses or CIDR ranges can communicate with the EC2 instance.

By following these steps, you can remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using AWS CLI, you can follow these steps:

1. **Identify the affected EC2 instance**: First, identify the EC2 instance(s) that are affected by the Hop Limit Check misconfiguration.

2. **Update the Security Group**: You will need to update the security group associated with the affected EC2 instance(s) to allow the desired traffic. Specifically, you need to modify the inbound rules to allow traffic with the desired hop limit.

3. **Get the Security Group ID**: Use the following AWS CLI command to get the security group ID associated with the affected EC2 instance:
   ```
   aws ec2 describe-instances --instance-ids <instance-id> --query 'Reservations[*].Instances[*].SecurityGroups[*].[GroupId]' --output text
   ```

4. **Update the Security Group Inbound Rules**: Use the following AWS CLI command to update the inbound rules of the security group to allow traffic with the desired hop limit. Replace `<security-group-id>` with the security group ID obtained in the previous step and `<desired-hop-limit>` with the desired hop limit value.
   ```
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --ip-permissions '[{"IpProtocol": "icmp", "FromPort": <desired-hop-limit>, "ToPort": <desired-hop-limit>, "IpRanges": [{"CidrIp": "0.0.0.0/0"}]}]'
   ```

5. **Verify the Security Group Rules**: Run the following AWS CLI command to verify that the inbound rule has been updated successfully:
   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions'
   ```

6. **Test Connectivity**: Finally, test the connectivity to ensure that the hop limit check misconfiguration has been remediated successfully.

By following these steps and updating the security group inbound rules to allow traffic with the desired hop limit, you can remediate the EC2 Hop Limit Check misconfiguration for AWS EC2 using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the EC2 Hop Limit Check misconfiguration in AWS EC2 using Python, you can create a Lambda function that will periodically check the hop limit for all your EC2 instances and take appropriate actions. Here are the step-by-step instructions to remediate this misconfiguration:

1. **Create a Lambda Function**:
   - Go to the AWS Management Console and navigate to the Lambda service.
   - Click on "Create function" and choose the option to author from scratch.
   - Provide a name for your function, select Python as the runtime, and choose an existing role with necessary permissions or create a new role.
   - Click on "Create function" to create the Lambda function.

2. **Add Code to Check Hop Limit**:
   - In the Lambda function code editor, write Python code to describe instances and check the hop limit for each EC2 instance.
   - Use the Boto3 library to interact with AWS services. Install it using `pip install boto3` if not already installed.
   - Use the `describe_instances` method to get information about all EC2 instances.
   - Check the hop limit for each instance by inspecting the "InstanceType" attribute.

3. **Take Remediation Actions**:
   - If the hop limit is not compliant, you can modify the instance settings to comply with the desired hop limit.
   - Use the `modify_instance_attribute` method to update the hop limit for non-compliant instances.

4. **Set up Event Trigger**:
   - Create a CloudWatch Events rule to trigger the Lambda function at a regular interval (e.g., every hour).
   - Configure the rule to trigger the Lambda function and set the schedule expression.

5. **Testing**:
   - Test the Lambda function by manually triggering it and verifying that it correctly identifies and remediates the hop limit misconfigurations.

6. **Monitoring**:
   - Set up CloudWatch Alarms to monitor the execution of the Lambda function and receive notifications in case of failures.

7. **Logging**:
   - Implement logging within the Lambda function to track the hop limit checks and remediation actions taken for auditing purposes.

By following these steps, you can create a Python-based Lambda function that automatically remediates the EC2 Hop Limit Check misconfiguration in AWS EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

