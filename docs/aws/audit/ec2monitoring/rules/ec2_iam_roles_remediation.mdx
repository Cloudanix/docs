
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of not using IAM Roles for EC2 instances in AWS using the AWS Management Console, follow these steps:

1. **Create an IAM Role for EC2:**
   - Navigate to the IAM service in the AWS Management Console.
   - Click on "Roles" in the left-hand menu.
   - Click the "Create role" button.
   - Select "AWS service" and then choose "EC2" as the service that will use this role.
   - Attach the necessary policies that define the permissions for the role.
   - Complete the role creation process by giving it a name and reviewing the settings.

2. **Launch EC2 Instance with IAM Role:**
   - Go to the EC2 Dashboard in the AWS Management Console.
   - Click on "Launch Instance."
   - Follow the steps to configure your instance.
   - In the "Configure Instance" step, under the "IAM role" dropdown, select the IAM role you created for EC2.

3. **Modify Existing EC2 Instances to Use IAM Role:**
   - Navigate to the EC2 Dashboard.
   - Select the instance you want to modify.
   - Click on the "Actions" dropdown, then select "Security" and "Modify IAM Role."
   - Choose the appropriate IAM role from the dropdown and apply the changes.

4. **Set Up IAM Policies and Permissions:**
   - Ensure that the IAM policies attached to the role have the least privilege necessary for the tasks the EC2 instance will perform.
   - Regularly review and update the policies to ensure they are up-to-date and secure.

By following these steps, you can ensure that your EC2 instances are using IAM roles, which helps in managing permissions securely and efficiently.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not using IAM Roles for EC2 instances using AWS CLI, follow these steps:

1. **Create an IAM Role with Necessary Permissions:**
   First, create an IAM role with the necessary permissions that your EC2 instances will need. For example, if your EC2 instances need to access S3, create a role with the appropriate S3 permissions.

   ```sh
   aws iam create-role --role-name MyEC2Role --assume-role-policy-document file://trust-policy.json
   aws iam attach-role-policy --role-name MyEC2Role --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
   ```

   The `trust-policy.json` should contain the trust relationship policy, allowing EC2 to assume this role. Example content for `trust-policy.json`:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "Service": "ec2.amazonaws.com"
         },
         "Action": "sts:AssumeRole"
       }
     ]
   }
   ```

2. **Launch EC2 Instance with IAM Role:**
   When launching a new EC2 instance, specify the IAM role that you created in the previous step.

   ```sh
   aws ec2 run-instances --image-id ami-0abcdef1234567890 --count 1 --instance-type t2.micro --iam-instance-profile Name=MyEC2Role
   ```

3. **Attach IAM Role to Existing EC2 Instance:**
   If you have an existing EC2 instance that does not have an IAM role attached, you can attach the IAM role using the following command:

   ```sh
   aws ec2 associate-iam-instance-profile --instance-id i-1234567890abcdef0 --iam-instance-profile Name=MyEC2Role
   ```

4. **Verify IAM Role Attachment:**
   Ensure that the IAM role is correctly attached to your EC2 instance by describing the instance profile association.

   ```sh
   aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-1234567890abcdef0
   ```

By following these steps, you can ensure that your EC2 instances are using IAM roles, thereby preventing the misconfiguration of not using IAM roles for EC2 instances.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not using IAM Roles for EC2 instances in AWS, you can use Python scripts to ensure that all EC2 instances are launched with an appropriate IAM role. Here are the steps to achieve this:

### Step 1: Install Boto3
Ensure you have the Boto3 library installed, which is the AWS SDK for Python.

```bash
pip install boto3
```

### Step 2: Create an IAM Role
Create an IAM role with the necessary permissions that you want to attach to your EC2 instances. This step is typically done once and manually through the AWS Management Console or using the AWS CLI.

### Step 3: Python Script to Launch EC2 Instances with IAM Role
Use the following Python script to launch EC2 instances with a specified IAM role. This script ensures that every new EC2 instance is launched with the IAM role.

```python
import boto3

# Initialize a session using Amazon EC2
ec2 = boto3.client('ec2', region_name='us-west-2')

# Define the IAM role to be used
iam_role_name = 'your-iam-role-name'

# Define the instance details
instance_details = {
    'ImageId': 'ami-0abcdef1234567890',  # Replace with your AMI ID
    'InstanceType': 't2.micro',
    'MinCount': 1,
    'MaxCount': 1,
    'IamInstanceProfile': {
        'Name': iam_role_name
    }
}

# Launch the instance
response = ec2.run_instances(**instance_details)

print("Launched EC2 instance with IAM role:", iam_role_name)
```

### Step 4: Python Script to Check Existing EC2 Instances for IAM Role
Use the following Python script to check existing EC2 instances and ensure they have an IAM role attached. This script can be run periodically to audit your instances.

```python
import boto3

# Initialize a session using Amazon EC2
ec2 = boto3.client('ec2', region_name='us-west-2')

# Describe all instances
response = ec2.describe_instances()

# Check each instance for IAM role
for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        instance_id = instance['InstanceId']
        if 'IamInstanceProfile' in instance:
            print(f"Instance {instance_id} has IAM role: {instance['IamInstanceProfile']['Arn']}")
        else:
            print(f"Instance {instance_id} does NOT have an IAM role attached.")
```

### Summary
1. **Install Boto3**: Ensure you have the Boto3 library installed.
2. **Create an IAM Role**: Create an IAM role with the necessary permissions.
3. **Launch EC2 Instances with IAM Role**: Use a Python script to launch EC2 instances with the specified IAM role.
4. **Audit Existing EC2 Instances**: Use a Python script to check existing EC2 instances for attached IAM roles.

By following these steps, you can prevent the misconfiguration of EC2 instances not using IAM roles.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.

2. In the navigation pane, choose 'Instances'.

3. In the list of instances, select the instance you want to check.

4. In the 'Description' tab at the bottom, look for 'IAM role'. If there is no IAM role associated with the instance, it means that IAM roles are not being used for that EC2 instance.

5. Repeat the process for all the instances in your AWS account to ensure that IAM roles are being used.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to execute the commands.

2. Once the AWS CLI is set up, you can list all the EC2 instances in your account by running the following command:

   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text
   ```
   This command will return a list of all EC2 instance IDs.

3. For each instance ID, you can check if an IAM role is attached to it by running the following command:

   ```
   aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=<instance-id>
   ```
   Replace `<instance-id>` with the ID of the EC2 instance you want to check. This command will return information about the IAM role associated with the specified EC2 instance.

4. If the command returns an empty result, it means that no IAM role is attached to the EC2 instance. If it returns a result, it means that an IAM role is attached to the EC2 instance. You can check the details of the IAM role to see if it has the necessary permissions.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3) on your local system. Boto3 allows you to directly create, update, and delete AWS resources from your Python scripts.

```python
pip install boto3
aws configure
```

2. Create a Python script that uses Boto3 to interact with the AWS EC2 service. The script will list all EC2 instances and their associated IAM roles.

```python
import boto3

def list_ec2_iam_roles():
    ec2 = boto3.resource('ec2')
    for instance in ec2.instances.all():
        if instance.iam_instance_profile:
            print(f"Instance ID: {instance.id}, IAM Role: {instance.iam_instance_profile['Arn']}")
        else:
            print(f"Instance ID: {instance.id} does not have an IAM role associated.")

list_ec2_iam_roles()
```

3. Run the Python script. The script will print out the instance ID and the associated IAM role for each EC2 instance. If an instance does not have an associated IAM role, it will print out a message indicating this.

```python
python list_ec2_iam_roles.py
```

4. Review the output of the script. Instances without an associated IAM role represent a potential misconfiguration, as IAM roles are the recommended method for providing AWS credentials to applications running on EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "EC2 IAM Roles Should Be Used" for AWS using the AWS console, please follow the below steps:

1. Login to your AWS Management Console.
2. Navigate to the EC2 dashboard.
3. Select the EC2 instance for which you want to remediate the misconfiguration.
4. Click on the "Actions" dropdown menu and select "Instance Settings" and then click on "Attach/Replace IAM Role".
5. In the "Attach/Replace IAM Role" window, select the IAM role that you want to attach to the EC2 instance.
6. Click on the "Apply" button to attach the selected IAM role to the EC2 instance.

By following the above steps, you have successfully remediated the misconfiguration "EC2 IAM Roles Should Be Used" for AWS. Now the EC2 instance is associated with an IAM role, which provides temporary security credentials to applications that run on the instance. This helps to improve the security of your AWS infrastructure by reducing the risk of unauthorized access to resources.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of not using EC2 IAM roles in AWS using AWS CLI, follow the below steps:

1. Create an IAM role with the required permissions that the EC2 instance needs. You can create this role using the AWS CLI command "aws iam create-role".

2. Attach the required policies to the IAM role. You can attach policies using the AWS CLI command "aws iam attach-role-policy".

3. Launch an EC2 instance and specify the IAM role created in step 1. You can do this using the AWS CLI command "aws ec2 run-instances" with the parameter "--iam-instance-profile".

4. Verify that the IAM role is being used by the EC2 instance by logging into the instance and running the command "curl http://169.254.169.254/latest/meta-data/iam/info". This command should return the IAM role ARN.

5. Once verified, you can remove any access keys that were previously used by the EC2 instance. You can do this using the AWS CLI command "aws ec2 delete-key-pair".

By following these steps, you can remediate the issue of not using EC2 IAM roles in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of not using EC2 IAM roles in AWS, we can use the following steps using Python:

1. First, we need to create an IAM role that has the necessary permissions for our EC2 instances. We can do this using the boto3 library in Python. Here's an example:

```
import boto3

iam = boto3.client('iam')

response = iam.create_role(
    RoleName='EC2-Role',
    AssumeRolePolicyDocument={
        'Version': '2012-10-17',
        'Statement': [
            {
                'Effect': 'Allow',
                'Principal': {
                    'Service': 'ec2.amazonaws.com'
                },
                'Action': 'sts:AssumeRole'
            }
        ]
    }
)

# Attach necessary policies to the role
iam.attach_role_policy(
    RoleName='EC2-Role',
    PolicyArn='arn:aws:iam::aws:policy/AmazonS3FullAccess'
)
```

2. Once the IAM role is created, we can assign it to our EC2 instances. We can do this by launching new instances with the `--iam-instance-profile` parameter or by modifying existing instances with the `modify_instance_attribute` method in the `boto3` library.

```
import boto3

ec2 = boto3.client('ec2')

# Launch new instances with IAM role
response = ec2.run_instances(
    ImageId='ami-0c55b159cbfafe1f0',
    InstanceType='t2.micro',
    MinCount=1,
    MaxCount=1,
    IamInstanceProfile={
        'Arn': 'arn:aws:iam::123456789012:instance-profile/EC2-Role'
    }
)

# Modify existing instances with IAM role
response = ec2.modify_instance_attribute(
    InstanceId='i-0123456789abcdef0',
    IamInstanceProfile={
        'Arn': 'arn:aws:iam::123456789012:instance-profile/EC2-Role'
    }
)
```

By following these steps, we can remediate the misconfiguration of not using EC2 IAM roles in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
