---
slug: storagegateway_last_backup_recovery_point_created
title: Storage Gateway Recovery Point Should Be Created
sidebar_label: Storage Gateway Recovery Point Should Be Created
---

### More Info:

This rule checksif a recovery point was created for Amazon Relational Database Service (Amazon RDS). The rule is NON_COMPLIANT if the Amazon RDS instance does not have a corresponding recovery point 

### Risk Level

High

### Address

Configuration

### Compliance Standards

CBP,SEBI


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of not having a Storage Gateway Recovery Point created in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to AWS Storage Gateway:**
   - Sign in to the AWS Management Console.
   - Open the Storage Gateway console at [https://console.aws.amazon.com/storagegateway/](https://console.aws.amazon.com/storagegateway/).

2. **Select Your Gateway:**
   - In the Storage Gateway console, choose the gateway for which you want to create a recovery point.
   - Click on the gateway name to open its details page.

3. **Create a Recovery Point:**
   - In the gateway details page, navigate to the "Actions" dropdown menu.
   - Select "Create recovery point" from the dropdown options.
   - Follow the prompts to configure and create the recovery point.

4. **Enable Automatic Backups:**
   - To ensure that recovery points are created regularly, enable automatic backups.
   - Go to the "Settings" tab of your gateway.
   - Look for the backup configuration section and enable automatic backups, specifying the frequency and retention period as per your requirements.

By following these steps, you can ensure that recovery points are regularly created for your Storage Gateway in EC2, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not having a Storage Gateway Recovery Point created in EC2 using AWS CLI, you can follow these steps:

1. **Create a Backup Plan:**
   Ensure you have a backup plan that includes the Storage Gateway. This plan will define when and how backups are created.

   ```sh
   aws backup create-backup-plan --backup-plan '{
       "BackupPlanName": "MyBackupPlan",
       "Rules": [
           {
               "RuleName": "DailyBackup",
               "TargetBackupVaultName": "Default",
               "ScheduleExpression": "cron(0 12 * * ? *)",
               "StartWindowMinutes": 60,
               "CompletionWindowMinutes": 180,
               "Lifecycle": {
                   "MoveToColdStorageAfterDays": 30,
                   "DeleteAfterDays": 365
               }
           }
       ]
   }'
   ```

2. **Assign Resources to the Backup Plan:**
   Assign the Storage Gateway resource to the backup plan to ensure it is included in the scheduled backups.

   ```sh
   aws backup create-backup-selection --backup-plan-id <your-backup-plan-id> --backup-selection '{
       "SelectionName": "MyBackupSelection",
       "IamRoleArn": "arn:aws:iam::123456789012:role/service-role/AWSBackupDefaultServiceRole",
       "Resources": [
           "arn:aws:storagegateway:us-west-2:123456789012:gateway/sgw-12A3456B"
       ]
   }'
   ```

3. **Verify Backup Plan and Selection:**
   Verify that the backup plan and selection have been created and assigned correctly.

   ```sh
   aws backup get-backup-plan --backup-plan-id <your-backup-plan-id>
   aws backup get-backup-selection --backup-plan-id <your-backup-plan-id> --selection-id <your-selection-id>
   ```

4. **Enable AWS Backup Service:**
   Ensure that the AWS Backup service is enabled for your account and region.

   ```sh
   aws backup start-backup-job --backup-vault-name Default --resource-arn arn:aws:storagegateway:us-west-2:123456789012:gateway/sgw-12A3456B --iam-role-arn arn:aws:iam::123456789012:role/service-role/AWSBackupDefaultServiceRole
   ```

By following these steps, you can ensure that a recovery point is created for your Storage Gateway in EC2, preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not having a Storage Gateway Recovery Point created in EC2 using Python scripts, you can follow these steps:

### Step 1: Set Up AWS SDK for Python (Boto3)
First, ensure you have the AWS SDK for Python (Boto3) installed. You can install it using pip if you haven't already:

```bash
pip install boto3
```

### Step 2: Configure AWS Credentials
Make sure your AWS credentials are configured. You can do this by setting up the `~/.aws/credentials` file or by using environment variables.

### Step 3: Create a Python Script to Check and Create Recovery Points
Here is a Python script that checks if a recovery point exists for a given Storage Gateway and creates one if it doesn't:

```python
import boto3
from botocore.exceptions import NoCredentialsError, PartialCredentialsError

# Initialize the AWS Storage Gateway client
client = boto3.client('storagegateway')

# Function to check if a recovery point exists
def check_recovery_point(gateway_arn):
    try:
        response = client.list_volume_recovery_points(GatewayARN=gateway_arn)
        recovery_points = response.get('VolumeRecoveryPointInfos', [])
        return len(recovery_points) > 0
    except (NoCredentialsError, PartialCredentialsError) as e:
        print(f"Error: {e}")
        return False

# Function to create a recovery point
def create_recovery_point(gateway_arn, volume_arn):
    try:
        response = client.create_snapshot_from_volume_recovery_point(
            GatewayARN=gateway_arn,
            VolumeARN=volume_arn,
            SnapshotDescription='Automated recovery point'
        )
        print(f"Recovery point created: {response['SnapshotId']}")
    except Exception as e:
        print(f"Error creating recovery point: {e}")

# Main function to ensure recovery point exists
def ensure_recovery_point(gateway_arn, volume_arn):
    if not check_recovery_point(gateway_arn):
        print("No recovery point found. Creating one...")
        create_recovery_point(gateway_arn, volume_arn)
    else:
        print("Recovery point already exists.")

# Example usage
gateway_arn = 'arn:aws:storagegateway:us-west-2:123456789012:gateway/sgw-12A3456B'
volume_arn = 'arn:aws:storagegateway:us-west-2:123456789012:volume/vol-12345678'
ensure_recovery_point(gateway_arn, volume_arn)
```

### Step 4: Automate the Script Execution
To ensure continuous compliance, you can automate the execution of this script using AWS Lambda or a cron job on an EC2 instance. Hereâ€™s a brief on how to set it up with AWS Lambda:

1. **Create a Lambda Function:**
   - Go to the AWS Lambda console.
   - Click on "Create function".
   - Choose "Author from scratch".
   - Configure the function name, runtime (Python 3.x), and permissions.

2. **Deploy the Script:**
   - Upload the script as a .zip file or directly paste the code into the Lambda function editor.
   - Ensure the Lambda function has the necessary IAM role with permissions to access Storage Gateway and create snapshots.

3. **Set Up a CloudWatch Event:**
   - Go to the CloudWatch console.
   - Create a new rule to trigger the Lambda function on a schedule (e.g., daily).

By following these steps, you can ensure that a Storage Gateway Recovery Point is always created in EC2, preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "ELASTIC BLOCK STORE", click on "Snapshots".
3. In the "Snapshots" page, you can see all the snapshots created for your EC2 instances. Check the "Description" column for any snapshots related to the Storage Gateway.
4. If there are no recent snapshots (recovery points) for the Storage Gateway, it indicates a misconfiguration as regular snapshots should be created for recovery purposes.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is installed and configured, you can use the following command to list all the gateways:

   ```
   aws storagegateway list-gateways
   ```
   This command will return a list of all the gateways. Note down the ARN of the gateway you want to check.

3. Now, you can use the following command to list all the volumes associated with the gateway:

   ```
   aws storagegateway list-volumes --gateway-arn <Gateway-ARN>
   ```
   Replace `<Gateway-ARN>` with the ARN of the gateway you noted down in the previous step. This command will return a list of all the volumes associated with the gateway. Note down the ARN of the volume you want to check.

4. Finally, you can use the following command to list all the recovery points associated with the volume:

   ```
   aws storagegateway list-recovery-points-for-gateway --volume-arn <Volume-ARN>
   ```
   Replace `<Volume-ARN>` with the ARN of the volume you noted down in the previous step. This command will return a list of all the recovery points associated with the volume. If no recovery points are returned, then no recovery point has been created for the volume.
</Accordion>

<Accordion title='Using Python'>
1. **Import necessary libraries and establish a session**: To start with, you need to import the necessary libraries in your Python script. The primary library you need is boto3, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. Here is how you can import it and establish a session:

```python
import boto3

# Create a session using your AWS credentials
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'  # or any other region where your instance is located
)
```

2. **Connect to the EC2 client**: Once the session is established, you can connect to the EC2 client using the session object. This will allow you to interact with the EC2 instances and perform various operations.

```python
# Connect to the EC2 client
ec2_client = session.client('ec2')
```

3. **List all the EC2 instances and their recovery points**: Now, you can list all the EC2 instances and their recovery points. You can do this by calling the `describe_instances` method on the EC2 client object. This will return a list of all the instances along with their details.

```python
# List all the EC2 instances
response = ec2_client.describe_instances()

# Loop through the instances and print their recovery points
for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        print(f"Instance ID: {instance['InstanceId']}, Recovery point: {instance['RecoveryPoint']}")
```

4. **Check if the recovery point is created**: Finally, you can check if the recovery point is created for each instance. If the recovery point is not created, you can print a message indicating the same.

```python
# Check if the recovery point is created
for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        if 'RecoveryPoint' not in instance:
            print(f"No recovery point created for instance: {instance['InstanceId']}")
```

Please note that the above script assumes that you have the necessary permissions to list and describe the EC2 instances. Also, replace 'YOUR_ACCESS_KEY' and 'YOUR_SECRET_KEY' with your actual AWS access key and secret key.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of not having Storage Gateway Recovery Point created for AWS EC2 using the AWS console, follow these step-by-step instructions:

1. **Sign in to the AWS Management Console**: Go to https://aws.amazon.com/ and sign in to your AWS account.

2. **Navigate to AWS Storage Gateway**: Go to the AWS Management Console and search for "Storage Gateway" in the services search bar.

3. **Select your Storage Gateway**: In the Storage Gateway console, select the Storage Gateway that is associated with your EC2 instance.

4. **Create a Recovery Point**: Within the Storage Gateway console, navigate to the "Volumes" section and select the volume that is associated with your EC2 instance.

5. **Initiate a Snapshot**: In the volume details page, locate the option to create a recovery point or snapshot. Click on the "Create Snapshot" or "Create Recovery Point" button.

6. **Configure Snapshot settings**: Follow the on-screen instructions to configure the snapshot settings, such as the snapshot description, frequency, and retention period.

7. **Review and Confirm**: Review the snapshot settings to ensure they meet your requirements, then click on the "Create Snapshot" or "Create Recovery Point" button to initiate the snapshot creation process.

8. **Monitor Snapshot Creation**: Monitor the snapshot creation process in the Storage Gateway console. Once the snapshot is successfully created, you have now remediated the misconfiguration of not having a Storage Gateway Recovery Point created for your AWS EC2 instance.

By following these steps, you have successfully remediated the misconfiguration of not having a Storage Gateway Recovery Point created for your AWS EC2 instance using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of not having Storage Gateway Recovery Point created for AWS EC2 using AWS CLI, you can follow these steps:

1. **Install and Configure AWS CLI:**
   If you haven't already, install and configure the AWS Command Line Interface (CLI) on your local machine. You can refer to the official AWS documentation for instructions on how to do this.

2. **Enable Storage Gateway for EC2 Instance:**
   Ensure that the AWS Storage Gateway service is enabled for the specific EC2 instance that requires a Recovery Point. You can do this by navigating to the AWS Management Console, selecting the EC2 service, choosing the specific instance, and enabling the Storage Gateway service.

3. **Create a Recovery Point using AWS CLI:**
   Use the AWS CLI to create a Recovery Point for the Storage Gateway associated with the EC2 instance. You can use the following command to create a Recovery Point:
   
   ```bash
   aws storagegateway create-snapshot-from-volume-recovery-point --volume-arn <VOLUME_ARN>
   ```

   Replace `<VOLUME_ARN>` with the Amazon Resource Name (ARN) of the volume associated with the EC2 instance.

4. **Verify the Recovery Point:**
   After executing the command, verify that the Recovery Point has been successfully created by checking the AWS Storage Gateway console or by running the following command:
   
   ```bash
   aws storagegateway list-volume-recovery-points --gateway-arn <GATEWAY_ARN>
   ```
   
   Replace `<GATEWAY_ARN>` with the ARN of the Storage Gateway associated with the EC2 instance.

5. **Set up Automated Recovery Point Creation (Optional):**
   To ensure that Recovery Points are created regularly, you can set up a scheduled task or automation using AWS CloudWatch Events or AWS Lambda to trigger the creation of Recovery Points at specified intervals.

By following these steps, you can successfully remediate the misconfiguration of not having Storage Gateway Recovery Points created for the AWS EC2 instance using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of not having Storage Gateway recovery points created for AWS EC2 instances using Python, you can follow these steps:

1. Install the AWS SDK for Python (Boto3) by running the following command:
   ```
   pip install boto3
   ```

2. Create a Python script to automate the process of creating recovery points for the AWS Storage Gateway. Below is a sample script that you can use:

```python
import boto3

# Initialize the AWS service clients
client = boto3.client('storagegateway')

# Specify the Gateway ARN for the Storage Gateway that is associated with the EC2 instance
gateway_arn = 'YOUR_GATEWAY_ARN'

# Create a recovery point for the specified Gateway ARN
response = client.create_tape_recovery_point(
    GatewayARN=gateway_arn
)

# Print the response
print(response)
```

3. Replace `'YOUR_GATEWAY_ARN'` with the actual ARN of the Storage Gateway that is associated with the EC2 instance.

4. Run the Python script to create a recovery point for the specified Storage Gateway. This will ensure that recovery points are created for the EC2 instance.

By following these steps and running the Python script, you can remediate the misconfiguration of not having Storage Gateway recovery points created for AWS EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

