---
slug: backup_plan_min_retention_check
title: Backup Plan Should Have  Retention Period.
sidebar_label: Backup Plan Should Have  Retention Period.
---

### More Info:

This rule checks if a backup plan has a backup rule that satisfies the retention period. The rule is NON_COMPLIANT if recovery points are not created at least as often as the specified frequency or expire before the specified period.

### Risk Level

High

### Address

Configuration

### Compliance Standards

CBP,RBI_MD_ITF,RBI_UCB


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of not having a retention period in a Backup Plan for EC2 using the AWS Management Console, follow these steps:

1. **Navigate to AWS Backup Service:**
   - Open the AWS Management Console.
   - In the search bar, type "AWS Backup" and select the AWS Backup service from the list.

2. **Create or Modify a Backup Plan:**
   - If you are creating a new backup plan, click on "Create backup plan."
   - If you are modifying an existing backup plan, select the backup plan you want to modify from the list.

3. **Set Retention Rules:**
   - In the backup plan details, navigate to the "Backup rule" section.
   - Click on "Add backup rule" or edit an existing rule.
   - In the "Backup rule" settings, locate the "Lifecycle" section.
   - Set the "Transition to cold storage" and "Expire" options to define the retention period for your backups. Ensure that the "Expire" option is set to a value that meets your retention policy requirements.

4. **Save the Backup Plan:**
   - After configuring the retention period, review the settings.
   - Click on "Create plan" if you are creating a new plan or "Save changes" if you are modifying an existing plan.

By following these steps, you ensure that your EC2 backup plan has a defined retention period, preventing the misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not having a retention period in your AWS Backup Plan for EC2 using AWS CLI, follow these steps:

1. **Create a Backup Plan:**
   First, create a backup plan with a defined retention period. Use the `create-backup-plan` command to specify the backup rules, including the retention period.

   ```sh
   aws backup create-backup-plan --backup-plan '{
       "BackupPlanName": "MyBackupPlan",
       "Rules": [
           {
               "RuleName": "DailyBackup",
               "TargetBackupVaultName": "MyBackupVault",
               "ScheduleExpression": "cron(0 12 * * ? *)",
               "StartWindowMinutes": 60,
               "CompletionWindowMinutes": 180,
               "Lifecycle": {
                   "DeleteAfterDays": 30
               }
           }
       ]
   }'
   ```

2. **Assign Resources to the Backup Plan:**
   Assign the EC2 instances to the backup plan using the `create-backup-selection` command. This ensures that the specified resources are included in the backup plan.

   ```sh
   aws backup create-backup-selection --backup-plan-id <backup-plan-id> --backup-selection '{
       "SelectionName": "MyBackupSelection",
       "IamRoleArn": "arn:aws:iam::123456789012:role/service-role/AWSBackupDefaultServiceRole",
       "Resources": [
           "arn:aws:ec2:region:account-id:instance/instance-id"
       ]
   }'
   ```

3. **Verify the Backup Plan:**
   Verify that the backup plan has been created and includes the retention period by using the `get-backup-plan` command.

   ```sh
   aws backup get-backup-plan --backup-plan-id <backup-plan-id>
   ```

4. **Monitor Backup Jobs:**
   Regularly monitor the backup jobs to ensure they are running as expected and adhering to the retention period. Use the `list-backup-jobs` command to check the status of backup jobs.

   ```sh
   aws backup list-backup-jobs --by-backup-vault-name MyBackupVault
   ```

By following these steps, you can ensure that your AWS Backup Plan for EC2 instances includes a retention period, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not having a retention period in an EC2 Backup Plan using Python scripts, you can follow these steps:

1. **Install and Configure AWS SDK (Boto3):**
   Ensure you have the AWS SDK for Python (Boto3) installed and configured with the necessary permissions to manage AWS Backup plans.

   ```bash
   pip install boto3
   ```

2. **Create a Backup Plan with Retention Period:**
   Use Boto3 to create a backup plan that includes a retention period. This ensures that any new backup plan created will have a retention period set.

   ```python
   import boto3

   # Initialize a session using Amazon EC2
   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='YOUR_REGION'
   )

   # Initialize the Backup client
   backup_client = session.client('backup')

   # Define the backup plan with a retention period
   backup_plan = {
       'BackupPlanName': 'MyBackupPlan',
       'Rules': [
           {
               'RuleName': 'DailyBackup',
               'TargetBackupVaultName': 'Default',
               'ScheduleExpression': 'cron(0 12 * * ? *)',  # Daily at 12 PM UTC
               'StartWindowMinutes': 60,
               'CompletionWindowMinutes': 180,
               'Lifecycle': {
                   'DeleteAfterDays': 30  # Retention period of 30 days
               }
           }
       ]
   }

   # Create the backup plan
   response = backup_client.create_backup_plan(
       BackupPlan=backup_plan
   )

   print("Backup Plan Created with ID:", response['BackupPlanId'])
   ```

3. **Validate Existing Backup Plans:**
   Ensure that all existing backup plans have a retention period set. If not, update them to include a retention period.

   ```python
   # List all backup plans
   backup_plans = backup_client.list_backup_plans()

   for plan in backup_plans['BackupPlansList']:
       plan_id = plan['BackupPlanId']
       plan_details = backup_client.get_backup_plan(BackupPlanId=plan_id)
       
       for rule in plan_details['BackupPlan']['Rules']:
           if 'Lifecycle' not in rule or 'DeleteAfterDays' not in rule['Lifecycle']:
               # Update the rule to include a retention period
               rule['Lifecycle'] = {'DeleteAfterDays': 30}  # Set retention period to 30 days

       # Update the backup plan with the new rules
       backup_client.update_backup_plan(
           BackupPlanId=plan_id,
           BackupPlan=plan_details['BackupPlan']
       )

       print(f"Updated Backup Plan {plan_id} to include retention period.")
   ```

4. **Automate the Validation Process:**
   Schedule the validation script to run periodically (e.g., using AWS Lambda and CloudWatch Events) to ensure that all backup plans always have a retention period set.

   ```python
   import boto3

   def lambda_handler(event, context):
       session = boto3.Session()
       backup_client = session.client('backup')

       # List all backup plans
       backup_plans = backup_client.list_backup_plans()

       for plan in backup_plans['BackupPlansList']:
           plan_id = plan['BackupPlanId']
           plan_details = backup_client.get_backup_plan(BackupPlanId=plan_id)
           
           for rule in plan_details['BackupPlan']['Rules']:
               if 'Lifecycle' not in rule or 'DeleteAfterDays' not in rule['Lifecycle']:
                   # Update the rule to include a retention period
                   rule['Lifecycle'] = {'DeleteAfterDays': 30}  # Set retention period to 30 days

           # Update the backup plan with the new rules
           backup_client.update_backup_plan(
               BackupPlanId=plan_id,
               BackupPlan=plan_details['BackupPlan']
           )

           print(f"Updated Backup Plan {plan_id} to include retention period.")

   # To deploy this function, create an AWS Lambda function and set up a CloudWatch Event to trigger it periodically.
   ```

By following these steps, you can ensure that all EC2 backup plans have a retention period set, preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and open the AWS Backup dashboard.
2. In the navigation pane, choose "Backup plans".
3. In the list of backup plans, select the backup plan you want to check.
4. In the backup plan details page, look for the "Retention period" section. This section will show the duration for which the backup will be retained. If the retention period is not set or is less than the required duration, it indicates a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is set up, you can use the `describe-backup-jobs` command to list all the backup jobs. The command is as follows:

   ```
   aws backup describe-backup-jobs
   ```

   This command will return a list of backup jobs with their details.

3. To check the retention period of a specific backup plan, you can use the `get-backup-plan` command followed by the backup plan ID. The command is as follows:

   ```
   aws backup get-backup-plan --backup-plan-id <your-backup-plan-id>
   ```

   Replace `<your-backup-plan-id>` with the ID of your backup plan. This command will return the details of the backup plan including the retention period.

4. You can then parse the output to check the retention period. If the retention period is not set or is less than the recommended period, then it is a misconfiguration. You can use a Python script to automate this process. Here is a simple example:

   ```python
   import json
   import subprocess

   def check_retention_period():
       command = 'aws backup get-backup-plan --backup-plan-id <your-backup-plan-id>'
       process = subprocess.Popen(command, stdout=subprocess.PIPE, shell=True)
       output, error = process.communicate()

       if error:
           print(f'Error: {error}')
           return

       backup_plan = json.loads(output)

       if 'Lifecycle' in backup_plan['BackupPlan']:
           retention_period = backup_plan['BackupPlan']['Lifecycle']['DeleteAfterDays']
           if retention_period < recommended_period:
               print(f'Misconfiguration detected: Retention period is less than recommended period')
           else:
               print(f'No misconfiguration detected: Retention period is {retention_period} days')
       else:
           print('Misconfiguration detected: Retention period is not set')

   check_retention_period()
   ```

   Replace `<your-backup-plan-id>` and `recommended_period` with your backup plan ID and the recommended retention period respectively.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary AWS SDK for Python (Boto3) in your environment. Boto3 allows you to directly create, update, and delete AWS services from your Python scripts.

```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Use the `describe_snapshots` method to retrieve information about all the snapshots. 

```python
ec2 = session.client('ec2')
snapshots = ec2.describe_snapshots(OwnerIds=['self'])
```

4. Iterate over the snapshots and check the `StartTime` attribute. If the difference between the current time and the `StartTime` is more than the retention period, then the backup plan is misconfigured.

```python
from datetime import datetime, timedelta

retention_period = 30  # days
current_time = datetime.now()

for snapshot in snapshots['Snapshots']:
    if (current_time - snapshot['StartTime'].replace(tzinfo=None)).days > retention_period:
        print(f"Snapshot {snapshot['SnapshotId']} is older than retention period.")
```

This script will print out the IDs of all snapshots that are older than the specified retention period, indicating a misconfiguration in the backup plan.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of not having a retention period set for the backup plan in AWS EC2 using the AWS console, follow these steps:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/console/) and login using your credentials.

2. **Navigate to AWS Backup Service**: In the AWS Management Console, search for "Backup" in the services search bar and click on "Backup" under the "Storage" category.

3. **Select Backup Plans**: In the AWS Backup console, click on "Backup plans" in the left-hand navigation pane.

4. **Edit Backup Plan**: Find the backup plan that needs to have a retention period set and click on the plan name to select it.

5. **Add Retention Period**: In the details of the backup plan, locate the section where you can set the retention period. Click on the "Edit" button next to the retention settings.

6. **Set Retention Period**: Enter the desired retention period in days for the backups to be retained. This can vary depending on your organization's retention policies.

7. **Save Changes**: After setting the retention period, click on the "Save" or "Update" button to save the changes to the backup plan.

8. **Verify Configuration**: Double-check the backup plan details to ensure that the retention period has been successfully set.

By following these steps, you have successfully remediated the misconfiguration of not having a retention period set for the backup plan in AWS EC2 using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of not having a retention period set for the backup plan in AWS EC2 using AWS CLI, follow these steps:

1. **List Backup Plans**: First, list all the existing backup plans to identify the one that needs to be updated. You can use the following AWS CLI command:
   
   ```bash
   aws backup list-backup-plans
   ```

2. **Update Backup Plan**: Once you have identified the backup plan that needs to be updated, you can use the following AWS CLI command to update the backup plan with a retention period:

   ```bash
   aws backup update-backup-plan --backup-plan-id <backup-plan-id> --lifecycle ResourceType=EC2,DeleteAfterDays=<retention-period>
   ```

   Replace `<backup-plan-id>` with the ID of the backup plan that needs to be updated and `<retention-period>` with the number of days you want to retain the backups.

3. **Verify**: Finally, verify that the retention period has been set successfully by listing the details of the updated backup plan using the following AWS CLI command:

   ```bash
   aws backup get-backup-plan --backup-plan-id <backup-plan-id>
   ```

   This command will display the details of the backup plan, including the retention period for EC2 resources.

By following these steps, you can remediate the misconfiguration of not having a retention period set for the backup plan in AWS EC2 using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of not having a retention period set for the backup plan in AWS EC2 using Python, you can follow these steps:

1. Install the AWS SDK for Python (Boto3) if you haven't already. You can install it using pip:
   ```
   pip install boto3
   ```

2. Write a Python script to update the backup plan with the desired retention period. Here is an example script to set a retention period of 30 days for a backup plan in AWS EC2:

```python
import boto3

# Initialize the EC2 client
client = boto3.client('backup')

# Specify the Backup Plan Id for which you want to update the retention period
backup_plan_id = 'your_backup_plan_id_here'

# Specify the desired retention period in days
retention_period = 30

# Update the backup plan with the new retention period
response = client.update_backup_plan(
    BackupPlanId=backup_plan_id,
    BackupPlan={
        'BackupPlanName': 'YourBackupPlanName',
        'Rules': [
            {
                'RuleName': 'DefaultBackupRule',
                'TargetBackupVaultName': 'Default',
                'ScheduleExpression': 'cron(0 0 * * ? *)',
                'StartWindowMinutes': 60,
                'CompletionWindowMinutes': 60,
                'Lifecycle': {
                    'DeleteAfterDays': retention_period
                }
            }
        ]
    }
)

# Print the response
print(response)
```

3. Replace `'your_backup_plan_id_here'` with the actual Backup Plan Id that you want to update.

4. Replace `'YourBackupPlanName'` with the name of your backup plan.

5. Run the Python script to update the backup plan with the specified retention period.

After running this script, the backup plan in AWS EC2 will be updated with the specified retention period, ensuring that backups are retained for the desired duration.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

