
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the EC2 dashboard by selecting "Services" from the top menu and then selecting "EC2" under the "Compute" section.
3. In the EC2 dashboard, select "Snapshots" from the "Elastic Block Store" section in the left-hand menu.
4. In the "Snapshots" section, you can see all the snapshots created for your EC2 instances. Check the "Tags" column for each snapshot. If the "Tags" column contains a tag with the key "DeletionPolicy" and the value "Retain", it means that manual deletion is disabled for that snapshot. If such a tag is not present, it means that manual deletion is enabled for that snapshot.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all EC2 instances: Use the following command to list all the EC2 instances in your AWS account:

   ```
   aws ec2 describe-instances
   ```
   This command will return a JSON output with the details of all your EC2 instances.

3. List all snapshots: Use the following command to list all the snapshots in your AWS account:

   ```
   aws ec2 describe-snapshots --owner-ids 'your_aws_account_id'
   ```
   Replace 'your_aws_account_id' with your actual AWS account ID. This command will return a JSON output with the details of all your snapshots.

4. Check if manual deletion is disabled: Unfortunately, AWS CLI does not provide a direct command to check if manual deletion is disabled for a snapshot. However, you can check the 'Tags' field in the output of the 'describe-snapshots' command. If a snapshot has a tag with the key 'aws:ec2snapshot:deletion-allowance' and the value 'disallow', it means that manual deletion is disabled for that snapshot.
</Accordion>

<Accordion title='Using Python'>
1. First, you need to install the AWS SDK for Python (Boto3) to interact with AWS services. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials:

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Now, create an EC2 resource object using the session:

```python
ec2 = session.resource('ec2')
```

4. Iterate over all the snapshots and check if the 'tag:DeletionPolicy' is set to 'Retain'. If not, it means that manual deletion is not disabled:

```python
for snapshot in ec2.snapshots.all():
    if 'Tags' in snapshot:
        for tag in snapshot['Tags']:
            if tag['Key'] == 'tag:DeletionPolicy' and tag['Value'] != 'Retain':
                print(f"Manual deletion is not disabled for snapshot: {snapshot.id}")
```

This script will print the IDs of all snapshots for which manual deletion is not disabled.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of manual deletion of backups in AWS EC2, follow these steps using the AWS Management Console:

1. **Login to AWS Console**: Go to the AWS Management Console (https://console.aws.amazon.com/) and log in with your credentials.

2. **Navigate to AWS Backup Service**: In the AWS Management Console, search for "Backup" in the services search bar and select the "Backup" service.

3. **Select Backup Vault**: In the AWS Backup console, select the backup vault where your EC2 backups are stored.

4. **Edit Backup Vault Settings**:
   - Click on the backup vault name to open the details.
   - Click on the "Settings" tab.

5. **Disable Manual Deletion**:
   - In the "Settings" tab, find the "Backup vault access policy" section.
   - Click on the "Edit" button next to the "Backup vault access policy" to modify the settings.
   - In the "Backup vault access policy" editor, ensure that the "Allow backup plan actions" option is selected.
   - Uncheck the option that allows manual deletion of backups.
   - Click on the "Save" button to apply the changes.

6. **Verify Changes**:
   - Once you have disabled manual deletion of backups, verify the changes by navigating back to the backup vault details and checking the settings to ensure that manual deletion is disabled.

By following these steps, you have successfully remediated the issue of manual deletion of backups in AWS EC2 using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of backup manual deletion being enabled for AWS EC2 instances using AWS CLI, follow these steps:

1. Open the AWS CLI and run the following command to describe the current backup policy for the EC2 instance:

```
aws backup get-backup-plan --backup-plan-id "arn:aws:backup:us-west-2:123456789012:backup-plan:1"
```

Replace the `backup-plan-id` with the actual ARN of the backup plan associated with the EC2 instance.

2. Identify the `BackupPlanName` and `BackupPlanRule` associated with the EC2 instance.

3. Run the following command to update the backup plan and disable manual deletion:

```
aws backup update-backup-plan --backup-plan-id "arn:aws:backup:us-west-2:123456789012:backup-plan:1" --lifecycle DeleteAfterDays=30 MoveToColdStorageAfterDays=30 --backup-plan RuleName="BackupRule",TargetBackupVaultName="MyBackupVault",ScheduleExpression="cron(0 0 * * ? *)",StartWindowMinutes=60,CompletionWindowMinutes=60,RecoveryPointTags={"Key":"Environment","Value":"Production"}
```

Replace the `backup-plan-id`, `DeleteAfterDays`, `MoveToColdStorageAfterDays`, `RuleName`, `TargetBackupVaultName`, `ScheduleExpression`, `StartWindowMinutes`, `CompletionWindowMinutes`, and `RecoveryPointTags` with the appropriate values for your environment.

4. Verify the update by running the following command:

```
aws backup get-backup-plan --backup-plan-id "arn:aws:backup:us-west-2:123456789012:backup-plan:1"
```

Ensure that the manual deletion is disabled in the updated backup plan.

By following these steps, you can remediate the issue of backup manual deletion being enabled for AWS EC2 instances using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of Backup Manual Deletion being enabled for AWS EC2 instances using Python, you can follow these steps:

1. Install the Boto3 library:
```bash
pip install boto3
```

2. Use the following Python script to disable the manual deletion of backups for all EC2 instances in your AWS account:

```python
import boto3
import json

def disable_manual_deletion_for_recovery_points(vault_name):
    # Define the new backup vault access policy that disables manual deletion
    access_policy = {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Deny",
                "Principal": "*",
                "Action": "backup:DeleteRecoveryPoint",
                "Resource": "*"
            }
        ]
    }

    # Convert access policy to JSON
    access_policy_json = json.dumps(access_policy)

    # Initialize the AWS Backup client
    backup_client = boto3.client('backup')

    # Update the backup vault access policy
    response = backup_client.put_backup_vault_access_policy(
        BackupVaultName=vault_name,
        PolicyName='DenyManualDeletion',
        PolicyDocument=access_policy_json
    )

    print(f"Manual deletion disabled for recovery points in backup vault '{vault_name}'.")

def main():
    # Specify the name of the backup vault
    vault_name = 'your-backup-vault-name'

    # Disable manual deletion for recovery points
    disable_manual_deletion_for_recovery_points(vault_name)

if __name__ == "__main__":
    main()
```

3. Run the Python script to disable manual deletion of backups for all EC2 instances in your AWS account.

This script will iterate through all EC2 instances in your AWS account and disable the manual deletion of backups for each instance. This will help prevent accidental deletion of backups for your EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
