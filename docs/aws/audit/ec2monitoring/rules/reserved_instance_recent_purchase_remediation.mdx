
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the EC2 dashboard, click on "Reserved Instances" in the left-hand navigation pane.
3. Here, you will see a list of all your reserved instances. Review the "Purchase Date" column to see when each reserved instance was purchased.
4. If there are any recent purchases that you do not recognize or that seem suspicious, you should investigate further. This could involve checking with the person who made the purchase, reviewing your AWS usage and cost reports, or contacting AWS support.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure to configure it with the necessary access keys and region.

2. Once the AWS CLI is set up, you can use the `describe-reserved-instances` command to list all your reserved instances. The command is as follows:

   ```
   aws ec2 describe-reserved-instances
   ```

3. This command will return a JSON output with all the details of your reserved instances. You can review this output to check the recent purchases. Look for the "Start" field in the output which indicates the date and time the Reserved Instance was purchased.

4. If you want to filter out the instances purchased within a specific time frame, you can use the `--query` option with the `describe-reserved-instances` command. For example, to list all the instances purchased in the last 30 days, you can use the following command:

   ```
   aws ec2 describe-reserved-instances --query "ReservedInstances[?Start>=`date -v-30d`]"
   ```
   
   Please note that the date command used in the query is specific to Unix-like systems. You might need to adjust it according to your operating system.
</Accordion>

<Accordion title='Using Python'>
1. **Setup AWS SDK (Boto3) in Python Environment:**
   First, you need to set up the AWS SDK (Boto3) in your Python environment. You can install it using pip:
   ```
   pip install boto3
   ```
   After installing boto3, configure your AWS credentials either by setting up environment variables or by using the AWS CLI.

2. **Create a Python Script to Fetch EC2 Reserved Instances:**
   You can use the `describe_reserved_instances` method provided by the EC2 client in boto3 to fetch all the reserved instances. Here is a sample script:

   ```python
   import boto3

   def fetch_reserved_instances():
       ec2_client = boto3.client('ec2')
       response = ec2_client.describe_reserved_instances()
       return response['ReservedInstances']

   reserved_instances = fetch_reserved_instances()
   for instance in reserved_instances:
       print(instance)
   ```
   This script will print all the reserved instances along with their details.

3. **Filter Recent Purchases:**
   The response from `describe_reserved_instances` includes a `Start` field which indicates the time at which the reservation started. You can use this field to filter out the recent purchases. Here is how you can modify the above script to do this:

   ```python
   from datetime import datetime, timedelta
   import boto3

   def fetch_recent_reserved_instances(days):
       ec2_client = boto3.client('ec2')
       response = ec2_client.describe_reserved_instances()
       recent_instances = []
       for instance in response['ReservedInstances']:
           start_time = instance['Start']
           if start_time > datetime.now() - timedelta(days=days):
               recent_instances.append(instance)
       return recent_instances

   recent_instances = fetch_recent_reserved_instances(30)
   for instance in recent_instances:
       print(instance)
   ```
   This script will print all the reserved instances purchased in the last 30 days.

4. **Review the Recent Purchases:**
   Now that you have the recent purchases, you can review them based on your requirements. For example, you might want to check if the instance type matches your standard instance type, or if the instance is in the correct region. You can add these checks in the `fetch_recent_reserved_instances` function.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Here are the step-by-step instructions to remediate the "EC2 Reserved Instances Recent Purchases Should Be Reviewed" misconfiguration in AWS using the AWS console:

1. Login to your AWS account and go to the AWS EC2 console.
2. Click on the "Reserved Instances" link in the left-hand navigation menu.
3. Review the list of recently purchased reserved instances to identify any that were purchased in error or are no longer needed.
4. Select the reserved instances that need to be modified or cancelled.
5. Click on the "Actions" button and select "Modify Reserved Instances" or "Cancel Reserved Instances" depending on the action you want to take.
6. Follow the prompts to modify or cancel the selected reserved instances.
7. After making the necessary changes, review the list of reserved instances again to ensure that all recent purchases have been reviewed and remediated.

By following these steps, you can remediate the "EC2 Reserved Instances Recent Purchases Should Be Reviewed" misconfiguration in AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
The EC2 Reserved Instances Recent Purchases Should Be Reviewed misconfiguration can be remediated in AWS using the following steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all active Reserved Instances:

```
aws ec2 describe-reserved-instances --filters "Name=state,Values=active"
```

3. Review the output of the above command and identify any recently purchased Reserved Instances that are not being utilized.

4. Run the following command to modify or cancel the unused Reserved Instances:

```
aws ec2 modify-reserved-instances --reserved-instances-id <ID> --target-configuration "InstanceCount=<COUNT>,OfferingId=<OFFERING_ID>"
```

Note: Replace `<ID>` with the Reserved Instance ID and `<COUNT>` with the desired instance count. `<OFFERING_ID>` can be obtained from the Reserved Instance description.

5. Alternatively, to cancel the unused Reserved Instances, run the following command:

```
aws ec2 cancel-reserved-instances-listings --reserved-instances-listing-ids <ID>
```

Note: Replace `<ID>` with the Reserved Instance Listing ID.

6. Repeat step 4 and 5 for all unused Reserved Instances.

7. Finally, run the following command to verify that all unused Reserved Instances have been modified or cancelled:

```
aws ec2 describe-reserved-instances --filters "Name=state,Values=active"
```

This should remediate the EC2 Reserved Instances Recent Purchases Should Be Reviewed misconfiguration in AWS.
</Accordion>

<Accordion title='Using Python'>
The misconfiguration "EC2 Reserved Instances Recent Purchases Should Be Reviewed" typically refers to a situation where an AWS account has recently purchased EC2 Reserved Instances, but they are not being fully utilized. To remediate this, you can use the following steps:

1. Identify the underutilized EC2 Reserved Instances using the AWS SDK for Python (boto3) by calling the `describe_reserved_instances()` method of the EC2 client object. This method returns information about the specified Reserved Instances, including the number of instances that are currently in use.

```python
import boto3

ec2_client = boto3.client('ec2')

reserved_instances = ec2_client.describe_reserved_instances()
```

2. Filter the results to only include Reserved Instances that are not being fully utilized. You can do this by comparing the `InstanceCount` attribute to the `InstanceCount` attribute of the `State` object for each Reserved Instance.

```python
underutilized_instances = []

for reserved_instance in reserved_instances['ReservedInstances']:
    state = ec2_client.describe_reserved_instances_modifications(
        ReservedInstancesModificationIds=[reserved_instance['ReservedInstancesId']]
    )['ReservedInstancesModifications'][0]['TargetConfigurations'][0]['ReservedInstancesConfiguration']['Scope']

    if reserved_instance['InstanceCount'] > state['InstanceCount']:
        underutilized_instances.append(reserved_instance)
```

3. Review the list of underutilized EC2 Reserved Instances and take appropriate action. This could include modifying the instance type or family to better match your workload, or selling the underutilized Reserved Instances on the Reserved Instance Marketplace.

```python
for instance in underutilized_instances:
    print(f"Underutilized EC2 Reserved Instance: {instance['ReservedInstancesId']}")
```

By following these steps, you can identify and remediate underutilized EC2 Reserved Instances in your AWS account using Python and the boto3 SDK.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
