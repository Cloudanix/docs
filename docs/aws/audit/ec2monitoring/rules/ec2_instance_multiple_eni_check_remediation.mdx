
### Triage and Remediation
<Tabs>




<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 instances from using multiple Elastic Network Interfaces (ENIs) in AWS using the AWS Management Console, follow these steps:

1. **Review and Modify Instance Launch Configurations:**
   - Navigate to the **EC2 Dashboard** in the AWS Management Console.
   - Click on **Launch Instance**.
   - In the **Network settings** section, ensure that only one network interface is configured. Remove any additional network interfaces if present.

2. **Set Up IAM Policies:**
   - Go to the **IAM Dashboard**.
   - Click on **Policies** and then **Create policy**.
   - Use the JSON editor to create a policy that restricts the creation of multiple ENIs. For example:
     ```json
     {
       "Version": "2012-10-17",
       "Statement": [
         {
           "Effect": "Deny",
           "Action": "ec2:CreateNetworkInterface",
           "Resource": "*"
         }
       ]
     }
     ```
   - Attach this policy to the IAM roles or users who manage EC2 instances.

3. **Configure AWS Config Rules:**
   - Navigate to the **AWS Config** service in the AWS Management Console.
   - Click on **Rules** and then **Add rule**.
   - Search for and select the **ec2-instance-no-multiple-eni** managed rule (if available) or create a custom rule to check for instances with multiple ENIs.
   - Set the rule to trigger evaluations and notify you of non-compliant resources.

4. **Monitor and Audit Using CloudWatch:**
   - Go to the **CloudWatch** service in the AWS Management Console.
   - Set up **Alarms** and **Logs** to monitor the creation of additional ENIs.
   - Create a CloudWatch alarm that triggers when an EC2 instance with multiple ENIs is detected, and set up notifications to alert the appropriate personnel.

By following these steps, you can effectively prevent EC2 instances from using multiple Elastic Network Interfaces through the AWS Management Console.
</Accordion>

<Accordion title='Using CLI'>
To prevent EC2 instances from using multiple Elastic Network Interfaces (ENIs) using AWS CLI, you can follow these steps:

1. **Create a Launch Template with a Single ENI Configuration:**
   Ensure that your EC2 instances are launched with a template that specifies only one ENI. This can be done by creating a launch template with the desired configuration.

   ```sh
   aws ec2 create-launch-template --launch-template-name MySingleENITemplate --version-description "Single ENI Template" --launch-template-data '{"NetworkInterfaces":[{"DeviceIndex":0,"AssociatePublicIpAddress":true}]}'
   ```

2. **Use IAM Policies to Restrict ENI Creation:**
   Create an IAM policy that restricts the creation of additional ENIs. Attach this policy to the IAM roles or users that manage EC2 instances.

   ```sh
   aws iam create-policy --policy-name RestrictENICreation --policy-document '{
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Deny",
               "Action": "ec2:CreateNetworkInterface",
               "Resource": "*"
           }
       ]
   }'
   ```

3. **Launch Instances Using the Template:**
   Ensure that all new EC2 instances are launched using the launch template created in step 1, which enforces the single ENI configuration.

   ```sh
   aws ec2 run-instances --launch-template LaunchTemplateName=MySingleENITemplate,Version=1 --count 1 --instance-type t2.micro
   ```

4. **Monitor and Enforce Compliance:**
   Regularly monitor your EC2 instances to ensure compliance with the single ENI policy. You can use AWS Config rules or custom scripts to check for instances with multiple ENIs and take corrective actions if necessary.

   ```sh
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,NetworkInterfaces]' --output table
   ```

By following these steps, you can prevent EC2 instances from using multiple Elastic Network Interfaces using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent EC2 instances from using multiple Elastic Network Interfaces (ENIs) using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   Ensure you have the AWS SDK for Python (Boto3) installed. If not, you can install it using pip:
   ```bash
   pip install boto3
   ```

2. **Create a Python Script to Describe EC2 Instances:**
   Use Boto3 to describe EC2 instances and check the number of ENIs attached to each instance. If an instance has more than one ENI, you can log it or take appropriate action.

   ```python
   import boto3

   # Initialize a session using Amazon EC2
   ec2 = boto3.client('ec2')

   # Describe all instances
   response = ec2.describe_instances()

   # Iterate over each instance
   for reservation in response['Reservations']:
       for instance in reservation['Instances']:
           instance_id = instance['InstanceId']
           network_interfaces = instance['NetworkInterfaces']
           
           # Check the number of ENIs
           if len(network_interfaces) > 1:
               print(f"Instance {instance_id} has multiple ENIs.")
               # Take appropriate action here (e.g., log, alert, etc.)
   ```

3. **Automate the Script Execution:**
   Schedule the script to run at regular intervals using a cron job (Linux) or Task Scheduler (Windows) to continuously monitor and prevent instances from having multiple ENIs.

   Example of a cron job entry to run the script every hour:
   ```bash
   0 * * * * /usr/bin/python3 /path/to/your/script.py
   ```

4. **Implement Preventive Measures:**
   To prevent the creation of instances with multiple ENIs, you can use AWS Config rules or AWS Lambda functions triggered by CloudWatch Events to enforce this policy. However, since the focus is on Python scripts, you can create a Lambda function using Boto3 to terminate or detach additional ENIs when detected.

   Example of a Lambda function to detach additional ENIs:
   ```python
   import boto3

   def lambda_handler(event, context):
       ec2 = boto3.client('ec2')
       response = ec2.describe_instances()

       for reservation in response['Reservations']:
           for instance in reservation['Instances']:
               instance_id = instance['InstanceId']
               network_interfaces = instance['NetworkInterfaces']
               
               if len(network_interfaces) > 1:
                   for eni in network_interfaces[1:]:
                       eni_id = eni['NetworkInterfaceId']
                       ec2.detach_network_interface(AttachmentId=eni['Attachment']['AttachmentId'])
                       print(f"Detached ENI {eni_id} from instance {instance_id}.")
   ```

By following these steps, you can effectively prevent EC2 instances from using multiple Elastic Network Interfaces using Python scripts.
</Accordion>
</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.

2. In the navigation pane, choose 'Network Interfaces' under the 'Network & Security' section.

3. In the 'Network Interfaces' page, you can see all the Elastic Network Interfaces (ENIs) associated with your EC2 instances. 

4. To check if an EC2 instance uses multiple ENIs, you can filter the list by the 'Attachment' column. If an instance ID appears more than once, it means that the EC2 instance is using multiple ENIs.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all EC2 instances: Use the following command to list all the EC2 instances in your AWS account.

   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text
   ```

3. For each instance, check the number of attached ENIs: For each instance ID obtained from the previous step, run the following command to get the number of attached Elastic Network Interfaces (ENIs).

   ```
   aws ec2 describe-network-interfaces --filters Name=attachment.instance-id,Values=<instance-id> --query 'NetworkInterfaces[*].[NetworkInterfaceId]' --output text
   ```

   Replace `<instance-id>` with the actual instance ID.

4. Analyze the output: If the output from the previous step shows more than one ENI for any instance, it means that the EC2 instance is using multiple Elastic Network Interfaces.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3, AWS EC2, AWS DynamoDB, and much more. To install it, you can use pip:

   ```bash
   pip install boto3
   ```
   Then, configure it with your user credentials.

2. Import the necessary modules and establish a session with AWS:

   ```python
   import boto3
   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='us-west-2'
   )
   ```
   Replace 'YOUR_ACCESS_KEY' and 'YOUR_SECRET_KEY' with your actual AWS access key and secret key.

3. Create an EC2 resource object using the AWS SDK for Python (Boto3). This object will allow you to interact with your EC2 instances:

   ```python
   ec2_resource = session.resource('ec2')
   ```

4. Now, iterate over all your EC2 instances and check the number of attached network interfaces. If an instance has more than one network interface, print a message:

   ```python
   for instance in ec2_resource.instances.all():
       interfaces = list(instance.network_interfaces)
       if len(interfaces) > 1:
           print(f"Instance {instance.id} has multiple ({len(interfaces)}) network interfaces.")
   ```
   This script will print out the IDs of all EC2 instances that have more than one network interface attached.
</Accordion>
</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of an EC2 instance using multiple Elastic Network Interfaces (ENIs) in AWS, you can follow these steps using the AWS Management Console:

1. **Identify the EC2 Instance**:
   - Log in to your AWS Management Console.
   - Go to the EC2 dashboard.
   - Identify the EC2 instance that is using multiple ENIs.

2. **Detach Unnecessary ENIs**:
   - Select the EC2 instance that is using multiple ENIs.
   - In the Description tab, under Network interfaces, you will see the list of attached ENIs.
   - Identify the additional ENIs that are not required for the instance.
   - Select the unnecessary ENIs one by one and click on the "Actions" dropdown.
   - From the dropdown, select "Detach network interface".
   - Confirm the action to detach the ENI from the EC2 instance.

3. **Delete Unnecessary ENIs** (Optional):
   - If the ENIs are no longer needed in your account, you can also choose to delete them.
   - Go to the EC2 dashboard and select "Network Interfaces" from the left-hand menu.
   - Identify the unnecessary ENIs and select them.
   - Click on the "Actions" dropdown and choose "Delete network interface".
   - Confirm the action to delete the ENI.

4. **Verify Configuration**:
   - After detaching or deleting the unnecessary ENIs, go back to the EC2 instance Description tab.
   - Ensure that the EC2 instance is now using only the required ENI.

5. **Update Security Groups and Route Tables** (if necessary):
   - If the ENIs that were detached had specific security group rules or were associated with custom route tables, make sure to update the security groups and route tables associated with the remaining ENI to ensure connectivity and proper network routing.

By following these steps, you should be able to remediate the issue of an EC2 instance using multiple Elastic Network Interfaces in AWS and ensure that it is using only the necessary ENIs.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of an EC2 instance using multiple Elastic Network Interfaces (ENIs) in AWS using the AWS CLI, you can follow these steps:

Step 1: List all the instances with multiple ENIs
```
aws ec2 describe-instances --query 'Reservations[*].Instances[?length(NetworkInterfaces) > `1`].[InstanceId,NetworkInterfaces[*].NetworkInterfaceId]' --output table
```

Step 2: Identify the instance you want to work on based on the InstanceId.

Step 3: Detach the additional ENIs from the instance
```
aws ec2 detach-network-interface --attachment-id <AttachmentID>
```
Replace `<AttachmentID>` with the attachment ID of the additional ENI you want to detach.

Step 4: Verify that the additional ENIs have been detached successfully
```
aws ec2 describe-instances --instance-ids <InstanceId> --query 'Reservations[*].Instances[*].NetworkInterfaces[*].NetworkInterfaceId' --output table
```
Replace `<InstanceId>` with the InstanceId of the instance you worked on.

Step 5: If the issue persists, you may need to stop and start the instance for the changes to take effect.
```
aws ec2 stop-instances --instance-ids <InstanceId>
aws ec2 start-instances --instance-ids <InstanceId>
```

By following these steps, you can remediate the issue of an EC2 instance using multiple Elastic Network Interfaces in AWS using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of an EC2 instance using multiple Elastic Network Interfaces (ENIs) in AWS using Python, you can follow these steps:

1. **Identify the EC2 instances with multiple ENIs**: Use the AWS SDK for Python (Boto3) to list all EC2 instances in your account and identify instances with more than one ENI attached.

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_instances()

for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        if len(instance['NetworkInterfaces']) > 1:
            print(f"Instance {instance['InstanceId']} has multiple ENIs attached.")
```

2. **Detach extra ENIs**: For instances identified with multiple ENIs, you can choose to detach the extra ENIs. Here's how you can do it:

```python
# Assuming instance_id is the ID of the instance with multiple ENIs
instance_id = 'your_instance_id_here'

response = ec2.describe_instances(InstanceIds=[instance_id])

for interface in response['Reservations'][0]['Instances'][0]['NetworkInterfaces'][1:]:
    interface_id = interface['NetworkInterfaceId']
    ec2.detach_network_interface(
        AttachmentId=interface['Attachment']['AttachmentId'],
        Force=True
    )
    print(f"Detached ENI {interface_id} from instance {instance_id}.")
```

3. **Verify the remediation**: After detaching the extra ENIs, verify that each EC2 instance has only one ENI attached.

```python
response = ec2.describe_instances()

for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        if len(instance['NetworkInterfaces']) > 1:
            print(f"Instance {instance['InstanceId']} still has multiple ENIs attached.")
        else:
            print(f"Instance {instance['InstanceId']} has only one ENI attached.")
```

By following these steps, you can use Python and Boto3 to identify EC2 instances with multiple ENIs attached and detach the extra ENIs to remediate the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
