---
slug: autoscaling_launch_config_hop_limit
title: Autoscaling Hop Limit Should Be Checked
sidebar_label: Autoscaling Hop Limit Should Be Checked
---

### More Info:

This rule checks the number of network hops that the metadata token can travel. This rule is NON_COMPLIANT if the Metadata response hop limit is greater than 1.

### Risk Level

Medium

### Address

Configuration

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and open the Amazon EC2 dashboard at https://console.aws.amazon.com/ec2/.

2. In the navigation pane, choose 'Auto Scaling groups'.

3. Select the Auto Scaling group that you want to check.

4. In the details pane, under 'Advanced configurations', look for 'Instance scale-in protection'. If it's enabled, it means that the Auto Scaling group has a hop limit.

5. Also, check the 'Scaling policies' tab. If there are multiple scaling policies in place, it could indicate a hop limit. 

Note: AWS Management Console does not provide a direct way to check the hop limit. The hop limit is a concept related to the number of times an Auto Scaling group scales in response to CloudWatch alarms. It's not a setting that you can directly view or modify. However, by checking the scaling policies and configurations, you can infer if a hop limit might be in place.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI by following the instructions provided in the official AWS documentation. Once installed, you can configure it by running the command `aws configure` and providing your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all Auto Scaling groups: Use the following AWS CLI command to list all the Auto Scaling groups in your AWS account:

   ```
   aws autoscaling describe-auto-scaling-groups
   ```

   This command will return a JSON output with the details of all the Auto Scaling groups.

3. Check the hop limit for each Auto Scaling group: In the JSON output, look for the `MaxInstanceLifetime` attribute for each Auto Scaling group. This attribute specifies the maximum amount of time, in seconds, that an instance can be in service. If this attribute is not present or its value is set to a very high number, it means that the hop limit is not properly configured.

4. Use a script to automate the process: If you have a large number of Auto Scaling groups, it might be more efficient to use a Python script to automate the process. You can use the `boto3` library, which is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, to interact with AWS services. Here is a simple script that lists all Auto Scaling groups and their hop limit:

   ```python
   import boto3

   # Create a client for the Auto Scaling service
   client = boto3.client('autoscaling')

   # List all Auto Scaling groups
   response = client.describe_auto_scaling_groups()

   # For each Auto Scaling group, print its name and hop limit
   for group in response['AutoScalingGroups']:
       print('Name:', group['AutoScalingGroupName'])
       print('Hop Limit:', group.get('MaxInstanceLifetime', 'Not set'))
   ```

   This script will print the name and hop limit of each Auto Scaling group. If the hop limit is not set, it will print "Not set".

#### Using Python

1. Install the necessary AWS SDK for Python (Boto3) if you haven't done so already. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials. Replace 'your_access_key', 'your_secret_key', and 'your_region' with your actual AWS credentials and the region you want to check.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='your_access_key',
    aws_secret_access_key='your_secret_key',
    region_name='your_region'
)
```

3. Now, create an EC2 resource object using the session you just created. Then, iterate over all your Auto Scaling groups and check the value of `MaxSize` attribute. If it's more than a certain limit (let's say 100), print a warning message.

```python
ec2_resource = session.resource('ec2')

for asg in ec2_resource.autoscaling_groups.all():
    if asg.MaxSize > 100:
        print(f"Warning: Auto Scaling group {asg.name} has a high MaxSize value: {asg.MaxSize}")
```

4. Run the script. If there are any Auto Scaling groups with a `MaxSize` value more than 100, you will see a warning message for each of them. This way, you can detect if the Autoscaling Hop Limit is not properly configured in your EC2 instances.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Autoscaling Hop Limit Should Be Checked" misconfiguration for AWS EC2 using the AWS console, follow these steps:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/console/) and login with your credentials.

2. **Navigate to EC2 Dashboard**: Click on the "Services" dropdown menu at the top left corner and select "EC2" under the Compute section.

3. **Select Auto Scaling Groups**: In the EC2 Dashboard, locate and click on "Auto Scaling Groups" from the navigation pane on the left.

4. **Select the Auto Scaling Group**: Identify the Auto Scaling Group that you want to remediate and click on its name to select it.

5. **Edit Auto Scaling Group**: In the Auto Scaling Group details page, click on the "Edit" button to modify the group settings.

6. **Configure Auto Scaling Group**: Scroll down to find the "Advanced Details" section and look for the "Instance Protection" settings.

7. **Enable Instance Protection**: In the "Instance Protection" settings, you should find an option related to "Autoscaling Hop Limit". Enable this option by checking the box or setting an appropriate value based on your requirements.

8. **Save Changes**: Once you have enabled the Autoscaling Hop Limit or set the appropriate value, scroll to the bottom of the page and click on the "Save" button to apply the changes.

9. **Verify Configuration**: After saving the changes, it is recommended to verify that the Autoscaling Hop Limit setting has been successfully applied. You can do this by checking the configuration details of the Auto Scaling Group.

By following these steps, you can remediate the "Autoscaling Hop Limit Should Be Checked" misconfiguration for AWS EC2 using the AWS console.

#### Using CLI

To remediate the misconfiguration of Autoscaling Hop Limit not being checked for AWS EC2 using AWS CLI, follow these steps:

1. Open your terminal or command prompt.

2. Run the following AWS CLI command to describe the Auto Scaling groups in your AWS account:
```
aws autoscaling describe-auto-scaling-groups
```

3. Identify the Auto Scaling group that you want to update with the Autoscaling Hop Limit.

4. Run the following AWS CLI command to update the Auto Scaling group with the Autoscaling Hop Limit:
```
aws autoscaling update-auto-scaling-group --auto-scaling-group-name <your-auto-scaling-group-name> --health-check-type ELB --health-check-grace-period 300
```
Replace `<your-auto-scaling-group-name>` with the actual name of your Auto Scaling group.

5. Verify that the Autoscaling Hop Limit has been successfully updated by running the following AWS CLI command:
```
aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names <your-auto-scaling-group-name> --query "AutoScalingGroups[].HealthCheckType"
```
Replace `<your-auto-scaling-group-name>` with the actual name of your Auto Scaling group.

6. Ensure that the output of the above command shows "ELB" as the HealthCheckType, which indicates that the Autoscaling Hop Limit has been successfully updated.

By following these steps, you can remediate the misconfiguration of Autoscaling Hop Limit not being checked for AWS EC2 using AWS CLI.

#### Using Python

To remediate the "Autoscaling Hop Limit Should Be Checked" misconfiguration for AWS EC2 using Python, you can use the AWS SDK for Python (Boto3) to update the Auto Scaling Group settings. Here are the step-by-step instructions:

1. Install Boto3:
```bash
pip install boto3
```

2. Use the following Python script to update the Auto Scaling Group settings to check the "Autoscaling Hop Limit":

```python
import boto3

# Initialize the Boto3 client for Auto Scaling
client = boto3.client('autoscaling')

# Specify the name of the Auto Scaling Group you want to update
auto_scaling_group_name = 'YOUR_AUTO_SCALING_GROUP_NAME'

# Update the Auto Scaling Group to check the "Autoscaling Hop Limit"
response = client.update_auto_scaling_group(
    AutoScalingGroupName=auto_scaling_group_name,
    NewInstancesProtectedFromScaleIn=True
)

print(f"Auto Scaling Group {auto_scaling_group_name} updated successfully to check Autoscaling Hop Limit.")
```

3. Replace `'YOUR_AUTO_SCALING_GROUP_NAME'` with the name of your Auto Scaling Group.

4. Run the Python script to update the Auto Scaling Group settings. This will enable the "Autoscaling Hop Limit" check for the specified Auto Scaling Group.

By following these steps, you can remediate the "Autoscaling Hop Limit Should Be Checked" misconfiguration for AWS EC2 using Python and Boto3.



</Tab>
</Tabs>