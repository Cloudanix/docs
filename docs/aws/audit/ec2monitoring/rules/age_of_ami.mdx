---
slug: age_of_ami
title: AMI Age Should Not Exceed the Configured Age
sidebar_label: AMI Age Should Not Exceed the Configured Age
---

### More Info:

Your AMI age should be more than configured number of days. This ensures that your EC2 instances deployed are secure and reliable.

### Risk Level

Low

### Address

Operational Maturity, Security, Reliability

### Compliance Standards

HITRUST, SOC2, NISTCSF, FedRAMP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "Images", click on "AMIs". This will display a list of all available AMIs.
3. For each AMI, check the "Creation Date" column. This will show the date when the AMI was created.
4. Compare the creation date with the current date to determine the age of the AMI. If the age exceeds the configured age, then it is a misconfiguration.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all AMIs: Use the `describe-images` command to list all AMIs. The command is as follows:

   ```
   aws ec2 describe-images --owners self
   ```

   This command will return a JSON output with details of all AMIs owned by the account.

3. Parse the output: You need to parse the output to get the creation date of each AMI. You can do this using the `jq` command-line JSON processor. The command is as follows:

   ```
   aws ec2 describe-images --owners self | jq -r '.Images[] | "\(.ImageId) \(.CreationDate)"'
   ```

   This command will return a list of AMIs along with their creation dates.

4. Check the age: Now, you need to check if the age of each AMI exceeds the configured age. You can do this by comparing the current date with the creation date of each AMI. You can use the `date` command to get the current date and then use the `diff` command to calculate the difference between the two dates. If the difference exceeds the configured age, then the AMI is too old.

#### Using Python

1. Import the necessary libraries: You will need the boto3 library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
from datetime import datetime, timedelta
```

2. Create a session using your AWS credentials. You can also use the AWS CLI's default session.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Now, create an EC2 resource object using the session. This object will allow you to interact with your EC2 instances.

```python
ec2_resource = session.resource('ec2')
```

4. Iterate over all the AMIs and check their creation date. If the creation date is older than the configured age, print the AMI ID.

```python
configured_age = 90  # in days
current_time = datetime.now()

for image in ec2_resource.images.filter(Owners=['self']):
    creation_time = image.creation_date  # returns a string in ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ
    creation_time = datetime.strptime(creation_time, "%Y-%m-%dT%H:%M:%S.%fZ")  # convert to datetime object
    ami_age = (current_time - creation_time).days
    if ami_age > configured_age:
        print(f"AMI {image.id} is {ami_age} days old, which exceeds the configured age of {configured_age} days.")
```

This script will print out the IDs of all AMIs that are older than the configured age.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

The AMI age should not exceed the configured age is a common misconfiguration in AWS. You can remediate this issue by following the below steps:

1. Log in to your AWS Management Console.
2. Go to the EC2 Dashboard.
3. Click on the "AMIs" option from the left-hand navigation panel.
4. Identify the AMI which has exceeded the configured age.
5. Select the AMI and click on the "Actions" button.
6. Choose the "Deregister" option from the drop-down list.
7. Confirm the deregistration by clicking on the "Deregister" button in the confirmation dialog box.
8. Once the AMI is deregistered, you can create a new AMI with the latest updates and configurations.

By following these steps, you can remediate the AMI age misconfiguration in AWS.

#### Using CLI

To remediate the "AMI Age Should Not Exceed the Configured Age" misconfiguration in AWS, you can follow the below steps using AWS CLI:

1. First, identify the AMIs that have exceeded the configured age by running the below command:

   ```
   aws ec2 describe-images --owners self --query 'Images[?CreationDate<=`<configured_age>`].[ImageId,CreationDate]' --output text
   ```

   Note: Replace `<configured_age>` with the age limit in the format `yyyy-mm-dd`.

2. Once you have identified the AMIs, you can deregister them using the below command:

   ```
   aws ec2 deregister-image --image-id <image_id>
   ```

   Note: Replace `<image_id>` with the ID of the AMI that you want to deregister.

3. Finally, to automate this process, you can create a Lambda function that runs the above commands on a scheduled basis to ensure that AMIs do not exceed the configured age limit.

#### Using Python

To remediate the AMI Age misconfiguration in AWS using Python, you can follow the steps below:

1. Identify the misconfigured AMIs by checking their age against the configured age.

2. Create a Lambda function in AWS that uses the Boto3 library to identify the misconfigured AMIs.

3. Use the EC2 client in Boto3 to get a list of all the AMIs in your AWS account.

4. Loop through the list of AMIs and check the age of each one against the configured age.

5. If an AMI is older than the configured age, deregister it using the EC2 client.

6. Set up a CloudWatch event to trigger the Lambda function at a regular interval to ensure that all misconfigured AMIs are remediated in a timely manner.

Here's some sample Python code that can be used to identify and deregister misconfigured AMIs:

```python
import boto3
from datetime import datetime, timedelta

# Set the configured age of AMIs in days
configured_age = 30

# Create an EC2 client
ec2 = boto3.client('ec2')

# Get a list of all the AMIs in the account
response = ec2.describe_images(Owners=['self'])

# Loop through the list of AMIs and check their age
for image in response['Images']:
    creation_date = datetime.strptime(image['CreationDate'], '%Y-%m-%dT%H:%M:%S.%fZ')
    age_in_days = (datetime.now() - creation_date).days
    if age_in_days > configured_age:
        # Deregister the AMI
        ec2.deregister_image(ImageId=image['ImageId'])
```

Note: This is just a sample code and it may need to be modified based on your specific requirements. Also, make sure to test the code thoroughly before running it in a production environment.

### Additional Reading:

- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) 
- [https://docs.aws.amazon.com/cli/latest/reference/ec2/describe-images.html](https://docs.aws.amazon.com/cli/latest/reference/ec2/describe-images.html) 


</Tab>
</Tabs>