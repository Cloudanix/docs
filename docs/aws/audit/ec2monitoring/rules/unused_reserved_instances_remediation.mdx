
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Reserved Instances from being unused in EC2 using the AWS Management Console, follow these steps:

1. **Monitor Reserved Instance Utilization:**
   - Navigate to the **AWS Management Console**.
   - Go to the **EC2 Dashboard**.
   - In the left-hand menu, select **Reserved Instances**.
   - Check the **Utilization Reports** to monitor the usage of your Reserved Instances. This will help you identify any underutilized or unused instances.

2. **Instance Matching:**
   - Ensure that your running instances match the specifications of your Reserved Instances (e.g., instance type, region, availability zone).
   - You can do this by comparing the details of your running instances under the **Instances** section with your Reserved Instances.

3. **Instance Reassignment:**
   - If you find that some Reserved Instances are not being utilized, consider reassigning workloads to match the Reserved Instance specifications.
   - You can stop and start instances to change their availability zone or instance type to match the Reserved Instances.

4. **Automated Alerts:**
   - Set up automated alerts using **Amazon CloudWatch** to notify you when Reserved Instances are underutilized.
   - Go to the **CloudWatch Dashboard**.
   - Create an alarm based on the metrics related to Reserved Instance utilization to receive notifications when utilization drops below a certain threshold.

By following these steps, you can proactively manage and ensure that your Reserved Instances are being utilized effectively.
</Accordion>

<Accordion title='Using CLI'>
To prevent Reserved Instances from being unused in EC2 using AWS CLI, you can follow these steps:

1. **Monitor Reserved Instances Utilization:**
   Regularly check the utilization of your Reserved Instances to ensure they are being used effectively.
   ```sh
   aws ce get-reservation-utilization --time-period Start=$(date -d '30 days ago' +%Y-%m-%d),End=$(date +%Y-%m-%d)
   ```

2. **List All Reserved Instances:**
   Retrieve a list of all your Reserved Instances to understand what you have reserved.
   ```sh
   aws ec2 describe-reserved-instances --filters Name=state,Values=active
   ```

3. **Match Reserved Instances with Running Instances:**
   Ensure that your running instances match the specifications of your Reserved Instances (e.g., instance type, region, availability zone).
   ```sh
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,InstanceType,Placement.AvailabilityZone]'
   ```

4. **Automate Monitoring and Alerts:**
   Set up automated monitoring and alerts to notify you when Reserved Instances are not being utilized.
   ```sh
   aws cloudwatch put-metric-alarm --alarm-name "UnusedReservedInstances" --metric-name "UnusedReservedInstances" --namespace "AWS/EC2" --statistic "Average" --period 86400 --threshold 1 --comparison-operator "GreaterThanOrEqualToThreshold" --evaluation-periods 1 --alarm-actions "arn:aws:sns:your-sns-topic-arn"
   ```

By following these steps, you can proactively monitor and ensure that your Reserved Instances are being utilized effectively, thereby preventing them from being unused.
</Accordion>

<Accordion title='Using Python'>
To prevent Reserved Instances from being unused in EC2 using Python scripts, you can follow these steps:

1. **Install and Configure AWS SDK (Boto3):**
   Ensure you have the AWS SDK for Python (Boto3) installed and configured with the necessary permissions to access EC2 and Reserved Instances.

   ```bash
   pip install boto3
   ```

   Configure your AWS credentials:

   ```bash
   aws configure
   ```

2. **List All Reserved Instances:**
   Use Boto3 to list all Reserved Instances and their states. This will help you identify which Reserved Instances are currently unused.

   ```python
   import boto3

   ec2_client = boto3.client('ec2')

   def list_reserved_instances():
       response = ec2_client.describe_reserved_instances(
           Filters=[
               {
                   'Name': 'state',
                   'Values': ['active']
               }
           ]
       )
       return response['ReservedInstances']

   reserved_instances = list_reserved_instances()
   for ri in reserved_instances:
       print(f"Reserved Instance ID: {ri['ReservedInstancesId']}, Instance Type: {ri['InstanceType']}, State: {ri['State']}")
   ```

3. **Check Usage of Reserved Instances:**
   Compare the Reserved Instances with the running instances to ensure they are being utilized. You can do this by listing all running instances and matching their instance types with the Reserved Instances.

   ```python
   def list_running_instances():
       response = ec2_client.describe_instances(
           Filters=[
               {
                   'Name': 'instance-state-name',
                   'Values': ['running']
               }
           ]
       )
       instances = []
       for reservation in response['Reservations']:
           for instance in reservation['Instances']:
               instances.append(instance)
       return instances

   running_instances = list_running_instances()
   running_instance_types = [instance['InstanceType'] for instance in running_instances]

   for ri in reserved_instances:
       if ri['InstanceType'] not in running_instance_types:
           print(f"Unused Reserved Instance: {ri['ReservedInstancesId']} of type {ri['InstanceType']}")
   ```

4. **Automate Notifications or Actions:**
   Set up automated notifications or actions if unused Reserved Instances are detected. For example, you can use AWS SNS to send notifications or take corrective actions like starting new instances that match the Reserved Instance types.

   ```python
   import boto3

   sns_client = boto3.client('sns')
   sns_topic_arn = 'arn:aws:sns:your-region:your-account-id:your-topic'

   def notify_unused_reserved_instance(ri):
       message = f"Unused Reserved Instance detected: {ri['ReservedInstancesId']} of type {ri['InstanceType']}"
       sns_client.publish(
           TopicArn=sns_topic_arn,
           Message=message,
           Subject='Unused Reserved Instance Alert'
       )

   for ri in reserved_instances:
       if ri['InstanceType'] not in running_instance_types:
           notify_unused_reserved_instance(ri)
   ```

By following these steps, you can automate the detection and notification of unused Reserved Instances in EC2 using Python scripts. This helps ensure that your Reserved Instances are being utilized effectively.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the EC2 dashboard by selecting "Services" from the top menu, then selecting "EC2" under the "Compute" category.
3. In the EC2 dashboard, select "Reserved Instances" from the left-hand menu. This will display a list of all your reserved instances.
4. Check the "State" column for each reserved instance. If the state is "active", it means the reserved instance is in use. If the state is "retired" or "expired", it means the reserved instance is not in use.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, AWS Secret Access Key, Default region name, and Default output format when prompted.

2. List all Reserved Instances: Use the following AWS CLI command to list all your Reserved Instances:

   ```
   aws ec2 describe-reserved-instances --query 'ReservedInstances[*].[ReservedInstancesId,State]' --output text
   ```
   This command will return a list of all your Reserved Instances along with their IDs and states. The state of a Reserved Instance can be either "active", "payment-pending", "payment-failed", "retired", or "queued-for-retirement".

3. List all Running Instances: Use the following AWS CLI command to list all your running instances:

   ```
   aws ec2 describe-instances --filters Name=instance-state-name,Values=running --query 'Reservations[*].Instances[*].[InstanceId]' --output text
   ```
   This command will return a list of all your running instances along with their IDs.

4. Compare the Lists: Now, you need to compare the list of Reserved Instances with the list of running instances. If a Reserved Instance is not in the list of running instances, it means that it is unused. You can do this comparison manually or you can write a script to do it for you.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3, AWS EC2, and others. You can install it using pip:

```python
pip install boto3
```
You also need to configure your AWS credentials. You can do this in several ways, but the simplest is to use the AWS CLI:

```bash
aws configure
```

2. Import the necessary libraries and establish a session with AWS:

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Use the EC2 client from the session to describe your reserved instances:

```python
ec2 = session.client('ec2')

response = ec2.describe_reserved_instances(
    Filters=[
        {
            'Name': 'state',
            'Values': [
                'active',
            ]
        },
    ]
)
```

4. Check if the reserved instances are being used:

```python
for reserved_instance in response['ReservedInstances']:
    instance_count = reserved_instance['InstanceCount']
    instance_type = reserved_instance['InstanceType']
    instance_state = reserved_instance['State']

    instances_response = ec2.describe_instances(
        Filters=[
            {
                'Name': 'instance-type',
                'Values': [
                    instance_type,
                ]
            },
            {
                'Name': 'instance-state-name',
                'Values': [
                    'running',
                ]
            },
        ]
    )

    running_instance_count = sum([len(reservation['Instances']) for reservation in instances_response['Reservations']])

    if running_instance_count < instance_count:
        print(f"Reserved instance {reserved_instance['ReservedInstancesId']} of type {instance_type} is not fully utilized. Running instances: {running_instance_count}, Reserved instances: {instance_count}")
```

This script will print out the IDs of the reserved instances that are not fully utilized.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of unused reserved instances in AWS, you can follow the below steps:

1. Log in to the AWS Management Console.
2. Navigate to the EC2 Dashboard.
3. Click on the "Reserved Instances" option from the left-hand menu.
4. Identify the unused reserved instances that need to be remediated.
5. Select the unused reserved instances that you want to modify.
6. Click on the "Actions" button and select "Modify Reserved Instances".
7. In the "Modify Reserved Instances" window, select the "Apply to" option and choose the instances that you want to apply the reserved instances to.
8. Click on the "Add to queue" button to add the modification to the queue.
9. Review the changes and click on the "Modify Reserved Instances" button to apply the changes.

Once the changes are applied, the unused reserved instances will be applied to the selected instances, and the misconfiguration of unused reserved instances will be remediated.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of unused reserved instances in AWS using AWS CLI, follow these steps:

1. Identify the unused reserved instances by running the following command:

   ```
   aws ec2 describe-reserved-instances --filters "Name=state,Values=active" "Name=instance-state-name,Values=stopped" --query "ReservedInstances[].{ID:ReservedInstancesId,Type:InstanceType,State:State,Count:InstanceCount,Start:Start,End:End}" --output table
   ```
   
   This command will list all the reserved instances that are in active state but not being used.

2. Once you have identified the unused reserved instances, you can either modify or delete them.

   To modify the unused reserved instances, you can change the instance type or the availability zone to match your current usage. To modify a reserved instance, run the following command:
   
   ```
   aws ec2 modify-reserved-instances --reserved-instances-id <reservation-id> --target-configuration InstanceCount=<new-count>,InstanceType=<new-type>,AvailabilityZone=<new-zone>
   ```
   
   Replace `<reservation-id>` with the ID of the unused reserved instance, `<new-count>` with the number of instances you want to reserve, `<new-type>` with the instance type you want to reserve, and `<new-zone>` with the availability zone you want to reserve the instance in.
   
   To delete the unused reserved instances, run the following command:
   
   ```
   aws ec2 cancel-reserved-instances-merchandise --reserved-instances-id <reservation-id>
   ```
   
   Replace `<reservation-id>` with the ID of the unused reserved instance you want to delete.
   
3. Verify that the unused reserved instances have been modified or deleted by running the command in step 1 again.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "Reserved Instances Should Not Be Unused" in AWS using python, follow these steps:

1. Identify the unused reserved instances in your AWS account. You can do this by using the AWS SDK for Python (boto3) to list all your reserved instances and their utilization status.

```python
import boto3

# Create an EC2 client
ec2 = boto3.client('ec2')

# List all the reserved instances
reserved_instances = ec2.describe_reserved_instances()

# Identify the unused reserved instances
unused_reserved_instances = []
for ri in reserved_instances['ReservedInstances']:
    if ri['State'] == 'active' and ri['InstanceCount'] > 0 and ri['InstanceCount'] == ri['AvailableInstanceCount']:
        unused_reserved_instances.append(ri['ReservedInstancesId'])
```

2. Once you have identified the unused reserved instances, you can either sell them on the AWS Reserved Instance Marketplace or exchange them for other instances that you need. To sell the unused reserved instances, you can use the AWS SDK for Python (boto3) to create a listing on the AWS Reserved Instance Marketplace.

```python
import boto3

# Create an EC2 client
ec2 = boto3.client('ec2')

# Create a listing for the unused reserved instances
response = ec2.create_reserved_instances_listing(
    ReservedInstancesId='YOUR_RESERVED_INSTANCE_ID',
    InstanceCount=1,
    PriceSchedules=[
        {
            'Term': 12,
            'Price': 1000.0,
            'CurrencyCode': 'USD'
        },
    ],
    ClientToken='YOUR_CLIENT_TOKEN'
)
```

3. If you want to exchange the unused reserved instances for other instances, you can use the AWS SDK for Python (boto3) to modify the reserved instances.

```python
import boto3

# Create an EC2 client
ec2 = boto3.client('ec2')

# Modify the unused reserved instances to exchange them for other instances
response = ec2.modify_reserved_instances(
    ReservedInstancesIds=[
        'YOUR_RESERVED_INSTANCE_ID',
    ],
    TargetConfigurations=[
        {
            'AvailabilityZone': 'us-west-2a',
            'InstanceCount': 1,
            'InstanceType': 't2.micro',
            'Platform': 'Linux/UNIX',
            'Scope': 'Availability Zone',
        },
    ]
)
```

By following these steps, you can remediate the misconfiguration "Reserved Instances Should Not Be Unused" in AWS using python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
