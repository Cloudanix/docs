---
slug: no_blacklisted_ami
title: Blacklisted AMIs Should Not Be Used
sidebar_label: Blacklisted AMIs Should Not Be Used
---

### More Info:

Blacklist all those AMI to prevent certain security issues to attack your application. Your EC2 Instances should not use any of the blacklisted AMIs.

### Risk Level

Low

### Address

Security, Operational Maturity

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console.
2. Navigate to the EC2 dashboard by selecting "Services" from the top menu, then selecting "EC2" under the "Compute" category.
3. In the EC2 dashboard, select "AMIs" from the "Images" section in the left-hand navigation pane.
4. In the AMIs page, you can see a list of all AMIs available for your account. Check the AMI IDs against your list of blacklisted AMIs. If any of the AMIs in the list match with the blacklisted AMIs, then those are being used in EC2.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the EC2 instances.

2. Once the AWS CLI is set up, you can list all the EC2 instances using the following command:

   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text
   ```
   This command will return a list of all the instance IDs.

3. Now, for each instance ID, you can get the AMI ID using the following command:

   ```
   aws ec2 describe-instances --instance-ids <instance-id> --query 'Reservations[*].Instances[*].[ImageId]' --output text
   ```
   Replace `<instance-id>` with the actual instance ID. This command will return the AMI ID of the instance.

4. Finally, you can check if the AMI ID is in your blacklist. This step depends on how you maintain your blacklist. If you have a text file with all the blacklisted AMI IDs, you can use the following command:

   ```
   grep -Fxq "<ami-id>" blacklist.txt
   ```
   Replace `<ami-id>` with the actual AMI ID. If the command returns nothing, the AMI ID is not in the blacklist. If the command returns the AMI ID, it is in the blacklist.
</Accordion>

<Accordion title='Using Python'>
1. **Import necessary libraries and establish a session**: To start with, you need to import the necessary libraries in your Python script. Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of AWS services like Amazon S3, Amazon EC2, etc. Here is how you can do it:

```python
import boto3
from botocore.exceptions import BotoCoreError, ClientError

# Create a session using your AWS credentials
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2' # or any other region
)
```

2. **Get the list of all EC2 instances**: Now, you need to get the list of all EC2 instances in your AWS account. You can do this using the `describe_instances()` function of the EC2 client in Boto3. Here is how you can do it:

```python
ec2 = session.client('ec2')

try:
    response = ec2.describe_instances()
except BotoCoreError as e:
    print(e)
```

3. **Check for blacklisted AMIs**: Now, you need to check if any of the EC2 instances are using blacklisted AMIs. You can do this by iterating over the instances and checking their `ImageId` against a list of blacklisted AMIs. Here is how you can do it:

```python
blacklisted_amis = ['ami-abc123', 'ami-def456'] # replace with your blacklisted AMIs

for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        if instance['ImageId'] in blacklisted_amis:
            print(f"Instance {instance['InstanceId']} is using blacklisted AMI {instance['ImageId']}")
```

4. **Handle exceptions**: It's a good practice to handle exceptions in your script. You can do this using the `try/except` block. In this case, you should handle `BotoCoreError` and `ClientError`, which are the common exceptions thrown by Boto3. Here is how you can do it:

```python
try:
    # your code here
except BotoCoreError as e:
    print(e)
except ClientError as e:
    print(e)
```

This script will print the IDs of all EC2 instances that are using blacklisted AMIs.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of blacklisted AMIs in AWS using AWS console, follow the steps below:

1. Log in to your AWS console.
2. Go to the EC2 dashboard.
3. Click on the "AMIs" option on the left-hand menu.
4. Identify the blacklisted AMIs from the list of available AMIs.
5. Select the blacklisted AMI that you want to remove.
6. Click on the "Actions" button and select "Deregister" from the drop-down menu.
7. Confirm the action by clicking on the "Deregister" button.
8. Once the AMI is deregistered, it will no longer be available for use.
9. Ensure that any instances using the blacklisted AMI are terminated and replaced with instances using approved AMIs.
10. Implement a process to regularly check and update the list of approved AMIs to prevent the use of blacklisted AMIs in the future.

By following the above steps, you can remediate the issue of blacklisted AMIs in AWS using AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of using blacklisted AMIs in AWS, you can follow the below steps using AWS CLI:

1. Identify the blacklisted AMIs in your AWS account. You can check the list of blacklisted AMIs on the AWS website.

2. Find all the instances that are using the blacklisted AMIs. You can use the following AWS CLI command to get the list of instances:

```
aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,ImageId]' --output text
```

This command will return a list of all the instances in your AWS account along with their AMI IDs.

3. Stop the instances that are using the blacklisted AMIs. You can use the following AWS CLI command to stop the instances:

```
aws ec2 stop-instances --instance-ids <instance-id-1> <instance-id-2> ... <instance-id-n>
```

Replace `<instance-id-1>`, `<instance-id-2>`, and so on with the instance IDs of the instances that are using the blacklisted AMIs.

4. Create a new instance using a non-blacklisted AMI. You can use the following AWS CLI command to launch a new instance:

```
aws ec2 run-instances --image-id <non-blacklisted-ami-id> --count 1 --instance-type <instance-type> --key-name <key-name> --security-group-ids <security-group-id> --subnet-id <subnet-id>
```

Replace `<non-blacklisted-ami-id>` with the ID of a non-blacklisted AMI, `<instance-type>` with the type of instance you want to launch, `<key-name>` with the name of the key pair you want to use to connect to the instance, `<security-group-id>` with the ID of the security group you want to use, and `<subnet-id>` with the ID of the subnet you want to launch the instance in.

5. Once the new instance is launched, you can transfer any data or configuration from the old instance to the new instance.

6. Finally, terminate the instances that were using the blacklisted AMIs. You can use the following AWS CLI command to terminate the instances:

```
aws ec2 terminate-instances --instance-ids <instance-id-1> <instance-id-2> ... <instance-id-n>
```

Replace `<instance-id-1>`, `<instance-id-2>`, and so on with the instance IDs of the instances that were using the blacklisted AMIs.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of using blacklisted AMIs in AWS using Python, follow these steps:

1. Define a list of blacklisted AMIs that you want to avoid using. You can get this list from multiple sources, such as AWS documentation or a security team.

```python
blacklisted_amis = ['ami-0123456789abcdef0', 'ami-0123456789abcdef1', 'ami-0123456789abcdef2']
```

2. Use the AWS SDK for Python (Boto3) to get a list of all the AMIs available in your AWS account.

```python
import boto3

ec2 = boto3.client('ec2')

all_amis = ec2.describe_images(Owners=['self'])['Images']
```

3. Loop through each AMI and check if it is blacklisted. If it is, deregister the AMI and delete its associated snapshots.

```python
for ami in all_amis:
    if ami['ImageId'] in blacklisted_amis:
        ec2.deregister_image(ImageId=ami['ImageId'])
        for block_device_mapping in ami['BlockDeviceMappings']:
            if 'Ebs' in block_device_mapping:
                snapshot_id = block_device_mapping['Ebs']['SnapshotId']
                ec2.delete_snapshot(SnapshotId=snapshot_id)
```

4. Optionally, you can also notify the appropriate team or individual about the remediation action.

```python
import boto3

sns = boto3.client('sns')

topic_arn = 'arn:aws:sns:us-east-1:123456789012:Blacklisted_AMIs'

message = 'The following blacklisted AMIs have been deregistered and their associated snapshots have been deleted: {}'.format(blacklisted_amis)

sns.publish(TopicArn=topic_arn, Message=message)
```

Note: Make sure you have appropriate permissions to perform these actions in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html) 

