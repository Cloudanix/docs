---
slug: storagegateway_resources_protected_by_backup_plan
title: Storage Gateway Volumes Should Have Backup Plan
sidebar_label: Storage Gateway Volumes Should Have Backup Plan
---

### More Info:

This rule checks if AWS Storage Gateway volumes are protected by a backup plan. The rule is NON_COMPLIANT if the Storage Gateway volume is not covered by a backup plan.

### Risk Level

High

### Address

Configuration

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the EC2 Dashboard by selecting "Services" from the top menu, then selecting "EC2" under the "Compute" category.
3. In the EC2 Dashboard, select "Volumes" under the "Elastic Block Store" section in the left-hand menu.
4. Review the list of volumes and their associated details. Check if there is a backup plan associated with each volume. This can be identified by looking at the "Tags" column for tags related to backup, or by checking the "Snapshots" section for each volume to see if there are regular snapshots being taken as part of a backup plan.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is set up, you can list all the volumes of the Storage Gateway using the following command:

   ```
   aws storagegateway list-volumes --gateway-arn <your-gateway-arn>
   ```
   Replace `<your-gateway-arn>` with the ARN of your gateway. This command will return a list of all volumes attached to the specified gateway.

3. For each volume, you can check if there is a backup plan associated with it using the following command:

   ```
   aws backup describe-backup-job --backup-job-id <your-backup-job-id>
   ```
   Replace `<your-backup-job-id>` with the ID of your backup job. This command will return the details of the specified backup job.

4. If the backup job does not exist or is not associated with the volume, then the volume does not have a backup plan. Repeat steps 3 and 4 for each volume to check all volumes.

#### Using Python

To check if your AWS Storage Gateway volumes have a backup plan, you can use the AWS SDK for Python (Boto3). Here are the steps:

1. **Set up your environment**: Before you start, make sure you have Python and Boto3 installed in your environment. You also need to configure your AWS credentials either by setting them as environment variables or by storing them in a credentials file.

2. **Create a Python script to list all your Storage Gateway volumes**: Use the `list_volumes` method from the `storagegateway` client in Boto3. Here's a sample script:

```python
import boto3

def list_volumes():
    client = boto3.client('storagegateway')
    response = client.list_volumes(GatewayARN='string')
    return response['VolumeInfos']

volumes = list_volumes()
for volume in volumes:
    print(volume['VolumeARN'])
```

3. **Create a Python script to list all your backup plans**: Use the `list_backup_plans` method from the `backup` client in Boto3. Here's a sample script:

```python
import boto3

def list_backup_plans():
    client = boto3.client('backup')
    response = client.list_backup_plans()
    return response['BackupPlansList']

backup_plans = list_backup_plans()
for plan in backup_plans:
    print(plan['BackupPlanArn'])
```

4. **Check if each volume has a backup plan**: For each volume, check if there's a backup plan that includes it. You can do this by calling the `get_backup_plan` method from the `backup` client for each backup plan, and checking if the volume's ARN is in the list of resources. Here's a sample script:

```python
import boto3

def check_volume_backup(volume_arn):
    client = boto3.client('backup')
    backup_plans = list_backup_plans()
    for plan in backup_plans:
        response = client.get_backup_plan(BackupPlanId=plan['BackupPlanId'])
        if volume_arn in response['BackupPlan']['BackupPlanResourceList']:
            return True
    return False

for volume in volumes:
    if not check_volume_backup(volume['VolumeARN']):
        print(f"Volume {volume['VolumeARN']} does not have a backup plan.")
```

This script will print the ARNs of all volumes that do not have a backup plan.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of Storage Gateway volumes not having a backup plan in AWS EC2 using the AWS console, follow these steps:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/) and login with your credentials.

2. **Navigate to Storage Gateway**: In the AWS Management Console, search for "Storage Gateway" in the services search bar, and click on the Storage Gateway service.

3. **Select the Gateway**: Select the Storage Gateway that is associated with the EC2 instance for which you want to create a backup plan.

4. **Create a Backup Plan**:
    - Click on the "Volumes" tab in the Storage Gateway console.
    - Select the volume for which you want to create a backup plan.
    - Under the "Actions" dropdown menu, select "Create EBS Snapshot Schedule".
    - Configure the backup schedule according to your requirements, such as frequency, retention policy, and start time.
    - Click on "Create" to save the backup plan.

5. **Monitor the Backup Plan**:
    - Once the backup plan is created, you can monitor its status and view the backup history in the Storage Gateway console.
    - Ensure that the backup plan is running as per the configured schedule and that backups are being created successfully.

6. **Verify Backup Data**: 
    - Periodically verify the backup data to ensure that it can be restored in case of any data loss or disaster.

By following these steps, you can remediate the misconfiguration of Storage Gateway volumes not having a backup plan for your AWS EC2 instance using the AWS console.

#### Using CLI

To remediate the misconfiguration of Storage Gateway volumes not having a backup plan in AWS EC2 using AWS CLI, you can follow these steps:

1. **List Storage Gateway Volumes**: First, list all the Storage Gateway volumes in your AWS account to identify the volumes that do not have a backup plan. You can use the following AWS CLI command:
   ```
   aws storagegateway list-volumes
   ```

2. **Enable Backup Plan**: For each volume that does not have a backup plan, you will need to enable a backup plan. You can use the following AWS CLI command to enable a backup plan for a specific volume:
   ```
   aws storagegateway update-vtl-vtldevice-type -i <VOLUME_ARN> --vtl-device-type "VTL" --vtl-device-iSCSI-Settings "TargetARN=<TARGET_ARN>,NetworkInterfaceId=<NETWORK_INTERFACE_ID>,InitiatorName=<INITIATOR_NAME>"
   ```
   - Replace `<VOLUME_ARN>` with the ARN of the volume that needs a backup plan.
   - Replace `<TARGET_ARN>` with the ARN of the target where the volume backups will be stored.
   - Replace `<NETWORK_INTERFACE_ID>` with the ID of the network interface for the volume.
   - Replace `<INITIATOR_NAME>` with the initiator name for the volume.

3. **Monitor Backup Plan**: Once you have enabled a backup plan for the volumes, monitor the backup status regularly to ensure that the backups are being performed successfully. You can use the following AWS CLI command to describe the backup status of a volume:
   ```
   aws storagegateway describe-vtl-devices
   ```

By following these steps, you can remediate the misconfiguration of Storage Gateway volumes not having a backup plan in AWS EC2 using AWS CLI.

#### Using Python

To remediate the misconfiguration of Storage Gateway Volumes not having a backup plan in AWS EC2 using Python, you can follow these steps:

1. Import the necessary libraries:
```python
import boto3
```

2. Initialize the AWS EC2 client:
```python
ec2_client = boto3.client('ec2')
```

3. Retrieve a list of Storage Gateway volumes:
```python
response = ec2_client.describe_volumes(Filters=[{'Name': 'volume-type', 'Values': ['gateway']}])
```

4. For each volume, check if a backup plan is already configured. If not, create a backup plan using AWS Backup service:
```python
backup_client = boto3.client('backup')

for volume in response['Volumes']:
    volume_arn = volume['VolumeArn']
    
    # Check if backup plan is already configured
    try:
        response = backup_client.get_recovery_point_restore_metadata(ResourceArn=volume_arn)
    except backup_client.exceptions.ResourceNotFoundException:
        # Create a backup plan if not already configured
        backup_plan = {
            'BackupPlanName': 'BackupPlanForVolume_' + volume['VolumeId'],
            'BackupPlanRule': {
                'RuleName': 'DefaultBackupRule',
                'TargetBackupVaultName': 'Default'
            }
        }
        response = backup_client.create_backup_plan(BackupPlan=backup_plan)
```

5. Implement appropriate error handling and logging as needed.

By following these steps and running the Python script, you can remediate the misconfiguration of Storage Gateway Volumes not having a backup plan in AWS EC2.



</Tab>
</Tabs>