---
slug: ec2_managedinstance_inventory_blacklisted
title: EC2 Systems Manager Are Configured To Collect Blacklisted Inventory.
sidebar_label: EC2 Systems Manager Are Configured To Collect Blacklisted Inventory.
---

### More Info:

This rule checks whether instances managed by Amazon EC2 Systems Manager are configured to collect blacklisted inventory types.

### Risk Level

Low

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 Systems Manager from being configured to collect blacklisted inventory in EC2 using the AWS Management Console, follow these steps:

1. **Access Systems Manager Inventory:**
   - Open the AWS Management Console.
   - Navigate to the Systems Manager service by searching for "Systems Manager" in the search bar and selecting it from the results.
   - In the left-hand navigation pane, under "Node Management," click on "Inventory."

2. **Review Inventory Collection:**
   - In the Inventory dashboard, review the inventory collection settings for your managed instances.
   - Ensure that the inventory collection is configured to collect only the necessary data and does not include any blacklisted inventory types.

3. **Modify Inventory Collection:**
   - If you find any blacklisted inventory types being collected, click on the "Edit" button next to the inventory collection configuration.
   - Adjust the inventory collection settings to exclude the blacklisted inventory types. You can do this by unchecking the boxes next to the blacklisted inventory types or by specifying only the allowed inventory types.

4. **Save Changes and Monitor:**
   - After making the necessary adjustments, click on the "Save" button to apply the changes.
   - Regularly monitor the inventory collection settings to ensure compliance with your organization's policies and to prevent any future misconfigurations.

By following these steps, you can prevent EC2 Systems Manager from being configured to collect blacklisted inventory using the AWS Management Console.
</Accordion>

<Accordion title='Using CLI'>
To prevent EC2 Systems Manager from collecting blacklisted inventory in EC2 using AWS CLI, you can follow these steps:

1. **Create a Systems Manager Inventory Policy:**
   Define a policy that specifies the allowed inventory types and excludes the blacklisted ones. Save this policy in a JSON file, for example, `inventory-policy.json`.

   ```json
   {
     "InventoryPolicy": {
       "AllowList": [
         "AWS:Application",
         "AWS:InstanceInformation",
         "AWS:Network"
       ],
       "DenyList": [
         "AWS:BlacklistedInventoryType"
       ]
     }
   }
   ```

2. **Attach the Inventory Policy to the EC2 Instances:**
   Use the `aws ssm put-inventory` command to attach the inventory policy to your EC2 instances. Replace `INSTANCE_ID` with your actual instance ID and `inventory-policy.json` with the path to your policy file.

   ```sh
   aws ssm put-inventory \
     --instance-id INSTANCE_ID \
     --items file://inventory-policy.json
   ```

3. **Configure Systems Manager Inventory Collection:**
   Ensure that the Systems Manager is configured to collect inventory according to the policy. Use the `aws ssm create-association` command to create an association that applies the inventory policy to your instances.

   ```sh
   aws ssm create-association \
     --name "AWS-GatherSoftwareInventory" \
     --targets "Key=InstanceIds,Values=INSTANCE_ID" \
     --parameters '{"applications": "Enabled", "instanceInformation": "Enabled", "networkConfig": "Enabled"}'
   ```

4. **Verify the Inventory Collection Configuration:**
   Use the `aws ssm list-inventory-entries` command to verify that the inventory collection is configured correctly and does not include any blacklisted inventory types.

   ```sh
   aws ssm list-inventory-entries \
     --instance-id INSTANCE_ID \
     --type-name "AWS:InstanceInformation"
   ```

By following these steps, you can ensure that EC2 Systems Manager is configured to collect only the allowed inventory types and prevent the collection of blacklisted inventory.
</Accordion>

<Accordion title='Using Python'>
To prevent EC2 Systems Manager from being configured to collect blacklisted inventory in AWS using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   Ensure you have Boto3 installed and configured with the necessary permissions to interact with AWS Systems Manager.

   ```bash
   pip install boto3
   ```

2. **Define the Blacklisted Inventory Types:**
   Create a list of inventory types that you want to blacklist.

   ```python
   blacklisted_inventory_types = ['AWS:Application', 'AWS:InstanceInformation']
   ```

3. **Create a Function to Validate Inventory Collection:**
   Write a function that checks the current inventory collection configuration and ensures it does not include any blacklisted types.

   ```python
   import boto3

   def validate_inventory_collection(instance_id, blacklisted_inventory_types):
       ssm_client = boto3.client('ssm')
       response = ssm_client.list_inventory_entries(
           InstanceId=instance_id,
           TypeName='AWS:InstanceInformation'
       )
       
       for item in response['Entries']:
           if item['TypeName'] in blacklisted_inventory_types:
               print(f"Blacklisted inventory type {item['TypeName']} found on instance {instance_id}.")
               return False
       return True
   ```

4. **Apply the Validation Across Instances:**
   Iterate over your instances and apply the validation function to ensure no blacklisted inventory types are being collected.

   ```python
   def check_all_instances():
       ec2_client = boto3.client('ec2')
       instances = ec2_client.describe_instances()
       
       for reservation in instances['Reservations']:
           for instance in reservation['Instances']:
               instance_id = instance['InstanceId']
               if not validate_inventory_collection(instance_id, blacklisted_inventory_types):
                   print(f"Instance {instance_id} is collecting blacklisted inventory types.")
               else:
                   print(f"Instance {instance_id} is compliant.")

   if __name__ == "__main__":
       check_all_instances()
   ```

This script will help you identify instances that are configured to collect blacklisted inventory types and ensure compliance by preventing such configurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, select "Managed Instances" under "Systems Manager Shared Resources".
3. In the "Managed Instances" page, you will see a list of all your instances. Select the instance you want to check.
4. In the instance details pane, click on the "Inventory" tab. Here, you can see all the inventory types collected from the instance. If the blacklisted inventory types are being collected, they will be listed here.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure the AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will need to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can use the "describe-instance-information" command to list all your EC2 instances. The command is as follows:

   ```
   aws ssm describe-instance-information
   ```

3. To check if EC2 Systems Manager is configured to collect blacklisted inventory, you need to check the "Inventory" tab in the EC2 Systems Manager. You can use the "get-inventory" command to get the inventory of a specific instance. The command is as follows:

   ```
   aws ssm get-inventory --instance-id <your-instance-id>
   ```

4. If the EC2 Systems Manager is not configured to collect blacklisted inventory, the output of the "get-inventory" command will not contain any blacklisted items. If it does contain blacklisted items, it means that the EC2 Systems Manager is configured to collect blacklisted inventory.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3, AWS EC2, and others. You can install it using pip:

   ```
   pip install boto3
   ```
   Then, configure it with your user credentials:

   ```
   aws configure
   ```
   You'll be prompted to enter your AWS Access Key ID, Secret Access Key, default region name, and default output format.

2. Use Boto3 to interact with AWS services: In your Python script, import the Boto3 library and create an EC2 resource object using your AWS credentials.

   ```python
   import boto3

   ec2 = boto3.resource('ec2')
   ```

3. Fetch the list of EC2 instances and their configurations: Use the `instances` collection of your EC2 resource object to fetch the list of instances. Then, for each instance, fetch its Systems Manager configuration.

   ```python
   for instance in ec2.instances.all():
       ssm_config = instance.ssm_configuration
       # Check if Systems Manager is configured to collect blacklisted inventory
       if 'Blacklisted' in ssm_config['Inventory']:
           print(f"Instance {instance.id} is configured to collect blacklisted inventory.")
   ```

4. Analyze the output: The script will print the IDs of all instances that are configured to collect blacklisted inventory. If no such instances are found, it means that none of your EC2 instances are misconfigured in this way. If some instances are found, you'll need to take further action to remediate this misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of EC2 Systems Manager collecting blacklisted inventory in AWS, follow these steps using the AWS Management Console:

1. **Access AWS Systems Manager Console**: 
   - Log in to your AWS account and navigate to the AWS Management Console.
   - Go to the Systems Manager service by searching for it in the search bar.

2. **Navigate to Inventory Explorer**:
   - In the Systems Manager console, navigate to the 'Explorer' section from the left-hand menu.

3. **Identify Blacklisted Inventory**:
   - In the Inventory Explorer, you will be able to see a list of all the managed instances and the collected inventory details.
   - Identify the blacklisted inventory items that are being collected by EC2 Systems Manager.

4. **Update Inventory Collection Configuration**:
   - Click on 'Inventory Setup' in the Systems Manager console.
   - Review the inventory collection configuration settings to identify the blacklisted items.
   - Click on 'Edit Inventory Schema' to modify the inventory collection configuration.

5. **Remove Blacklisted Items**:
   - In the inventory schema, locate the blacklisted inventory items that are being collected.
   - Remove the blacklisted items from the inventory schema by deselecting them or deleting them from the configuration.

6. **Save Changes**:
   - Once you have removed the blacklisted items from the inventory collection configuration, click on 'Save' to apply the changes.

7. **Verify Configuration**:
   - Go back to the Inventory Explorer and verify that the blacklisted inventory items are no longer being collected.

8. **Monitor for Compliance**:
   - Regularly monitor the inventory collection configuration to ensure that blacklisted items are not being collected in the future.

By following these steps, you can remediate the misconfiguration of EC2 Systems Manager collecting blacklisted inventory in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of EC2 Systems Manager collecting blacklisted inventory in AWS, you can follow these steps using AWS CLI:

Step 1: Identify the Systems Manager inventory collection configuration
Run the following AWS CLI command to describe the current inventory collection configuration for Systems Manager:

```bash
aws ssm describe-instance-information
```

This command will provide information about the managed instances and their inventory collection status.

Step 2: Update the inventory collection configuration
Run the following AWS CLI command to update the inventory collection configuration for Systems Manager:

```bash
aws ssm update-instance-information --instance-information-filter-list key=InstanceDetailedInformation,values=true
```

This command will update the inventory collection configuration to collect detailed information for the managed instances.

Step 3: Verify the updated configuration
You can run the describe-instance-information command again to verify that the inventory collection configuration has been updated successfully:

```bash
aws ssm describe-instance-information
```

Ensure that the inventory collection is now configured to collect the required information and that blacklisted inventory items are no longer being collected.

By following these steps, you can remediate the misconfiguration of EC2 Systems Manager collecting blacklisted inventory in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration where EC2 Systems Manager is configured to collect blacklisted inventory in AWS, you can follow these steps using Python:

1. **Identify the Blacklisted Inventory Configuration**: First, you need to identify the blacklisted inventory configuration in the EC2 Systems Manager. This can be done by checking the Systems Manager Inventory configuration settings.

2. **Update the Inventory Configuration**: You will need to update the inventory configuration to remove the blacklisted items. This can be done by modifying the Systems Manager Inventory configuration using the AWS SDK for Python (Boto3).

3. **Install Boto3**: If you haven't already, install the Boto3 library in your Python environment. You can install it using pip:
    ```bash
    pip install boto3
    ```

4. **Write Python Script**: Write a Python script that uses Boto3 to update the Systems Manager Inventory configuration. Here is an example script that removes the blacklisted inventory items:
    ```python
    import boto3

    # Initialize the EC2 client
    ssm_client = boto3.client('ssm')

    # Get the current inventory configuration
    response = ssm_client.get_inventory_configuration(
        InstanceId='your-instance-id-here'
    )

    # Remove the blacklisted items from the inventory configuration
    inventory_configuration = response['InventoryConfiguration']
    blacklisted_items = ['blacklisted-item1', 'blacklisted-item2']  # Add the blacklisted items here
    updated_inventory = [item for item in inventory_configuration if item not in blacklisted_items]

    # Update the inventory configuration
    response = ssm_client.put_inventory_configuration(
        InstanceId='your-instance-id-here',
        InventoryConfiguration=updated_inventory
    )

    print('Inventory configuration updated successfully.')
    ```

5. **Replace 'your-instance-id-here' and 'blacklisted-itemX'**: Replace 'your-instance-id-here' with the actual EC2 instance ID and add the blacklisted items to be removed from the inventory configuration.

6. **Run the Script**: Execute the Python script in your environment. This will update the Systems Manager Inventory configuration to remove the blacklisted items.

By following these steps, you can remediate the misconfiguration where EC2 Systems Manager is configured to collect blacklisted inventory in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

