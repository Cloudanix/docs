---
slug: ec2_older_than_x_days
title: Long Running Instances Should Be Re-launched
sidebar_label: Long Running Instances Should Be Re-launched
---

### More Info:

EC2 instance running indefinitely in your AWS your account could increase the risk of potential issues.

### Risk Level

Informational

### Address

Reliability, Security

### Compliance Standards

CBP



### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent long-running instances in EC2 using the AWS Management Console, follow these steps:

1. **Set Up CloudWatch Alarms:**
   - Navigate to the **CloudWatch** service in the AWS Management Console.
   - Create a new alarm by selecting **Alarms** from the left-hand menu and clicking **Create Alarm**.
   - Choose the **EC2** metric for instance uptime or status checks.
   - Configure the alarm to trigger when an instance has been running for a specified period (e.g., 30 days).

2. **Enable Auto Scaling:**
   - Go to the **EC2** service in the AWS Management Console.
   - Select **Auto Scaling Groups** from the left-hand menu.
   - Create a new Auto Scaling group or modify an existing one to include your instances.
   - Configure the Auto Scaling policies to replace instances after a certain period or based on health checks.

3. **Use AWS Config Rules:**
   - Navigate to the **AWS Config** service in the AWS Management Console.
   - Create a new rule by selecting **Rules** from the left-hand menu and clicking **Add Rule**.
   - Choose a managed rule such as `ec2-instance-managed-by-systems-manager` to ensure instances are managed and can be re-launched as needed.
   - Customize the rule to check for long-running instances and take appropriate actions.

4. **Implement Lifecycle Policies:**
   - Go to the **EC2** service in the AWS Management Console.
   - Select **Instances** from the left-hand menu.
   - Tag your instances with a specific key-value pair (e.g., `Lifecycle: Short`).
   - Use AWS Lambda functions triggered by CloudWatch Events to periodically check and terminate instances based on their tags and uptime.

By following these steps, you can effectively monitor and manage the lifecycle of your EC2 instances to prevent long-running instances from causing issues.
</Accordion>

<Accordion title='Using CLI'>
To prevent long-running instances in EC2 using AWS CLI, you can implement the following steps:

1. **Set Up CloudWatch Alarms for Instance Uptime:**
   Create a CloudWatch alarm to monitor the uptime of your instances. This will help you get notified when an instance has been running for too long.

   ```sh
   aws cloudwatch put-metric-alarm --alarm-name "InstanceUptimeAlarm" \
   --metric-name "InstanceUptime" --namespace "AWS/EC2" --statistic "Maximum" \
   --period 3600 --threshold 720 --comparison-operator "GreaterThanThreshold" \
   --dimensions Name=InstanceId,Value=i-1234567890abcdef0 --evaluation-periods 1 \
   --alarm-actions arn:aws:sns:us-west-2:123456789012:MyTopic
   ```

2. **Automate Instance Re-launch Using Lambda:**
   Create a Lambda function that will stop and start instances based on the CloudWatch alarm. First, create a Lambda function and then add the following policy to allow it to manage EC2 instances:

   ```sh
   aws iam create-role --role-name LambdaEC2Role --assume-role-policy-document file://trust-policy.json
   aws iam attach-role-policy --role-name LambdaEC2Role --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess
   ```

3. **Schedule Regular Instance Reboots:**
   Use AWS CLI to create a scheduled event that triggers the Lambda function to reboot instances periodically.

   ```sh
   aws events put-rule --schedule-expression "rate(24 hours)" --name "RebootInstancesRule"
   aws events put-targets --rule "RebootInstancesRule" --targets "Id"="1","Arn"="arn:aws:lambda:us-west-2:123456789012:function:RebootInstancesFunction"
   ```

4. **Tag Instances for Monitoring:**
   Tag your instances to identify which ones need to be monitored for long-running status. This helps in filtering and managing instances more effectively.

   ```sh
   aws ec2 create-tags --resources i-1234567890abcdef0 --tags Key=Monitor,Value=True
   ```

By following these steps, you can effectively monitor and manage long-running instances in EC2 using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent long-running instances in EC2 using Python scripts, you can implement a monitoring and automation strategy. Here are the steps to achieve this:

### 1. **Set Up AWS SDK (Boto3)**
First, ensure you have the AWS SDK for Python (Boto3) installed. You can install it using pip if you haven't already:

```bash
pip install boto3
```

### 2. **Identify Long-Running Instances**
Create a Python script to identify instances that have been running for a long time. You can define what "long-running" means based on your requirements (e.g., instances running for more than 30 days).

```python
import boto3
from datetime import datetime, timedelta

# Initialize a session using Amazon EC2
ec2 = boto3.client('ec2')

# Define the threshold for long-running instances (e.g., 30 days)
threshold_days = 30
threshold_date = datetime.now() - timedelta(days=threshold_days)

# Describe instances
response = ec2.describe_instances()

# Iterate over instances and check their launch time
for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        launch_time = instance['LaunchTime']
        if launch_time < threshold_date:
            print(f"Instance {instance['InstanceId']} is running for more than {threshold_days} days.")
```

### 3. **Automate Instance Re-launching**
Once you identify long-running instances, you can automate their re-launching. This involves stopping the instance and then starting it again.

```python
# Function to stop and start instances
def relaunch_instance(instance_id):
    # Stop the instance
    ec2.stop_instances(InstanceIds=[instance_id])
    print(f"Stopping instance {instance_id}...")
    
    # Wait until the instance is stopped
    waiter = ec2.get_waiter('instance_stopped')
    waiter.wait(InstanceIds=[instance_id])
    print(f"Instance {instance_id} stopped.")
    
    # Start the instance
    ec2.start_instances(InstanceIds=[instance_id])
    print(f"Starting instance {instance_id}...")
    
    # Wait until the instance is running
    waiter = ec2.get_waiter('instance_running')
    waiter.wait(InstanceIds=[instance_id])
    print(f"Instance {instance_id} is running again.")

# Iterate over instances and relaunch if they are long-running
for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        launch_time = instance['LaunchTime']
        if launch_time < threshold_date:
            relaunch_instance(instance['InstanceId'])
```

### 4. **Schedule the Script**
To ensure this script runs periodically, you can schedule it using a cron job (on Unix-based systems) or Task Scheduler (on Windows). This will help in continuously monitoring and managing long-running instances.

#### Example Cron Job (Unix-based systems):
```bash
# Open the crontab editor
crontab -e

# Add the following line to run the script every day at midnight
0 0 * * * /usr/bin/python3 /path/to/your/script.py
```

By following these steps, you can effectively prevent long-running instances in EC2 using Python scripts. This approach ensures that instances are periodically checked and re-launched if they exceed the defined running time threshold.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "Instances", click on "Instances".
3. In the Instances dashboard, you can see all your instances running. Check the "Launch Time" column for each instance. This will show you when the instance was launched.
4. If an instance has been running for a long time (based on your organization's policy, it could be weeks or months), it may need to be re-launched. You can identify these instances by comparing the "Launch Time" with the current date and time.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```

   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format. These details can be found in your AWS Management Console.

2. List all EC2 instances: You can list all your EC2 instances using the following command:

   ```
   aws ec2 describe-instances
   ```

   This command will return a JSON output with details about all your EC2 instances.

3. Filter long running instances: You can filter out the long running instances by checking the 'LaunchTime' attribute of each instance. You can do this using a Python script. Here is a simple script that prints the instance ID and launch time of instances that have been running for more than 30 days:

   ```python
   import boto3
   from datetime import datetime, timedelta

   ec2 = boto3.resource('ec2')

   for instance in ec2.instances.all():
       launch_time = instance.launch_time
       now = datetime.now(launch_time.tzinfo)
       if now - launch_time > timedelta(days=30):
           print(f'Instance {instance.id} has been running since {launch_time}')
   ```

4. Analyze the output: The output of the script will give you the instance IDs and launch times of all long running instances. You can use this information to decide whether these instances should be re-launched or not.
</Accordion>

<Accordion title='Using Python'>
1. **Setup AWS SDK (Boto3) in Python Environment:**
   First, you need to set up AWS SDK (Boto3) in your Python environment. You can install it using pip:
   ```
   pip install boto3
   ```
   After installing boto3, configure your AWS credentials either by setting up environment variables or by using AWS CLI.

2. **Create a Python Script to List EC2 Instances:**
   Create a Python script that uses Boto3 to list all the EC2 instances in your AWS account. Here's a basic example:
   ```python
   import boto3

   def list_instances():
       ec2 = boto3.resource('ec2')
       for instance in ec2.instances.all():
           print('ID: {}, State: {}, Launch Time: {}'.format(
               instance.id, instance.state['Name'], instance.launch_time))

   list_instances()
   ```
   This script will print the ID, state, and launch time of each EC2 instance.

3. **Modify the Script to Detect Long Running Instances:**
   Modify the script to detect instances that have been running for a long time. You can do this by comparing the launch time of each instance with the current time. Here's an example:
   ```python
   import boto3
   from datetime import datetime, timezone

   def detect_long_running_instances():
       ec2 = boto3.resource('ec2')
       for instance in ec2.instances.all():
           launch_time = instance.launch_time
           now = datetime.now(timezone.utc)
           running_time = now - launch_time
           if running_time.days > 30:  # Change this to your desired threshold
               print('ID: {}, State: {}, Launch Time: {}, Running Time: {} days'.format(
                   instance.id, instance.state['Name'], instance.launch_time, running_time.days))

   detect_long_running_instances()
   ```
   This script will print the ID, state, launch time, and running time (in days) of each EC2 instance that has been running for more than 30 days.

4. **Schedule the Script:**
   Finally, you can schedule this script to run at regular intervals using a task scheduler like cron (on Unix-based systems) or Task Scheduler (on Windows). This way, you'll be able to detect long running instances on a regular basis.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of long running instances in AWS using the AWS console, you can follow the below steps:

1. Log in to your AWS Management Console.

2. Go to the EC2 dashboard.

3. Under the Instances section, select the instance that has been running for a long time.

4. Stop the instance by right-clicking on it and selecting "Instance State" > "Stop".

5. Once the instance is stopped, right-click on it again and select "Instance Settings" > "Change Shutdown Behavior".

6. From the drop-down menu, select "Terminate".

7. Click "Apply" and then "Save".

8. Start a new instance with the same configuration as the terminated instance.

9. Once the new instance is running, ensure that all the data and configurations from the old instance are properly transferred to the new instance.

10. Finally, terminate the old instance to avoid any unnecessary charges.

By following these steps, you can remediate the issue of long running instances in AWS and ensure that your cloud infrastructure is optimized for performance and cost.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of long-running instances in AWS using AWS CLI, follow the steps below:

1. Open the AWS CLI on your local machine or EC2 instance.

2. List all the instances that are currently running using the following command:

   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,InstanceType,State.Name,LaunchTime]' --output text
   ```

   This command will list all the instances that are currently running in your AWS account.

3. Identify the instances that have been running for a long time and need to be relaunched.

4. Stop the identified instances using the following command:

   ```
   aws ec2 stop-instances --instance-ids instance_id
   ```

   Replace `instance_id` with the ID of the instance that needs to be stopped. This command will stop the instance.

5. Once the instance is stopped, launch a new instance using the same configuration as the stopped instance.

   ```
   aws ec2 run-instances --image-id ami-xxxxxxxx --count 1 --instance-type t2.micro --key-name MyKeyPair --security-group-ids sg-xxxxxxxx --subnet-id subnet-xxxxxxxx
   ```

   Replace the `image-id`, `instance-type`, `key-name`, `security-group-ids`, and `subnet-id` with the same configuration as the stopped instance. This command will launch a new instance.

6. Once the new instance is launched, terminate the old instance using the following command:

   ```
   aws ec2 terminate-instances --instance-ids instance_id
   ```

   Replace `instance_id` with the ID of the stopped instance. This command will terminate the old instance.

7. Verify that the new instance is running and functioning properly.

By following these steps, you can remediate the misconfiguration of long-running instances in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of long running instances in AWS using Python, you can follow these steps:

1. Import the necessary AWS SDK modules in Python. For example, you can use the `boto3` module.

```
import boto3
```

2. Create a session with AWS using the `boto3.Session()` method.

```
session = boto3.Session(
    aws_access_key_id='ACCESS_KEY',
    aws_secret_access_key='SECRET_KEY',
    region_name='REGION'
)
```

3. Use the `boto3.client()` method to connect to the EC2 service.

```
ec2 = session.client('ec2')
```

4. Use the `describe_instances()` method to get a list of all running instances.

```
instances = ec2.describe_instances(
    Filters=[
        {
            'Name': 'instance-state-name',
            'Values': ['running']
        }
    ]
)
```

5. Loop through the list of instances and use the `terminate_instances()` method to terminate them.

```
for instance in instances['Reservations'][0]['Instances']:
    instance_id = instance['InstanceId']
    ec2.terminate_instances(
        InstanceIds=[
            instance_id
        ]
    )
```

6. Alternatively, you can use the `stop_instances()` method to stop the instances instead of terminating them.

```
for instance in instances['Reservations'][0]['Instances']:
    instance_id = instance['InstanceId']
    ec2.stop_instances(
        InstanceIds=[
            instance_id
        ]
    )
```

7. You can also add additional filters to the `describe_instances()` method to target specific instances based on tags or other attributes.

```
instances = ec2.describe_instances(
    Filters=[
        {
            'Name': 'tag:Environment',
            'Values': ['Production']
        },
        {
            'Name': 'instance-state-name',
            'Values': ['running']
        }
    ]
)
```

8. Finally, you can schedule this Python script to run periodically using a task scheduler or cron job to ensure that long running instances are always re-launched.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html) 

