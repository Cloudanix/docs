---
slug: unrestricted_netbios_access
title: Unrestricted Netbios Access Should Not Be Allowed
sidebar_label: Unrestricted Netbios Access Should Not Be Allowed
---

### More Info:

No AWS EC2 security group should allow unrestricted inbound access to TCP port 139 and UDP ports 137 and 138 (NetBIOS).

### Risk Level

High

### Address

Security

### Compliance Standards

HIPAA, NIST, SOC2, GDPR


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent unrestricted NetBIOS access in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to Security Groups:**
   - Open the AWS Management Console.
   - In the navigation pane, choose "Security Groups" under the "Network & Security" section.

2. **Select the Security Group:**
   - Identify and select the security group associated with your EC2 instances that you want to modify.

3. **Edit Inbound Rules:**
   - In the "Inbound rules" tab, click on the "Edit inbound rules" button.
   - Look for any rules that allow unrestricted access (0.0.0.0/0 or ::/0) to ports 137-139 (NetBIOS).

4. **Remove or Restrict NetBIOS Access:**
   - Remove any inbound rules that allow unrestricted access to ports 137-139.
   - If necessary, add more restrictive rules that only allow access from specific IP addresses or ranges that require NetBIOS access.

By following these steps, you can ensure that NetBIOS access is not left unrestricted, thereby enhancing the security of your EC2 instances.
</Accordion>

<Accordion title='Using CLI'>
To prevent unrestricted NetBIOS access in EC2 using AWS CLI, you need to modify the security group rules to restrict access to the NetBIOS ports (137-139). Here are the steps:

1. **Identify the Security Group:**
   First, identify the security group associated with your EC2 instance that has unrestricted NetBIOS access.

   ```sh
   aws ec2 describe-instances --instance-ids <instance-id> --query 'Reservations[*].Instances[*].SecurityGroups[*].GroupId' --output text
   ```

2. **Revoke Inbound Rules for NetBIOS Ports:**
   Revoke any inbound rules that allow unrestricted access to NetBIOS ports (137-139).

   ```sh
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol udp --port 137 --cidr 0.0.0.0/0
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol udp --port 138 --cidr 0.0.0.0/0
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 139 --cidr 0.0.0.0/0
   ```

3. **Add Restricted Inbound Rules for NetBIOS Ports:**
   If necessary, add more restrictive inbound rules for the NetBIOS ports, specifying only the trusted IP ranges.

   ```sh
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol udp --port 137 --cidr <trusted-ip-range>
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol udp --port 138 --cidr <trusted-ip-range>
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol tcp --port 139 --cidr <trusted-ip-range>
   ```

4. **Verify the Security Group Rules:**
   Verify that the security group rules have been updated correctly to ensure that unrestricted access to NetBIOS ports is no longer allowed.

   ```sh
   aws ec2 describe-security-groups --group-ids <security-group-id>
   ```

By following these steps, you can prevent unrestricted NetBIOS access in your EC2 instances using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent unrestricted NetBIOS access in EC2 instances using Python scripts, you can use the Boto3 library, which is the AWS SDK for Python. Here are the steps to achieve this:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed. If not, you can install it using pip:
   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by creating a `~/.aws/credentials` file.

3. **Create a Python Script to Identify Security Groups with Unrestricted NetBIOS Access**:
   Write a Python script to identify security groups that allow unrestricted access to NetBIOS ports (137-139).

4. **Modify Security Groups to Restrict NetBIOS Access**:
   Update the identified security groups to restrict access to NetBIOS ports.

Here is a sample Python script to achieve this:

```python
import boto3

# Initialize a session using Amazon EC2
ec2 = boto3.client('ec2')

# Define the NetBIOS ports
netbios_ports = [137, 138, 139]

# Function to check if a security group has unrestricted NetBIOS access
def has_unrestricted_netbios_access(security_group):
    for permission in security_group['IpPermissions']:
        if 'FromPort' in permission and 'ToPort' in permission:
            if permission['FromPort'] in netbios_ports and permission['ToPort'] in netbios_ports:
                for ip_range in permission['IpRanges']:
                    if ip_range['CidrIp'] == '0.0.0.0/0':
                        return True
    return False

# Describe all security groups
response = ec2.describe_security_groups()

# Iterate over each security group
for sg in response['SecurityGroups']:
    if has_unrestricted_netbios_access(sg):
        print(f"Security Group {sg['GroupId']} has unrestricted NetBIOS access. Revoking permissions...")

        # Revoke the unrestricted NetBIOS access
        for permission in sg['IpPermissions']:
            if 'FromPort' in permission and 'ToPort' in permission:
                if permission['FromPort'] in netbios_ports and permission['ToPort'] in netbios_ports:
                    ec2.revoke_security_group_ingress(
                        GroupId=sg['GroupId'],
                        IpProtocol=permission['IpProtocol'],
                        FromPort=permission['FromPort'],
                        ToPort=permission['ToPort'],
                        CidrIp='0.0.0.0/0'
                    )
                    print(f"Revoked unrestricted NetBIOS access for Security Group {sg['GroupId']}")

print("Completed checking and updating security groups.")
```

### Explanation:
1. **Initialize Boto3 Client**: The script initializes a Boto3 client for EC2.
2. **Define NetBIOS Ports**: The NetBIOS ports (137, 138, 139) are defined.
3. **Check for Unrestricted Access**: The script defines a function to check if a security group has unrestricted access to NetBIOS ports.
4. **Revoke Unrestricted Access**: The script iterates over all security groups, identifies those with unrestricted NetBIOS access, and revokes the permissions.

This script ensures that no security group in your AWS account has unrestricted access to NetBIOS ports, thereby preventing potential security risks.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the left navigation pane, under the "Network & Security" section, click on "Security Groups".
3. In the Security Groups page, you will see a list of all the security groups associated with your EC2 instances. Click on the security group that you want to check.
4. In the details pane at the bottom, click on the "Inbound rules" tab. Here, you can see all the inbound rules associated with the selected security group. Check if there are any rules that allow unrestricted access (0.0.0.0/0) to the NetBIOS ports (TCP/UDP 137-139, TCP 445). If such rules exist, then NetBIOS access is unrestricted, which is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the EC2 instances and security groups.

2. Once the AWS CLI is set up, you can list all the security groups in your AWS account using the following command:

   ```
   aws ec2 describe-security-groups --query 'SecurityGroups[*].[GroupId]' --output text
   ```

3. For each security group, you can describe the rules to check if there is any unrestricted access to NetBIOS. NetBIOS uses TCP/UDP ports 137, 138, and 139. You can use the following command to check the inbound rules:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions[*].[FromPort,ToPort,IpRanges]' --output text
   ```

4. If the output of the above command includes 0.0.0.0/0 (which means unrestricted access) for the ports 137, 138, or 139, then it means that unrestricted NetBIOS access is allowed. You should review these security groups and update the rules to restrict the access as necessary.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:

```python
pip install boto3
```

2. Set up AWS credentials: You can set up your AWS credentials in several ways, but the simplest is to use the AWS CLI tool to configure them:

```bash
aws configure
```

3. Create a Python script to check for unrestricted NetBIOS access: The script will use Boto3 to interact with the AWS EC2 service, retrieve all security groups, and check if they have unrestricted access to NetBIOS (port 139 and 445). Here is a simple script:

```python
import boto3

def check_unrestricted_netbios_access():
    ec2 = boto3.resource('ec2')
    security_groups = ec2.security_groups.all()

    for sg in security_groups:
        for permission in sg.ip_permissions:
            for ip_range in permission['IpRanges']:
                if '0.0.0.0/0' in ip_range['CidrIp']:
                    if permission['FromPort'] in [139, 445] and permission['ToPort'] in [139, 445]:
                        print(f"Security Group {sg.id} has unrestricted NetBIOS access.")

check_unrestricted_netbios_access()
```

4. Run the script: You can run the script using any Python interpreter. The script will print out the IDs of any security groups that have unrestricted NetBIOS access.

```bash
python check_netbios.py
```

Please note that this script only checks for IPv4 unrestricted access. If you want to check for IPv6 as well, you would need to modify the script to also check the 'Ipv6Ranges' field in the ip_permissions.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the "Unrestricted Netbios Access Should Not Be Allowed" misconfiguration in AWS using the AWS console, you can follow these steps:

1. Log in to your AWS Management Console.
2. Go to the Amazon VPC dashboard.
3. Click on "Security Groups" from the left-hand menu.
4. Select the security group that has unrestricted NetBIOS access.
5. Click on the "Inbound Rules" tab.
6. Locate the rule that allows unrestricted NetBIOS access (usually port 137-139).
7. Click on the "Edit" button next to the rule.
8. Change the source IP address to a specific IP address or range of IP addresses that should be allowed to access NetBIOS.
9. Click on the "Save" button to save the changes.

By following these steps, you have successfully remediated the "Unrestricted Netbios Access Should Not Be Allowed" misconfiguration in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the unrestricted NetBIOS access issue in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI and run the following command to list all the security groups in your AWS account:

   ```
   aws ec2 describe-security-groups
   ```

2. Identify the security group that has unrestricted NetBIOS access.

3. Run the following command to revoke the inbound rule that allows unrestricted NetBIOS access:

   ```
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 139 --cidr 0.0.0.0/0
   ```

   Note: Replace `<security-group-id>` with the ID of the security group that you identified in step 2.

4. Run the following command to revoke the inbound rule that allows unrestricted NetBIOS access:

   ```
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 445 --cidr 0.0.0.0/0
   ```

   Note: Replace `<security-group-id>` with the ID of the security group that you identified in step 2.

5. Verify that the inbound rules have been revoked by running the following command:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id>
   ```

   Note: Replace `<security-group-id>` with the ID of the security group that you identified in step 2.

6. Repeat steps 3-5 for all the security groups in your AWS account that have unrestricted NetBIOS access.

7. Once you have revoked the inbound rules for all the security groups, the unrestricted NetBIOS access issue will be remediated.
</Accordion>

<Accordion title='Using Python'>
To remediate the "Unrestricted Netbios Access Should Not Be Allowed" misconfiguration for AWS using python, you can follow these steps:

1. Import the necessary AWS SDK and modules in your python script.
```
import boto3
from botocore.exceptions import ClientError
```

2. Create an AWS client for EC2 service.
```
ec2 = boto3.client('ec2')
```

3. Get a list of all the security groups in your AWS account.
```
response = ec2.describe_security_groups()
security_groups = response['SecurityGroups']
```

4. Loop through each security group and check if it has unrestricted NetBIOS access. To do this, check if any of the inbound rules of the security group has the protocol set to "UDP" or "TCP", the port range set to "137-139", and the source IP range set to "0.0.0.0/0" or "::/0".
```
for sg in security_groups:
    for rule in sg['IpPermissions']:
        if rule['IpProtocol'] in ['tcp', 'udp'] and rule['FromPort'] <= 139 and rule['ToPort'] >= 137:
            for ip_range in rule['IpRanges']:
                if ip_range['CidrIp'] in ['0.0.0.0/0', '::/0']:
                    print(f"Security group {sg['GroupId']} allows unrestricted NetBIOS access.")
```

5. If you find any security group that has unrestricted NetBIOS access, remove the offending inbound rule from the security group using the revoke_security_group_ingress() method of the AWS EC2 client. You will need to provide the security group ID, the protocol, the port range, and the source IP range of the offending rule as parameters to this method.
```
try:
    ec2.revoke_security_group_ingress(
        GroupId=sg['GroupId'],
        IpPermissions=[
            {
                'IpProtocol': rule['IpProtocol'],
                'FromPort': rule['FromPort'],
                'ToPort': rule['ToPort'],
                'IpRanges': [
                    {
                        'CidrIp': ip_range['CidrIp']
                    }
                ]
            }
        ]
    )
    print(f"Removed unrestricted NetBIOS access from security group {sg['GroupId']}.")
except ClientError as e:
    print(f"Error removing unrestricted NetBIOS access from security group {sg['GroupId']}: {e}")
```

6. After removing the offending rule, you can verify that the security group no longer allows unrestricted NetBIOS access by repeating step 4.

Note: Make sure you have the necessary permissions to modify security groups in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html) 
- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html) 
- [https://docs.aws.amazon.com/cli/latest/reference/ec2/authorize-security-group-ingress.html](https://docs.aws.amazon.com/cli/latest/reference/ec2/authorize-security-group-ingress.html) 

