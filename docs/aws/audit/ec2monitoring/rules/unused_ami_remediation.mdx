
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent unused Amazon Machine Images (AMIs) from accumulating in your AWS EC2 environment using the AWS Management Console, follow these steps:

1. **Identify Unused AMIs:**
   - Navigate to the **EC2 Dashboard** in the AWS Management Console.
   - In the left-hand menu, click on **AMIs** under the **Images** section.
   - Review the list of AMIs and identify those that are not associated with any running instances or are no longer needed.

2. **Tag AMIs with Metadata:**
   - For better management, tag your AMIs with metadata such as creation date, owner, and purpose.
   - Select an AMI, click on the **Tags** tab, and then click **Add/Edit Tags**.
   - Add relevant tags to help identify and manage AMIs more effectively.

3. **Set Up Lifecycle Policies:**
   - Use AWS Data Lifecycle Manager to automate the deletion of outdated or unused AMIs.
   - Navigate to the **Lifecycle Manager** under the **Elastic Block Store** section.
   - Create a new lifecycle policy, specifying the criteria for AMI deletion, such as age or tag-based rules.

4. **Regular Audits:**
   - Schedule regular audits to review and clean up unused AMIs.
   - Set a calendar reminder or use AWS Config rules to periodically check for compliance with your AMI management policies.

By following these steps, you can effectively manage and prevent the accumulation of unused AMIs in your AWS environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent unused Amazon Machine Images (AMIs) from accumulating in your AWS account using the AWS CLI, you can follow these steps:

1. **List All AMIs:**
   Use the `describe-images` command to list all AMIs owned by your account. This helps you identify which AMIs are currently available.
   ```sh
   aws ec2 describe-images --owners self
   ```

2. **Identify Unused AMIs:**
   To identify unused AMIs, you can cross-reference the AMIs with the instances that are currently running. First, list all running instances:
   ```sh
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].ImageId' --output text
   ```

3. **Filter Out Used AMIs:**
   Compare the list of AMIs from step 1 with the list of AMIs in use from step 2. You can use a script to automate this comparison. Here is a simple example in Python:
   ```python
   import boto3

   ec2 = boto3.client('ec2')

   # Get all AMIs
   all_amis = ec2.describe_images(Owners=['self'])['Images']
   all_ami_ids = {ami['ImageId'] for ami in all_amis}

   # Get all running instances
   running_instances = ec2.describe_instances(Filters=[{'Name': 'instance-state-name', 'Values': ['running']}])
   used_ami_ids = {instance['ImageId'] for reservation in running_instances['Reservations'] for instance in reservation['Instances']}

   # Find unused AMIs
   unused_ami_ids = all_ami_ids - used_ami_ids
   print("Unused AMIs:", unused_ami_ids)
   ```

4. **Automate the Cleanup Process:**
   Once you have identified the unused AMIs, you can automate their deregistration to prevent accumulation. Here is a sample command to deregister an unused AMI:
   ```sh
   aws ec2 deregister-image --image-id ami-xxxxxxxxxxxxxxxxx
   ```

   You can loop through the list of unused AMIs and deregister them using a script:
   ```python
   for ami_id in unused_ami_ids:
       ec2.deregister_image(ImageId=ami_id)
       print(f"Deregistered AMI: {ami_id}")
   ```

By following these steps, you can effectively prevent unused AMIs from accumulating in your AWS account using the AWS CLI and a bit of Python scripting.
</Accordion>

<Accordion title='Using Python'>
To prevent unused Amazon Machine Images (AMIs) in EC2 using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   - Install Boto3 if you haven't already:
     ```bash
     pip install boto3
     ```

2. **Identify Unused AMIs:**
   - Write a Python script to list all AMIs and check if they are associated with any running or stopped instances. If not, they are considered unused.

3. **Automate the Cleanup Process:**
   - Create a script to deregister unused AMIs and delete associated snapshots.

4. **Schedule the Script:**
   - Use AWS Lambda or a cron job to run the script periodically to ensure unused AMIs are regularly cleaned up.

Here is a sample Python script to identify and deregister unused AMIs:

```python
import boto3

def get_all_amis():
    ec2 = boto3.client('ec2')
    response = ec2.describe_images(Owners=['self'])
    return response['Images']

def get_all_instances():
    ec2 = boto3.client('ec2')
    response = ec2.describe_instances()
    instances = []
    for reservation in response['Reservations']:
        for instance in reservation['Instances']:
            instances.append(instance)
    return instances

def find_unused_amis():
    amis = get_all_amis()
    instances = get_all_instances()
    
    used_amis = set(instance['ImageId'] for instance in instances)
    unused_amis = [ami for ami in amis if ami['ImageId'] not in used_amis]
    
    return unused_amis

def deregister_ami(ami_id):
    ec2 = boto3.client('ec2')
    ec2.deregister_image(ImageId=ami_id)
    print(f"Deregistered AMI: {ami_id}")

def delete_snapshot(snapshot_id):
    ec2 = boto3.client('ec2')
    ec2.delete_snapshot(SnapshotId=snapshot_id)
    print(f"Deleted Snapshot: {snapshot_id}")

def cleanup_unused_amis():
    unused_amis = find_unused_amis()
    for ami in unused_amis:
        ami_id = ami['ImageId']
        deregister_ami(ami_id)
        for block_device in ami['BlockDeviceMappings']:
            if 'Ebs' in block_device:
                snapshot_id = block_device['Ebs']['SnapshotId']
                delete_snapshot(snapshot_id)

if __name__ == "__main__":
    cleanup_unused_amis()
```

### Steps Explanation:

1. **Set Up AWS SDK for Python (Boto3):**
   - Ensure Boto3 is installed and configured with appropriate AWS credentials.

2. **Identify Unused AMIs:**
   - The script retrieves all AMIs owned by the user and all instances.
   - It then checks which AMIs are not associated with any running or stopped instances.

3. **Automate the Cleanup Process:**
   - The script deregisters unused AMIs and deletes associated snapshots to free up storage.

4. **Schedule the Script:**
   - Deploy the script on AWS Lambda or set up a cron job to run it periodically, ensuring continuous cleanup of unused AMIs.

By following these steps, you can effectively prevent the accumulation of unused AMIs in your AWS environment using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "Images", click on "AMIs". This will display a list of all available AMIs.
3. To identify unused AMIs, check the "Launch Time" column. If an AMI hasn't been used for a long time, it's likely that it's unused.
4. Additionally, you can check the "Usage" column. If the value is "Not used", it means that the AMI is not associated with any running instances.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI by following the instructions provided in the official AWS documentation. Once installed, you can configure it by running the command `aws configure` and providing your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all AMIs: You can list all the AMIs available in your AWS account by running the following command: `aws ec2 describe-images --owners self`. This command will return a JSON object containing details of all the AMIs owned by your AWS account.

3. Check for unused AMIs: To check for unused AMIs, you need to compare the list of AMIs obtained in the previous step with the list of AMIs currently in use by your EC2 instances. You can get the list of AMIs currently in use by running the following command: `aws ec2 describe-instances --query 'Reservations[*].Instances[*].ImageId' --output text`. Any AMI that is in the first list but not in the second list is an unused AMI.

4. Filter unused AMIs: To make the process of identifying unused AMIs easier, you can use the `jq` command-line JSON processor. The following command will return a list of AMIs that are not in use: `aws ec2 describe-images --owners self | jq -r '.Images[].ImageId' | grep -v -f <(aws ec2 describe-instances --query 'Reservations[*].Instances[*].ImageId' --output text)`.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:

```python
pip install boto3
```

2. Set up AWS credentials: You can configure your AWS credentials in several ways, but the simplest is to use the AWS CLI tool to store them in ~/.aws/credentials:

```bash
aws configure
```

3. Write a Python script to list all AMIs: You can use the `describe_images` method from the EC2 client in Boto3 to list all AMIs. You can filter the AMIs by the owner to list only the AMIs owned by your account.

```python
import boto3

def list_amis():
    ec2 = boto3.client('ec2')
    response = ec2.describe_images(Owners=['self'])
    for image in response['Images']:
        print("Image ID: ", image['ImageId'])

list_amis()
```

4. Check if the AMIs are in use: To check if an AMI is in use, you can describe the instances in your account and check if the `ImageId` of any instance matches the `ImageId` of the AMI. If an AMI is not used by any instance, it is unused.

```python
def check_unused_amis():
    ec2 = boto3.client('ec2')
    amis = ec2.describe_images(Owners=['self'])
    instances = ec2.describe_instances()
    used_amis = set(instance['Instances'][0]['ImageId'] for instance in instances['Reservations'])
    for ami in amis['Images']:
        if ami['ImageId'] not in used_amis:
            print("Unused AMI: ", ami['ImageId'])

check_unused_amis()
```

This script will print the IDs of all unused AMIs.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step by step instructions to remediate the unused AMIs issue in AWS using AWS console:

1. Login to your AWS console.
2. Go to the EC2 dashboard.
3. Click on the "AMIs" option from the left-hand menu.
4. Sort the AMIs by the "Creation Date" column to identify the oldest and unused AMIs.
5. Select the unused AMIs that you want to remove.
6. Click on the "Actions" button and select "Deregister" from the dropdown menu.
7. Confirm the deregistration by clicking on the "Deregister" button in the confirmation window.
8. Once the AMI is deregistered, you can delete the associated EBS snapshots by selecting the AMI and clicking on the "Snapshots" tab.
9. Select the associated EBS snapshot(s) and click on the "Actions" button.
10. From the dropdown menu, select "Delete" and confirm the deletion.

By following these steps, you can remediate the unused AMIs issue in AWS and ensure that your cloud resources are optimized for cost and efficiency.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of unused AMIs in AWS using AWS CLI, follow the below steps:

1. Open the AWS CLI in your terminal or command prompt.

2. List all the AMIs that are not in use by running the following command:

```
aws ec2 describe-images --owners self --filters "Name=state,Values=available" "Name=tag-key,Values=Name" --query 'Images[*].{ID:ImageId,Name:Tags[0].Value}'
```
This command will list all the AMIs that are not in use and have a Name tag.

3. Identify the AMIs that are not required anymore and make a note of their IDs.

4. Deregister the unused AMIs by running the following command:

```
aws ec2 deregister-image --image-id <AMI-ID>
```
Replace `<AMI-ID>` with the actual ID of the unused AMI.

5. Verify that the AMI has been deregistered by running the following command:

```
aws ec2 describe-images --image-ids <AMI-ID>
```
Replace `<AMI-ID>` with the actual ID of the unused AMI. If the command returns an error stating that the AMI does not exist, then it has been successfully deregistered.

By following the above steps, you can remediate the misconfiguration of unused AMIs in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the unused AMIs misconfiguration in AWS using Python, you can follow these steps:

1. Install the Boto3 library for Python using pip: `pip install boto3`

2. Create an AWS session using the `boto3.Session()` method.

3. Use the `ec2` resource in Boto3 to get a list of all the AMIs currently available in your AWS account. You can use the `filter()` method to filter out only the unused AMIs by checking their `state` attribute. For example:

```python
import boto3

session = boto3.Session()

ec2 = session.resource('ec2')
unused_amis = []

for ami in ec2.images.filter(Owners=['self']):
    if ami.state == 'available' and len(ami.block_device_mappings) == 0:
        unused_amis.append(ami.id)
```

4. Once you have the list of unused AMIs, you can use the `deregister_image()` method to remove them from your AWS account. For example:

```python
for ami_id in unused_amis:
    ami = ec2.Image(ami_id)
    ami.deregister()
```

This will deregister all the unused AMIs in your AWS account. Make sure to test this code in a non-production environment before running it in a production environment.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
