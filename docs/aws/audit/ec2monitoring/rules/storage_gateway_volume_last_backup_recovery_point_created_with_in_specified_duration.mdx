---
slug: storage_gateway_volume_last_backup_recovery_point_created_with_in_specified_duration
title: Storage Gateway Volume Last Backup Recovery Point Should Be Created Within Specified Duration
sidebar_label: Storage Gateway Volume Last Backup Recovery Point Within Specified Duration
---

### More Info:

This rule ensures that the last backup recovery point for Storage Gateway volumes is created within the specified duration. 

### Risk Level

High

### Address

Configuration

### Compliance Standards

CBP,SEBI



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the AWS Storage Gateway service.
3. In the navigation pane, select "Volumes".
4. For each volume listed, check the "Last Backup" column. This will show the date and time of the last backup recovery point. If this date and time is outside of your specified duration, then there is a misconfiguration.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is installed and configured, you can use the `list-volumes` command to list all the volumes in your AWS account. The command is as follows:

   ```
   aws storagegateway list-volumes --gateway-arn <gateway-arn>
   ```
   Replace `<gateway-arn>` with the ARN of your gateway. This command will return a list of all volumes associated with the specified gateway.

3. For each volume, you can use the `describe-tape-recovery-points` command to get the details of the last recovery point. The command is as follows:

   ```
   aws storagegateway describe-tape-recovery-points --gateway-arn <gateway-arn> --tape-arn <volume-arn>
   ```
   Replace `<gateway-arn>` with the ARN of your gateway and `<volume-arn>` with the ARN of the volume. This command will return the details of the recovery points for the specified volume.

4. Finally, you can check the `TapeRecoveryPointInfos` field in the output of the `describe-tape-recovery-points` command. This field contains the details of the recovery points, including the time when the last recovery point was created. If the last recovery point was created more than the specified duration ago, then there is a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Configure AWS Credentials: You need to configure your AWS credentials. You can configure credentials by using the AWS CLI or by directly setting your access keys as environment variables in your Python script:

   ```python
   import boto3

   aws_access_key_id = 'YOUR_ACCESS_KEY'
   aws_secret_access_key = 'YOUR_SECRET_KEY'
   aws_session_token = 'YOUR_SESSION_TOKEN' # optional

   session = boto3.Session(
       aws_access_key_id=aws_access_key_id,
       aws_secret_access_key=aws_secret_access_key,
       aws_session_token=aws_session_token,
   )
   ```

3. Connect to the EC2 service: Once your credentials are set up, you can connect to the EC2 service. You can do this by creating an EC2 resource object using the session object you created in the previous step:

   ```python
   ec2_resource = session.resource('ec2')
   ```

4. Check the last backup recovery point: Now you can check the last backup recovery point of your Storage Gateway Volume. You can do this by calling the `describe_volumes` method on your EC2 resource object and then checking the `LastBackupTime` attribute of each volume:

   ```python
   volumes = ec2_resource.describe_volumes()
   for volume in volumes['Volumes']:
       last_backup_time = volume['LastBackupTime']
       print(f'Volume ID: {volume["VolumeId"]}, Last Backup Time: {last_backup_time}')
   ```

   This will print out the volume ID and the last backup time for each of your volumes. If the last backup time is not within the specified duration, then you have detected a misconfiguration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To ensure that the last backup recovery point for Storage Gateway volumes is created within the specified duration, follow these steps using the AWS Management Console:

1. **Access the AWS Management Console**: Go to the AWS Management Console at https://aws.amazon.com/ and log in with your credentials.

2. **Navigate to AWS Storage Gateway**: Click on the "Services" dropdown menu at the top of the console, then select "Storage Gateway" under the "Storage" section.

3. **Select Volumes**: In the Storage Gateway dashboard, click on "Volumes" from the left-hand navigation pane.

4. **Identify Volumes with No Recent Recovery Points**: Review the list of volumes and identify those that do not have a recent backup recovery point created within the specified duration.

5. **Take Manual Backup**: For each volume identified, manually initiate a backup to create a new recovery point within the specified duration.
   
6. **Monitor Backups**: Regularly monitor the backup status and ensure that new recovery points are created within the specified duration for all volumes.

By following these steps, you can ensure that the last backup recovery point for Storage Gateway volumes is created within the specified duration using the AWS Management Console.

#### Using CLI

To remediate the misconfiguration of Storage Gateway volumes not having recovery points created within the specified duration in AWS using AWS CLI, you can follow these steps:

1. **Identify the Storage Gateway Volumes**:
   - Use the `list-gateways` command to list all Storage Gateways in your account.
     ```bash
     aws storagegateway list-gateways
     ```

2. **Create a Recovery Point for the Volume**:
   - Use the `start-gateway` command to create a recovery point for the Storage Gateway volume.
     ```bash
     aws storagegateway start-gateway --gateway-arn <gateway-arn> --volume-arn <volume-arn>
     ```
   - Replace `<gateway-arn>` with the ARN of your Storage Gateway and `<volume-arn>` with the ARN of the volume for which you want to create a recovery point.

3. **Verify Backup Status**:
   - Use the `describe-scheduled-filesystem-operations` command to check the status of the backup operation.
     ```bash
     aws storagegateway describe-scheduled-filesystem-operations --gateway-arn <gateway-arn> --volume-arn <volume-arn>
     ```
   - Replace `<gateway-arn>` with the ARN of your Storage Gateway and `<volume-arn>` with the ARN of the volume.

By following these steps, you can remediate the misconfiguration of Storage Gateway volumes not having recovery points created within the specified duration in AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration of Storage Gateway volumes not having recovery points created within the specified duration in AWS using Python, you can follow these steps:

1. **Install Boto3**: Boto3 is the Amazon Web Services (AWS) SDK for Python. You can install it using pip:
   ```bash
   pip install boto3
```

2. Configure AWS credentials:
Make sure you have AWS credentials configured on your system. You can set it up by running:
```bash
aws configure
```

3. **Create a Python script**: Create a Python script with the following code to create a recovery point for the Storage Gateway volume.

```python
import boto3

# Initialize the Boto3 client for Storage Gateway
storage_gateway_client = boto3.client('storagegateway', region_name='your_aws_region')

# Specify the ARN of the Storage Gateway volume
volume_arn = 'your_volume_arn'

# Create a recovery point for the volume
response = storage_gateway_client.start_gateway_recovery_point_creation(
    GatewayARN='your_gateway_arn',
    VolumeARN=volume_arn
)

print("Recovery point creation initiated for volume with ARN:", volume_arn)

```

Replace placeholders: Replace 'your_aws_region' with the AWS region where your Storage Gateway is located, 'your_volume_arn' with the ARN of your Storage Gateway volume, and 'your_gateway_arn' with the ARN of your Storage Gateway.

4. **Run the Python Script**:
   - Execute the Python script in your local environment or on an EC2 instance with appropriate IAM roles that have permissions to modify Storage Gateway configurations.
     ```bash
     python your_script.py
     ```

By following these steps, you can remediate the misconfiguration of Storage Gateway volumes not having recovery points created within the specified duration in AWS using Python.
</Tab>
</Tabs>