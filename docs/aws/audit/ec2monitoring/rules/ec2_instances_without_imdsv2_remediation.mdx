
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of not requiring IMDSv2 (Instance Metadata Service Version 2) for EC2 instances using the AWS Management Console, follow these steps:

1. **Navigate to EC2 Dashboard:**
   - Open the AWS Management Console.
   - In the top navigation bar, select "Services" and then choose "EC2" under the "Compute" section.

2. **Select Instances:**
   - In the EC2 Dashboard, click on "Instances" in the left-hand navigation pane to view your list of EC2 instances.

3. **Modify Instance Metadata Options:**
   - Select the instance for which you want to require IMDSv2.
   - Click on the "Actions" button, then choose "Instance Settings" and select "Modify Instance Metadata Options."

4. **Enable IMDSv2 Requirement:**
   - In the "Modify Instance Metadata Options" dialog, set the "Metadata version" to "IMDSv2 only."
   - Ensure that "Http tokens" is set to "required."
   - Click the "Save" button to apply the changes.

By following these steps, you ensure that the selected EC2 instance requires the use of IMDSv2, enhancing the security of your instance metadata.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not requiring IMDSv2 (Instance Metadata Service Version 2) for EC2 instances using the AWS CLI, follow these steps:

1. **Describe the EC2 Instances:**
   First, identify the EC2 instances for which you want to enforce IMDSv2. You can list all instances or filter based on specific criteria.
   ```sh
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].InstanceId'
   ```

2. **Modify Instance Metadata Options:**
   Use the `modify-instance-metadata-options` command to enforce the use of IMDSv2 for a specific instance. Replace `<instance-id>` with the actual instance ID.
   ```sh
   aws ec2 modify-instance-metadata-options --instance-id <instance-id> --http-tokens required
   ```

3. **Verify the Configuration:**
   After modifying the instance metadata options, verify that the changes have been applied correctly.
   ```sh
   aws ec2 describe-instances --instance-id <instance-id> --query 'Reservations[*].Instances[*].MetadataOptions'
   ```

4. **Automate for Multiple Instances:**
   If you need to apply this setting to multiple instances, you can use a loop in a shell script. For example:
   ```sh
   instance_ids=$(aws ec2 describe-instances --query 'Reservations[*].Instances[*].InstanceId' --output text)
   for instance_id in $instance_ids; do
       aws ec2 modify-instance-metadata-options --instance-id $instance_id --http-tokens required
   done
   ```

By following these steps, you can ensure that all specified EC2 instances require IMDSv2, enhancing the security of your instance metadata.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not requiring IMDSv2 (Instance Metadata Service Version 2) for EC2 instances in AWS using Python scripts, you can follow these steps:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed, which is the AWS SDK for Python. You can install it using pip if you haven't already.

   ```bash
   pip install boto3
   ```

2. **Create a Boto3 Session**:
   Initialize a Boto3 session with the necessary AWS credentials and region.

   ```python
   import boto3

   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='YOUR_REGION'
   )
   ec2_client = session.client('ec2')
   ```

3. **Describe EC2 Instances**:
   Retrieve the list of EC2 instances to check their current metadata options.

   ```python
   response = ec2_client.describe_instances()
   instances = response['Reservations']
   ```

4. **Update Metadata Options to Require IMDSv2**:
   Iterate through the instances and update their metadata options to require IMDSv2.

   ```python
   for reservation in instances:
       for instance in reservation['Instances']:
           instance_id = instance['InstanceId']
           ec2_client.modify_instance_metadata_options(
               InstanceId=instance_id,
               HttpTokens='required'
           )
           print(f"Updated instance {instance_id} to require IMDSv2")
   ```

Here is the complete script:

```python
import boto3

# Initialize a Boto3 session
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
ec2_client = session.client('ec2')

# Describe EC2 instances
response = ec2_client.describe_instances()
instances = response['Reservations']

# Update metadata options to require IMDSv2
for reservation in instances:
    for instance in reservation['Instances']:
        instance_id = instance['InstanceId']
        ec2_client.modify_instance_metadata_options(
            InstanceId=instance_id,
            HttpTokens='required'
        )
        print(f"Updated instance {instance_id} to require IMDSv2")
```

### Summary of Steps:
1. Install the Boto3 library.
2. Create a Boto3 session with AWS credentials and region.
3. Describe EC2 instances to get their current metadata options.
4. Update each instance to require IMDSv2 by modifying their metadata options.

This script ensures that all your EC2 instances are configured to require IMDSv2, thereby enhancing the security of your instance metadata.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and open the Amazon EC2 dashboard.

2. In the navigation pane, under "Instances", click on "Instances".

3. Select the EC2 instance that you want to check.

4. In the bottom panel, click on the "Security" tab.

5. Under "Instance Metadata", check the "Metadata version" field. If it is set to "IMDSv1", then IMDSv2 is not required for this EC2 instance. If it is set to "IMDSv2", then IMDSv2 is required.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the EC2 instances.

2. Once the AWS CLI is set up, you can use the following command to list all the EC2 instances in your account:

   ```
   aws ec2 describe-instances
   ```

3. After getting the list of instances, you need to check the metadata options for each instance. You can do this by using the following command:

   ```
   aws ec2 describe-instances --instance-ids <instance-id> --query "Reservations[].Instances[].MetadataOptions"
   ```

   Replace `<instance-id>` with the ID of the instance you want to check.

4. The output of the above command will show the metadata options for the specified instance. If the `HttpTokens` field is set to `required`, it means that IMDSv2 is required for the instance. If it's set to `optional`, it means that IMDSv2 is not required.

Please note that the above steps will only check the IMDSv2 requirement for a single instance. If you want to check all instances, you will need to run the command in step 3 for each instance. You can automate this process by using a script.
</Accordion>

<Accordion title='Using Python'>
To check if EC2 instances require Instance Metadata Service Version 2 (IMDSv2), you can use the Boto3 library in Python, which allows you to directly interact with AWS services, including EC2. Here are the steps:

1. **Import the necessary libraries and establish a session with AWS:**

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```
Replace 'YOUR_ACCESS_KEY', 'YOUR_SECRET_KEY', and 'YOUR_REGION' with your actual AWS credentials and the region you want to check.

2. **Create an EC2 resource object using the session:**

```python
ec2_resource = session.resource('ec2')
```

3. **Iterate over all instances and check the metadata options:**

```python
for instance in ec2_resource.instances.all():
    metadata_options = instance.describe_attribute(Attribute='metadataOptions')
    http_tokens = metadata_options['MetadataOptions']['HttpTokens']
    if http_tokens == 'optional':
        print(f"Instance {instance.id} does not require IMDSv2")
```
This script will print out the IDs of all instances that do not require IMDSv2.

4. **Handle exceptions:**

While interacting with AWS services, it's a good practice to handle exceptions that might occur due to reasons like network issues, insufficient permissions, etc. You can use the `botocore.exceptions` module for this.

```python
from botocore.exceptions import NoCredentialsError

try:
    # Your code here
except NoCredentialsError:
    print("No AWS credentials found")
```
This will print a helpful error message if the script is unable to find your AWS credentials.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the "Require IMDSv2 for EC2 Instances" misconfiguration in AWS using the AWS console, follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the EC2 dashboard.
3. Select the EC2 instance that needs to be remediated.
4. Click on the "Actions" button and select "Instance Settings" and then click on "Modify IAM Role".
5. In the "Modify IAM Role" dialog box, select "Require IMDSv2" and click "Save".
6. Verify the configuration by checking the "IMDSv2" column in the EC2 instances view. It should show "Enabled".

By following these steps, you have successfully remediated the "Require IMDSv2 for EC2 Instances" misconfiguration in AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
The Instance Metadata Service (IMDS) is a service provided by Amazon Web Services (AWS) that allows EC2 instances to retrieve metadata about themselves and their environment. IMDSv2 is a newer version of the service that provides additional security features. 

To remediate the "Require IMDSv2 for EC2 Instances" misconfiguration in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine or EC2 instance with appropriate IAM permissions.
2. Run the following command to enable IMDSv2 on all running EC2 instances in the current region:
```
aws ec2 modify-instance-metadata-options --instance-id $(curl -s http://169.254.169.254/latest/meta-data/instance-id) --http-put-response-hop-limit 1 --http-endpoint enabled
```
This command uses the `modify-instance-metadata-options` API to enable IMDSv2 on the current EC2 instance by passing `--http-endpoint enabled` and `--http-put-response-hop-limit 1` parameters.

3. To enable IMDSv2 on all new EC2 instances launched in the current region, run the following command:
```
aws ec2 modify-instance-metadata-options --http-put-response-hop-limit 1 --http-endpoint enabled
```
This command uses the `modify-instance-metadata-options` API to enable IMDSv2 on all new EC2 instances launched in the current region by passing `--http-endpoint enabled` and `--http-put-response-hop-limit 1` parameters.

4. Verify that the IMDSv2 is enabled on the EC2 instance by running the following command:
```
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
```
This command should return the security credentials associated with the instance's IAM role, indicating that IMDSv2 is enabled.

By following these steps, you can remediate the "Require IMDSv2 for EC2 Instances" misconfiguration in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
The Instance Metadata Service (IMDS) is a service provided by AWS that allows EC2 instances to retrieve information about themselves and their environment. IMDSv1 is the default version of the service, but it has some security vulnerabilities that can be exploited by attackers. IMDSv2 is a more secure version of the service that addresses these vulnerabilities. 

To remediate the "Require IMDSv2 For EC2 Instances" misconfiguration in AWS using Python, you can follow these steps:

1. Install the AWS SDK for Python (Boto3) using pip:

```
pip install boto3
```

2. Create a new Python script and import the necessary libraries:

```python
import boto3
from botocore.exceptions import ClientError
```

3. Create a new session and EC2 client:

```python
session = boto3.Session()
ec2_client = session.client('ec2')
```

4. Get a list of all EC2 instances in your account:

```python
response = ec2_client.describe_instances()
instances = [i for r in response['Reservations'] for i in r['Instances']]
```

5. For each instance, check if IMDSv2 is already enabled:

```python
for instance in instances:
    instance_id = instance['InstanceId']
    try:
        response = ec2_client.describe_instance_attribute(
            InstanceId=instance_id,
            Attribute='instanceMetadataOptions'
        )
        imds_mode = response['InstanceMetadataOptions']['HttpEndpoint']
        if imds_mode == 'enabled' and response['InstanceMetadataOptions']['HttpTokens'] == 'required':
            print(f"IMDSv2 already enabled for instance {instance_id}")
            continue
    except ClientError as e:
        if e.response['Error']['Code'] == 'InvalidInstanceID.NotFound':
            print(f"Instance {instance_id} not found")
            continue
        else:
            raise e
```

6. If IMDSv2 is not enabled, update the instance attribute to enable it:

```python
response = ec2_client.modify_instance_metadata_options(
    InstanceId=instance_id,
    HttpEndpoint='enabled',
    HttpTokens='required'
)
print(f"IMDSv2 enabled for instance {instance_id}")
```

7. Save and run the Python script to remediate the misconfiguration.

Note: This script assumes that you have the necessary permissions to modify EC2 instance attributes in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
