
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, select "Instances" to view all the EC2 instances.
3. For each instance, check the "Monitoring" tab. This tab provides metrics about CPU utilization, Disk reads and writes, Network packets, etc. 
4. If the CPU utilization is consistently low (below 20% for example), the instance may be underutilized. Similarly, if the Disk reads/writes and Network packets are low, it could also indicate underutilization.
</Accordion>

<Accordion title='Using CLI'>
1. **Install and Configure AWS CLI**: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. **List all EC2 Instances**: Use the AWS CLI command `aws ec2 describe-instances` to list all the EC2 instances in your account. This command will return a JSON output with details about all your instances.

3. **Check CPU Utilization**: To check the CPU utilization of your EC2 instances, you can use the CloudWatch `get-metric-statistics` command. The command will look something like this: 

    ```
    aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization --dimensions Name=InstanceId,Value=instance_id --start-time 2021-01-01T00:00:00Z --end-time 2021-01-02T23:59:59Z --period 3600 --statistics Maximum --unit Percent
    ```

    Replace `instance_id` with the ID of your EC2 instance, and adjust the `start-time` and `end-time` parameters to the period you want to check. This command will return the maximum CPU utilization for each hour in the specified period.

4. **Analyze the Output**: The output of the `get-metric-statistics` command will include a `Datapoints` array with the maximum CPU utilization for each hour. If the CPU utilization is consistently low (e.g., less than 20%), the EC2 instance may be underutilized.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3):
   You need to install Boto3 in your Python environment. You can do this using pip:
   ```
   pip install boto3
   ```
   Then, configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config:
   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```
   ```
   [default]
   region=us-east-1
   ```

2. Use Boto3 to connect to AWS EC2:
   You can use Boto3 to create an EC2 resource object using the AWS credentials:
   ```python
   import boto3

   ec2 = boto3.resource('ec2')
   ```

3. Retrieve and analyze EC2 instances:
   You can use the EC2 resource object to retrieve all EC2 instances and analyze their utilization:
   ```python
   instances = ec2.instances.all()

   for instance in instances:
       # Get instance id and type
       instance_id = instance.id
       instance_type = instance.instance_type

       # Get CloudWatch metrics for the instance
       cloudwatch = boto3.client('cloudwatch')
       metrics = cloudwatch.get_metric_statistics(
           Namespace='AWS/EC2',
           MetricName='CPUUtilization',
           Dimensions=[
               {
                   'Name': 'InstanceId',
                   'Value': instance_id
               },
           ],
           StartTime=datetime.datetime.utcnow() - datetime.timedelta(seconds=600),
           EndTime=datetime.datetime.utcnow(),
           Period=300,
           Statistics=['Average']
       )

       # Check if the instance is underutilized
       if metrics['Datapoints']:
           cpu_utilization = metrics['Datapoints'][0]['Average']
           if cpu_utilization < 20.0:  # You can adjust this threshold as needed
               print(f"Instance {instance_id} of type {instance_type} is underutilized with CPU utilization of {cpu_utilization}%")
   ```

4. Regularly run the script:
   You should regularly run this script to monitor your EC2 instances. You can do this manually, or you can automate it using a cron job or a similar scheduling tool.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of underutilized EC2 instances in AWS, you can follow the below steps:

1. Log in to your AWS Management Console.
2. Go to the EC2 Dashboard.
3. Click on the "Instances" option from the left-hand side menu.
4. Select the underutilized EC2 instance(s) that you want to remediate.
5. Click on the "Actions" button and select "Create Image" from the dropdown list.
6. Enter the required details for creating an image of the instance and click on the "Create Image" button.
7. Once the image is created, go to the "AMIs" section from the left-hand side menu.
8. Select the newly created AMI and click on the "Launch" button.
9. Follow the on-screen instructions to launch a new instance from the AMI.
10. Once the new instance is launched, you can terminate the underutilized instance(s) to save costs.

By creating an AMI of the underutilized EC2 instance and launching a new instance from it, you can ensure that the new instance is properly configured and optimized for your workload. This will help you avoid underutilization of your EC2 instances and reduce your AWS costs.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate EC2 instances that are underutilized in AWS using AWS CLI, you can follow these steps:

1. Identify the underutilized EC2 instances by checking their CPU utilization metrics. You can use the following AWS CLI command to get the CPU utilization metrics for all running instances in your account:

```
aws cloudwatch get-metric-statistics --namespace "AWS/EC2" --metric-name "CPUUtilization" --dimensions "Name=InstanceId,Value=INSTANCE_ID" --start-time START_TIME --end-time END_TIME --period 300 --statistics "Average"
```

Replace INSTANCE_ID with the ID of the instance you want to check, START_TIME and END_TIME with the time range you want to check.

2. Once you have identified the underutilized instances, you can take the following actions:

- Resize the instance: If the instance is underutilized because it has too few resources, you can resize the instance to a larger size using the `modify-instance-attribute` AWS CLI command.

```
aws ec2 modify-instance-attribute --instance-id INSTANCE_ID --instance-type INSTANCE_TYPE
```

Replace INSTANCE_ID with the ID of the instance you want to resize and INSTANCE_TYPE with the new instance type.

- Terminate the instance: If the instance is underutilized because it is no longer needed, you can terminate the instance using the `terminate-instances` AWS CLI command.

```
aws ec2 terminate-instances --instance-ids INSTANCE_ID
```

Replace INSTANCE_ID with the ID of the instance you want to terminate.

3. Monitor the CPU utilization metrics of your instances regularly to ensure they are not underutilized or overutilized. You can set up CloudWatch alarms to notify you when the CPU utilization exceeds or falls below a certain threshold.

By following these steps, you can remediate the misconfiguration of underutilized EC2 instances in AWS.
</Accordion>

<Accordion title='Using Python'>
To remediate EC2 instances that are underutilized in AWS using Python, you can follow the below steps:

1. Identify underutilized instances: 
   - Use AWS SDK for Python (Boto3) to get the list of all EC2 instances.
   - For each instance, get its CPU utilization metric using CloudWatch.
   - If the average CPU utilization is below a certain threshold (e.g. 20%) for a certain period (e.g. 7 days), mark the instance as underutilized.

2. Stop underutilized instances:
   - Use Boto3 to stop the identified underutilized instances.
   - Before stopping the instance, make sure that it is not being used for any critical application or service.

3. Schedule start/stop instances:
   - Use AWS Lambda and CloudWatch Events to schedule start/stop instances based on the usage pattern.
   - For example, you can start instances during peak hours and stop them during off-hours to save costs.

4. Resize underutilized instances:
   - Use AWS Auto Scaling to resize instances based on their usage pattern.
   - For example, you can increase the instance size during peak hours and decrease it during off-hours to optimize costs.

5. Monitor and optimize:
   - Monitor the instances regularly to ensure that they are not underutilized or overutilized.
   - Optimize the instances based on the usage pattern and workload requirements to minimize costs and maximize performance.

Note: It is important to ensure that the remediation process does not affect the availability and performance of critical applications or services running on the EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
