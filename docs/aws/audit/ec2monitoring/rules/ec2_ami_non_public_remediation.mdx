
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.

2. In the navigation pane, choose 'AMIs'.

3. In the table, find the AMI that you want to check. The 'Visibility' column indicates whether the AMI is public or private.

4. If the 'Visibility' column shows 'Public', then the AMI is publicly accessible. If it shows 'Private', then the AMI is not publicly accessible.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all AMIs: Use the `describe-images` command to list all the AMIs available in your AWS account. The command is as follows:

   ```
   aws ec2 describe-images --owners self
   ```
   This command will return a JSON output with details of all the AMIs.

3. Check the permissions of each AMI: In the JSON output, look for the `Public` field under `ImageAttribute`. If the value of `Public` is `true`, then the AMI is public. Here is a sample command to check if an AMI is public:

   ```
   aws ec2 describe-image-attribute --image-id <your-ami-id> --attribute launchPermission
   ```
   Replace `<your-ami-id>` with the ID of your AMI.

4. Automate the process: If you have many AMIs, it would be tedious to check each one manually. You can write a script to automate the process. Here is a sample Python script using the boto3 library:

   ```python
   import boto3

   ec2 = boto3.client('ec2')

   response = ec2.describe_images(Owners=['self'])

   for image in response['Images']:
       image_id = image['ImageId']
       attribute = ec2.describe_image_attribute(
           ImageId=image_id,
           Attribute='launchPermission'
       )
       if attribute['LaunchPermissions']:
           for permission in attribute['LaunchPermissions']:
               if 'Group' in permission and permission['Group'] == 'all':
                   print(f"AMI {image_id} is public")
   ```
   This script will print the IDs of all public AMIs.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: To interact with AWS services, you need to install the Boto3 library. You can install it using pip:

   ```
   pip install boto3
   ```

2. Configure AWS credentials: Before you can interact with AWS services, you need to set up your AWS credentials. You can do this by creating a file at ~/.aws/credentials. At the very least, the contents of the file should be:

   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. Write a Python script to check for public AMIs: The following script will list all AMIs and check if they are public. If an AMI is public, it will print out its ID.

   ```python
   import boto3

   def check_public_amis():
       ec2 = boto3.resource('ec2')
       images = ec2.images.filter(Owners=['self'])

       for image in images:
           if image.public == True:
               print(f'Public AMI detected: {image.id}')

   if __name__ == '__main__':
       check_public_amis()
   ```

4. Run the script: You can run the script using the Python interpreter. The script will print out the IDs of any public AMIs it finds.

   ```
   python check_public_amis.py
   ```

This script will only check for public AMIs in the default region. If you have AMIs in other regions, you will need to modify the script to check those regions as well.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the steps to remediate the issue of EC2 AMIs being public in AWS using the AWS console:

1. Login to your AWS console.

2. Go to the EC2 dashboard.

3. Click on the "AMIs" option in the left-hand menu.

4. Select the AMI that you want to remediate.

5. Click on the "Modify Image Permissions" button.

6. In the "Modify Image Permissions" dialog box, select "Private" as the new permission.

7. Click on the "Save" button to apply the new permission.

8. Repeat the above steps for all the public AMIs that you want to remediate.

9. Once you have changed the permissions for all the public AMIs, verify that they are no longer public by checking the "Permissions" column in the AMIs dashboard.

10. If any AMIs are still public, repeat the above steps for those AMIs.

By following the above steps, you can remediate the issue of EC2 AMIs being public in AWS and ensure that your AMIs are only accessible to authorized users.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "EC2 AMIs Should Not Be Public" for AWS using AWS CLI, follow these steps:

1. Log in to your AWS account and open the AWS CLI.

2. Run the following command to check if there are any public AMIs in your AWS account:

   ```
   aws ec2 describe-images --owners self --filters "Name=is-public,Values=true"
   ```

3. If there are any public AMIs, you can make them private by running the following command:

   ```
   aws ec2 modify-image-attribute --image-id <image-id> --launch-permission "{\"Remove\": [{\"Group\":\"all\"}]}"
   ```

   Replace `<image-id>` with the ID of the AMI you want to make private.

4. After running the command, verify that the AMI is no longer public by running the following command:

   ```
   aws ec2 describe-images --owners self --filters "Name=image-id,Values=<image-id>" "Name=is-public,Values=false"
   ```

   Replace `<image-id>` with the ID of the AMI you just made private.

5. Repeat steps 3-4 for all public AMIs in your AWS account.

6. Once you have made all the necessary AMIs private, you can prevent future public AMIs by setting the default AMI permissions to private. Run the following command:

   ```
   aws ec2 modify-image-attribute --attribute launchPermission --value "{\"Add\": [{\"Group\":\"self\"}]}" --image-id ami-00000000000000000
   ```

   Replace `ami-00000000000000000` with the ID of any private AMI in your account.

7. After running the command, verify that the default AMI permissions have been set to private by running the following command:

   ```
   aws ec2 describe-image-attribute --attribute launchPermission --image-id ami-00000000000000000
   ```

   Replace `ami-00000000000000000` with the ID of the AMI you used in step 6.

By following these steps, you can remediate the "EC2 AMIs Should Not Be Public" misconfiguration for AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of EC2 AMIs being public in AWS using Python, you can follow the below steps:

Step 1: Identify the public EC2 AMIs in your AWS account using boto3 library in Python. 

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_images(
    Filters=[
        {
            'Name': 'is-public',
            'Values': [
                'true',
            ]
        },
    ]
)

for image in response['Images']:
    print('Public AMI ID: ' + image['ImageId'])
```

Step 2: Deregister the public EC2 AMIs using the `deregister_image()` method.

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_images(
    Filters=[
        {
            'Name': 'is-public',
            'Values': [
                'true',
            ]
        },
    ]
)

for image in response['Images']:
    print('Deregistering public AMI ID: ' + image['ImageId'])
    ec2.deregister_image(ImageId=image['ImageId'])
```

Step 3: Modify the EC2 AMI permissions to make them private using the `modify_image_attribute()` method.

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_images(
    Filters=[
        {
            'Name': 'is-public',
            'Values': [
                'true',
            ]
        },
    ]
)

for image in response['Images']:
    print('Making private AMI ID: ' + image['ImageId'])
    ec2.modify_image_attribute(
        ImageId=image['ImageId'],
        LaunchPermission={
            'Remove': [
                {
                    'Group': 'all',
                },
            ],
        },
    )
```

Note: Before making any changes to your AWS account, it is recommended to test the code in a non-production environment and ensure that it is working as expected.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
