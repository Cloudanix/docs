---
slug: ec2_resources_protected_by_backup_plan
title: EC2 Instances Should Have Backup Plan Protection 
sidebar_label: EC2 Instances Should Have Backup Plan Protection 
---

### More Info:

This rule checks if Amazon Elastic Compute Cloud (Amazon EC2) instances are protected by a backup plan. The rule is NON_COMPLIANT if the Amazon EC2 instance is not covered by a backup plan.

### Risk Level

High

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 instances from lacking a backup plan protection in AWS using the AWS Management Console, follow these steps:

1. **Create an IAM Role for Backup:**
   - Navigate to the IAM service in the AWS Management Console.
   - Create a new role with the necessary permissions for AWS Backup. Attach the `AWSBackupServiceRolePolicyForBackup` managed policy to this role.

2. **Set Up AWS Backup Plan:**
   - Go to the AWS Backup service in the AWS Management Console.
   - Create a new backup plan by specifying the backup rules, such as frequency, backup window, and lifecycle policies.
   - Define the resources to be backed up, including EC2 instances.

3. **Assign Resources to Backup Plan:**
   - In the AWS Backup console, navigate to the "Assign resources" section.
   - Select the EC2 instances you want to include in the backup plan.
   - Assign the previously created IAM role to these resources to allow AWS Backup to manage backups for these instances.

4. **Enable Backup Monitoring and Notifications:**
   - Set up monitoring and notifications for backup jobs in the AWS Backup console.
   - Configure Amazon CloudWatch Alarms and SNS topics to receive notifications about backup job statuses, ensuring you are alerted to any issues or failures in the backup process.

By following these steps, you can ensure that your EC2 instances have a robust backup plan in place, reducing the risk of data loss due to misconfigurations.
</Accordion>

<Accordion title='Using CLI'>
To prevent EC2 instances from lacking a backup plan protection using AWS CLI, you can follow these steps:

1. **Create an IAM Role for Backup**:
   Ensure you have an IAM role with the necessary permissions to create and manage backups. This role will be used by AWS Backup to perform backup operations.

   ```sh
   aws iam create-role --role-name BackupRole --assume-role-policy-document file://trust-policy.json
   aws iam attach-role-policy --role-name BackupRole --policy-arn arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup
   ```

2. **Create a Backup Plan**:
   Define a backup plan that specifies when and how frequently backups should be taken.

   ```sh
   aws backup create-backup-plan --backup-plan file://backup-plan.json
   ```

   Example `backup-plan.json`:
   ```json
   {
     "BackupPlanName": "MyBackupPlan",
     "Rules": [
       {
         "RuleName": "DailyBackup",
         "TargetBackupVaultName": "Default",
         "ScheduleExpression": "cron(0 12 * * ? *)",
         "StartWindowMinutes": 60,
         "CompletionWindowMinutes": 180,
         "Lifecycle": {
           "DeleteAfterDays": 30
         }
       }
     ]
   }
   ```

3. **Assign Resources to the Backup Plan**:
   Assign your EC2 instances to the backup plan by specifying their resource ARNs.

   ```sh
   aws backup create-backup-selection --backup-plan-id <backup-plan-id> --backup-selection file://backup-selection.json
   ```

   Example `backup-selection.json`:
   ```json
   {
     "SelectionName": "MyEC2BackupSelection",
     "IamRoleArn": "arn:aws:iam::<account-id>:role/BackupRole",
     "Resources": [
       "arn:aws:ec2:<region>:<account-id>:instance/<instance-id>"
     ]
   }
   ```

4. **Verify Backup Plan and Selection**:
   Ensure that the backup plan and selection are correctly configured and active.

   ```sh
   aws backup list-backup-plans
   aws backup list-backup-selections --backup-plan-id <backup-plan-id>
   ```

By following these steps, you can ensure that your EC2 instances have a backup plan in place, thereby preventing the misconfiguration of lacking backup protection.
</Accordion>

<Accordion title='Using Python'>
To prevent EC2 instances from lacking a backup plan protection using Python scripts, you can automate the creation and management of backups using AWS SDK for Python (Boto3). Here are the steps:

1. **Install Boto3**:
   Ensure you have Boto3 installed in your Python environment. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Create a Backup Plan**:
   Define a backup plan using AWS Backup. This plan will specify the backup rules and schedules.

   ```python
   import boto3

   backup_client = boto3.client('backup')

   backup_plan = {
       'BackupPlanName': 'MyBackupPlan',
       'Rules': [
           {
               'RuleName': 'DailyBackup',
               'TargetBackupVaultName': 'Default',
               'ScheduleExpression': 'cron(0 12 * * ? *)',  # Daily at 12:00 UTC
               'StartWindowMinutes': 60,
               'CompletionWindowMinutes': 180,
               'Lifecycle': {
                   'MoveToColdStorageAfterDays': 30,
                   'DeleteAfterDays': 365
               },
               'RecoveryPointTags': {
                   'Environment': 'Production'
               }
           }
       ]
   }

   response = backup_client.create_backup_plan(
       BackupPlan=backup_plan
   )

   backup_plan_id = response['BackupPlanId']
   print(f"Backup Plan ID: {backup_plan_id}")
   ```

3. **Assign Resources to the Backup Plan**:
   Assign your EC2 instances to the backup plan by creating a backup selection.

   ```python
   backup_selection = {
       'SelectionName': 'EC2BackupSelection',
       'IamRoleArn': 'arn:aws:iam::YOUR_ACCOUNT_ID:role/service-role/AWSBackupDefaultServiceRole',
       'Resources': [
           'arn:aws:ec2:REGION:ACCOUNT_ID:instance/INSTANCE_ID'
       ]
   }

   response = backup_client.create_backup_selection(
       BackupPlanId=backup_plan_id,
       BackupSelection=backup_selection
   )

   print(f"Backup Selection ID: {response['SelectionId']}")
   ```

4. **Automate the Process**:
   Automate the above steps to ensure that any new EC2 instances are automatically added to the backup plan. This can be done by integrating the script with your instance launch process or by periodically running the script to check for new instances.

   ```python
   import time

   def automate_backup_for_new_instances():
       ec2_client = boto3.client('ec2')
       instances = ec2_client.describe_instances()

       instance_ids = []
       for reservation in instances['Reservations']:
           for instance in reservation['Instances']:
               instance_ids.append(instance['InstanceId'])

       backup_selection['Resources'] = [f'arn:aws:ec2:REGION:ACCOUNT_ID:instance/{instance_id}' for instance_id in instance_ids]

       response = backup_client.create_backup_selection(
           BackupPlanId=backup_plan_id,
           BackupSelection=backup_selection
       )

       print(f"Backup Selection ID: {response['SelectionId']}")

   # Run the automation periodically
   while True:
       automate_backup_for_new_instances()
       time.sleep(86400)  # Run daily
   ```

By following these steps, you can ensure that your EC2 instances are always protected by a backup plan, thus preventing the misconfiguration of lacking backup protection.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "INSTANCES", click on "Instances".
3. Select the EC2 instance that you want to check for backup plan protection.
4. In the bottom panel, click on the "Tags" tab. Look for a tag named "Backup" or "Backup Plan". If such a tag does not exist or if it's not properly configured, then the EC2 instance does not have a backup plan protection.
5. Additionally, you can navigate to the AWS Backup service from the AWS Management Console and check if the selected EC2 instance is included in any backup plan. If it's not, then the EC2 instance does not have backup plan protection.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all EC2 instances: Use the following command to list all the EC2 instances in your AWS account:

   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text
   ```
   This command will return a list of all EC2 instance IDs.

3. Check for backup plans: For each EC2 instance ID returned by the previous command, you need to check if there is a backup plan associated with it. You can do this by using the following command:

   ```
   aws backup describe-backup-job --backup-job-id <instance-id>
   ```
   Replace `<instance-id>` with the ID of the EC2 instance you want to check. This command will return information about the backup job associated with the specified EC2 instance. If there is no backup job, the command will return an error.

4. Analyze the output: If the `describe-backup-job` command returns an error for an EC2 instance, it means that there is no backup plan associated with that instance. If the command returns information about a backup job, it means that there is a backup plan associated with the instance. You need to repeat this process for each EC2 instance ID returned by the `describe-instances` command.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing your script, you need to install the AWS SDK for Python (Boto3). You can do this by running the command `pip install boto3` in your terminal.

2. Import the necessary libraries and establish a session: In your Python script, you'll need to import the Boto3 library and establish a session with your AWS account. Here's how you can do that:

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. Connect to the EC2 service: Once you've established a session, you can connect to the EC2 service and retrieve a list of all your instances. Here's how you can do that:

```python
ec2 = session.resource('ec2')

for instance in ec2.instances.all():
    print(instance.id, instance.state)
```

4. Check for backup plans: Now that you have a list of all your instances, you can check each one to see if it has a backup plan. You can do this by checking the tags associated with each instance. If an instance has a tag with the key 'Backup', then it has a backup plan. Here's how you can do that:

```python
for instance in ec2.instances.all():
    tags = {t['Key']: t['Value'] for t in instance.tags or []}
    if 'Backup' not in tags:
        print(f'Instance {instance.id} does not have a backup plan.')
```

This script will print out the ID of any instance that does not have a backup plan.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of EC2 instances not having a backup plan in AWS, you can set up automated backups using Amazon EBS snapshots. Here's a step-by-step guide on how to do this using the AWS Management Console:

1. **Sign in to the AWS Management Console:**
   Go to https://aws.amazon.com/ and sign in to the AWS Management Console using your credentials.

2. **Navigate to the EC2 Dashboard:**
   Click on the "Services" dropdown menu at the top of the page, select "EC2" under the "Compute" section to go to the EC2 Dashboard.

3. **Select the EC2 Instance:**
   In the EC2 Dashboard, select the EC2 instance for which you want to set up automated backups.

4. **Create an Amazon EBS Snapshot:**
   - Select the EBS volume attached to the EC2 instance.
   - Click on the "Actions" dropdown menu, navigate to "Create snapshot" and click on it.
   - Enter a descriptive name for the snapshot and click on "Create snapshot".

5. **Set up Automated Backups:**
   - In the EC2 Dashboard, under the "ELASTIC BLOCK STORE" section, click on "Snapshots".
   - Select the snapshot that you created in the previous step.
   - Click on the "Actions" dropdown menu and select "Create Lifecycle Policy".
   - Enter a name for the policy, set the frequency and retention period for backups, and click on "Create policy".

6. **Monitor Backup Status:**
   - To monitor the backup status, go to the EC2 Dashboard, click on "Instances" in the navigation pane, and select the EC2 instance.
   - Under the "Description" tab, you can view the details of the automated backups and their status.

By following these steps, you have successfully set up automated backups for your EC2 instance using Amazon EBS snapshots, ensuring that you have a backup plan in place for protection.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of EC2 instances not having backup plan protection in AWS using AWS CLI, you can follow these steps:

1. **Identify EC2 Instances**: First, you need to identify the EC2 instances that do not have backup plan protection enabled. You can use the following AWS CLI command to list all EC2 instances in your account:
   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key==`Name`].Value]' --output table
   ```

2. **Enable Backup Plan Protection**: To enable backup plan protection for EC2 instances, you can create a backup plan using AWS Backup service. Here's an example command to create a backup plan:
   ```
   aws backup create-backup-plan --backup-plan '{"BackupPlanName": "MyBackupPlan","BackupPlanRule": {"RuleName": "DefaultRule","TargetBackupVaultName": "MyBackupVault","ScheduleExpression": "cron(0 0 ? * SUN *)","StartWindowMinutes": 60,"CompletionWindowMinutes": 10080,"Lifecycle":{"DeleteAfterDays": 30}}}'
   ```

3. **Assign Backup Plan to EC2 Instances**: Next, you need to assign the backup plan to the EC2 instances. You can use the following AWS CLI command to assign the backup plan to the EC2 instances:
   ```
   aws backup start-restore-job --resource-type EC2_INSTANCE --metadata '{"instanceId": "YOUR_INSTANCE_ID"}' --iam-role-arn "YOUR_IAM_ROLE_ARN" --backup-vault-name "YOUR_BACKUP_VAULT_NAME"
   ```

4. **Verify Backup Plan Protection**: Finally, you should verify that the backup plan protection has been successfully enabled for the EC2 instances. You can check the backup status using the AWS Backup console or the following AWS CLI command:
   ```
   aws backup list-recovery-points-by-backup-vault --backup-vault-name "YOUR_BACKUP_VAULT_NAME"
   ```

By following these steps, you can remediate the misconfiguration of EC2 instances not having backup plan protection enabled in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of EC2 instances not having a backup plan protection in AWS using Python, you can follow these steps:

1. **Identify EC2 Instances**: Use the Boto3 library in Python to list all the EC2 instances in your AWS account.

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_instances()
instances = [instance['InstanceId'] for reservation in response['Reservations'] for instance in reservation['Instances']]
```

2. **Create AMI Backups**: For each identified EC2 instance, create an AMI backup. This will serve as a snapshot of the instance that can be used to restore it if needed.

```python
for instance_id in instances:
    response = ec2.create_image(InstanceId=instance_id, Name='Backup-{}'.format(instance_id), NoReboot=True)
    image_id = response['ImageId']
    print('Created AMI {} for instance {}'.format(image_id, instance_id))
```

3. **Set Up Lifecycle Policies**: Configure lifecycle policies to manage the retention of your AMIs to avoid unnecessary costs and clutter. You can do this using the `create_lifecycle_policy` method in Boto3.

```python
lifecycle_policy = {
    'Description': 'AMI Backup Lifecycle Policy',
    'State': 'ENABLED',
    'PolicyDetails': {
        'ResourceTypes': ['AMI'],
        'TargetTags': [{'Key': 'Backup', 'Value': 'True'}],
        'Schedules': [
            {
                'Name': 'DailyBackup',
                'CopyTags': True,
                'CreateRule': {
                    'Interval': 1,
                    'IntervalUnit': 'DAYS',
                    'Times': ['00:00']
                },
                'RetainRule': {
                    'Count': 7
                }
            }
        ]
    }
}

response = ec2.create_lifecycle_policy(LifecyclePolicy=lifecycle_policy)
policy_id = response['PolicyId']
print('Created Lifecycle Policy {}'.format(policy_id))
```

4. **Automate Backup Process**: Set up a cron job or a Lambda function to automate the backup process at regular intervals.

By following these steps, you can ensure that your EC2 instances have a backup plan protection in place in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

