

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under NETWORK & SECURITY, click on "Security Groups".
3. In the Security Groups page, select the security group associated with your PostgreSQL database.
4. In the lower part of the page, select the "Inbound" tab to view the inbound rules. Check if there are any rules that allow unrestricted access (0.0.0.0/0 or ::/0) to the PostgreSQL default port (5432). If such rules exist, it indicates that unrestricted PostgreSQL access is allowed.

#### Using CLI

1. First, you need to list all the security groups in your AWS account. You can do this by using the following AWS CLI command:

   ```
   aws ec2 describe-security-groups --query 'SecurityGroups[*].[GroupId]' --output text
   ```

2. Once you have the list of all security groups, you need to check the inbound rules for each security group. You can do this by using the following AWS CLI command:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions[*]' --output json
   ```

   Replace `<security-group-id>` with the ID of the security group you want to check.

3. In the output of the above command, look for any rules that allow unrestricted access (0.0.0.0/0) to PostgreSQL (port 5432). If such a rule exists, it means that unrestricted PostgreSQL access is allowed.

4. To automate the above steps, you can write a Python script using the boto3 library. The script would iterate over all security groups and their inbound rules, and print out the IDs of the security groups that allow unrestricted PostgreSQL access. Here is a sample script:

   ```python
   import boto3

   ec2 = boto3.client('ec2')

   response = ec2.describe_security_groups()

   for group in response['SecurityGroups']:
       for permission in group['IpPermissions']:
           if 'FromPort' in permission and permission['FromPort'] == 5432 and 'IpRanges' in permission:
               for range in permission['IpRanges']:
                   if range['CidrIp'] == '0.0.0.0/0':
                       print(f"Unrestricted PostgreSQL access allowed in security group: {group['GroupId']}")
   ```
   
   Run the script using the command: `python3 script_name.py`

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) and psycopg2-binary, which is a PostgreSQL database adapter for Python. You can install these libraries using pip:

```python
pip install boto3 psycopg2-binary
```

2. Connect to AWS: Use Boto3 to connect to AWS. You'll need your access key, secret access key, and the region you're working in. Replace 'your_access_key', 'your_secret_key', and 'your_region' with your actual AWS credentials.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='your_access_key',
    aws_secret_access_key='your_secret_key',
    region_name='your_region'
)
```

3. List all EC2 instances: Use the Boto3 EC2 resource object to list all your EC2 instances. Then, for each instance, get the security group IDs.

```python
ec2_resource = session.resource('ec2')

for instance in ec2_resource.instances.all():
    for sg in instance.security_groups:
        print(sg['GroupId'])
```

4. Check PostgreSQL access: For each security group, check the inbound rules. If a rule allows access to port 5432 (the default PostgreSQL port) from '0.0.0.0/0' (which means any IP address), then unrestricted PostgreSQL access is allowed.

```python
ec2_client = session.client('ec2')

for instance in ec2_resource.instances.all():
    for sg in instance.security_groups:
        response = ec2_client.describe_security_groups(GroupIds=[sg['GroupId']])
        for rule in response['SecurityGroups'][0]['IpPermissions']:
            if rule['FromPort'] == 5432 and '0.0.0.0/0' in [ip['CidrIp'] for ip in rule['IpRanges']]:
                print(f"Unrestricted PostgreSQL access allowed in security group {sg['GroupId']}")
```

This script will print the IDs of the security groups that allow unrestricted PostgreSQL access.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the unrestricted PostgreSQL access issue in AWS, you can follow the below steps:

1. Go to the AWS Management Console and navigate to the RDS dashboard.
2. Select the RDS instance that has unrestricted PostgreSQL access.
3. Click on the "Modify" button.
4. In the "Network & Security" section, select the "Additional Configuration" tab.
5. Under "Security Group Rules," locate the rule that allows unrestricted PostgreSQL access.
6. Remove the rule by clicking on the "x" icon next to it.
7. Add a new rule that allows access only from trusted sources.
8. Click on the "Save Changes" button.

By following these steps, you can remediate the unrestricted PostgreSQL access issue in AWS and ensure that your PostgreSQL database is only accessible from trusted sources.

#### Using CLI

To remediate unrestricted PostgreSQL access in AWS, you can follow these steps using AWS CLI:

1. Open the AWS CLI and run the following command to get the security group ID of the security group associated with the PostgreSQL instance:

   ```
   aws rds describe-db-instances --query 'DBInstances[*].VpcSecurityGroups[*].VpcSecurityGroupId' --output text
   ```

2. Run the following command to get the ID of the security group:

   ```
   aws ec2 describe-security-groups --filters Name=group-id,Values=<security-group-ID> --query 'SecurityGroups[*].{Name:GroupName,ID:GroupId}' --output table
   ```

3. Run the following command to revoke the unrestricted access to PostgreSQL:

   ```
   aws ec2 revoke-security-group-ingress --group-id <security-group-ID> --protocol tcp --port 5432 --cidr 0.0.0.0/0
   ```

   This command will revoke the inbound rule that allows unrestricted access to PostgreSQL.

4. Run the following command to verify that the unrestricted access has been revoked:

   ```
   aws ec2 describe-security-groups --filters Name=group-id,Values=<security-group-ID> --query 'SecurityGroups[*].IpPermissions'
   ```

   This command will show the current inbound rules for the security group. You should see that the rule allowing unrestricted access to PostgreSQL has been removed.

By following these steps, you have successfully remediated the unrestricted PostgreSQL access in AWS.

#### Using Python

To remediate the unrestricted PostgreSQL access issue in AWS, you can use Python to create a security group that allows access to the PostgreSQL instance only from a specific IP address or range of IP addresses. Here are the steps to do so:

1. First, you need to create a new security group that will be used to restrict access to the PostgreSQL instance. You can do this using the `boto3` library in Python. Here's an example code snippet that creates a new security group:

```python
import boto3

ec2 = boto3.resource('ec2')

# Create a new security group
security_group = ec2.create_security_group(
    GroupName='PostgreSQLAccess',
    Description='Restrict access to PostgreSQL instance'
)

# Add a rule to allow access to the PostgreSQL port (5432) from a specific IP address
security_group.authorize_ingress(
    IpPermissions=[
        {
            'IpProtocol': 'tcp',
            'FromPort': 5432,
            'ToPort': 5432,
            'IpRanges': [
                {
                    'CidrIp': 'x.x.x.x/32' # Replace x.x.x.x with the specific IP address you want to allow access from
                }
            ]
        }
    ]
)
```

2. Once you've created the new security group, you need to assign it to the PostgreSQL instance. You can do this using the `modify_db_instance` method from the `boto3` library. Here's an example code snippet that assigns the new security group to the PostgreSQL instance:

```python
import boto3

rds = boto3.client('rds')

# Modify the PostgreSQL instance to use the new security group
response = rds.modify_db_instance(
    DBInstanceIdentifier='your-instance-id', # Replace with your PostgreSQL instance ID
    VpcSecurityGroupIds=[
        security_group.id
    ]
)
```

3. Finally, you can verify that the access to the PostgreSQL instance has been restricted by checking the security group rules associated with the instance. You can do this using the `describe_db_instances` method from the `boto3` library. Here's an example code snippet that checks the security group rules:

```python
import boto3

rds = boto3.client('rds')

# Get the PostgreSQL instance details
response = rds.describe_db_instances(
    DBInstanceIdentifier='your-instance-id' # Replace with your PostgreSQL instance ID
)

# Get the security group IDs associated with the instance
security_group_ids = response['DBInstances'][0]['VpcSecurityGroups']

# Print the security group rules associated with each security group
for security_group_id in security_group_ids:
    response = ec2.describe_security_groups(
        GroupIds=[
            security_group_id['VpcSecurityGroupId']
        ]
    )
    print(response['SecurityGroups'][0]['IpPermissions'])
```

This code will print the security group rules associated with each security group, which should show that access to the PostgreSQL port (5432) is only allowed from the specific IP address or range of IP addresses that you specified in the security group rule.


</Tab>
</Tabs>