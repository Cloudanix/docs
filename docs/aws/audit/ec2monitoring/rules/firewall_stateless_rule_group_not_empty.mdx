---
slug: firewall_stateless_rule_group_not_empty
title: Non-Empty Stateless Network Firewall Rule Groups Should Not Be Present
sidebar_label: Non-Empty Stateless Network Firewall Rule Groups Should Not Be Present
---

### More Info:

This rule checks if a stateless Network Firewall Rule Group contains rules. It ensures that there are rules defined in the stateless Network Firewall Rule Group. The rule is marked as non-compliant if there are no rules in the stateless Network Firewall Rule Group.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent non-empty stateless network firewall rule groups from being present in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to the VPC Dashboard:**
   - Sign in to the AWS Management Console.
   - Open the VPC Dashboard by selecting "VPC" from the "Services" menu.

2. **Access Network Firewall:**
   - In the VPC Dashboard, scroll down to the "Network Firewall" section.
   - Click on "Firewall policies" to view existing firewall policies.

3. **Review Stateless Rule Groups:**
   - Select the firewall policy you want to review.
   - Under the "Stateless rule groups" section, ensure that no non-empty stateless rule groups are attached. If any are present, review their necessity and configuration.

4. **Modify or Remove Unnecessary Rule Groups:**
   - If you find any non-empty stateless rule groups that are not required, select the rule group.
   - Click on "Actions" and choose "Disassociate" to remove the rule group from the firewall policy.

By following these steps, you can ensure that non-empty stateless network firewall rule groups are not present in your EC2 configurations, thereby maintaining a more secure and compliant environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent non-empty stateless network firewall rule groups in EC2 using AWS CLI, you can follow these steps:

1. **Create a Stateless Rule Group with No Rules:**
   Ensure that when you create a stateless rule group, you do not add any rules to it. This can be done using the `create-rule-group` command.

   ```sh
   aws network-firewall create-rule-group \
       --rule-group-name myStatelessRuleGroup \
       --type STATELESS \
       --capacity 100 \
       --rule-group '{"rulesSource": {"statelessRulesAndCustomActions": {"statelessRules": []}}}' \
       --description "Empty stateless rule group"
   ```

2. **List Existing Rule Groups:**
   Regularly list your existing rule groups to ensure that no non-empty stateless rule groups are present.

   ```sh
   aws network-firewall list-rule-groups
   ```

3. **Describe Rule Groups to Verify Rules:**
   For each rule group, describe it to check if it contains any rules. This helps in verifying that the rule groups are indeed empty.

   ```sh
   aws network-firewall describe-rule-group \
       --rule-group-arn <rule-group-arn>
   ```

4. **Automate Checks with a Script:**
   Create a script that automates the process of checking for non-empty stateless rule groups and alerts you if any are found. This can be done using a combination of AWS CLI commands and a scripting language like Python.

   ```python
   import subprocess
   import json

   def list_rule_groups():
       result = subprocess.run(['aws', 'network-firewall', 'list-rule-groups'], capture_output=True, text=True)
       return json.loads(result.stdout)

   def describe_rule_group(rule_group_arn):
       result = subprocess.run(['aws', 'network-firewall', 'describe-rule-group', '--rule-group-arn', rule_group_arn], capture_output=True, text=True)
       return json.loads(result.stdout)

   rule_groups = list_rule_groups()
   for rg in rule_groups['RuleGroups']:
       details = describe_rule_group(rg['RuleGroupArn'])
       if details['RuleGroup']['RulesSource']['StatelessRulesAndCustomActions']['StatelessRules']:
           print(f"Non-empty stateless rule group found: {rg['RuleGroupName']}")
       else:
           print(f"Stateless rule group {rg['RuleGroupName']} is empty.")
   ```

By following these steps, you can ensure that non-empty stateless network firewall rule groups are not present in your EC2 environment using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent non-empty stateless network firewall rule groups in EC2 using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps to achieve this:

1. **Set Up Boto3 and AWS Credentials:**
   Ensure you have Boto3 installed and configured with your AWS credentials.

   ```bash
   pip install boto3
   ```

   Configure your AWS credentials:

   ```bash
   aws configure
   ```

2. **Create a Python Script to List Stateless Rule Groups:**
   Write a script to list all stateless rule groups in your AWS account.

   ```python
   import boto3

   def list_stateless_rule_groups():
       client = boto3.client('network-firewall')
       response = client.list_rule_groups(
           Type='STATELESS'
       )
       return response['RuleGroups']

   stateless_rule_groups = list_stateless_rule_groups()
   print(stateless_rule_groups)
   ```

3. **Check for Non-Empty Rule Groups:**
   Modify the script to check if any of the stateless rule groups are non-empty.

   ```python
   def check_non_empty_stateless_rule_groups():
       client = boto3.client('network-firewall')
       stateless_rule_groups = list_stateless_rule_groups()
       non_empty_groups = []

       for group in stateless_rule_groups:
           group_details = client.describe_rule_group(
               RuleGroupArn=group['Arn'],
               Type='STATELESS'
           )
           if group_details['RuleGroupResponse']['RuleGroupStatus'] != 'INACTIVE':
               non_empty_groups.append(group['Name'])

       return non_empty_groups

   non_empty_stateless_rule_groups = check_non_empty_stateless_rule_groups()
   if non_empty_stateless_rule_groups:
       print("Non-empty stateless rule groups found:", non_empty_stateless_rule_groups)
   else:
       print("All stateless rule groups are empty.")
   ```

4. **Prevent Creation of Non-Empty Stateless Rule Groups:**
   Implement a function to prevent the creation of non-empty stateless rule groups by checking the rules before creating a new group.

   ```python
   def create_stateless_rule_group(rule_group_name, rules):
       if rules:
           raise ValueError("Stateless rule group should not contain any rules.")
       
       client = boto3.client('network-firewall')
       response = client.create_rule_group(
           RuleGroupName=rule_group_name,
           Type='STATELESS',
           RuleGroup={
               'RulesSource': {
                   'StatelessRulesAndCustomActions': {
                       'StatelessRules': []
                   }
               }
           },
           Capacity=100
       )
       return response

   try:
       create_stateless_rule_group('example-rule-group', [])
       print("Stateless rule group created successfully.")
   except ValueError as e:
       print(e)
   ```

By following these steps, you can ensure that non-empty stateless network firewall rule groups are not present in your EC2 environment using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "Network & Security", click on "Network ACLs".
3. In the Network ACLs page, you will see a list of all your Network Access Control Lists. Click on the ID of the Network ACL you want to inspect.
4. In the details pane, under the "Inbound Rules" and "Outbound Rules" tabs, check for any rules that allow all traffic (0.0.0.0/0 in the Source or Destination field). If such rules exist, it indicates that the Network ACL is stateless and is a potential misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI using pip (Python package manager) by running the command `pip install awscli`. After installation, you can configure it by running `aws configure` and providing your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all Network ACLs: You can list all the Network ACLs in your AWS account by running the following command: `aws ec2 describe-network-acls`. This command will return a JSON output with details of all the Network ACLs.

3. Parse the JSON output: You can parse the JSON output to check for any Network ACLs that have stateless rule groups. You can use the `jq` command-line JSON processor for this. The command would look something like this: `aws ec2 describe-network-acls | jq '.NetworkAcls[] | select(.Entries[] | select(.RuleAction == "allow" and .Egress == false and .CidrBlock == "0.0.0.0/0"))'`.

4. Check for Non-Empty Stateless Network Firewall Rule Groups: If the above command returns any Network ACLs, it means that there are Non-Empty Stateless Network Firewall Rule Groups present in your EC2 instances. If the command doesn't return any output, it means that there are no such rule groups present.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3, AWS EC2, and more. You can install it using pip:

```python
pip install boto3
```
Then, configure it using your AWS credentials:

```python
aws configure
AWS Access Key ID [None]: YOUR_ACCESS_KEY
AWS Secret Access Key [None]: YOUR_SECRET_KEY
Default region name [None]: YOUR_REGION
Default output format [None]: json
```

2. Import the necessary modules and create an EC2 resource object using Boto3:

```python
import boto3

ec2 = boto3.resource('ec2')
```

3. Iterate over all the security groups associated with your EC2 instances and check for stateless network firewall rule groups:

```python
for security_group in ec2.security_groups.all():
    if security_group.VpcId is None:  # This is a stateless security group
        for rule in security_group.ip_permissions:
            if rule['IpRanges']:  # This rule is not empty
                print(f"Non-empty stateless network firewall rule group found: {security_group.id}")
```

4. The above script will print the IDs of all non-empty stateless network firewall rule groups. If no such groups are found, it will not print anything. This way, you can easily detect any misconfigurations in your EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the non-empty stateless network firewall rule groups in AWS EC2 using AWS console, follow these steps:

1. **Open the Amazon VPC Console**: Go to the AWS Management Console, navigate to the VPC service.

2. **Navigate to Security Groups**: In the VPC dashboard, click on "Security Groups" in the left-hand menu.

3. **Identify the Security Group**: Identify the security group that has non-empty stateless network firewall rule groups. You can check the rules defined in each security group to find the non-empty ones.

4. **Edit the Security Group**: Select the security group that needs to be remediated and click on the "Inbound Rules" or "Outbound Rules" tab, depending on where the non-empty rule group is present.

5. **Remove Non-Empty Stateless Rules**: Look for any rules that are not required or are unnecessarily broad. To remove a rule, select it and click on the "Delete" or "Remove" button.

6. **Add Necessary Rules**: If any necessary rules were inadvertently removed, add them back in a way that follows the principle of least privilege. Click on the "Add Rule" button to define a new rule.

7. **Review and Save Changes**: Once you have removed the non-empty stateless rules and added any necessary rules, review the changes to ensure they align with your security requirements. Click on the "Save" or "Apply" button to apply the changes.

8. **Verify the Security Group**: After saving the changes, verify that the security group no longer contains any non-empty stateless network firewall rule groups.

By following these steps, you can successfully remediate the non-empty stateless network firewall rule groups in AWS EC2 using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of having non-empty stateless network firewall rule groups in AWS EC2 using AWS CLI, follow these steps:

1. List all the security groups in your AWS account using the following AWS CLI command:
```
aws ec2 describe-security-groups
```

2. Identify the security group that has non-empty stateless network firewall rule groups. Look for the security group with the `IpPermissions` attribute that contains rules.

3. Note down the Group ID of the security group that needs to be remediated.

4. Remove all the inbound and outbound rules from the identified security group using the following AWS CLI command:
```
aws ec2 revoke-security-group-ingress --group-id YOUR_SECURITY_GROUP_ID --protocol all --port all --cidr 0.0.0.0/0
aws ec2 revoke-security-group-egress --group-id YOUR_SECURITY_GROUP_ID --protocol all --port all --cidr 0.0.0.0/0
```

Replace `YOUR_SECURITY_GROUP_ID` with the actual Group ID of the identified security group.

5. Verify that the security group no longer has any inbound or outbound rules by describing the security group using the following AWS CLI command:
```
aws ec2 describe-security-groups --group-ids YOUR_SECURITY_GROUP_ID
```

6. Once you have confirmed that the security group is now empty, you have successfully remediated the issue of having non-empty stateless network firewall rule groups in AWS EC2.

By following these steps, you can effectively remediate the misconfiguration of having non-empty stateless network firewall rule groups in AWS EC2 using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of having non-empty stateless network firewall rule groups in AWS EC2 using Python, you can follow these steps:

1. Use the AWS SDK for Python (Boto3) to interact with the AWS EC2 service.

2. List all the security groups associated with your EC2 instances.

3. For each security group, check if there are any stateless network firewall rule groups that are not empty.

4. If you find any non-empty stateless network firewall rule groups, remove the rules from the security group.

5. Here is a sample Python code snippet that demonstrates how to achieve this:

```python
import boto3

# Initialize the EC2 client
ec2_client = boto3.client('ec2')

# Get all security groups
response = ec2_client.describe_security_groups()

for sg in response['SecurityGroups']:
    group_id = sg['GroupId']
    
    # Check if the security group is stateless and non-empty
    if sg['IpPermissionsEgress'] and not sg['IpPermissions']:
        
        # Remove all egress rules from the security group
        ec2_client.revoke_security_group_egress(GroupId=group_id, IpPermissions=sg['IpPermissionsEgress'])
        
        print(f"Revoked egress rules for security group: {group_id}")
```

6. Make sure to replace the placeholder values like `YourRegion` and `YourProfile` with your actual AWS region and profile name in the code snippet.

7. Run the Python script to remediate the non-empty stateless network firewall rule groups in your AWS EC2 security groups.

By following these steps and running the provided Python script, you can remediate the misconfiguration of having non-empty stateless network firewall rule groups in AWS EC2.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

