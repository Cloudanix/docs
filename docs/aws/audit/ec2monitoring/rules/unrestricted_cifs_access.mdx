---
slug: unrestricted_cifs_access
title: Unrestricted CIFS Access Should Not Be Allowed
sidebar_label: Unrestricted CIFS Access Should Not Be Allowed
---

### More Info:

No AWS EC2 security group should allow unrestricted inbound access to TCP port 445 and (CIFS).

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, AWSWAF, GDPR, SOC2, NISTCSF, PCIDSS, FedRAMP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the EC2 dashboard, select "Security Groups" under the "Network & Security" section.
3. In the Security Groups page, select each security group one by one and check the "Inbound rules" tab in the lower panel.
4. Look for any rules where the protocol is set to "CIFS" (port 445) and the source is set to "0.0.0.0/0" or "::/0". This indicates that CIFS access is unrestricted, which is a misconfiguration.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```

   You will be prompted to provide your AWS Access Key ID, Secret Access Key, default region name, and default output format.

2. List all security groups: The next step is to list all the security groups in your AWS account. You can do this by running the following command:

   ```
   aws ec2 describe-security-groups --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"
   ```

   This command will return a list of all security groups along with their names and IDs.

3. Check for unrestricted CIFS access: Now, for each security group, you need to check if it allows unrestricted CIFS access. You can do this by running the following command:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query "SecurityGroups[*].IpPermissions[*].{FromPort:FromPort,ToPort:ToPort,IpRanges:IpRanges[*].CidrIp}"
   ```

   Replace `<security-group-id>` with the ID of the security group you want to check. This command will return a list of all IP permissions for the specified security group.

4. Analyze the output: If the output of the previous command includes an IP range of `0.0.0.0/0` (which means all IP addresses) and the port range includes `445` (the port used by CIFS), then the security group allows unrestricted CIFS access.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3): Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:

```python
pip install boto3
```

2. Set up AWS credentials: You can set up your AWS credentials in several ways, but the simplest is to use the AWS CLI tool to store them in ~/.aws/credentials:

```bash
aws configure
```

3. Create a Python script to check for unrestricted CIFS access: 

```python
import boto3

def check_cifs_access():
    ec2 = boto3.resource('ec2')
    security_groups = ec2.security_groups.all()

    for group in security_groups:
        if group.ip_permissions:
            for perm in group.ip_permissions:
                if perm['IpProtocol'] == 'tcp' and (perm['FromPort'] == 445 or perm['FromPort'] == 139):
                    for range in perm['IpRanges']:
                        if range['CidrIp'] == '0.0.0.0/0':
                            print(f"Security Group {group.id} allows unrestricted CIFS access")

check_cifs_access()
```

4. Run the script: This script will iterate over all security groups in your AWS account, and for each group, it will check if it has any inbound rules allowing TCP traffic on ports 445 or 139 (the ports used by the CIFS protocol) from any IP address (0.0.0.0/0). If it finds such a rule, it will print a warning message with the ID of the security group. You can run this script regularly to check for misconfigurations.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the unrestricted CIFS access issue in AWS, you can follow the below steps:

1. Login to the AWS Management Console.
2. Go to the EC2 dashboard.
3. Select the Security Group associated with the EC2 instance that has unrestricted CIFS access.
4. Click on the "Inbound Rules" tab.
5. Locate the rule that allows unrestricted CIFS access and select it.
6. Click on the "Edit" button.
7. Change the source IP range to only allow access from trusted IP addresses or a specific IP range.
8. Save the changes.

By following these steps, you have successfully remediated the unrestricted CIFS access issue in AWS.

#### Using CLI

To remediate the misconfiguration of unrestricted CIFS access in AWS using AWS CLI, you can follow these steps:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to list all the Amazon Elastic File System (Amazon EFS) file systems in your AWS account:

```
aws efs describe-file-systems
```

3. Identify the file system that has unrestricted CIFS access.

4. Run the following command to modify the file system policy to restrict CIFS access:

```
aws efs put-file-system-policy --file-system-id fs-12345678 --policy "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Sid\":\"RestrictCIFSAccess\",\"Effect\":\"Deny\",\"Principal\":{\"AWS\":\"*\"},\"Action\":[\"elasticfilesystem:ClientMount\",\"elasticfilesystem:ClientWrite\"],\"Resource\":\"arn:aws:elasticfilesystem:us-east-1:123456789012:file-system/fs-12345678\",\"Condition\":{\"Bool\":{\"aws:SecureTransport\":\"false\"}}}]}"
```

Replace `fs-12345678` with the ID of the file system that has unrestricted CIFS access.

5. Verify that the policy has been updated by running the following command:

```
aws efs describe-file-system-policy --file-system-id fs-12345678
```

This command should return the updated policy for the file system.

6. Test the file system to ensure that CIFS access has been restricted.

#### Using Python

To remediate unrestricted CIFS access in AWS using Python, follow these steps:

1. Import the necessary libraries:

```
import boto3
```

2. Create an Amazon S3 client:

```
s3 = boto3.client('s3')
```

3. Retrieve the current bucket policy:

```
bucket_policy = s3.get_bucket_policy(Bucket='your-bucket-name')
```

4. Check if the policy allows unrestricted CIFS access:

```
if 'CIFS' in bucket_policy['Policy']:
    # Remove the CIFS permission
    new_policy = bucket_policy['Policy'].replace('CIFS', '')
    # Update the bucket policy
    s3.put_bucket_policy(Bucket='your-bucket-name', Policy=new_policy)
```

5. If the policy allows unrestricted CIFS access, remove the CIFS permission from the policy:

```
new_policy = bucket_policy['Policy'].replace('CIFS', '')
```

6. Update the bucket policy:

```
s3.put_bucket_policy(Bucket='your-bucket-name', Policy=new_policy)
```

By following these steps, you can remediate unrestricted CIFS access in AWS using Python.

### Additional Reading:

- [https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#AddRemoveRules](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#AddRemoveRules) 


</Tab>
</Tabs>