

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, select "Instances" to view all the EC2 instances.
3. For each instance, check the "Monitoring" tab. This tab provides metrics such as CPU utilization, Disk reads and writes, Network packets, etc.
4. If the CPU utilization is consistently low (close to 0%) over a long period of time, the instance might be idle. Similarly, if there are no disk reads/writes or network packets, the instance is likely not being used.

#### Using CLI

1. Install and configure AWS CLI: Before you can start, you need to install the AWS CLI on your local machine. You can do this by downloading the appropriate installer from the AWS website. Once installed, you can configure it by running `aws configure` and providing your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all EC2 instances: Use the following command to list all your EC2 instances. This will return a JSON object with all your instances.

   ```
   aws ec2 describe-instances
   ```

3. Check instance status: For each instance, check the 'State' field. If the 'State' is 'running', the instance is not idle. If the 'State' is 'stopped', the instance is idle. You can use the following command to filter out the instances that are running:

   ```
   aws ec2 describe-instances --filters "Name=instance-state-name,Values=stopped"
   ```

4. Check instance usage: For each running instance, you can check the CPU utilization to determine if it's idle or not. You can use the CloudWatch `get-metric-statistics` command to get the CPU utilization for a specific instance:

   ```
   aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization --dimensions Name=InstanceId,Value=instance_id --start-time 2021-01-01T00:00:00Z --end-time 2021-01-02T00:00:00Z --period 3600 --statistics Maximum
   ```

   Replace 'instance_id' with the ID of your instance. This command will return the maximum CPU utilization for each hour in the specified time range. If the CPU utilization is consistently low (e.g., less than 10%), the instance might be idle.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) in your environment. This can be done using pip:

   ```
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config:

   ~/.aws/credentials:
   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

   ~/.aws/config:
   ```
   [default]
   region=us-east-1
   ```

3. Write a Python script to detect idle EC2 instances: The following script uses Boto3 to get a list of all EC2 instances, then checks the CPU utilization for each instance over the past 24 hours. If the maximum CPU utilization is less than a certain threshold (e.g., 10%), the instance is considered idle.

   ```python
   import boto3

   def is_idle(instance_id, threshold=10):
       cloudwatch = boto3.client('cloudwatch')
       response = cloudwatch.get_metric_statistics(
           Namespace='AWS/EC2',
           MetricName='CPUUtilization',
           Dimensions=[
               {
                   'Name': 'InstanceId',
                   'Value': instance_id
               },
           ],
           StartTime=datetime.datetime.utcnow() - datetime.timedelta(days=1),
           EndTime=datetime.datetime.utcnow(),
           Period=3600,
           Statistics=['Maximum']
       )
       return all([datapoint['Maximum'] < threshold for datapoint in response['Datapoints']])

   ec2 = boto3.resource('ec2')
   for instance in ec2.instances.all():
       if is_idle(instance.id):
           print(f"Instance {instance.id} is idle.")
   ```

4. Run the script: You can run the script using Python. It will print out the IDs of all idle EC2 instances:

   ```
   python detect_idle_ec2.py
   ```

This script only checks CPU utilization, which may not be the only indicator of an idle instance. Depending on your use case, you might want to check other metrics as well, such as network traffic or disk I/O.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

The best way to remediate this issue is to stop the idle instances. Here are the step by step instructions to remediate this issue in AWS using the AWS console:

1. Log in to the AWS Management Console.
2. Click on the EC2 service.
3. Select the instances that are idle.
4. Click on the "Actions" button and select "Instance State" and then click "Stop".
5. In the confirmation dialog box, click "Yes, Stop".
6. Wait for the instances to stop.
7. Once the instances have stopped, select them again.
8. Click on the "Actions" button and select "Instance Settings" and then click "Change Shutdown Behavior".
9. In the "Change Shutdown Behavior" dialog box, select "Terminate" and then click "Save".
10. Start the instances again when they are required.

By following these steps, you can remediate the EC2 instances that are idle in AWS and ensure that you are not being charged unnecessarily for instances that are not being used.

#### Using CLI

To remediate the EC2 Instances should not be idle misconfiguration in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the running instances in your AWS account:

   ```
   aws ec2 describe-instances --filters Name=instance-state-name,Values=running
   ```

3. Identify the idle instances that have been running for a long time and need to be remediated.

4. To stop the idle instances, run the following command:

   ```
   aws ec2 stop-instances --instance-ids <instance-id>
   ```

   Replace `<instance-id>` with the ID of the idle instance that you want to stop.

5. Confirm the action by entering `y` when prompted.

6. After the instance has been stopped, you can start it again using the following command:

   ```
   aws ec2 start-instances --instance-ids <instance-id>
   ```

   Replace `<instance-id>` with the ID of the stopped instance that you want to start.

7. Confirm the action by entering `y` when prompted.

8. Repeat steps 4-7 for any other idle instances that need to be remediated.

9. To prevent this misconfiguration from occurring in the future, you can set up CloudWatch alarms to monitor the CPU utilization of your instances and take action if it falls below a certain threshold.

#### Using Python

To remediate the issue of idle EC2 instances in AWS using Python, you can follow the below steps:

1. Create a Lambda function in Python that will identify and terminate idle EC2 instances. 

2. Use the AWS SDK for Python (Boto3) to access the AWS EC2 service and retrieve the list of instances.

3. For each instance, check its CPU utilization using CloudWatch metrics. If the CPU utilization is below a certain threshold (e.g., 10%), then terminate the instance using the terminate_instances() method.

4. Schedule the Lambda function to run periodically using AWS CloudWatch Events. 

Here's a sample Python code to get you started:

```
import boto3

def lambda_handler(event, context):
    ec2 = boto3.client('ec2')
    cw = boto3.client('cloudwatch')
    idle_threshold = 10 # Set the idle threshold to 10%
    
    # Get a list of all running instances
    instances = ec2.describe_instances(
        Filters=[
            {'Name': 'instance-state-name', 'Values': ['running']}
        ]
    )
    
    # Check CPU utilization for each instance
    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            instance_id = instance['InstanceId']
            cpu_utilization = cw.get_metric_statistics(
                Namespace='AWS/EC2',
                MetricName='CPUUtilization',
                Dimensions=[
                    {'Name': 'InstanceId', 'Value': instance_id}
                ],
                StartTime='2022-02-01T00:00:00Z',
                EndTime='2022-02-01T23:59:59Z',
                Period=3600,
                Statistics=['Average']
            )['Datapoints'][0]['Average']
            
            # Terminate idle instances
            if cpu_utilization < idle_threshold:
                ec2.terminate_instances(InstanceIds=[instance_id])
                print(f"Terminated instance {instance_id}")
```

Note: This is just a sample code and you may need to modify it according to your specific requirements.


</Tab>
</Tabs>