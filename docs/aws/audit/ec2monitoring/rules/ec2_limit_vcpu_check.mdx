---
slug: ec2_limit_vcpu_check
title: EC2 Instances Should Not Reach vCPU Limit
sidebar_label: EC2 Instances Should Not Reach vCPU Limit
---

### More Info:

Monitoring vCPU-based limits for on-demand EC2 instances avoids resource starvation. Service Quotas is an AWS service that enables you to view and manage your quotas from a central location. Quotas, also referred to as limits, are the maximum value for your resources, actions, and items in your AWS account.

### Risk Level

Medium

### Address

Operational Maturity, Reliability

### Compliance Standards

AWSWAF


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "INSTANCES", click on "Instances".
3. Select the EC2 instance that you want to check.
4. In the bottom panel, click on the "Monitoring" tab.
5. Here, you can see the "CPU Utilization" metric. If the CPU Utilization is consistently high or at its maximum limit, it indicates that the EC2 instance is reaching its vCPU limit.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI using pip (Python package manager) by running the command `pip install awscli`. After installation, you can configure it by running `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all EC2 instances: Use the AWS CLI command `aws ec2 describe-instances` to list all the EC2 instances in your account. This command will return a JSON output with details of all the instances.

3. Extract instance IDs and their vCPU count: From the output of the previous command, you can extract the instance IDs and their vCPU count using the command `aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId, CpuOptions.CoreCount]' --output text`. This command will return a list of instance IDs along with their vCPU count.

4. Check vCPU limit: Now, for each instance ID, you can check if it has reached its vCPU limit by comparing the vCPU count from the previous step with the vCPU limit of the instance type. You can get the vCPU limit of an instance type from the AWS documentation. If the vCPU count is equal to or greater than the vCPU limit, then the instance has reached its vCPU limit.
</Accordion>

<Accordion title='Using Python'>
1. **Setup AWS SDK (Boto3):** First, you need to set up AWS SDK (Boto3) for Python. This allows Python to interact with AWS services. You can install it using pip:

   ```python
   pip install boto3
   ```

2. **Configure AWS Credentials:** Next, you need to configure your AWS credentials. You can do this by creating a file at ~/.aws/credentials. At the command line, type the following:

   ```bash
   aws configure
   ```

   Then input your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

3. **Create a Python Script to Check vCPU Usage:** Now, you can create a Python script that uses Boto3 to check the vCPU usage of your EC2 instances. Here's a basic example:

   ```python
   import boto3

   # Create a session using your AWS credentials
   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='us-west-2'
   )

   # Create an EC2 resource object using the session
   ec2_resource = session.resource('ec2')

   # Iterate over all your instances
   for instance in ec2_resource.instances.all():
       # Get the instance type
       instance_type = instance.instance_type

       # Get the vCPU info for the instance type
       ec2 = session.client('ec2')
       vcpu_info = ec2.describe_instance_types(InstanceTypes=[instance_type])

       # Get the current vCPU usage
       cloudwatch = session.client('cloudwatch')
       vcpu_usage = cloudwatch.get_metric_statistics(
           Namespace='AWS/EC2',
           MetricName='CPUUtilization',
           Dimensions=[
               {
                   'Name': 'InstanceId',
                   'Value': instance.id
               },
           ],
           StartTime=datetime.datetime.utcnow() - datetime.timedelta(seconds=600),
           EndTime=datetime.datetime.utcnow(),
           Period=60,
           Statistics=['Average']
       )

       # Check if the vCPU usage is at the limit
       if vcpu_usage['Datapoints']:
           average_vcpu_usage = vcpu_usage['Datapoints'][0]['Average']
           vcpu_limit = vcpu_info['InstanceTypes'][0]['VCpuInfo']['DefaultVCpus']
           if average_vcpu_usage >= vcpu_limit:
               print(f"Instance {instance.id} is at vCPU limit.")
   ```

4. **Run the Python Script:** Finally, you can run the Python script. It will print out the IDs of any instances that are at their vCPU limit. If no instances are at their limit, it won't print anything.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "EC2 Instances Should Not Reach vCPU Limit" in AWS using the AWS console, follow the below steps:

1. Open the AWS Management Console and navigate to the EC2 dashboard.
2. Select the EC2 instance that is reaching the vCPU limit.
3. Click on the "Actions" button and select "Instance Settings" and then click on "Change Instance Type".
4. Select a larger instance type that provides more vCPUs than the current instance type.
5. Review the changes and click on "Apply".
6. Once the instance type is changed, the instance will have more vCPUs and the vCPU limit will no longer be reached.

Alternatively, you can also use AWS Auto Scaling to automatically adjust the instance type based on the resource utilization of the instance. This will ensure that the instance always has enough vCPUs and other resources to handle the workload.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the EC2 instances reaching vCPU limit misconfiguration in AWS using AWS CLI, follow the below steps:

Step 1: Log in to the AWS Management Console.

Step 2: Open the AWS CLI on your local machine.

Step 3: Use the below command to describe the EC2 instances that have reached the vCPU limit:

```
aws ec2 describe-instances --query 'Reservations[].Instances[?CpuOptions.CpuCreditsRemaining==`0`].{InstanceID:InstanceId, vCPUs:CpuOptions.CoreCount}'
```

This command will display the list of instances that have reached the vCPU limit.

Step 4: Stop the EC2 instances that have reached the vCPU limit using the below command:

```
aws ec2 stop-instances --instance-ids <instance-id>
```

Replace the `<instance-id>` with the actual instance ID of the instance that you want to stop.

Step 5: Modify the instance type of the stopped instances using the below command:

```
aws ec2 modify-instance-attribute --instance-id <instance-id> --instance-type <new-instance-type>
```

Replace `<instance-id>` with the actual instance ID of the instance that you want to modify, and `<new-instance-type>` with the desired instance type.

Step 6: Start the modified EC2 instances using the below command:

```
aws ec2 start-instances --instance-ids <instance-id>
```

Replace the `<instance-id>` with the actual instance ID of the instance that you want to start.

By following these steps, you can remediate the EC2 instances reaching vCPU limit misconfiguration in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the EC2 Instances reaching vCPU limit misconfiguration in AWS using python, you can follow the below steps:

Step 1: Identify the EC2 instances which are reaching vCPU limit using the boto3 library in python.

```python
import boto3

# Create EC2 client
ec2 = boto3.client('ec2')

# Get all EC2 instances
reservations = ec2.describe_instances()

for reservation in reservations['Reservations']:
    for instance in reservation['Instances']:
        # Check if the instance is running and has a vCPU limit
        if instance['State']['Name'] == 'running' and 'CpuOptions' in instance and 'CoreCount' in instance['CpuOptions']:
            # Check if the instance is reaching the vCPU limit
            if instance['CpuOptions']['CoreCount'] >= instance['CpuOptions']['ThreadsPerCore']:
                # Remediate the misconfiguration by stopping and starting the instance
                ec2.stop_instances(InstanceIds=[instance['InstanceId']])
                ec2.start_instances(InstanceIds=[instance['InstanceId']])
```

Step 2: Stop and start the EC2 instances which are reaching the vCPU limit to remediate the misconfiguration.

```python
# Stop and start the instances which are reaching the vCPU limit
ec2.stop_instances(InstanceIds=[instance['InstanceId']])
ec2.start_instances(InstanceIds=[instance['InstanceId']])
```

By following the above steps, you can remediate the EC2 Instances reaching vCPU limit misconfiguration in AWS using python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/servicequotas/latest/userguide/intro.html](https://docs.aws.amazon.com/servicequotas/latest/userguide/intro.html) 

