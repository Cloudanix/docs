

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, select "Instances" to view all the EC2 instances.
3. For each instance, check the "Tags" section. If the instance is managed by SSM, it should have a tag with the key "SSM-Managed" and the value "True". If such a tag is not present, the instance is not managed by SSM.
4. Alternatively, you can navigate to the Systems Manager dashboard and select "Managed Instances" in the navigation pane. If an EC2 instance is managed by SSM, it will be listed here.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the EC2 instances and SSM.

2. Once the AWS CLI is installed and configured, you can list all the EC2 instances using the following command:

   ```
   aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text
   ```

   This command will return a list of all EC2 instance IDs.

3. Now, for each EC2 instance, you need to check if it is managed by SSM. You can do this by using the following command:

   ```
   aws ssm describe-instance-information --filters "Key=InstanceIds,Values=<instance-id>"
   ```

   Replace `<instance-id>` with the ID of the EC2 instance you want to check. If the instance is managed by SSM, this command will return information about the instance. If the instance is not managed by SSM, this command will return an empty result.

4. To automate the process, you can write a script that loops through all EC2 instances and checks if they are managed by SSM. Here is a simple example in bash:

   ```
   #!/bin/bash

   instances=$(aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text)

   for instance in $instances
   do
     result=$(aws ssm describe-instance-information --filters "Key=InstanceIds,Values=$instance")

     if [ -z "$result" ]
     then
       echo "Instance $instance is not managed by SSM"
     else
       echo "Instance $instance is managed by SSM"
     fi
   done
   ```

   This script will print a message for each EC2 instance indicating whether it is managed by SSM or not.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3) in your local environment. Boto3 allows you to directly create, update, and delete AWS resources from your Python scripts.

```python
pip install boto3
aws configure
```

2. Import the necessary modules and create a session using your AWS credentials.

```python
import boto3
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. Use the `describe_instances()` function to get a list of all EC2 instances. Then, use the `list_associations()` function from the SSM client to get a list of all instances managed by SSM.

```python
ec2 = session.resource('ec2')
ssm = session.client('ssm')

instances = ec2.instances.all()
ssm_associations = ssm.list_associations()['Associations']
```

4. Compare the two lists to find any EC2 instances that are not managed by SSM. If an instance is not in the list of SSM associations, it is not managed by SSM.

```python
for instance in instances:
    if not any(association['InstanceId'] == instance.id for association in ssm_associations):
        print(f'Instance {instance.id} is not managed by SSM')
```

This script will print out the IDs of any EC2 instances that are not managed by SSM.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "EC2 Instances Should Be Managed By SSM" in AWS using the AWS console, follow the below steps:

1. Open the AWS Management Console and navigate to the EC2 dashboard.
2. Select the EC2 instance that needs to be managed by SSM.
3. Click on the "Actions" button and select "Instance Settings" and then click on "Attach/Replace IAM Role".
4. In the "Attach/Replace IAM Role" window, select the option "SSMManagedInstanceCore" in the "IAM Role" drop-down menu.
5. Click on "Apply" to attach the IAM role to the EC2 instance.
6. Once the IAM role is attached, navigate to the SSM dashboard.
7. Select "Managed Instances" from the left-hand menu.
8. Verify that the EC2 instance is listed as a managed instance. If it is not listed, select "Register instances" to add the EC2 instance to SSM.
9. After registering the instance, select the instance and click on "Actions" and then select "Run Command".
10. In the "Run a Command" window, select the "AWS-ConfigureAWSPackage" document.
11. In the "Command Parameters" section, select the "Install" option for the "action" parameter.
12. Click on "Run" to install the SSM agent on the EC2 instance.
13. Once the SSM agent is installed, the EC2 instance will be managed by SSM.

By following the above steps, the misconfiguration "EC2 Instances Should Be Managed By SSM" can be remediated for AWS using the AWS console.

#### Using CLI

To remediate the misconfiguration "EC2 Instances Should Be Managed By SSM" in AWS using AWS CLI, follow the below steps:

Step 1: Install and configure AWS CLI on your local machine.

Step 2: Run the following command to identify the EC2 instances that are not managed by SSM:

```
aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0], [not contains(Tags[?Key==`aws: ssm: managed`, Value==`true`)], InstanceId]]' --output text
```

Step 3: The above command will output a list of all EC2 instances that are not managed by SSM. Identify the instances that need to be remediated.

Step 4: Run the following command to enable SSM management for the identified EC2 instances:

```
aws ssm send-command --document-name "AWS-ConfigureAWSPackage" --document-version "1" --targets "Key=InstanceIds,Values=<Instance-ID>" --parameters '{"action":["Install"],"installationType":["Uninstall and reinstall"],"name":["AmazonCloudWatchAgent"],"version":["latest"]}' --timeout-seconds 600 --max-concurrency "50" --max-errors "0" --output-s3-bucket-name "<S3-Bucket-Name>" --output-s3-key-prefix "output" --region "<Region>"
```

Note: Replace `<Instance-ID>`, `<S3-Bucket-Name>`, and `<Region>` with the appropriate values.

Step 5: Repeat Step 4 for all the identified EC2 instances.

Step 6: Verify that SSM management is enabled for the EC2 instances by running the following command:

```
aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0], [not contains(Tags[?Key==`aws: ssm: managed`, Value==`true`)], InstanceId]]' --output text
```

The above command should not return any output, indicating that all EC2 instances are now managed by SSM.

#### Using Python

To remediate the misconfiguration "EC2 Instances Should Be Managed By SSM" in AWS using Python, you can follow these steps:

1. Install the AWS SDK for Python (Boto3) using pip: `pip install boto3`

2. Create an AWS SSM client object using the following code:

```python
import boto3

ssm_client = boto3.client('ssm')
```

3. Retrieve a list of all EC2 instances in the AWS account using the following code:

```python
import boto3

ec2_client = boto3.client('ec2')

response = ec2_client.describe_instances()
instances = []

for reservation in response['Reservations']:
    for instance in reservation['Instances']:
        instances.append(instance['InstanceId'])
```

4. For each EC2 instance, check if it is already managed by SSM using the following code:

```python
import boto3

ssm_client = boto3.client('ssm')

response = ssm_client.describe_instance_information(
    InstanceInformationFilterList=[
        {
            'key': 'InstanceIds',
            'valueSet': [
                'INSTANCE_ID'
            ]
        },
    ]
)

if len(response['InstanceInformationList']) > 0:
    print('Instance is already managed by SSM')
else:
    print('Instance is not managed by SSM')
```

Replace `INSTANCE_ID` with the ID of the EC2 instance you want to check.

5. If the EC2 instance is not already managed by SSM, you can remediate the misconfiguration by running the following command:

```python
import boto3

ssm_client = boto3.client('ssm')

response = ssm_client.send_command(
    InstanceIds=[
        'INSTANCE_ID',
    ],
    DocumentName='AWS-ConfigureAWSPackage',
    Parameters={
        'action': ['Install'],
        'name': ['AmazonCloudWatchAgent'],
    }
)

command_id = response['Command']['CommandId']
```

Replace `INSTANCE_ID` with the ID of the EC2 instance you want to remediate.

This command will install the Amazon CloudWatch agent on the EC2 instance and configure it to be managed by SSM. You can monitor the progress of the command using the `command_id` returned by the `send_command` method.


</Tab>
</Tabs>