---
slug: reserved_instance_payment_failed
title: EC2 Reserved Instances Should Not Have Payment Failed
sidebar_label: EC2 Reserved Instances Should Not Have Payment Failed
---

### More Info:

To ensure that none of your AWS EC2 Reserved Instance purchases have failed.

### Risk Level

Low

### Address

Cost Optimisation

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 Reserved Instances from having payment failures in AWS using the AWS Management Console, follow these steps:

1. **Set Up Billing Alerts:**
   - Navigate to the **Billing and Cost Management Dashboard**.
   - Go to **Billing Preferences**.
   - Enable **Receive Billing Alerts**.
   - Set up a billing alarm in **CloudWatch** to notify you when your charges exceed a certain threshold.

2. **Enable Multi-Factor Authentication (MFA):**
   - Go to the **IAM Dashboard**.
   - Select **Users** and choose the user you want to enable MFA for.
   - Click on the **Security credentials** tab.
   - Click on **Manage MFA device** and follow the instructions to set up MFA.

3. **Monitor Payment Methods:**
   - Navigate to the **Billing and Cost Management Dashboard**.
   - Go to **Payment Methods**.
   - Ensure that your payment methods are up-to-date and have sufficient funds or credit limits.

4. **Set Up Budget Notifications:**
   - Go to the **Billing and Cost Management Dashboard**.
   - Select **Budgets** from the left-hand menu.
   - Create a new budget and set thresholds for notifications.
   - Configure email notifications to alert you when your spending approaches or exceeds your budget.

By following these steps, you can proactively monitor and manage your billing and payment methods to prevent EC2 Reserved Instances from having payment failures.
</Accordion>

<Accordion title='Using CLI'>
To prevent EC2 Reserved Instances from having payment failures using AWS CLI, you can follow these steps:

1. **Set Up Billing Alerts:**
   Ensure you have billing alerts set up to notify you of any potential payment issues. This can help you take proactive measures before a payment failure occurs.
   ```sh
   aws cloudwatch put-metric-alarm --alarm-name "BillingAlarm" --metric-name "EstimatedCharges" --namespace "AWS/Billing" --statistic "Maximum" --period 21600 --threshold 100 --comparison-operator "GreaterThanOrEqualToThreshold" --evaluation-periods 1 --alarm-actions "arn:aws:sns:us-east-1:123456789012:NotifyMe" --dimensions "Name=Currency,Value=USD"
   ```

2. **Enable Cost and Usage Reports:**
   Enable detailed cost and usage reports to monitor your spending and ensure you have enough funds to cover your Reserved Instances.
   ```sh
   aws cur put-report-definition --report-definition file://report-definition.json
   ```
   Ensure `report-definition.json` contains the necessary configuration for your cost and usage report.

3. **Automate Payment Method Verification:**
   Regularly verify your payment methods using AWS CLI to ensure they are up-to-date and valid.
   ```sh
   aws organizations describe-account --account-id 123456789012
   ```
   This command helps you retrieve account details, including the status of your payment methods.

4. **Monitor Reserved Instance Utilization:**
   Regularly check the utilization of your Reserved Instances to ensure they are being used effectively, which can help justify the cost and prevent unnecessary expenses.
   ```sh
   aws ce get-reservation-utilization --time-period Start=2023-01-01,End=2023-12-31
   ```

By following these steps, you can proactively manage your AWS billing and payment methods to prevent EC2 Reserved Instances from having payment failures.
</Accordion>

<Accordion title='Using Python'>
To prevent EC2 Reserved Instances from having payment failures using Python scripts, you can follow these steps:

1. **Set Up AWS SDK (Boto3) and Authentication:**
   Ensure you have the AWS SDK for Python (Boto3) installed and properly configured with your AWS credentials.

   ```python
   import boto3

   # Initialize a session using Amazon EC2
   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='YOUR_REGION'
   )

   ec2_client = session.client('ec2')
   ```

2. **Monitor Reserved Instances Payment Status:**
   Create a function to check the payment status of your Reserved Instances. This can be done by integrating with AWS Cost Explorer or AWS Billing and Cost Management APIs.

   ```python
   def check_reserved_instances_payment_status():
       # Initialize Cost Explorer client
       ce_client = session.client('ce')

       # Get the reservation utilization report
       response = ce_client.get_reservation_utilization(
           TimePeriod={
               'Start': '2023-01-01',
               'End': '2023-12-31'
           },
           Granularity='MONTHLY'
       )

       for reservation in response['UtilizationsByTime']:
           for group in reservation['Groups']:
               if group['Attributes']['PaymentOption'] == 'No Upfront' and group['Utilization']['Total']['AmortizedUpfrontCost'] == '0':
                   print(f"Payment failed for reservation: {group['Key']}")
                   # Add your logic to handle payment failure
   ```

3. **Automate Payment Verification:**
   Schedule the script to run periodically (e.g., daily) using a task scheduler like cron (Linux) or Task Scheduler (Windows) to ensure continuous monitoring.

   ```python
   import schedule
   import time

   def job():
       check_reserved_instances_payment_status()

   # Schedule the job every day at a specific time
   schedule.every().day.at("10:00").do(job)

   while True:
       schedule.run_pending()
       time.sleep(1)
   ```

4. **Alerting and Notification:**
   Integrate with an alerting system (e.g., AWS SNS) to notify administrators if a payment failure is detected.

   ```python
   def send_alert(message):
       sns_client = session.client('sns')
       response = sns_client.publish(
           TopicArn='YOUR_SNS_TOPIC_ARN',
           Message=message,
           Subject='EC2 Reserved Instance Payment Failure Alert'
       )
       print(response)

   def check_reserved_instances_payment_status():
       # (Previous code)
       for reservation in response['UtilizationsByTime']:
           for group in reservation['Groups']:
               if group['Attributes']['PaymentOption'] == 'No Upfront' and group['Utilization']['Total']['AmortizedUpfrontCost'] == '0':
                   alert_message = f"Payment failed for reservation: {group['Key']}"
                   send_alert(alert_message)
   ```

By following these steps, you can proactively monitor and prevent EC2 Reserved Instances from having payment failures using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the navigation pane, under "RESOURCES", click on "Reserved Instances".
3. In the Reserved Instances dashboard, you can see the list of all your reserved instances. Check the "State" column for each reserved instance.
4. If the state of any reserved instance is "payment-failed", it indicates that the payment for that reserved instance has failed.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all EC2 Reserved Instances: Use the following AWS CLI command to list all your EC2 Reserved Instances:

   ```
   aws ec2 describe-reserved-instances --query 'ReservedInstances[*].[ReservedInstancesId,State]' --output text
   ```
   This command will return a list of all your Reserved Instances along with their IDs and states.

3. Check for Payment Failed status: From the output of the above command, check if any of the Reserved Instances have their state as 'payment-failed'. If any Reserved Instance has this state, it means that the payment for that Reserved Instance has failed.

4. Automate the process with a Python script: You can automate this process by writing a Python script that uses the boto3 library to interact with AWS. The script would use the `describe_reserved_instances` function to get a list of all Reserved Instances and then check the 'State' of each Reserved Instance to see if it is 'payment-failed'. If it finds any Reserved Instance with this state, it can print out the ID of that Reserved Instance.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3): Boto3 makes it easy to integrate your Python application, library, or script with AWS services including AWS S3, AWS EC2, AWS DynamoDB, and much more. To install Boto3, you can use pip:

   ```
   pip install boto3
   ```

   You also need to configure your AWS credentials. You can do this in several ways, but the simplest is to use the AWS CLI:

   ```
   aws configure
   ```

   Then follow the prompts to input your AWS Access Key ID, Secret Access Key, default region name, and default output format.

2. Use Boto3 to interact with AWS EC2: You can use Boto3 to create, configure, and manage AWS services. For example, you can start or stop EC2 instances, create security groups, and so on. Here is a simple script to list all EC2 instances:

   ```python
   import boto3

   ec2 = boto3.resource('ec2')

   for instance in ec2.instances.all():
       print(instance.id, instance.state)
   ```

3. Check the status of Reserved Instances: You can use the `describe_reserved_instances` method to get information about Reserved Instances. The `State` field indicates whether the Reserved Instance is active, payment-pending, retired, etc. Here is a script to check if any Reserved Instances have payment failed:

   ```python
   import boto3

   ec2 = boto3.client('ec2')

   response = ec2.describe_reserved_instances()

   for ri in response['ReservedInstances']:
       if ri['State'] == 'payment-failed':
           print(f"Reserved Instance {ri['ReservedInstancesId']} has payment failed.")
   ```

4. Handle the results: Depending on your needs, you can modify the script to take action when it finds a Reserved Instance with payment failed. For example, you could send an email notification, log the event, etc. Remember to handle exceptions and errors appropriately in your script.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the EC2 Reserved Instances payment failed misconfiguration in AWS, please follow the steps below:

1. Log in to your AWS Management Console.
2. Go to the EC2 dashboard.
3. Click on the "Reserved Instances" link on the left-hand side menu.
4. Find the Reserved Instance with the payment failed status and select it.
5. Click on the "Actions" button and select "Modify Reserved Instances".
6. In the "Modify Reserved Instances" window, select the new payment option and click "Save Changes".
7. If the payment information is correct, the Reserved Instance will be reactivated.

Alternatively, you can also remediate this misconfiguration using the AWS CLI by running the following command:

```
aws ec2 modify-reserved-instances --reserved-instances-id <reservation-id> --instance-count <new-instance-count> --payment-option <payment-option>
```

Replace `<reservation-id>` with the ID of the Reserved Instance that has the payment failed status, `<new-instance-count>` with the number of instances you want to reserve and `<payment-option>` with the new payment option you want to use.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the "EC2 Reserved Instances Should Not Have Payment Failed" misconfiguration for AWS using AWS CLI, follow the below steps:

1. Login to the AWS CLI by using the command `aws configure` and entering your AWS access key ID, secret access key, default region name, and default output format.

2. Check the status of your EC2 Reserved Instances using the command `aws ec2 describe-reserved-instances`.

3. Identify the reserved instances with payment failed status.

4. To remediate the misconfiguration, you can either retry the payment or modify the reserved instance to a different payment option.

5. To retry the payment, use the command `aws ec2 modify-reserved-instances --reserved-instances-id <ID> --offering-id <ID> --instance-count <COUNT> --dry-run` and replace the `<ID>` with the ID of the reserved instance, and `<COUNT>` with the number of instances you want to purchase.

6. To modify the reserved instance to a different payment option, use the command `aws ec2 modify-reserved-instances --reserved-instances-id <ID> --target-configuration OfferingId=<ID>,InstanceCount=<COUNT>` and replace the `<ID>` with the ID of the reserved instance, and `<COUNT>` with the number of instances you want to purchase.

7. After retrying the payment or modifying the reserved instance, use the command `aws ec2 describe-reserved-instances` to verify that the status has been updated to active.

8. Repeat the above steps for all the reserved instances with payment failed status.

By following the above steps, you can remediate the "EC2 Reserved Instances Should Not Have Payment Failed" misconfiguration for AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "EC2 Reserved Instances Should Not Have Payment Failed" for AWS using python, you can follow the below steps:

Step 1: Import the necessary libraries

```
import boto3
```

Step 2: Create an EC2 client object

```
ec2 = boto3.client('ec2')
```

Step 3: Get the list of all Reserved Instances

```
reserved_instances = ec2.describe_reserved_instances()
```

Step 4: Iterate through the list of Reserved Instances and check if any of them have a payment failure

```
for reserved_instance in reserved_instances['ReservedInstances']:
    if reserved_instance['State'] == 'payment-failed':
        # Perform the remediation action
```

Step 5: Perform the remediation action, which is to modify the payment method and update the Reserved Instance

```
# Modify the payment method
ec2.modify_reserved_instances(
    ReservedInstancesIds=[reserved_instance['ReservedInstancesId']],
    ClientToken='string',
    TargetConfigurations=[
        {
            'AvailabilityZone': 'string',
            'InstanceCount': 123,
            'InstanceType': 'string',
            'Platform': 'string'
        },
    ],
    PaymentOption='AllUpfront'
)

# Update the Reserved Instance
ec2.modify_reserved_instances(
    ReservedInstancesIds=[reserved_instance['ReservedInstancesId']],
    ClientToken='string',
    TargetConfigurations=[
        {
            'AvailabilityZone': 'string',
            'InstanceCount': 123,
            'InstanceType': 'string',
            'Platform': 'string'
        },
    ]
)
```

Step 6: Once the remediation action is performed, verify if the Reserved Instance is updated successfully

```
# Verify if the Reserved Instance is updated successfully
reserved_instance = ec2.describe_reserved_instances(
    ReservedInstancesIds=[reserved_instance['ReservedInstancesId']]
)
if reserved_instance['ReservedInstances'][0]['State'] != 'payment-failed':
    print('Reserved Instance updated successfully')
else:
    print('Failed to update Reserved Instance')
```

By following the above steps, you can remediate the misconfiguration "EC2 Reserved Instances Should Not Have Payment Failed" for AWS using python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-reserved-instances.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-reserved-instances.html) 

