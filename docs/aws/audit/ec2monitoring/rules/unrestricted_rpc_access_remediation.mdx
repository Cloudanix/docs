
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent unrestricted RPC (Remote Procedure Call) access in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to Security Groups:**
   - Open the AWS Management Console.
   - In the navigation pane, choose "Security Groups" under the "Network & Security" section.

2. **Select the Security Group:**
   - Identify and select the security group associated with your EC2 instance that you want to modify.

3. **Edit Inbound Rules:**
   - In the selected security group, go to the "Inbound rules" tab.
   - Click on the "Edit inbound rules" button.

4. **Restrict RPC Access:**
   - Locate any rules that allow inbound traffic on port 135 (commonly used for RPC).
   - Modify the source to a specific IP address or range that requires access, rather than allowing unrestricted access (e.g., 0.0.0.0/0).
   - If no specific IPs need access, consider removing the rule entirely.
   - Click "Save rules" to apply the changes.

By following these steps, you can ensure that RPC access to your EC2 instances is restricted to only trusted sources, thereby enhancing the security of your AWS environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent unrestricted RPC (Remote Procedure Call) access in EC2 using AWS CLI, you need to modify the security group rules to restrict access to the necessary IP addresses and ports. Here are the steps:

1. **Identify the Security Group:**
   First, identify the security group associated with your EC2 instance.
   ```sh
   aws ec2 describe-instances --instance-ids <instance-id> --query "Reservations[*].Instances[*].SecurityGroups[*].GroupId" --output text
   ```

2. **Revoke Unrestricted Inbound Rules:**
   Revoke any existing inbound rules that allow unrestricted access to the RPC port (typically port 135 for Microsoft RPC).
   ```sh
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 135 --cidr 0.0.0.0/0
   ```

3. **Add Restricted Inbound Rules:**
   Add inbound rules to allow access only from specific IP addresses or ranges that require RPC access.
   ```sh
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol tcp --port 135 --cidr <trusted-ip-range>
   ```

4. **Verify Security Group Rules:**
   Verify that the security group rules have been updated correctly.
   ```sh
   aws ec2 describe-security-groups --group-ids <security-group-id>
   ```

Replace `<instance-id>`, `<security-group-id>`, and `<trusted-ip-range>` with your specific instance ID, security group ID, and the IP range you want to allow access from, respectively.
</Accordion>

<Accordion title='Using Python'>
To prevent unrestricted RPC (Remote Procedure Call) access in EC2 instances using Python scripts, you can follow these steps:

### 1. **Set Up AWS SDK for Python (Boto3)**
First, ensure you have Boto3 installed and configured. You can install it using pip if you haven't already:

```bash
pip install boto3
```

### 2. **Create a Python Script to Describe Security Groups**
You need to identify the security groups associated with your EC2 instances and check their inbound rules for unrestricted RPC access (port 135).

```python
import boto3

# Initialize a session using Amazon EC2
ec2 = boto3.client('ec2')

# Describe all security groups
response = ec2.describe_security_groups()

# Check for unrestricted RPC access
for sg in response['SecurityGroups']:
    for permission in sg['IpPermissions']:
        if 'FromPort' in permission and permission['FromPort'] == 135:
            for ip_range in permission['IpRanges']:
                if ip_range['CidrIp'] == '0.0.0.0/0':
                    print(f"Security Group {sg['GroupId']} has unrestricted RPC access")
```

### 3. **Modify Security Groups to Restrict RPC Access**
If unrestricted access is found, modify the security group to restrict access. You can remove the rule allowing unrestricted access and add a more restrictive rule.

```python
# Function to remove unrestricted RPC access
def remove_unrestricted_rpc_access(sg_id):
    ec2.revoke_security_group_ingress(
        GroupId=sg_id,
        IpProtocol='tcp',
        FromPort=135,
        ToPort=135,
        CidrIp='0.0.0.0/0'
    )
    print(f"Removed unrestricted RPC access from Security Group {sg_id}")

# Function to add restricted RPC access (example: only from a specific IP)
def add_restricted_rpc_access(sg_id, ip_range):
    ec2.authorize_security_group_ingress(
        GroupId=sg_id,
        IpProtocol='tcp',
        FromPort=135,
        ToPort=135,
        CidrIp=ip_range
    )
    print(f"Added restricted RPC access to Security Group {sg_id}")

# Example usage
for sg in response['SecurityGroups']:
    for permission in sg['IpPermissions']:
        if 'FromPort' in permission and permission['FromPort'] == 135:
            for ip_range in permission['IpRanges']:
                if ip_range['CidrIp'] == '0.0.0.0/0':
                    remove_unrestricted_rpc_access(sg['GroupId'])
                    add_restricted_rpc_access(sg['GroupId'], '192.168.1.0/24')  # Example IP range
```

### 4. **Automate and Schedule the Script**
To ensure continuous compliance, automate the script to run at regular intervals using a scheduler like cron (Linux) or Task Scheduler (Windows).

```bash
# Example cron job to run the script every day at midnight
0 0 * * * /usr/bin/python3 /path/to/your/script.py
```

By following these steps, you can prevent unrestricted RPC access in your EC2 instances using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the left navigation pane, under the "Network & Security" section, click on "Security Groups".
3. In the Security Groups page, you will see a list of all the security groups associated with your EC2 instances. Click on the security group that you want to check.
4. In the details pane at the bottom, click on the "Inbound" tab. Here, you can see all the inbound rules for the selected security group. If there is a rule that allows unrestricted RPC access (i.e., the source is set to "0.0.0.0/0" or "::/0" and the port range includes 135), then this is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```

   During the configuration process, you will be asked to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format. You can find these details in your AWS Management Console.

2. List all security groups: Once your AWS CLI is set up, you can list all the security groups in your account by running the following command:

   ```
   aws ec2 describe-security-groups --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"
   ```

   This command will return a list of all security groups along with their names and IDs.

3. Check for unrestricted RPC access: For each security group, you need to check if it allows unrestricted RPC access. You can do this by running the following command:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query "SecurityGroups[*].IpPermissions[*].{FromPort:FromPort,ToPort:ToPort,IpRanges:IpRanges[*].CidrIp}"
   ```

   Replace `<security-group-id>` with the ID of the security group you want to check. This command will return a list of all inbound rules for the specified security group.

4. Analyze the output: If any of the returned rules have `FromPort` and `ToPort` set to `135` (the port used by RPC) and `IpRanges` set to `0.0.0.0/0` (which represents all IP addresses), then the security group allows unrestricted RPC access.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing your Python script, you need to install the necessary libraries. The Boto3 library is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Configure AWS Credentials: Boto3 needs your AWS credentials (access key and secret access key) to call AWS services on your behalf. You can configure it in several ways, but the simplest is to use the AWS CLI:

   ```bash
   aws configure
   ```

   Then input your Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

3. Write the Python script: The following Python script uses Boto3 to retrieve all security groups and checks if they have unrestricted RPC access:

   ```python
   import boto3

   ec2 = boto3.resource('ec2')

   # Get all security groups
   security_groups = ec2.security_groups.all()

   # Check each security group for unrestricted RPC access
   for group in security_groups:
       for permission in group.ip_permissions:
           # Check if protocol is RPC (port 135)
           if permission['FromPort'] == 135 and permission['ToPort'] == 135:
               for range in permission['IpRanges']:
                   # Check if access is unrestricted (0.0.0.0/0)
                   if range['CidrIp'] == '0.0.0.0/0':
                       print(f"Security Group {group.group_name} ({group.group_id}) allows unrestricted RPC access.")
   ```

4. Run the Python script: Save the script to a file, e.g., `check_rpc_access.py`, and run it using Python:

   ```bash
   python check_rpc_access.py
   ```

   The script will print out the names and IDs of any security groups that allow unrestricted RPC access.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of unrestricted RPC access in AWS, you can follow these steps:

1. Open the AWS Management Console and go to the EC2 dashboard.
2. Click on the "Security Groups" option in the left-hand menu.
3. Select the security group that is allowing unrestricted RPC access.
4. Click on the "Inbound Rules" tab and locate the rule that allows RPC access.
5. Click on the "Edit" button next to the rule.
6. Change the source IP address to a specific IP address or range of IP addresses that require access to RPC.
7. If necessary, add a new rule to allow access to RPC from specific IP addresses or ranges.
8. Click on the "Save" button to apply the changes.

Once the changes are saved, the security group will no longer allow unrestricted RPC access. It is important to regularly review and update security group rules to ensure that they are properly configured and do not leave any vulnerabilities open to attack.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the "Unrestricted RPC Access Should Not Be Allowed" misconfiguration in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list the security groups in your AWS account:

   ```
   aws ec2 describe-security-groups
   ```

3. Identify the security group that has the unrestricted RPC access.

4. Run the following command to modify the security group and remove the unrestricted RPC access:

   ```
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 111 --cidr 0.0.0.0/0
   ```

   Note: Replace `<security-group-id>` with the ID of the security group that has the unrestricted RPC access.

5. Run the following command to verify that the unrestricted RPC access has been removed:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id>
   ```

   Note: Replace `<security-group-id>` with the ID of the security group that has the unrestricted RPC access.

6. Verify that the remediation was successful by confirming that the security group no longer has unrestricted RPC access.

By following these steps, you can remediate the "Unrestricted RPC Access Should Not Be Allowed" misconfiguration in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the "Unrestricted RPC Access Should Not Be Allowed" issue in AWS using Python, follow the below steps:

1. First, we need to identify the security group that allows unrestricted RPC access. You can use the following Python code to list all the security groups in your AWS account:

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.describe_security_groups()
for sg in response['SecurityGroups']:
    print(sg['GroupId'], sg['GroupName'])
```

2. Once you have identified the security group that allows unrestricted RPC access, you can use the following Python code to revoke the rule:

```python
import boto3

ec2 = boto3.client('ec2')

response = ec2.revoke_security_group_ingress(
    GroupId='SECURITY_GROUP_ID',
    IpPermissions=[
        {
            'IpProtocol': 'tcp',
            'FromPort': 135,
            'ToPort': 139,
            'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
        },
        {
            'IpProtocol': 'tcp',
            'FromPort': 445,
            'ToPort': 445,
            'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
        },
        {
            'IpProtocol': 'udp',
            'FromPort': 137,
            'ToPort': 138,
            'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
        }
    ]
)
```

In the above code, replace 'SECURITY_GROUP_ID' with the ID of the security group that allows unrestricted RPC access.

3. The above code will revoke the rule that allows unrestricted RPC access. You can run the first code again to verify that the rule has been revoked.

Note: The above code assumes that you have the necessary permissions to modify security groups in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
