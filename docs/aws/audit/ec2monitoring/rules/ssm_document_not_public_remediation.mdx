
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent SSM (Systems Manager) Documents from being public in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to Systems Manager:**
   - Open the AWS Management Console.
   - In the search bar, type "Systems Manager" and select it from the dropdown.

2. **Access Documents:**
   - In the Systems Manager console, in the left-hand navigation pane, click on "Documents" under the "Shared Resources" section.

3. **Review Document Permissions:**
   - Select the SSM Document you want to review.
   - Click on the "Permissions" tab to view the current permissions settings.

4. **Modify Permissions:**
   - Ensure that the document is not shared with the public. If it is, remove any public access by adjusting the permissions.
   - Set the appropriate permissions to restrict access to only the necessary AWS IAM users, roles, or groups.

By following these steps, you can ensure that your SSM Documents are not publicly accessible, thereby enhancing the security of your AWS environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent an SSM (Systems Manager) Document from being public in EC2 using AWS CLI, you can follow these steps:

1. **List SSM Documents**:
   First, list all the SSM documents to identify the ones you need to check or modify.
   ```sh
   aws ssm list-documents
   ```

2. **Describe Document Permissions**:
   Check the current permissions of a specific SSM document to see if it is public.
   ```sh
   aws ssm describe-document-permission --name <DocumentName> --permission-type Share
   ```

3. **Remove Public Access**:
   If the document is public, remove the public access by modifying the document permissions. This command removes the 'All' account, which represents public access.
   ```sh
   aws ssm modify-document-permission --name <DocumentName> --account-ids-to-remove "All" --permission-type Share
   ```

4. **Verify Permissions**:
   After modifying the permissions, verify that the document is no longer public.
   ```sh
   aws ssm describe-document-permission --name <DocumentName> --permission-type Share
   ```

Replace `<DocumentName>` with the actual name of your SSM document. These steps ensure that your SSM documents are not publicly accessible.
</Accordion>

<Accordion title='Using Python'>
To prevent SSM (Systems Manager) Documents from being public in EC2 using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps to achieve this:

1. **Install Boto3**:
   Ensure you have Boto3 installed in your Python environment. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by setting environment variables. For example:
   ```bash
   aws configure
   ```

3. **Create a Python Script to List SSM Documents**:
   Write a Python script to list all SSM documents and check their permissions. If any document is public, update its permissions to make it private.

   ```python
   import boto3

   def list_ssm_documents():
       ssm_client = boto3.client('ssm')
       paginator = ssm_client.get_paginator('list_documents')
       for page in paginator.paginate():
           for document in page['DocumentIdentifiers']:
               check_and_update_document_permissions(document['Name'])

   def check_and_update_document_permissions(document_name):
       ssm_client = boto3.client('ssm')
       response = ssm_client.describe_document_permission(
           Name=document_name,
           PermissionType='Share'
       )
       if 'AccountIds' in response and 'all' in response['AccountIds']:
           print(f"Document {document_name} is public. Updating permissions...")
           ssm_client.modify_document_permission(
               Name=document_name,
               PermissionType='Share',
               AccountIdsToRemove=['all']
           )
           print(f"Document {document_name} permissions updated to private.")

   if __name__ == "__main__":
       list_ssm_documents()
   ```

4. **Run the Script**:
   Execute the script to ensure all SSM documents are checked and updated if they are public.

   ```bash
   python your_script_name.py
   ```

This script will list all SSM documents, check their permissions, and update any public documents to be private. This ensures that no SSM document is publicly accessible.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Systems Manager home page.

2. In the navigation pane, choose Documents under Shared Resources.

3. In the list of documents, select the document you want to check.

4. In the document details page, check the "Owner" and "Shared with" fields. If the "Owner" is not your account or "Shared with" is set to "Public", then the SSM document is public.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all SSM Documents: Use the AWS CLI command `aws ssm list-documents` to list all the SSM documents in your AWS account. The command will return a JSON object with details about each SSM document.

   ```
   aws ssm list-documents
   ```
3. Check the permissions of each SSM Document: For each SSM document, you can use the `aws ssm describe-document-permission` command to check its permissions. You need to provide the name of the SSM document as a parameter.

   ```
   aws ssm describe-document-permission --name "document-name"
   ```
   This command will return a JSON object with the permissions of the specified SSM document.

4. Identify public SSM Documents: If the `describe-document-permission` command returns a permission type of "Share" and the account IDs include "*", this indicates that the SSM document is public. You can use a script to automate this process and identify all public SSM documents.

   Here is a simple Python script that uses the AWS SDK (boto3) to do this:

   ```python
   import boto3

   ssm = boto3.client('ssm')

   response = ssm.list_documents()

   for document in response['DocumentIdentifiers']:
       permissions = ssm.describe_document_permission(
           Name=document['Name'],
           PermissionType='Share'
       )
       if '*' in permissions['AccountIdsToShare']:
           print(f"Document {document['Name']} is public")
   ```
   This script lists all SSM documents, checks their permissions, and prints the names of the documents that are public.
</Accordion>

<Accordion title='Using Python'>
To detect if an SSM Document is public in EC2 using Python scripts, you can use the Boto3 library, which allows you to write software that makes use of services like Amazon S3, Amazon EC2, and others. Here are the steps:

1. **Import the Boto3 library in Python:**

    Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:

    ```python
    pip install boto3
    ```

2. **Create an AWS session using Boto3:**

    You need to create a session using your AWS credentials. You can configure your credentials in several ways, but the simplest is to use the AWS CLI tool. Here is an example:

    ```python
    import boto3

    session = boto3.Session(
        aws_access_key_id='YOUR_ACCESS_KEY',
        aws_secret_access_key='YOUR_SECRET_KEY',
        aws_session_token='SESSION_TOKEN',
    )
    ```

3. **Get the list of all SSM documents:**

    Use the `describe_document_permission` method to get the list of all SSM documents and their permissions. This method returns all the SSM documents along with their permissions (Share, Private, Public).

    ```python
    ssm = session.client('ssm')
    response = ssm.describe_document_permission(
        Name='string',
        PermissionType='Share'
    )
    ```

4. **Check if the SSM document is public:**

    Iterate over the response from the previous step and check if any SSM document has the permission type as 'Public'. If it does, then the SSM document is public.

    ```python
    for document in response['DocumentPermissions']:
        if document['PermissionType'] == 'Public':
            print(f"SSM Document {document['Name']} is public")
    ```

This script will print the names of all the SSM documents that are public.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Navigate to the AWS Systems Manager (SSM) Documents page in the AWS Management Console.
2. Identify the SSM documents that are shared with all accounts.
3. Click on the document to view its details.
4. Modify the document permissions to remove the "All" option from the account sharing list.
5. Save the changes.
</Accordion>

<Accordion title='Using CLI'>
```bash
aws ssm modify-document-permission --name <document-name> --permission-type Share --account-ids <account-ids>
```
Replace `<document-name>` with the name of the SSM document and `<account-ids>` with a comma-separated list of account IDs that should have access to the document.

</Accordion>

<Accordion title='Using Python'>
```python
import boto3

def remediate_ssm_document_permission(document_name):
    # Initialize AWS SSM client
    ssm_client = boto3.client('ssm')

    # Remove the "All" option from the document permissions
    response = ssm_client.modify_document_permission(
        Name=document_name,
        PermissionType='Share',
        AccountIds=[],
        SharedDocumentVersion=None
    )
    print(f"Permissions updated for SSM document '{document_name}'.")

def main():
    # Specify the name of the SSM document to remediate
    document_name = 'your-ssm-document-name'

    # Remediate SSM document permissions
    remediate_ssm_document_permission(document_name)

if __name__ == "__main__":
    main()
```

Replace `'your-ssm-document-name'` with the name of the SSM document you want to remediate. This script removes the "All" option from the document permissions to ensure it is not shared with all accounts. Adjust the script as needed to fit your environment and document permissions.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
