---
slug: security_group_counts
title: Security Group Excessive Counts
sidebar_label: Security Group Excessive Counts
---

### More Info:

Your AWS account should not have excessive number of security groups per region.

### Risk Level

Medium

### Address

Security

### Compliance Standards

AWSWAF



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and open the Amazon EC2 dashboard.
2. In the navigation pane, under "Network & Security", click on "Security Groups". This will display a list of all security groups associated with your AWS account.
3. Count the number of security groups listed. If the number exceeds the recommended limit (usually 500 per VPC), then it indicates a misconfiguration.
4. For a more detailed analysis, you can click on each security group to view its inbound and outbound rules. Excessive rules within a security group can also indicate a misconfiguration.

#### Using CLI

1. Install and configure AWS CLI: Before you can run any AWS CLI commands, you need to install and configure the AWS CLI on your local machine. You can do this by following the instructions provided in the AWS CLI User Guide.

2. List all Security Groups: Use the following AWS CLI command to list all the security groups in your AWS account:

   ```
   aws ec2 describe-security-groups --query 'SecurityGroups[*].GroupId' --output text
   ```
   This command will return a list of all security group IDs.

3. Count the number of Security Groups: You can count the number of security groups by piping the output of the previous command to the `wc -l` command in your shell:

   ```
   aws ec2 describe-security-groups --query 'SecurityGroups[*].GroupId' --output text | wc -l
   ```
   This command will return the total number of security groups in your AWS account.

4. Compare the count with AWS limits: AWS has a default limit of 2500 security groups per region for each AWS account. If the number returned by the previous command is close to or exceeds this limit, you have excessive security group counts.

#### Using Python

1. Install the necessary Python libraries: Before you can start writing your Python script, you need to install the necessary libraries. The Boto3 library is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of AWS services like Amazon S3, Amazon EC2, etc. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Configure AWS Credentials: Boto3 needs your AWS credentials (access key and secret access key) to call AWS services on your behalf. You can configure it in several ways, but the simplest is to use the AWS CLI:

   ```bash
   aws configure
   ```

   Then input your Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

3. Write the Python script: Now you can write a Python script to check the number of security groups in your EC2 instances. Here's a simple script that does this:

   ```python
   import boto3

   def count_security_groups():
       ec2 = boto3.resource('ec2')
       security_groups = list(ec2.security_groups.all())
       return len(security_groups)

   print(count_security_groups())
   ```

   This script first creates a resource service client for EC2 using boto3. Then it retrieves all security groups and converts them into a list. The length of this list is the total number of security groups.

4. Run the Python script: Finally, you can run your Python script using the Python interpreter:

   ```bash
   python script.py
   ```

   This will print the total number of security groups in your EC2 instances. If this number is excessively high, it may indicate a misconfiguration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Excessive counts in Security Groups could indicate that there are too many rules in a single Security Group, which can lead to security risks and complexity in managing the rules. To remediate this issue in AWS using the AWS console, follow these steps:

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. Select the Security Group that has excessive counts.
3. Click on the "Edit inbound rules" button to modify the rules.
4. Review the rules and identify any redundant or unnecessary rules.
5. Remove any redundant or unnecessary rules by clicking on the "X" button next to each rule.
6. Consolidate similar rules by combining them into a single rule.
7. Click on the "Save rules" button to save the changes.

By following these steps, you should be able to remediate the excessive counts in the Security Group and reduce the risk of security breaches.

#### Using CLI

The Security Group Excessive Counts issue occurs when a security group has too many rules, which can lead to performance issues and make it difficult to manage the security group. To remediate this issue in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your computer.

2. Use the following command to list all the security groups in your AWS account:

```
aws ec2 describe-security-groups
```

3. Identify the security group that has too many rules.

4. Use the following command to get the details of the security group:

```
aws ec2 describe-security-groups --group-ids <security-group-id>
```

5. Review the rules and identify any rules that are not necessary or duplicates.

6. Use the following command to delete the unnecessary rules:

```
aws ec2 revoke-security-group-ingress --group-id <security-group-id> --ip-permissions <ip-permissions>
```

7. Replace `<security-group-id>` with the ID of the security group that has too many rules.

8. Replace `<ip-permissions>` with the IP permissions of the rule that you want to delete. You can get the IP permissions from the output of the previous command.

9. Repeat steps 6 to 8 for all the unnecessary rules.

10. Use the following command to confirm that the rules have been deleted:

```
aws ec2 describe-security-groups --group-ids <security-group-id>
```

11. Verify that the security group no longer has excessive counts.

Note: Make sure to test the security group after making changes to ensure that it is still functioning as expected.

#### Using Python

To remediate Security Group Excessive Counts in AWS using python, you can follow these steps:

1. Identify the security groups with excessive counts by using the `describe_security_groups` method from the `boto3` library in python. This method will return a list of all the security groups in your AWS account. You can then iterate through this list to identify the security groups with excessive counts.

2. Once you have identified the security groups with excessive counts, you can use the `revoke_ingress` method to remove unnecessary inbound rules. This method takes in the `GroupId` parameter to identify the security group and the `IpPermissions` parameter to specify the inbound rules to be removed.

3. After removing the unnecessary inbound rules, you can use the `authorize_ingress` method to add the necessary inbound rules. This method takes in the `GroupId` parameter to identify the security group and the `IpPermissions` parameter to specify the inbound rules to be added.

Here's a sample code snippet that you can use as a starting point:

```
import boto3

# Create an EC2 client
ec2 = boto3.client('ec2')

# Get all security groups
security_groups = ec2.describe_security_groups()

# Iterate through security groups
for sg in security_groups['SecurityGroups']:
    # Check if security group has excessive counts
    if len(sg['IpPermissions']) > 50:
        # Remove unnecessary inbound rules
        ec2.revoke_ingress(
            GroupId=sg['GroupId'],
            IpPermissions=sg['IpPermissions']
        )
        # Add necessary inbound rules
        ec2.authorize_ingress(
            GroupId=sg['GroupId'],
            IpPermissions=[
                {
                    'IpProtocol': 'tcp',
                    'FromPort': 22,
                    'ToPort': 22,
                    'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
                },
                {
                    'IpProtocol': 'tcp',
                    'FromPort': 80,
                    'ToPort': 80,
                    'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
                }
            ]
        )
```

In this example, we are checking if a security group has more than 50 inbound rules and removing all the inbound rules using the `revoke_ingress` method. We are then adding two necessary inbound rules for SSH and HTTP using the `authorize_ingress` method. You can modify the code to suit your specific requirements.

### Additional Reading:

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html) 


</Tab>
</Tabs>