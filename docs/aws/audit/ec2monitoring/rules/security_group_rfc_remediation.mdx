
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Security Groups from allowing inbound traffic from RFC 1918 addresses in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to Security Groups:**
   - Open the AWS Management Console.
   - In the navigation pane, choose "EC2" to go to the EC2 Dashboard.
   - In the left-hand menu, under "Network & Security," choose "Security Groups."

2. **Select the Security Group:**
   - From the list of security groups, select the security group you want to modify.

3. **Edit Inbound Rules:**
   - With the security group selected, choose the "Inbound rules" tab.
   - Click on the "Edit inbound rules" button.

4. **Remove or Modify Rules:**
   - Review the existing inbound rules and identify any rules that allow traffic from RFC 1918 address ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).
   - Remove or modify these rules to restrict or deny access from these private IP ranges.
   - Click "Save rules" to apply the changes.

By following these steps, you can ensure that your security groups do not allow inbound traffic from RFC 1918 addresses, thereby enhancing the security of your EC2 instances.
</Accordion>

<Accordion title='Using CLI'>
To prevent Security Groups from allowing inbound traffic from RFC 1918 addresses in EC2 using AWS CLI, follow these steps:

1. **Identify the Security Group:**
   First, identify the security group that you want to modify. You can list all security groups to find the relevant one.
   ```sh
   aws ec2 describe-security-groups --query 'SecurityGroups[*].[GroupId,GroupName]' --output table
   ```

2. **Revoke Inbound Rules Allowing RFC 1918 Addresses:**
   Revoke any inbound rules that allow traffic from RFC 1918 addresses (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).
   ```sh
   aws ec2 revoke-security-group-ingress --group-id <SecurityGroupId> --protocol tcp --port <PortNumber> --cidr 10.0.0.0/8
   aws ec2 revoke-security-group-ingress --group-id <SecurityGroupId> --protocol tcp --port <PortNumber> --cidr 172.16.0.0/12
   aws ec2 revoke-security-group-ingress --group-id <SecurityGroupId> --protocol tcp --port <PortNumber> --cidr 192.168.0.0/16
   ```

3. **Add Secure Inbound Rules:**
   Add secure inbound rules that do not include RFC 1918 addresses. For example, allow traffic only from specific IP addresses or ranges that are not part of RFC 1918.
   ```sh
   aws ec2 authorize-security-group-ingress --group-id <SecurityGroupId> --protocol tcp --port <PortNumber> --cidr <AllowedCIDR>
   ```

4. **Verify the Security Group Configuration:**
   Verify that the security group no longer allows inbound traffic from RFC 1918 addresses.
   ```sh
   aws ec2 describe-security-groups --group-ids <SecurityGroupId> --query 'SecurityGroups[*].IpPermissions'
   ```

Replace `<SecurityGroupId>`, `<PortNumber>`, and `<AllowedCIDR>` with the appropriate values for your specific use case.
</Accordion>

<Accordion title='Using Python'>
To prevent Security Groups from allowing inbound traffic from RFC 1918 addresses in EC2 using Python scripts, you can use the Boto3 library, which is the AWS SDK for Python. Here are the steps:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Initialize Boto3 Client**:
   Initialize the Boto3 EC2 client to interact with the EC2 service.
   ```python
   import boto3

   ec2_client = boto3.client('ec2')
   ```

3. **Retrieve Security Groups**:
   Retrieve all security groups in your AWS account.
   ```python
   security_groups = ec2_client.describe_security_groups()
   ```

4. **Check and Prevent RFC 1918 Inbound Rules**:
   Iterate through the security groups and their inbound rules to check for RFC 1918 addresses. If found, remove or prevent these rules.
   ```python
   RFC_1918_CIDR_BLOCKS = [
       '10.0.0.0/8',
       '172.16.0.0/12',
       '192.168.0.0/16'
   ]

   for sg in security_groups['SecurityGroups']:
       sg_id = sg['GroupId']
       for permission in sg['IpPermissions']:
           for ip_range in permission.get('IpRanges', []):
               cidr = ip_range['CidrIp']
               if any(cidr.startswith(rfc) for rfc in RFC_1918_CIDR_BLOCKS):
                   # Remove the rule
                   ec2_client.revoke_security_group_ingress(
                       GroupId=sg_id,
                       IpProtocol=permission['IpProtocol'],
                       FromPort=permission.get('FromPort'),
                       ToPort=permission.get('ToPort'),
                       CidrIp=cidr
                   )
                   print(f"Removed RFC 1918 rule {cidr} from security group {sg_id}")
   ```

This script will help you prevent security groups from allowing inbound traffic from RFC 1918 addresses by removing any such rules found. Make sure to run this script with appropriate permissions and test it in a non-production environment first to ensure it works as expected.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the left navigation pane, under the "Network & Security" section, click on "Security Groups".
3. Select the security group you want to inspect. In the lower pane, click on the "Inbound rules" tab to view the inbound traffic rules.
4. Check the "Source" column for each rule. If any rule has a source IP address that falls within the RFC 1918 address space (10.0.0.0 - 10.255.255.255, 172.16.0.0 - 172.31.255.255, 192.168.0.0 - 192.168.255.255), then the security group is misconfigured as it allows inbound traffic from RFC 1918 address space.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all security groups: Use the following command to list all the security groups in your AWS account.

   ```
   aws ec2 describe-security-groups --query 'SecurityGroups[*].GroupId' --output text
   ```

3. Check inbound rules for each security group: For each security group, you need to check the inbound rules to see if they allow traffic from RFC 1918 address ranges (10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16). You can do this by running the following command for each security group:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions[*].IpRanges[*].CidrIp' --output text
   ```

   Replace `<security-group-id>` with the ID of the security group you want to check.

4. Analyze the output: If the output of the above command includes any of the RFC 1918 address ranges, then the security group allows inbound traffic from those ranges. If not, then it doesn't. You need to repeat steps 3 and 4 for each security group in your AWS account.
</Accordion>

<Accordion title='Using Python'>
1. First, you need to install the necessary Python libraries. Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary libraries and establish a session with AWS. You will need your access key and secret access key for this step.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Now, you can use the EC2 resource from this session to get all the security groups. For each security group, check the inbound rules. If any rule allows traffic from RFC 1918 address ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16), then it's a misconfiguration.

```python
ec2_resource = session.resource('ec2')

for security_group in ec2_resource.security_groups.all():
    for rule in security_group.ip_permissions:
        for ip_range in rule['IpRanges']:
            if ip_range['CidrIp'] in ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']:
                print(f"Security Group {security_group.id} allows inbound traffic from RFC 1918 address ranges.")
```

4. The above script will print out the IDs of all security groups that have this misconfiguration. You can then take the necessary steps to fix these issues.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step-by-step instructions to remediate the misconfiguration "Security Groups Should Not Allow Inbound Traffic From RFC 1918" for AWS using the AWS console:

1. Log in to the AWS Management Console.
2. Navigate to the EC2 service.
3. Click on "Security Groups" from the left-hand menu.
4. Select the security group that needs to be remediated.
5. Click on the "Inbound Rules" tab.
6. Identify the inbound rule(s) that allow traffic from RFC 1918 addresses (10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16).
7. Click on the "Edit" button for the rule that needs to be remediated.
8. Change the "Source" field to a specific IP address or range that is allowed to access the resource(s) protected by the security group.
9. Alternatively, you can also change the "Source" field to "Custom" and enter an IP address or range that is not part of RFC 1918.
10. Click on the "Save rules" button to apply the changes.

After following these steps, the security group will no longer allow inbound traffic from RFC 1918 addresses.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Security Groups Should Not Allow Inbound Traffic From RFC 1918" for AWS using AWS CLI, you can follow the below steps:

Step 1: Identify the Security Group(s) that allow inbound traffic from RFC 1918 IP addresses. 

```
aws ec2 describe-security-groups --filters Name=ip-permission.cidr,Values=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"
```

This command will list all the security groups that allow inbound traffic from RFC 1918 IP addresses.

Step 2: Revoke the Inbound Rule from the Security Group(s) identified in Step 1.

```
aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port <port-number> --cidr <RFC 1918 IP address range>
```

Replace `<security-group-id>` with the ID of the security group, `<port-number>` with the port number that is open to RFC 1918 IP addresses, and `<RFC 1918 IP address range>` with the appropriate RFC 1918 IP address range.

Repeat this command for each security group identified in Step 1.

Step 3: Verify that the Inbound Rule has been revoked.

```
aws ec2 describe-security-groups --group-id <security-group-id> --query "SecurityGroups[*].IpPermissions[*].{Protocol:IpProtocol,FromPort:FromPort,ToPort:ToPort,IPRange:CidrIp}"
```

Replace `<security-group-id>` with the ID of the security group.

This command will list all the inbound rules for the security group. Verify that the rule allowing inbound traffic from RFC 1918 IP addresses has been revoked.

Repeat this command for each security group identified in Step 1.

By following these steps, you can remediate the misconfiguration "Security Groups Should Not Allow Inbound Traffic From RFC 1918" for AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of Security Groups allowing inbound traffic from RFC 1918 in AWS using Python, follow these steps:

1. List all the security groups in your AWS account using the `describe_security_groups` method from the `boto3` library.

```python
import boto3

client = boto3.client('ec2')

response = client.describe_security_groups()
security_groups = response['SecurityGroups']
```

2. Iterate through the security groups and for each security group, check if it allows inbound traffic from RFC 1918. If it does, update the security group to remove the rule.

```python
for sg in security_groups:
    for rule in sg['IpPermissions']:
        if 'IpRanges' in rule:
            for ip_range in rule['IpRanges']:
                if 'Description' in ip_range and 'RFC 1918' in ip_range['Description']:
                    sg_id = sg['GroupId']
                    protocol = rule['IpProtocol']
                    from_port = rule['FromPort']
                    to_port = rule['ToPort']
                    cidr_ip = ip_range['CidrIp']
                    client.revoke_security_group_ingress(
                        GroupId=sg_id,
                        IpPermissions=[
                            {
                                'IpProtocol': protocol,
                                'FromPort': from_port,
                                'ToPort': to_port,
                                'IpRanges': [
                                    {
                                        'CidrIp': cidr_ip,
                                        'Description': 'Removed RFC 1918 rule'
                                    },
                                ],
                            },
                        ],
                    )
```

3. After running the script, all the security groups that allow inbound traffic from RFC 1918 will be updated to remove the rule.

Note: Before running the script, make sure you have the necessary permissions to modify security groups in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
