
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent unrestricted HTTPS access in EC2 using the AWS Management Console, follow these steps:

1. **Navigate to Security Groups:**
   - Open the AWS Management Console.
   - In the navigation pane, choose "EC2" under the "Compute" section.
   - In the left-hand menu, select "Security Groups" under the "Network & Security" section.

2. **Identify the Security Group:**
   - Locate the security group associated with your EC2 instance that you want to modify.
   - Click on the security group ID to view its details.

3. **Edit Inbound Rules:**
   - In the security group details, go to the "Inbound rules" tab.
   - Click the "Edit inbound rules" button.

4. **Restrict HTTPS Access:**
   - Find the rule that allows HTTPS (port 443) access.
   - Modify the "Source" field to restrict access to specific IP addresses or CIDR blocks instead of allowing access from "0.0.0.0/0" (which means unrestricted access).
   - Click "Save rules" to apply the changes.

By following these steps, you can ensure that HTTPS access to your EC2 instances is restricted to only trusted IP addresses, thereby enhancing the security of your instances.
</Accordion>

<Accordion title='Using CLI'>
To prevent unrestricted HTTPS access in EC2 using AWS CLI, you need to modify the security group rules to restrict access. Here are the steps:

1. **Identify the Security Group:**
   First, identify the security group associated with your EC2 instance.

   ```sh
   aws ec2 describe-instances --instance-ids <instance-id> --query "Reservations[*].Instances[*].SecurityGroups[*].GroupId" --output text
   ```

2. **Describe Security Group Rules:**
   Describe the security group rules to find the rule that allows unrestricted HTTPS access (port 443).

   ```sh
   aws ec2 describe-security-groups --group-ids <security-group-id>
   ```

3. **Revoke Unrestricted HTTPS Access:**
   Revoke the rule that allows unrestricted HTTPS access (0.0.0.0/0 or ::/0).

   ```sh
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 443 --cidr 0.0.0.0/0
   ```

   For IPv6:

   ```sh
   aws ec2 revoke-security-group-ingress --group-id <security-group-id> --protocol tcp --port 443 --cidr ::/0
   ```

4. **Add Restricted HTTPS Access:**
   Add a rule to allow HTTPS access from a specific IP range or trusted sources.

   ```sh
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol tcp --port 443 --cidr <trusted-ip-range>
   ```

   For example, to allow access only from a specific IP address (e.g., 203.0.113.0/24):

   ```sh
   aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol tcp --port 443 --cidr 203.0.113.0/24
   ```

By following these steps, you can ensure that HTTPS access to your EC2 instances is restricted to trusted sources only.
</Accordion>

<Accordion title='Using Python'>
To prevent unrestricted HTTPS access in EC2 using Python scripts, you can use the Boto3 library, which is the Amazon Web Services (AWS) SDK for Python. Here are the steps to achieve this:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed. If not, you can install it using pip:
   ```bash
   pip install boto3
   ```

2. **Create a Boto3 Session**:
   Initialize a Boto3 session with your AWS credentials and region.

3. **Identify Security Groups with Unrestricted HTTPS Access**:
   Use Boto3 to describe security groups and identify those with unrestricted HTTPS access (port 443 open to 0.0.0.0/0).

4. **Revoke Unrestricted HTTPS Access**:
   Modify the identified security groups to revoke the unrestricted HTTPS access.

Here is a Python script to perform these steps:

```python
import boto3

# Initialize a session using Amazon EC2
session = boto3.Session(
    aws_access_key_id='YOUR_AWS_ACCESS_KEY',
    aws_secret_access_key='YOUR_AWS_SECRET_KEY',
    region_name='YOUR_AWS_REGION'
)

ec2 = session.client('ec2')

# Describe all security groups
response = ec2.describe_security_groups()

for sg in response['SecurityGroups']:
    for permission in sg['IpPermissions']:
        if permission['IpProtocol'] == 'tcp' and permission['FromPort'] == 443 and permission['ToPort'] == 443:
            for ip_range in permission['IpRanges']:
                if ip_range['CidrIp'] == '0.0.0.0/0':
                    print(f"Security Group {sg['GroupId']} has unrestricted HTTPS access.")
                    
                    # Revoke the rule
                    ec2.revoke_security_group_ingress(
                        GroupId=sg['GroupId'],
                        IpProtocol='tcp',
                        FromPort=443,
                        ToPort=443,
                        CidrIp='0.0.0.0/0'
                    )
                    print(f"Revoked unrestricted HTTPS access from Security Group {sg['GroupId']}.")

print("Completed checking and revoking unrestricted HTTPS access.")
```

### Key Points:
1. **Install Boto3**: Ensure the Boto3 library is installed.
2. **Create a Boto3 Session**: Initialize a session with your AWS credentials.
3. **Identify Security Groups**: Use `describe_security_groups` to find security groups with unrestricted HTTPS access.
4. **Revoke Access**: Use `revoke_security_group_ingress` to remove the unrestricted access.

This script will help you identify and revoke any security group rules that allow unrestricted HTTPS access, thereby enhancing the security of your EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the left navigation pane, under the "NETWORK & SECURITY" section, click on "Security Groups".
3. In the Security Groups page, you will see a list of all the security groups associated with your EC2 instances. Click on the security group that you want to check.
4. In the details pane at the bottom, click on the "Inbound" tab. Here, you can see all the inbound rules for this security group. If there is a rule that allows unrestricted HTTPS access (0.0.0.0/0 or ::/0 in the source), then this is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all security groups: Once your AWS CLI is set up, you can list all the security groups in your account by running the following command:
   ```
   aws ec2 describe-security-groups --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"
   ```
   This command will return a list of all security groups along with their names and IDs.

3. Check security group rules: For each security group, you need to check the inbound rules to see if they allow unrestricted HTTPS access. You can do this by running the following command:
   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions[*]'
   ```
   Replace `<security-group-id>` with the ID of the security group you want to check. This command will return a list of all inbound rules for the specified security group.

4. Detect unrestricted HTTPS access: In the output of the previous command, look for rules where the `IpProtocol` is `tcp`, the `FromPort` is `443`, and the `IpRanges` includes `0.0.0.0/0`. This indicates that the security group allows unrestricted HTTPS access.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3):
   You need to install Boto3 in your Python environment. You can do this using pip:
   ```
   pip install boto3
   ```
   After installing Boto3, you need to configure it. You can do this by creating a new session using your AWS credentials:
   ```python
   import boto3

   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='YOUR_REGION'
   )
   ```

2. List all security groups:
   Use the `describe_security_groups` method to get a list of all security groups in your AWS account:
   ```python
   ec2 = session.resource('ec2')
   security_groups = ec2.describe_security_groups()
   ```

3. Check each security group for unrestricted HTTPS access:
   For each security group, check if it has a rule that allows unrestricted HTTPS access. This can be done by checking if the security group has a rule with `IpProtocol` set to 'tcp', `FromPort` and `ToPort` set to 443 (the port for HTTPS), and `CidrIp` set to '0.0.0.0/0' (which means all IP addresses):
   ```python
   for group in security_groups['SecurityGroups']:
       for permission in group['IpPermissions']:
           if permission['IpProtocol'] == 'tcp' and permission['FromPort'] == 443 and permission['ToPort'] == 443:
               for range in permission['IpRanges']:
                   if range['CidrIp'] == '0.0.0.0/0':
                       print(f"Security group {group['GroupId']} allows unrestricted HTTPS access")
   ```

4. Run the script:
   Finally, run the script. If there are any security groups that allow unrestricted HTTPS access, they will be printed out. If there are no such security groups, nothing will be printed out. This way, you can easily detect if unrestricted HTTPS access is allowed in your AWS EC2 instances.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the "Unrestricted HTTPS Access Should Not Be Allowed" misconfiguration in AWS, you can follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the AWS EC2 service.
3. Click on the "Security Groups" option from the left-hand menu.
4. Select the security group that is associated with the instance(s) that have unrestricted HTTPS access.
5. Click on the "Inbound Rules" tab.
6. Locate the HTTPS rule that has unrestricted access (i.e., source is set to "0.0.0.0/0" or "::/0").
7. Click on the "Edit" button for the rule.
8. Change the source to a more restrictive IP range or security group that requires HTTPS access.
9. Click on the "Save Rules" button to apply the changes.

Note: If you are unsure which security group is associated with the instance(s) that have unrestricted HTTPS access, you can view the instance details to find the security group ID and then navigate to the Security Groups section to find the security group.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of unrestricted HTTPS access in AWS using AWS CLI, follow these steps:

Step 1: Open the AWS CLI in your terminal or command prompt.

Step 2: Run the following command to list all the security groups in your AWS account:

```
aws ec2 describe-security-groups
```

Step 3: Identify the security group(s) that have unrestricted HTTPS access allowed.

Step 4: Run the following command to remove the HTTPS access rule from the identified security group(s):

```
aws ec2 revoke-security-group-ingress --group-id <security_group_id> --protocol tcp --port 443 --cidr 0.0.0.0/0
```

Note: Replace `<security_group_id>` with the actual ID of the security group that needs to be remediated.

Step 5: Verify that the HTTPS access rule has been removed by running the following command:

```
aws ec2 describe-security-groups --group-id <security_group_id>
```

Note: Replace `<security_group_id>` with the actual ID of the security group that was remediated.

Step 6: Repeat the above steps for all the security groups that have unrestricted HTTPS access allowed.

By following the above steps, you can remediate the misconfiguration of unrestricted HTTPS access in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the unrestricted HTTPS access issue in AWS using Python, you can follow the below steps:

1. Identify the Security Group(s) which are allowing unrestricted HTTPS access.
2. Using the AWS SDK for Python (Boto3), modify the inbound rules of the identified Security Group(s) to allow HTTPS access only from trusted sources.
3. Create a script to automate this process for all the Security Group(s) in your AWS account.

Here is a sample Python code to remediate the issue:

```
import boto3

# Define the AWS region and security group id
region = 'us-east-1'
security_group_id = 'sg-0123456789abcdef'

# Create an EC2 client
ec2 = boto3.client('ec2', region_name=region)

# Get the existing inbound rules of the security group
response = ec2.describe_security_groups(GroupIds=[security_group_id])

# Modify the inbound rules to allow HTTPS access only from trusted sources
ec2.authorize_security_group_ingress(
    GroupId=security_group_id,
    IpPermissions=[
        {
            'IpProtocol': 'tcp',
            'FromPort': 443,
            'ToPort': 443,
            'IpRanges': [
                {
                    'CidrIp': 'trusted_ip_address/32'
                }
            ]
        }
    ]
)
```

Note: Replace the `region` and `security_group_id` variables with your own values. Also, replace the `trusted_ip_address` with the IP address(es) of the trusted sources that should be allowed HTTPS access.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
