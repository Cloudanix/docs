---
slug: redshift_reserved_node_expiry_in_7_days
title: Redshift Reserved Node Lease Expiration In The Next 7 Days
sidebar_label: Redshift Reserved Node Lease Expiration In The Next 7 Days
---

### More Info:

Amazon Redshift Reserved Nodes (RN) should be renewed before expiration.

### Risk Level

Low

### Address

Cost Optimisation

### Compliance Standards

CBP



### Triage and Remediation
<Tabs>



<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Redshift Reserved Node Lease Expiration in the next 7 days using the AWS Management Console, follow these steps:

1. **Navigate to Redshift Dashboard:**
   - Open the AWS Management Console.
   - In the search bar, type "Redshift" and select "Amazon Redshift" from the dropdown.

2. **Check Reserved Node Expiration:**
   - In the Redshift dashboard, go to the "Reserved Nodes" section.
   - Review the list of reserved nodes and check the expiration dates to identify any nodes expiring within the next 7 days.

3. **Set Up Notifications:**
   - Go to the "Billing and Cost Management" dashboard.
   - Navigate to "Budgets" and create a new budget specifically for Redshift reserved nodes.
   - Set up alerts to notify you when a reserved node is approaching its expiration date.

4. **Plan for Renewal or Purchase:**
   - Based on the expiration information, plan to either renew the expiring reserved nodes or purchase new ones.
   - Ensure you have the necessary budget and approvals in place to make the purchase or renewal decision promptly.

By following these steps, you can proactively manage your Redshift reserved nodes and avoid unexpected lease expirations.
</Accordion>

<Accordion title='Using CLI'>
To prevent Redshift Reserved Node Lease Expiration in the next 7 days using AWS CLI, you can follow these steps:

1. **Check Current Reserved Nodes:**
   First, you need to list all your reserved nodes to identify which ones are nearing expiration.
   ```sh
   aws redshift describe-reserved-nodes
   ```

2. **Set Up CloudWatch Alarms:**
   Create a CloudWatch alarm to monitor the expiration of reserved nodes. This will notify you before the lease expires.
   ```sh
   aws cloudwatch put-metric-alarm --alarm-name "RedshiftReservedNodeExpiration" \
   --metric-name "ReservedNodeExpiration" --namespace "AWS/Redshift" \
   --statistic "Maximum" --period 86400 --threshold 1 --comparison-operator "GreaterThanOrEqualToThreshold" \
   --evaluation-periods 7 --alarm-actions "arn:aws:sns:your-region:your-account-id:your-sns-topic"
   ```

3. **Automate Renewal with Lambda:**
   Create a Lambda function that automatically renews the reserved nodes. First, create a Lambda function and then use the following command to add a trigger for the CloudWatch alarm.
   ```sh
   aws lambda create-function --function-name RenewRedshiftReservedNodes \
   --runtime python3.8 --role arn:aws:iam::your-account-id:role/your-lambda-role \
   --handler lambda_function.lambda_handler --zip-file fileb://function.zip
   ```

4. **Schedule Regular Checks:**
   Use AWS CLI to create a scheduled event that triggers the Lambda function to check and renew reserved nodes regularly.
   ```sh
   aws events put-rule --schedule-expression "rate(1 day)" --name "CheckRedshiftReservedNodes"
   aws events put-targets --rule "CheckRedshiftReservedNodes" --targets "Id"="1","Arn"="arn:aws:lambda:your-region:your-account-id:function:RenewRedshiftReservedNodes"
   ```

By following these steps, you can proactively monitor and renew your Redshift reserved nodes, preventing lease expiration issues.
</Accordion>

<Accordion title='Using Python'>
To prevent Redshift Reserved Node Lease Expiration in the next 7 days using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   - Install Boto3 if you haven't already.
   - Configure your AWS credentials.

   ```bash
   pip install boto3
   ```

   ```python
   import boto3

   # Initialize a session using Amazon Redshift
   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='YOUR_REGION'
   )

   redshift = session.client('redshift')
   ```

2. **Fetch Reserved Nodes Information:**
   - Use the `describe_reserved_nodes` method to get details about your reserved nodes.

   ```python
   import datetime

   def get_reserved_nodes():
       response = redshift.describe_reserved_nodes()
       return response['ReservedNodes']

   reserved_nodes = get_reserved_nodes()
   ```

3. **Check for Expiration Dates:**
   - Iterate through the reserved nodes and check if any are expiring within the next 7 days.

   ```python
   def check_expiring_nodes(reserved_nodes):
       expiring_nodes = []
       current_date = datetime.datetime.now(datetime.timezone.utc)
       for node in reserved_nodes:
           expiration_date = node['ReservedNodeOfferingType']
           if expiration_date - current_date <= datetime.timedelta(days=7):
               expiring_nodes.append(node)
       return expiring_nodes

   expiring_nodes = check_expiring_nodes(reserved_nodes)
   ```

4. **Notify or Take Preventive Action:**
   - You can set up a notification system (e.g., send an email or a message to an SNS topic) to alert you about the expiring nodes.
   - Alternatively, you can automate the renewal process if you have predefined criteria.

   ```python
   import smtplib
   from email.mime.text import MIMEText

   def send_notification(expiring_nodes):
       if not expiring_nodes:
           return

       msg_content = f"The following Redshift reserved nodes are expiring in the next 7 days:\n{expiring_nodes}"
       msg = MIMEText(msg_content)
       msg['Subject'] = 'Redshift Reserved Node Expiration Alert'
       msg['From'] = 'your-email@example.com'
       msg['To'] = 'recipient-email@example.com'

       with smtplib.SMTP('smtp.example.com') as server:
           server.login('your-email@example.com', 'your-email-password')
           server.sendmail(msg['From'], [msg['To']], msg.as_string())

   send_notification(expiring_nodes)
   ```

By following these steps, you can proactively monitor and prevent Redshift Reserved Node Lease Expiration using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Redshift dashboard. From the navigation pane, choose "Clusters".
3. In the Clusters section, you will see a list of all your Redshift clusters. Click on the cluster for which you want to check the Reserved Node Lease Expiration.
4. In the cluster details page, navigate to the "Configuration" tab. Here, you can find the "Node Configuration" section which includes details about the lease of the reserved node. Check the "Lease Expiration" date to see if it falls within the next 7 days.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all Redshift Reserved Nodes: Use the `describe-reserved-nodes` command to list all the reserved nodes in your Redshift cluster. This command returns a JSON output that includes details about each reserved node.

   ```
   aws redshift describe-reserved-nodes
   ```

3. Parse the output: The output from the previous command includes a `StartTime` field that indicates when the lease for each reserved node started. You can calculate the expiration date by adding the lease duration to this start time. 

   You can use a tool like `jq` to parse the JSON output and extract the necessary information. For example, the following command extracts the `ReservedNodeId` and `StartTime` for each reserved node:

   ```
   aws redshift describe-reserved-nodes | jq -r '.ReservedNodes[] | .ReservedNodeId, .StartTime'
   ```

4. Check for upcoming lease expirations: Now that you have the start time for each reserved node, you can calculate the expiration date and check if it falls within the next 7 days. You can do this using a scripting language like Python or Bash. For example, in Python, you could use the `datetime` module to calculate the expiration date and compare it to the current date:

   ```python
   from datetime import datetime, timedelta

   # Replace these with the actual start time and lease duration
   start_time = datetime.strptime(start_time_str, '%Y-%m-%dT%H:%M:%S.%fZ')
   lease_duration = timedelta(days=365)  # 1 year lease

   expiration_date = start_time + lease_duration
   if expiration_date <= datetime.now() + timedelta(days=7):
       print(f'Reserved node {reserved_node_id} will expire in the next 7 days')
   ```
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3) on your local system. Boto3 allows you to directly create, update, and delete AWS services from your Python scripts.

2. Import the necessary libraries and establish a session with AWS using your access keys.

```python
import boto3
from datetime import datetime, timedelta

# Create a session using your AWS credentials
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'  # or your preferred region
)
```

3. Create a Redshift client using the session created above and retrieve all reserved nodes.

```python
# Create a Redshift client
redshift = session.client('redshift')

# Get all reserved nodes
response = redshift.describe_reserved_nodes()

reserved_nodes = response['ReservedNodes']
```

4. Iterate over the reserved nodes and check if the lease expiration is within the next 7 days.

```python
# Get the current date and time
now = datetime.now()

# Calculate the date and time 7 days from now
seven_days_from_now = now + timedelta(days=7)

# Iterate over the reserved nodes
for node in reserved_nodes:
    # Get the lease expiration date and time
    lease_expiration = node['StartTime'] + timedelta(days=node['Duration'])

    # Check if the lease expiration is within the next 7 days
    if now <= lease_expiration <= seven_days_from_now:
        print(f"Reserved node {node['ReservedNodeId']} will expire in the next 7 days.")
```

This script will print out the IDs of all reserved nodes that will expire in the next 7 days. You can modify it to take other actions as needed, such as sending an email notification.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of Redshift Reserved Node Lease Expiration in the next 7 days in AWS using the AWS Management Console, follow these steps:

1. **Sign in to the AWS Management Console**: Go to https://aws.amazon.com/ and sign in to your AWS account.

2. **Navigate to Amazon Redshift Console**: Click on the "Services" dropdown menu at the top of the page and select "Redshift" under the Analytics section. This will take you to the Amazon Redshift Console.

3. **Check Reserved Nodes**: In the left navigation pane, click on "Clusters" to view your Redshift clusters. Then, click on the cluster for which you want to check the Reserved Node Lease Expiration.

4. **View Reserved Nodes**: In the cluster details page, scroll down to the "Cluster Details" section. Under the "Node Configuration" tab, you will find the details of your Reserved Nodes, including the expiration date.

5. **Renew Reserved Node Lease**: If the Reserved Node Lease is expiring within the next 7 days, you will need to renew the lease to avoid any disruption in your Redshift cluster. To renew the lease, follow these steps:
   
   - Click on the "Reserved Nodes" tab.
   - Select the Reserved Node that is expiring soon.
   - Click on the "Actions" dropdown menu and select "Modify Reserved Node".
   - In the Modify Reserved Node dialog box, adjust the lease duration to extend the expiration date beyond the next 7 days.
   - Click "Modify" to update the Reserved Node lease.

6. **Verify Lease Renewal**: Once you have renewed the Reserved Node lease, go back to the cluster details page and verify that the expiration date has been extended beyond the next 7 days.

By following these steps, you can successfully remediate the issue of Redshift Reserved Node Lease Expiration in the next 7 days in AWS using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of Redshift Reserved Node Lease Expiration in the next 7 days using AWS CLI, follow these steps:

1. **List Reserved Nodes:** First, list all the reserved nodes in your Redshift cluster using the following AWS CLI command:
   ```
   aws redshift describe-reserved-nodes
   ```

2. **Identify Expiring Nodes:** Identify the reserved nodes that are expiring in the next 7 days from the output of the above command.

3. **Purchase New Reserved Nodes:** To avoid any downtime, purchase new reserved nodes to replace the expiring ones. You can purchase new reserved nodes using the following AWS CLI command:
   ```
   aws redshift purchase-reserved-node-offering --reserved-node-offering-id <offering-id> --node-count <count>
   ```
   Replace `<offering-id>` with the ID of the reserved node offering you want to purchase and `<count>` with the number of nodes you want to purchase.

4. **Modify Cluster:** Modify your Redshift cluster to use the newly purchased reserved nodes. You can modify the cluster using the following AWS CLI command:
   ```
   aws redshift modify-cluster --cluster-identifier <cluster-identifier> --node-type <node-type> --number-of-nodes <number-of-nodes>
   ```
   Replace `<cluster-identifier>` with the identifier of your Redshift cluster, `<node-type>` with the type of nodes you want to use, and `<number-of-nodes>` with the total number of nodes in the cluster.

5. **Verify Changes:** After modifying the cluster, verify that the new reserved nodes are being used and the expiring nodes are no longer in use.

By following these steps, you can remediate the issue of Redshift Reserved Node Lease Expiration in the next 7 days for AWS Redshift using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of Redshift Reserved Node Lease Expiration in the next 7 days using Python, you can create a script that will check the expiration date of the reserved node leases and take necessary actions. Here's a step-by-step guide to remediate this issue:

Step 1: Install the necessary Python libraries
Make sure you have the AWS SDK for Python (Boto3) installed. You can install it using pip:

```bash
pip install boto3
```

Step 2: Write a Python script to check the expiration date of reserved nodes
Create a Python script that will use Boto3 to interact with AWS Redshift and check the expiration date of the reserved nodes. Here's an example script:

```python
import boto3
from datetime import datetime, timedelta

# Initialize the Redshift client
client = boto3.client('redshift')

# Get a list of reserved nodes
response = client.describe_reserved_nodes()

# Check the expiration date of each reserved node
for node in response['ReservedNodes']:
    expiration_date = node['StartTime'] + timedelta(days=node['Duration'])
    days_until_expiration = (expiration_date - datetime.now()).days

    if days_until_expiration <= 7:
        print(f"Reserved Node {node['ReservedNodeId']} expires in {days_until_expiration} days. Renewing...")
        # Add code here to renew the reserved node lease
```

Step 3: Add code to renew the reserved node lease
In the script above, you need to add code to renew the reserved node lease if the expiration date is within the next 7 days. You can use the `modify_reserved_node` method to modify the reserved node lease with an extended duration.

Step 4: Schedule the script to run periodically
You can schedule the script to run periodically using a cron job or a scheduler like AWS CloudWatch Events. Set it to run daily or as frequently as needed to check for reserved node leases expiring within the next 7 days.

By following these steps and customizing the script according to your requirements, you can effectively remediate the issue of Redshift Reserved Node Lease Expiration in the next 7 days using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/redshift/latest/mgmt/purchase-reserved-node-instance.html](https://docs.aws.amazon.com/redshift/latest/mgmt/purchase-reserved-node-instance.html) 

