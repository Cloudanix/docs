---
slug: redshift_cluster_in_vpc
title: Redshift Clusters Should Be Launched Within a VPC
sidebar_label: Redshift Clusters Should Be Launched Within a VPC
---

### More Info:

Your Redshift clusters should be provisioned within the AWS EC2-VPC platform instead of EC2-Classic platform (outdated) for better flexibility and control over clusters security, traffic routing, availability and more.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the Redshift dashboard by selecting "Services" from the top menu, then selecting "Redshift" under the "Database" category.
3. In the Redshift dashboard, select "Clusters" from the left-hand menu. This will display a list of all your Redshift clusters.
4. For each cluster, check the "VPC ID" column. If any cluster has "None" or "N/A" listed in this column, it means that the cluster is not launched within a VPC, indicating a misconfiguration.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the Redshift clusters.

2. Once the AWS CLI is installed and configured, you can list all the Redshift clusters using the following command:

   ```
   aws redshift describe-clusters --query 'Clusters[*].[ClusterIdentifier]' --output text
   ```
   This command will return a list of all Redshift cluster identifiers.

3. For each cluster identifier, you can check if it is launched within a VPC by using the following command:

   ```
   aws redshift describe-clusters --cluster-identifier <cluster-identifier> --query 'Clusters[*].[VpcId]' --output text
   ```
   Replace `<cluster-identifier>` with the actual cluster identifier. This command will return the VPC ID if the cluster is launched within a VPC. If the cluster is not launched within a VPC, it will return `None`.

4. Repeat step 3 for each cluster identifier. If any of the clusters is not launched within a VPC, it indicates a misconfiguration.

#### Using Python

To check if Redshift Clusters are launched within a VPC using Python scripts, you can use the Boto3 library which allows you to directly interact with AWS services such as Redshift. Here are the steps:

1. **Import the Boto3 library and create a Redshift client:**

    ```python
    import boto3
    redshift = boto3.client('redshift')
    ```

2. **Retrieve all Redshift clusters:**

    ```python
    clusters = redshift.describe_clusters()
    ```

    This will return a dictionary containing all the Redshift clusters.

3. **Iterate over each cluster and check the VPC ID:**

    ```python
    for cluster in clusters['Clusters']:
        if 'VpcId' not in cluster or not cluster['VpcId']:
            print(f"Cluster {cluster['ClusterIdentifier']} is not launched within a VPC.")
    ```

    This will print out the identifiers of all Redshift clusters that are not launched within a VPC.

4. **Handle exceptions:**

    It's a good practice to handle exceptions that may occur during the execution of the script. For instance, you can catch the `botocore.exceptions.NoCredentialsError` exception which is thrown when the Boto3 library is unable to find the credentials to use.

    ```python
    try:
        # The previous code goes here.
    except botocore.exceptions.NoCredentialsError:
        print("No AWS credentials found.")
    ```

Remember to replace `'redshift'` with the appropriate AWS region code if necessary.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of launching Redshift clusters outside of a VPC in AWS, follow these steps using the AWS Management Console:

1. **Create a VPC (Virtual Private Cloud)**:
   - Go to the AWS Management Console and navigate to the VPC dashboard.
   - Click on "Create VPC" and provide the necessary details like VPC name, CIDR block, and other configurations.
   - Create at least one subnet within the VPC for your Redshift cluster.

2. **Modify Redshift Cluster Configuration**:
   - Go to the Amazon Redshift console.
   - Select the Redshift cluster that is not within a VPC.
   - Click on the "Cluster" actions dropdown and select "Modify".
   - In the "Network and security" section, choose the VPC and the subnet you created in step 1.
   - Save the changes.

3. **Verify the Configuration**:
   - Once the modification is complete, verify that the Redshift cluster is now launched within the VPC.
   - Check the VPC ID and subnet ID associated with the Redshift cluster to ensure it is within the desired VPC.

4. **Update Security Group Rules**:
   - Update the security group rules associated with the Redshift cluster to allow necessary inbound and outbound traffic within the VPC.

5. **Test the Redshift Cluster**:
   - After making these changes, test the Redshift cluster to ensure it is functioning as expected within the VPC.

By following these steps, you can remediate the misconfiguration of launching Redshift clusters outside of a VPC in AWS and ensure that your Redshift cluster is securely deployed within a VPC.

#### Using CLI

To remediate the misconfiguration of launching Redshift clusters within a VPC in AWS using AWS CLI, follow these steps:

1. **Create a VPC (if not already created):**
   ```bash
   aws ec2 create-vpc --cidr-block 10.0.0.0/16
   ```

2. **Create a subnet within the VPC:**
   ```bash
   aws ec2 create-subnet --vpc-id <VPC_ID> --cidr-block 10.0.1.0/24
   ```

3. **Create a security group for Redshift within the VPC:**
   ```bash
   aws ec2 create-security-group --group-name redshift-sg --description "Redshift Security Group" --vpc-id <VPC_ID>
   ```

4. **Allow necessary inbound rules for the security group (e.g., Redshift port 5439):**
   ```bash
   aws ec2 authorize-security-group-ingress --group-id <SECURITY_GROUP_ID> --protocol tcp --port 5439 --cidr 0.0.0.0/0
   ```

5. **Launch a Redshift cluster within the VPC:**
   ```bash
   aws redshift create-cluster --cluster-identifier myredshiftcluster --node-type dc2.large --master-username admin --master-user-password <PASSWORD> --cluster-type single-node --vpc-security-group-ids <SECURITY_GROUP_ID> --cluster-subnet-group-name <SUBNET_GROUP_NAME>
   ```

6. **Ensure that the Redshift cluster is launched within the VPC by checking the VPC ID of the cluster:**
   ```bash
   aws redshift describe-clusters --cluster-identifier myredshiftcluster
   ```

By following these steps, you would have successfully remediated the misconfiguration of launching Redshift clusters within a VPC in AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration of launching Redshift clusters within a VPC in AWS using Python, you can follow these steps:

1. Import the necessary Python libraries:
```python
import boto3
```

2. Initialize the AWS Redshift client:
```python
redshift_client = boto3.client('redshift')
```

3. Get a list of existing Redshift clusters:
```python
response = redshift_client.describe_clusters()
clusters = response['Clusters']
```

4. For each Redshift cluster, check if it is launched within a VPC:
```python
for cluster in clusters:
    cluster_id = cluster['ClusterIdentifier']
    vpc_id = cluster.get('VpcId', None)
    
    if vpc_id is None:
        # Modify the cluster to launch within a VPC
        redshift_client.modify_cluster(ClusterIdentifier=cluster_id, VpcSecurityGroupIds=['vpc-security-group-id'])
```

5. Replace `'vpc-security-group-id'` with the appropriate VPC security group ID where you want to launch the Redshift cluster.

6. Run the Python script to remediate the misconfiguration by launching the Redshift clusters within a VPC.

By following these steps, you can use Python to remediate the misconfiguration of launching Redshift clusters within a VPC in AWS.

### Additional Reading:

- [https://docs.aws.amazon.com/redshift/latest/mgmt/getting-started-cluster-in-vpc.html](https://docs.aws.amazon.com/redshift/latest/mgmt/getting-started-cluster-in-vpc.html) 


</Tab>
</Tabs>