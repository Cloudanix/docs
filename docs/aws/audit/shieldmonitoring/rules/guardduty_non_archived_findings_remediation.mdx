

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the Amazon GuardDuty console at https://console.aws.amazon.com/guardduty/.

2. In the navigation pane, choose "Settings".

3. Under the "General" tab, look for the "Finding Publishing Frequency" section.

4. If the "Finding Publishing Frequency" is set to "Never", it means Non Archived Findings are not enabled for GuardDuty. If it is set to "Every 5 minutes" or "Every 15 minutes", it means Non Archived Findings are enabled.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all the detectors: Use the `list-detectors` command to get a list of all GuardDuty detector IDs in your AWS account. The command is as follows:

   ```
   aws guardduty list-detectors
   ```

   This command will return a list of detector IDs.

3. Get detector details: For each detector ID, use the `get-detector` command to get the details of the detector. The command is as follows:

   ```
   aws guardduty get-detector --detector-id <detector-id>
   ```

   Replace `<detector-id>` with the actual detector ID. This command will return the details of the detector, including whether or not findings are archived.

4. Check if findings are archived: In the output of the `get-detector` command, look for the `FindingPublishingFrequency` field. If the value of this field is `FIFTEEN_MINUTES`, `ONE_HOUR`, or `SIX_HOURS`, then findings are not archived. If the value is `NEVER`, then findings are archived.

#### Using Python

1. **Import necessary libraries and establish a session**: To start with, you need to import the necessary libraries in your Python script. Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of AWS services like Amazon S3, Amazon EC2, etc. Here is how you can do it:

```python
import boto3
import json

# Create a session using your AWS credentials
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2' # or any other region where you have your resources
)
```

2. **Create a GuardDuty client**: After establishing a session, you need to create a GuardDuty client. This client will provide you with methods to interact with the GuardDuty service.

```python
# Create GuardDuty client
gd_client = session.client('guardduty')
```

3. **List detectors**: GuardDuty service uses detectors to monitor the AWS environment. You need to list all the detectors to check their configurations.

```python
# List detectors
response = gd_client.list_detectors()

# Get the detector Ids
detector_ids = response['DetectorIds']
```

4. **Check for non-archived findings**: Now, for each detector, you can check if the "FindingPublishingFrequency" is set to "FIFTEEN_MINUTES". If it is not, it means that the findings are not being archived.

```python
for detector_id in detector_ids:
    detector = gd_client.get_detector(DetectorId=detector_id)
    if detector['FindingPublishingFrequency'] != 'FIFTEEN_MINUTES':
        print(f"Non-archived findings enabled for detector: {detector_id}")
```

This script will print the detector IDs for which non-archived findings are enabled. You can modify this script according to your needs, for example, to send an alert or to automatically fix the misconfiguration.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the non-archived findings enabled for GuardDuty in AWS Shield, you can follow these steps using the AWS Management Console:

1. **Login to AWS Console**: Go to https://aws.amazon.com/ and login to your AWS account using your credentials.

2. **Navigate to GuardDuty Service**: In the AWS Management Console, search for "GuardDuty" in the services search bar and click on the GuardDuty service.

3. **Select the GuardDuty Detector**: In the GuardDuty console, select the GuardDuty detector for which you want to remediate the non-archived findings.

4. **Navigate to Settings**: Click on the "Settings" tab in the GuardDuty console to view the settings for the selected detector.

5. **Disable Non-Archived Findings**: In the settings page, locate the "Non-Archived Findings" section and toggle the switch to disable it. This will ensure that findings are automatically archived after 90 days.

6. **Save Changes**: Once you have disabled the non-archived findings, click on the "Save" button to apply the changes.

7. **Verify Configuration**: You can verify that the non-archived findings are disabled by checking the settings page again and ensuring that the switch is in the off position.

By following these steps, you have successfully remediated the non-archived findings enabled for GuardDuty in AWS Shield using the AWS Management Console.

#### Using CLI

To remediate the non-archived findings enabled for GuardDuty in AWS Shield using AWS CLI, you can follow these steps:

1. Open the AWS CLI and run the following command to disable the non-archived findings in GuardDuty:

```bash
aws guardduty update-organization-configuration --detector-id <detector-id> --auto-enable --data-sources "s3Logs={enable=false}"
```

Replace `<detector-id>` with the ID of the GuardDuty detector for which you want to disable the non-archived findings.

2. Verify that the non-archived findings are disabled by running the following command:

```bash
aws guardduty get-detector --detector-id <detector-id> --query DataSources.S3Logs
```

This command will return the current configuration of S3 logs for the specified GuardDuty detector.

3. Once you have verified that the non-archived findings are disabled, you have successfully remediated the misconfiguration in AWS Shield for GuardDuty.

By following these steps, you can remediate the non-archived findings enabled for GuardDuty in AWS Shield using AWS CLI.

#### Using Python

To remediate the non-archived findings enabled for GuardDuty in AWS Shield using Python, you can follow these steps:

1. Import the necessary libraries:
```python
import boto3
```

2. Create a Boto3 client for GuardDuty:
```python
guardduty = boto3.client('guardduty')
```

3. List all the detectors in GuardDuty:
```python
detectors = guardduty.list_detectors()
```

4. Iterate through each detector and update the findingPublishingFrequency to "ARCHIVE":
```python
for detector in detectors['DetectorIds']:
    guardduty.update_detector(
        DetectorId=detector,
        FindingPublishingFrequency='ARCHIVE'
    )
```

5. Verify that the findings are now being archived by checking the FindingPublishingFrequency of each detector:
```python
for detector in detectors['DetectorIds']:
    response = guardduty.get_detector(
        DetectorId=detector
    )
    print(f"Detector {detector} finding publishing frequency: {response['FindingPublishingFrequency']}")
```

By following these steps and running the Python script, you can remediate the non-archived findings enabled for GuardDuty in AWS Shield.


</Tab>
</Tabs>