
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent inactive IAM users in AWS using the AWS Management Console, follow these steps:

1. **Regularly Review IAM Users:**
   - Navigate to the IAM Dashboard in the AWS Management Console.
   - Click on "Users" to see a list of all IAM users.
   - Regularly review the list of users to identify any that have not been active for a specified period (e.g., 90 days).

2. **Enable CloudTrail Logging:**
   - Go to the CloudTrail service in the AWS Management Console.
   - Ensure that CloudTrail is enabled to log all API activity.
   - This will help you track user activity and identify inactive users.

3. **Set Up IAM Access Advisor:**
   - In the IAM Dashboard, select a user and go to the "Access Advisor" tab.
   - Review the last accessed information for each service.
   - Use this information to determine if the user has been inactive.

4. **Implement Automated Monitoring:**
   - Use AWS Config to create a rule that checks for inactive IAM users.
   - Go to the AWS Config service in the AWS Management Console.
   - Create a new rule with a custom Lambda function that evaluates user activity and flags inactive users.

By following these steps, you can proactively monitor and manage IAM users to prevent inactive accounts from posing a security risk.
</Accordion>

<Accordion title='Using CLI'>
To prevent inactive IAM users in AWS using the AWS CLI, you can follow these steps:

1. **List All IAM Users:**
   First, you need to list all IAM users in your AWS account. This will help you identify which users are inactive.
   ```sh
   aws iam list-users
   ```

2. **Enable CloudTrail for Monitoring:**
   Ensure that AWS CloudTrail is enabled to monitor and log all IAM activities. This will help you track user activity and identify inactive users.
   ```sh
   aws cloudtrail create-trail --name myTrail --s3-bucket-name my-bucket
   aws cloudtrail start-logging --name myTrail
   ```

3. **Set Up IAM User Access Keys Rotation Policy:**
   Implement a policy to rotate IAM user access keys regularly. This will ensure that inactive users are identified and their access keys are rotated or deactivated.
   ```sh
   aws iam update-access-key --access-key-id <AccessKeyId> --status Inactive
   ```

4. **Automate Inactive User Detection:**
   Use a script to automate the detection of inactive users. You can use AWS CLI commands within a Python script to check the last activity of IAM users and take appropriate actions.
   ```python
   import boto3
   from datetime import datetime, timedelta

   iam = boto3.client('iam')
   cloudtrail = boto3.client('cloudtrail')

   # Define the threshold for inactivity (e.g., 90 days)
   threshold_date = datetime.now() - timedelta(days=90)

   # List all IAM users
   users = iam.list_users()['Users']

   for user in users:
       user_name = user['UserName']
       # Get the last activity of the user from CloudTrail
       events = cloudtrail.lookup_events(
           LookupAttributes=[
               {
                   'AttributeKey': 'Username',
                   'AttributeValue': user_name
               },
           ],
           StartTime=threshold_date,
           EndTime=datetime.now()
       )['Events']

       if not events:
           print(f"User {user_name} is inactive since {threshold_date}")
           # Take action, e.g., deactivate the user or notify the admin
   ```

By following these steps, you can effectively prevent inactive IAM users in AWS using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent inactive IAM users in AWS using Python scripts, you can follow these steps:

### 1. **Set Up AWS SDK for Python (Boto3)**
First, ensure you have Boto3 installed and configured with the necessary permissions to manage IAM users.

```bash
pip install boto3
```

### 2. **Identify Inactive Users**
Create a Python script to identify inactive IAM users. You can define inactivity based on the last activity date, such as the last time they accessed AWS services.

```python
import boto3
from datetime import datetime, timedelta

# Initialize a session using Amazon IAM
iam = boto3.client('iam')

# Define the inactivity period (e.g., 90 days)
inactivity_period = 90
threshold_date = datetime.now() - timedelta(days=inactivity_period)

# List all IAM users
users = iam.list_users()

# Check for inactive users
inactive_users = []
for user in users['Users']:
    user_name = user['UserName']
    last_used = iam.get_user(UserName=user_name)['User'].get('PasswordLastUsed', None)
    
    if last_used and last_used < threshold_date:
        inactive_users.append(user_name)

print(f"Inactive users: {inactive_users}")
```

### 3. **Automate Inactive User Detection**
Schedule the script to run periodically (e.g., daily or weekly) using a cron job or AWS Lambda to ensure continuous monitoring.

#### Using AWS Lambda:
1. Create a Lambda function and upload the script.
2. Set up a CloudWatch Events rule to trigger the Lambda function on a schedule.

### 4. **Notify or Take Action on Inactive Users**
You can extend the script to notify administrators or take automated actions such as disabling or deleting inactive users.

#### Example: Disable Inactive Users
```python
import boto3
from datetime import datetime, timedelta

# Initialize a session using Amazon IAM
iam = boto3.client('iam')

# Define the inactivity period (e.g., 90 days)
inactivity_period = 90
threshold_date = datetime.now() - timedelta(days=inactivity_period)

# List all IAM users
users = iam.list_users()

# Check for inactive users and disable them
for user in users['Users']:
    user_name = user['UserName']
    last_used = iam.get_user(UserName=user_name)['User'].get('PasswordLastUsed', None)
    
    if last_used and last_used < threshold_date:
        # Disable the user by removing their login profile
        iam.delete_login_profile(UserName=user_name)
        print(f"Disabled user: {user_name}")
```

### Summary
1. **Set Up AWS SDK for Python (Boto3)**: Install and configure Boto3.
2. **Identify Inactive Users**: Create a script to identify users inactive for a specified period.
3. **Automate Inactive User Detection**: Schedule the script using AWS Lambda and CloudWatch Events.
4. **Notify or Take Action on Inactive Users**: Extend the script to disable or notify about inactive users.

By following these steps, you can effectively prevent inactive IAM users in AWS using Python scripts.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and open the IAM console at https://console.aws.amazon.com/iam/.

2. In the navigation pane, choose "Users". This will display a list of all IAM users associated with the account.

3. For each user, check the "Last activity" column. This column shows the time since the user last used an AWS service. If the column shows "None", the user has not used any AWS service since it was created.

4. To get more detailed information, click on the user name. In the "User activity" section, you can see the services that the user has accessed in the last 365 days. If there is no activity, the user is considered inactive.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all IAM users: Use the AWS CLI command `aws iam list-users` to get a list of all IAM users in your AWS account. This command will return a JSON object that contains information about all IAM users.

3. Check last activity of each IAM user: For each IAM user, you can check their last activity date by using the AWS CLI command `aws iam get-user --user-name <username>`. This command will return a JSON object that contains information about the specified IAM user, including the `PasswordLastUsed` field which indicates the last time the IAM user logged in to the AWS Management Console or made an AWS API call.

4. Identify inactive IAM users: By comparing the current date with the `PasswordLastUsed` field of each IAM user, you can identify which IAM users have been inactive for a long period of time. You can do this comparison manually or write a script to automate the process. If the `PasswordLastUsed` field is not present for a user, it means that the user never logged in with a password.
</Accordion>

<Accordion title='Using Python'>
1. **Setup AWS SDK (Boto3):** First, you need to set up AWS SDK (Boto3) for Python. This allows Python to interact with AWS services. You can install it using pip:

```python
pip install boto3
```

2. **Configure AWS Credentials:** Next, you need to configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config:

```python
~/.aws/credentials:
[default]
aws_access_key_id = YOUR_ACCESS_KEY
aws_secret_access_key = YOUR_SECRET_KEY

~/.aws/config:
[default]
region=us-east-1
```

3. **Python Script to Detect Inactive IAM Users:** Now, you can write a Python script that uses Boto3 to interact with AWS IAM. This script will list all IAM users and their last activity date. If a user has not been active for a certain period of time, it will be considered inactive:

```python
import boto3
from datetime import datetime, timedelta

# Create IAM client
iam = boto3.client('iam')

# Get list of all users
users = iam.list_users()['Users']

# Define the period of inactivity
inactive_days = 90

for user in users:
    username = user['UserName']
    # Get last activity of user
    try:
        last_activity = iam.get_user(UserName=username)['User']['PasswordLastUsed']
    except:
        last_activity = None

    # If user has never been active or has been inactive for more than the defined period
    if last_activity is None or (datetime.now(last_activity.tzinfo) - last_activity) > timedelta(days=inactive_days):
        print(f'User {username} is inactive.')
```

4. **Run the Script:** Finally, you can run the script using a Python interpreter. The script will print out the usernames of all inactive IAM users. If there are no inactive users, it will not print anything. 

Please note that this script only checks for inactivity based on password usage. If a user is only using access keys, they might still be active even if the script considers them inactive.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate inactive IAM users in AWS using the AWS Management Console, follow these steps:

1. Sign in to the AWS Management Console using your AWS account credentials.
2. Open the IAM console by searching for "IAM" in the AWS services search bar and selecting "IAM" from the results.
3. In the left navigation pane, click on "Users" to view the list of IAM users in your account.
4. Identify the inactive users by looking at the "Last activity" column. Users who have not performed any activity for an extended period are considered inactive.
5. Select the checkbox next to the inactive user(s) that you want to remediate.
6. Click on the "Security credentials" tab at the bottom of the user details section.
7. Under "Access keys," check if the user has any access keys. If there are any access keys, they should be deleted.
   - To delete an access key, click on the "Delete" button next to the access key.
   - If the user requires access keys, generate new ones after deleting the old keys.
8. Under "Console password," check if the user has a password set. If a password is set, it should be reset.
   - To reset the password, click on the "Manage" button next to the console password.
   - Follow the on-screen instructions to set a new password for the user.
9. Under "Permissions," review the user's assigned policies and group memberships.
   - Remove the user from any unnecessary groups or policies.
   - If the user requires specific permissions, ensure they are assigned the appropriate policies.
10. Click on the "Tags" tab to review any assigned tags. Remove any unnecessary tags.
11. Once you have reviewed and made the necessary changes for the inactive user(s), click on the "Close" button to save the changes.

By following these steps, you can remediate inactive IAM users in AWS using the AWS Management Console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of inactive IAM users in AWS using AWS CLI, follow these step-by-step instructions:

1. List all IAM users:
   - Open the AWS CLI or AWS CloudShell.
   - Run the following command to list all IAM users:
     ```
     aws iam list-users
     ```

2. Identify inactive users:
   - Review the output of the previous command and identify the inactive users based on their LastActivityDate. Users who have not performed any activity for a long time can be considered inactive.

3. Deactivate inactive users:
   - Run the following command for each inactive user identified:
     ```
     aws iam update-user --user-name <username> --no-active
     ```
     Replace `<username>` with the actual username of the inactive user.

4. Verify user deactivation:
   - Run the following command to verify that the user has been deactivated:
     ```
     aws iam get-user --user-name <username>
     ```
     Replace `<username>` with the actual username of the inactive user.
   - Check the output and ensure that the "UserStatus" is set to "Inactive".

5. Optional: Remove access keys and MFA devices:
   - If necessary, you can also remove access keys and MFA devices associated with the inactive user to further secure your AWS account.
   - Run the following command to list the access keys for a user:
     ```
     aws iam list-access-keys --user-name <username>
     ```
     Replace `<username>` with the actual username of the inactive user.
   - Run the following command to delete an access key:
     ```
     aws iam delete-access-key --access-key-id <access-key-id> --user-name <username>
     ```
     Replace `<access-key-id>` with the actual access key ID and `<username>` with the actual username of the inactive user.
   - Run the following command to list the MFA devices for a user:
     ```
     aws iam list-mfa-devices --user-name <username>
     ```
     Replace `<username>` with the actual username of the inactive user.
   - Run the following command to deactivate an MFA device:
     ```
     aws iam deactivate-mfa-device --user-name <username> --serial-number <serial-number>
     ```
     Replace `<username>` with the actual username of the inactive user and `<serial-number>` with the actual serial number of the MFA device.

By following these steps, you can remediate the issue of inactive IAM users in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate inactive IAM users in AWS, you can follow these step-by-step instructions using Python:

1. Install Boto3: Boto3 is the AWS SDK for Python. You can install it using pip by running the following command:
   ```
   pip install boto3
   ```

2. Import the necessary libraries: In your Python script, import the required libraries, including `boto3` and `datetime`:
   ```python
   import boto3
   from datetime import datetime, timedelta
   ```

3. Configure AWS credentials: Set up your AWS credentials by either configuring the AWS CLI or using environment variables. This will allow your Python script to authenticate and access your AWS account.

4. Define a function to check for inactive IAM users: Create a function that will check for inactive IAM users based on a specified number of days of inactivity. For example, if a user has not logged in for 90 days, they will be considered inactive. Here's an example implementation:
   ```python
   def check_inactive_users(days):
       iam_client = boto3.client('iam')
       now = datetime.now()
       inactive_users = []

       response = iam_client.list_users()

       for user in response['Users']:
           username = user['UserName']
           last_login = iam_client.get_login_profile(UserName=username).get('LoginProfile', {}).get('CreateDate')
           
           if last_login:
               last_login = last_login.replace(tzinfo=None)
               if (now - last_login) > timedelta(days=days):
                   inactive_users.append(username)

       return inactive_users
   ```

5. Get a list of inactive IAM users: Call the `check_inactive_users` function, passing the number of days of inactivity as an argument. This will return a list of inactive IAM users:
   ```python
   inactive_users = check_inactive_users(90)
   print(f"Inactive IAM Users: {inactive_users}")
   ```

6. Disable the inactive IAM users: Iterate over the list of inactive users and disable their access by setting the `Status` to `Inactive` using the `update_login_profile` method:
   ```python
   for user in inactive_users:
       iam_client.update_login_profile(UserName=user, PasswordResetRequired=True)
       iam_client.delete_login_profile(UserName=user)
       print(f"Disabled access for user: {user}")
   ```

   Note: Disabling the user's access ensures that they cannot log in, but it does not delete the user. If you want to delete the user, you can use the `delete_user` method instead.

7. Run the script: Save the script with a `.py` extension and run it using Python. It will identify the inactive IAM users and disable their access.

Make sure to review the script and adjust any parameters or settings according to your specific requirements before running it in your AWS environment.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
