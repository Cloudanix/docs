---
slug: cloudtrail_publicly_accessible
title: CloudTrail Logging Buckets Should Not Be Publicly Accessible
sidebar_label: CloudTrail Logging Buckets Should Not Be Publicly Accessible
---

### More Info:

AWS CloudTrail logging buckets should not be publicly accessible. Using an overly permissive or insecure set of permissions for your CloudTrail logging S3 buckets could provide malicious users access to your AWS account log data which can increase exponentially the risk of unauthorized access.

### Risk Level

Critical

### Address

Security

### Compliance Standards

GDPR, HIPAA, CISAWS, CBP, AWSWAF, HITRUST, SOC2, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the Amazon S3 console at https://console.aws.amazon.com/s3/.

2. In the Bucket name list, choose the name of the bucket that you want to check.

3. Choose the Permissions tab.

4. Under the Block public access settings, check if the settings are turned on. If any of the settings are turned off, it means that the bucket is publicly accessible. 

Note: You can also use AWS CLI or SDKs to retrieve the block public access settings for your bucket.

#### Using CLI

1. First, you need to list all the S3 buckets in your AWS account. You can do this by using the following AWS CLI command:

   ```
   aws s3api list-buckets --query 'Buckets[].Name'
   ```

2. Once you have the list of all S3 buckets, you need to check the bucket policy of each bucket. You can do this by using the following AWS CLI command:

   ```
   aws s3api get-bucket-policy --bucket <bucket-name>
   ```

   Replace `<bucket-name>` with the name of your bucket. This command will return the bucket policy in JSON format.

3. Now, you need to check if the bucket policy allows public access. You can do this by looking for the following statement in the bucket policy:

   ```
   "Effect": "Allow",
   "Principal": "*",
   "Action": "s3:GetObject",
   "Resource": "arn:aws:s3:::<bucket-name>/*"
   ```

   If this statement is present in the bucket policy, it means that the bucket is publicly accessible.

4. Finally, you need to check if the bucket is used for CloudTrail logging. You can do this by using the following AWS CLI command:

   ```
   aws cloudtrail describe-trails
   ```

   This command will return a list of all CloudTrail trails in your AWS account. If the S3 bucket is listed in the `S3BucketName` field of any trail, it means that the bucket is used for CloudTrail logging.

#### Using Python

1. Import the necessary AWS SDK for Python (Boto3) modules and initialize a client for AWS S3 and CloudTrail:

```python
import boto3
s3 = boto3.client('s3')
cloudtrail = boto3.client('cloudtrail')
```

2. Get the list of all CloudTrail trails and their respective S3 bucket names:

```python
trails = cloudtrail.describe_trails()
bucket_names = [trail['S3BucketName'] for trail in trails['trailList']]
```

3. For each bucket, get the bucket policy and check if it allows public access:

```python
for bucket_name in bucket_names:
    bucket_policy = s3.get_bucket_policy(Bucket=bucket_name)
    is_public = any(statement['Principal'] == '*' for statement in bucket_policy['Policy']['Statement'])
    if is_public:
        print(f'Bucket {bucket_name} is publicly accessible.')
```

4. If the bucket is publicly accessible, print a warning message. If not, print a message indicating that the bucket is not publicly accessible:

```python
    if is_public:
        print(f'WARNING: The CloudTrail logging bucket {bucket_name} is publicly accessible.')
    else:
        print(f'The CloudTrail logging bucket {bucket_name} is not publicly accessible.')
```

This script will check all CloudTrail logging buckets in the AWS account and print a warning message for each bucket that is publicly accessible. Note that this script only checks for public access via the bucket policy. There may be other ways that a bucket can be made publicly accessible, such as through the bucket's ACLs or through a public access block configuration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

1. **Sign in to the AWS Management Console**.
2. **Navigate to the CloudTrail service**.
3. **Select Trails from the navigation pane**.
4. **Identify Trails with Publicly Accessible Buckets**:
   - Review each trail listed in the CloudTrail console and identify those with publicly accessible S3 buckets.
5. **Review Bucket ACL and Bucket Policy**:
   - Click on each trail to view its details.
   - Under the "S3 bucket" section, review the bucket ACL and bucket policy for any grants to "AllUsers" or "AuthenticatedUsers" with "FULL_CONTROL" permission.
6. **Remove Public Access**:
   - If there are grants allowing public access, you need to remove them:
     - Modify the bucket ACL to remove any grants allowing public access.
     - Delete the bucket policy if it allows public access.
7. **Repeat for Other Trails**:
   - Repeat the above steps for all trails with publicly accessible S3 buckets.

#### Using CLI

1. **Identify CloudTrail Trails with Publicly Accessible Buckets**:
```bash
aws cloudtrail describe-trails --query "trailList[?contains(S3BucketName, 'public-accessible-bucket')]" --output json
```
Replace `'public-accessible-bucket'` with the name of the bucket you're investigating.

2. **Remove Public Access from S3 Bucket ACL**:
```bash
aws s3api put-bucket-acl --bucket BUCKET_NAME --acl private
```
Replace `BUCKET_NAME` with the name of the S3 bucket.

3. **Remove Bucket Policy** (if exists):
```bash
aws s3api delete-bucket-policy --bucket BUCKET_NAME
```
Replace `BUCKET_NAME` with the name of the S3 bucket.

4. **Repeat for Other Trails**:
   - If there are multiple CloudTrail trails with publicly accessible S3 buckets, repeat the above steps for each of them.

These steps will remove public access from the S3 buckets associated with the CloudTrail trails using the AWS CLI. Ensure that you have appropriate IAM permissions to modify S3 bucket ACLs and policies.

#### Using Python

Here's a Python script to identify and remediate CloudTrail trails with publicly accessible S3 buckets:

```python
import boto3

class CloudTrailChecker:
    def __init__(self):
        self.cloudtrail_client = boto3.client('cloudtrail')
        self.s3_client = boto3.client('s3')

    def get_publicly_accessible_trails(self):
        failures = []
        response = self.cloudtrail_client.describe_trails()
        for trail in response['trailList']:
            if self.is_trail_public(trail):
                failures.append(trail)
        return failures

    def is_trail_public(self, trail):
        bucket_name = trail.get("S3BucketName", "")
        bucket_acl = self.s3_client.get_bucket_acl(Bucket=bucket_name)
        bucket_policy = self.s3_client.get_bucket_policy(Bucket=bucket_name)
        
        for grant in bucket_acl.get("Grants", []):
            if grant.get("Grantee", {}).get("URI", "") in [
                "http://acs.amazonaws.com/groups/global/AllUsers",
                "http://acs.amazonaws.com/groups/global/AuthenticatedUsers",
            ] and grant.get("Permission", None) == "FULL_CONTROL":
                return True
        
        statements = bucket_policy.get("Policy", {}).get("Statement", [])
        for statement in statements:
            if statement.get("Effect", "") == "Allow" and statement.get("Principal", "") == "*":
                return True
        
        return False

    def remediate_public_trail(self, trail_name):
        bucket_name = self.cloudtrail_client.describe_trails(trailNameList=[trail_name])['trailList'][0]['S3BucketName']
        
        # Remove public access from bucket ACL
        self.s3_client.put_bucket_acl(
            Bucket=bucket_name,
            ACL='private'
        )
        
        # Remove public access from bucket policy
        self.s3_client.delete_bucket_policy(
            Bucket=bucket_name
        )
        
        print(f"Public access has been removed from the CloudTrail trail {trail_name}.")

# Instantiate the class
checker = CloudTrailChecker()

# Get trails with publicly accessible buckets
public_trails = checker.get_publicly_accessible_trails()

# Remediate public trails
for trail in public_trails:
    checker.remediate_public_trail(trail['Name'])
```

This Python script identifies CloudTrail trails with publicly accessible S3 buckets and provides a placeholder for the remediation logic. You would need to implement the logic to modify the bucket ACL and bucket policy to remove public access.

Make sure to have appropriate IAM permissions for managing CloudTrail trails if you're using AWS CLI or Python script.

### Additional Reading:

- [https://docs.aws.amazon.com/awscloudtrail/latest/userguide/create-s3-bucket-policy-for-cloudtrail.html](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/create-s3-bucket-policy-for-cloudtrail.html) 


</Tab>
</Tabs>