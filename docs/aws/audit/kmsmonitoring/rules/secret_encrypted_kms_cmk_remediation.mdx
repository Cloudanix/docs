

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the AWS Key Management Service (KMS) dashboard at https://console.aws.amazon.com/kms/.
3. In the navigation pane, choose "Customer managed keys". Here you can see all the keys that are managed by the customer.
4. For each key, click on its alias to open the key details page. Under the "Key policy" section, check if the key is used to encrypt any Secret Manager secrets. If not, it indicates that the Secret Manager secrets are not encrypted with CMKs in KMS.

#### Using CLI

1. First, you need to list all the secrets in the Secret Manager. You can do this by using the AWS CLI command:

```bash
aws secretsmanager list-secrets --region <region-name>
```
Replace `<region-name>` with the name of the AWS region where your secrets are stored.

2. The output of the above command will give you a list of secrets. For each secret, you need to describe the secret to get more details. Use the following command:

```bash
aws secretsmanager describe-secret --secret-id <secret-id> --region <region-name>
```
Replace `<secret-id>` with the ID of the secret you want to check and `<region-name>` with the name of the AWS region where your secret is stored.

3. In the output of the above command, look for the "KmsKeyId" field. This field indicates the ID of the AWS KMS key that's used to encrypt the secret. If this field is not present or if it's set to the default AWS managed key (alias/aws/secretsmanager), then the secret is not encrypted with a customer managed key (CMK).

4. To confirm whether the KMS key is a customer managed key or not, you can describe the key using the following command:

```bash
aws kms describe-key --key-id <kms-key-id> --region <region-name>
```
Replace `<kms-key-id>` with the ID of the KMS key you want to check and `<region-name>` with the name of the AWS region where your key is stored. In the output, look for the "KeyManager" field. If it's set to "CUSTOMER", then the key is a customer managed key. If it's set to "AWS", then the key is an AWS managed key.

#### Using Python

1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. You can install the Google Cloud SDK and the Google Cloud Client Library for Python using pip. Run the following commands to install them:

   ```bash
   pip install --upgrade google-cloud-sdk
   pip install --upgrade google-cloud-secret-manager
   ```

2. Import the necessary libraries and initialize the Secret Manager client: In your Python script, you need to import the necessary libraries and initialize the Secret Manager client. Here's how you can do it:

   ```python
   from google.cloud import secretmanager
   from google.cloud import kms

   secret_manager_client = secretmanager.SecretManagerServiceClient()
   kms_client = kms.KeyManagementServiceClient()
   ```

3. List all secrets and check their encryption: You can use the `list_secrets` method of the Secret Manager client to list all secrets. For each secret, you can use the `get_secret` method to get its details and check if it's encrypted with a customer-managed key (CMK). Here's how you can do it:

   ```python
   parent = secret_manager_client.project_path('your-project-id')

   for secret in secret_manager_client.list_secrets(parent):
       secret = secret_manager_client.get_secret(secret.name)
       if 'customerManagedEncryption' not in secret.replication.automatic:
           print(f'Secret {secret.name} is not encrypted with a CMK.')
   ```

4. Check if the CMK is in KMS: For each secret that's encrypted with a CMK, you can use the `get_crypto_key` method of the KMS client to check if the CMK is in KMS. Here's how you can do it:

   ```python
   for secret in secret_manager_client.list_secrets(parent):
       secret = secret_manager_client.get_secret(secret.name)
       if 'customerManagedEncryption' in secret.replication.automatic:
           cmk = secret.replication.automatic.customerManagedEncryption.kms_key_name
           try:
               kms_client.get_crypto_key(cmk)
           except Exception as e:
               print(f'CMK {cmk} for secret {secret.name} is not in KMS.')
   ```
   
Please replace 'your-project-id' with your actual project id.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, I can help you with that. Here are the step-by-step instructions to remediate the "Secret Manager Secrets Should Be Encrypted With CMKs" misconfiguration in AWS using the AWS console:

1. Log in to the AWS Management Console and navigate to the AWS Secrets Manager service.

2. Click on the secret that needs to be remediated.

3. Under the "Encryption" section, click on the "Edit" button.

4. Select the "AWS KMS customer master key (CMK)" option.

5. Choose the appropriate CMK from the list or create a new one.

6. Click on the "Save" button to save the changes.

7. Ensure that the secret is now encrypted with the selected CMK by checking the "Encryption" section.

That's it! Following these steps should remediate the "Secret Manager Secrets Should Be Encrypted With CMKs" misconfiguration in AWS.

#### Using CLI

To remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" for AWS using AWS CLI, you can follow the below steps:

1. Open the AWS CLI on your local machine or EC2 instance.
2. Run the following command to list all the secrets in the Secret Manager:

   ```
   aws secretsmanager list-secrets
   ```

3. Note down the ARN of the secret that needs to be encrypted with a CMK.
4. Create a new KMS customer managed key (CMK) by running the following command:

   ```
   aws kms create-key --description "My new CMK"
   ```

5. Note down the ARN of the newly created CMK.
6. Run the following command to update the secret to use the newly created CMK:

   ```
   aws secretsmanager update-secret-version-stage --secret-id <ARN-of-secret> --secret-version-stage AWSCURRENT --kms-key-id <ARN-of-new-CMK>
   ```

   Replace `<ARN-of-secret>` with the ARN of the secret that needs to be encrypted with a CMK, and `<ARN-of-new-CMK>` with the ARN of the newly created CMK.

7. Verify that the secret is now encrypted with the new CMK by running the following command:

   ```
   aws secretsmanager describe-secret --secret-id <ARN-of-secret>
   ```

   This command should return the details of the secret, including the KMS key ID.

By following the above steps, you can remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" for AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" in AWS using Python, you can follow the below steps:

1. Create a Customer Managed Key (CMK) in AWS Key Management Service (KMS) if not already created.

```python
import boto3

kms_client = boto3.client('kms')

response = kms_client.create_key(
    Description='CMK for Secret Manager',
    KeyUsage='ENCRYPT_DECRYPT',
    Origin='AWS_KMS'
)

cmk_arn = response['KeyMetadata']['Arn']
```

2. Enable Key Rotation for the CMK created in step 1.

```python
import boto3

kms_client = boto3.client('kms')

kms_client.enable_key_rotation(
    KeyId='CMK_ARN'
)
```

3. Update the Secrets in AWS Secret Manager to use the CMK created in step 1 for encryption.

```python
import boto3

secrets_client = boto3.client('secretsmanager')

response = secrets_client.update_secret(
    SecretId='SECRET_NAME',
    KmsKeyId='CMK_ARN',
    SecretString='{"username":"admin","password":"secret"}'
)
```

Note: Replace `CMK_ARN` with the ARN of the CMK created in step 1 and `SECRET_NAME` with the name of the Secret in AWS Secret Manager that needs to be updated.

By following these steps, you can remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" for AWS using Python.


</Tab>
</Tabs>