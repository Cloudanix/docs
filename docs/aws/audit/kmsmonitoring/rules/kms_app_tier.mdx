---
slug: kms_app_tier
title: App-tier KMS Key Should Be In Use
sidebar_label: App-tier KMS Key Should Be In Use
---

### More Info:

There should be one Amazon KMS Customer Master Key (CMK) created in your AWS account for the app tier in order to protect data that transits your AWS application stack, have full control over encryption process, and meet security and compliance requirements.

### Risk Level

Low

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration "App-tier KMS Key Should Be In Use" in AWS Key Management Service (KMS) using the AWS Management Console, follow these steps:

1. **Navigate to KMS Dashboard:**
   - Open the AWS Management Console.
   - In the search bar, type "KMS" and select "Key Management Service" from the results.

2. **Create a New KMS Key:**
   - In the KMS dashboard, click on "Create a key."
   - Follow the wizard to create a new symmetric or asymmetric key, depending on your requirements.
   - Ensure you provide a meaningful alias and description for the key.

3. **Configure Key Policies:**
   - During the key creation process, configure the key policies to grant appropriate permissions to the necessary IAM users, roles, or services.
   - Ensure that the key policies are restrictive and follow the principle of least privilege.

4. **Update App-tier Resources to Use KMS Key:**
   - Identify the app-tier resources (e.g., RDS, S3, EBS) that should use the KMS key for encryption.
   - Update the configuration of these resources to use the newly created KMS key for encryption.
   - For example, for an S3 bucket, go to the bucket properties, enable default encryption, and select the KMS key you created.

By following these steps, you can ensure that your app-tier resources are using KMS keys for encryption, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not using a KMS key for the App-tier in AWS, you can follow these steps using the AWS CLI:

1. **Create a KMS Key:**
   First, create a new KMS key if you don't already have one. This key will be used to encrypt your App-tier resources.
   ```sh
   aws kms create-key --description "App-tier KMS Key" --key-usage ENCRYPT_DECRYPT --origin AWS_KMS
   ```

2. **Create an Alias for the KMS Key:**
   Create an alias for easier reference to your KMS key.
   ```sh
   aws kms create-alias --alias-name alias/app-tier-key --target-key-id <your-key-id>
   ```

3. **Encrypt App-tier Resources:**
   Ensure that your App-tier resources (e.g., EBS volumes, S3 buckets, RDS instances) are encrypted using the KMS key. For example, to encrypt an EBS volume:
   ```sh
   aws ec2 create-volume --size 10 --region us-west-2 --availability-zone us-west-2a --volume-type gp2 --encrypted --kms-key-id alias/app-tier-key
   ```

4. **Update Existing Resources:**
   If you have existing resources that need to be encrypted, you will need to create snapshots and then create new encrypted resources from those snapshots. For example, to encrypt an existing EBS volume:
   ```sh
   # Create a snapshot of the existing volume
   aws ec2 create-snapshot --volume-id <your-volume-id> --description "Snapshot of unencrypted volume"

   # Create a new encrypted volume from the snapshot
   aws ec2 copy-snapshot --source-region us-west-2 --source-snapshot-id <your-snapshot-id> --encrypted --kms-key-id alias/app-tier-key
   ```

By following these steps, you can ensure that your App-tier resources are properly encrypted using a KMS key, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not using a KMS key for your app-tier in AWS, you can use the AWS SDK for Python (Boto3) to ensure that your resources are encrypted with a KMS key. Here are the steps to achieve this:

1. **Install Boto3**:
   Ensure you have Boto3 installed in your Python environment. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Create or Use an Existing KMS Key**:
   You can create a new KMS key or use an existing one. Here is a script to create a new KMS key:
   ```python
   import boto3

   kms_client = boto3.client('kms')

   response = kms_client.create_key(
       Description='App-tier KMS key',
       KeyUsage='ENCRYPT_DECRYPT',
       Origin='AWS_KMS'
   )

   key_id = response['KeyMetadata']['KeyId']
   print(f'Created KMS Key with ID: {key_id}')
   ```

3. **Encrypt App-tier Resources**:
   Ensure that your app-tier resources (e.g., S3 buckets, EBS volumes, RDS instances) are encrypted using the KMS key. Here is an example for encrypting an S3 bucket:
   ```python
   s3_client = boto3.client('s3')

   bucket_name = 'your-app-tier-bucket'
   kms_key_id = 'your-kms-key-id'

   s3_client.put_bucket_encryption(
       Bucket=bucket_name,
       ServerSideEncryptionConfiguration={
           'Rules': [
               {
                   'ApplyServerSideEncryptionByDefault': {
                       'SSEAlgorithm': 'aws:kms',
                       'KMSMasterKeyID': kms_key_id
                   }
               }
           ]
       }
   )

   print(f'Enabled KMS encryption for bucket: {bucket_name}')
   ```

4. **Verify Encryption**:
   Verify that the resources are encrypted using the specified KMS key. Here is an example for verifying the encryption of an S3 bucket:
   ```python
   response = s3_client.get_bucket_encryption(Bucket=bucket_name)
   rules = response['ServerSideEncryptionConfiguration']['Rules']

   for rule in rules:
       if rule['ApplyServerSideEncryptionByDefault']['SSEAlgorithm'] == 'aws:kms':
           print(f'Bucket {bucket_name} is encrypted with KMS Key ID: {rule["ApplyServerSideEncryptionByDefault"]["KMSMasterKeyID"]}')
       else:
           print(f'Bucket {bucket_name} is not encrypted with KMS')
   ```

By following these steps, you can ensure that your app-tier resources are properly encrypted using a KMS key, thereby preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" in the search box and selecting "Key Management Service" from the dropdown list.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand side menu. This will display a list of all the KMS keys that are currently in use within your AWS account.
4. To check if the App-tier KMS key is in use, look for the key in the list. If the key is not listed, it means it is not in use. If the key is listed, check the "Key Usage" column to see if it is being used for encryption or decryption. If the key is being used, it will show "Encrypt and decrypt" under the "Key Usage" column.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access KMS keys.

2. Once AWS CLI is set up, you can list all the KMS keys in your account by running the following command:
   ```
   aws kms list-keys --region your-region-name
   ```
   Replace 'your-region-name' with the name of your AWS region. This command will return a list of all KMS keys in the specified region.

3. To check if a specific KMS key is in use, you can use the 'list-grants' command. Replace 'key-id' with the ID of the KMS key you want to check.
   ```
   aws kms list-grants --key-id your-key-id
   ```
   This command will return a list of all grants for the specified KMS key. If the list is empty, it means the key is not in use.

4. To automate this process, you can write a Python script using the boto3 library, which is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python. This script would iterate over all KMS keys and check if they are in use. Here is a basic example:
   ```python
   import boto3

   # Create a client
   client = boto3.client('kms')

   # List keys
   response = client.list_keys()

   # Iterate over keys
   for key in response['Keys']:
       # List grants for each key
       grants = client.list_grants(KeyId=key['KeyId'])
       # Check if key is in use
       if not grants['Grants']:
           print(f"Key {key['KeyId']} is not in use")
   ```
   This script will print the IDs of all KMS keys that are not in use.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. For AWS, you will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary libraries and initialize the client: After installing the libraries, you can start writing the script. First, import the necessary libraries and initialize the AWS client.

```python
import boto3

client = boto3.client('kms')
```

3. List all KMS keys: The next step is to list all the KMS keys. You can do this using the `list_keys` function.

```python
response = client.list_keys()

keys = response['Keys']
```

4. Check if the keys are in use: Finally, you can check if the keys are in use. You can do this by looping through the keys and checking the `KeyUsage` attribute. If the `KeyUsage` attribute is not 'ENCRYPT_DECRYPT', then the key is not in use.

```python
for key in keys:
    key_id = key['KeyId']
    key_metadata = client.describe_key(KeyId=key_id)
    key_usage = key_metadata['KeyMetadata']['KeyUsage']
    
    if key_usage != 'ENCRYPT_DECRYPT':
        print(f"Key {key_id} is not in use")
```

This script will print out the IDs of all keys that are not in use.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step-by-step instructions to remediate the "App-tier KMS Key Should Be In Use" misconfiguration in AWS using the AWS console:

1. Open the AWS Management Console and navigate to the AWS KMS service.
2. Click on "Customer managed keys" from the left-hand menu.
3. Search for the KMS key that is used to encrypt data at the app-tier.
4. Check if the key is enabled and has an alias name.
5. If the key is disabled, enable it by selecting the key and clicking on "Enable key" from the "Actions" menu.
6. If the key does not have an alias name, add an alias by selecting the key and clicking on "Add alias" from the "Actions" menu.
7. Provide an alias name for the key and click on "Create alias".
8. Now, navigate to the app-tier EC2 instance and stop the instance.
9. Go to the EC2 instance details page and click on the "Volumes" tab.
10. Select the root volume of the instance and click on "Actions" > "Create snapshot".
11. Once the snapshot is created, click on "Actions" > "Create image".
12. Provide a name and description for the image and select the KMS key that was enabled in step 5.
13. Click on "Create image".
14. Once the image is created, start a new EC2 instance from the image.
15. Verify that the new instance is using the KMS key by checking the "Encryption" attribute of the root volume.

By following these steps, you should be able to remediate the "App-tier KMS Key Should Be In Use" misconfiguration in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the "App-tier KMS Key Should Be In Use" misconfiguration for AWS using AWS CLI, follow these steps:

1. Log in to the AWS Management Console.

2. Open the AWS CLI and run the following command to check if the KMS key is in use:

   ```
   aws kms list-aliases
   ```

   This command will list all the KMS keys available in your account.

3. Identify the KMS key that should be used for the App-tier and note down its ARN.

4. Open the AWS CLI and run the following command to update the App-tier to use the correct KMS key:

   ```
   aws elasticbeanstalk update-environment --environment-name <environment-name> --option-settings Namespace=aws:elasticbeanstalk:application:environment,OptionName=APP_TIER_KMS_KEY_ID,Value=<KMS-key-ARN>
   ```

   Replace `<environment-name>` with the name of the environment that needs to be updated, and `<KMS-key-ARN>` with the ARN of the correct KMS key.

5. Verify that the update was successful by running the following command:

   ```
   aws elasticbeanstalk describe-environments --environment-names <environment-name>
   ```

   This command will return the details of the environment. Check that the `APP_TIER_KMS_KEY_ID` option is set to the correct KMS key ARN.

6. Repeat the above steps for all environments in your AWS account that are affected by this misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To remediate the "App-tier KMS Key Should Be In Use" misconfiguration in AWS using Python, you can follow these steps:

1. First, you need to identify the App-tier KMS Key that should be used. You can do this by checking your AWS account to see if there is a KMS Key that is specifically designated for use with your App-tier resources. If there is, note down the ARN of the KMS Key.

2. Next, you need to update your App-tier resources to use the designated KMS Key. You can do this by using the AWS SDK for Python (Boto3) to modify the resources' encryption settings. Here's an example code snippet that shows how to do this for an EC2 instance:

```python
import boto3

# Replace the values in the following variables with your own values
instance_id = 'your-instance-id'
kms_key_arn = 'your-kms-key-arn'

# Create a Boto3 EC2 client
ec2 = boto3.client('ec2')

# Modify the instance's encryption settings to use the designated KMS Key
response = ec2.modify_instance_attribute(
    InstanceId=instance_id,
    BlockDeviceMappings=[
        {
            'DeviceName': '/dev/sda1',
            'Ebs': {
                'Encrypted': True,
                'KmsKeyId': kms_key_arn
            }
        }
    ]
)
```

This code modifies the encryption settings of the root EBS volume of an EC2 instance to use the designated KMS Key.

3. Finally, you should verify that the App-tier resources are now using the designated KMS Key. You can do this by checking the encryption settings of the resources using the AWS Management Console or the AWS CLI.

By following these steps, you should be able to remediate the "App-tier KMS Key Should Be In Use" misconfiguration in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html](https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html) 

