---
slug: kms_db_tier
title: Database-tier KMS Key Should Be In Use
sidebar_label: Database-tier KMS Key Should Be In Use
---

### More Info:

There should be one Amazon KMS Customer Master Key (CMK) created in your AWS account for the database tier in order to protect data-at-rest available within your AWS web stack, have full control over encryption/decryption process, and meet security and compliance requirements.

### Risk Level

Low

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the RDS dashboard.
2. In the navigation pane, choose "Databases" to open the list of your RDS instances.
3. Select the RDS instance that you want to examine, then choose the "Configuration" tab to view the details of the selected instance.
4. In the "Details" section, look for the "KMS key ID" attribute. If the attribute value is set to "aws/rds" (the default AWS managed key), the selected RDS instance is not using a customer-managed KMS key, indicating a potential misconfiguration.

#### Using CLI

1. First, you need to list all the RDS instances in your AWS account. You can do this by using the AWS CLI command:

   ```
   aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier]' --output text
   ```
   This command will return a list of all RDS instance identifiers.

2. Next, for each RDS instance, you need to check if it's encrypted with a KMS key. You can do this by using the following AWS CLI command:

   ```
   aws rds describe-db-instances --db-instance-identifier <DBInstanceIdentifier> --query 'DBInstances[*].[KmsKeyId]' --output text
   ```
   Replace `<DBInstanceIdentifier>` with the identifier of the RDS instance you want to check. This command will return the KMS key ID used to encrypt the RDS instance. If the output is empty, it means the RDS instance is not encrypted with a KMS key.

3. To check if the KMS key is in use, you can use the following AWS CLI command:

   ```
   aws kms describe-key --key-id <KmsKeyId> --query 'KeyMetadata.[KeyState]' --output text
   ```
   Replace `<KmsKeyId>` with the KMS key ID you got from the previous step. This command will return the state of the KMS key. If the state is 'Enabled', it means the KMS key is in use.

4. Repeat steps 2 and 3 for each RDS instance in your AWS account. If any RDS instance is not encrypted with a KMS key, or if the KMS key is not in use, it means there is a misconfiguration.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) to interact with AWS services. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Set up AWS credentials: Boto3 needs your AWS credentials (access key and secret access key) to interact with AWS services. You can set them in your environment variables:

   ```bash
   export AWS_ACCESS_KEY_ID='your_access_key'
   export AWS_SECRET_ACCESS_KEY='your_secret_key'
   ```

3. Write a Python script to list all KMS keys and check if they are in use:

   ```python
   import boto3

   def check_kms_keys_in_use():
       client = boto3.client('kms')
       response = client.list_keys()

       for key in response['Keys']:
           key_id = key['KeyId']
           key_metadata = client.describe_key(KeyId=key_id)
           if key_metadata['KeyMetadata']['KeyState'] != 'Enabled':
               print(f"KMS key {key_id} is not in use")

   if __name__ == "__main__":
       check_kms_keys_in_use()
   ```
   
   This script lists all KMS keys and checks if their state is 'Enabled'. If not, it prints the key ID.

4. Run the Python script: You can run the script using the Python interpreter:

   ```bash
   python check_kms_keys.py
   ```

   This will print the IDs of all KMS keys that are not in use.

Please note that this script only checks if the KMS keys are enabled or not. It does not check if they are actually used by any AWS service. To do that, you would need to check each AWS service individually, which would require a more complex script.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

The remediation steps for "Database-tier KMS Key Should Be In Use" in AWS using the AWS console are as follows:

1. Open the Amazon RDS console at https://console.aws.amazon.com/rds/.
2. In the navigation pane, choose "Encryption".
3. Select the DB instance that you want to encrypt.
4. Click on the "Modify" button.
5. In the "Encryption" section, choose "Yes" for the "Encrypt this DB instance" option.
6. Select the KMS key that you want to use for encryption in the "KMS key ID" drop-down list.
7. Click on the "Continue" button.
8. Review the changes and click on the "Modify DB instance" button to apply the changes.

After completing these steps, the database-tier KMS key will be in use, and the misconfiguration will be remediated.

#### Using CLI

To remediate the "Database-tier KMS Key Should Be In Use" misconfiguration in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the RDS instances in your AWS account:

```
aws rds describe-db-instances
```

3. Identify the RDS instance that has the misconfiguration.

4. Run the following command to modify the RDS instance to use a KMS key:

```
aws rds modify-db-instance --db-instance-identifier <your-db-instance-identifier> --kms-key-id <your-kms-key-id>
```

Replace `<your-db-instance-identifier>` with the name of your RDS instance and `<your-kms-key-id>` with the ID of the KMS key that you want to use.

5. Verify that the RDS instance is now using the KMS key by running the following command:

```
aws rds describe-db-instances --db-instance-identifier <your-db-instance-identifier> | grep KmsKeyId
```

This command should return the ID of the KMS key that you specified in step 4.

6. Repeat steps 4 and 5 for all the RDS instances that have the misconfiguration.

#### Using Python

To remediate the "Database-tier KMS Key Should Be In Use" misconfiguration in AWS using Python, you can follow these steps:

1. Identify the RDS instances that are not using a KMS key for encryption.

2. Use the AWS SDK for Python (Boto3) to modify the RDS instances to use a KMS key for encryption.

Here is the Python code to accomplish this:

```python
import boto3

# Create an RDS client
rds = boto3.client('rds')

# Get a list of all RDS instances
instances = rds.describe_db_instances()

# Loop through each instance and check if it is using a KMS key for encryption
for instance in instances['DBInstances']:
    if 'KmsKeyId' not in instance:
        # If the instance is not using a KMS key, modify it to use one
        rds.modify_db_instance(
            DBInstanceIdentifier=instance['DBInstanceIdentifier'],
            KmsKeyId='your_kms_key_id_here'
        )
```

Replace "your_kms_key_id_here" with the ID of the KMS key that you want to use for encryption.

This code will loop through all RDS instances and modify any instances that are not using a KMS key for encryption to use the specified KMS key.

### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html](https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html) 


</Tab>
</Tabs>