---
slug: kms_db_tier
title: Database-tier KMS Key Should Be In Use
sidebar_label: Database-tier KMS Key Should Be In Use
---

### More Info:

There should be one Amazon KMS Customer Master Key (CMK) created in your AWS account for the database tier in order to protect data-at-rest available within your AWS web stack, have full control over encryption/decryption process, and meet security and compliance requirements.

### Risk Level

Low

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration "Database-tier KMS Key Should Be In Use" in AWS using the AWS Management Console, follow these steps:

1. **Navigate to KMS (Key Management Service):**
   - Open the AWS Management Console.
   - In the search bar, type "KMS" and select "Key Management Service" from the results.

2. **Create or Select a KMS Key:**
   - If you don't have a KMS key, click on "Create a key" and follow the prompts to create a new key.
   - If you already have a KMS key, select the appropriate key from the list.

3. **Configure Key Policies:**
   - Ensure that the key policies are correctly configured to allow the necessary IAM roles and users to use the key for database encryption.
   - Click on the key, go to the "Key Policy" tab, and review or edit the policy as needed.

4. **Enable Encryption for Database Services:**
   - Navigate to the specific database service you are using (e.g., RDS, DynamoDB).
   - For RDS, go to the "Databases" section, select your database instance, and choose "Modify."
   - In the "Encryption" section, select the KMS key you created or identified earlier.
   - Save the changes and apply them to ensure the database is encrypted using the specified KMS key.

By following these steps, you can ensure that your database-tier is properly encrypted using a KMS key, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not using a KMS key for your database-tier in AWS, you can follow these steps using the AWS CLI:

1. **Create a KMS Key:**
   First, create a KMS key that will be used to encrypt your database. This key will be used to ensure that your database-tier is properly encrypted.

   ```sh
   aws kms create-key --description "Database-tier KMS Key" --key-usage ENCRYPT_DECRYPT --origin AWS_KMS
   ```

2. **Create an Alias for the KMS Key:**
   Create an alias for easier reference to your KMS key.

   ```sh
   aws kms create-alias --alias-name alias/database-tier-key --target-key-id <KMS_KEY_ID>
   ```

   Replace `<KMS_KEY_ID>` with the actual Key ID returned from the previous command.

3. **Enable Encryption on RDS Instance:**
   When creating a new RDS instance, specify the KMS key to be used for encryption.

   ```sh
   aws rds create-db-instance \
       --db-instance-identifier mydbinstance \
       --allocated-storage 20 \
       --db-instance-class db.t2.micro \
       --engine mysql \
       --master-username admin \
       --master-user-password password \
       --kms-key-id <KMS_KEY_ID>
   ```

   Replace `<KMS_KEY_ID>` with the actual Key ID or alias (e.g., `alias/database-tier-key`).

4. **Modify Existing RDS Instance to Use KMS Key:**
   If you have an existing RDS instance, modify it to use the KMS key for encryption.

   ```sh
   aws rds modify-db-instance \
       --db-instance-identifier mydbinstance \
       --storage-encrypted \
       --kms-key-id <KMS_KEY_ID> \
       --apply-immediately
   ```

   Replace `<KMS_KEY_ID>` with the actual Key ID or alias (e.g., `alias/database-tier-key`).

By following these steps, you ensure that your database-tier is properly encrypted using a KMS key, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To ensure that a Database-tier KMS (Key Management Service) key is in use, you can use Python scripts to automate the creation and assignment of KMS keys to your database resources. Below are the steps to prevent the misconfiguration using Python scripts for AWS, Azure, and GCP.

### AWS

1. **Install AWS SDK for Python (Boto3)**
   ```bash
   pip install boto3
   ```

2. **Create a KMS Key**
   ```python
   import boto3

   kms_client = boto3.client('kms')

   response = kms_client.create_key(
       Description='Key for encrypting database-tier resources',
       KeyUsage='ENCRYPT_DECRYPT',
       Origin='AWS_KMS'
   )

   key_id = response['KeyMetadata']['KeyId']
   print(f'Created KMS Key with ID: {key_id}')
   ```

3. **Assign KMS Key to RDS Instance**
   ```python
   rds_client = boto3.client('rds')

   response = rds_client.modify_db_instance(
       DBInstanceIdentifier='your-db-instance-identifier',
       KmsKeyId=key_id,
       ApplyImmediately=True
   )

   print(f'Assigned KMS Key to RDS Instance: {response}')
   ```

### Azure

1. **Install Azure SDK for Python**
   ```bash
   pip install azure-mgmt-keyvault azure-mgmt-sql
   ```

2. **Create a Key Vault and Key**
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.keyvault import KeyVaultManagementClient
   from azure.mgmt.keyvault.models import VaultCreateOrUpdateParameters, Sku, SkuName, KeyAttributes

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   resource_group_name = 'your-resource-group'
   vault_name = 'your-key-vault-name'

   kv_client = KeyVaultManagementClient(credential, subscription_id)

   vault_params = VaultCreateOrUpdateParameters(
       location='your-location',
       properties={
           'sku': Sku(name=SkuName.standard),
           'tenant_id': 'your-tenant-id',
           'access_policies': []
       }
   )

   vault = kv_client.vaults.begin_create_or_update(resource_group_name, vault_name, vault_params).result()
   print(f'Created Key Vault: {vault.name}')

   key_client = kv_client.keys
   key = key_client.create_key(vault_name, 'your-key-name', 'RSA', key_attributes=KeyAttributes(enabled=True))
   print(f'Created Key: {key.name}')
   ```

3. **Assign Key to SQL Database**
   ```python
   from azure.mgmt.sql import SqlManagementClient

   sql_client = SqlManagementClient(credential, subscription_id)

   response = sql_client.databases.begin_create_or_update(
       resource_group_name,
       'your-sql-server-name',
       'your-database-name',
       {
           'location': 'your-location',
           'properties': {
               'encryption': {
                   'status': 'Enabled',
                   'key_vault_uri': vault.properties.vault_uri,
                   'key_name': key.name
               }
           }
       }
   ).result()

   print(f'Assigned Key to SQL Database: {response.name}')
   ```

### GCP

1. **Install Google Cloud SDK**
   ```bash
   pip install google-cloud-kms google-cloud-sql
   ```

2. **Create a KMS Key**
   ```python
   from google.cloud import kms

   client = kms.KeyManagementServiceClient()
   parent = client.location_path('your-project-id', 'your-location')

   key_ring = client.create_key_ring(parent, 'your-key-ring-id', {})
   print(f'Created Key Ring: {key_ring.name}')

   key = client.create_crypto_key(
       key_ring.name,
       'your-key-id',
       {
           'purpose': kms.enums.CryptoKey.CryptoKeyPurpose.ENCRYPT_DECRYPT
       }
   )
   print(f'Created KMS Key: {key.name}')
   ```

3. **Assign KMS Key to Cloud SQL Instance**
   ```python
   from google.cloud import sql_v1

   client = sql_v1.SqlAdminServiceClient()
   instance = client.get_instance('your-project-id', 'your-instance-id')

   instance.settings.data_disk_kms_key_name = key.name

   response = client.update_instance(instance)
   print(f'Assigned KMS Key to Cloud SQL Instance: {response.name}')
   ```

By following these steps, you can ensure that your database-tier resources are using KMS keys for encryption, thereby preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon RDS console at https://console.aws.amazon.com/rds/.

2. In the navigation pane, choose "Databases" to navigate to the databases section.

3. Select the database instance that you want to check. In the details section, look for the "KMS key ID" field. If the field is empty or not present, it means that the database-tier KMS key is not in use.

4. To further verify, you can go to the AWS Key Management Service (KMS) console at https://console.aws.amazon.com/kms/. Check if the key ID mentioned in the RDS database details is present and enabled in the KMS console. If it's not, then the KMS key is not in use for the selected database instance.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all the RDS instances in your AWS account. You can do this by using the AWS CLI command:

```bash
aws rds describe-db-instances --query 'DBInstances[*].[DBInstanceIdentifier]' --output text
```

2. Once you have the list of RDS instances, you can check the KMS key associated with each instance. This can be done using the following command:

```bash
aws rds describe-db-instances --db-instance-identifier <DBInstanceIdentifier> --query 'DBInstances[*].[KmsKeyId]' --output text
```
Replace `<DBInstanceIdentifier>` with the actual identifier of the RDS instance.

3. If the output of the above command is `None`, it means that the RDS instance is not using a KMS key. If it returns a KMS key ID, it means that the RDS instance is using that KMS key.

4. To ensure that the KMS key is in use, you can list all the grants for the KMS key using the following command:

```bash
aws kms list-grants --key-id <KmsKeyId> --query 'Grants[*].[GranteePrincipal]' --output text
```
Replace `<KmsKeyId>` with the actual KMS key ID. If the output includes the ARN of the RDS instance, it means that the KMS key is in use by the RDS instance.
</Accordion>

<Accordion title='Using Python'>
To check if a Database-tier KMS Key is in use in AWS KMS using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps:

1. **Setup AWS SDK for Python (Boto3):**
   First, you need to set up Boto3. Install it using pip:
   ```
   pip install boto3
   ```
   Then, configure your AWS credentials. You can do this by setting the following environment variables:
   ```
   AWS_ACCESS_KEY_ID = 'your_access_key'
   AWS_SECRET_ACCESS_KEY = 'your_secret_key'
   ```

2. **List all KMS keys:**
   Use the `list_keys` method to retrieve all KMS keys. Here's a sample script:
   ```python
   import boto3

   # Create a client
   kms = boto3.client('kms')

   # List keys
   response = kms.list_keys()

   # Print the keys
   for key in response['Keys']:
       print(key['KeyId'])
   ```

3. **Check if the key is used by RDS instances:**
   Use the `describe_db_instances` method from the RDS client to list all RDS instances and their KMS key IDs. Here's a sample script:
   ```python
   import boto3

   # Create a client
   rds = boto3.client('rds')

   # List RDS instances
   response = rds.describe_db_instances()

   # Print the KMS key ID for each instance
   for instance in response['DBInstances']:
       print(instance['KmsKeyId'])
   ```

4. **Compare the keys:**
   Compare the keys from step 2 and step 3. If a key from step 2 is not found in step 3, it means that the key is not used by any RDS instance. Here's a sample script:
   ```python
   import boto3

   # Create KMS and RDS clients
   kms = boto3.client('kms')
   rds = boto3.client('rds')

   # List keys
   kms_response = kms.list_keys()

   # List RDS instances
   rds_response = rds.describe_db_instances()

   # Get the KMS key IDs
   kms_keys = [key['KeyId'] for key in kms_response['Keys']]

   # Get the KMS key IDs used by RDS instances
   rds_keys = [instance['KmsKeyId'] for instance in rds_response['DBInstances']]

   # Find the keys that are not used by RDS instances
   unused_keys = set(kms_keys) - set(rds_keys)

   # Print the unused keys
   for key in unused_keys:
       print(key)
   ```
   This script will print the IDs of the KMS keys that are not used by any RDS instance.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
The remediation steps for "Database-tier KMS Key Should Be In Use" in AWS using the AWS console are as follows:

1. Open the Amazon RDS console at https://console.aws.amazon.com/rds/.
2. In the navigation pane, choose "Encryption".
3. Select the DB instance that you want to encrypt.
4. Click on the "Modify" button.
5. In the "Encryption" section, choose "Yes" for the "Encrypt this DB instance" option.
6. Select the KMS key that you want to use for encryption in the "KMS key ID" drop-down list.
7. Click on the "Continue" button.
8. Review the changes and click on the "Modify DB instance" button to apply the changes.

After completing these steps, the database-tier KMS key will be in use, and the misconfiguration will be remediated.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the "Database-tier KMS Key Should Be In Use" misconfiguration in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the RDS instances in your AWS account:

```
aws rds describe-db-instances
```

3. Identify the RDS instance that has the misconfiguration.

4. Run the following command to modify the RDS instance to use a KMS key:

```
aws rds modify-db-instance --db-instance-identifier <your-db-instance-identifier> --kms-key-id <your-kms-key-id>
```

Replace `<your-db-instance-identifier>` with the name of your RDS instance and `<your-kms-key-id>` with the ID of the KMS key that you want to use.

5. Verify that the RDS instance is now using the KMS key by running the following command:

```
aws rds describe-db-instances --db-instance-identifier <your-db-instance-identifier> | grep KmsKeyId
```

This command should return the ID of the KMS key that you specified in step 4.

6. Repeat steps 4 and 5 for all the RDS instances that have the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To remediate the "Database-tier KMS Key Should Be In Use" misconfiguration in AWS using Python, you can follow these steps:

1. Identify the RDS instances that are not using a KMS key for encryption.

2. Use the AWS SDK for Python (Boto3) to modify the RDS instances to use a KMS key for encryption.

Here is the Python code to accomplish this:

```python
import boto3

# Create an RDS client
rds = boto3.client('rds')

# Get a list of all RDS instances
instances = rds.describe_db_instances()

# Loop through each instance and check if it is using a KMS key for encryption
for instance in instances['DBInstances']:
    if 'KmsKeyId' not in instance:
        # If the instance is not using a KMS key, modify it to use one
        rds.modify_db_instance(
            DBInstanceIdentifier=instance['DBInstanceIdentifier'],
            KmsKeyId='your_kms_key_id_here'
        )
```

Replace "your_kms_key_id_here" with the ID of the KMS key that you want to use for encryption.

This code will loop through all RDS instances and modify any instances that are not using a KMS key for encryption to use the specified KMS key.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html](https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html) 

