
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of not rotating Secrets Manager secrets frequently in AWS KMS using the AWS Management Console, follow these steps:

1. **Navigate to Secrets Manager:**
   - Open the AWS Management Console.
   - In the search bar, type "Secrets Manager" and select it from the dropdown list.

2. **Select the Secret:**
   - In the Secrets Manager dashboard, you will see a list of your secrets.
   - Click on the secret that you want to configure for rotation.

3. **Enable Automatic Rotation:**
   - In the secret details page, find the "Secret rotation" section.
   - Click on the "Edit rotation" button.
   - Select the "Enable automatic rotation" checkbox.

4. **Configure Rotation Schedule:**
   - Choose a rotation interval that meets your security requirements (e.g., 30 days).
   - Optionally, you can specify a custom Lambda function to handle the rotation if the default one does not meet your needs.
   - Click "Save" to apply the changes.

By following these steps, you ensure that your secrets in AWS Secrets Manager are rotated frequently, thereby enhancing the security of your KMS-managed secrets.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not rotating Secrets Manager secrets frequently in AWS KMS using AWS CLI, you can follow these steps:

1. **Create a Secret with Automatic Rotation Enabled:**
   Ensure that when you create a new secret, you enable automatic rotation. Use the `create-secret` command with the `--rotation-lambda-arn` and `--rotation-rules` parameters.

   ```sh
   aws secretsmanager create-secret \
       --name MySecretName \
       --secret-string file://mysecret.json \
       --kms-key-id alias/my-kms-key \
       --rotation-lambda-arn arn:aws:lambda:region:account-id:function:MyRotationLambda \
       --rotation-rules AutomaticallyAfterDays=30
   ```

2. **Enable Rotation for an Existing Secret:**
   If you have an existing secret, you can enable rotation using the `rotate-secret` command.

   ```sh
   aws secretsmanager rotate-secret \
       --secret-id MySecretName \
       --rotation-lambda-arn arn:aws:lambda:region:account-id:function:MyRotationLambda \
       --rotation-rules AutomaticallyAfterDays=30
   ```

3. **Update Rotation Rules for an Existing Secret:**
   To update the rotation rules for an existing secret, use the `update-secret` command with the `--rotation-rules` parameter.

   ```sh
   aws secretsmanager update-secret \
       --secret-id MySecretName \
       --rotation-rules AutomaticallyAfterDays=30
   ```

4. **Verify Rotation Configuration:**
   To ensure that the rotation configuration is correctly set, you can describe the secret and check its rotation rules using the `describe-secret` command.

   ```sh
   aws secretsmanager describe-secret \
       --secret-id MySecretName
   ```

   Look for the `RotationEnabled` and `RotationRules` fields in the output to verify that rotation is enabled and configured correctly.

By following these steps, you can ensure that your secrets in AWS Secrets Manager are rotated frequently, thereby enhancing the security of your secrets.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not rotating Secrets Manager secrets frequently in AWS KMS using Python scripts, you can follow these steps:

### 1. **Set Up AWS SDK for Python (Boto3)**
First, ensure you have the AWS SDK for Python (Boto3) installed. You can install it using pip if you haven't already:

```bash
pip install boto3
```

### 2. **Create a Python Script to Enable Automatic Rotation**
You can create a Python script to enable automatic rotation for your secrets in AWS Secrets Manager. Below is an example script:

```python
import boto3
from botocore.exceptions import ClientError

# Initialize a session using Amazon Secrets Manager
client = boto3.client('secretsmanager')

def enable_secret_rotation(secret_id, rotation_lambda_arn):
    try:
        response = client.rotate_secret(
            SecretId=secret_id,
            RotationLambdaARN=rotation_lambda_arn,
            RotationRules={
                'AutomaticallyAfterDays': 30  # Rotate every 30 days
            }
        )
        print(f"Rotation enabled for secret: {secret_id}")
    except ClientError as e:
        print(f"Error enabling rotation for secret {secret_id}: {e}")

# Replace 'your-secret-id' and 'your-lambda-arn' with your actual secret ID and Lambda ARN
secret_id = 'your-secret-id'
rotation_lambda_arn = 'your-lambda-arn'

enable_secret_rotation(secret_id, rotation_lambda_arn)
```

### 3. **Schedule the Script to Run Periodically**
To ensure that the script runs periodically, you can use a scheduling tool like cron (on Unix-based systems) or Task Scheduler (on Windows). This will help you to regularly check and enforce the rotation policy.

### 4. **Monitor and Alert on Rotation Status**
You can set up CloudWatch Alarms to monitor the rotation status of your secrets. If a secret is not rotated within the expected time frame, an alert can be triggered. Below is an example of how you can create a CloudWatch alarm using Boto3:

```python
import boto3

# Initialize a session using Amazon CloudWatch
cloudwatch = boto3.client('cloudwatch')

def create_rotation_alarm(secret_id):
    try:
        response = cloudwatch.put_metric_alarm(
            AlarmName=f'SecretRotationAlarm-{secret_id}',
            MetricName='RotationAge',
            Namespace='AWS/SecretsManager',
            Statistic='Maximum',
            Period=86400,  # 1 day
            EvaluationPeriods=1,
            Threshold=30,  # 30 days
            ComparisonOperator='GreaterThanOrEqualToThreshold',
            AlarmActions=[
                'arn:aws:sns:your-region:your-account-id:your-sns-topic'  # Replace with your SNS topic ARN
            ],
            Dimensions=[
                {
                    'Name': 'SecretId',
                    'Value': secret_id
                },
            ]
        )
        print(f"Alarm created for secret: {secret_id}")
    except ClientError as e:
        print(f"Error creating alarm for secret {secret_id}: {e}")

# Replace 'your-secret-id' with your actual secret ID
secret_id = 'your-secret-id'

create_rotation_alarm(secret_id)
```

By following these steps, you can ensure that your secrets in AWS Secrets Manager are rotated frequently, thereby preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the AWS Key Management Service (KMS) dashboard.
3. In the navigation pane, choose "Customer managed keys".
4. For each KMS key listed in the dashboard, check the "Rotation status" column. If the rotation status is set to "Disabled", it means the Secrets Manager secrets are not being rotated frequently.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the Secrets Manager and KMS services.

2. Once the AWS CLI is set up, you can list all the secrets stored in the Secrets Manager by running the following command:

   ```
   aws secretsmanager list-secrets
   ```

   This command will return a JSON object containing all the secrets. You can parse this JSON object to get the list of secrets.

3. For each secret, you can get the rotation configuration by running the following command:

   ```
   aws secretsmanager describe-secret --secret-id <secret-id>
   ```

   Replace `<secret-id>` with the actual ID of the secret. This command will return a JSON object containing the details of the secret, including the rotation configuration.

4. To check if the secret is rotated frequently, you need to look at the `RotationRules` field in the returned JSON object. If the `AutomaticallyAfterDays` field is set to a high value, it means the secret is not rotated frequently. If the `RotationEnabled` field is set to `false`, it means the secret rotation is not enabled.

   Note: AWS recommends rotating secrets every 30 days. So, if the `AutomaticallyAfterDays` field is set to a value greater than 30, it can be considered as a misconfiguration.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary AWS SDK for Python (Boto3) modules and initialize a new client for the AWS Key Management Service (KMS):

```python
import boto3
kms_client = boto3.client('kms')
```

2. List all the keys in your AWS account:

```python
response = kms_client.list_keys()
keys = response['Keys']
```

3. For each key, get the key rotation status:

```python
for key in keys:
    key_id = key['KeyId']
    response = kms_client.get_key_rotation_status(KeyId=key_id)
    print(f"Key ID: {key_id}, Rotation Status: {response['KeyRotationEnabled']}")
```

4. If the rotation status is False, then the key is not being rotated frequently. This is a misconfiguration. The script should flag these keys for further investigation or remediation.

Note: This script assumes that you have the necessary permissions to list and get the rotation status of KMS keys in your AWS account. If you don't, you'll need to update your IAM policies accordingly. Also, make sure to handle any exceptions that might occur during the execution of the script, such as `botocore.exceptions.BotoCoreError` and `botocore.exceptions.ClientError`.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of Secrets Manager secrets not being rotated frequently in AWS using the AWS console, follow these steps:

1. Open the AWS Secrets Manager console.
2. Select the secret that needs to be rotated.
3. Click on the "Rotation" tab.
4. Click on the "Edit rotation" button.
5. In the "Configure rotation" section, select the rotation frequency and the number of days to keep the previous version of the secret.
6. Click on the "Enable rotation" checkbox.
7. Choose the Lambda function or AWS Secrets Manager to rotate the secret.
8. Click on the "Save changes" button.

By following these steps, the Secrets Manager secret will be automatically rotated according to the selected frequency, and the previous versions of the secret will be kept for the specified number of days.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of Secrets Manager Secrets not being rotated frequently in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the secrets available in the Secrets Manager service:

```
aws secretsmanager list-secrets
```
3. Identify the secret that needs to be rotated frequently.

4. Run the following command to rotate the secret:

```
aws secretsmanager rotate-secret --secret-id <secret-id>
```

Note: Replace `<secret-id>` with the ID of the secret that needs to be rotated.

5. After running the above command, the Secrets Manager service will create a new version of the secret and update the old version with a new password or other credentials.

6. Update the applications or services that use the secret with the new credentials.

7. Delete the old version of the secret using the following command:

```
aws secretsmanager delete-secret --secret-id <secret-id> --force-delete-without-recovery
```

Note: Replace `<secret-id>` with the ID of the old version of the secret.

8. Repeat the above steps periodically to ensure that secrets are rotated frequently. It is recommended to set up automated rotation using AWS Lambda or other automation tools.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of Secrets Manager Secrets not being rotated frequently in AWS, you can use the following steps using Python:

1. Import the Boto3 library for AWS:

```python
import boto3
```

2. Create an AWS Secrets Manager client:

```python
client = boto3.client('secretsmanager')
```

3. Get a list of all secrets in AWS Secrets Manager:

```python
secrets = client.list_secrets()
```

4. Loop through the list of secrets and check if each secret has been rotated within the last 30 days:

```python
for secret in secrets['SecretList']:
    if 'RotationRules' in secret:
        rotation_days = secret['RotationRules']['AutomaticallyAfterDays']
        last_rotated_date = secret['LastRotatedDate']
        if (datetime.now() - last_rotated_date).days > rotation_days:
            # Secret has not been rotated within the last 30 days
            # Code to rotate the secret goes here
```

5. If a secret has not been rotated within the last 30 days, use the `rotate_secret` function to rotate the secret:

```python
client.rotate_secret(SecretId=secret['ARN'])
```

6. Add logging and error handling to the script as needed.

7. Schedule the script to run on a regular basis (e.g. daily) using AWS Lambda or a cron job.

By following these steps, you can ensure that all secrets in AWS Secrets Manager are rotated frequently, which helps to improve the security of your AWS environment.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
