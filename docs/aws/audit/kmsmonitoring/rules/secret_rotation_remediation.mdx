
### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Secret Manager secrets from being rotated using AWS Key Management Service (KMS) in the AWS Management Console, follow these steps:

1. **Navigate to AWS Secrets Manager:**
   - Open the AWS Management Console.
   - In the search bar, type "Secrets Manager" and select it from the dropdown.

2. **Select the Secret:**
   - In the Secrets Manager dashboard, you will see a list of your secrets.
   - Click on the secret for which you want to disable rotation.

3. **Disable Automatic Rotation:**
   - In the secret details page, look for the "Secret rotation" section.
   - Click on the "Edit rotation" button.
   - In the rotation configuration page, select "Disable automatic rotation."
   - Click "Save" to apply the changes.

4. **Verify the Changes:**
   - Return to the secret details page and ensure that the "Secret rotation" status is now set to "Disabled."

By following these steps, you can prevent the automatic rotation of secrets managed by AWS Secrets Manager using the AWS Management Console.
</Accordion>

<Accordion title='Using CLI'>
To prevent misconfigurations related to Secret Manager Secrets Rotation in AWS KMS using the AWS CLI, you can follow these steps:

1. **Create a New Secret with Rotation Disabled:**
   When creating a new secret, ensure that automatic rotation is disabled by not specifying the `--rotation-lambda-arn` and `--rotation-rules` parameters.

   ```sh
   aws secretsmanager create-secret --name MySecret --secret-string "MySecretValue"
   ```

2. **Update an Existing Secret to Disable Rotation:**
   If a secret already exists and has rotation enabled, you can disable it by updating the secret and setting the `--rotation-enabled` parameter to `false`.

   ```sh
   aws secretsmanager update-secret --secret-id MySecret --rotation-enabled false
   ```

3. **Verify Rotation Status:**
   To ensure that rotation is disabled, you can describe the secret and check the rotation configuration.

   ```sh
   aws secretsmanager describe-secret --secret-id MySecret
   ```

   Look for the `RotationEnabled` field in the output and ensure it is set to `false`.

4. **Audit Secrets Periodically:**
   Regularly audit your secrets to ensure that rotation remains disabled where it is not required. You can list all secrets and check their rotation status.

   ```sh
   aws secretsmanager list-secrets
   ```

   For each secret, describe it and verify the `RotationEnabled` field.

   ```sh
   aws secretsmanager describe-secret --secret-id <SecretId>
   ```

By following these steps, you can prevent misconfigurations related to Secret Manager Secrets Rotation in AWS KMS using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent misconfigurations related to Secret Manager Secrets Rotation in KMS using Python scripts, you can follow these steps:

### 1. **Set Up Your Environment**
Ensure you have the necessary libraries installed and configured for accessing your cloud provider's services. For Google Cloud Platform (GCP), you will need the `google-cloud-secret-manager` and `google-cloud-kms` libraries.

```bash
pip install google-cloud-secret-manager google-cloud-kms
```

### 2. **Authenticate and Initialize Clients**
Authenticate your application and initialize the Secret Manager and KMS clients.

```python
from google.cloud import secretmanager
from google.cloud import kms

# Initialize the Secret Manager client
secret_client = secretmanager.SecretManagerServiceClient()

# Initialize the KMS client
kms_client = kms.KeyManagementServiceClient()
```

### 3. **Create a Secret with Rotation Policy**
When creating a secret, ensure that you specify a rotation policy. This will automatically enable rotation for the secret.

```python
from google.protobuf import duration_pb2

# Define the parent project
parent = f"projects/{project_id}"

# Create the secret with a rotation policy
secret = secret_client.create_secret(
    request={
        "parent": parent,
        "secret_id": secret_id,
        "secret": {
            "replication": {"automatic": {}},
            "rotation": {
                "next_rotation_time": {
                    "seconds": int(time.time() + 3600 * 24 * 30)  # 30 days from now
                },
                "rotation_period": duration_pb2.Duration(seconds=3600 * 24 * 30),  # 30 days
            },
        },
    }
)
print(f"Created secret: {secret.name}")
```

### 4. **Ensure KMS Key is Properly Configured**
Ensure that the KMS key used for encrypting the secret is properly configured and has the necessary permissions.

```python
# Define the KMS key name
key_name = kms_client.crypto_key_path(project_id, location_id, key_ring_id, crypto_key_id)

# Get the KMS key
key = kms_client.get_crypto_key(name=key_name)

# Ensure the key has the necessary permissions
policy = kms_client.get_iam_policy(resource=key_name)
bindings = policy.bindings
bindings.append({
    "role": "roles/cloudkms.cryptoKeyEncrypterDecrypter",
    "members": {f"serviceAccount:{service_account_email}"}
})
policy.bindings = bindings
kms_client.set_iam_policy(resource=key_name, policy=policy)
print(f"Updated IAM policy for key: {key_name}")
```

By following these steps, you can ensure that secrets in Secret Manager have rotation enabled and are properly managed using KMS. This will help prevent misconfigurations related to secret rotation.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the AWS Key Management Service (KMS) dashboard.
3. In the navigation pane, choose "Customer managed keys".
4. In the list of keys, select the key that you want to check.
5. Under the "Key rotation" section, check if "Automatically rotate this CMK every year" is enabled. If it's not enabled, then Secret Manager Secrets Rotation is not enabled for this key.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all the secrets in the AWS Secrets Manager. You can do this by using the AWS CLI command:

```bash
aws secretsmanager list-secrets --region <region-name>
```
Replace `<region-name>` with the name of the AWS region where your secrets are stored.

2. The output of the above command will give you a list of secrets. Each secret will have a `Name` and `ARN`. You need to note down the `ARN` of the secret that you want to check.

3. Next, you need to describe the secret using its `ARN`. You can do this by using the AWS CLI command:

```bash
aws secretsmanager describe-secret --secret-id <secret-arn> --region <region-name>
```
Replace `<secret-arn>` with the ARN of the secret that you noted down in the previous step.

4. The output of the above command will give you the details of the secret. You need to check the `RotationEnabled` field in the output. If the `RotationEnabled` field is `true`, then the secret rotation is enabled. If the `RotationEnabled` field is `false` or not present, then the secret rotation is not enabled.
</Accordion>

<Accordion title='Using Python'>
To check if Secret Manager Secrets Rotation is enabled in KMS using Python scripts, you can follow these steps:

1. **Install the necessary libraries**: You need to install the `google-cloud-secret-manager` library. You can install it using pip:
```python
pip install google-cloud-secret-manager
```

2. **Set up authentication**: Before you can interact with GCP services, you need to set up authentication. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file.
```python
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="/path/to/your/service-account-file.json"
```

3. **Initialize the Secret Manager client**: You can do this using the `secretmanager` module from the `google.cloud` library.
```python
from google.cloud import secretmanager
client = secretmanager.SecretManagerServiceClient()
```

4. **Check for Secret Rotation**: You can list all secrets and check if they have a rotation policy. If a secret does not have a rotation policy, it means that Secret Rotation is not enabled for that secret.
```python
parent = client.project_path('your-project-id')

for secret in client.list_secrets(parent):
    secret_name = secret.name
    secret_version = client.secret_version_path('your-project-id', secret_name, 'latest')
    secret_version = client.access_secret_version(secret_version)

    if not secret.rotation:
        print(f'Secret {secret_name} does not have rotation enabled.')
```
This script will print out the names of all secrets that do not have Secret Rotation enabled.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the "Secret Manager Secrets Rotation Enabled" misconfiguration for AWS using the AWS console, please follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the AWS Secrets Manager service from the Services menu.
3. Select the secret for which you want to disable rotation.
4. Click on the "Disable rotation" button in the "Rotation configuration" section.
5. In the confirmation dialog box, click on the "Disable rotation" button to confirm the action.

Once you have completed these steps, the secret will no longer be set to rotate automatically, and you will need to manually rotate the secret when necessary.

#
</Accordion>

<Accordion title='Using CLI'>
The AWS Secret Manager is a service that enables you to store and manage secrets such as database credentials, API keys, and other sensitive data. One of the key features of Secret Manager is the ability to rotate secrets automatically, which helps to prevent unauthorized access to sensitive data.

If the misconfiguration is "Secret Manager Secrets Rotation Enabled", it means that secrets rotation is not enabled for the AWS Secret Manager. To remediate this misconfiguration, you can follow these steps using the AWS CLI:

Step 1: List all the secrets in the Secret Manager

```
aws secretsmanager list-secrets
```

Step 2: Enable rotation for each secret

```
aws secretsmanager rotate-secret --secret-id <SECRET_ID> --rotation-rules '{"AutomaticallyAfterDays": 30}'
```

Note: Replace `<SECRET_ID>` with the actual ID of the secret.

Step 3: Verify that rotation is enabled for the secret

```
aws secretsmanager describe-secret --secret-id <SECRET_ID>
```

This command should return the details of the secret, including the rotation configuration.

Step 4: Repeat steps 2 and 3 for all the secrets in the Secret Manager

Enabling secret rotation is an important security best practice, and it helps to ensure that sensitive data is protected from unauthorized access.
</Accordion>

<Accordion title='Using Python'>
To remediate the "Secrets Manager Secrets Rotation Enabled" misconfiguration in AWS using Python, follow these steps:

1. Open the AWS Management Console and navigate to the AWS Secrets Manager service.

2. Identify the secret(s) that have rotation enabled and note their ARN(s).

3. Use the AWS SDK for Python (Boto3) to disable rotation for each identified secret. Here's an example code snippet:

```python
import boto3

# Replace <SECRET_ARN> with the ARN of the secret to remediate
secret_arn = '<SECRET_ARN>'

# Create a Secrets Manager client
client = boto3.client('secretsmanager')

# Disable rotation for the secret
response = client.update_secret(
    SecretId=secret_arn,
    RotationLambdaARN='',
    RotationRules={
        'AutomaticallyAfterDays': None
    }
)

print(response)
```

4. Repeat step 3 for each identified secret with rotation enabled.

5. Verify that rotation is now disabled for each secret by checking their configuration in the AWS Management Console or using the Boto3 SDK.

Note: Disabling rotation for a secret means that it will no longer automatically rotate its credentials. You may need to manually rotate the credentials periodically to maintain security.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
