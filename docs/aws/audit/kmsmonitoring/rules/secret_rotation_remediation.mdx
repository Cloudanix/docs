
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the AWS Key Management Service (KMS) dashboard.
3. In the navigation pane, choose "Customer managed keys".
4. In the list of keys, select the key that you want to check.
5. Under the "Key rotation" section, check if "Automatically rotate this CMK every year" is enabled. If it's not enabled, then Secret Manager Secrets Rotation is not enabled for this key.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all the secrets in the AWS Secrets Manager. You can do this by using the AWS CLI command:

```bash
aws secretsmanager list-secrets --region <region-name>
```
Replace `<region-name>` with the name of the AWS region where your secrets are stored.

2. The output of the above command will give you a list of secrets. Each secret will have a `Name` and `ARN`. You need to note down the `ARN` of the secret that you want to check.

3. Next, you need to describe the secret using its `ARN`. You can do this by using the AWS CLI command:

```bash
aws secretsmanager describe-secret --secret-id <secret-arn> --region <region-name>
```
Replace `<secret-arn>` with the ARN of the secret that you noted down in the previous step.

4. The output of the above command will give you the details of the secret. You need to check the `RotationEnabled` field in the output. If the `RotationEnabled` field is `true`, then the secret rotation is enabled. If the `RotationEnabled` field is `false` or not present, then the secret rotation is not enabled.
</Accordion>

<Accordion title='Using Python'>
To check if Secret Manager Secrets Rotation is enabled in KMS using Python scripts, you can follow these steps:

1. **Install the necessary libraries**: You need to install the `google-cloud-secret-manager` library. You can install it using pip:
```python
pip install google-cloud-secret-manager
```

2. **Set up authentication**: Before you can interact with GCP services, you need to set up authentication. You can do this by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of your service account key file.
```python
import os
os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="/path/to/your/service-account-file.json"
```

3. **Initialize the Secret Manager client**: You can do this using the `secretmanager` module from the `google.cloud` library.
```python
from google.cloud import secretmanager
client = secretmanager.SecretManagerServiceClient()
```

4. **Check for Secret Rotation**: You can list all secrets and check if they have a rotation policy. If a secret does not have a rotation policy, it means that Secret Rotation is not enabled for that secret.
```python
parent = client.project_path('your-project-id')

for secret in client.list_secrets(parent):
    secret_name = secret.name
    secret_version = client.secret_version_path('your-project-id', secret_name, 'latest')
    secret_version = client.access_secret_version(secret_version)

    if not secret.rotation:
        print(f'Secret {secret_name} does not have rotation enabled.')
```
This script will print out the names of all secrets that do not have Secret Rotation enabled.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the "Secret Manager Secrets Rotation Enabled" misconfiguration for AWS using the AWS console, please follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the AWS Secrets Manager service from the Services menu.
3. Select the secret for which you want to disable rotation.
4. Click on the "Disable rotation" button in the "Rotation configuration" section.
5. In the confirmation dialog box, click on the "Disable rotation" button to confirm the action.

Once you have completed these steps, the secret will no longer be set to rotate automatically, and you will need to manually rotate the secret when necessary.

#
</Accordion>

<Accordion title='Using CLI'>
The AWS Secret Manager is a service that enables you to store and manage secrets such as database credentials, API keys, and other sensitive data. One of the key features of Secret Manager is the ability to rotate secrets automatically, which helps to prevent unauthorized access to sensitive data.

If the misconfiguration is "Secret Manager Secrets Rotation Enabled", it means that secrets rotation is not enabled for the AWS Secret Manager. To remediate this misconfiguration, you can follow these steps using the AWS CLI:

Step 1: List all the secrets in the Secret Manager

```
aws secretsmanager list-secrets
```

Step 2: Enable rotation for each secret

```
aws secretsmanager rotate-secret --secret-id <SECRET_ID> --rotation-rules '{"AutomaticallyAfterDays": 30}'
```

Note: Replace `<SECRET_ID>` with the actual ID of the secret.

Step 3: Verify that rotation is enabled for the secret

```
aws secretsmanager describe-secret --secret-id <SECRET_ID>
```

This command should return the details of the secret, including the rotation configuration.

Step 4: Repeat steps 2 and 3 for all the secrets in the Secret Manager

Enabling secret rotation is an important security best practice, and it helps to ensure that sensitive data is protected from unauthorized access.
</Accordion>

<Accordion title='Using Python'>
To remediate the "Secrets Manager Secrets Rotation Enabled" misconfiguration in AWS using Python, follow these steps:

1. Open the AWS Management Console and navigate to the AWS Secrets Manager service.

2. Identify the secret(s) that have rotation enabled and note their ARN(s).

3. Use the AWS SDK for Python (Boto3) to disable rotation for each identified secret. Here's an example code snippet:

```python
import boto3

# Replace <SECRET_ARN> with the ARN of the secret to remediate
secret_arn = '<SECRET_ARN>'

# Create a Secrets Manager client
client = boto3.client('secretsmanager')

# Disable rotation for the secret
response = client.update_secret(
    SecretId=secret_arn,
    RotationLambdaARN='',
    RotationRules={
        'AutomaticallyAfterDays': None
    }
)

print(response)
```

4. Repeat step 3 for each identified secret with rotation enabled.

5. Verify that rotation is now disabled for each secret by checking their configuration in the AWS Management Console or using the Boto3 SDK.

Note: Disabling rotation for a secret means that it will no longer automatically rotate its credentials. You may need to manually rotate the credentials periodically to maintain security.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
