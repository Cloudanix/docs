

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the AWS Key Management Service (KMS) console at https://console.aws.amazon.com/kms.

2. To use the AWS KMS console, you must sign in as an IAM user, assume an IAM role, or sign in as the root user (not recommended) in your AWS account.

3. In the navigation pane, choose "Customer managed keys".

4. Choose the alias or key ID of the KMS key to review.

5. Under Key policy, review the policy. Look for the "Sid": "Allow access for Key Administrators" section. This section contains the IAM users and roles that have administrative permissions for the KMS key. If the number of IAM entities (users/roles) listed here is more than necessary, it indicates a misconfiguration. 

Remember, the principle of least privilege should be applied, and only the necessary IAM entities should have administrative access to the KMS key.

#### Using CLI

1. First, you need to list all the keys in your AWS account. You can do this by using the AWS CLI command `list-keys`. The command is as follows:

   ```
   aws kms list-keys --region your-region-name
   ```
   Replace 'your-region-name' with the name of your AWS region. This command will return a list of all the KMS keys in your account.

2. Once you have the list of keys, you can describe the key policy for each key. The command to do this is `get-key-policy`. The command is as follows:

   ```
   aws kms get-key-policy --key-id your-key-id --policy-name default
   ```
   Replace 'your-key-id' with the ID of the key you want to check. This command will return the policy of the key.

3. Now, you need to parse the output of the `get-key-policy` command to check the number of KMS admins. You can do this by using a Python script. The script will read the output of the `get-key-policy` command, convert it to a Python dictionary, and then count the number of KMS admins. Here is a sample script:

   ```python
   import json

   # Replace this with the output of the 'get-key-policy' command
   policy_output = ''

   policy = json.loads(policy_output)
   admins = [statement for statement in policy['Statement'] if 'kms:Create*' in statement['Action']]

   print('Number of KMS admins:', len(admins))
   ```

4. Repeat steps 2 and 3 for each key in your account. If any key has more than the desired number of KMS admins, it is a misconfiguration.

#### Using Python

1. Import the necessary AWS SDK for Python (Boto3) modules and initialize a new KMS client:

```python
import boto3
kms_client = boto3.client('kms')
```

2. Retrieve all the KMS keys in your AWS account:

```python
response = kms_client.list_keys()
kms_keys = response['Keys']
```

3. For each KMS key, retrieve the key policy and parse it to find the number of admins:

```python
for key in kms_keys:
    key_id = key['KeyId']
    policy = kms_client.get_key_policy(KeyId=key_id, PolicyName='default')
```

4. Parse the policy JSON and count the number of admins. If the number of admins is more than a certain threshold (e.g., 2), print a warning message:

```python
import json
policy_document = json.loads(policy['Policy'])
admin_count = 0
for statement in policy_document['Statement']:
    if 'kms:Create*' in statement['Action'] or 'kms:Describe*' in statement['Action']:
        admin_count += 1
if admin_count > 2:
    print(f"Warning: KMS key {key_id} has too many admins ({admin_count})")
```

This script will print a warning for each KMS key that has more than 2 admins. You can adjust the threshold as per your organization's requirements.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of KMS Key Policies should be designed to limit the number of KMS Admins in AWS, follow the below steps using AWS Console:

1. Open the AWS KMS Console.
2. From the left navigation pane, choose "Customer managed keys".
3. Select the KMS key for which you want to remediate the misconfiguration.
4. In the Key policy section, choose "Edit".
5. Update the key policy to include only the required number of IAM users or roles who need administrative access to the KMS key.
6. Remove any unnecessary IAM users or roles from the key policy.
7. Choose "Review policy".
8. Review the policy changes and ensure that the policy is designed to limit the number of KMS admins.
9. Choose "Save changes" to save the updated key policy.
10. Verify that only the required IAM users or roles have administrative access to the KMS key.

By following these steps, you can remediate the misconfiguration of KMS Key Policies should be designed to limit the number of KMS Admins in AWS.

#### Using CLI

To remediate this issue for AWS, you can follow these steps using AWS CLI:

1. Identify the KMS key ID that needs to be remediated.

2. Create a new IAM policy that grants the required permissions for KMS key management.

3. Attach the new IAM policy to an IAM user or role that needs to manage the KMS key.

4. Remove the KMS key administrator permissions from the existing IAM users or roles.

Here are the detailed steps:

Step 1: Identify the KMS key ID that needs to be remediated

Use the following command to list all the KMS keys in your AWS account:

```
aws kms list-keys
```

Identify the KMS key ID that needs to be remediated.

Step 2: Create a new IAM policy that grants the required permissions for KMS key management

Create a new IAM policy that grants the required permissions for KMS key management. Here's an example of a policy that allows a user to manage a specific KMS key:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowKeyManagement",
            "Effect": "Allow",
            "Action": [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion"
            ],
            "Resource": "arn:aws:kms:us-east-1:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab"
        }
    ]
}
```

Replace the KMS key ARN with the ARN of the KMS key that needs to be managed.

Step 3: Attach the new IAM policy to an IAM user or role that needs to manage the KMS key

Use the following command to attach the new IAM policy to an IAM user or role:

```
aws iam attach-user-policy --user-name <user-name> --policy-arn <policy-arn>
```

Replace `<user-name>` with the name of the IAM user or role that needs to manage the KMS key, and `<policy-arn>` with the ARN of the new IAM policy.

Step 4: Remove the KMS key administrator permissions from the existing IAM users or roles

Use the following command to remove the KMS key administrator permissions from the existing IAM users or roles:

```
aws kms revoke-grant --key-id <key-id> --grant-id <grant-id>
```

Replace `<key-id>` with the ID of the KMS key, and `<grant-id>` with the ID of the grant that needs to be revoked.

Repeat this command for each grant that needs to be revoked.

By following these steps, you can remediate the misconfiguration of KMS key policies that should be designed to limit the number of KMS admins for AWS.

#### Using Python

To remediate this misconfiguration in AWS using Python, you can follow these steps:

1. First, you need to identify the KMS keys that have overly permissive key policies. You can use the `boto3` library in Python to list all the KMS keys and their key policies.

```python
import boto3

# Create a KMS client
kms = boto3.client('kms')

# List all the KMS keys
response = kms.list_keys()

# Loop through each key and print its key policy
for key in response['Keys']:
    key_id = key['KeyId']
    key_policy = kms.get_key_policy(KeyId=key_id, PolicyName='default')['Policy']
    print(f"Key ID: {key_id} \nKey Policy: {key_policy}")
```

2. Once you have identified the KMS keys with overly permissive key policies, you need to update their policies to limit the number of KMS admins. You can use the `put_key_policy` method to update the key policy.

```python
import json

# Define the new key policy
new_policy = {
    "Version": "2012-10-17",
    "Id": "key-policy-1",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": [
                    "arn:aws:iam::123456789012:user/Admin1",
                    "arn:aws:iam::123456789012:user/Admin2"
                ]
            },
            "Action": [
                "kms:*"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow use of the key",
            "Effect": "Allow",
            "Principal": "*",
            "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey"
            ],
            "Resource": "*"
        }
    ]
}

# Update the key policy for a specific KMS key
response = kms.put_key_policy(
    KeyId='1234abcd-12ab-34cd-56ef-1234567890ab',
    PolicyName='default',
    Policy=json.dumps(new_policy)
)
```

In the above code, you need to replace the `KeyId` with the ID of the KMS key that you want to update, and replace the `AWS` ARNs with the ARNs of the IAM users who should have KMS admin permissions.

3. Repeat step 2 for all the KMS keys with overly permissive key policies.

By following these steps, you can remediate the misconfiguration of KMS key policies being designed to limit the number of KMS admins in AWS using Python.


</Tab>
</Tabs>