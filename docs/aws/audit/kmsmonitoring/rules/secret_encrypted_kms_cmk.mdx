---
slug: secret_encrypted_kms_cmk
title: Secret Manager Secrets Should Be Encrypted With CMKs
sidebar_label: Secret Manager Secrets Should Be Encrypted With CMKs
---

### More Info:

Ensure that your Amazon Secrets Manager secrets (i.e. database credentials, API keys, OAuth tokens, etc) are encrypted with Amazon KMS Customer Master Keys (CMKs) instead of default encryption keys that Secrets Manager service creates for you, in order to have a more granular control over secret data encryption and decryption process, and meet compliance requirements.

### Risk Level

High

### Address

Security

### Compliance Standards

ISO27001, HIPAA, NISTCSF, PCIDSS


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the AWS Key Management Service (KMS) dashboard at https://console.aws.amazon.com/kms/.
3. In the navigation pane, choose "Customer managed keys". Here you can see all the keys that are managed by the customer.
4. For each key, click on its alias to open the key details page. Under the "Key policy" section, check if the key is used to encrypt any Secret Manager secrets. If not, it indicates that the Secret Manager secrets are not encrypted with CMKs in KMS.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all the secrets in the Secret Manager. You can do this by using the following AWS CLI command:

```bash
aws secretsmanager list-secrets --region <region-name>
```

2. Once you have the list of secrets, you can describe each secret to get its details. You can do this by using the following AWS CLI command:

```bash
aws secretsmanager describe-secret --secret-id <secret-id> --region <region-name>
```

3. In the output of the above command, look for the "KmsKeyId" field. This field indicates the AWS KMS key that's used to encrypt the secret. If this field is not present or if it's using the default AWS managed key (alias/aws/secretsmanager), then the secret is not encrypted with a customer managed key (CMK).

4. Repeat the above steps for all the secrets in the Secret Manager. If any secret is not encrypted with a CMK, then it's a misconfiguration.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: You will need the `boto3` library for AWS, `azure-mgmt-keyvault` for Azure, and `google-cloud-secret-manager` for GCP. You can install these libraries using pip:

   ```bash
   pip install boto3 azure-mgmt-keyvault google-cloud-secret-manager
   ```

2. AWS: Use the `boto3` library to list all secrets in the Secret Manager and check if they are encrypted with a customer-managed key (CMK):

   ```python
   import boto3

   client = boto3.client('secretsmanager')

   response = client.list_secrets()

   for secret in response['SecretList']:
       if 'KmsKeyId' not in secret:
           print(f"Secret {secret['Name']} is not encrypted with a CMK")
   ```

3. Azure: Use the `azure-mgmt-keyvault` library to list all secrets in the Key Vault and check if they are encrypted with a customer-managed key:

   ```python
   from azure.mgmt.keyvault import KeyVaultManagementClient
   from azure.identity import DefaultAzureCredential

   credential = DefaultAzureCredential()
   client = KeyVaultManagementClient(credential, "<subscription_id>")

   for vault in client.vaults.list():
       for secret in client.vaults.get(vault.name).properties.enabled_for_disk_encryption:
           if not secret:
               print(f"Secret {secret.name} in vault {vault.name} is not encrypted with a CMK")
   ```

4. GCP: Use the `google-cloud-secret-manager` library to list all secrets in the Secret Manager and check if they are encrypted with a customer-managed key:

   ```python
   from google.cloud import secretmanager

   client = secretmanager.SecretManagerServiceClient()

   for secret in client.list_secrets(request={"parent": "projects/<project_id>"}):
       if 'kmsKeyName' not in secret.replication.automatic:
           print(f"Secret {secret.name} is not encrypted with a CMK")
   ```
   
Please replace `<subscription_id>` and `<project_id>` with your actual Azure subscription ID and GCP project ID respectively.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Here are the step-by-step instructions to remediate the "Secret Manager Secrets Should Be Encrypted With CMKs" misconfiguration in AWS using the AWS console:

1. Log in to the AWS Management Console and navigate to the AWS Secrets Manager service.

2. Click on the secret that needs to be remediated.

3. Under the "Encryption" section, click on the "Edit" button.

4. Select the "AWS KMS customer master key (CMK)" option.

5. Choose the appropriate CMK from the list or create a new one.

6. Click on the "Save" button to save the changes.

7. Ensure that the secret is now encrypted with the selected CMK by checking the "Encryption" section.

That's it! Following these steps should remediate the "Secret Manager Secrets Should Be Encrypted With CMKs" misconfiguration in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" for AWS using AWS CLI, you can follow the below steps:

1. Open the AWS CLI on your local machine or EC2 instance.
2. Run the following command to list all the secrets in the Secret Manager:

   ```
   aws secretsmanager list-secrets
   ```

3. Note down the ARN of the secret that needs to be encrypted with a CMK.
4. Create a new KMS customer managed key (CMK) by running the following command:

   ```
   aws kms create-key --description "My new CMK"
   ```

5. Note down the ARN of the newly created CMK.
6. Run the following command to update the secret to use the newly created CMK:

   ```
   aws secretsmanager update-secret-version-stage --secret-id <ARN-of-secret> --secret-version-stage AWSCURRENT --kms-key-id <ARN-of-new-CMK>
   ```

   Replace `<ARN-of-secret>` with the ARN of the secret that needs to be encrypted with a CMK, and `<ARN-of-new-CMK>` with the ARN of the newly created CMK.

7. Verify that the secret is now encrypted with the new CMK by running the following command:

   ```
   aws secretsmanager describe-secret --secret-id <ARN-of-secret>
   ```

   This command should return the details of the secret, including the KMS key ID.

By following the above steps, you can remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" for AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" in AWS using Python, you can follow the below steps:

1. Create a Customer Managed Key (CMK) in AWS Key Management Service (KMS) if not already created.

```python
import boto3

kms_client = boto3.client('kms')

response = kms_client.create_key(
    Description='CMK for Secret Manager',
    KeyUsage='ENCRYPT_DECRYPT',
    Origin='AWS_KMS'
)

cmk_arn = response['KeyMetadata']['Arn']
```

2. Enable Key Rotation for the CMK created in step 1.

```python
import boto3

kms_client = boto3.client('kms')

kms_client.enable_key_rotation(
    KeyId='CMK_ARN'
)
```

3. Update the Secrets in AWS Secret Manager to use the CMK created in step 1 for encryption.

```python
import boto3

secrets_client = boto3.client('secretsmanager')

response = secrets_client.update_secret(
    SecretId='SECRET_NAME',
    KmsKeyId='CMK_ARN',
    SecretString='{"username":"admin","password":"secret"}'
)
```

Note: Replace `CMK_ARN` with the ARN of the CMK created in step 1 and `SECRET_NAME` with the name of the Secret in AWS Secret Manager that needs to be updated.

By following these steps, you can remediate the misconfiguration "Secret Manager Secrets Should Be Encrypted With CMKs" for AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/secretsmanager/latest/userguide/security-encryption.html](https://docs.aws.amazon.com/secretsmanager/latest/userguide/security-encryption.html) 

