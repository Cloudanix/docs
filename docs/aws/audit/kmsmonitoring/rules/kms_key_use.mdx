---
slug: kms_key_use
title: KMS Customer Master Key Should Be In Use
sidebar_label: KMS Customer Master Key Should Be In Use
---

### More Info:

You should have KMS CMK customer-managed keys in use in your account instead of AWS managed-keys in order to have full control over your data encryption and decryption process.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" into the search bar and selecting "Key Management Service" from the dropdown menu.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand menu. This will display a list of all the Customer Master Keys (CMKs) that are currently in your AWS account.
4. To check if a CMK is in use, look at the "Key Usage" column. If the key is being used, it will display "Encrypt and Decrypt". If the key is not in use, it will display "None".
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access KMS resources.

2. Once AWS CLI is set up, you can list all the KMS keys in your account by running the following command:

   ```
   aws kms list-keys --region your-region-name
   ```

   Replace 'your-region-name' with the name of the AWS region where your KMS keys are located. This command will return a list of all KMS keys in the specified region.

3. To check if a specific KMS key is in use, you need to check the key's rotation status. You can do this by running the following command:

   ```
   aws kms get-key-rotation-status --key-id your-key-id --region your-region-name
   ```

   Replace 'your-key-id' with the ID of the KMS key you want to check, and 'your-region-name' with the name of the AWS region where the key is located. This command will return the rotation status of the specified key.

4. If the key is not in use, the 'KeyRotationEnabled' field in the response will be 'false'. If the key is in use, the 'KeyRotationEnabled' field will be 'true'. This is because AWS automatically rotates keys that are in use. Therefore, if a key is not being rotated, it is likely not in use.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. For AWS, you will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary libraries and initialize the client: In your Python script, you will need to import the boto3 library and initialize the KMS client. You can do this with the following code:

```python
import boto3

# Create a client
kms = boto3.client('kms')
```

3. List all the keys and check their usage: You can list all the keys in your AWS account using the list_keys() function. Then, for each key, you can check its usage using the get_key_rotation_status() function. If the key is not in use, print a message:

```python
# List all keys
response = kms.list_keys()

# For each key, check its usage
for key in response['Keys']:
    key_id = key['KeyId']
    rotation_status = kms.get_key_rotation_status(KeyId=key_id)
    
    # If the key is not in use, print a message
    if not rotation_status['KeyRotationEnabled']:
        print(f'Key {key_id} is not in use.')
```

4. Run the script: Finally, you can run the script. If there are any keys that are not in use, they will be printed out. If all keys are in use, nothing will be printed. This script will help you detect any KMS Customer Master Keys that are not in use in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the KMS Customer Master Key Should Be In Use misconfiguration in AWS using AWS console, follow these steps:

1. Open the AWS Management Console and navigate to the AWS Key Management Service (KMS) console.

2. Click on the "Customer managed keys" option in the left-hand menu.

3. Identify the key that is not in use and select it by clicking on its alias.

4. Click on the "Key actions" dropdown menu and select "Enable Key".

5. In the pop-up window, select the AWS service(s) that you want to use the key with and click "Enable".

6. Once enabled, the key will be available for use by the selected AWS service(s).

7. Repeat steps 3-6 for any other keys that are not in use.

8. Verify that the KMS Customer Master Key is now in use by checking the compliance status of the resource or by running a compliance check.

By following these steps, you can remediate the KMS Customer Master Key Should Be In Use misconfiguration in AWS using AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
The misconfiguration "KMS Customer Master Key Should Be In Use" suggests that the AWS Key Management Service (KMS) is not being used to encrypt data at rest. To remediate this, you can follow these steps using AWS CLI:

1. Identify the resources that are not using KMS encryption. You can use the following command to list all the EBS volumes that are not encrypted with KMS:
```
aws ec2 describe-volumes --query "Volumes[?Encrypted=='false']"
```

2. Encrypt the EBS volumes with KMS. To do this, create a new KMS Customer Master Key (CMK) or use an existing one. You can use the following command to create a new CMK:
```
aws kms create-key --description "My new CMK"
```

3. Once you have a CMK, you can use it to encrypt the EBS volumes. You can use the following command to encrypt a specific EBS volume:
```
aws ec2 modify-volume --volume-id <volume-id> --encrypted --kms-key-id <kms-key-id>
```
Replace `<volume-id>` with the ID of the EBS volume and `<kms-key-id>` with the ID of the CMK.

4. Repeat step 3 for all the EBS volumes that are not encrypted with KMS.

5. Finally, verify that all the EBS volumes are encrypted with KMS. You can use the following command to list all the EBS volumes and their encryption status:
```
aws ec2 describe-volumes --query "Volumes[*].[VolumeId,Encrypted,KmsKeyId]"
``` 

Note: Make sure to test the remediation steps in a non-production environment before applying them to a production environment.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of KMS Customer Master Key Should Be In Use in AWS using Python, follow these steps:

1. Identify the AWS resource that is not using a KMS customer master key. This can be done by using the AWS CLI command `aws kms list-aliases` to list all the KMS customer master keys and `aws kms list-grants` to list all the grants for the KMS customer master keys.

2. Once you have identified the resource that is not using a KMS customer master key, you can use the AWS SDK for Python (Boto3) to update the resource to use a KMS customer master key. For example, if the resource is an S3 bucket, you can use the following code snippet to update the bucket policy to use a KMS customer master key:

```python
import boto3
import json

s3 = boto3.client('s3')

bucket_name = 'your-bucket-name'
kms_key_arn = 'your-kms-key-arn'

bucket_policy = {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DenyUnEncryptedObjectUploads",
            "Effect": "Deny",
            "Principal": "*",
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::{}/*".format(bucket_name),
            "Condition": {
                "Null": {
                    "s3:x-amz-server-side-encryption": "true"
                }
            }
        }
    ]
}

bucket_policy['Statement'][0]['Condition']['StringEquals'] = {
    "s3:x-amz-server-side-encryption-aws-kms-key-id": kms_key_arn
}

s3.put_bucket_policy(
    Bucket=bucket_name,
    Policy=json.dumps(bucket_policy)
)
```

This code snippet updates the bucket policy to deny uploads of unencrypted objects and adds a condition to require the use of a KMS customer master key for server-side encryption of objects in the bucket.

3. Repeat the above steps for any other AWS resources that are not using a KMS customer master key.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html) 

