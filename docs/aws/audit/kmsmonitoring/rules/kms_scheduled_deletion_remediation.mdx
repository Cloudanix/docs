

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the KMS dashboard at https://console.aws.amazon.com/kms/.
3. In the navigation pane, choose "Customer managed keys".
4. Here, you can see all your KMS keys. Check the "Key state" column for each key. If a key is scheduled for deletion, it will be listed as "Pending Deletion".

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. Make sure you have the necessary permissions to access KMS keys.

2. Use the following AWS CLI command to list all the KMS keys:

   ```
   aws kms list-keys
   ```

   This command will return a list of all KMS keys in your AWS account.

3. To check if a KMS key is scheduled for deletion, use the following command:

   ```
   aws kms describe-key --key-id <key-id>
   ```

   Replace `<key-id>` with the ID of the key you want to check. This command will return the metadata associated with the specified KMS key.

4. In the output of the above command, look for the `KeyState` field. If the value of this field is `PendingDeletion`, it means the key is scheduled for deletion. If the `DeletionDate` field is also present, it indicates the date and time when the key is scheduled to be deleted.

#### Using Python

1. Install the necessary Python SDKs for AWS. This can be done using pip, the Python package installer. For AWS, you would need to install boto3. You can install it using the following command:

```python
pip install boto3
```

2. Configure your AWS credentials. Boto3 uses the AWS SDK for Python to allow developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You need to configure your AWS credentials for boto3 to use. You can do this in several ways, but the simplest is to use the AWS CLI. Run `aws configure` and then enter your credentials at the prompts.

3. Write a Python script to list all KMS keys and check their deletion status. Here is a sample script:

```python
import boto3

def list_keys():
    client = boto3.client('kms')
    response = client.list_keys()
    return response['Keys']

def check_deletion_status(key_id):
    client = boto3.client('kms')
    response = client.describe_key(KeyId=key_id)
    if 'PendingWindowInDays' in response['KeyMetadata']['DeletionDate']:
        return True
    return False

keys = list_keys()
for key in keys:
    if check_deletion_status(key['KeyId']):
        print(f"Key {key['KeyId']} is scheduled for deletion.")
```

4. Run the script. If any keys are scheduled for deletion, they will be printed out. This script only checks the status of the keys, it does not recover them. You would need to manually recover the keys or write another script to do so.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step by step instructions to remediate the KMS Keys Scheduled for Deletion should be recovered misconfiguration in AWS using the AWS console:

1. Open the AWS Management Console and navigate to the KMS service.

2. In the left navigation pane, click on "Scheduled Deletion".

3. Check the list of keys scheduled for deletion and identify the key that needs to be recovered.

4. Select the key by clicking on the checkbox next to it.

5. Click on the "Recover" button on the top of the page.

6. In the confirmation dialog box, click on the "Recover" button again to confirm the recovery.

7. Once the key is recovered, it will be available for use again.

That's it! You have successfully remediated the KMS Keys Scheduled for Deletion should be recovered misconfiguration in AWS using the AWS console.

#### Using CLI

Sure, here are the step-by-step instructions to remediate the KMS Keys Scheduled for Deletion should be Recovered issue in AWS using AWS CLI:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the KMS keys that are scheduled for deletion:

```
aws kms list-grants --key-id <key-id> --query "Grants[?RetiringPrincipal!=''].GrantId"
```

Note: Replace `<key-id>` with the ID of the KMS key that is scheduled for deletion.

3. Review the output of the command and identify the Grant IDs of the grants that are scheduled for deletion.

4. Run the following command to recover the grants that are scheduled for deletion:

```
aws kms retire-grant --key-id <key-id> --grant-id <grant-id>
```

Note: Replace `<key-id>` with the ID of the KMS key that is scheduled for deletion and `<grant-id>` with the ID of the grant that you want to recover.

5. Repeat steps 4 and 5 for all the grants that are scheduled for deletion.

6. Once you have recovered all the grants that were scheduled for deletion, recheck the status of the KMS key to ensure that the issue has been resolved.

That's it! These steps should help you remediate the KMS Keys Scheduled for Deletion should be Recovered issue in AWS using AWS CLI.

#### Using Python

To remediate this issue in AWS using Python, you can use the AWS SDK for Python (Boto3) to recover the KMS keys that are scheduled for deletion. Here are the steps to do so:

1. Import the required Boto3 libraries:

```python
import boto3
from botocore.exceptions import ClientError
```

2. Create a Boto3 client for the KMS service:

```python
kms_client = boto3.client('kms')
```

3. Use the `list_grants` API to get the list of all KMS keys that are scheduled for deletion:

```python
try:
    response = kms_client.list_grants(Filters=[{'Key': 'GrantState', 'Values': ['PendingDeletion']}])
    grants = response['Grants']
except ClientError as e:
    print(f"Error listing KMS grants: {e}")
    grants = []
```

4. For each grant that is scheduled for deletion, use the `cancel_key_deletion` API to cancel the scheduled deletion:

```python
for grant in grants:
    try:
        response = kms_client.cancel_key_deletion(KeyId=grant['KeyId'])
        print(f"Cancelled deletion for KMS key {grant['KeyId']}")
    except ClientError as e:
        print(f"Error cancelling deletion for KMS key {grant['KeyId']}: {e}")
```

This Python script will cancel the scheduled deletion for all KMS keys that are in the "PendingDeletion" state. You can run this script periodically to ensure that any KMS keys that are scheduled for deletion are recovered.


</Tab>
</Tabs>