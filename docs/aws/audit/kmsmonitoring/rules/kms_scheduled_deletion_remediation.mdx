
### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" in the search box and selecting "Key Management Service" from the dropdown list.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand side menu. This will display a list of all the KMS keys that are currently managed by your account.
4. Check the "Key state" column for each key. If a key is scheduled for deletion, its state will be listed as "Pending Deletion".
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access KMS keys.

2. Once AWS CLI is installed and configured, you can list all the KMS keys that are scheduled for deletion by running the following command:

   ```
   aws kms list-keys
   ```

   This command will list all the KMS keys in your account.

3. For each key listed, you can check its metadata to see if it's scheduled for deletion. You can do this by running the following command:

   ```
   aws kms describe-key --key-id <key-id>
   ```

   Replace `<key-id>` with the ID of the key you want to check. This command will return a JSON object that contains the metadata of the key.

4. In the returned JSON object, look for the `KeyState` field. If the value of this field is `PendingDeletion`, it means the key is scheduled for deletion. If the value is `Enabled`, it means the key is not scheduled for deletion.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python SDKs for AWS. This can be done using pip, the Python package installer. For AWS, you will need the boto3 SDK. You can install it using the following command:

```python
pip install boto3
```

2. Import the necessary libraries and initialize the AWS client. You will need to import boto3 and initialize the KMS client. You can do this with the following code:

```python
import boto3
kms_client = boto3.client('kms')
```

3. Fetch the list of all KMS keys that are scheduled for deletion. You can do this using the `list_keys` method of the KMS client and then filtering the keys that have the `KeyState` as `PendingDeletion`. Here is a sample code:

```python
keys = kms_client.list_keys()
keys_scheduled_for_deletion = [key for key in keys['Keys'] if kms_client.describe_key(KeyId=key['KeyId'])['KeyMetadata']['KeyState'] == 'PendingDeletion']
```

4. Print the keys that are scheduled for deletion. You can do this with a simple print statement:

```python
print("Keys scheduled for deletion: ", keys_scheduled_for_deletion)
```

This script will print all the KMS keys that are scheduled for deletion. If there are no keys scheduled for deletion, it will print an empty list.
</Accordion>

</AccordionGroup>
</Tab>
<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step by step instructions to remediate the KMS Keys Scheduled for Deletion should be recovered misconfiguration in AWS using the AWS console:

1. Open the AWS Management Console and navigate to the KMS service.

2. In the left navigation pane, click on "Scheduled Deletion".

3. Check the list of keys scheduled for deletion and identify the key that needs to be recovered.

4. Select the key by clicking on the checkbox next to it.

5. Click on the "Recover" button on the top of the page.

6. In the confirmation dialog box, click on the "Recover" button again to confirm the recovery.

7. Once the key is recovered, it will be available for use again.

That's it! You have successfully remediated the KMS Keys Scheduled for Deletion should be recovered misconfiguration in AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
Sure, here are the step-by-step instructions to remediate the KMS Keys Scheduled for Deletion should be Recovered issue in AWS using AWS CLI:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the KMS keys that are scheduled for deletion:

```
aws kms list-grants --key-id <key-id> --query "Grants[?RetiringPrincipal!=''].GrantId"
```

Note: Replace `<key-id>` with the ID of the KMS key that is scheduled for deletion.

3. Review the output of the command and identify the Grant IDs of the grants that are scheduled for deletion.

4. Run the following command to recover the grants that are scheduled for deletion:

```
aws kms retire-grant --key-id <key-id> --grant-id <grant-id>
```

Note: Replace `<key-id>` with the ID of the KMS key that is scheduled for deletion and `<grant-id>` with the ID of the grant that you want to recover.

5. Repeat steps 4 and 5 for all the grants that are scheduled for deletion.

6. Once you have recovered all the grants that were scheduled for deletion, recheck the status of the KMS key to ensure that the issue has been resolved.

That's it! These steps should help you remediate the KMS Keys Scheduled for Deletion should be Recovered issue in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate this issue in AWS using Python, you can use the AWS SDK for Python (Boto3) to recover the KMS keys that are scheduled for deletion. Here are the steps to do so:

1. Import the required Boto3 libraries:

```python
import boto3
from botocore.exceptions import ClientError
```

2. Create a Boto3 client for the KMS service:

```python
kms_client = boto3.client('kms')
```

3. Use the `list_grants` API to get the list of all KMS keys that are scheduled for deletion:

```python
try:
    response = kms_client.list_grants(Filters=[{'Key': 'GrantState', 'Values': ['PendingDeletion']}])
    grants = response['Grants']
except ClientError as e:
    print(f"Error listing KMS grants: {e}")
    grants = []
```

4. For each grant that is scheduled for deletion, use the `cancel_key_deletion` API to cancel the scheduled deletion:

```python
for grant in grants:
    try:
        response = kms_client.cancel_key_deletion(KeyId=grant['KeyId'])
        print(f"Cancelled deletion for KMS key {grant['KeyId']}")
    except ClientError as e:
        print(f"Error cancelling deletion for KMS key {grant['KeyId']}: {e}")
```

This Python script will cancel the scheduled deletion for all KMS keys that are in the "PendingDeletion" state. You can run this script periodically to ensure that any KMS keys that are scheduled for deletion are recovered.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
