

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" in the search box and selecting "Key Management Service" from the dropdown list.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand side menu. This will display a list of all the customer master keys (CMKs) that are currently available within your AWS account.
4. For each CMK listed, check the "Last accessed" column. If the date is more than 90 days ago, or if the column says "Never", this indicates that the CMK is unused and should be removed.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access KMS.

2. Once AWS CLI is installed and configured, you can list all the keys in your account by running the following command:

   ```
   aws kms list-keys
   ```

   This command will return a list of all the keys in your account, including their key IDs and ARNs.

3. To check if a key is used or not, you can use the `list-key-policies` command. This command will return a list of all the policies attached to a key. If a key has no policies attached to it, it means it's not used. Here is the command:

   ```
   aws kms list-key-policies --key-id <your-key-id>
   ```

   Replace `<your-key-id>` with the ID of the key you want to check.

4. If the key is not used, it will return an empty list. If it returns any policies, it means the key is in use. You can also use the `get-key-rotation-status` command to check if the key rotation is enabled or not. If it's not enabled, it's another sign that the key might not be in use.

   ```
   aws kms get-key-rotation-status --key-id <your-key-id>
   ```

   Replace `<your-key-id>` with the ID of the key you want to check. If the key rotation is not enabled, the command will return `false`.

#### Using Python

1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the 'boto3' library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can set your credentials for use by boto3 in several ways, but the simplest is to use the AWS CLI. Run 'aws configure' and then enter your access key, secret access key, and default region when prompted.

3. Write a Python script to list all the keys and their usage: You can use the 'list_keys' method to retrieve all the keys in your account. Then, for each key, use the 'get_key_rotation_status' and 'list_key_policies' methods to check if the key is being used. Here is a sample script:

   ```python
   import boto3

   # Create a client
   kms = boto3.client('kms')

   # List all keys
   response = kms.list_keys()

   # For each key, check its usage
   for key in response['Keys']:
       key_id = key['KeyId']
       key_rotation_status = kms.get_key_rotation_status(KeyId=key_id)
       key_policies = kms.list_key_policies(KeyId=key_id)

       # If the key is not being used, print it
       if not key_rotation_status['KeyRotationEnabled'] and not key_policies['PolicyNames']:
           print(f"Unused key: {key_id}")
   ```

4. Run the script: Finally, run the script using a Python interpreter. The script will print out the IDs of all unused keys. If no keys are printed, that means all keys are being used.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the issue of an unused Customer Master Key in AWS:

1. Log in to the AWS Management Console.
2. Go to the AWS Key Management Service (KMS) console.
3. In the left navigation pane, select "Customer managed keys."
4. Find the Customer Master Key (CMK) that is not being used and select it.
5. In the "Key state" section, check if the key is enabled or disabled. If the key is enabled, disable it by selecting "Disable key" from the "Actions" dropdown menu.
6. Once the key is disabled, select "Schedule key deletion" from the "Actions" dropdown menu.
7. In the "Schedule key deletion" dialog box, specify the number of days for which you want to retain the key before it is deleted permanently. You can select a minimum of 7 days and a maximum of 30 days.
8. Click on the "Schedule key deletion" button to schedule the deletion of the key.

By following these steps, you can remediate the issue of an unused Customer Master Key in AWS and ensure that your cloud environment is secure.

#### Using CLI

To remediate the misconfiguration of an unused customer master key in AWS using AWS CLI, you can follow these steps:

1. Open your AWS CLI and run the following command to list all the Customer Master Keys (CMKs) in your account:

   ```
   aws kms list-keys
   ```

   This command will return a list of all the CMKs in your account.

2. Identify the unused CMK that you want to remove and make sure that it is not being used by any resources or services in your account.

3. Run the following command to disable the CMK:

   ```
   aws kms disable-key --key-id <key-id>
   ```

   Replace `<key-id>` with the ID of the CMK that you want to disable.

4. After disabling the CMK, run the following command to schedule the deletion of the CMK:

   ```
   aws kms schedule-key-deletion --key-id <key-id> --pending-window-in-days 7
   ```

   Replace `<key-id>` with the ID of the CMK that you want to delete and `--pending-window-in-days` with the number of days (between 7 and 30) that you want to wait before the CMK is permanently deleted.

5. Verify that the CMK has been scheduled for deletion by running the following command:

   ```
   aws kms list-scheduled-key-deletions
   ```

   This command will return a list of all the CMKs that are scheduled for deletion.

6. Once the scheduled deletion time has passed, the CMK will be permanently deleted from your account.

Note: Before deleting any CMK, it is important to ensure that it is not being used by any resources or services in your account. Deleting a CMK that is being used can cause data loss or service disruption.

#### Using Python

To remediate the misconfiguration "Unused Customer Master Key Should Be Removed" in AWS using Python, you can follow the below steps:

1. Import the necessary AWS SDKs and modules in Python.
2. Use the AWS Key Management Service (KMS) API to list all the customer master keys (CMKs) in your AWS account.
3. For each CMK, check if it is in use by any AWS resource or service. If not, delete the CMK.
4. To delete a CMK, use the `boto3` Python module to call the `kms.delete_key()` method and pass the CMK ID as a parameter.

Here is a sample Python code that can help you remediate the misconfiguration:

```python
import boto3

# Create a KMS client
kms = boto3.client('kms')

# List all the customer master keys (CMKs)
response = kms.list_keys()

# For each CMK, check if it is in use by any AWS resource or service
for key in response['Keys']:
    key_id = key['KeyId']
    key_metadata = kms.describe_key(KeyId=key_id)

    if not key_metadata['KeyMetadata']['Enabled']:
        # If the CMK is disabled, delete it
        print(f"Deleting disabled CMK {key_id}...")
        kms.schedule_key_deletion(KeyId=key_id)
    elif not key_metadata['KeyMetadata']['KeyUsage']:
        # If the CMK is not in use, delete it
        print(f"Deleting unused CMK {key_id}...")
        kms.schedule_key_deletion(KeyId=key_id)
    else:
        print(f"Skipping CMK {key_id}: in use by {key_metadata['KeyMetadata']['KeyUsage']}")

print("CMK remediation completed.")
```

Note: Before running the code, make sure you have the necessary AWS credentials and permissions to access the KMS API. Also, make sure to test the code in a non-production environment before implementing it in a production environment.


</Tab>
</Tabs>