---
slug: kms_scheduled_deletion
title: KMS Keys Scheduled For Deletion Should Be Recovered
sidebar_label: KMS Keys Scheduled For Deletion Should Be Recovered
---

### More Info:

Any disabled AWS KMS Customer Master Keys (CMK) that have been accidentally or intentionally scheduled for deletion should be recovered in order to prevent losing any data encrypted with these keys.

### Risk Level

Low

### Address

Reliability, Security

### Compliance Standards

HIPAA, NIST, AWSWAF


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent KMS Keys from being scheduled for deletion in AWS using the AWS Management Console, follow these steps:

1. **Access the KMS Dashboard:**
   - Sign in to the AWS Management Console.
   - Navigate to the Key Management Service (KMS) by searching for "KMS" in the search bar and selecting it from the results.

2. **Review Key Status:**
   - In the KMS dashboard, click on "Customer managed keys" in the left-hand menu.
   - Review the list of keys and check the status of each key. Keys scheduled for deletion will have a status indicating they are pending deletion.

3. **Cancel Key Deletion:**
   - For any key that is scheduled for deletion, click on the key ID or alias to open its details page.
   - In the key details page, look for the "Key actions" button and select "Cancel deletion" from the dropdown menu.

4. **Confirm Cancellation:**
   - A confirmation dialog will appear. Confirm the cancellation by clicking the "Cancel deletion" button in the dialog.
   - The key's status will change from "Pending deletion" to "Enabled" or "Disabled," depending on its previous state.

By following these steps, you can ensure that KMS keys are not inadvertently deleted and remain available for use.
</Accordion>

<Accordion title='Using CLI'>
To prevent KMS keys from being scheduled for deletion in AWS using the AWS CLI, you can follow these steps:

1. **List All KMS Keys**:
   First, identify the KMS keys that are scheduled for deletion. You can list all KMS keys and filter out the ones that are scheduled for deletion.
   ```sh
   aws kms list-keys
   ```

2. **Describe Key to Check Deletion Status**:
   For each key, describe the key to check if it is scheduled for deletion.
   ```sh
   aws kms describe-key --key-id <key-id>
   ```

3. **Cancel Key Deletion**:
   If a key is found to be scheduled for deletion, cancel the deletion process.
   ```sh
   aws kms cancel-key-deletion --key-id <key-id>
   ```

4. **Automate the Process**:
   To ensure that keys are not accidentally scheduled for deletion in the future, you can create a script that periodically checks for keys scheduled for deletion and cancels the deletion if found. Here is a simple example in Python using Boto3:
   ```python
   import boto3

   kms_client = boto3.client('kms')

   def cancel_scheduled_deletions():
       keys = kms_client.list_keys()['Keys']
       for key in keys:
           key_id = key['KeyId']
           key_metadata = kms_client.describe_key(KeyId=key_id)['KeyMetadata']
           if key_metadata['KeyState'] == 'PendingDeletion':
               kms_client.cancel_key_deletion(KeyId=key_id)
               print(f"Cancelled deletion for key: {key_id}")

   if __name__ == "__main__":
       cancel_scheduled_deletions()
   ```

By following these steps, you can prevent KMS keys from being scheduled for deletion using the AWS CLI and automate the process to ensure continuous compliance.
</Accordion>

<Accordion title='Using Python'>
To prevent KMS keys from being scheduled for deletion in AWS KMS using Python scripts, you can follow these steps:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed, which is the AWS SDK for Python. You can install it using pip if you haven't already.

   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by setting environment variables.

   ```bash
   aws configure
   ```

3. **Create a Python Script to List KMS Keys**:
   Write a Python script to list all KMS keys and check their status. This script will help you identify keys that are scheduled for deletion.

   ```python
   import boto3

   # Initialize a session using Amazon KMS
   kms_client = boto3.client('kms')

   # List all KMS keys
   def list_kms_keys():
       keys = kms_client.list_keys()
       return keys['Keys']

   # Check the status of each key
   def check_key_status(key_id):
       key_metadata = kms_client.describe_key(KeyId=key_id)
       return key_metadata['KeyMetadata']['KeyState']

   # Main function
   def main():
       keys = list_kms_keys()
       for key in keys:
           key_id = key['KeyId']
           status = check_key_status(key_id)
           if status == 'PendingDeletion':
               print(f"Key {key_id} is scheduled for deletion.")

   if __name__ == "__main__":
       main()
   ```

4. **Prevent Keys from Being Scheduled for Deletion**:
   Modify the script to automatically cancel the deletion of keys that are found to be scheduled for deletion.

   ```python
   import boto3

   # Initialize a session using Amazon KMS
   kms_client = boto3.client('kms')

   # List all KMS keys
   def list_kms_keys():
       keys = kms_client.list_keys()
       return keys['Keys']

   # Check the status of each key
   def check_key_status(key_id):
       key_metadata = kms_client.describe_key(KeyId=key_id)
       return key_metadata['KeyMetadata']['KeyState']

   # Cancel key deletion
   def cancel_key_deletion(key_id):
       kms_client.cancel_key_deletion(KeyId=key_id)
       print(f"Cancelled deletion for key {key_id}")

   # Main function
   def main():
       keys = list_kms_keys()
       for key in keys:
           key_id = key['KeyId']
           status = check_key_status(key_id)
           if status == 'PendingDeletion':
               cancel_key_deletion(key_id)

   if __name__ == "__main__":
       main()
   ```

By following these steps, you can prevent KMS keys from being scheduled for deletion using a Python script. This script will list all KMS keys, check their status, and cancel the deletion for any keys that are found to be scheduled for deletion.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" in the search box and selecting "Key Management Service" from the dropdown list.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand side menu. This will display a list of all the KMS keys that are currently managed by your account.
4. Check the "Key state" column for each key. If a key is scheduled for deletion, its state will be listed as "Pending Deletion".
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access KMS keys.

2. Once AWS CLI is installed and configured, you can list all the KMS keys that are scheduled for deletion by running the following command:

   ```
   aws kms list-keys
   ```

   This command will list all the KMS keys in your account.

3. For each key listed, you can check its metadata to see if it's scheduled for deletion. You can do this by running the following command:

   ```
   aws kms describe-key --key-id <key-id>
   ```

   Replace `<key-id>` with the ID of the key you want to check. This command will return a JSON object that contains the metadata of the key.

4. In the returned JSON object, look for the `KeyState` field. If the value of this field is `PendingDeletion`, it means the key is scheduled for deletion. If the value is `Enabled`, it means the key is not scheduled for deletion.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python SDKs for AWS. This can be done using pip, the Python package installer. For AWS, you will need the boto3 SDK. You can install it using the following command:

```python
pip install boto3
```

2. Import the necessary libraries and initialize the AWS client. You will need to import boto3 and initialize the KMS client. You can do this with the following code:

```python
import boto3
kms_client = boto3.client('kms')
```

3. Fetch the list of all KMS keys that are scheduled for deletion. You can do this using the `list_keys` method of the KMS client and then filtering the keys that have the `KeyState` as `PendingDeletion`. Here is a sample code:

```python
keys = kms_client.list_keys()
keys_scheduled_for_deletion = [key for key in keys['Keys'] if kms_client.describe_key(KeyId=key['KeyId'])['KeyMetadata']['KeyState'] == 'PendingDeletion']
```

4. Print the keys that are scheduled for deletion. You can do this with a simple print statement:

```python
print("Keys scheduled for deletion: ", keys_scheduled_for_deletion)
```

This script will print all the KMS keys that are scheduled for deletion. If there are no keys scheduled for deletion, it will print an empty list.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step by step instructions to remediate the KMS Keys Scheduled for Deletion should be recovered misconfiguration in AWS using the AWS console:

1. Open the AWS Management Console and navigate to the KMS service.

2. In the left navigation pane, click on "Scheduled Deletion".

3. Check the list of keys scheduled for deletion and identify the key that needs to be recovered.

4. Select the key by clicking on the checkbox next to it.

5. Click on the "Recover" button on the top of the page.

6. In the confirmation dialog box, click on the "Recover" button again to confirm the recovery.

7. Once the key is recovered, it will be available for use again.

That's it! You have successfully remediated the KMS Keys Scheduled for Deletion should be recovered misconfiguration in AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
Sure, here are the step-by-step instructions to remediate the KMS Keys Scheduled for Deletion should be Recovered issue in AWS using AWS CLI:

1. Open the AWS CLI on your local machine.

2. Run the following command to list all the KMS keys that are scheduled for deletion:

```
aws kms list-grants --key-id <key-id> --query "Grants[?RetiringPrincipal!=''].GrantId"
```

Note: Replace `<key-id>` with the ID of the KMS key that is scheduled for deletion.

3. Review the output of the command and identify the Grant IDs of the grants that are scheduled for deletion.

4. Run the following command to recover the grants that are scheduled for deletion:

```
aws kms retire-grant --key-id <key-id> --grant-id <grant-id>
```

Note: Replace `<key-id>` with the ID of the KMS key that is scheduled for deletion and `<grant-id>` with the ID of the grant that you want to recover.

5. Repeat steps 4 and 5 for all the grants that are scheduled for deletion.

6. Once you have recovered all the grants that were scheduled for deletion, recheck the status of the KMS key to ensure that the issue has been resolved.

That's it! These steps should help you remediate the KMS Keys Scheduled for Deletion should be Recovered issue in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate this issue in AWS using Python, you can use the AWS SDK for Python (Boto3) to recover the KMS keys that are scheduled for deletion. Here are the steps to do so:

1. Import the required Boto3 libraries:

```python
import boto3
from botocore.exceptions import ClientError
```

2. Create a Boto3 client for the KMS service:

```python
kms_client = boto3.client('kms')
```

3. Use the `list_grants` API to get the list of all KMS keys that are scheduled for deletion:

```python
try:
    response = kms_client.list_grants(Filters=[{'Key': 'GrantState', 'Values': ['PendingDeletion']}])
    grants = response['Grants']
except ClientError as e:
    print(f"Error listing KMS grants: {e}")
    grants = []
```

4. For each grant that is scheduled for deletion, use the `cancel_key_deletion` API to cancel the scheduled deletion:

```python
for grant in grants:
    try:
        response = kms_client.cancel_key_deletion(KeyId=grant['KeyId'])
        print(f"Cancelled deletion for KMS key {grant['KeyId']}")
    except ClientError as e:
        print(f"Error cancelling deletion for KMS key {grant['KeyId']}: {e}")
```

This Python script will cancel the scheduled deletion for all KMS keys that are in the "PendingDeletion" state. You can run this script periodically to ensure that any KMS keys that are scheduled for deletion are recovered.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/deleting-keys.html](https://docs.aws.amazon.com/kms/latest/developerguide/deleting-keys.html) 

