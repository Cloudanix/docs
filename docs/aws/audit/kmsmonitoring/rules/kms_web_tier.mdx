---
slug: kms_web_tier
title: Web-tier KMS Key Should Be In Use
sidebar_label: Web-tier KMS Key Should Be In Use
---

### More Info:

There should be one Amazon KMS Customer Master Key (CMK) created in your AWS account for the web tier in order to protect data that transits your AWS web stack, have full control over data encryption/decryption process, and meet compliance requirements.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the AWS Key Management Service (KMS) console at https://console.aws.amazon.com/kms.

2. In the navigation pane, choose "Customer managed keys". This will display a list of all the keys that are managed by the customer.

3. For each key, check the "Key usage" column. If the key usage is not set to "Encrypt and decrypt", it means the key is not in use.

4. Additionally, you can check the "Last accessed" column. If the date is too old or not available, it indicates that the key might not be in use.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the KMS keys.

2. Once the AWS CLI is installed and configured, you can list all the KMS keys in your account by running the following command:

   ```
   aws kms list-keys
   ```
   This command will return a list of all KMS keys in your account.

3. To check if a specific KMS key is in use, you can use the `list-grants` command. Replace `key-id` with the ID of the key you want to check:

   ```
   aws kms list-grants --key-id <key-id>
   ```
   This command will return a list of all grants for the specified key. If the list is empty, the key is not in use.

4. To check if a KMS key is used by the web-tier, you need to check the resources that are using the key. This can be done by checking the policies of the resources. For example, if the key is used by an S3 bucket, you can check the bucket policy to see if the key is referenced. This can be done using the `get-bucket-policy` command:

   ```
   aws s3api get-bucket-policy --bucket <bucket-name>
   ```
   Replace `<bucket-name>` with the name of your bucket. If the returned policy references the KMS key, it means the key is in use by the web-tier.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) in your environment. This can be done using pip:

   ```bash
   pip install boto3
   ```

2. Import the necessary libraries and initialize the AWS client: In your Python script, you need to import the boto3 library and initialize the AWS client for KMS.

   ```python
   import boto3

   # Create a client
   kms = boto3.client('kms')
   ```

3. List all KMS keys: Use the `list_keys` method to retrieve all KMS keys in your AWS account.

   ```python
   # List all keys
   response = kms.list_keys()

   # Print the keys
   for key in response['Keys']:
       print(key['KeyId'])
   ```

4. Check if the KMS key is in use: To check if a KMS key is in use, you can use the `list_grants` method. This method returns a list of all grants for the specified KMS key.

   ```python
   # Check if the key is in use
   for key in response['Keys']:
       grants = kms.list_grants(KeyId=key['KeyId'])
       if not grants['Grants']:
           print(f"The key {key['KeyId']} is not in use.")
   ```

This script will print all KMS keys that are not in use. If a key is not in use, it means that it's not associated with any AWS resources, and therefore, it's a potential misconfiguration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Web-tier KMS Key Should Be In Use" misconfiguration in AWS using the AWS console, follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the AWS Key Management Service (KMS) dashboard.
3. Click on "Create key" to create a new KMS key. 
4. Choose "Symmetric" as the key type and select "AWS managed" for the key material origin.
5. Enter a name for the key, such as "Web-tier KMS Key".
6. Under "Key usage permissions", grant the appropriate permissions to the IAM roles or users that require access to the key. 
7. Click "Next" to review the key configuration settings, then click "Finish" to create the key.
8. Navigate to the Amazon Elastic Compute Cloud (EC2) dashboard.
9. Select the instance(s) that require the KMS key.
10. In the "Actions" menu, select "Instance Settings" and then "Modify IAM Role".
11. Select the IAM role that requires access to the KMS key, and click "Save".
12. Repeat steps 9-11 for any additional instances that require the KMS key.

By following these steps, you have created a new KMS key and configured the appropriate IAM roles to use it, remediating the "Web-tier KMS Key Should Be In Use" misconfiguration.

#### Using CLI

The "Web-tier KMS Key Should Be In Use" misconfiguration suggests that the web application is not using a KMS key to encrypt data at rest. To remediate this misconfiguration in AWS using AWS CLI, follow these steps:

1. Identify the KMS key that should be used by the web application. You can either create a new KMS key or use an existing KMS key.

2. Use the AWS CLI to update the encryption configuration of the web application to use the KMS key. The command to update the encryption configuration depends on the type of storage used by the web application. For example, if the web application uses an S3 bucket to store data, you can use the following command:

```
aws s3 put-bucket-encryption --bucket <bucket-name> --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"aws:kms","KMSMasterKeyID":"<kms-key-id>"}}]}'
```

Replace `<bucket-name>` with the name of the S3 bucket used by the web application and `<kms-key-id>` with the ID of the KMS key that should be used.

3. Verify that the encryption configuration of the web application has been updated to use the KMS key. You can use the AWS CLI to retrieve the encryption configuration of the S3 bucket using the following command:

```
aws s3 get-bucket-encryption --bucket <bucket-name>
```

Replace `<bucket-name>` with the name of the S3 bucket used by the web application.

4. Test the web application to ensure that it is still functioning correctly after the encryption configuration has been updated.

By following these steps, you can remediate the "Web-tier KMS Key Should Be In Use" misconfiguration in AWS using AWS CLI.

#### Using Python

To remediate the "Web-tier KMS Key Should Be In Use" misconfiguration in AWS using Python, you can follow the below steps:

Step 1: Install the AWS SDK for Python (Boto3) using the following command:

```python
!pip install boto3
```

Step 2: Create a Boto3 client for AWS Key Management Service (KMS) using the following code:

```python
import boto3

kms_client = boto3.client('kms')
```

Step 3: Get the list of all the KMS keys in your AWS account using the following code:

```python
response = kms_client.list_keys()

for key in response['Keys']:
    print(key['KeyId'])
```

Step 4: Identify the KMS key that should be used for the web-tier and store its Key ID in a variable. 

Step 5: Update your web-tier instances to use the identified KMS key. This can be done by updating the instance launch configuration or updating the instance metadata.

For example, if you are using an EC2 instance, you can update its metadata by using the following code:

```python
import requests

metadata_url = 'http://169.254.169.254/latest/user-data'
metadata = requests.get(metadata_url).text

# Update the KMS key ID in the metadata
updated_metadata = metadata.replace('OLD_KMS_KEY_ID', 'NEW_KMS_KEY_ID')

# Save the updated metadata
requests.put(metadata_url, data=updated_metadata)
```

Step 6: Verify that the web-tier instances are now using the correct KMS key by checking the instance metadata or by using the AWS CLI or AWS Management Console.

By following these steps, you can remediate the "Web-tier KMS Key Should Be In Use" misconfiguration in AWS using Python.

### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html](https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html) 


</Tab>
</Tabs>