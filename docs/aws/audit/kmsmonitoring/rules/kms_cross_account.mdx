---
slug: kms_cross_account
title: KMS Keys Should Not Allow Unknown Cross Account Access
sidebar_label: KMS Keys Should Not Allow Unknown Cross Account Access
---

### More Info:

All your AWS Key Management Service keys should be configured to be accessed only by trusted AWS accounts in order to protect against unauthorized cross account access. This will help prevent data breaches and loss.

### Risk Level

High

### Address

Security

### Compliance Standards

AWSWAF



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the AWS Key Management Service (KMS) console at https://console.aws.amazon.com/kms.

2. To use the AWS KMS console, you must sign in as an IAM user, assume an IAM role, or sign in as the root user (not recommended) in your AWS account.

3. In the navigation pane, choose "Customer managed keys". 

4. For each key listed in the console, click on the key to open its details. Under the "Key policy" section, check if there are any statements that allow access from AWS accounts that are not recognized or trusted. If such statements exist, then the KMS key allows unknown cross-account access.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. Make sure you have the necessary permissions to access KMS keys and their policies.

2. List all the KMS keys in your account using the following command:
   ```
   aws kms list-keys --region your-region-name
   ```
   Replace 'your-region-name' with the name of the AWS region where your KMS keys are located. This command will return a list of all KMS keys in the specified region.

3. For each key in the list, retrieve the key policy using the following command:
   ```
   aws kms get-key-policy --key-id your-key-id --policy-name default
   ```
   Replace 'your-key-id' with the ID of each key you want to check. This command will return the default policy of the specified key.

4. Check the returned policy for any statements that allow access to the key from unknown AWS accounts. Specifically, look for statements where the 'Principal' field is not a known AWS account ID or is set to '*'. If such statements exist, the key allows unknown cross account access.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) to interact with AWS services. You can install it using pip:

   ```
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can do this by creating the files ~/.aws/credentials and ~/.aws/config. In the credentials file, add your access key and secret access key:

   ```
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

   In the config file, add your default region:

   ```
   [default]
   region=us-east-1
   ```

3. Write a Python script to list all KMS keys and their policies:

   ```python
   import boto3
   import json

   # Create a client
   kms = boto3.client('kms')

   # List all keys
   response = kms.list_keys()

   for key in response['Keys']:
       # Get the policy of the key
       policy = kms.get_key_policy(KeyId=key['KeyId'], PolicyName='default')
       policy_document = json.loads(policy['Policy'])

       # Check if there are any statements that allow access from unknown accounts
       for statement in policy_document['Statement']:
           if 'AWS' in statement['Principal']:
               principal = statement['Principal']['AWS']
               if principal != 'arn:aws:iam::YOUR_ACCOUNT_ID:root' and principal != '*':
                   print(f"Key {key['KeyId']} allows access from unknown account {principal}")
   ```

4. Run the script: You can run the script using the Python interpreter. The script will print out the IDs of the KMS keys that allow access from unknown accounts:

   ```
   python check_kms_keys.py
   ```

This script checks if there are any KMS keys that allow access from accounts other than the root account of your AWS account. If there are, it prints out the IDs of these keys. Note that this script only checks the default policy of each key. If you have custom policies, you might need to modify the script to check those as well.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the KMS Keys Should Not Allow Unknown Cross Account Access misconfiguration for AWS using the AWS console, follow the below steps:

1. Log in to the AWS Management Console.

2. Go to the AWS Key Management Service (KMS) console.

3. Click on the "Customer managed keys" link located in the left-hand menu.

4. Select the KMS key that is not configured properly.

5. Click on the "Key policy" tab.

6. Click on the "Edit" button.

7. In the "Principal" section, remove any unknown or unauthorized cross-account access.

8. Add the appropriate AWS account IDs or IAM roles that should have access to the KMS key.

9. Click on the "Review policy" button.

10. Review the changes and ensure that they are correct.

11. Click on the "Save changes" button.

12. Verify that the KMS key is now properly configured by testing it with authorized access.

By following these steps, you will have successfully remediated the KMS Keys Should Not Allow Unknown Cross Account Access misconfiguration for AWS using the AWS console.

#### Using CLI

To remediate the misconfiguration "KMS Keys Should Not Allow Unknown Cross Account Access" in AWS using AWS CLI, follow the below steps:

1. Identify the KMS keys that allow unknown cross-account access:
   
   ```
   aws kms list-keys --query "Keys[?KeyManager != 'AWS' && KeyState == 'Enabled']" --output text | awk '{print $1}' | while read key_id; do aws kms get-key-policy --key-id $key_id --policy-name default --query Policy --output text | grep -q "Effect\": \"Allow" && echo $key_id; done
   ```

2. Remove the unknown cross-account access from the KMS key policy:

   ```
   aws kms list-keys --query "Keys[?KeyManager != 'AWS' && KeyState == 'Enabled']" --output text | awk '{print $1}' | while read key_id; do aws kms get-key-policy --key-id $key_id --policy-name default --query Policy --output text | sed '/Effect\": \"Allow\"/,/\"Principal\": {/d' > policy.json && aws kms put-key-policy --key-id $key_id --policy-name default --policy file://policy.json && rm policy.json; done
   ```

3. Verify that the unknown cross-account access has been removed:

   ```
   aws kms list-keys --query "Keys[?KeyManager != 'AWS' && KeyState == 'Enabled']" --output text | awk '{print $1}' | while read key_id; do aws kms get-key-policy --key-id $key_id --policy-name default --query Policy --output text | grep -q "Effect\": \"Allow" && echo $key_id; done
   ```

   If there is no output, then the remediation is successful.

#### Using Python

To remediate the misconfiguration "KMS Keys Should Not Allow Unknown Cross Account Access" for AWS using Python, you can follow these steps:

1. Identify the KMS keys that are allowing unknown cross-account access. You can do this by using the AWS CLI command `aws kms list-keys` to get a list of all the KMS keys and then using the `aws kms describe-key` command to get the key policy for each key.

2. Check the key policy to see if it allows unknown cross-account access. You can do this by looking for the `"AWS"` field in the `Principal` element of the policy. If the `"AWS"` field is set to `"*"` or does not include a specific account ID, then the key allows unknown cross-account access.

3. Modify the key policy to remove the unknown cross-account access. You can do this by using the `aws kms put-key-policy` command to update the key policy. You will need to specify the key ID, the policy name, and the new policy document that removes the `"AWS"` field or replaces it with a specific account ID.

4. Test the modified key policy to ensure that it no longer allows unknown cross-account access. You can do this by using the `aws kms encrypt` command to encrypt a test message using the modified key. If the encryption is successful, then the key policy has been remediated.

Here is an example Python script that can be used to remediate the misconfiguration:

```python
import boto3
import json

# Initialize the KMS client
kms = boto3.client('kms')

# Get a list of all KMS keys
response = kms.list_keys()

# Loop through each key
for key in response['Keys']:
    # Get the key policy
    key_policy = kms.get_key_policy(KeyId=key['KeyId'], PolicyName='default')['Policy']

    # Parse the policy document
    policy_doc = json.loads(key_policy)

    # Check if the policy allows unknown cross-account access
    if 'AWS' in policy_doc['Statement'][0]['Principal'] and \
        ('*' in policy_doc['Statement'][0]['Principal']['AWS'] or \
        len(policy_doc['Statement'][0]['Principal']['AWS']) == 1):
        
        # Modify the policy to remove the unknown cross-account access
        policy_doc['Statement'][0]['Principal']['AWS'] = ['arn:aws:iam::123456789012:root']

        # Update the key policy
        response = kms.put_key_policy(KeyId=key['KeyId'], PolicyName='default', Policy=json.dumps(policy_doc))

        # Print the result
        print('Key policy updated for key ' + key['KeyId'])
``` 

Note: Replace the account ID `123456789012` with your own account ID.

### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying-external-accounts.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying-external-accounts.html) 


</Tab>
</Tabs>