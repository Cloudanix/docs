---
slug: kms_cross_account
title: KMS Keys Should Not Allow Unknown Cross Account Access
sidebar_label: KMS Keys Should Not Allow Unknown Cross Account Access
---

### More Info:

All your AWS Key Management Service keys should be configured to be accessed only by trusted AWS accounts in order to protect against unauthorized cross account access. This will help prevent data breaches and loss.

### Risk Level

High

### Address

Security

### Compliance Standards

AWSWAF


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent KMS Keys from allowing unknown cross-account access in AWS using the AWS Management Console, follow these steps:

1. **Navigate to the KMS Dashboard:**
   - Open the AWS Management Console.
   - In the search bar, type "KMS" and select "Key Management Service" from the results.

2. **Select the Key:**
   - In the KMS dashboard, click on "Customer managed keys" in the left-hand menu.
   - Select the KMS key you want to review or modify.

3. **Review Key Policy:**
   - In the key details page, go to the "Key policy" tab.
   - Review the key policy to ensure that it does not include any unknown or unintended AWS account IDs. The policy should only grant access to trusted accounts and principals.

4. **Modify Key Policy:**
   - If you find any unknown or unintended account IDs, click on the "Edit" button to modify the key policy.
   - Remove or correct any entries that grant access to unknown accounts.
   - Save the changes to update the key policy.

By following these steps, you can ensure that your KMS keys are not inadvertently granting access to unknown or unauthorized AWS accounts.
</Accordion>

<Accordion title='Using CLI'>
To prevent KMS Keys from allowing unknown cross-account access in AWS using the AWS CLI, you can follow these steps:

1. **List KMS Keys**:
   First, identify the KMS keys in your account.
   ```sh
   aws kms list-keys
   ```

2. **Describe Key Policy**:
   For each key, describe the key policy to review the current permissions.
   ```sh
   aws kms get-key-policy --key-id <key-id> --policy-name default
   ```

3. **Update Key Policy**:
   Modify the key policy to restrict access to known accounts only. Create a JSON file (`key-policy.json`) with the updated policy and then apply it.
   ```sh
   aws kms put-key-policy --key-id <key-id> --policy-name default --policy file://key-policy.json
   ```

4. **Verify Key Policy**:
   Ensure the key policy has been updated correctly by describing the key policy again.
   ```sh
   aws kms get-key-policy --key-id <key-id> --policy-name default
   ```

By following these steps, you can prevent KMS keys from allowing unknown cross-account access using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent KMS Keys from allowing unknown cross-account access in AWS KMS using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   Ensure you have the AWS SDK for Python (Boto3) installed. If not, you can install it using pip:
   ```bash
   pip install boto3
   ```

2. **Create a Python Script to Define the KMS Key Policy:**
   Write a Python script that defines a secure key policy, ensuring that only known and trusted AWS accounts have access to the KMS key. Below is an example script:

   ```python
   import boto3
   import json

   # Initialize a session using Amazon KMS
   kms_client = boto3.client('kms')

   # Define the KMS key policy
   key_policy = {
       "Version": "2012-10-17",
       "Id": "key-default-1",
       "Statement": [
           {
               "Sid": "Enable IAM User Permissions",
               "Effect": "Allow",
               "Principal": {
                   "AWS": "arn:aws:iam::YOUR_ACCOUNT_ID:root"
               },
               "Action": "kms:*",
               "Resource": "*"
           },
           {
               "Sid": "Allow access for Key Administrators",
               "Effect": "Allow",
               "Principal": {
                   "AWS": [
                       "arn:aws:iam::YOUR_ACCOUNT_ID:role/KeyAdminRole"
                   ]
               },
               "Action": [
                   "kms:Create*",
                   "kms:Describe*",
                   "kms:Enable*",
                   "kms:List*",
                   "kms:Put*",
                   "kms:Update*",
                   "kms:Revoke*",
                   "kms:Disable*",
                   "kms:Get*",
                   "kms:Delete*",
                   "kms:TagResource",
                   "kms:UntagResource",
                   "kms:ScheduleKeyDeletion",
                   "kms:CancelKeyDeletion"
               ],
               "Resource": "*"
           }
       ]
   }

   # Convert the policy to JSON
   key_policy_json = json.dumps(key_policy)

   # Create a new KMS key with the defined policy
   response = kms_client.create_key(
       Policy=key_policy_json,
       Description='KMS key with restricted cross-account access',
       KeyUsage='ENCRYPT_DECRYPT',
       Origin='AWS_KMS'
   )

   # Print the key ID of the newly created key
   print(f"Created KMS key with ID: {response['KeyMetadata']['KeyId']}")
   ```

3. **Run the Script:**
   Execute the script to create a new KMS key with the specified policy. This policy ensures that only the specified AWS account and roles have access to the key, preventing unknown cross-account access.

4. **Review and Update Existing KMS Keys:**
   For existing KMS keys, you can use a similar approach to update their policies. Here is an example script to update an existing KMS key policy:

   ```python
   import boto3
   import json

   # Initialize a session using Amazon KMS
   kms_client = boto3.client('kms')

   # Define the updated KMS key policy
   updated_key_policy = {
       "Version": "2012-10-17",
       "Id": "key-default-1",
       "Statement": [
           {
               "Sid": "Enable IAM User Permissions",
               "Effect": "Allow",
               "Principal": {
                   "AWS": "arn:aws:iam::YOUR_ACCOUNT_ID:root"
               },
               "Action": "kms:*",
               "Resource": "*"
           },
           {
               "Sid": "Allow access for Key Administrators",
               "Effect": "Allow",
               "Principal": {
                   "AWS": [
                       "arn:aws:iam::YOUR_ACCOUNT_ID:role/KeyAdminRole"
                   ]
               },
               "Action": [
                   "kms:Create*",
                   "kms:Describe*",
                   "kms:Enable*",
                   "kms:List*",
                   "kms:Put*",
                   "kms:Update*",
                   "kms:Revoke*",
                   "kms:Disable*",
                   "kms:Get*",
                   "kms:Delete*",
                   "kms:TagResource",
                   "kms:UntagResource",
                   "kms:ScheduleKeyDeletion",
                   "kms:CancelKeyDeletion"
               ],
               "Resource": "*"
           }
       ]
   }

   # Convert the policy to JSON
   updated_key_policy_json = json.dumps(updated_key_policy)

   # Update the policy of an existing KMS key
   key_id = 'YOUR_EXISTING_KEY_ID'
   response = kms_client.put_key_policy(
       KeyId=key_id,
       PolicyName='default',
       Policy=updated_key_policy_json
   )

   print(f"Updated policy for KMS key with ID: {key_id}")
   ```

By following these steps, you can ensure that your KMS keys do not allow unknown cross-account access, thereby enhancing the security of your AWS environment.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" in the search box and selecting "Key Management Service" from the dropdown list.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand side menu. This will display a list of all the KMS keys that are currently available within your AWS account.
4. For each key listed, click on the key ID to open its details page. In the "Key policy" section, check the "Principal" attribute in the policy statement. If the "Principal" attribute has a value of "*" (which means any AWS account) or an AWS account ID that is not familiar, it means the KMS key allows unknown cross-account access.
</Accordion>

<Accordion title='Using CLI'>
1. **Install and Configure AWS CLI**: Before you start, make sure that AWS CLI is installed and configured on your system. You can install it using pip (Python package installer). The command to install AWS CLI is `pip install awscli`. After installation, configure it using `aws configure` command. You will be asked to provide your AWS credentials, region and output format.

2. **List all KMS Keys**: Use the `list-keys` command to list all the KMS keys in your account. The command is `aws kms list-keys`. This will return a list of all KMS keys along with their KeyId and Arn.

3. **Describe Key Policy**: For each KeyId returned from the previous step, use the `get-key-policy` command to get the policy of the key. The command is `aws kms get-key-policy --key-id <KeyId> --policy-name default`. Replace `<KeyId>` with the actual KeyId. This will return the policy of the key in JSON format.

4. **Check for Unknown Cross Account Access**: Parse the JSON output from the previous step and check the `Statement` array. Each statement represents a permission and contains `Principal` and `Action` fields. If the `Principal` field contains an AWS account ID that you do not recognize or '*' (which represents all AWS accounts), and the `Action` field allows actions that you do not want to allow, then the KMS key allows unknown cross account access.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the 'boto3' library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can set your credentials for use by boto3 in several ways, but a common way is to use the AWS CLI. Run 'aws configure' and then enter your access key, secret access key, and default region when prompted.

3. Write a Python script to list all KMS keys and their policies: Use the 'boto3' library to create a client for AWS Key Management Service (KMS). Then, use the 'list_keys' method to get a list of all KMS keys. For each key, use the 'get_key_policy' method to get the policy of the key. Here is a sample script:

   ```python
   import boto3

   # Create a KMS client
   kms = boto3.client('kms')

   # List all KMS keys
   response = kms.list_keys()

   for key in response['Keys']:
       # Get the policy of the key
       policy = kms.get_key_policy(KeyId=key['KeyId'], PolicyName='default')
       print('Key ID: ', key['KeyId'])
       print('Policy: ', policy['Policy'])
   ```

4. Analyze the policies: The 'get_key_policy' method returns the policy of the key as a JSON string. You need to parse this string and analyze the policy. If the policy allows access from unknown cross accounts, then the KMS key is misconfigured. You can use the 'json' library to parse the JSON string. Here is a sample script:

   ```python
   import json

   # Parse the policy
   policy_dict = json.loads(policy['Policy'])

   # Check if the policy allows access from unknown cross accounts
   for statement in policy_dict['Statement']:
       if 'AWS' in statement['Principal']:
           # If the principal is not a known account, print a warning
           if statement['Principal']['AWS'] not in known_accounts:
               print('Warning: Key ', key['KeyId'], ' allows access from unknown account ', statement['Principal']['AWS'])
   ```
   
Please replace `known_accounts` with a list of your known AWS account IDs.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the KMS Keys Should Not Allow Unknown Cross Account Access misconfiguration for AWS using the AWS console, follow the below steps:

1. Log in to the AWS Management Console.

2. Go to the AWS Key Management Service (KMS) console.

3. Click on the "Customer managed keys" link located in the left-hand menu.

4. Select the KMS key that is not configured properly.

5. Click on the "Key policy" tab.

6. Click on the "Edit" button.

7. In the "Principal" section, remove any unknown or unauthorized cross-account access.

8. Add the appropriate AWS account IDs or IAM roles that should have access to the KMS key.

9. Click on the "Review policy" button.

10. Review the changes and ensure that they are correct.

11. Click on the "Save changes" button.

12. Verify that the KMS key is now properly configured by testing it with authorized access.

By following these steps, you will have successfully remediated the KMS Keys Should Not Allow Unknown Cross Account Access misconfiguration for AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "KMS Keys Should Not Allow Unknown Cross Account Access" in AWS using AWS CLI, follow the below steps:

1. Identify the KMS keys that allow unknown cross-account access:
   
   ```
   aws kms list-keys --query "Keys[?KeyManager != 'AWS' && KeyState == 'Enabled']" --output text | awk '{print $1}' | while read key_id; do aws kms get-key-policy --key-id $key_id --policy-name default --query Policy --output text | grep -q "Effect\": \"Allow" && echo $key_id; done
   ```

2. Remove the unknown cross-account access from the KMS key policy:

   ```
   aws kms list-keys --query "Keys[?KeyManager != 'AWS' && KeyState == 'Enabled']" --output text | awk '{print $1}' | while read key_id; do aws kms get-key-policy --key-id $key_id --policy-name default --query Policy --output text | sed '/Effect\": \"Allow\"/,/\"Principal\": {/d' > policy.json && aws kms put-key-policy --key-id $key_id --policy-name default --policy file://policy.json && rm policy.json; done
   ```

3. Verify that the unknown cross-account access has been removed:

   ```
   aws kms list-keys --query "Keys[?KeyManager != 'AWS' && KeyState == 'Enabled']" --output text | awk '{print $1}' | while read key_id; do aws kms get-key-policy --key-id $key_id --policy-name default --query Policy --output text | grep -q "Effect\": \"Allow" && echo $key_id; done
   ```

   If there is no output, then the remediation is successful.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "KMS Keys Should Not Allow Unknown Cross Account Access" for AWS using Python, you can follow these steps:

1. Identify the KMS keys that are allowing unknown cross-account access. You can do this by using the AWS CLI command `aws kms list-keys` to get a list of all the KMS keys and then using the `aws kms describe-key` command to get the key policy for each key.

2. Check the key policy to see if it allows unknown cross-account access. You can do this by looking for the `"AWS"` field in the `Principal` element of the policy. If the `"AWS"` field is set to `"*"` or does not include a specific account ID, then the key allows unknown cross-account access.

3. Modify the key policy to remove the unknown cross-account access. You can do this by using the `aws kms put-key-policy` command to update the key policy. You will need to specify the key ID, the policy name, and the new policy document that removes the `"AWS"` field or replaces it with a specific account ID.

4. Test the modified key policy to ensure that it no longer allows unknown cross-account access. You can do this by using the `aws kms encrypt` command to encrypt a test message using the modified key. If the encryption is successful, then the key policy has been remediated.

Here is an example Python script that can be used to remediate the misconfiguration:

```python
import boto3
import json

# Initialize the KMS client
kms = boto3.client('kms')

# Get a list of all KMS keys
response = kms.list_keys()

# Loop through each key
for key in response['Keys']:
    # Get the key policy
    key_policy = kms.get_key_policy(KeyId=key['KeyId'], PolicyName='default')['Policy']

    # Parse the policy document
    policy_doc = json.loads(key_policy)

    # Check if the policy allows unknown cross-account access
    if 'AWS' in policy_doc['Statement'][0]['Principal'] and \
        ('*' in policy_doc['Statement'][0]['Principal']['AWS'] or \
        len(policy_doc['Statement'][0]['Principal']['AWS']) == 1):
        
        # Modify the policy to remove the unknown cross-account access
        policy_doc['Statement'][0]['Principal']['AWS'] = ['arn:aws:iam::123456789012:root']

        # Update the key policy
        response = kms.put_key_policy(KeyId=key['KeyId'], PolicyName='default', Policy=json.dumps(policy_doc))

        # Print the result
        print('Key policy updated for key ' + key['KeyId'])
``` 

Note: Replace the account ID `123456789012` with your own account ID.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying-external-accounts.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying-external-accounts.html) 

