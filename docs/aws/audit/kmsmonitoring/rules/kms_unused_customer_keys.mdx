---
slug: kms_unused_customer_keys
title: Unused Customer Master Key Should Be Removed
sidebar_label: Unused Customer Master Key Should Be Removed
---

### More Info:

Any disabled KMS Customer Master Keys in your AWS account should be removed in order to lower the cost of your monthly AWS bill.

### Risk Level

Medium

### Address

Operational Maturity, Cost optimization, Security

### Compliance Standards

NIST


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent unused Customer Master Keys (CMKs) in AWS Key Management Service (KMS) using the AWS Management Console, follow these steps:

1. **Access the KMS Dashboard:**
   - Sign in to the AWS Management Console.
   - Navigate to the KMS service by typing "KMS" in the search bar and selecting "Key Management Service" from the results.

2. **Identify Unused Keys:**
   - In the KMS dashboard, click on "Customer managed keys" in the left-hand menu.
   - Review the list of keys and look for keys that have not been used recently. You can check the "Last used" column to identify keys that have not been used for a significant period.

3. **Enable Key Rotation:**
   - For keys that are still needed but not frequently used, consider enabling automatic key rotation to ensure they remain secure.
   - Select the key, click on the "Key actions" dropdown, and choose "Enable key rotation."

4. **Tagging and Documentation:**
   - Tag your keys with relevant information such as the purpose, owner, and creation date to keep track of their usage and lifecycle.
   - Select the key, go to the "Tags" tab, and add appropriate tags.

By following these steps, you can effectively manage and monitor your CMKs, ensuring that unused keys are identified and either repurposed or scheduled for deletion.
</Accordion>

<Accordion title='Using CLI'>
To prevent unused Customer Master Keys (CMKs) in AWS Key Management Service (KMS) using AWS CLI, you can follow these steps:

1. **List All CMKs:**
   First, list all the CMKs in your account to identify which ones are currently in use and which ones are not.
   ```sh
   aws kms list-keys
   ```

2. **Describe Key Usage:**
   For each CMK, describe the key to get detailed information, including its usage status.
   ```sh
   aws kms describe-key --key-id <key-id>
   ```

3. **Enable Key Rotation:**
   Enable automatic key rotation for CMKs that are in use to ensure they are regularly updated and secure.
   ```sh
   aws kms enable-key-rotation --key-id <key-id>
   ```

4. **Tagging Keys:**
   Tag your CMKs with metadata to indicate their purpose and usage status. This helps in identifying and managing keys more effectively.
   ```sh
   aws kms tag-resource --key-id <key-id> --tags TagKey=Usage,TagValue=Active
   ```

By following these steps, you can better manage your CMKs and ensure that unused keys are identified and can be removed if necessary.
</Accordion>

<Accordion title='Using Python'>
To prevent unused Customer Master Keys (CMKs) in AWS Key Management Service (KMS) using Python scripts, you can follow these steps:

1. **List All CMKs**:
   Use the AWS SDK for Python (Boto3) to list all the CMKs in your account. This will help you identify which keys are currently available.

   ```python
   import boto3

   kms_client = boto3.client('kms')

   def list_all_keys():
       keys = []
       response = kms_client.list_keys()
       keys.extend(response['Keys'])

       while 'NextMarker' in response:
           response = kms_client.list_keys(Marker=response['NextMarker'])
           keys.extend(response['Keys'])

       return keys

   all_keys = list_all_keys()
   print("All CMKs:", all_keys)
   ```

2. **Get Key Usage Information**:
   For each key, get detailed information to determine if it is being used. You can check the key's metadata, including its creation date and last usage date.

   ```python
   def get_key_usage(key_id):
       response = kms_client.describe_key(KeyId=key_id)
       key_metadata = response['KeyMetadata']
       return key_metadata

   for key in all_keys:
       key_id = key['KeyId']
       key_metadata = get_key_usage(key_id)
       print(f"Key ID: {key_id}, Last Used Date: {key_metadata.get('LastUsedDate')}")
   ```

3. **Identify Unused Keys**:
   Compare the last usage date with a threshold (e.g., 90 days) to identify keys that have not been used recently.

   ```python
   from datetime import datetime, timedelta

   def is_key_unused(key_metadata, days_threshold=90):
       last_used_date = key_metadata.get('LastUsedDate')
       if not last_used_date:
           return True  # Key has never been used
       threshold_date = datetime.now() - timedelta(days=days_threshold)
       return last_used_date < threshold_date

   unused_keys = []
   for key in all_keys:
       key_id = key['KeyId']
       key_metadata = get_key_usage(key_id)
       if is_key_unused(key_metadata):
           unused_keys.append(key_id)

   print("Unused CMKs:", unused_keys)
   ```

4. **Automate Key Deletion**:
   Optionally, you can automate the deletion of these unused keys. Note that deleting keys is a sensitive operation and should be done with caution. Ensure you have backups and necessary approvals before proceeding.

   ```python
   def schedule_key_deletion(key_id, pending_window_in_days=30):
       response = kms_client.schedule_key_deletion(
           KeyId=key_id,
           PendingWindowInDays=pending_window_in_days
       )
       return response

   for key_id in unused_keys:
       response = schedule_key_deletion(key_id)
       print(f"Scheduled deletion for key {key_id}: {response}")
   ```

By following these steps, you can effectively identify and manage unused CMKs in AWS KMS using Python scripts. This helps in maintaining a clean and secure key management environment.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the Key Management Service (KMS) dashboard by selecting "Services" from the top menu, then typing "KMS" into the search bar and selecting "Key Management Service" from the dropdown menu.
3. In the KMS dashboard, select "Customer managed keys" from the left-hand menu. This will display a list of all customer master keys (CMKs) in your account.
4. For each CMK, check the "Last accessed" column. If a key has not been accessed for a long period of time, it may be unused and could potentially be removed.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access KMS.

2. Once AWS CLI is installed and configured, you can list all the keys in your account by running the following command:

   ```
   aws kms list-keys
   ```

   This command will return a list of all the keys in your account, including their key IDs and ARNs.

3. To check if a key is used or not, you can use the `list-key-policies` command. This command will return a list of all the policies attached to a key. If a key has no policies attached to it, it means it's not used. Here is the command:

   ```
   aws kms list-key-policies --key-id <your-key-id>
   ```

   Replace `<your-key-id>` with the ID of the key you want to check.

4. If the `list-key-policies` command returns an empty list, it means the key is not used. However, to be sure, you can also check the key's rotation status. If the key is not rotated, it's another indication that it's not used. Here is the command to check the rotation status:

   ```
   aws kms get-key-rotation-status --key-id <your-key-id>
   ```

   Replace `<your-key-id>` with the ID of the key you want to check. If the command returns `false`, it means the key is not rotated and likely not used.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the 'boto3' library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can set your credentials for use by boto3 in several ways: through the AWS CLI, AWS IAM roles, or the AWS credentials file (`~/.aws/credentials`). 

3. Write a Python script to list all the keys and their usage: You can use the 'list_keys' method provided by the 'boto3' library to list all the keys. Then, use the 'get_key_rotation_status' and 'list_key_policies' methods to check if the key is being used or not. Here is a sample script:

   ```python
   import boto3

   # Create a client
   kms = boto3.client('kms')

   # List all keys
   response = kms.list_keys()

   # For each key, check its usage
   for key in response['Keys']:
       key_id = key['KeyId']
       rotation_status = kms.get_key_rotation_status(KeyId=key_id)
       key_policies = kms.list_key_policies(KeyId=key_id)

       # If the key is not being used, print it
       if not rotation_status['KeyRotationEnabled'] and not key_policies['PolicyNames']:
           print(f"Unused key detected: {key_id}")
   ```

4. Run the Python script: Finally, run the Python script. It will print out the IDs of all unused keys. If no unused keys are detected, it will not print anything. This way, you can easily detect any unused Customer Master Keys in AWS KMS.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step-by-step instructions to remediate the issue of an unused Customer Master Key in AWS:

1. Log in to the AWS Management Console.
2. Go to the AWS Key Management Service (KMS) console.
3. In the left navigation pane, select "Customer managed keys."
4. Find the Customer Master Key (CMK) that is not being used and select it.
5. In the "Key state" section, check if the key is enabled or disabled. If the key is enabled, disable it by selecting "Disable key" from the "Actions" dropdown menu.
6. Once the key is disabled, select "Schedule key deletion" from the "Actions" dropdown menu.
7. In the "Schedule key deletion" dialog box, specify the number of days for which you want to retain the key before it is deleted permanently. You can select a minimum of 7 days and a maximum of 30 days.
8. Click on the "Schedule key deletion" button to schedule the deletion of the key.

By following these steps, you can remediate the issue of an unused Customer Master Key in AWS and ensure that your cloud environment is secure.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of an unused customer master key in AWS using AWS CLI, you can follow these steps:

1. Open your AWS CLI and run the following command to list all the Customer Master Keys (CMKs) in your account:

   ```
   aws kms list-keys
   ```

   This command will return a list of all the CMKs in your account.

2. Identify the unused CMK that you want to remove and make sure that it is not being used by any resources or services in your account.

3. Run the following command to disable the CMK:

   ```
   aws kms disable-key --key-id <key-id>
   ```

   Replace `<key-id>` with the ID of the CMK that you want to disable.

4. After disabling the CMK, run the following command to schedule the deletion of the CMK:

   ```
   aws kms schedule-key-deletion --key-id <key-id> --pending-window-in-days 7
   ```

   Replace `<key-id>` with the ID of the CMK that you want to delete and `--pending-window-in-days` with the number of days (between 7 and 30) that you want to wait before the CMK is permanently deleted.

5. Verify that the CMK has been scheduled for deletion by running the following command:

   ```
   aws kms list-scheduled-key-deletions
   ```

   This command will return a list of all the CMKs that are scheduled for deletion.

6. Once the scheduled deletion time has passed, the CMK will be permanently deleted from your account.

Note: Before deleting any CMK, it is important to ensure that it is not being used by any resources or services in your account. Deleting a CMK that is being used can cause data loss or service disruption.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "Unused Customer Master Key Should Be Removed" in AWS using Python, you can follow the below steps:

1. Import the necessary AWS SDKs and modules in Python.
2. Use the AWS Key Management Service (KMS) API to list all the customer master keys (CMKs) in your AWS account.
3. For each CMK, check if it is in use by any AWS resource or service. If not, delete the CMK.
4. To delete a CMK, use the `boto3` Python module to call the `kms.delete_key()` method and pass the CMK ID as a parameter.

Here is a sample Python code that can help you remediate the misconfiguration:

```python
import boto3

# Create a KMS client
kms = boto3.client('kms')

# List all the customer master keys (CMKs)
response = kms.list_keys()

# For each CMK, check if it is in use by any AWS resource or service
for key in response['Keys']:
    key_id = key['KeyId']
    key_metadata = kms.describe_key(KeyId=key_id)

    if not key_metadata['KeyMetadata']['Enabled']:
        # If the CMK is disabled, delete it
        print(f"Deleting disabled CMK {key_id}...")
        kms.schedule_key_deletion(KeyId=key_id)
    elif not key_metadata['KeyMetadata']['KeyUsage']:
        # If the CMK is not in use, delete it
        print(f"Deleting unused CMK {key_id}...")
        kms.schedule_key_deletion(KeyId=key_id)
    else:
        print(f"Skipping CMK {key_id}: in use by {key_metadata['KeyMetadata']['KeyUsage']}")

print("CMK remediation completed.")
```

Note: Before running the code, make sure you have the necessary AWS credentials and permissions to access the KMS API. Also, make sure to test the code in a non-production environment before implementing it in a production environment.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/deleting-keys.html](https://docs.aws.amazon.com/kms/latest/developerguide/deleting-keys.html) 

