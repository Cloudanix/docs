---
slug: kms_key_exposed
title: KMS Keys Should Not Be Exposed
sidebar_label: KMS Keys Should Not Be Exposed
---

### More Info:

Any publicly accessible AWS Key Management Service master keys should be identified and their access policy should be updated in order to stop any unsigned requests made to these resources.

### Risk Level

High

### Address

Security

### Compliance Standards

AWSWAF, PCIDSS, GDPR


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent KMS keys from being exposed in AWS Key Management Service (KMS) using the AWS Management Console, follow these steps:

1. **Restrict Key Policies:**
   - Navigate to the AWS KMS console.
   - Select the KMS key you want to manage.
   - Go to the "Key Policy" tab.
   - Edit the key policy to ensure that only authorized IAM users and roles have access to the key. Remove any overly permissive policies that grant access to all users or roles.

2. **Enable Key Rotation:**
   - In the AWS KMS console, select the KMS key.
   - Go to the "Key Rotation" tab.
   - Enable automatic key rotation to ensure that the key is rotated every year, reducing the risk of long-term exposure.

3. **Audit Key Usage:**
   - Use AWS CloudTrail to monitor and log all usage of your KMS keys.
   - Navigate to the CloudTrail console and ensure that logging is enabled for KMS API calls.
   - Regularly review the CloudTrail logs to detect any unauthorized or unusual access patterns.

4. **Set Up Alerts:**
   - Use AWS CloudWatch to set up alarms for any unauthorized access attempts or changes to key policies.
   - Navigate to the CloudWatch console.
   - Create a new alarm based on CloudTrail logs that capture KMS-related events.
   - Configure the alarm to notify you via email or SMS when suspicious activity is detected.

By following these steps, you can significantly reduce the risk of your KMS keys being exposed in AWS.
</Accordion>

<Accordion title='Using CLI'>
To prevent KMS keys from being exposed in AWS using the AWS CLI, you can follow these steps:

1. **Create a Key Policy with Least Privilege:**
   Ensure that the key policy grants the minimum necessary permissions to users and roles. Use the `aws kms create-key` command to create a new key with a restrictive policy.

   ```sh
   aws kms create-key --policy file://key-policy.json
   ```

   The `key-policy.json` should define the least privilege access.

2. **Restrict IAM Policies:**
   Ensure that IAM policies do not grant broad permissions to KMS keys. Use the `aws iam put-role-policy` or `aws iam put-user-policy` commands to attach restrictive policies to roles or users.

   ```sh
   aws iam put-role-policy --role-name MyRole --policy-name RestrictiveKMSPolicy --policy-document file://restrictive-iam-policy.json
   ```

3. **Enable Key Rotation:**
   Enable automatic key rotation to enhance security. Use the `aws kms enable-key-rotation` command.

   ```sh
   aws kms enable-key-rotation --key-id <your-key-id>
   ```

4. **Audit Key Usage:**
   Regularly audit the usage of your KMS keys to ensure they are not being misused. Use the `aws kms get-key-rotation-status` and `aws kms describe-key` commands to review key configurations.

   ```sh
   aws kms get-key-rotation-status --key-id <your-key-id>
   aws kms describe-key --key-id <your-key-id>
   ```

By following these steps, you can help ensure that your KMS keys are not exposed and are managed securely.
</Accordion>

<Accordion title='Using Python'>
To prevent KMS keys from being exposed in AWS, Azure, and GCP using Python scripts, you can follow these steps:

### AWS (Amazon Web Services)

1. **Set Up AWS SDK for Python (Boto3):**
   Install the Boto3 library if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Create a Python Script to Manage KMS Key Policies:**
   ```python
   import boto3

   # Initialize a session using Amazon KMS
   kms_client = boto3.client('kms')

   # Define the KMS Key ID
   key_id = 'your-kms-key-id'

   # Define a secure key policy
   key_policy = {
       "Version": "2012-10-17",
       "Id": "key-default-1",
       "Statement": [
           {
               "Sid": "Enable IAM User Permissions",
               "Effect": "Allow",
               "Principal": {
                   "AWS": "arn:aws:iam::account-id:root"
               },
               "Action": "kms:*",
               "Resource": "*"
           },
           {
               "Sid": "Allow access for Key Administrators",
               "Effect": "Allow",
               "Principal": {
                   "AWS": [
                       "arn:aws:iam::account-id:role/KeyAdminRole"
                   ]
               },
               "Action": [
                   "kms:Create*",
                   "kms:Describe*",
                   "kms:Enable*",
                   "kms:List*",
                   "kms:Put*",
                   "kms:Update*",
                   "kms:Revoke*",
                   "kms:Disable*",
                   "kms:Get*",
                   "kms:Delete*",
                   "kms:TagResource",
                   "kms:UntagResource",
                   "kms:ScheduleKeyDeletion",
                   "kms:CancelKeyDeletion"
               ],
               "Resource": "*"
           }
       ]
   }

   # Apply the key policy
   response = kms_client.put_key_policy(
       KeyId=key_id,
       PolicyName='default',
       Policy=json.dumps(key_policy)
   )

   print(response)
   ```

### Azure (Microsoft Azure)

1. **Set Up Azure SDK for Python:**
   Install the Azure Key Vault library if you haven't already:
   ```bash
   pip install azure-keyvault
   ```

2. **Create a Python Script to Manage Key Vault Access Policies:**
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.keyvault.keys import KeyClient
   from azure.keyvault.keys.models import KeyVaultKey, KeyType

   # Initialize a KeyClient
   credential = DefaultAzureCredential()
   key_client = KeyClient(vault_url="https://your-key-vault-name.vault.azure.net/", credential=credential)

   # Define the key name
   key_name = "your-key-name"

   # Create a key if it doesn't exist
   key = key_client.create_key(key_name, KeyType.rsa)

   # Define a secure access policy
   access_policy = {
       "tenant_id": "your-tenant-id",
       "object_id": "your-object-id",
       "permissions": {
           "keys": ["get", "list", "create", "update", "import", "delete", "backup", "restore", "recover", "purge"]
       }
   }

   # Apply the access policy
   key_client.set_key_access_policy(key_name, access_policy)

   print(f"Access policy set for key: {key_name}")
   ```

### GCP (Google Cloud Platform)

1. **Set Up Google Cloud SDK for Python:**
   Install the Google Cloud KMS library if you haven't already:
   ```bash
   pip install google-cloud-kms
   ```

2. **Create a Python Script to Manage KMS IAM Policies:**
   ```python
   from google.cloud import kms
   from google.iam.v1 import policy_pb2, iam_policy_pb2

   # Initialize a KMS client
   client = kms.KeyManagementServiceClient()

   # Define the key name
   key_name = client.crypto_key_path('your-project-id', 'your-location', 'your-key-ring', 'your-key-name')

   # Define a secure IAM policy
   policy = policy_pb2.Policy(
       bindings=[
           {
               "role": "roles/cloudkms.cryptoKeyEncrypterDecrypter",
               "members": [
                   "serviceAccount:your-service-account@your-project-id.iam.gserviceaccount.com"
               ]
           }
       ]
   )

   # Apply the IAM policy
   request = iam_policy_pb2.SetIamPolicyRequest(
       resource=key_name,
       policy=policy
   )
   response = client.set_iam_policy(request=request)

   print(f"IAM policy set for key: {key_name}")
   ```

These scripts ensure that only authorized users and roles have access to your KMS keys, thereby preventing exposure.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the AWS Key Management Service (KMS) console at https://console.aws.amazon.com/kms.

2. In the navigation pane, choose "Customer managed keys". This will display a list of all your customer managed keys.

3. For each key, click on the key ID to open its details page. 

4. In the Key policy section, check if the "Effect" is set to "Allow" and "Principal" is set to "*". If it is, then the KMS key is exposed.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all KMS keys: Use the `list-keys` command to get a list of all KMS keys in your account. The command is as follows:
   ```
   aws kms list-keys
   ```
   This command will return a list of all KMS keys along with their key IDs.

3. Describe key policy: For each key ID returned in the previous step, use the `get-key-policy` command to get the policy of the key. The command is as follows:
   ```
   aws kms get-key-policy --key-id <key-id> --policy-name default
   ```
   Replace `<key-id>` with the actual key ID. This command will return the policy of the key in JSON format.

4. Check the policy: Inspect the returned policy for any statements that allow the `*` (all) action or have the `Principal` set to `*` (all). If such statements exist, it means the KMS key is exposed.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you can start writing the script, you need to install the necessary Python libraries. For AWS, you will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary libraries and initialize the client: After installing the necessary libraries, you need to import them into your script and initialize the AWS client.

```python
import boto3

# Create a client
client = boto3.client('kms')
```

3. List all KMS keys: You can use the `list_keys` function to get a list of all KMS keys in your AWS account.

```python
# List all KMS keys
response = client.list_keys()

# Print the list of keys
for key in response['Keys']:
    print(key['KeyId'])
```

4. Check the key policy: For each key, you can use the `get_key_policy` function to get the policy of the key. If the policy allows the key to be used by any AWS account or an anonymous user, then the key is exposed.

```python
# Check the key policy
for key in response['Keys']:
    policy = client.get_key_policy(KeyId=key['KeyId'], PolicyName='default')
    if 'AWS: *' in policy['Policy'] or 'AWS: anonymous' in policy['Policy']:
        print(f"Key {key['KeyId']} is exposed")
```

This script will print the IDs of all exposed KMS keys.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
Sure, here are the step by step instructions to remediate this misconfiguration in AWS using the AWS console:

1. Log in to the AWS Management Console.
2. Go to the AWS KMS console.
3. Click on the "Aliases" tab.
4. Select the KMS key that is exposed.
5. Click on the "Key Policy" button.
6. Review the Key Policy to ensure that it is not exposing the KMS key.
7. If the Key Policy is exposing the KMS key, click on the "Edit" button.
8. Update the Key Policy to remove any permissions that expose the KMS key.
9. Click on the "Review and Save" button.
10. Review the changes made to the Key Policy.
11. Click on the "Save Changes" button to save the updated Key Policy.

Once you have completed these steps, the KMS key will no longer be exposed and the misconfiguration will be remediated.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the issue of KMS Keys being exposed in AWS, you can follow the below steps using AWS CLI:

1. List all the KMS keys in your AWS account by running the following command:
```
aws kms list-keys
```

2. Identify the KMS key(s) that are exposed and note down their Key IDs.

3. Remove the Key Policy from the KMS key(s) by running the following command:
```
aws kms put-key-policy --key-id <key-id> --policy-name default --policy "{}"
```
Replace `<key-id>` with the Key ID of the KMS key that you want to remediate.

4. Verify that the Key Policy has been removed by running the following command:
```
aws kms get-key-policy --key-id <key-id> --policy-name default
```
Replace `<key-id>` with the Key ID of the KMS key that you remediated. This command should return an empty policy.

5. Repeat steps 3 and 4 for all the exposed KMS keys in your AWS account.

By following the above steps, you can remediate the issue of KMS Keys being exposed in AWS.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of KMS Keys being exposed in AWS using Python, you can follow the below steps:

Step 1: Identify the KMS keys that are exposed.

You can use the AWS CLI command `aws kms list-keys` to list all the KMS keys in your AWS account. Then, you can use the `aws kms describe-key` command to get the details of each key and check if any of them are exposed.

Step 2: Revoke the key policy that is exposing the KMS key.

You can use the `aws kms put-key-policy` command to revoke the key policy that is exposing the KMS key. Here's an example of how you can do it:

```python
import boto3

# Create a KMS client
kms = boto3.client('kms')

# Specify the key ID and the policy name
key_id = 'your_key_id'
policy_name = 'your_policy_name'

# Get the current key policy
key_policy = kms.get_key_policy(KeyId=key_id, PolicyName=policy_name)

# Revoke the key policy
key_policy['Policy'] = '{"Statement": []}'
kms.put_key_policy(KeyId=key_id, PolicyName=policy_name, Policy=json.dumps(key_policy['Policy']))
```

Step 3: Monitor the KMS keys to ensure they are not exposed again.

You can set up CloudWatch alarms to monitor the KMS keys and get notified if any of them are exposed again. You can also use AWS Config to monitor the KMS keys and get notified if any of the key policies are changed.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/kms/latest/developerguide/determining-access.html](https://docs.aws.amazon.com/kms/latest/developerguide/determining-access.html) 

