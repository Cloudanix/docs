---
slug: check_cross_account_access
title: Lambda Functions Should Not Allow Cross Account Access
sidebar_label: Lambda Functions Should Not Allow Cross Account Access
---

### More Info:

Your Amazon Lambda functions should be configured to allow access only to trusted AWS accounts in order to protect against unauthorized cross account access.

### Risk Level

Medium

### Address

Security

### Compliance Standards

HITRUST, SOC2, NISTCSF, PCIDSS


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent Lambda functions from allowing cross-account access using the AWS Management Console, follow these steps:

1. **Navigate to the Lambda Console:**
   - Open the AWS Management Console.
   - In the Services menu, select "Lambda" to go to the Lambda dashboard.

2. **Select the Lambda Function:**
   - In the Lambda dashboard, find and select the specific Lambda function you want to configure.

3. **Review and Edit Resource-Based Policy:**
   - In the Lambda function's configuration page, go to the "Permissions" tab.
   - Under the "Resource-based policy" section, review the existing policy statements.
   - Ensure that there are no policy statements that grant permissions to accounts other than your own. If there are, edit or remove those statements to restrict access.

4. **Use IAM Roles for Cross-Account Access:**
   - If cross-account access is necessary, use IAM roles with specific trust policies instead of directly granting permissions in the Lambda resource-based policy.
   - Create an IAM role in the target account and specify the trusted entities (the AWS account or specific IAM roles) that can assume the role.
   - Update the Lambda function to assume this IAM role when necessary, ensuring that the role has the least privilege required for the function to operate.

By following these steps, you can ensure that your Lambda functions do not inadvertently allow cross-account access, thereby enhancing the security of your AWS environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent Lambda functions from allowing cross-account access using the AWS CLI, you can follow these steps:

1. **Check Existing Lambda Function Policies:**
   First, you need to list the existing resource-based policies attached to your Lambda function to identify any cross-account permissions.

   ```sh
   aws lambda get-policy --function-name <your-lambda-function-name>
   ```

2. **Remove Cross-Account Permissions:**
   If you find any cross-account permissions, you should remove them. Use the `remove-permission` command to delete specific permissions.

   ```sh
   aws lambda remove-permission --function-name <your-lambda-function-name> --statement-id <statement-id>
   ```

3. **Update Lambda Function Policy:**
   Ensure that the Lambda function policy only allows access from trusted accounts or roles. You can use the `add-permission` command to add specific permissions.

   ```sh
   aws lambda add-permission --function-name <your-lambda-function-name> --principal <trusted-account-id> --statement-id <statement-id> --action "lambda:InvokeFunction"
   ```

4. **Review and Validate Permissions:**
   After making changes, review the updated policy to ensure that no unintended cross-account access is allowed.

   ```sh
   aws lambda get-policy --function-name <your-lambda-function-name>
   ```

By following these steps, you can prevent cross-account access to your Lambda functions using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent Lambda functions from allowing cross-account access using Python scripts, you can follow these steps:

1. **Set Up AWS SDK for Python (Boto3):**
   Ensure you have Boto3 installed and configured with the necessary permissions to manage Lambda functions.

   ```bash
   pip install boto3
   ```

2. **Create a Python Script to List Lambda Functions:**
   Use Boto3 to list all Lambda functions in your account.

   ```python
   import boto3

   def list_lambda_functions():
       client = boto3.client('lambda')
       response = client.list_functions()
       return response['Functions']

   functions = list_lambda_functions()
   for function in functions:
       print(function['FunctionName'])
   ```

3. **Check and Update Lambda Function Policies:**
   Iterate through each Lambda function and check its resource-based policy for cross-account access. If found, remove or update the policy to restrict access.

   ```python
   def get_function_policy(function_name):
       client = boto3.client('lambda')
       try:
           response = client.get_policy(FunctionName=function_name)
           return response['Policy']
       except client.exceptions.ResourceNotFoundException:
           return None

   def remove_cross_account_access(function_name):
       client = boto3.client('lambda')
       policy = get_function_policy(function_name)
       if policy:
           statements = json.loads(policy)['Statement']
           for statement in statements:
               if 'AWS' in statement['Principal'] and statement['Principal']['AWS'] != 'arn:aws:iam::YOUR_ACCOUNT_ID:root':
                   client.remove_permission(FunctionName=function_name, StatementId=statement['Sid'])

   for function in functions:
       remove_cross_account_access(function['FunctionName'])
   ```

4. **Automate the Script Execution:**
   Schedule the script to run periodically using a cron job or AWS Lambda itself to ensure continuous compliance.

   ```python
   import json
   import boto3

   def lambda_handler(event, context):
       functions = list_lambda_functions()
       for function in functions:
           remove_cross_account_access(function['FunctionName'])

   # If running as a standalone script
   if __name__ == "__main__":
       functions = list_lambda_functions()
       for function in functions:
           remove_cross_account_access(function['FunctionName'])
   ```

By following these steps, you can ensure that your Lambda functions do not allow cross-account access, thereby enhancing the security of your AWS environment.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the AWS Lambda service by typing 'Lambda' into the search bar and selecting 'Lambda' from the dropdown menu.
3. In the AWS Lambda console, select the 'Functions' option from the left-hand navigation pane. This will display a list of all the Lambda functions in your account.
4. For each Lambda function, select the function to view its details. Under the 'Permissions' tab, check the 'Resource-based policy' section. If there are any statements with "Principal": "*" (which allows cross-account access) or `"Principal": {"AWS": "arn:aws:iam::<account-id>:root"}` (which allows access from a specific AWS account), then the Lambda function is misconfigured to allow cross-account access.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all the Lambda functions in your AWS account. You can do this by using the AWS CLI command `aws lambda list-functions`. This command will return a list of all the Lambda functions in your AWS account.

2. For each Lambda function, you need to get the resource policy. You can do this by using the AWS CLI command `aws lambda get-policy --function-name <function-name>`. Replace `<function-name>` with the name of your Lambda function. This command will return the resource policy of the Lambda function.

3. Once you have the resource policy, you need to check if there are any statements that allow cross-account access. You can do this by looking for any statements where the `Principal` field is not equal to your AWS account ID or `*`.

4. If you find any such statements, then the Lambda function allows cross-account access. If you don't find any such statements, then the Lambda function does not allow cross-account access. 

Note: You can automate these steps by writing a Python script that uses the AWS SDK (boto3) to interact with the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary AWS SDK for Python (Boto3) modules in your Python script. You will need the 'boto3' module to interact with AWS services and the 'json' module to parse the AWS Lambda function policy.

```python
import boto3
import json
```

2. Create a session using your AWS credentials. Replace 'aws_access_key_id', 'aws_secret_access_key', and 'aws_session_token' with your actual AWS credentials.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    aws_session_token='SESSION_TOKEN',
)
```

3. Create a client for AWS Lambda.

```python
lambda_client = session.client('lambda')
```

4. List all the Lambda functions in your account and retrieve their policies. Check if the 'Principal' in the policy is set to '*' or contains an AWS account ID that is not yours. If it does, then the Lambda function allows cross-account access.

```python
functions = lambda_client.list_functions()
for function in functions['Functions']:
    policy = lambda_client.get_policy(FunctionName=function['FunctionName'])
    policy_doc = json.loads(policy['Policy'])
    for statement in policy_doc['Statement']:
        if statement['Principal'] == '*' or statement['Principal'] != 'YOUR_AWS_ACCOUNT_ID':
            print(f"Lambda function {function['FunctionName']} allows cross-account access.")
```

This script will print the names of all Lambda functions in your AWS account that allow cross-account access. Replace 'YOUR_AWS_ACCOUNT_ID' with your actual AWS account ID.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "Lambda Functions Should Not Allow Cross Account Access" in AWS using the AWS console, follow these steps:

1. Sign in to the AWS Management Console.
2. Open the AWS Lambda console.
3. In the left navigation pane, choose "Functions".
4. Select the Lambda function that you want to remediate.
5. Choose the "Permissions" tab.
6. Scroll down to the "Resource-based policy" section.
7. Click the "Edit" button.
8. In the "Policy" editor, remove any statements that allow cross-account access.
9. Click the "Save" button to save the updated policy.
10. Verify that the updated policy does not allow cross-account access.

By following these steps, you have successfully remediated the misconfiguration "Lambda Functions Should Not Allow Cross Account Access" in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration in AWS, you can follow the below steps:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to list all the Lambda functions in your AWS account:

   ```
   aws lambda list-functions
   ```

3. Identify the Lambda function that is allowing cross-account access.

4. Run the following command to update the Lambda function's resource-based policy to deny cross-account access:

   ```
   aws lambda remove-permission --function-name <function-name> --statement-id <statement-id>
   ```

   Replace `<function-name>` with the name of the Lambda function that is allowing cross-account access, and `<statement-id>` with the ID of the statement that allows cross-account access.

   For example:

   ```
   aws lambda remove-permission --function-name my-function --statement-id AllowCrossAccountAccess
   ```

5. Verify that the resource-based policy has been updated by running the following command:

   ```
   aws lambda get-policy --function-name <function-name>
   ```

   Replace `<function-name>` with the name of the Lambda function that you updated.

   The output should show that the resource-based policy now denies cross-account access.

6. Repeat steps 4-5 for any other Lambda functions that are allowing cross-account access.

7. Once you have updated all the Lambda functions, verify that cross-account access is no longer allowed by attempting to access the Lambda function from a different AWS account.

By following these steps, you can remediate the misconfiguration and ensure that Lambda functions do not allow cross-account access in AWS.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of Lambda functions allowing cross-account access in AWS, you can follow these steps using Python:

1. Open the AWS Lambda console.
2. Click on the Lambda function that is allowing cross-account access.
3. Under the "Configuration" tab, click on "Permissions".
4. Click on the "Remove" button next to the role that is allowing cross-account access.
5. Click on the "Add Permission" button.
6. Select the "AWS Service" radio button.
7. Choose the service that needs access to the Lambda function.
8. Choose the "Use a permission policy" option.
9. In the policy editor, add the following policy:

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Principal": {
        "AWS": "*"
      },
      "Action": "lambda:*",
      "Resource": "arn:aws:lambda:<region>:<account-id>:function:<function-name>",
      "Condition": {
        "ArnNotEquals": {
          "aws:SourceArn": "arn:aws:logs:<region>:<account-id>:log-group:/aws/lambda/<function-name>:*"
        }
      }
    }
  ]
}
```

Replace `<region>`, `<account-id>`, and `<function-name>` with the appropriate values for your Lambda function.

10. Click on the "Add" button to save the new permission policy.

This policy will deny access to the Lambda function from any AWS account except for the specified service, and only if the request originates from the specified log group.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/lambda/latest/dg/access-control-identity-based.html](https://docs.aws.amazon.com/lambda/latest/dg/access-control-identity-based.html) 

