---
slug: dlq_configured
title: AWS Lambda Should Have DLQ Configured
sidebar_label: AWS Lambda Should Have DLQ Configured
---

### More Info:

You should configure a dead letter queue (DLQ) on AWS Lambda to give you more control over message handling for all asynchronous invocations.

### Risk Level

Informational

### Address

Security

### Compliance Standards

HIPAA, SOC2, PCIDSS, NIST



### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of AWS Lambda not having a Dead Letter Queue (DLQ) configured using the AWS Management Console, follow these steps:

1. **Navigate to the Lambda Console:**
   - Open the AWS Management Console.
   - In the Services menu, select "Lambda" to go to the Lambda dashboard.

2. **Select the Lambda Function:**
   - In the Lambda dashboard, find and click on the name of the Lambda function you want to configure.

3. **Configure Dead Letter Queue (DLQ):**
   - In the Lambda function configuration page, scroll down to the "Asynchronous invocation" section.
   - Click on the "Edit" button in the "Asynchronous invocation" section.
   - Under the "Dead-letter queue" section, select either "SQS queue" or "SNS topic" from the dropdown menu.
   - Choose an existing SQS queue or SNS topic, or create a new one if necessary.

4. **Save Changes:**
   - After selecting the appropriate DLQ, click the "Save" button to apply the changes.

By following these steps, you ensure that your AWS Lambda function has a DLQ configured, which helps in handling failed asynchronous invocations.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of AWS Lambda not having a Dead Letter Queue (DLQ) configured using AWS CLI, follow these steps:

1. **Create an SQS Queue or SNS Topic for DLQ:**
   - First, you need to create an SQS queue or an SNS topic that will act as the DLQ.
   ```sh
   aws sqs create-queue --queue-name my-dlq
   ```
   or
   ```sh
   aws sns create-topic --name my-dlq-topic
   ```

2. **Get the ARN of the Created SQS Queue or SNS Topic:**
   - Retrieve the ARN of the SQS queue or SNS topic you just created.
   ```sh
   aws sqs get-queue-attributes --queue-url https://sqs.<region>.amazonaws.com/<account-id>/my-dlq --attribute-names QueueArn
   ```
   or
   ```sh
   aws sns get-topic-attributes --topic-arn arn:aws:sns:<region>:<account-id>:my-dlq-topic
   ```

3. **Update the Lambda Function Configuration to Include the DLQ:**
   - Use the ARN obtained in the previous step to update your Lambda function configuration to include the DLQ.
   ```sh
   aws lambda update-function-configuration --function-name my-lambda-function --dead-letter-config TargetArn=arn:aws:sqs:<region>:<account-id>:my-dlq
   ```
   or
   ```sh
   aws lambda update-function-configuration --function-name my-lambda-function --dead-letter-config TargetArn=arn:aws:sns:<region>:<account-id>:my-dlq-topic
   ```

4. **Verify the Configuration:**
   - Ensure that the DLQ configuration has been successfully applied to your Lambda function.
   ```sh
   aws lambda get-function-configuration --function-name my-lambda-function
   ```

By following these steps, you can prevent the misconfiguration of AWS Lambda not having a DLQ configured using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of AWS Lambda not having a Dead Letter Queue (DLQ) configured, you can use the AWS SDK for Python (Boto3) to ensure that DLQ is set up for your Lambda functions. Here are the steps to achieve this:

1. **Install Boto3**:
   Ensure you have Boto3 installed in your Python environment. You can install it using pip if you haven't already:
   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by setting environment variables.

3. **Create or Identify an SQS Queue or SNS Topic**:
   You need an SQS queue or an SNS topic to act as the DLQ. You can create one using the AWS Management Console, AWS CLI, or Boto3.

4. **Python Script to Configure DLQ for Lambda**:
   Use the following Python script to configure a DLQ for your Lambda function. This script assumes you have an existing Lambda function and an SQS queue or SNS topic to use as the DLQ.

   ```python
   import boto3

   # Initialize the boto3 client for Lambda
   lambda_client = boto3.client('lambda')

   # Define your Lambda function name and DLQ ARN (SQS or SNS)
   lambda_function_name = 'your_lambda_function_name'
   dlq_arn = 'arn:aws:sqs:region:account-id:queue-name'  # Replace with your DLQ ARN

   # Update the Lambda function configuration to include the DLQ
   response = lambda_client.update_function_configuration(
       FunctionName=lambda_function_name,
       DeadLetterConfig={
           'TargetArn': dlq_arn
       }
   )

   # Print the response to verify the update
   print(response)
   ```

### Explanation:
1. **Install Boto3**: Ensures you have the necessary library to interact with AWS services.
2. **Set Up AWS Credentials**: Ensures your script can authenticate with AWS.
3. **Create or Identify an SQS Queue or SNS Topic**: Provides a target for the DLQ configuration.
4. **Python Script to Configure DLQ for Lambda**: The script updates the Lambda function configuration to include the DLQ, ensuring that any failed invocations are sent to the specified SQS queue or SNS topic.

By following these steps, you can programmatically ensure that your AWS Lambda functions have a DLQ configured, thereby preventing the misconfiguration.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the AWS Lambda console.

2. In the navigation pane, choose "Functions". 

3. Select the function you want to inspect for DLQ configuration.

4. Scroll down to the "Asynchronous invocation" section. Here, you can see if a Dead Letter Queue (DLQ) is configured. If the DLQ is not configured, the "Dead-letter queue" field will be empty or will show "Not configured". 

5. Repeat the process for all the Lambda functions in your AWS account across all regions.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the AWS Lambda functions.

2. Once the AWS CLI is installed and configured, you can list all the Lambda functions in your account by running the following command:

   ```
   aws lambda list-functions --region your-region
   ```

   Replace 'your-region' with the region your AWS resources are located in. This command will return a JSON object with all your Lambda functions.

3. To check if a specific Lambda function has a Dead Letter Queue (DLQ) configured, you can use the following command:

   ```
   aws lambda get-function-configuration --function-name your-function-name --region your-region
   ```

   Replace 'your-function-name' with the name of the Lambda function you want to check and 'your-region' with the region your AWS resources are located in. This command will return a JSON object with the configuration of the specified Lambda function.

4. In the returned JSON object, look for the 'DeadLetterConfig' attribute. If this attribute is present and has an 'Arn' attribute with a value, then the Lambda function has a DLQ configured. If the 'DeadLetterConfig' attribute is not present or the 'Arn' attribute is empty, then the Lambda function does not have a DLQ configured.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3) on your local system. This will allow you to interact with AWS services using Python.

```python
pip install boto3
```

2. Import the necessary modules and establish a session with AWS using your access and secret keys.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Create a client for AWS Lambda service.

```python
lambda_client = session.client('lambda')
```

4. Now, you can list all the Lambda functions and check if they have a Dead Letter Queue (DLQ) configured. If the 'DeadLetterConfig' attribute is missing or 'TargetArn' is None, then DLQ is not configured.

```python
def check_dlq_configured():
    response = lambda_client.list_functions()
    for function in response['Functions']:
        function_name = function['FunctionName']
        function_details = lambda_client.get_function_configuration(FunctionName=function_name)
        if 'DeadLetterConfig' not in function_details or not function_details['DeadLetterConfig']['TargetArn']:
            print(f"Lambda function {function_name} does not have DLQ configured.")
```

This script will print the names of all Lambda functions that do not have DLQ configured.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "AWS Lambda Should Have DLQ Configured" in AWS using AWS console, follow the steps below:

1. Open the AWS Management Console and navigate to the AWS Lambda service.

2. Select the Lambda function that needs to be remediated.

3. In the Configuration tab, scroll down to the "Dead letter queue" section and click on "Edit".

4. In the "Dead letter queue" section, select "Enable" and then select an existing SNS topic or create a new one.

5. Set the maximum number of times the function can retry failed executions. This is the number of times that AWS Lambda attempts to run your function before sending the event to the dead letter queue.

6. Click on "Save" to save the configuration.

7. Verify that the Dead Letter Queue is configured properly by testing the Lambda function with a sample event. 

By following these steps, you have successfully remediated the misconfiguration "AWS Lambda Should Have DLQ Configured" in AWS using the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
Step by step instructions on how to remediate AWS Lambda Should Have DLQ Configured using AWS CLI are:

1. Open the AWS CLI on your local machine.
2. Run the following command to list all the Lambda functions in your AWS account:

   ```
   aws lambda list-functions
   ```

3. Identify the Lambda function that needs to be remediated and note down its name.
4. Run the following command to update the Lambda function and add a Dead Letter Queue (DLQ) configuration:

   ```
   aws lambda update-function-configuration --function-name <function-name> --dead-letter-config TargetArn=<arn-of-the-SQS-queue>
   ```

   Replace `<function-name>` with the name of the Lambda function that needs to be remediated and `<arn-of-the-SQS-queue>` with the ARN of the SQS queue that should be used as the DLQ for this function.

5. Verify that the DLQ configuration has been added to the Lambda function by running the following command:

   ```
   aws lambda get-function-configuration --function-name <function-name>
   ```

   Replace `<function-name>` with the name of the Lambda function that was remediated.

6. Ensure that the SQS queue has the necessary permissions to invoke the Lambda function by adding the following policy to the SQS queue:

   ```
   {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Principal": {
                   "Service": "lambda.amazonaws.com"
               },
               "Action": "sqs:SendMessage",
               "Resource": "<arn-of-the-SQS-queue>",
               "Condition": {
                   "ArnEquals": {
                       "aws:SourceArn": "<arn-of-the-Lambda-function>"
                   }
               }
           }
       ]
   }
   ```

   Replace `<arn-of-the-SQS-queue>` with the ARN of the SQS queue and `<arn-of-the-Lambda-function>` with the ARN of the Lambda function that was remediated.

7. Verify that the SQS queue has the necessary permissions to invoke the Lambda function by running the following command:

   ```
   aws lambda get-policy --function-name <function-name>
   ```

   Replace `<function-name>` with the name of the Lambda function that was remediated.

With these steps, you have successfully remediated the AWS Lambda Should Have DLQ Configured misconfiguration using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the AWS Lambda misconfiguration of not having a Dead Letter Queue (DLQ) configured, you can follow these steps using Python:

1. Open the AWS Lambda function in the AWS Management Console.

2. Click on the "Configuration" tab.

3. Scroll down to the "Dead Letter Queue" section and click on "Edit".

4. Select the option "Enable Dead Letter Queue" and choose an existing SQS queue or create a new one.

5. Set the "Maximum Receives" value to the desired number of times a message can be unsuccessfully processed before being sent to the DLQ.

6. Click on "Save" to apply the changes.

Alternatively, you can use the AWS SDK for Python (Boto3) to remediate the misconfiguration programmatically. Here's an example code snippet:

```python
import boto3

lambda_client = boto3.client('lambda')

function_name = 'my-lambda-function'
dlq_arn = 'arn:aws:sqs:us-east-1:123456789012:my-dlq'

response = lambda_client.update_function_configuration(
    FunctionName=function_name,
    DeadLetterConfig={
        'TargetArn': dlq_arn,
        'MaxTriggers': 3
    }
)

print(response)
```

In this example, we're using the `update_function_configuration` method to set the DLQ configuration for a Lambda function. The `DeadLetterConfig` parameter takes a dictionary with the `TargetArn` and `MaxTriggers` values. The `TargetArn` is the ARN of the SQS queue to use as the DLQ, and `MaxTriggers` is the maximum number of times a message can be unsuccessfully processed before being sent to the DLQ.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html](https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html) 

