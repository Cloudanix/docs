

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the AWS Lambda service by typing 'Lambda' into the search bar and selecting 'Lambda' from the dropdown menu.
3. Once in the Lambda service, you will see a list of all your Lambda functions. Select the function you want to check for cross-account access.
4. In the function's configuration page, navigate to the 'Permissions' tab. Here, you can see the resource-based policy of the Lambda function. This policy defines who or what can invoke your function. If there are any statements in the policy that allow access from a different AWS account (the 'Principal' field contains an AWS account ID that is not your own), then the function allows cross-account access.

#### Using CLI

1. First, you need to list all your Lambda functions. You can do this by using the AWS CLI command:

```bash
aws lambda list-functions --region your-region
```

This command will return a list of all your Lambda functions in the specified region.

2. For each Lambda function, you need to get the resource policy. You can do this by using the AWS CLI command:

```bash
aws lambda get-policy --function-name your-function-name --region your-region
```

This command will return the resource policy of the specified Lambda function.

3. You need to parse the output of the previous command to get the policy. The policy is a JSON object that describes who has what permissions to the function. You can use a tool like `jq` to parse the JSON output.

```bash
aws lambda get-policy --function-name your-function-name --region your-region | jq '.Policy'
```

4. Finally, you need to check if the policy allows cross-account access. You can do this by looking for statements in the policy where the `Principal` field is not the same as your account ID. If such statements exist, then the function allows cross-account access. You can use a tool like `jq` to filter the statements.

```bash
aws lambda get-policy --function-name your-function-name --region your-region | jq '.Policy.Statement[] | select(.Principal.AWS != "your-account-id")'
```

This command will return the statements in the policy that allow cross-account access. If no such statements exist, then the function does not allow cross-account access.

#### Using Python

1. Import the necessary AWS SDK for Python (Boto3) modules in your Python script. You will need the 'boto3' module to interact with AWS services and the 'json' module to parse the AWS IAM policy documents.

```python
import boto3
import json
```

2. Create a session using your AWS credentials. Replace 'aws_access_key_id', 'aws_secret_access_key', and 'aws_session_token' with your actual AWS credentials.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    aws_session_token='SESSION_TOKEN',
)
```

3. Create a client for AWS Lambda service and list all the Lambda functions in your account.

```python
lambda_client = session.client('lambda')
functions = lambda_client.list_functions()
```

4. Iterate over each Lambda function and check its resource-based policy. If the policy allows access from another AWS account, print a warning message.

```python
for function in functions['Functions']:
    policy = lambda_client.get_policy(FunctionName=function['FunctionName'])
    policy_doc = json.loads(policy['Policy'])
    for statement in policy_doc['Statement']:
        if statement['Principal'] == '*':
            print(f"Warning: The Lambda function {function['FunctionName']} allows cross-account access.")
        elif 'AWS' in statement['Principal'] and statement['Principal']['AWS'] != 'arn:aws:iam::' + session.client('sts').get_caller_identity().get('Account') + ':root':
            print(f"Warning: The Lambda function {function['FunctionName']} allows cross-account access.")
```

This script will print a warning for each Lambda function that allows cross-account access. Please note that this script only checks for explicit cross-account access and does not consider potential access through roles or other indirect methods.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Lambda Functions Should Not Allow Cross Account Access" in AWS using the AWS console, follow these steps:

1. Sign in to the AWS Management Console.
2. Open the AWS Lambda console.
3. In the left navigation pane, choose "Functions".
4. Select the Lambda function that you want to remediate.
5. Choose the "Permissions" tab.
6. Scroll down to the "Resource-based policy" section.
7. Click the "Edit" button.
8. In the "Policy" editor, remove any statements that allow cross-account access.
9. Click the "Save" button to save the updated policy.
10. Verify that the updated policy does not allow cross-account access.

By following these steps, you have successfully remediated the misconfiguration "Lambda Functions Should Not Allow Cross Account Access" in AWS.

#### Using CLI

To remediate the misconfiguration in AWS, you can follow the below steps:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to list all the Lambda functions in your AWS account:

   ```
   aws lambda list-functions
   ```

3. Identify the Lambda function that is allowing cross-account access.

4. Run the following command to update the Lambda function's resource-based policy to deny cross-account access:

   ```
   aws lambda remove-permission --function-name <function-name> --statement-id <statement-id>
   ```

   Replace `<function-name>` with the name of the Lambda function that is allowing cross-account access, and `<statement-id>` with the ID of the statement that allows cross-account access.

   For example:

   ```
   aws lambda remove-permission --function-name my-function --statement-id AllowCrossAccountAccess
   ```

5. Verify that the resource-based policy has been updated by running the following command:

   ```
   aws lambda get-policy --function-name <function-name>
   ```

   Replace `<function-name>` with the name of the Lambda function that you updated.

   The output should show that the resource-based policy now denies cross-account access.

6. Repeat steps 4-5 for any other Lambda functions that are allowing cross-account access.

7. Once you have updated all the Lambda functions, verify that cross-account access is no longer allowed by attempting to access the Lambda function from a different AWS account.

By following these steps, you can remediate the misconfiguration and ensure that Lambda functions do not allow cross-account access in AWS.

#### Using Python

To remediate the issue of Lambda functions allowing cross-account access in AWS, you can follow these steps using Python:

1. Open the AWS Lambda console.
2. Click on the Lambda function that is allowing cross-account access.
3. Under the "Configuration" tab, click on "Permissions".
4. Click on the "Remove" button next to the role that is allowing cross-account access.
5. Click on the "Add Permission" button.
6. Select the "AWS Service" radio button.
7. Choose the service that needs access to the Lambda function.
8. Choose the "Use a permission policy" option.
9. In the policy editor, add the following policy:

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Principal": {
        "AWS": "*"
      },
      "Action": "lambda:*",
      "Resource": "arn:aws:lambda:<region>:<account-id>:function:<function-name>",
      "Condition": {
        "ArnNotEquals": {
          "aws:SourceArn": "arn:aws:logs:<region>:<account-id>:log-group:/aws/lambda/<function-name>:*"
        }
      }
    }
  ]
}
```

Replace `<region>`, `<account-id>`, and `<function-name>` with the appropriate values for your Lambda function.

10. Click on the "Add" button to save the new permission policy.

This policy will deny access to the Lambda function from any AWS account except for the specified service, and only if the request originates from the specified log group.


</Tab>
</Tabs>