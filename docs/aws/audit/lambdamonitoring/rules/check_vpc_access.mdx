---
slug: check_vpc_access
title: Lambda Should Have Access To VPC-only Resources
sidebar_label: Lambda Should Have Access To VPC-only Resources
---

### More Info:

Your Amazon Lambda functions should have access to VPC-only resources such as AWS Redshift data warehouses, AWS ElastiCache clusters, AWS RDS database instances, and service endpoints that are only accessible from within a particular Virtual Private Cloud (VPC).

### Risk Level

Medium

### Address

Security

### Compliance Standards

HIPAA, SOC2, NISTCSF, PCIDSS


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration where an AWS Lambda function should have access to VPC-only resources using the AWS Management Console, follow these steps:

1. **Create or Modify the Lambda Function:**
   - Navigate to the AWS Management Console.
   - Go to the **Lambda** service.
   - Either create a new Lambda function or select an existing one that you want to modify.

2. **Configure VPC Settings:**
   - In the Lambda function configuration page, scroll down to the **Network** section.
   - Click on the **Edit** button in the **VPC** section.
   - Select the **VPC** that contains the resources your Lambda function needs to access.

3. **Select Subnets and Security Groups:**
   - Choose the appropriate **Subnets** within the selected VPC. Ensure these subnets have the necessary route tables and network access to the VPC-only resources.
   - Select the **Security Groups** that allow the necessary inbound and outbound traffic for your Lambda function to communicate with the VPC-only resources.

4. **Save Changes:**
   - After configuring the VPC, subnets, and security groups, click the **Save** button to apply the changes.
   - Ensure that the Lambda function has the necessary IAM role permissions to access the VPC and its resources.

By following these steps, you can ensure that your AWS Lambda function is properly configured to access VPC-only resources, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration where an AWS Lambda function should have access to VPC-only resources, you need to ensure that the Lambda function is properly configured to connect to the appropriate VPC, subnets, and security groups. Here are the steps to achieve this using AWS CLI:

1. **Identify the VPC, Subnets, and Security Groups:**
   - Ensure you have the VPC ID, Subnet IDs, and Security Group IDs that the Lambda function should use.
   - You can list your VPCs, subnets, and security groups using the following commands:
     ```sh
     aws ec2 describe-vpcs
     aws ec2 describe-subnets
     aws ec2 describe-security-groups
     ```

2. **Create or Update the Lambda Function with VPC Configuration:**
   - When creating a new Lambda function, use the `--vpc-config` parameter to specify the VPC, subnets, and security groups.
     ```sh
     aws lambda create-function \
       --function-name MyLambdaFunction \
       --runtime python3.8 \
       --role arn:aws:iam::123456789012:role/execution_role \
       --handler lambda_function.lambda_handler \
       --zip-file fileb://function.zip \
       --vpc-config SubnetIds=subnet-abc123,subnet-def456,SecurityGroupIds=sg-123abc
     ```

3. **Update an Existing Lambda Function to Use VPC Configuration:**
   - If you need to update an existing Lambda function to connect to a VPC, use the `update-function-configuration` command with the `--vpc-config` parameter.
     ```sh
     aws lambda update-function-configuration \
       --function-name MyLambdaFunction \
       --vpc-config SubnetIds=subnet-abc123,subnet-def456,SecurityGroupIds=sg-123abc
     ```

4. **Verify the Lambda Function Configuration:**
   - After creating or updating the Lambda function, verify that the VPC configuration is correctly applied.
     ```sh
     aws lambda get-function-configuration --function-name MyLambdaFunction
     ```

By following these steps, you can ensure that your AWS Lambda function is properly configured to access VPC-only resources, thereby preventing the misconfiguration.
</Accordion>

<Accordion title='Using Python'>
To prevent AWS Lambda from having access to VPC-only resources using Python scripts, you can follow these steps:

1. **Create a Lambda Function Without VPC Configuration:**
   Ensure that when you create a Lambda function, you do not associate it with a VPC. This can be done using the `boto3` library in Python.

   ```python
   import boto3

   client = boto3.client('lambda')

   response = client.create_function(
       FunctionName='myLambdaFunction',
       Runtime='python3.8',
       Role='arn:aws:iam::123456789012:role/service-role/MyLambdaRole',
       Handler='lambda_function.lambda_handler',
       Code={
           'S3Bucket': 'my-bucket',
           'S3Key': 'my-function.zip'
       },
       Description='My Lambda function without VPC access',
       Timeout=15,
       MemorySize=128,
       Publish=True
   )

   print(response)
   ```

2. **Update Existing Lambda Function to Remove VPC Configuration:**
   If a Lambda function is already associated with a VPC, you can update it to remove the VPC configuration.

   ```python
   import boto3

   client = boto3.client('lambda')

   response = client.update_function_configuration(
       FunctionName='myLambdaFunction',
       VpcConfig={
           'SubnetIds': [],
           'SecurityGroupIds': []
       }
   )

   print(response)
   ```

3. **Ensure IAM Role Does Not Grant VPC Access:**
   Make sure the IAM role associated with the Lambda function does not have permissions to interact with VPC resources. This can be done by creating or updating the IAM role policy.

   ```python
   import boto3

   iam = boto3.client('iam')

   policy_document = {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Action": [
                   "logs:CreateLogGroup",
                   "logs:CreateLogStream",
                   "logs:PutLogEvents"
               ],
               "Resource": "arn:aws:logs:*:*:*"
           }
       ]
   }

   response = iam.put_role_policy(
       RoleName='MyLambdaRole',
       PolicyName='LambdaBasicExecution',
       PolicyDocument=json.dumps(policy_document)
   )

   print(response)
   ```

4. **Automate Compliance Checks:**
   Regularly check your Lambda functions to ensure they are not associated with VPCs. This can be done by listing all Lambda functions and checking their VPC configuration.

   ```python
   import boto3

   client = boto3.client('lambda')

   response = client.list_functions()

   for function in response['Functions']:
       function_name = function['FunctionName']
       config = client.get_function_configuration(FunctionName=function_name)
       if 'VpcConfig' in config and config['VpcConfig']['SubnetIds']:
           print(f"Function {function_name} is associated with a VPC.")
       else:
           print(f"Function {function_name} is not associated with a VPC.")
   ```

By following these steps, you can ensure that your AWS Lambda functions do not have access to VPC-only resources, thereby preventing potential misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the AWS Lambda console.

2. In the navigation pane, choose "Functions". You will see a list of all your Lambda functions.

3. Select the function you want to check. In the function's configuration page, scroll down to the "VPC" section. 

4. If the function is not connected to a VPC, the "VPC" field will be set to "No VPC". If the function is connected to a VPC, you will see the details of the VPC, subnets, and security groups that the function has access to. If the function needs to access VPC-only resources but is not connected to a VPC, this is a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to list all your Lambda functions. You can do this by using the AWS CLI command:

```bash
aws lambda list-functions --region your-region
```
Replace "your-region" with your actual AWS region.

2. The output of this command will give you a list of all your Lambda functions. For each function, you need to check if it has VPC access. You can do this by describing the function configuration using the following command:

```bash
aws lambda get-function-configuration --function-name your-function-name --region your-region
```
Replace "your-function-name" with the actual name of your Lambda function and "your-region" with your actual AWS region.

3. The output of this command will give you the configuration details of your Lambda function. Look for the "VpcConfig" section in the output. If the "VpcConfig" section is present and it has "SubnetIds" and "SecurityGroupIds", then your Lambda function has access to VPC resources.

4. Repeat steps 2 and 3 for each Lambda function in your list. If any function does not have a "VpcConfig" section or if the "VpcConfig" section does not have "SubnetIds" and "SecurityGroupIds", then that function does not have access to VPC-only resources.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary AWS SDK for Python (Boto3) modules in your Python script. You will need the 'boto3' module to interact with AWS services and the 'json' module to parse the AWS service responses.

```python
import boto3
import json
```

2. Create a session using your AWS credentials. Replace 'aws_access_key_id', 'aws_secret_access_key', and 'aws_session_token' with your actual AWS credentials.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    aws_session_token='SESSION_TOKEN',
)
```

3. Create a client for AWS Lambda service.

```python
lambda_client = session.client('lambda')
```

4. List all the Lambda functions and check if they have access to VPC-only resources. If the 'VpcConfig' attribute of a Lambda function is empty, it means that the function does not have access to VPC-only resources.

```python
response = lambda_client.list_functions()
for function in response['Functions']:
    if 'VpcConfig' not in function or not function['VpcConfig']['VpcId']:
        print(f"Lambda function {function['FunctionName']} does not have access to VPC-only resources.")
```

This script will print the names of all Lambda functions that do not have access to VPC-only resources.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "Lambda Should Have Access To VPC-only Resources" for AWS using AWS console, you can follow the below steps:

1. Go to the AWS Lambda console.
2. Select the Lambda function that needs to access VPC-only resources.
3. Click on the "Configuration" tab.
4. Scroll down to the "Network" section.
5. Click on "Edit".
6. Select the VPC that has the required resources.
7. Select the subnets that the Lambda function needs to access.
8. If required, select the security groups that the Lambda function needs to access.
9. Click on "Save" to apply the changes.

By following the above steps, the Lambda function will have access to VPC-only resources.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Lambda Should Have Access To VPC-only Resources" in AWS using AWS CLI, you can follow the below steps:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to create a new VPC configuration file:

```
aws ec2 create-vpc --cidr-block <CIDR_BLOCK>
```

Here, replace `<CIDR_BLOCK>` with the CIDR block range you want to use for your VPC.

3. Run the following command to create a new subnet within the VPC:

```
aws ec2 create-subnet --vpc-id <VPC_ID> --cidr-block <SUBNET_CIDR_BLOCK>
```

Here, replace `<VPC_ID>` with the ID of the VPC you created in step 2 and `<SUBNET_CIDR_BLOCK>` with the CIDR block range you want to use for your subnet.

4. Run the following command to create a new security group for the Lambda function:

```
aws ec2 create-security-group --group-name <SECURITY_GROUP_NAME> --description "<SECURITY_GROUP_DESCRIPTION>" --vpc-id <VPC_ID>
```

Here, replace `<SECURITY_GROUP_NAME>` with the name you want to give your security group, `<SECURITY_GROUP_DESCRIPTION>` with a brief description of the security group, and `<VPC_ID>` with the ID of the VPC you created in step 2.

5. Run the following command to modify the security group to allow inbound traffic from the VPC:

```
aws ec2 authorize-security-group-ingress --group-id <SECURITY_GROUP_ID> --protocol all --cidr <SUBNET_CIDR_BLOCK>
```

Here, replace `<SECURITY_GROUP_ID>` with the ID of the security group you created in step 4 and `<SUBNET_CIDR_BLOCK>` with the CIDR block range of the subnet you created in step 3.

6. Run the following command to create a new execution role for the Lambda function:

```
aws iam create-role --role-name <ROLE_NAME> --assume-role-policy-document file://trust-policy.json
```

Here, replace `<ROLE_NAME>` with the name you want to give your execution role and `trust-policy.json` with the file path to your trust policy document.

7. Run the following command to attach the necessary policies to the execution role:

```
aws iam attach-role-policy --role-name <ROLE_NAME> --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
```

Here, replace `<ROLE_NAME>` with the name of the execution role you created in step 6.

8. Run the following command to update the Lambda function to use the VPC and security group:

```
aws lambda update-function-configuration --function-name <FUNCTION_NAME> --vpc-config SubnetIds=<SUBNET_ID>,SecurityGroupIds=<SECURITY_GROUP_ID> --role <ROLE_ARN>
```

Here, replace `<FUNCTION_NAME>` with the name of the Lambda function you want to update, `<SUBNET_ID>` with the ID of the subnet you created in step 3, `<SECURITY_GROUP_ID>` with the ID of the security group you created in step 4, and `<ROLE_ARN>` with the ARN of the execution role you created in step 6.

9. Run the following command to test the Lambda function to ensure it has access to VPC-only resources:

```
aws lambda invoke --function-name <FUNCTION_NAME> --payload '{}' output.json
```

Here, replace `<FUNCTION_NAME>` with the name of the Lambda function you updated in step 8.

These steps should remediate the misconfiguration "Lambda Should Have Access To VPC-only Resources" in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the Lambda function not having access to VPC-only resources in AWS, you can follow the below steps:

1. Open the AWS Management Console and navigate to the Lambda service page.
2. Locate the Lambda function that needs to access VPC-only resources and click on it.
3. Click on the "Configuration" tab and scroll down to the "VPC" section.
4. Click on the "Edit" button to edit the VPC configuration.
5. Select the VPC that the Lambda function needs to access and select at least one subnet in each Availability Zone.
6. Select the security groups that allow access to the resources needed by the Lambda function.
7. Click on the "Save" button to save the updated VPC configuration.

Now, the Lambda function will have access to VPC-only resources. 

Here is a sample Python code to create a Lambda function with access to VPC-only resources: 

```
import boto3

def lambda_handler(event, context):
    # Create an EC2 client
    ec2 = boto3.client('ec2')
    
    # Describe instances in the VPC
    response = ec2.describe_instances()
    
    # Print the instances
    for reservation in response["Reservations"]:
        for instance in reservation["Instances"]:
            print(instance["InstanceId"])
```

Make sure to attach the appropriate VPC and security group to the Lambda function while creating it.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html](https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html) 

