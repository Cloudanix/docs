---
slug: apigateway_private_endpoint
title: Only Private End-Points Should Access APIs
sidebar_label: Only Private End-Points Should Access APIs
---

### More Info:

Amazon API Gateway APIs should be accessible only through private API endpoints and must not be visible to the public Internet.

### Risk Level

Medium

### Address

Security

### Compliance Standards

SOC2, NISTCSF, PCIDSS


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent only private endpoints from accessing APIs in API Gateway using the AWS Management Console, follow these steps:

1. **Create a VPC Endpoint for API Gateway:**
   - Navigate to the VPC Dashboard.
   - Select "Endpoints" from the left-hand menu.
   - Click on "Create Endpoint."
   - Choose the service name for API Gateway `(com.amazonaws.<region>.execute-api)`.
   - Select the VPC and subnets where you want the endpoint to be accessible.
   - Configure the security group to control access to the endpoint.
   - Click "Create Endpoint."

2. **Configure API Gateway to Use the VPC Endpoint:**
   - Navigate to the API Gateway Console.
   - Select the API you want to configure.
   - Go to the "Stages" section and select the stage you want to configure.
   - In the "Settings" tab, set the "Endpoint Type" to "Private."
   - Specify the VPC Endpoint ID created in the previous step.

3. **Update Resource Policies:**
   - In the API Gateway Console, select the API.
   - Go to the "Resource Policy" section.
   - Add a policy that allows access only from the VPC Endpoint.
   - Example policy:
     ```json
     {
       "Version": "2012-10-17",
       "Statement": [
         {
           "Effect": "Allow",
           "Principal": "*",
           "Action": "execute-api:Invoke",
           "Resource": "arn:aws:execute-api:<region>:<account-id>:<api-id>/*",
           "Condition": {
             "StringEquals": {
               "aws:SourceVpce": "<vpc-endpoint-id>"
             }
           }
         }
       ]
     }
     ```
   - Save the policy.

4. **Test the Configuration:**
   - Ensure that the API is only accessible through the VPC Endpoint.
   - Attempt to access the API from outside the VPC to confirm that it is not accessible.

By following these steps, you can ensure that only private endpoints within your VPC can access your API Gateway, enhancing the security of your APIs.
</Accordion>

<Accordion title='Using CLI'>
To prevent only private endpoints from accessing APIs in API Gateway using AWS CLI, you can follow these steps:

1. **Create a VPC Endpoint for API Gateway:**
   Ensure you have a VPC endpoint for API Gateway in your VPC. This allows your API Gateway to be accessed only within your VPC.

   ```sh
   aws ec2 create-vpc-endpoint --vpc-id <your-vpc-id> --service-name com.amazonaws.<region>.execute-api --vpc-endpoint-type Interface
   ```

2. **Update API Gateway to Use VPC Endpoint:**
   Configure your API Gateway to use the VPC endpoint by associating it with the VPC link.

   ```sh
   aws apigateway create-vpc-link --name <vpc-link-name> --target-arns <vpc-endpoint-arn>
   ```

3. **Restrict API Gateway Access to VPC:**
   Update the API Gateway resource policy to restrict access to the VPC endpoint.

   ```sh
   aws apigateway update-rest-api --rest-api-id <api-id> --patch-operations op=add,path=/policy,value='{
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Deny",
         "Principal": "*",
         "Action": "execute-api:Invoke",
         "Resource": "arn:aws:execute-api:<region>:<account-id>:<api-id>/*",
         "Condition": {
           "StringNotEquals": {
             "aws:SourceVpce": "<vpc-endpoint-id>"
           }
         }
       }
     ]
   }'
   ```

4. **Verify the Configuration:**
   Ensure that the API Gateway is correctly configured to only allow access from the specified VPC endpoint.

   ```sh
   aws apigateway get-rest-api --rest-api-id <api-id>
   ```

By following these steps, you can ensure that only private endpoints within your VPC can access your API Gateway, thereby preventing public access.
</Accordion>

<Accordion title='Using Python'>
To prevent public access to APIs in API Gateway and ensure that only private endpoints can access them, you can use Python scripts to configure the necessary settings in AWS, Azure, and GCP. Below are the steps for each cloud provider:

### AWS (Amazon Web Services)

1. **Create a VPC Endpoint for API Gateway:**
   ```python
   import boto3

   ec2_client = boto3.client('ec2')

   response = ec2_client.create_vpc_endpoint(
       VpcEndpointType='Interface',
       VpcId='vpc-xxxxxxxx',
       ServiceName='com.amazonaws.<region>.execute-api',
       SubnetIds=['subnet-xxxxxxxx'],
       SecurityGroupIds=['sg-xxxxxxxx']
   )
   print(response)
   ```

2. **Update API Gateway to Use the VPC Endpoint:**
   ```python
   import boto3

   apigateway_client = boto3.client('apigateway')

   response = apigateway_client.update_rest_api(
       restApiId='api-id',
       patchOperations=[
           {
               'op': 'replace',
               'path': '/endpointConfiguration/types',
               'value': 'PRIVATE'
           }
       ]
   )
   print(response)
   ```

### Azure (Microsoft Azure)

1. **Create a Private Endpoint for API Management:**
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.network import NetworkManagementClient

   credential = DefaultAzureCredential()
   network_client = NetworkManagementClient(credential, 'subscription-id')

   response = network_client.private_endpoints.begin_create_or_update(
       'resource-group-name',
       'private-endpoint-name',
       {
           'location': 'eastus',
           'private_link_service_connections': [{
               'name': 'connection-name',
               'private_link_service_id': '/subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.ApiManagement/service/apim-service-name',
               'group_ids': ['gateway']
           }],
           'subnet': {
               'id': '/subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.Network/virtualNetworks/vnet-name/subnets/subnet-name'
           }
       }
   ).result()
   print(response)
   ```

2. **Configure API Management to Use the Private Endpoint:**
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.apimanagement import ApiManagementClient

   credential = DefaultAzureCredential()
   apim_client = ApiManagementClient(credential, 'subscription-id')

   response = apim_client.api_management_service.update(
       'resource-group-name',
       'apim-service-name',
       {
           'public_network_access': 'Disabled'
       }
   )
   print(response)
   ```

### GCP (Google Cloud Platform)

1. **Create a Private Service Connect Endpoint:**
   ```python
   from google.cloud import compute_v1

   client = compute_v1.GlobalForwardingRulesClient()

   forwarding_rule = compute_v1.ForwardingRule(
       name='private-endpoint',
       load_balancing_scheme='INTERNAL',
       network='projects/project-id/global/networks/network-name',
       target='projects/project-id/global/targetHttpProxies/target-proxy-name'
   )

   operation = client.insert(
       project='project-id',
       forwarding_rule_resource=forwarding_rule
   )
   print(operation)
   ```

2. **Restrict API Gateway to Use the Private Endpoint:**
   ```python
   from google.cloud import apigateway_v1

   client = apigateway_v1.ApiGatewayServiceClient()

   api = client.get_api(name='projects/project-id/locations/global/apis/api-id')

   api.gateway_config = {
       'endpoint_type': 'PRIVATE'
   }

   operation = client.update_api(api=api)
   print(operation)
   ```

These scripts will help you configure your API Gateways to ensure that only private endpoints can access them, thereby preventing public access.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the API Gateway service.

2. In the API Gateway dashboard, select the API you want to inspect.

3. In the API details page, select the "Resources" option from the left-hand side menu. This will display all the resources and methods associated with the selected API.

4. For each method, click on the method request to view its settings. Under the "Settings" tab, check the "Endpoint Type" field. If it is set to "Edge Optimized" or "Regional", it means the API is publicly accessible. If it is set to "Private", it means the API can only be accessed from within your VPC or via a VPC endpoint.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the API Gateway.

2. Once the AWS CLI is set up, you can list all the APIs in the API Gateway by using the following command:

   ```
   aws apigateway get-rest-apis
   ```
   This command will return a list of all the APIs in the API Gateway.

3. To check the endpoint configuration of each API, you can use the following command:

   ```
   aws apigateway get-rest-api --rest-api-id {rest-api-id}
   ```
   Replace `{rest-api-id}` with the ID of the API you want to check. This command will return the details of the API, including its endpoint configuration.

4. To check if only private endpoints can access the API, look at the `endpointConfiguration` field in the output. If the `types` field under `endpointConfiguration` contains "PRIVATE", then only private endpoints can access the API. If it contains "EDGE" or "REGIONAL", then the API can be accessed from public endpoints.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary AWS SDK for Python (Boto3) modules and initialize a new client for the API Gateway service. 

```python
import boto3
client = boto3.client('apigateway')
```

2. Fetch all the APIs in the API Gateway service. 

```python
response = client.get_rest_apis()
apis = response['items']
```

3. For each API, get the endpoint configuration and check if it's a private endpoint. 

```python
for api in apis:
    endpoint_type = api['endpointConfiguration']['types'][0]
    if endpoint_type != 'PRIVATE':
        print(f"API {api['name']} is not a private endpoint.")
```

4. The above script will print out the names of all APIs that are not private endpoints. If no APIs are printed, then all APIs are private endpoints. If some APIs are printed, then those APIs are not private endpoints and are misconfigured.

Note: This script assumes that you have configured your AWS credentials correctly, either by setting the AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and AWS_SESSION_TOKEN environment variables, or by using the AWS CLI or AWS SDKs to configure your credentials.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration "Only Private End-Points Should Access APIs" in AWS, you can follow the steps below:

1. Login to your AWS Console.

2. Navigate to the Amazon API Gateway service.

3. Select the API that you want to remediate.

4. Click on the "Settings" tab.

5. Under the "Endpoint Type" section, select the "Private" option.

6. If you have not already created a VPC endpoint for the API Gateway, create one by clicking on the "Create VPC Link" button.

7. In the "Create VPC Link" dialog box, select the VPC that you want to use for the endpoint.

8. Choose the security groups that will be associated with the VPC endpoint.

9. Click on the "Create" button.

10. Once the VPC endpoint is created, go back to the API Gateway "Settings" tab.

11. Under the "Endpoint Configuration" section, select the VPC endpoint that you just created.

12. Click on the "Save Changes" button.

13. Test the API to ensure that it is only accessible through the private endpoint.

By following these steps, you have remediated the misconfiguration "Only Private End-Points Should Access APIs" in AWS.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "Only Private Endpoints Should Access APIs" for AWS using AWS CLI, follow the below steps:

1. Identify the APIs that are publicly accessible by running the following command:

```
aws apigateway get-rest-apis --query "items[?endpointConfiguration.types[0]=='EDGE'].name"
```

This command will list all the APIs that are publicly accessible via the internet.

2. For each of the APIs identified in step 1, update the endpoint configuration to make it private by running the following command:

```
aws apigateway update-rest-api --rest-api-id <rest-api-id> --patch-operations op=replace,path=/endpointConfiguration/types/0,value=PRIVATE
```

Replace `<rest-api-id>` with the ID of the API that you want to update.

3. Verify that the endpoint configuration has been updated by running the following command:

```
aws apigateway get-rest-api --rest-api-id <rest-api-id> --query "endpointConfiguration.types"
```

This command will return the endpoint configuration of the API. Verify that the first element in the array is "PRIVATE".

4. Repeat steps 2 and 3 for all the APIs that were identified in step 1.

5. Once you have updated all the APIs, verify that they are no longer publicly accessible by running the following command:

```
aws apigateway get-rest-apis --query "items[?endpointConfiguration.types[0]=='EDGE'].name"
```

This command should not return any APIs.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "Only Private End-Points Should Access APIs" in AWS using Python, you can follow the below steps:

Step 1: Identify the APIs which are not restricted to private endpoints only.

Step 2: For each API, check if it is currently accessible from a public endpoint.

Step 3: If the API is accessible from a public endpoint, restrict its access to private endpoints only.

Step 4: To restrict the access of an API to private endpoints only, you can use the following Python code:

```python
import boto3

# Create a boto3 client for the API Gateway service
apigateway = boto3.client('apigateway')

# Get the ID of the API which you want to restrict to private endpoints only
api_id = 'your_api_id'

# Get the current settings of the API
response = apigateway.get_rest_api(restApiId=api_id)

# Check if the API is currently accessible from a public endpoint
if response['endpointConfiguration']['types'][0] == 'EDGE':
    # If the API is accessible from a public endpoint, restrict its access to private endpoints only
    apigateway.update_rest_api(
        restApiId=api_id,
        patchOperations=[
            {
                'op': 'replace',
                'path': '/endpointConfiguration/types/0',
                'value': 'PRIVATE'
            }
        ]
    )
```

Step 5: Run this code for all the APIs which are not restricted to private endpoints only.

By following these steps, you can remediate the misconfiguration "Only Private End-Points Should Access APIs" in AWS using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://aws.amazon.com/blogs/compute/introducing-amazon-api-gateway-private-endpoints/](https://aws.amazon.com/blogs/compute/introducing-amazon-api-gateway-private-endpoints/) 

