---
slug: apigateway_enable_encryption_api_cache
title: Enable Encryption For API Cache
sidebar_label: Enable Encryption For API Cache
---

### More Info:

Ensure that your Amazon API Gateway REST APIs are configured to encrypt API cached responses in order to protect data while in transit (as it travels to and from Amazon API Gateway).

### Risk Level

High

### Address

Security

### Compliance Standards

HITRUST, SOC2, NISTCSF, PCIDSS




<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the Amazon API Gateway console at https://console.aws.amazon.com/apigateway/.

2. In the navigation pane, choose the API Gateway service.

3. In the APIs list, select the API you want to check.

4. In the API details page, select the "Stages" option from the left side menu.

5. In the Stages section, select the stage of the API you want to check.

6. In the Stage Editor panel, under the "Cache Settings" section, check if the "Cache encryption enabled" option is set to true. If it's not, then the API cache is not encrypted.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the API Gateway.

2. Once the AWS CLI is installed and configured, you can use the following command to list all the APIs in your AWS account:

   ```
   aws apigateway get-rest-apis
   ```

   This command will return a list of all the REST APIs in your account. Note down the "id" of the API you want to check.

3. Now, you can use the following command to get the details of the API:

   ```
   aws apigateway get-stages --rest-api-id <your-api-id>
   ```

   Replace `<your-api-id>` with the id of your API. This command will return the details of all the stages of your API.

4. In the output of the above command, look for the "cacheClusterEnabled" and "cacheClusterSize" fields. If "cacheClusterEnabled" is true and "cacheClusterSize" is not null, it means that the API cache is enabled. To check if the encryption is enabled for the API cache, look for the "cacheDataEncrypted" field. If it is true, it means that the encryption is enabled for the API cache. If it is false or not present, it means that the encryption is not enabled.

#### Using Python

1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the `boto3` library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```python
   pip install boto3
   ```

2. Set up AWS credentials: You need to configure your AWS credentials. You can set your credentials for use by `boto3` in several ways, but the simplest is to use the AWS CLI. Run `aws configure` and then enter your access key, secret access key, and default region when prompted.

3. Write a Python script to check the API Cache Encryption: You can use the `get_rest_apis` function provided by `boto3` to retrieve all the REST APIs in your AWS account. Then, for each API, you can use the `get_stages` function to retrieve all the stages of that API. Finally, for each stage, you can check the `cacheClusterEnabled` and `cacheClusterSize` attributes to see if the API cache is enabled and what its size is. Here is a sample script:

   ```python
   import boto3

   client = boto3.client('apigateway')

   response = client.get_rest_apis()

   for item in response['items']:
       api_id = item['id']
       stages = client.get_stages(restApiId=api_id)
       for stage in stages['item']:
           if 'cacheClusterEnabled' in stage and 'cacheClusterSize' in stage:
               print(f"API ID: {api_id}, Stage: {stage['stageName']}, Cache Enabled: {stage['cacheClusterEnabled']}, Cache Size: {stage['cacheClusterSize']}")
           else:
               print(f"API ID: {api_id}, Stage: {stage['stageName']}, Cache not enabled")
   ```

4. Run the Python script: Finally, you can run the Python script. It will print out the API ID, stage name, whether the cache is enabled, and the cache size for each stage of each API. If the cache is not enabled for a stage, it will print out that the cache is not enabled for that stage.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

Sure, here are the step-by-step instructions to remediate the misconfiguration "Enable Encryption for API Cache" in AWS using the AWS console:

1. Open the Amazon API Gateway console at https://console.aws.amazon.com/apigateway/.

2. In the navigation pane, choose "Caches" under the API you want to configure.

3. Select the API cache for which you want to enable encryption.

4. Choose "Edit" to modify the cache settings.

5. In the "Cache Settings" section, select "Enable Encryption" under "Cache Data Encryption".

6. Choose the KMS key that you want to use for encryption from the "KMS Key" drop-down list. If you don't have a KMS key, you can create one by choosing "Create a new KMS key".

7. Choose "Save" to save the changes.

That's it! You have now enabled encryption for API cache in AWS using the AWS console.

#### Using CLI

To remediate the misconfiguration "Enable Encryption For API Cache" in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI and run the following command to get a list of all the cache clusters in your AWS account:
```
aws elasticache describe-cache-clusters
```

2. Identify the cache cluster that needs to be encrypted and note down its name.

3. Run the following command to enable encryption for the cache cluster:
```
aws elasticache modify-cache-cluster --cache-cluster-id <cache-cluster-id> --engine-secuity-group-names <security-group-name> --transit-encryption Enabled
```
Replace `<cache-cluster-id>` with the name of the cache cluster identified in step 2 and `<security-group-name>` with the name of the security group associated with the cache cluster.

4. Verify that encryption has been enabled for the cache cluster by running the following command:
```
aws elasticache describe-cache-clusters --cache-cluster-id <cache-cluster-id>
```
Replace `<cache-cluster-id>` with the name of the cache cluster identified in step 2.

5. If the encryption has been successfully enabled, the output of the above command will contain the following line:
```
"TransitEncryptionEnabled": true
```

By following these steps, you can remediate the misconfiguration "Enable Encryption For API Cache" in AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration "Enable Encryption For API Cache" in AWS using Python, follow these steps:

1. Open the AWS Management Console and navigate to the Amazon API Gateway service.

2. Select the API that you want to remediate and click on the "Stages" tab.

3. Click on the "Cache" tab and select the cache that you want to remediate.

4. Click on the "Settings" button and select "Enable Encryption".

5. In the "Enable Encryption" dialog box, select the KMS key that you want to use for encryption.

6. Click on the "Enable" button to enable encryption for the API cache.

7. To automate this process using Python, you can use the AWS SDK for Python (Boto3) to write a script that performs the above steps. Here is an example script:

```
import boto3

# Set the AWS region
region = 'us-west-2'

# Set the API Gateway API ID and stage name
api_id = 'your_api_id'
stage_name = 'your_stage_name'

# Set the cache ID
cache_id = 'your_cache_id'

# Set the KMS key ID for encryption
kms_key_id = 'your_kms_key_id'

# Create an API Gateway client
client = boto3.client('apigateway', region_name=region)

# Enable encryption for the cache
client.update_stage(
    restApiId=api_id,
    stageName=stage_name,
    patchOperations=[
        {
            'op': 'replace',
            'path': '/caching/dataEncrypted',
            'value': 'true'
        },
        {
            'op': 'replace',
            'path': '/caching/encryptionEnabled',
            'value': 'true'
        },
        {
            'op': 'replace',
            'path': '/caching/kmsKeyId',
            'value': kms_key_id
        }
    ]
)
```

Note: Replace the placeholders "your_api_id", "your_stage_name", "your_cache_id", and "your_kms_key_id" with your own values. Also, make sure that you have the necessary permissions to perform this operation.

### Additional Reading:

- [https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-caching.html](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-caching.html) 


</Tab>
</Tabs>