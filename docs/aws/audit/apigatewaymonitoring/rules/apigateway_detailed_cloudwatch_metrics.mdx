---
slug: apigateway_detailed_cloudwatch_metrics
title: Cloudwatch Metrics Must Be Enabled For All APIs
sidebar_label: Cloudwatch Metrics Must Be Enabled For All APIs
---

### More Info:

Detailed CloudWatch metrics should be enabled for all APIs created with AWS API Gateway service in order to monitor API stages caching, latency and detected errors at a more granular level and set alarms accordingly.

### Risk Level

Low

### Address

Operational Maturity

### Compliance Standards

HIPAA, SOC2, HITRUST, NISTCSF, PCIDSS



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the API Gateway service.
2. In the API Gateway dashboard, you will see a list of all your APIs. Select the API you want to check.
3. Once you've selected the API, navigate to the "Stages" section on the left-hand side menu.
4. In the Stages section, select a stage, then click on the "Logs/Tracing" tab. Here, you can check if CloudWatch Metrics is enabled for the API. If it's not, there will be no checkmark next to "Enable CloudWatch Metrics".

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   Installation:
   ```
   pip install awscli
   ```
   Configuration:
   ```
   aws configure
   ```
   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all APIs: Use the following command to list all the APIs in API Gateway:
   ```
   aws apigateway get-rest-apis
   ```
   This command will return a list of all the APIs in your AWS account.

3. Check CloudWatch metrics for each API: For each API in the list, you need to check if CloudWatch metrics are enabled. You can do this by running the following command for each API:
   ```
   aws apigateway get-stage --rest-api-id <api-id> --stage-name <stage-name>
   ```
   Replace `<api-id>` with the ID of the API and `<stage-name>` with the name of the stage you want to check. This command will return the details of the specified stage.

4. Verify CloudWatch metrics: In the output of the previous command, look for the `methodSettings` field. If CloudWatch metrics are enabled, you should see `"metricsEnabled": true`. If this field is not present or set to `false`, then CloudWatch metrics are not enabled for that API.

#### Using Python

1. **Setup AWS SDK (Boto3) in Python Environment:**
   First, you need to set up AWS SDK (Boto3) in your Python environment. You can install it using pip:
   ```
   pip install boto3
   ```
   After installing boto3, configure your AWS credentials. You can configure your credentials either by exporting them directly into your shell or by storing them in a credentials file on your local system.

2. **List All APIs in API Gateway:**
   Use the `get_rest_apis` function to retrieve all the APIs in the API Gateway. Here is a sample script:
   ```python
   import boto3

   client = boto3.client('apigateway')

   response = client.get_rest_apis()

   for item in response['items']:
       print(item['name'], item['id'])
   ```
   This script will print the name and id of all APIs in the API Gateway.

3. **Check Cloudwatch Metrics for Each API:**
   For each API, check if Cloudwatch metrics are enabled. You can do this by calling the `get_stage` function and checking the `metricsEnabled` attribute. Here is a sample script:
   ```python
   import boto3

   client = boto3.client('apigateway')

   response = client.get_rest_apis()

   for item in response['items']:
       stages = client.get_stages(restApiId=item['id'])
       for stage in stages['item']:
           if not stage['methodSettings']['*/*']['metricsEnabled']:
               print(f"Cloudwatch Metrics are not enabled for API: {item['name']}")
   ```
   This script will print the name of the APIs for which Cloudwatch metrics are not enabled.

4. **Automate the Process:**
   You can automate this process by running this script at regular intervals. You can use AWS Lambda to run this script automatically. You can also set up a Cloudwatch event that triggers this Lambda function at regular intervals. This way, you can continuously monitor your APIs and ensure that Cloudwatch metrics are always enabled.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration "Cloudwatch Metrics Must Be Enabled For All APIs" for AWS using AWS console, follow the below steps:

1. Open the AWS Management Console and go to the Amazon API Gateway service.

2. Select the API for which you want to enable CloudWatch metrics.

3. Click on the "Stages" option from the left-hand side menu.

4. Select the stage for which you want to enable CloudWatch metrics.

5. Click on the "Logs/Tracing" tab.

6. Under the "CloudWatch Settings" section, check the box next to "Enable CloudWatch Logs" and "Enable CloudWatch Metrics".

7. Select the appropriate log format for your API.

8. Click on the "Save Changes" button.

9. Repeat the above steps for all the APIs and stages that you want to enable CloudWatch metrics for.

By following these steps, you can remediate the misconfiguration "Cloudwatch Metrics Must Be Enabled For All APIs" for AWS using AWS console.

#### Using CLI

To remediate the misconfiguration "Cloudwatch Metrics Must Be Enabled For All APIs" in AWS using AWS CLI, follow the below steps:

1. Open the AWS CLI on your local machine and run the following command to enable CloudWatch metrics for all existing APIs in your AWS account:

```
aws apigateway update-account --metrics-enabled
```

2. To ensure that CloudWatch metrics are enabled for all new APIs created in your account, run the following command:

```
aws apigateway update-rest-api --rest-api-id <rest-api-id> --patch-operations op=replace,path=/metrics/enabled,value=true
```

Note: Replace `<rest-api-id>` with the ID of your REST API.

3. To verify that CloudWatch metrics are enabled for all APIs, run the following command:

```
aws apigateway get-account
```

This command should return a JSON object with the following key-value pair:

```
"metricsEnabled": true
```

4. To verify that CloudWatch metrics are enabled for a specific API, run the following command:

```
aws apigateway get-rest-api --rest-api-id <rest-api-id>
```

This command should return a JSON object with the following key-value pair:

```
"metrics": {
    "enabled": true
}
```

Note: Replace `<rest-api-id>` with the ID of your REST API.

By following these steps, you will have successfully remediated the misconfiguration "Cloudwatch Metrics Must Be Enabled For All APIs" in AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration "Cloudwatch Metrics Must Be Enabled For All APIs" for AWS using Python, you can follow these steps:

1. Import the necessary AWS SDK for Python (Boto3) library.

```
import boto3
```

2. Create a Boto3 client for the Amazon API Gateway service.

```
apigateway = boto3.client('apigateway')
```

3. Get a list of all the APIs in your AWS account using the `get_rest_apis` method.

```
response = apigateway.get_rest_apis()
```

4. Loop through the list of APIs and enable CloudWatch metrics for each one using the `update_stage` method.

```
for api in response['items']:
    stages = apigateway.get_stages(restApiId=api['id'])
    for stage in stages['item']:
        apigateway.update_stage(restApiId=api['id'], stageName=stage['stageName'], patchOperations=[{'op': 'replace', 'path': '/metrics/enabled', 'value': 'true'}])
```

This code snippet will enable CloudWatch metrics for all APIs and stages in your AWS account. You can run this code as a Python script or integrate it into your existing infrastructure-as-code (IaC) pipeline to ensure that CloudWatch metrics are always enabled for your APIs.

### Additional Reading:

- [https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-metrics-and-dimensions.html](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-metrics-and-dimensions.html) 


</Tab>
</Tabs>