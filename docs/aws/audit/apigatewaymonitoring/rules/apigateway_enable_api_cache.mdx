---
slug: apigateway_enable_api_cache
title: Enable API Cache
sidebar_label: Enable API Cache
---

### More Info:

Ensure that response caching is enabled for your Amazon API Gateway REST APIs in order to enhance API responsiveness and decrease latency.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent enabling API Cache in API Gateway using the AWS Management Console, follow these steps:

1. **Navigate to API Gateway:**
   - Open the AWS Management Console.
   - In the Services menu, select "API Gateway" under the "Networking & Content Delivery" section.

2. **Select Your API:**
   - In the API Gateway console, select the API for which you want to prevent enabling the cache.

3. **Access Stage Settings:**
   - Click on the "Stages" option in the left-hand navigation pane.
   - Select the stage you want to configure (e.g., "prod" or "dev").

4. **Disable Cache:**
   - In the "Stage Editor" pane, scroll down to the "Cache Settings" section.
   - Ensure that the "Enable API Cache" option is unchecked.

By following these steps, you can prevent the API cache from being enabled in API Gateway using the AWS Management Console.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not enabling API Cache in API Gateway using AWS CLI, you can follow these steps:

1. **Create or Update API Gateway Stage with Caching Enabled:**
   Ensure that the stage of your API Gateway has caching enabled. You can do this by creating or updating the stage with the `--cache-cluster-enabled` parameter set to `true`.

   ```sh
   aws apigateway create-stage --rest-api-id <rest-api-id> --stage-name <stage-name> --deployment-id <deployment-id> --cache-cluster-enabled true
   ```

   Or, if you are updating an existing stage:

   ```sh
   aws apigateway update-stage --rest-api-id <rest-api-id> --stage-name <stage-name> --patch-operations op=replace,path=/cacheClusterEnabled,value=true
   ```

2. **Specify Cache Cluster Size:**
   Define the size of the cache cluster to ensure it is appropriately configured. This can be done during the creation or update of the stage.

   ```sh
   aws apigateway create-stage --rest-api-id <rest-api-id> --stage-name <stage-name> --deployment-id <deployment-id> --cache-cluster-size <cache-cluster-size>
   ```

   Or, if you are updating an existing stage:

   ```sh
   aws apigateway update-stage --rest-api-id <rest-api-id> --stage-name <stage-name> --patch-operations op=replace,path=/cacheClusterSize,value=<cache-cluster-size>
   ```

3. **Enable Caching for Specific Methods:**
   Ensure that caching is enabled for specific methods within your API Gateway. This can be done by updating the method settings.

   ```sh
   aws apigateway update-method --rest-api-id <rest-api-id> --resource-id <resource-id> --http-method <http-method> --patch-operations op=replace,path=/methodSettings/*/*/cachingEnabled,value=true
   ```

4. **Set Cache TTL (Time to Live):**
   Define the TTL for the cache to control how long responses are cached.

   ```sh
   aws apigateway update-stage --rest-api-id <rest-api-id> --stage-name <stage-name> --patch-operations op=replace,path=/methodSettings/*/*/cacheTtlInSeconds,value=<ttl-in-seconds>
   ```

Replace `<rest-api-id>`, `<stage-name>`, `<deployment-id>`, `<cache-cluster-size>`, `<resource-id>`, `<http-method>`, and `<ttl-in-seconds>` with your specific API Gateway details.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not enabling API Cache in API Gateway using Python scripts, you can follow these steps:

1. **Install Required Libraries**:
   Ensure you have the necessary libraries installed. You will need `boto3` for AWS, `azure-mgmt-apimanagement` for Azure, and `google-api-python-client` for GCP.

   ```bash
   pip install boto3 azure-mgmt-apimanagement google-api-python-client
   ```

2. **AWS: Enable API Cache in API Gateway**:
   Use `boto3` to enable caching for your API Gateway in AWS.

   ```python
   import boto3

   client = boto3.client('apigateway')

   def enable_api_cache(rest_api_id, stage_name):
       response = client.update_stage(
           restApiId=rest_api_id,
           stageName=stage_name,
           patchOperations=[
               {
                   'op': 'replace',
                   'path': '/cacheClusterEnabled',
                   'value': 'true'
               },
               {
                   'op': 'replace',
                   'path': '/cacheClusterSize',
                   'value': '0.5'  # Example size, adjust as needed
               }
           ]
       )
       print(response)

   # Example usage
   enable_api_cache('your_rest_api_id', 'your_stage_name')
   ```

3. **Azure: Enable API Cache in API Management**:
   Use `azure-mgmt-apimanagement` to enable caching for your API Management in Azure.

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.apimanagement import ApiManagementClient

   credential = DefaultAzureCredential()
   client = ApiManagementClient(credential, 'your_subscription_id')

   def enable_api_cache(resource_group_name, service_name, api_id):
       api = client.api.get(resource_group_name, service_name, api_id)
       api.cache = {
           'description': 'Cache description',
           'duration': '300',  # Cache duration in seconds
           'useDynamicCompression': True
       }
       client.api.create_or_update(resource_group_name, service_name, api_id, api)

   # Example usage
   enable_api_cache('your_resource_group_name', 'your_service_name', 'your_api_id')
   ```

4. **GCP: Enable API Cache in API Gateway**:
   Use `google-api-python-client` to enable caching for your API Gateway in GCP.

   ```python
   from googleapiclient.discovery import build
   from google.oauth2 import service_account

   credentials = service_account.Credentials.from_service_account_file('path_to_your_service_account.json')
   service = build('apigateway', 'v1', credentials=credentials)

   def enable_api_cache(api_name, config_id):
       config = service.projects().locations().apis().configs().get(
           name=f'projects/your_project_id/locations/global/apis/{api_name}/configs/{config_id}'
       ).execute()

       config['gatewayConfig']['backendConfig']['cacheConfig'] = {
           'enabled': True,
           'ttl': '300s'  # Cache TTL in seconds
       }

       service.projects().locations().apis().configs().patch(
           name=f'projects/your_project_id/locations/global/apis/{api_name}/configs/{config_id}',
           body=config
       ).execute()

   # Example usage
   enable_api_cache('your_api_name', 'your_config_id')
   ```

These scripts will help you enable API caching in AWS, Azure, and GCP, thereby preventing the misconfiguration of not having API caching enabled. Adjust the parameters as needed for your specific environment.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the Amazon API Gateway console at https://console.aws.amazon.com/apigateway/.

2. In the navigation pane, choose the API Gateway service.

3. In the APIs list, select the API you want to check.

4. In the API details page, select the "Stages" option from the left side menu.

5. In the Stages section, select the stage for which you want to check the API cache. 

6. In the Stage Editor panel, under the "Settings" tab, look for the "Cache Settings" section. If the "Enable API cache" checkbox is checked, then the API cache is enabled. If it's not checked, then the API cache is not enabled.
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local system. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all the APIs: Use the `get-rest-apis` command to list all the APIs in your AWS account. The command is as follows:
   ```
   aws apigateway get-rest-apis
   ```
   This command will return a list of all the APIs in your account, along with their details.

3. Get the details of a specific API: Once you have the list of APIs, you can get the details of a specific API by using the `get-rest-api` command along with the API's ID. The command is as follows:
   ```
   aws apigateway get-rest-api --rest-api-id {api-id}
   ```
   Replace `{api-id}` with the ID of the API you want to check. This command will return the details of the specified API.

4. Check the API Cache setting: In the details returned by the `get-rest-api` command, look for the `cacheClusterEnabled` field. If this field is set to `true`, then the API Cache is enabled. If it is set to `false` or if the field is not present, then the API Cache is not enabled.
</Accordion>

<Accordion title='Using Python'>
To check if API Cache is enabled in API Gateway using Python scripts, you can use the Boto3 library, which allows you to directly interact with AWS services, including API Gateway. Here are the steps:

1. **Install Boto3**: First, you need to install the Boto3 library in your Python environment. You can do this using pip:
   ```
   pip install boto3
   ```

2. **Configure AWS Credentials**: Boto3 needs your AWS credentials (access key and secret access key) to interact with AWS services. You can configure it using the AWS CLI:
   ```
   aws configure
   ```
   Then, input your access key, secret access key, and your preferred AWS region when prompted.

3. **Create a Python Script**: Now, you can create a Python script that uses Boto3 to interact with API Gateway and check if API Cache is enabled. Here's a basic example:
   ```python
   import boto3

   def check_api_cache():
       client = boto3.client('apigateway')
       response = client.get_rest_apis()

       for api in response['items']:
           api_id = api['id']
           stage_response = client.get_stages(restApiId=api_id)

           for stage in stage_response['item']:
               if 'cacheClusterEnabled' in stage and stage['cacheClusterEnabled']:
                   print(f"API Cache is enabled for API {api_id} in stage {stage['stageName']}")
               else:
                   print(f"API Cache is not enabled for API {api_id} in stage {stage['stageName']}")

   if __name__ == "__main__":
       check_api_cache()
   ```
   This script retrieves all REST APIs and their stages, then checks if the 'cacheClusterEnabled' attribute is present and set to True.

4. **Run the Python Script**: Finally, you can run the Python script using a Python interpreter:
   ```
   python check_api_cache.py
   ```
   The script will print out whether API Cache is enabled for each API and stage.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of enabling API Cache in AWS, you can follow the below steps:

1. Login to your AWS Management Console.
2. Navigate to the API Gateway service.
3. Select the API that you want to enable caching for.
4. Click on the "Stages" option in the left-hand menu.
5. Select the stage for which you want to enable caching.
6. Click on the "Settings" tab.
7. Scroll down to the "Cache Settings" section.
8. Click on the "Enable API Cache" checkbox.
9. Set the "Cache Capacity" and "TTL" values as per your requirement.
10. Click on the "Save Changes" button.

Once you have completed these steps, caching will be enabled for your API in AWS. You can test it by making some API requests and checking if the response time has improved.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration of enabling API Cache in AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine.
2. Run the following command to create a new API cache:

```
aws apigateway create-cache-cluster --cache-cluster-name <cache-cluster-name> --cache-node-type <cache-node-type> --region <region>
```

Replace `<cache-cluster-name>` with the name you want to give to your new cache cluster, `<cache-node-type>` with the type of cache node you want to use, and `<region>` with the region where you want to create the cache.

3. Run the following command to deploy the API with the cache enabled:

```
aws apigateway update-rest-api --rest-api-id <rest-api-id> --patch-operations op=replace,path=/endpointConfiguration/types/EDGE,value=REGIONAL op=add,path=/endpointConfiguration/types/EDGE/cacheClusterEnabled,value=true --region <region>
```

Replace `<rest-api-id>` with the ID of the REST API you want to deploy and `<region>` with the region where the REST API is located.

4. Verify that the API cache is enabled by running the following command:

```
aws apigateway get-rest-api --rest-api-id <rest-api-id> --region <region> | grep cacheClusterEnabled
```

This command should return a value of `true` for the `cacheClusterEnabled` parameter.

By following these steps, you should be able to remediate the misconfiguration of enabling API Cache in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of not having API cache enabled in AWS, you can use the following steps in Python:

1. Import the required AWS SDK modules:
```
import boto3
```

2. Create a boto3 client for Amazon API Gateway:
```
client = boto3.client('apigateway')
```

3. Get the list of APIs in your AWS account:
```
api_list = client.get_rest_apis()['items']
```

4. For each API in the list, check if API cache is enabled:
```
for api in api_list:
    response = client.get_stage(restApiId=api['id'], stageName='prod')
    if 'cacheClusterEnabled' not in response:
        response = client.update_stage(restApiId=api['id'], stageName='prod', patchOperations=[{
            'op': 'replace',
            'path': '/cacheClusterEnabled',
            'value': 'True'
        }])
```

5. If API cache is not enabled, update the API stage to enable it:
```
response = client.update_stage(restApiId=api['id'], stageName='prod', patchOperations=[{
    'op': 'replace',
    'path': '/cacheClusterEnabled',
    'value': 'True'
}])
```

6. Verify that API cache is enabled by checking the response:
```
if 'cacheClusterEnabled' in response and response['cacheClusterEnabled'] == 'True':
    print('API cache enabled successfully')
else:
    print('Error enabling API cache')
```

These steps will enable API cache in all the APIs in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-caching.html](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-caching.html) 

