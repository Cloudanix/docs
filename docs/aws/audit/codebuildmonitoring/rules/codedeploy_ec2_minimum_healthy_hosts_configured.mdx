---
slug: codedeploy_ec2_minimum_healthy_hosts_configured
title: EC2 Minimum Healthy Hosts Fleet Percentage Should Be Maintained
sidebar_label: EC2 Minimum Healthy Hosts Fleet Percentage Should Be Maintained
---

### More Info:

This rule checks if the deployment group for EC2/On-Premises Compute Platform is configured with a minimum healthy hosts fleet percentage or host count greater than or equal to the input threshold.

### Risk Level

Medium

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent EC2 Minimum Healthy Hosts Fleet Percentage issues in AWS CodeBuild using the AWS Management Console, follow these steps:

1. **Navigate to CodeBuild Project:**
   - Open the AWS Management Console.
   - In the search bar, type "CodeBuild" and select it from the list of services.
   - Choose the specific CodeBuild project you want to configure.

2. **Configure Build Environment:**
   - In the CodeBuild project settings, go to the "Build environment" section.
   - Ensure that the environment type and compute type are appropriately configured to handle the expected load and maintain a healthy host percentage.

3. **Set Up Auto Scaling:**
   - Navigate to the "Auto Scaling" settings within the CodeBuild project.
   - Configure the minimum and maximum number of instances to ensure that there are always enough healthy hosts available.
   - Set the desired capacity to a value that maintains the required healthy host percentage.

4. **Monitor and Adjust:**
   - Use CloudWatch to monitor the health and performance of your CodeBuild instances.
   - Set up alarms and notifications to alert you if the number of healthy hosts falls below the desired threshold.
   - Adjust the auto-scaling policies as needed based on the monitoring data to ensure the minimum healthy host percentage is maintained.

By following these steps, you can ensure that your EC2 instances used in CodeBuild maintain the required minimum healthy host percentage, thereby preventing potential misconfigurations.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of EC2 Minimum Healthy Hosts Fleet Percentage in AWS CodeBuild using AWS CLI, follow these steps:

1. **Create or Update a Build Project with Health Check Configuration:**
   Ensure that your CodeBuild project is configured to maintain a minimum healthy hosts fleet percentage. You can do this by specifying the `vpcConfig` and `environment` settings in your build project configuration.

   ```sh
   aws codebuild create-project \
       --name my-build-project \
       --source type=GITHUB,location=https://github.com/my-repo/my-project \
       --artifacts type=NO_ARTIFACTS \
       --environment type=LINUX_CONTAINER,image=aws/codebuild/standard:4.0,computeType=BUILD_GENERAL1_SMALL \
       --service-role arn:aws:iam::123456789012:role/service-role/codebuild-service-role \
       --vpc-config subnetIds=subnet-12345678,securityGroupIds=sg-12345678
   ```

   If updating an existing project, use:

   ```sh
   aws codebuild update-project \
       --name my-build-project \
       --vpc-config subnetIds=subnet-12345678,securityGroupIds=sg-12345678
   ```

2. **Set Up Auto Scaling for EC2 Instances:**
   Ensure that your EC2 instances are part of an Auto Scaling group that maintains the desired healthy host percentage. Create or update an Auto Scaling group with the desired configuration.

   ```sh
   aws autoscaling create-auto-scaling-group \
       --auto-scaling-group-name my-asg \
       --instance-id i-1234567890abcdef0 \
       --min-size 1 \
       --max-size 5 \
       --desired-capacity 3 \
       --vpc-zone-identifier subnet-12345678
   ```

   If updating an existing group, use:

   ```sh
   aws autoscaling update-auto-scaling-group \
       --auto-scaling-group-name my-asg \
       --desired-capacity 3
   ```

3. **Configure Health Checks for Auto Scaling Group:**
   Ensure that the Auto Scaling group has health checks enabled to maintain the minimum healthy hosts.

   ```sh
   aws autoscaling update-auto-scaling-group \
       --auto-scaling-group-name my-asg \
       --health-check-type EC2 \
       --health-check-grace-period 300
   ```

4. **Set Up CloudWatch Alarms:**
   Create CloudWatch alarms to monitor the health of your EC2 instances and trigger actions if the number of healthy hosts falls below the desired threshold.

   ```sh
   aws cloudwatch put-metric-alarm \
       --alarm-name HealthyHostsAlarm \
       --metric-name HealthyHostCount \
       --namespace AWS/EC2 \
       --statistic Average \
       --period 300 \
       --threshold 2 \
       --comparison-operator LessThanThreshold \
       --dimensions Name=AutoScalingGroupName,Value=my-asg \
       --evaluation-periods 1 \
       --alarm-actions arn:aws:sns:us-west-2:123456789012:my-sns-topic
   ```

By following these steps, you can ensure that your EC2 instances in AWS CodeBuild maintain the minimum healthy hosts fleet percentage using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of EC2 Minimum Healthy Hosts Fleet Percentage in AWS CodeBuild using Python scripts, you can use the AWS SDK for Python (Boto3). Here are the steps:

1. **Install Boto3**:
   Ensure you have Boto3 installed. If not, you can install it using pip.
   ```bash
   pip install boto3
   ```

2. **Set Up AWS Credentials**:
   Make sure your AWS credentials are configured. You can set them up using the AWS CLI or by setting environment variables.

3. **Create a Python Script**:
   Write a Python script to configure the minimum healthy hosts fleet percentage for your CodeBuild project.

4. **Implement the Script**:
   Below is a sample Python script to set the minimum healthy hosts fleet percentage for an AWS CodeBuild project.

```python
import boto3

def set_minimum_healthy_hosts(project_name, min_healthy_hosts):
    # Initialize a session using Amazon CodeBuild
    client = boto3.client('codebuild')

    # Get the current project configuration
    response = client.batch_get_projects(names=[project_name])
    if not response['projects']:
        raise ValueError(f"Project {project_name} not found")

    project = response['projects'][0]

    # Update the project configuration with the minimum healthy hosts
    updated_project = client.update_project(
        name=project_name,
        environment={
            'type': project['environment']['type'],
            'image': project['environment']['image'],
            'computeType': project['environment']['computeType'],
            'environmentVariables': project['environment'].get('environmentVariables', []),
            'privilegedMode': project['environment'].get('privilegedMode', False),
            'certificate': project['environment'].get('certificate', ''),
            'registryCredential': project['environment'].get('registryCredential', {}),
            'imagePullCredentialsType': project['environment'].get('imagePullCredentialsType', 'CODEBUILD')
        },
        serviceRole=project['serviceRole'],
        timeoutInMinutes=project['timeoutInMinutes'],
        queuedTimeoutInMinutes=project.get('queuedTimeoutInMinutes', 480),
        encryptionKey=project.get('encryptionKey', ''),
        tags=project.get('tags', []),
        vpcConfig=project.get('vpcConfig', {}),
        badgeEnabled=project.get('badgeEnabled', False),
        logsConfig=project.get('logsConfig', {}),
        fileSystemLocations=project.get('fileSystemLocations', []),
        buildBatchConfig={
            'serviceRole': project['buildBatchConfig']['serviceRole'],
            'combineArtifacts': project['buildBatchConfig']['combineArtifacts'],
            'restrictions': {
                'maximumBuildsAllowed': project['buildBatchConfig']['restrictions']['maximumBuildsAllowed'],
                'computeTypesAllowed': project['buildBatchConfig']['restrictions']['computeTypesAllowed']
            },
            'timeoutInMins': project['buildBatchConfig']['timeoutInMins'],
            'batchReportMode': project['buildBatchConfig']['batchReportMode'],
            'minimumHealthyHosts': {
                'type': 'FLEET_PERCENT',
                'value': min_healthy_hosts
            }
        }
    )

    print(f"Updated project {project_name} with minimum healthy hosts fleet percentage: {min_healthy_hosts}%")

# Example usage
project_name = 'your-codebuild-project-name'
min_healthy_hosts = 50  # Set the desired minimum healthy hosts fleet percentage
set_minimum_healthy_hosts(project_name, min_healthy_hosts)
```

### Explanation:
1. **Install Boto3**: Ensure Boto3 is installed to interact with AWS services.
2. **Set Up AWS Credentials**: Configure your AWS credentials to allow the script to authenticate with AWS.
3. **Create a Python Script**: Write a script to interact with the AWS CodeBuild service.
4. **Implement the Script**: Use the Boto3 client to fetch the current project configuration and update it with the desired minimum healthy hosts fleet percentage.

This script ensures that the minimum healthy hosts fleet percentage is maintained for your CodeBuild project, preventing misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the CodeBuild service.
2. In the navigation pane, select "Build projects". This will display a list of all your build projects.
3. Select the build project you want to check. This will open the project details page.
4. In the project details page, navigate to the "Environment" section. Here, you can see the "Compute" configuration. If the "Compute type" is set to "Fleet", you can see the "Minimum healthy hosts" setting. This setting should be maintained at a certain percentage to ensure the health of your EC2 instances. If it's not, it indicates a misconfiguration.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is set up, you can use the `describe-projects` command to list all the CodeBuild projects in your AWS account. The command is as follows:

   ```
   aws codebuild describe-projects
   ```

3. After getting the list of projects, you can use the `batch-get-projects` command to get detailed information about each project. You need to provide the names of the projects as input to this command. The command is as follows:

   ```
   aws codebuild batch-get-projects --names project-name1 project-name2
   ```

4. In the output of the above command, look for the `computeType` field under the `environment` section. If the `computeType` is set to `BUILD_GENERAL1_SMALL`, it means that the EC2 instance type used for the CodeBuild project is small and may not maintain the minimum healthy hosts fleet percentage. 

Please note that AWS CodeBuild does not directly provide a configuration to maintain a minimum healthy hosts fleet percentage. You may need to manage this at the EC2 Auto Scaling group level or use other AWS services like Elastic Beanstalk or ECS that provide such configurations.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary AWS SDK for Python (Boto3) if you haven't done so already. You can install it using pip:

```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials:

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='YOUR_REGION'
)
```

3. Now, create a client for 'codebuild' service:

```python
client = session.client('codebuild')
```

4. Now, you can list all the projects and check the 'minimumHealthyHosts' for each project:

```python
response = client.list_projects()

for project in response['projects']:
    project_details = client.batch_get_projects(names=[project])
    for project in project_details['projects']:
        if 'vpcConfig' in project:
            if 'vpcId' in project['vpcConfig']:
                vpc_id = project['vpcConfig']['vpcId']
                if vpc_id:
                    print(f"Project {project['name']} is using VPC {vpc_id}")
                    if 'minimumHealthyHosts' in project['vpcConfig']:
                        min_healthy_hosts = project['vpcConfig']['minimumHealthyHosts']
                        print(f"Minimum healthy hosts for project {project['name']} is {min_healthy_hosts}")
                    else:
                        print(f"Project {project['name']} does not have a minimum healthy hosts configuration")
                else:
                    print(f"Project {project['name']} is not using a VPC")
            else:
                print(f"Project {project['name']} does not have a VPC configuration")
        else:
            print(f"Project {project['name']} does not have a VPC configuration")
```

This script will print the minimum healthy hosts configuration for each project that is using a VPC. If a project is not using a VPC or does not have a minimum healthy hosts configuration, it will print a message indicating this.

Please replace 'YOUR_ACCESS_KEY', 'YOUR_SECRET_KEY', and 'YOUR_REGION' with your actual AWS access key, secret key, and region.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of maintaining the Minimum Healthy Hosts Fleet Percentage for AWS CodeBuild in AWS console, you can follow these steps:

1. **Access AWS CodeBuild Console:**
   - Log in to your AWS Management Console.
   - Go to the AWS CodeBuild service by searching for "CodeBuild" in the search bar.

2. **Select the Project:**
   - In the AWS CodeBuild console, select the project for which you want to remediate the misconfiguration.

3. **Edit Project Configuration:**
   - Click on the project name to access the project details.
   - Click on the "Edit" button to edit the project configuration.

4. **Update Compute Type:**
   - In the project configuration settings, navigate to the "Environment" section.
   - Under the "Environment image" section, you will find the "Compute type" field.
   - Select a compute type that supports maintaining the Minimum Healthy Hosts Fleet Percentage. For example, choose a compute type that allows you to specify the minimum and maximum number of instances to keep running.

5. **Set Minimum Healthy Hosts Fleet Percentage:**
   - Look for the settings related to the Minimum Healthy Hosts Fleet Percentage or the number of instances to maintain.
   - Update the configuration to specify the desired percentage or number of instances that should be kept healthy at all times.

6. **Save Configuration Changes:**
   - After updating the configuration, scroll down and click on the "Update Project" button to save the changes.

7. **Verify Changes:**
   - Once the project configuration is saved, trigger a build or wait for the next scheduled build to ensure that the changes have taken effect.
   - Monitor the project to ensure that the Minimum Healthy Hosts Fleet Percentage is being maintained as per the updated configuration.

By following these steps, you should be able to remediate the misconfiguration of maintaining the Minimum Healthy Hosts Fleet Percentage for AWS CodeBuild in the AWS console.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the EC2 Minimum Healthy Hosts Fleet Percentage misconfiguration for AWS CodeBuild using AWS CLI, follow these steps:

1. **Identify the CodeBuild project**: First, identify the CodeBuild project for which you want to remediate the EC2 Minimum Healthy Hosts Fleet Percentage misconfiguration.

2. **Update the CodeBuild project**: Use the AWS CLI command `update-project` to update the CodeBuild project configuration with the desired minimum healthy hosts fleet percentage. Here's an example command to update the CodeBuild project:

```bash
aws codebuild update-project --name <project-name> --environment "computeType=BUILD_GENERAL1_SMALL,image=aws/codebuild/standard:4.0,minimumHealthyHosts=50"
```

Replace `<project-name>` with the actual name of your CodeBuild project. In the `environment` parameter, specify the `minimumHealthyHosts` value as per your requirements. In the example command above, it's set to `50`.

3. **Verify the configuration**: After running the `update-project` command, verify the CodeBuild project configuration to ensure that the minimum healthy hosts fleet percentage has been successfully updated. You can use the `describe-projects` command to check the configuration:

```bash
aws codebuild describe-projects --names <project-name>
```

Replace `<project-name>` with the name of your CodeBuild project. Check the output to confirm that the `minimumHealthyHosts` value has been updated to the desired percentage.

By following these steps, you can successfully remediate the EC2 Minimum Healthy Hosts Fleet Percentage misconfiguration for AWS CodeBuild using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of maintaining the minimum healthy hosts fleet percentage for AWS CodeBuild using Python, follow these steps:

1. **Create a Lambda function**: Create a new Lambda function in the AWS Management Console using Python. This Lambda function will be triggered by CloudWatch Events on a schedule.

2. **Add Lambda function code**: Write Python code in the Lambda function that will check the current status of the CodeBuild project and adjust the minimum healthy hosts fleet percentage if it is not within the desired range. Here is an example code snippet to get you started:

```python
import boto3

def lambda_handler(event, context):
    codebuild = boto3.client('codebuild')
    
    project_name = 'YOUR_CODEBUILD_PROJECT_NAME'
    desired_percentage = 80  # Set your desired minimum healthy hosts fleet percentage
    
    response = codebuild.batch_get_projects(names=[project_name])
    project = response['projects'][0]
    
    if 'computeType' in project and 'environmentVariables' in project['computeType']:
        for var in project['computeType']['environmentVariables']:
            if var['name'] == 'MIN_HEALTHY_HOSTS_FLEET_PERCENTAGE':
                current_percentage = int(var['value'])
                if current_percentage != desired_percentage:
                    var['value'] = str(desired_percentage)
                    codebuild.update_project(name=project_name, environment={'environmentVariables': project['computeType']['environmentVariables']})
                    print(f"Minimum healthy hosts fleet percentage updated to {desired_percentage}% for {project_name}")
                    break
```

3. **Set up CloudWatch Events trigger**: In the AWS Management Console, create a new CloudWatch Events rule that triggers the Lambda function at a desired schedule (e.g., every hour).

4. **Test the remediation**: Manually trigger the Lambda function to test if it updates the minimum healthy hosts fleet percentage for the specified CodeBuild project.

By following these steps, you can automatically remediate the misconfiguration of maintaining the minimum healthy hosts fleet percentage for AWS CodeBuild using Python and ensure that it stays within the desired range.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

