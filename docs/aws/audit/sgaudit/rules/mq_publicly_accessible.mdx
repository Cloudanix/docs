---
slug: mq_publicly_accessible
title: MQ Broker Should Not Be Publicly Accessible
sidebar_label: MQ Broker Should Not Be Publicly Accessible
---

### More Info:

MQ brokers should not be launched into public cloud. Unless there is a specific business requirement, MQ Brokers should not have a public endpoint and should be accessed from within a VPC only.

### Risk Level

Medium

### Address

Security

### Compliance Standards

GDPR, HITRUST, SOC2


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent an Amazon MQ Broker from being publicly accessible in Security Groups using the AWS Management Console, follow these steps:

1. **Navigate to the Amazon MQ Console:**
   - Open the AWS Management Console.
   - In the search bar, type "Amazon MQ" and select it from the list of services.

2. **Select the Broker:**
   - In the Amazon MQ console, you will see a list of your brokers.
   - Click on the name of the broker you want to configure.

3. **Modify Security Groups:**
   - In the broker details page, locate the "Security and network" section.
   - Click on the security group associated with your broker to open the Amazon EC2 console.

4. **Edit Inbound Rules:**
   - In the Amazon EC2 console, select the security group associated with your broker.
   - Click on the "Inbound rules" tab.
   - Ensure that there are no rules allowing public access (i.e., 0.0.0.0/0 or ::/0) to the broker ports.
   - Modify or remove any such rules to restrict access to specific IP addresses or CIDR blocks that are trusted.

By following these steps, you can ensure that your Amazon MQ Broker is not publicly accessible, thereby enhancing its security.
</Accordion>

<Accordion title='Using CLI'>
To prevent an Amazon MQ Broker from being publicly accessible in Security Groups using AWS CLI, you can follow these steps:

1. **Identify the Security Group associated with the MQ Broker:**
   First, you need to identify the security group that is associated with your MQ Broker. You can do this by describing the MQ Broker and noting the security group ID.

   ```sh
   aws mq describe-broker --broker-id <your-broker-id>
   ```

2. **Describe the Security Group to check for public access:**
   Once you have the security group ID, describe the security group to check for any rules that allow public access (i.e., CIDR range `0.0.0.0/0`).

   ```sh
   aws ec2 describe-security-groups --group-ids <your-security-group-id>
   ```

3. **Revoke Inbound Rules that allow public access:**
   If you find any inbound rules that allow public access, revoke them. For example, if there is a rule allowing access from `0.0.0.0/0` on port 5671 (default port for MQ), you can revoke it using the following command:

   ```sh
   aws ec2 revoke-security-group-ingress --group-id <your-security-group-id> --protocol tcp --port 5671 --cidr 0.0.0.0/0
   ```

4. **Add Inbound Rules to restrict access:**
   Add more restrictive inbound rules to allow access only from specific IP addresses or CIDR ranges that you trust. For example, to allow access only from a specific IP address `203.0.113.0` on port 5671:

   ```sh
   aws ec2 authorize-security-group-ingress --group-id <your-security-group-id> --protocol tcp --port 5671 --cidr 203.0.113.0/32
   ```

By following these steps, you can ensure that your Amazon MQ Broker is not publicly accessible and is only accessible from trusted IP addresses.
</Accordion>

<Accordion title='Using Python'>
To prevent an MQ Broker from being publicly accessible in Security Groups using Python scripts, you can use the respective SDKs for AWS, Azure, and GCP. Below are the steps and example scripts for each cloud provider:

### AWS (Using Boto3)

1. **Install Boto3**:
   ```bash
   pip install boto3
   ```

2. **Create a Python script to modify the security group**:
   ```python
   import boto3

   ec2 = boto3.client('ec2')

   def make_mq_broker_private(security_group_id):
       # Revoke public access (0.0.0.0/0) for all ports
       ec2.revoke_security_group_ingress(
           GroupId=security_group_id,
           IpPermissions=[
               {
                   'IpProtocol': '-1',
                   'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
               }
           ]
       )
       print(f"Public access revoked for security group {security_group_id}")

   # Example usage
   make_mq_broker_private('sg-0123456789abcdef0')
   ```

### Azure (Using Azure SDK for Python)

1. **Install Azure SDK**:
   ```bash
   pip install azure-mgmt-network
   ```

2. **Create a Python script to modify the network security group**:
   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.network import NetworkManagementClient

   subscription_id = 'your_subscription_id'
   resource_group_name = 'your_resource_group_name'
   nsg_name = 'your_nsg_name'

   credential = DefaultAzureCredential()
   network_client = NetworkManagementClient(credential, subscription_id)

   def make_mq_broker_private():
       nsg = network_client.network_security_groups.get(resource_group_name, nsg_name)
       for rule in nsg.security_rules:
           if rule.destination_address_prefix == 'Internet':
               rule.destination_address_prefix = 'Private'
               network_client.security_rules.create_or_update(resource_group_name, nsg_name, rule.name, rule)
               print(f"Updated rule {rule.name} to be private")

   # Example usage
   make_mq_broker_private()
   ```

### GCP (Using Google Cloud Python Client Library)

1. **Install Google Cloud Python Client Library**:
   ```bash
   pip install google-cloud-compute
   ```

2. **Create a Python script to modify the firewall rules**:
   ```python
   from google.cloud import compute_v1

   def make_mq_broker_private(project_id, firewall_rule_name):
       client = compute_v1.FirewallsClient()
       firewall = client.get(project=project_id, firewall=firewall_rule_name)
       
       # Remove 0.0.0.0/0 from allowed IP ranges
       for allowed in firewall.allowed:
           if '0.0.0.0/0' in allowed.source_ranges:
               allowed.source_ranges.remove('0.0.0.0/0')
               allowed.source_ranges.append('10.0.0.0/8')  # Example private range
       
       client.update(project=project_id, firewall=firewall_rule_name, firewall_resource=firewall)
       print(f"Updated firewall rule {firewall_rule_name} to be private")

   # Example usage
   make_mq_broker_private('your_project_id', 'your_firewall_rule_name')
   ```

These scripts will help you modify the security configurations to ensure that your MQ Broker is not publicly accessible. Make sure to replace placeholders with your actual cloud resource identifiers.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the Amazon MQ console.

2. In the navigation pane, choose "Brokers". This will display a list of all your Amazon MQ brokers.

3. Select the broker that you want to check. This will open the broker's details page.

4. In the broker's details page, check the "Public accessibility" setting. If it is set to "Yes", then the broker is publicly accessible. If it is set to "No", then the broker is not publicly accessible.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is set up, you can list all the Amazon MQ brokers in your account by using the following command:

   ```
   aws mq list-brokers
   ```

   This command will return a list of all the brokers in your account.

3. For each broker, you can describe the broker to get more details about it. Use the following command:

   ```
   aws mq describe-broker --broker-id <Broker-ID>
   ```

   Replace `<Broker-ID>` with the ID of the broker you want to inspect. This command will return a JSON object with details about the broker.

4. In the returned JSON object, look for the `PubliclyAccessible` field. If the value of this field is `true`, then the broker is publicly accessible, which is a misconfiguration. If the value is `false`, then the broker is not publicly accessible, which is the correct configuration.
</Accordion>

<Accordion title='Using Python'>
1. Install the necessary Python libraries: Before you start, you need to install the necessary Python libraries. You will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

```python
pip install boto3
```

2. Set up AWS credentials: You need to configure your AWS credentials. You can do this by creating the credentials file yourself. By default, its location is at ~/.aws/credentials. At a minimum, the credentials file should look like this:

```python
[default]
aws_access_key_id = YOUR_ACCESS_KEY
aws_secret_access_key = YOUR_SECRET_KEY
```

3. Python script to detect misconfiguration: Now, you can use the following Python script to detect if the MQ Broker is publicly accessible:

```python
import boto3

def check_mq_broker_public_accessibility():
    client = boto3.client('mq')

    response = client.list_brokers()

    for broker in response['BrokerSummaries']:
        broker_response = client.describe_broker(BrokerId=broker['BrokerId'])
        if broker_response['PubliclyAccessible']:
            print(f"MQ Broker {broker['BrokerId']} is publicly accessible.")

check_mq_broker_public_accessibility()
```

This script first lists all the MQ Brokers in your AWS account. Then, for each broker, it checks if the 'PubliclyAccessible' attribute is True. If it is, it prints a message indicating that the broker is publicly accessible.

4. Run the script: Finally, you can run the script using a Python interpreter. If there are any MQ Brokers that are publicly accessible, they will be printed out. If not, nothing will be printed. This way, you can easily detect if there are any misconfigurations in your AWS account.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of an MQ Broker being publicly accessible in AWS Security Groups, follow these steps using the AWS Management Console:

1. **Log in to the AWS Management Console**: Go to https://aws.amazon.com/ and log in to your AWS account.

2. **Navigate to the Amazon MQ Service**: Click on the "Services" dropdown menu at the top left corner of the console, then select "Amazon MQ" under the "Messaging" category.

3. **Select the MQ Broker**: In the Amazon MQ dashboard, select the MQ Broker that is publicly accessible.

4. **Update Security Group Rules**:
   - In the left-hand navigation pane, click on "Configuration" and then select the "Security groups" tab.
   - Click on the security group that is associated with the MQ Broker.

5. **Edit Inbound Rules**:
   - In the "Inbound rules" tab, review the existing rules that allow public access to the MQ Broker.
   - Identify the rule(s) that allow access from any IP address (0.0.0.0/0) or from unauthorized IP ranges.

6. **Remove Public Access**:
   - Select the rule(s) that allow public access to the MQ Broker.
   - Click on the "Actions" dropdown menu and choose "Edit inbound rules".
   - Remove the rule(s) that allow access from any IP address or unauthorized IP ranges.
   - Add specific IP ranges or security groups that are allowed to access the MQ Broker if necessary.

7. **Save Changes**: Click on the "Save rules" button to apply the changes to the security group.

8. **Verify Changes**:
   - Go back to the Amazon MQ dashboard and check the security group settings for the MQ Broker to ensure that public access has been restricted.
   - Test the connectivity to the MQ Broker to ensure that it is only accessible from authorized sources.

By following these steps, you can remediate the misconfiguration of an MQ Broker being publicly accessible in AWS Security Groups and restrict access to authorized entities only.
</Accordion>

<Accordion title='Using CLI'>
#

To remediate the misconfiguration of making an MQ Broker publicly accessible in AWS using AWS CLI, you can follow these steps:

1. List the existing security groups associated with your MQ Broker:
```
aws mq list-brokers
```

2. Identify the security group associated with the MQ Broker that is publicly accessible:
```
aws mq describe-broker --broker-id <your-broker-id>
```

3. Note down the Security Group ID associated with the MQ Broker.

4. Update the inbound rules of the Security Group to restrict access only to the necessary IP addresses or CIDR blocks. Replace `<security-group-id>` with the Security Group ID noted in step 3 and `<your-ip>` with your IP address:
```
aws ec2 authorize-security-group-ingress --group-id <security-group-id> --protocol tcp --port 8162 --cidr <your-ip>/32
```

5. Verify that the inbound rule has been updated successfully:
```
aws ec2 describe-security-groups --group-ids <security-group-id>
```

6. Repeat steps 4 and 5 for any other necessary ports (e.g., 61614 for AMQP, 5671 for MQTT, etc.) to ensure that only the required ports are accessible.

By following these steps, you can remediate the misconfiguration of making an MQ Broker publicly accessible in AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of an MQ Broker being publicly accessible in AWS using Python, you can follow these steps:

1. **Identify the Security Group**: First, you need to identify the Security Group associated with the MQ Broker.

2. **Update Security Group Rules**: You will need to update the inbound rules of the Security Group to restrict access to the MQ Broker to only the necessary IP addresses or ranges.

3. **Revoke Public Access**: Remove the existing rule that allows public access to the MQ Broker.

Here is a sample Python script to achieve this:

```python
import boto3

# Define the region and the security group ID associated with the MQ Broker
region = 'your_region'
security_group_id = 'your_security_group_id'

# Create a Boto3 client for EC2
ec2_client = boto3.client('ec2', region_name=region)

# Revoke the existing rule that allows public access to the MQ Broker
response = ec2_client.revoke_security_group_ingress(
    GroupId=security_group_id,
    IpPermissions=[
        {
            'IpProtocol': 'tcp',
            'FromPort': 8161,  # Assuming default port for MQ Broker
            'ToPort': 8161,
            'IpRanges': [{'CidrIp': '0.0.0.0/0'}]  # Restrict this as per your requirement
        }
    ]
)

print("Public access to the MQ Broker has been revoked.")
```

Make sure to replace `'your_region'` and `'your_security_group_id'` with the appropriate values for your environment.

After running this script, the Security Group associated with the MQ Broker will be updated to revoke public access, thereby remedying the misconfiguration of the MQ Broker being publicly accessible in AWS.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/accessing-web-console-of-broker-without-public-accessibility.html](https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/accessing-web-console-of-broker-without-public-accessibility.html) 

