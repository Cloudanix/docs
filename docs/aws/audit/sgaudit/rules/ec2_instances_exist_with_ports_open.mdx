---
slug: ec2_instances_exist_with_ports_open
title: Ports Should Not Be Open for External Traffic
sidebar_label: Ports Should Not Be Open for External Traffic
---

### More Info:

Security groups should not have all ports or protocols open to the public. Security groups should be created on a per-service basis and avoid allowing all ports or protocols.

### Risk Level

Medium

### Address

Security

### Compliance Standards

NIST



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and open the Amazon VPC console at https://console.aws.amazon.com/vpc/.

2. In the navigation pane, choose 'Security Groups'.

3. Select the security group that you want to verify.

4. In the details pane, on the 'Inbound rules' tab, check the 'Source' column. If it is set to '0.0.0.0/0' or '::/0', it means that the port is open for external traffic.

5. Repeat the process for all security groups in all regions and all VPCs.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine. You can download it from the official AWS website. After installation, you need to configure it with your AWS account credentials. You can do this by running the command `aws configure` and then entering your AWS Access Key ID, Secret Access Key, Default region name, and Default output format when prompted.

2. List all security groups: Use the following command to list all the security groups in your AWS account.

   ```
   aws ec2 describe-security-groups --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"
   ```

3. Check for open ports: For each security group, check the inbound rules to see if any ports are open for external traffic. You can do this using the following command, replacing `SECURITY_GROUP_ID` with the ID of the security group you want to check.

   ```
   aws ec2 describe-security-groups --group-ids SECURITY_GROUP_ID --query 'SecurityGroups[*].IpPermissions[*].{IP:IpRanges,Port:FromPort}'
   ```

4. Analyze the output: The output of the above command will show you the IP ranges and ports that are open for each security group. If the IP range is `0.0.0.0/0` or `::/0`, it means that the port is open to the entire internet. If the port number is in the range of well-known ports (0-1023), registered ports (1024-49151), or dynamic or private ports (49152-65535), it means that the port is open for external traffic.

#### Using Python

1. **AWS:**

   You can use the boto3 library in Python to interact with AWS services. Here is a script to check if any ports are open for external traffic in security groups:

   ```python
   import boto3

   ec2 = boto3.resource('ec2')

   for security_group in ec2.security_groups.all():
       for permission in security_group.ip_permissions:
           for ip_range in permission['IpRanges']:
               if ip_range['CidrIp'] == '0.0.0.0/0':
                   print(f"Security Group {security_group.id} has an open port.")
   ```
   
2. **Azure:**

   You can use the Azure SDK for Python to interact with Azure services. Here is a script to check if any ports are open for external traffic in Network Security Groups:

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.network import NetworkManagementClient

   credential = DefaultAzureCredential()
   subscription_id = 'your-subscription-id'
   network_client = NetworkManagementClient(credential, subscription_id)

   for nsg in network_client.network_security_groups.list_all():
       for rule in nsg.security_rules:
           if rule.destination_address_prefix == '*' and rule.access == 'Allow':
               print(f"Network Security Group {nsg.name} has an open port.")
   ```
   
3. **GCP:**

   You can use the google-cloud-sdk library in Python to interact with GCP services. Here is a script to check if any ports are open for external traffic in Firewall rules:

   ```python
   from google.cloud import compute_v1

   client = compute_v1.FirewallsClient()

   for firewall in client.list(project='your-project-id'):
       for rule in firewall.allowed:
           if '0.0.0.0/0' in rule['IPProtocol']:
               print(f"Firewall {firewall.name} has an open port.")
   ```
   
Please replace 'your-subscription-id' and 'your-project-id' with your actual Azure subscription ID and GCP project ID respectively.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of ports being open for external traffic in AWS Security Groups, follow these steps using the AWS Management Console:

1. Sign in to the AWS Management Console.
2. Navigate to the EC2 dashboard.
3. In the navigation pane, under the 'Network & Security' section, click on 'Security Groups'.
4. Select the security group that has the open ports for external traffic that you want to remediate.
5. Click on the 'Inbound rules' tab.
6. Identify the rule that allows external traffic (0.0.0.0/0) to access the specific port(s).
7. Click on the 'Edit inbound rules' button.
8. Select the rule that allows the unwanted external traffic and click on the 'Delete' button to remove it.
9. Click on the 'Save rules' button to apply the changes.
10. Verify that the rule allowing external traffic to the specific port(s) has been removed successfully.

By following these steps, you have successfully remediated the issue of ports being open for external traffic in the AWS Security Group.

#### Using CLI

To remediate the issue of ports being open for external traffic in AWS Security Groups using AWS CLI, follow these steps:

1. Identify the security group that has the open port for external traffic. You can use the following AWS CLI command to list all security groups in your AWS account:
```
aws ec2 describe-security-groups
```

2. Once you have identified the security group that needs to be remediated, note down the Group ID of the security group.

3. Use the following AWS CLI command to revoke the ingress rule that allows external traffic to the port in the security group. Replace `<group-id>` and `<ip-permission-id>` with the actual values:
```
aws ec2 revoke-security-group-ingress --group-id <group-id> --ip-permissions '[{"IpProtocol": "tcp", "FromPort": <port-number>, "ToPort": <port-number>, "IpRanges": [{"CidrIp": "0.0.0.0/0"}], "IpPermissionId": "<ip-permission-id>"}]'
```

4. Verify that the ingress rule has been revoked successfully by describing the security group again:
```
aws ec2 describe-security-groups --group-ids <group-id>
```

5. Repeat the above steps for any other security groups that have open ports for external traffic.

By following the above steps, you can successfully remediate the issue of ports being open for external traffic in AWS Security Groups using AWS CLI.

#### Using Python

To remediate the issue of ports being open for external traffic in AWS Security Groups using Python, you can use the AWS SDK for Python (Boto3) to update the security group rules. Here are the step-by-step instructions to remediate this issue:

1. Install the Boto3 library if you haven't already:

```bash
pip install boto3
```

2. Use the following Python script to identify and close the open ports in the security groups:

```python
import boto3

# Initialize the EC2 client
ec2 = boto3.client('ec2')

# Define the security group ID that you want to remediate
security_group_id = 'YOUR_SECURITY_GROUP_ID'

# Describe the current inbound rules of the security group
response = ec2.describe_security_groups(GroupIds=[security_group_id])

# Iterate over each inbound rule and revoke the open ports
for rule in response['SecurityGroups'][0]['IpPermissions']:
    if 'FromPort' in rule and 'ToPort' in rule:
        from_port = rule['FromPort']
        to_port = rule['ToPort']
        if from_port != to_port:
            ec2.revoke_security_group_ingress(
                GroupId=security_group_id,
                IpPermissions=[{
                    'FromPort': from_port,
                    'ToPort': to_port,
                    'IpProtocol': rule['IpProtocol'],
                    'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
                }]
            )
        else:
            ec2.revoke_security_group_ingress(
                GroupId=security_group_id,
                IpPermissions=[{
                    'FromPort': from_port,
                    'ToPort': to_port,
                    'IpProtocol': rule['IpProtocol'],
                    'IpRanges': [{'CidrIp': '0.0.0.0/0'}]
                }]
            )

print("Security group remediated successfully.")
```

3. Replace `'YOUR_SECURITY_GROUP_ID'` with the actual ID of the security group that you want to remediate.

4. Run the Python script. It will iterate over each inbound rule in the specified security group and revoke the open ports for external traffic.

By following these steps, you can remediate the issue of open ports for external traffic in AWS Security Groups using Python and the Boto3 library.

### Additional Reading:

- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html) 


</Tab>
</Tabs>