---
slug: mq_rabbit_deployment_mode
title: MQ Rabbit Has Deployment Mode.
sidebar_label: MQ Rabbit Has Deployment Mode.
---

### More Info:

This rule checks the deployment mode configured for the Amazon MQ RabbitMQ broker engine. The rule is NON_COMPLIANT if the default single-instance broker mode is being used.

### Risk Level

Low

### Address

Configuration

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the EC2 Dashboard.
2. In the left navigation pane, under Network & Security, click on "Security Groups".
3. In the Security Groups page, you will see a list of all security groups. Find the security group associated with your RabbitMQ deployment.
4. Check the Inbound and Outbound rules of the security group. If the security group is misconfigured, it may allow unrestricted access (0.0.0.0/0) to the RabbitMQ ports (5672 and 15672). This is a misconfiguration as it exposes the RabbitMQ server to the public internet.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can use the "describe-security-groups" command to list all the security groups in your AWS account. The command is as follows:

   ```
   aws ec2 describe-security-groups
   ```

   This command will return a JSON output with details of all the security groups.

3. To check if MQ Rabbit has a deployment mode, you need to look for the security group associated with it. You can filter the security groups using the "query" option in the AWS CLI command. Replace "your-security-group-id" with the ID of your security group:

   ```
   aws ec2 describe-security-groups --group-ids your-security-group-id
   ```

4. The output will contain a section named "IpPermissions". This section contains all the inbound rules for the security group. If MQ Rabbit has a deployment mode, there should be an inbound rule allowing traffic on the port that MQ Rabbit uses for deployment mode. You can manually inspect this section to check for the rule. If the rule is not present, then MQ Rabbit does not have a deployment mode.
</Accordion>

<Accordion title='Using Python'>
To check if MQ Rabbit has a deployment mode in Security Groups using Python scripts, you can use the Boto3 library for AWS. Here are the steps:

1. **Install Boto3**: Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc. You can install it using pip:
   ```python
   pip install boto3
   ```

2. **Configure AWS Credentials**: Before you can start using Boto3, you need to set up authentication credentials for your AWS account using either the AWS CLI or by creating the credentials file yourself. The default location for the file is `~/.aws/credentials`. At the very least, the credentials file should specify the access key and secret access key. To specify these for the `default` profile, you can use the following format:
   ```python
   [default]
   aws_access_key_id = YOUR_ACCESS_KEY
   aws_secret_access_key = YOUR_SECRET_KEY
   ```

3. **Create a Python Script to List Security Groups**: You can use the `describe_security_groups` method to retrieve information about the security groups in your AWS environment. Here is a simple script that lists all security groups:
   ```python
   import boto3

   ec2 = boto3.client('ec2')

   response = ec2.describe_security_groups()

   print(response)
   ```

4. **Check for MQ Rabbit Deployment Mode**: Now, you need to modify the script to check if the MQ Rabbit has a deployment mode. You can do this by iterating over the security groups and checking the `GroupName` or `GroupId` depending on how you have set up your environment. Here is a simple script that checks if a security group with the name 'MQ_Rabbit_Deployment_Mode' exists:
   ```python
   import boto3

   ec2 = boto3.client('ec2')

   response = ec2.describe_security_groups()

   for group in response['SecurityGroups']:
       if group['GroupName'] == 'MQ_Rabbit_Deployment_Mode':
           print('MQ Rabbit has a deployment mode in Security Groups')
           break
   else:
       print('MQ Rabbit does not have a deployment mode in Security Groups')
   ```

Please note that this is a very basic script and might need to be adjusted based on your specific environment and requirements. For example, you might need to handle pagination if you have more than a certain number of security groups.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the misconfiguration of having "MQ Rabbit Has Deployment Mode" for AWS Security Groups using the AWS console, you can follow these step-by-step instructions:

1. **Login to AWS Console:**
   - Go to the AWS Management Console (https://aws.amazon.com/console/) and log in to your AWS account.

2. **Navigate to the EC2 Service:**
   - In the AWS Management Console, navigate to the EC2 service by clicking on "Services" in the top left corner and selecting "EC2" under the Compute section.

3. **Select Security Groups:**
   - In the EC2 Dashboard, locate and click on "Security Groups" in the navigation pane on the left side of the screen.

4. **Identify the Security Group:**
   - Identify the specific security group associated with the MQ Rabbit service that has the deployment mode misconfiguration.

5. **Edit Inbound Rules:**
   - Select the identified security group by clicking on the checkbox next to it, and then click on the "Inbound Rules" tab at the bottom of the page.

6. **Review and Modify Inbound Rules:**
   - Review the inbound rules configured for the security group. Look for any rules that allow unrestricted access (0.0.0.0/0) to the MQ Rabbit service or any other services that should not have public access.
  
7. **Update Inbound Rules:**
   - Modify the inbound rules to restrict access to only the necessary IP addresses or ranges that require access to the MQ Rabbit service. Remove any rules that allow access from all IP addresses (0.0.0.0/0) unless absolutely necessary.

8. **Save Changes:**
   - Once you have updated the inbound rules to restrict access appropriately, click on the "Save rules" or "Save" button to apply the changes to the security group.

9. **Verify Changes:**
   - After saving the changes, verify that the inbound rules have been updated successfully and that the deployment mode misconfiguration for the MQ Rabbit service has been remediated.

By following these steps and ensuring that the security group associated with the MQ Rabbit service has the correct inbound rules configured, you can remediate the misconfiguration of having "MQ Rabbit Has Deployment Mode" for AWS Security Groups.
</Accordion>

<Accordion title='Using CLI'>
#

To remediate the misconfiguration of MQ Rabbit having deployment mode set in AWS Security Groups using AWS CLI, follow these steps:

1. **Identify the Security Group**: First, you need to identify the Security Group associated with the MQ Rabbit instance that has the deployment mode misconfiguration.

2. **Get the existing Security Group rules**: Use the following AWS CLI command to get the details of the existing Security Group rules:
   ```
   aws ec2 describe-security-groups --group-ids YOUR_SECURITY_GROUP_ID
   ```

3. **Update Security Group Rule**: You will need to update the Security Group rule to ensure that the deployment mode is correctly configured. Use the following AWS CLI command to update the Security Group rule:
   ```
   aws ec2 authorize-security-group-ingress --group-id YOUR_SECURITY_GROUP_ID --protocol tcp --port YOUR_PORT_NUMBER --cidr YOUR_CIDR_IP_RANGE
   ```
   Replace the placeholders with the actual values:
   - `YOUR_SECURITY_GROUP_ID`: The ID of the Security Group associated with the MQ Rabbit instance.
   - `YOUR_PORT_NUMBER`: The port number used by MQ Rabbit.
   - `YOUR_CIDR_IP_RANGE`: The CIDR IP range that should be allowed to access the MQ Rabbit instance.

4. **Verify the Changes**: After updating the Security Group rule, verify the changes by running the `describe-security-groups` command again to ensure that the deployment mode misconfiguration has been remediated.

5. **Monitor for Compliance**: Regularly monitor the Security Groups associated with the MQ Rabbit instance to ensure that the deployment mode remains correctly configured and no unauthorized changes are made.

By following these steps, you can remediate the misconfiguration of MQ Rabbit having deployment mode set in AWS Security Groups using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration of having "MQ Rabbit Has Deployment Mode" for AWS Security Groups using Python, you can follow these steps:

Step 1: Install the necessary Python libraries
Ensure you have the AWS SDK for Python (Boto3) installed. You can install it using pip:
```bash
pip install boto3
```

Step 2: Write a Python script to update the Security Group configuration
You can use the following Python script as a template to update the Security Group configuration:

```python
import boto3

# Initialize the Boto3 client for EC2
ec2_client = boto3.client('ec2')

# Specify the Security Group ID that needs to be remediated
security_group_id = 'YOUR_SECURITY_GROUP_ID'

# Describe the existing Security Group configuration
response = ec2_client.describe_security_groups(GroupIds=[security_group_id])

# Update the Security Group configuration to remove the "MQ Rabbit Has Deployment Mode"
for group in response['SecurityGroups']:
    for permission in group['IpPermissions']:
        if 'FromPort' in permission and permission['FromPort'] == 5672 and 'ToPort' in permission and permission['ToPort'] == 5672:
            group['IpPermissions'].remove(permission)

# Apply the updated Security Group configuration
ec2_client.authorize_security_group_ingress(
    GroupId=security_group_id,
    IpPermissions=group['IpPermissions']
)

print(f"Security Group {security_group_id} has been successfully remediated.")
```

Step 3: Update the script with your Security Group ID
Replace `'YOUR_SECURITY_GROUP_ID'` in the script with the actual Security Group ID that needs to be remediated.

Step 4: Run the Python script
Save the script to a file (e.g., `remediate_security_group.py`) and run it using Python:
```bash
python remediate_security_group.py
```

This script will update the specified Security Group configuration to remove the "MQ Rabbit Has Deployment Mode" misconfiguration for AWS Security Groups using Python.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>

