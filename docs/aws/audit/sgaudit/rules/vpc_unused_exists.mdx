---
slug: vpc_unused_exists
title: Unused Virtual Private Gateways Should Be Removed
sidebar_label: Unused Virtual Private Gateways Should Be Removed
---

### More Info:

Unused Amazon Virtual Private Gateways should be removed in order to adhere to best practices and to avoid reaching the service limit.

### Risk Level

Low

### Address

Operational Maturity, Security

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent unused Virtual Private Gateways (VPGs) in AWS Security Groups using the AWS Management Console, follow these steps:

1. **Identify Unused VPGs:**
   - Navigate to the **VPC Dashboard** in the AWS Management Console.
   - In the left-hand navigation pane, select **Virtual Private Gateways**.
   - Review the list of VPGs and identify any that are not attached to a VPC or are not in use.

2. **Review Security Groups:**
   - Go to the **EC2 Dashboard**.
   - In the left-hand navigation pane, select **Security Groups**.
   - Review the security groups to ensure that they do not have rules that reference the unused VPGs.

3. **Update Security Group Rules:**
   - For each security group, select the group and navigate to the **Inbound Rules** and **Outbound Rules** tabs.
   - Remove any rules that reference the unused VPGs.

4. **Monitor and Automate:**
   - Set up AWS Config rules to monitor for unused VPGs and security group rules referencing them.
   - Use AWS CloudWatch to create alarms and notifications for any detected unused VPGs.

By following these steps, you can ensure that unused Virtual Private Gateways are identified and removed from security groups, thereby maintaining a secure and efficient AWS environment.
</Accordion>

<Accordion title='Using CLI'>
To prevent unused Virtual Private Gateways (VPGs) in AWS using the AWS CLI, you can follow these steps:

1. **List All Virtual Private Gateways:**
   First, identify all the Virtual Private Gateways in your account to determine which ones are currently in use and which ones are not.

   ```sh
   aws ec2 describe-vpn-gateways --query 'VpnGateways[*].{ID:VpnGatewayId,State:State,Attachments:VpcAttachments}'
   ```

2. **Check Attachments:**
   For each Virtual Private Gateway, check if it is attached to any VPC. If a VPG is not attached to any VPC, it is considered unused.

   ```sh
   aws ec2 describe-vpn-gateways --vpn-gateway-ids <vpn-gateway-id> --query 'VpnGateways[*].VpcAttachments'
   ```

3. **Tagging for Monitoring:**
   Tag the Virtual Private Gateways with a specific tag to indicate their status (e.g., "Status: Unused" or "Status: InUse"). This helps in monitoring and managing them effectively.

   ```sh
   aws ec2 create-tags --resources <vpn-gateway-id> --tags Key=Status,Value=Unused
   ```

4. **Automate Monitoring:**
   Set up a scheduled AWS Lambda function or a CloudWatch rule to periodically check for unused Virtual Private Gateways and alert you or take action based on the tags.

   Example Lambda function snippet (Python):

   ```python
   import boto3

   def lambda_handler(event, context):
       ec2 = boto3.client('ec2')
       response = ec2.describe_vpn_gateways()
       for vpn_gateway in response['VpnGateways']:
           if not vpn_gateway['VpcAttachments']:
               ec2.create_tags(
                   Resources=[vpn_gateway['VpnGatewayId']],
                   Tags=[{'Key': 'Status', 'Value': 'Unused'}]
               )
   ```

By following these steps, you can effectively prevent and manage unused Virtual Private Gateways in your AWS environment using the AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To prevent unused Virtual Private Gateways (VPGs) in security groups using Python scripts, you can follow these steps:

### 1. **Set Up Your Environment**
Ensure you have the necessary libraries installed and configured for AWS, Azure, and GCP. For AWS, you will use `boto3`, for Azure, you will use `azure-mgmt-network`, and for GCP, you will use `google-cloud-compute`.

```bash
pip install boto3 azure-mgmt-network google-cloud-compute
```

### 2. **AWS: Identify and Remove Unused VPGs**

```python
import boto3

def remove_unused_vpgs_aws():
    ec2_client = boto3.client('ec2')
    
    # Describe all VPGs
    vpgs = ec2_client.describe_vpn_gateways()
    
    for vpg in vpgs['VpnGateways']:
        if vpg['State'] == 'available' and not vpg['VpcAttachments']:
            # Delete the unused VPG
            ec2_client.delete_vpn_gateway(VpnGatewayId=vpg['VpnGatewayId'])
            print(f"Deleted unused VPG: {vpg['VpnGatewayId']}")

remove_unused_vpgs_aws()
```

### 3. **Azure: Identify and Remove Unused VPGs**

```python
from azure.identity import DefaultAzureCredential
from azure.mgmt.network import NetworkManagementClient

def remove_unused_vpgs_azure(subscription_id):
    credential = DefaultAzureCredential()
    network_client = NetworkManagementClient(credential, subscription_id)
    
    # List all VPGs
    vpgs = network_client.virtual_network_gateways.list_all()
    
    for vpg in vpgs:
        if not vpg.ip_configurations:
            # Delete the unused VPG
            network_client.virtual_network_gateways.begin_delete(vpg.resource_group_name, vpg.name)
            print(f"Deleted unused VPG: {vpg.name}")

subscription_id = 'your_subscription_id'
remove_unused_vpgs_azure(subscription_id)
```

### 4. **GCP: Identify and Remove Unused VPGs**

```python
from google.cloud import compute_v1

def remove_unused_vpgs_gcp(project_id):
    client = compute_v1.VpnGatewaysClient()
    
    # List all VPGs
    vpgs = client.list(project=project_id, region='your-region')
    
    for vpg in vpgs:
        if not vpg.vpn_tunnels:
            # Delete the unused VPG
            client.delete(project=project_id, region='your-region', vpn_gateway=vpg.name)
            print(f"Deleted unused VPG: {vpg.name}")

project_id = 'your_project_id'
remove_unused_vpgs_gcp(project_id)
```

### Summary
1. **Set Up Your Environment**: Install necessary libraries.
2. **AWS**: Use `boto3` to identify and remove unused VPGs.
3. **Azure**: Use `azure-mgmt-network` to identify and remove unused VPGs.
4. **GCP**: Use `google-cloud-compute` to identify and remove unused VPGs.

These scripts will help you automate the process of identifying and removing unused Virtual Private Gateways in AWS, Azure, and GCP, thereby preventing misconfigurations.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console.
2. Navigate to the VPC Dashboard by selecting "Services" from the top menu, then choosing "VPC" under the "Networking & Content Delivery" category.
3. In the VPC Dashboard, select "Virtual Private Gateways" from the left-hand menu. This will display a list of all Virtual Private Gateways associated with your AWS account.
4. Check the "State" column for each Virtual Private Gateway. If the state is listed as "detached", this indicates that the Virtual Private Gateway is unused and should be removed.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the resources.

2. Once the AWS CLI is set up, you can list all the Virtual Private Gateways in your account using the following command:

   ```
   aws ec2 describe-vpn-gateways
   ```

   This command will return a JSON output with details of all the VPN gateways in your account.

3. To find unused VPN gateways, you need to check the 'VpnAttachments' field in the output. If this field is empty, it means the VPN gateway is not attached to any VPC and is unused.

   You can use the following command to filter out unused VPN gateways:

   ```
   aws ec2 describe-vpn-gateways --query 'VpnGateways[?VpnAttachments==`[]`]'
   ```

4. For a more detailed view, you can use the 'jq' command-line JSON processor to format the output. Install 'jq' if it's not already installed, and then use the following command:

   ```
   aws ec2 describe-vpn-gateways | jq -r '.VpnGateways[] | select(.VpnAttachments==[]) | .VpnGatewayId'
   ```

   This command will return the IDs of all unused VPN gateways.
</Accordion>

<Accordion title='Using Python'>
1. Install and configure AWS SDK for Python (Boto3):
   You need to install and configure Boto3 to interact with AWS services. You can install it using pip:
   ```
   pip install boto3
   ```
   Then, configure your AWS credentials either by setting environment variables `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` and `AWS_SESSION_TOKEN`, or by creating the credentials file at `~/.aws/credentials`.

2. Create a Python script to list all Virtual Private Gateways (VGWs):
   You can use the `describe_vpn_gateways` method provided by Boto3 to list all VGWs. Here is a sample script:
   ```python
   import boto3

   def list_vgws():
       ec2 = boto3.client('ec2')
       response = ec2.describe_vpn_gateways()
       return response['VpnGateways']

   print(list_vgws())
   ```
   This script will print all VGWs in your AWS account.

3. Check if VGWs are attached to a VPC:
   Each VGW in the response from `describe_vpn_gateways` has a `VpcAttachments` field. If this field is empty, the VGW is not attached to any VPC. Here is how you can modify the script to print only unused VGWs:
   ```python
   import boto3

   def list_unused_vgws():
       ec2 = boto3.client('ec2')
       response = ec2.describe_vpn_gateways()
       unused_vgws = [vgw for vgw in response['VpnGateways'] if not vgw['VpcAttachments']]
       return unused_vgws

   print(list_unused_vgws())
   ```
   This script will print all unused VGWs in your AWS account.

4. Schedule the script to run periodically:
   You can schedule the script to run periodically using a cron job or a task scheduler, depending on your operating system. This way, you can regularly check for unused VGWs and take action if any are found.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate the issue of Unused Virtual Private Gateways in AWS, you can follow these steps using the AWS Management Console:

1. **Login to AWS Console**: Navigate to the AWS Management Console at https://aws.amazon.com/ and login with your credentials.

2. **Access VPC Dashboard**: Go to the VPC dashboard by selecting the "Services" dropdown menu at the top left corner, then selecting "VPC" under the Networking & Content Delivery section.

3. **Identify Unused Virtual Private Gateways**:
   - In the VPC dashboard, click on "Virtual Private Gateways" on the left-hand side menu.
   - Review the list of Virtual Private Gateways to identify any that are not associated with any VPCs or are no longer in use.

4. **Dissociate and Delete Unused Virtual Private Gateways**:
   - Select the unused Virtual Private Gateway that you want to remove.
   - Click on the "Actions" dropdown menu and choose "Detach from VPC" to dissociate the Virtual Private Gateway from the VPC.
   - Once detached, select the Virtual Private Gateway again and click on the "Actions" dropdown menu, then choose "Delete Virtual Private Gateway" to remove it completely.

5. **Confirm Deletion**:
   - A confirmation dialog will appear asking you to confirm the deletion of the Virtual Private Gateway. Confirm the action to proceed with the deletion.

6. **Verify Removal**:
   - After deleting the Virtual Private Gateway, verify that it has been successfully removed from the list of Virtual Private Gateways in the VPC dashboard.

By following these steps, you can remediate the issue of Unused Virtual Private Gateways in AWS by identifying and removing any Virtual Private Gateways that are no longer in use.
</Accordion>

<Accordion title='Using CLI'>
#

To remediate the issue of unused Virtual Private Gateways in AWS, you can follow the steps below using AWS CLI:

1. List all the Virtual Private Gateways in your AWS account:
```
aws ec2 describe-vpn-gateways --query 'VpnGateways[?State == `available`].{ID:VpnGatewayId}'
```

2. Identify the Virtual Private Gateways that are not associated with any VPC. These are the ones that are unused.

3. To detach the Virtual Private Gateway from a VPC, you can use the following command:
```
aws ec2 detach-vpn-gateway --vpn-gateway-id <vpn-gateway-id> --vpc-id <vpc-id>
```

4. Once you have detached the Virtual Private Gateway from all VPCs, you can delete the Virtual Private Gateway using the following command:
```
aws ec2 delete-vpn-gateway --vpn-gateway-id <vpn-gateway-id>
```

5. Confirm that the Virtual Private Gateway has been deleted by listing all the Virtual Private Gateways again:
```
aws ec2 describe-vpn-gateways --query 'VpnGateways[?State == `available`].{ID:VpnGatewayId}'
```

By following these steps, you can identify and remove any unused Virtual Private Gateways in your AWS account using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the issue of unused Virtual Private Gateways in AWS using Python, you can follow these steps:

1. Use Boto3, the AWS SDK for Python, to list all the Virtual Private Gateways in your AWS account.
2. Use Boto3 to list all the VPCs in your AWS account.
3. Compare the Virtual Private Gateways with the VPCs to identify any unused Virtual Private Gateways.
4. If any Virtual Private Gateways are found to be unused, delete them using Boto3.

Here is a sample Python script to achieve this:

```python
import boto3

# Initialize the Boto3 client
ec2_client = boto3.client('ec2')

# List all Virtual Private Gateways
response = ec2_client.describe_vpn_gateways()

# List all VPCs
vpcs = ec2_client.describe_vpcs()

# Extract the VPC IDs from the VPCs response
vpc_ids = [vpc['VpcId'] for vpc in vpcs['Vpcs']]

# Identify the Virtual Private Gateways that are not associated with any VPC
unused_vpn_gateways = [vpn_gateway['VpnGatewayId'] for vpn_gateway in response['VpnGateways'] if 'VpcAttachments' not in vpn_gateway or len(vpn_gateway['VpcAttachments']) == 0]

# Delete the unused Virtual Private Gateways
for vpn_gateway_id in unused_vpn_gateways:
    ec2_client.delete_vpn_gateway(VpnGatewayId=vpn_gateway_id)
    print(f"Deleted Virtual Private Gateway: {vpn_gateway_id}")
```

Make sure you have the necessary permissions in your AWS IAM role to delete Virtual Private Gateways before running this script. Also, ensure you have installed the Boto3 library (`pip install boto3`) and configured your AWS credentials.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/vpn/latest/s2svpn/delete-vpn.html](https://docs.aws.amazon.com/vpn/latest/s2svpn/delete-vpn.html) 

