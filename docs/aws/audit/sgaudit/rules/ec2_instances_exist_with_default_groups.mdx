---
slug: ec2_instances_exist_with_default_groups
title: Default Security Groups Should Block All Traffic
sidebar_label: Default Security Groups Should Block All Traffic
---

### More Info:

Default security groups should block all traffic by default. EC2 instances should not be associated with default security groups.

### Risk Level

Medium

### Address

Security

### Compliance Standards

NIST



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the EC2 dashboard.
2. In the left navigation pane, under the "Network & Security" section, click on "Security Groups".
3. In the Security Groups page, look for the default security group of your VPC. The default security group is named as "default", and it's associated with your VPC.
4. Click on the "Inbound Rules" tab to view the inbound traffic rules. If the default security group allows all inbound traffic (0.0.0.0/0), it means it's misconfigured and not blocking all traffic. Similarly, check the "Outbound Rules". If it allows all outbound traffic (0.0.0.0/0), it's also a misconfiguration.

#### Using CLI

1. Install and configure AWS CLI: Before you can start using AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```

   You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all security groups: Once your AWS CLI is set up, you can list all the security groups in your account by running the following command:

   ```
   aws ec2 describe-security-groups --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"
   ```

   This command will return a list of all security groups along with their names and IDs.

3. Check the inbound rules for each security group: For each security group, you can check the inbound rules by running the following command:

   ```
   aws ec2 describe-security-groups --group-ids <security-group-id> --query 'SecurityGroups[*].IpPermissions[*]'
   ```

   Replace `<security-group-id>` with the ID of the security group you want to check. This command will return a list of all inbound rules for the specified security group.

4. Check if the security group allows all traffic: If the returned list from the previous step includes a rule that allows all traffic (0.0.0.0/0), then the security group is misconfigured. The rule allowing all traffic would look something like this:

   ```
   {
       "IpProtocol": "-1",
       "IpRanges": [
           {
               "CidrIp": "0.0.0.0/0"
           }
       ]
   }
   ```

   If such a rule exists, the security group is not blocking all traffic, which is a misconfiguration.

#### Using Python

1. AWS:
   - Import the boto3 library in your python script. Boto3 is the Amazon Web Services (AWS) Software Development Kit (SDK) for Python.
   - Create an AWS session using your access key and secret access key.
   - Use the describe_security_groups() method to retrieve all security groups.
   - Iterate over each security group and check if it allows all traffic. If the IpPermissions list is empty, it means all traffic is allowed.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)

ec2 = session.resource('ec2')
security_groups = ec2.security_groups.all()

for sg in security_groups:
    if not sg.ip_permissions:
        print(f"Security Group {sg.id} allows all traffic")
```

2. Azure:
   - Import the Azure SDK for Python.
   - Authenticate to Azure using your credentials.
   - Retrieve all network security groups.
   - Iterate over each security group and check if it allows all traffic. If the securityRules list is empty, it means all traffic is allowed.

```python
from azure.mgmt.network import NetworkManagementClient
from azure.common.credentials import ServicePrincipalCredentials

credentials = ServicePrincipalCredentials(
    client_id='YOUR_CLIENT_ID',
    secret='YOUR_SECRET',
    tenant='YOUR_TENANT_ID'
)

network_client = NetworkManagementClient(credentials, 'YOUR_SUBSCRIPTION_ID')
security_groups = network_client.network_security_groups.list_all()

for sg in security_groups:
    if not sg.security_rules:
        print(f"Security Group {sg.id} allows all traffic")
```

3. GCP:
   - Import the google-cloud-sdk library in your python script.
   - Authenticate to GCP using your service account key.
   - Retrieve all firewall rules.
   - Iterate over each rule and check if it allows all traffic. If the allowed list is empty, it means all traffic is allowed.

```python
from google.cloud import compute_v1

client = compute_v1.FirewallsClient()

firewall_rules = client.list(project='YOUR_PROJECT_ID')

for rule in firewall_rules:
    if not rule.allowed:
        print(f"Firewall Rule {rule.id} allows all traffic")
```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the misconfiguration of default security groups allowing all traffic in AWS, follow these steps using the AWS Management Console:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/console/) and log in with your credentials.

2. **Navigate to the EC2 Dashboard**: Click on the "Services" dropdown in the top left corner and select "EC2" under the Compute section.

3. **Access Security Groups**: In the EC2 Dashboard, locate and click on the "Security Groups" option in the left-hand navigation pane.

4. **Identify Default Security Group**: Look for the default security group in the list of security groups. The default security group usually has the Group Name as "default" and the description as "default VPC security group".

5. **Edit Inbound Rules**: Click on the default security group to select it. Then, navigate to the "Inbound rules" tab at the bottom of the dashboard.

6. **Remove All Inbound Rules**: You will see a list of inbound rules that allow traffic to the instances associated with this security group. To block all traffic, you need to remove all existing inbound rules.

7. **Add Necessary Rules**: After removing all inbound rules, you can add specific rules based on your requirements. Click on the "Edit inbound rules" button and add rules for the specific ports and protocols that your instances need to communicate with.

8. **Save Changes**: Once you have added the necessary rules, click on the "Save rules" button to apply the changes to the default security group.

9. **Verify Changes**: Verify that the default security group now only allows traffic based on the rules you have defined.

By following these steps, you have successfully remediated the misconfiguration of default security groups allowing all traffic in AWS.

#### Using CLI

To remediate the misconfiguration of default security groups allowing all traffic in AWS using AWS CLI, follow these steps:

1. List all default security groups in your AWS account:
```bash
aws ec2 describe-security-groups --filters Name=group-name,Values=default
```

2. Identify the default security group that allows all traffic.

3. Get the Group ID of the default security group that allows all traffic:
```bash
aws ec2 describe-security-groups --group-names default --query 'SecurityGroups[0].GroupId' --output text
```

4. Update the inbound rules of the default security group to deny all traffic:
```bash
aws ec2 revoke-security-group-ingress --group-id YOUR_GROUP_ID --protocol all --port all --cidr 0.0.0.0/0
```

5. Update the outbound rules of the default security group to deny all traffic:
```bash
aws ec2 revoke-security-group-egress --group-id YOUR_GROUP_ID --protocol all --port all --cidr 0.0.0.0/0
```

Replace `YOUR_GROUP_ID` with the Group ID of the default security group that allows all traffic.

By following these steps, you will successfully remediate the misconfiguration of default security groups allowing all traffic in AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration of default security groups allowing all traffic in AWS using Python, you can use the AWS SDK for Python (Boto3) to update the inbound and outbound rules of the default security group to deny all traffic. Here are the step-by-step instructions to remediate this issue:

1. Install Boto3: If you haven't already installed Boto3, you can do so using pip:

```bash
pip install boto3
```

2. Write a Python script to update the default security group:

```python
import boto3

# Initialize the EC2 client
ec2 = boto3.client('ec2')

# Get the default security group ID
response = ec2.describe_security_groups(Filters=[{'Name': 'group-name', 'Values': ['default']}])
default_security_group_id = response['SecurityGroups'][0]['GroupId']

# Revoke all inbound rules
ec2.revoke_security_group_ingress(
    GroupId=default_security_group_id,
    IpPermissions=[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}]}]
)

# Revoke all outbound rules
ec2.revoke_security_group_egress(
    GroupId=default_security_group_id,
    IpPermissions=[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}]}]
)

print("Default security group rules updated to deny all traffic.")
```

3. Run the Python script: Execute the Python script to update the default security group rules to deny all traffic.

```bash
python update_default_security_group.py
```

After running this script, the default security group in your AWS account will be updated to block all inbound and outbound traffic. Make sure to review the changes and ensure they align with your security requirements.

### Additional Reading:

- [https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-security-groups.html#default-security-group](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-security-groups.html#default-security-group) 


</Tab>
</Tabs>