---
slug: iam_users_policy_blacklisted_check
title: Blocked KMS Actions In Inline Policies Should Be Set
sidebar_label: Blocked KMS Actions In Inline Policies Should Be Set
---

### More Info:

This rule checks if the inline policies attached to your IAM roles do not allow blocked actions on all AWS Key Management Service (KMS) keys. The rule is NON_COMPLIANT if any blocked action is allowed on all AWS KMS keys in an inline policy.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the IAM dashboard by selecting "Services" from the top menu, then choosing "IAM" under the "Security, Identity, & Compliance" category.
3. In the IAM dashboard, select "Policies" from the left-hand side menu.
4. Here, you can see all the policies. You need to check each policy one by one. Click on the policy name to open it.
5. In the policy details page, check the policy document. If the policy document has "kms:Create*" or "kms:Describe*" or "kms:Enable*" or "kms:List*" or "kms:Put*" or "kms:Update*" or "kms:Revoke*" or "kms:Disable*" or "kms:Get*" or "kms:Delete*" or "kms:TagResource" or "kms:UntagResource" or "kms:ScheduleKeyDeletion" or "kms:CancelKeyDeletion" actions as blocked, then the policy is misconfigured.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to execute IAM related commands.

2. Once the AWS CLI is set up, you can list all the IAM policies using the following command:
   ```
   aws iam list-policies --scope Local
   ```
   This command will return a list of all the IAM policies that are created within your AWS account.

3. For each policy, you can get the policy details including the policy document by using the following command:
   ```
   aws iam get-policy-version --policy-arn <Policy_ARN> --version-id <Policy_Version_ID>
   ```
   Replace `<Policy_ARN>` with the ARN of the policy and `<Policy_Version_ID>` with the version ID of the policy. This command will return the policy document which includes the permissions set by the policy.

4. Now, you need to check the policy document for any blocked KMS actions. You can do this by looking for "kms:Deny" statements in the policy document. If such statements are found, it means that some KMS actions are blocked in the inline policy. You can use a script to automate this process. Here is a simple Python script that uses the `boto3` AWS SDK to do this:
   ```python
   import boto3

   client = boto3.client('iam')

   response = client.list_policies(Scope='Local')

   for policy in response['Policies']:
       policy_version = client.get_policy_version(
           PolicyArn=policy['Arn'],
           VersionId=policy['DefaultVersionId']
       )
       for statement in policy_version['PolicyVersion']['Document']['Statement']:
           if statement['Effect'] == 'Deny' and 'kms' in statement['Action']:
               print(f"Policy {policy['PolicyName']} blocks some KMS actions")
   ```
   This script lists all the local IAM policies, gets the default version of each policy, and checks if there are any "Deny" statements for KMS actions. If such statements are found, the script prints the name of the policy.

#### Using Python

1. Install the necessary Python libraries: Before you start, ensure that you have the necessary Python libraries installed. You will need 'boto3' for AWS, 'azure-identity' and 'azure-mgmt-resource' for Azure, and 'google-cloud-resource-manager' and 'google-auth' for GCP. You can install these using pip:

   ```bash
   pip install boto3 azure-identity azure-mgmt-resource google-cloud-resource-manager google-auth
   ```

2. AWS: Use the AWS SDK 'boto3' to list all IAM policies and check if any inline policy allows blocked KMS actions. Here is a sample script:

   ```python
   import boto3

   client = boto3.client('iam')
   response = client.list_policies(Scope='Local')

   for policy in response['Policies']:
       policy_version = client.get_policy_version(PolicyArn=policy['Arn'], VersionId=policy['DefaultVersionId'])
       for statement in policy_version['PolicyVersion']['Document']['Statement']:
           if 'kms:' in statement['Action'] and statement['Effect'] == 'Deny':
               print(f"Policy {policy['PolicyName']} has blocked KMS actions")
   ```

3. Azure: Use the Azure SDK to list all role definitions and check if any role allows blocked KMS actions. Here is a sample script:

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.resource import ResourceManagementClient

   credential = DefaultAzureCredential()
   client = ResourceManagementClient(credential, "<subscription_id>")

   for role_definition in client.role_definitions.list():
       if 'Microsoft.KeyVault/vaults/keys/*' in role_definition.permissions and role_definition.permissions['Microsoft.KeyVault/vaults/keys/*'].actions == 'Deny':
           print(f"Role {role_definition.name} has blocked KMS actions")
   ```

4. GCP: Use the GCP SDK to list all IAM policies and check if any policy allows blocked KMS actions. Here is a sample script:

   ```python
   from google.cloud import resource_manager
   from google.auth import default

   credentials, project = default()
   client = resource_manager.Client(credentials=credentials)

   for policy in client.list_policies():
       if 'cloudkms.cryptoKeyVersions.useTo*' in policy.bindings and policy.bindings['cloudkms.cryptoKeyVersions.useTo*'].role == 'roles/denied':
           print(f"Policy {policy.name} has blocked KMS actions")
   ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of blocked KMS actions in inline policies in AWS IAM using the AWS Management Console, follow these step-by-step instructions:

1. **Identify the Inline Policies**: 
   - Sign in to the AWS Management Console.
   - Open the IAM console at https://console.aws.amazon.com/iam/.
   - In the navigation pane, choose "Policies".
   - Select the policy that contains the inline policy with blocked KMS actions.

2. **Edit the Inline Policy**:
   - Click on the policy name to open the policy details.
   - In the "Policy summary" section, find the inline policy that contains the blocked KMS actions.
   - Click on the "Edit policy" button to modify the inline policy.

3. **Update the Policy Document**:
   - In the policy editor, locate the section that specifies the actions allowed or denied.
   - Remove any explicit denies for KMS actions that are necessary for your use case.
   - Ensure that the policy allows the required KMS actions by using the appropriate IAM policy actions (e.g., kms:Encrypt, kms:Decrypt, kms:GenerateDataKey, etc.).

4. **Review and Save the Changes**:
   - After updating the policy document to allow the necessary KMS actions, review the changes to ensure they meet your security and access requirements.
   - Click on the "Review policy" button to validate the policy syntax.
   - Once the policy syntax is valid, click on the "Save changes" button to update the inline policy.

5. **Test the Policy**:
   - After saving the changes, test the inline policy to ensure that the required KMS actions are now allowed.
   - You can test the policy by assigning it to a user or role and performing the relevant actions that involve KMS encryption/decryption.

By following these steps, you can remediate the issue of blocked KMS actions in inline policies in AWS IAM using the AWS Management Console. It is essential to regularly review and update IAM policies to ensure that they align with your organization's security and compliance requirements.

#### Using CLI

To remediate the issue of blocked KMS actions in inline policies in AWS IAM using AWS CLI, follow these steps:

1. Identify the IAM user or role with inline policies that contain blocked KMS actions.

2. Open your terminal and execute the following AWS CLI command to list all IAM users and roles with inline policies that contain blocked KMS actions:
   ```
   aws iam list-entities-for-policy --policy-arn arn:aws:iam::aws:policy/AWSKeyManagementServicePowerUserPolicy
   ```

3. Identify the inline policy attached to the IAM user or role that contains blocked KMS actions.

4. Modify the inline policy to allow the necessary KMS actions. You can do this by creating a new inline policy with the required KMS permissions and attaching it to the IAM user or role.

5. Use the AWS CLI command to create a new inline policy with the required KMS permissions. Save the policy document in a JSON file (e.g., kms_policy.json) with the necessary permissions. Here is an example of a policy document that allows all KMS actions:
   ```
   {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Action": "kms:*",
               "Resource": "*"
           }
       ]
   }
   ```

6. Execute the following AWS CLI command to attach the new inline policy to the IAM user or role:
   ```
   aws iam put-user-policy --user-name <IAM-USER-NAME> --policy-name AllowKMSActions --policy-document file://kms_policy.json
   ```

7. Verify that the new inline policy with the required KMS permissions has been successfully attached to the IAM user or role by listing the user policies:
   ```
   aws iam list-user-policies --user-name <IAM-USER-NAME>
   ```

8. Test the IAM user or role to ensure that they can now perform the necessary KMS actions without any issues.

By following these steps, you can remediate the issue of blocked KMS actions in inline policies in AWS IAM using AWS CLI.

#### Using Python

To remediate the issue of blocked KMS actions in inline policies in AWS IAM using Python, you can follow these steps:

1. Identify the IAM user or role with the inline policy that is blocking KMS actions.
2. Update the inline policy to allow the necessary KMS actions.

Here is an example Python script that demonstrates how to remediate this issue:

```python
import boto3

# Initialize the IAM client
iam_client = boto3.client('iam')

# Specify the IAM user or role name with the inline policy blocking KMS actions
user_or_role_name = 'YOUR_USER_OR_ROLE_NAME'

# Specify the KMS actions that need to be allowed
kms_actions = ['kms:Encrypt', 'kms:Decrypt', 'kms:GenerateDataKey']

# Get the inline policies attached to the IAM user or role
response = iam_client.list_user_policies(UserName=user_or_role_name)
policy_names = response['PolicyNames']

# Update each inline policy to allow the necessary KMS actions
for policy_name in policy_names:
    policy_document = iam_client.get_user_policy(UserName=user_or_role_name, PolicyName=policy_name)['PolicyDocument']
    for statement in policy_document['Statement']:
        if statement['Effect'] == 'Deny' and 'kms' in statement['Action']:
            for action in kms_actions:
                statement['Action'].remove(action)
    
    # Update the policy with the modified document
    iam_client.put_user_policy(UserName=user_or_role_name, PolicyName=policy_name, PolicyDocument=policy_document)

print(f"KMS actions have been allowed in the inline policies for {user_or_role_name}")
```

Make sure to replace `'YOUR_USER_OR_ROLE_NAME'` with the actual IAM user or role name that has the inline policy blocking KMS actions. Also, update the `kms_actions` list with the specific KMS actions that need to be allowed.

By running this Python script, you will be able to remediate the issue of blocked KMS actions in inline policies for the specified IAM user or role in AWS IAM.



</Tab>
</Tabs>