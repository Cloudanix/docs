

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the IAM console at https://console.aws.amazon.com/iam/.

2. In the navigation pane, choose "Roles". This will display a list of all the IAM roles that are currently configured within your AWS environment.

3. Select a role to review its details. Under the "Permissions" tab, you can see the policies attached to the role. 

4. If there are any custom policies attached to the role, they will be listed here. Custom policies are identified by their unique ARN (Amazon Resource Name), which differs from the ARN of AWS managed policies. Custom policies usually have the format: arn:aws:iam::<account-id>:policy/<policy-name>. If such policies are present, it indicates a misconfiguration.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access IAM roles and policies.

2. Once the AWS CLI is set up, you can list all the IAM roles in your AWS account by running the following command:

   ```
   aws iam list-roles
   ```

   This command will return a JSON object that contains all the IAM roles in your AWS account.

3. To check if there are any custom role policies, you can use the following command:

   ```
   aws iam list-role-policies --role-name {role-name}
   ```

   Replace `{role-name}` with the name of the IAM role you want to check. This command will return a list of all the inline policies that are attached to the specified IAM role.

4. If there are any custom role policies, they will be listed in the output of the previous command. You can then inspect these policies to see if they are misconfigured. If the command returns an empty list, it means that there are no custom role policies attached to the IAM role.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3):
   You need to install and configure Boto3 to interact with AWS services. You can install it using pip:
   ```
   pip install boto3
   ```
   Then, configure your AWS credentials to allow Boto3 to interact with AWS services on your behalf. You can do this by setting the following environment variables:
   ```
   AWS_ACCESS_KEY_ID='your_access_key'
   AWS_SECRET_ACCESS_KEY='your_secret_key'
   ```

2. Import necessary libraries and create an IAM client:
   You need to import Boto3 and create an IAM client to interact with IAM service. Here is how you can do it:
   ```python
   import boto3

   # Create IAM client
   iam = boto3.client('iam')
   ```

3. List all IAM roles and check for custom policies:
   You can list all IAM roles and their associated policies using the `list_roles` and `list_role_policies` methods. Then, you can check if any custom policies are present. Here is how you can do it:
   ```python
   # List all IAM roles
   roles = iam.list_roles()
   for role in roles['Roles']:
       # List policies for each role
       policies = iam.list_role_policies(RoleName=role['RoleName'])
       for policy_name in policies['PolicyNames']:
           # If a custom policy is found, print a message
           if policy_name != 'AmazonS3FullAccess' and policy_name != 'AmazonDynamoDBFullAccess' and policy_name != 'AmazonEC2FullAccess':
               print(f'Custom policy {policy_name} found in role {role["RoleName"]}')
   ```

4. Run the script:
   Finally, you can run the script to detect if any IAM custom role policies are present. If any are found, the script will print a message with the role name and policy name. If no custom policies are found, the script will not print anything.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of IAM custom role policies being present in AWS IAM using the AWS Management Console, follow these step-by-step instructions:

1. **Sign in to the AWS Management Console**: Go to the AWS Management Console and sign in using your AWS account credentials.

2. **Navigate to the IAM Service**: Click on the "Services" dropdown in the top left corner of the console, and then select "IAM" under the Security, Identity, & Compliance section.

3. **Identify Custom Role Policies**: In the IAM console, click on the "Roles" option in the left-hand menu to view a list of IAM roles in your account.

4. **Select the Role**: Identify the IAM role that has custom policies attached to it. Click on the name of the role to view its details.

5. **Remove Custom Policies**: In the permissions tab of the IAM role details, you will see the list of policies attached to the role. Identify the custom policies that should not be present and click on the policy to select it.

6. **Detach the Policy**: Click on the "Detach Policy" button to remove the custom policy from the IAM role. Confirm the action when prompted.

7. **Review and Save Changes**: Review the updated permissions for the IAM role to ensure that only the necessary managed policies are attached. Click on the "Save Changes" button to apply the changes.

8. **Verify Remediation**: Once the custom role policies have been removed, verify that the IAM role now only has the necessary managed policies attached to it.

By following these steps, you can remediate the issue of IAM custom role policies being present in AWS IAM using the AWS Management Console.

#### Using CLI

To remediate the issue of IAM custom role policies being present in AWS using AWS CLI, you can follow these steps:

1. Identify the IAM roles with custom policies:
   Run the following AWS CLI command to list all IAM roles in your account along with their policies:
   ```
   aws iam list-roles
   ```

2. Review the policies attached to each IAM role:
   For each IAM role identified in the previous step, run the following AWS CLI command to list the policies attached to the role:
   ```
   aws iam list-role-policies --role-name <role-name>
   ```

3. Remove the custom policies attached to the IAM roles:
   For each IAM role that has custom policies attached, run the following AWS CLI command to detach the custom policy from the role:
   ```
   aws iam delete-role-policy --role-name <role-name> --policy-name <policy-name>
   ```

4. Verify the custom policies have been removed:
   Run the following AWS CLI command to verify that the custom policy has been successfully removed from the IAM role:
   ```
   aws iam list-role-policies --role-name <role-name>
   ```

5. Repeat the above steps for all IAM roles with custom policies attached to remediate the issue across all roles.

By following the above steps, you can remediate the issue of IAM custom role policies being present in AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration of IAM custom role policies being present in AWS using Python, you can follow these steps:

Step 1: List all IAM roles with custom policies attached
```python
import boto3

client = boto3.client('iam')

response = client.list_roles()

for role in response['Roles']:
    role_name = role['RoleName']
    attached_policies = client.list_attached_role_policies(RoleName=role_name)['AttachedPolicies']
    
    if attached_policies:
        print(f"IAM Role {role_name} has custom policies attached.")
```

Step 2: Detach custom policies from IAM roles
```python
for role in response['Roles']:
    role_name = role['RoleName']
    attached_policies = client.list_attached_role_policies(RoleName=role_name)['AttachedPolicies']
    
    if attached_policies:
        for policy in attached_policies:
            policy_arn = policy['PolicyArn']
            client.detach_role_policy(RoleName=role_name, PolicyArn=policy_arn)
            print(f"Detached policy {policy_arn} from IAM Role {role_name}")
```

Step 3: Verify that custom policies have been successfully detached
```python
response = client.list_roles()

for role in response['Roles']:
    role_name = role['RoleName']
    attached_policies = client.list_attached_role_policies(RoleName=role_name)['AttachedPolicies']
    
    if attached_policies:
        print(f"IAM Role {role_name} still has custom policies attached.")
    else:
        print(f"IAM Role {role_name} no longer has custom policies attached.")
```

By following these steps, you can remediate the misconfiguration of IAM custom role policies being present in AWS using Python.


</Tab>
</Tabs>