---
slug: iam_groups_policy_blacklisted_check
title: Blocked KMS Actions In Inline Policies Should Be Set
sidebar_label: Blocked KMS Actions In Inline Policies Should Be Set
---

### More Info:

This rule checks if the inline policies attached to your IAM roles do not allow blocked actions on all AWS Key Management Service (KMS) keys. The rule is NON_COMPLIANT if any blocked action is allowed on all AWS KMS keys in an inline policy.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the IAM console at https://console.aws.amazon.com/iam/.
   
2. In the navigation pane, choose "Policies". This will display a list of all the IAM policies that are currently configured in your AWS environment.

3. Select the policy you want to check for blocked KMS actions. This will open the policy details page.

4. In the policy details page, check the policy document for any "Deny" statements that are applied to KMS actions. If there are any "Deny" statements, it means that certain KMS actions are blocked in the inline policy.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to execute IAM related commands.

2. Once the AWS CLI is set up, you can list all the IAM policies using the following command:
   ```
   aws iam list-policies --scope Local
   ```
   This command will return a list of all the IAM policies that are created within your AWS account.

3. For each policy, you can get the policy details including the policy document which contains the permissions. Use the following command to get the policy details:
   ```
   aws iam get-policy-version --policy-arn <Policy_ARN> --version-id <Policy_Version_ID>
   ```
   Replace `<Policy_ARN>` with the ARN of the policy and `<Policy_Version_ID>` with the version ID of the policy. This command will return the policy document in a JSON format.

4. Now, you need to check the policy document for any blocked KMS actions. You can do this manually by looking at the "Action" field in the policy document. If there are any KMS actions that are explicitly denied, then those are the blocked KMS actions. You can also write a script to automate this process. Here is a simple Python script that uses the `json` module to parse the policy document and check for blocked KMS actions:
   ```python
   import json

   # Load the policy document
   with open('policy_document.json') as f:
       policy = json.load(f)

   # Check for blocked KMS actions
   for statement in policy['Statement']:
       if statement['Effect'] == 'Deny' and 'kms' in statement['Action']:
           print('Blocked KMS action found:', statement['Action'])
   ```
   Replace `'policy_document.json'` with the path to the JSON file containing the policy document. This script will print out all the blocked KMS actions found in the policy document.

#### Using Python

1. Install the necessary Python libraries: Before you start, you need to install the AWS SDK for Python (Boto3) in your environment. This can be done using pip:

   ```
   pip install boto3
   ```

2. Import the necessary libraries and establish a session: In your Python script, you need to import the Boto3 library and establish a session with AWS. You also need to import the IAM client from Boto3.

   ```python
   import boto3

   session = boto3.Session(
       aws_access_key_id='YOUR_ACCESS_KEY',
       aws_secret_access_key='YOUR_SECRET_KEY',
       region_name='YOUR_REGION'
   )

   iam = session.client('iam')
   ```

3. Retrieve and analyze IAM policies: Now, you can use the IAM client to retrieve all IAM policies and analyze them. You need to check if any inline policy allows all KMS actions (`"kms:*"`) but blocks some specific actions. Here is a sample code snippet:

   ```python
   policies = iam.list_policies(Scope='Local')['Policies']

   for policy in policies:
       policy_version = iam.get_policy_version(
           PolicyArn=policy['Arn'],
           VersionId=policy['DefaultVersionId']
       )['PolicyVersion']

       for statement in policy_version['Document']['Statement']:
           if (statement['Effect'] == 'Allow' and 'kms:*' in statement['Action'] and
               'Condition' in statement and 'StringNotEquals' in statement['Condition'] and
               'kms:ViaService' in statement['Condition']['StringNotEquals']):
               print(f"Policy {policy['PolicyName']} allows all KMS actions but blocks some specific actions.")
   ```

4. Run the script: Finally, you can run the script to detect any misconfigurations. If any misconfigurations are detected, the script will print the names of the policies that have them.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the "Blocked KMS Actions In Inline Policies Should Be Set" misconfiguration in AWS IAM using the AWS Management Console, follow these steps:

1. **Login to AWS Console**: Go to the AWS Management Console (https://aws.amazon.com/console/) and login to your AWS account.

2. **Navigate to IAM Service**: Click on the "Services" dropdown in the top left corner and select "IAM" under the Security, Identity, & Compliance section.

3. **Select the User/Role/Group**: In the left-hand navigation pane, choose the appropriate option (User, Role, or Group) where the inline policy with blocked KMS actions exists.

4. **Locate the Inline Policy**: Scroll down to the "Permissions" tab and find the inline policy that contains blocked KMS actions. Click on the policy to edit it.

5. **Edit the Inline Policy**: In the policy editor, locate the section where KMS actions are blocked. This may look like:
   ```
   {
       "Effect": "Deny",
       "Action": "kms:Encrypt",
       "Resource": "*"
   }
   ```
   Remove the block or update it to allow the necessary KMS actions as needed.

6. **Save Changes**: After making the necessary changes to the inline policy, click on the "Review policy" button to review the changes.

7. **Review and Apply Changes**: Review the policy changes to ensure that the necessary KMS actions are now allowed. If everything looks correct, click on the "Save changes" button to apply the updated policy.

8. **Verify Changes**: Once the policy is saved, verify that the blocked KMS actions have been remediated by attempting to perform the previously blocked actions. You can also use the IAM Policy Simulator to validate the changes.

By following these steps, you should be able to remediate the "Blocked KMS Actions In Inline Policies Should Be Set" misconfiguration in AWS IAM using the AWS Management Console.

#### Using CLI

To remediate the misconfiguration of blocked KMS actions in inline policies in AWS IAM using AWS CLI, follow these steps:

1. Identify the IAM user, group, or role that has inline policies with blocked KMS actions.
2. Use the AWS CLI to list all the inline policies attached to the IAM entity. You can use the following command:
   
   ```
   aws iam list-user-policies --user-name <IAM-USER-NAME>
   aws iam list-group-policies --group-name <IAM-GROUP-NAME>
   aws iam list-role-policies --role-name <IAM-ROLE-NAME>
   ```

3. For each inline policy identified in step 2, use the AWS CLI to get the policy document:
   
   ```
   aws iam get-user-policy --user-name <IAM-USER-NAME> --policy-name <POLICY-NAME>
   aws iam get-group-policy --group-name <IAM-GROUP-NAME> --policy-name <POLICY-NAME>
   aws iam get-role-policy --role-name <IAM-ROLE-NAME> --policy-name <POLICY-NAME>
   ```

4. Review the policy document to identify any blocked KMS actions. Look for statements that deny access to KMS actions.
5. Modify the policy document to allow the required KMS actions. Remove any explicit denies for KMS actions.
6. Update the inline policy with the modified policy document. Use the following command:

   ```
   aws iam put-user-policy --user-name <IAM-USER-NAME> --policy-name <POLICY-NAME> --policy-document file://<UPDATED-POLICY-DOCUMENT>
   aws iam put-group-policy --group-name <IAM-GROUP-NAME> --policy-name <POLICY-NAME> --policy-document file://<UPDATED-POLICY-DOCUMENT>
   aws iam put-role-policy --role-name <IAM-ROLE-NAME> --policy-name <POLICY-NAME> --policy-document file://<UPDATED-POLICY-DOCUMENT>
   ```

7. Verify that the inline policies no longer have blocked KMS actions by listing the policies and reviewing the policy documents.

By following these steps, you can remediate the misconfiguration of blocked KMS actions in inline policies in AWS IAM using AWS CLI.

#### Using Python

To remediate the issue of blocked KMS actions in inline policies in AWS IAM using Python, follow these steps:

1. Identify the IAM user or role with the inline policy that contains blocked KMS actions.
2. Use the AWS SDK for Python (Boto3) to update the inline policy to allow the necessary KMS actions.
3. Modify the inline policy to include the required KMS actions.

Here is a sample Python script to remediate this issue:

```python
import boto3

# Initialize the IAM client
iam_client = boto3.client('iam')

# Specify the IAM user or role name
user_name = 'YOUR_USER_NAME'
policy_name = 'YOUR_POLICY_NAME'

# Specify the required KMS actions
kms_actions = [
    "kms:Encrypt",
    "kms:Decrypt",
    "kms:ReEncrypt*",
    "kms:GenerateDataKey*",
    "kms:DescribeKey"
]

# Get the current policy document
policy_document = {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": kms_actions,
            "Resource": "*"
        }
    ]
}

# Update the inline policy
response = iam_client.put_user_policy(
    UserName=user_name,
    PolicyName=policy_name,
    PolicyDocument=json.dumps(policy_document)
)

print("Policy updated successfully.")
```

Replace `'YOUR_USER_NAME'` and `'YOUR_POLICY_NAME'` with the actual IAM user or role name and policy name that need to be remediated. Update the `kms_actions` list with the required KMS actions that should be allowed in the inline policy.

Run this Python script to update the inline policy and allow the necessary KMS actions.



</Tab>
</Tabs>