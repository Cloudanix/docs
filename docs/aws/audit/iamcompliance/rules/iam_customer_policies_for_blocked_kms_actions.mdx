---
slug: iam_customer_policies_for_blocked_kms_actions
title: Blocked KMS Actions In IAM Policies Should Be Set
sidebar_label: Blocked KMS Actions In IAM Policies Should Be Set
---

### More Info:

This rule checks if the managed AWS Identity and Access Management (IAM) policies that you create do not allow blocked actions on AWS Key Management Service (KMS) keys. The rule is NON_COMPLIANT if any blocked action is allowed on AWS KMS keys by the managed IAM policy. Note that this rule does not evaluate the conditions provided in IAM policies.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the IAM console at https://console.aws.amazon.com/iam/.
   
2. In the navigation pane, choose "Policies" to open the Policies dashboard.

3. In the Policies dashboard, you can search for the specific IAM policy by typing its name in the search box. Click on the policy name to open its details page.

4. In the policy details page, check the policy document for any blocked KMS actions. If the "Effect" parameter is set to "Deny" for any KMS actions, it means those actions are blocked in the IAM policy.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access IAM policies.

2. Once AWS CLI is set up, you can list all the IAM policies using the following command:
   ```
   aws iam list-policies --scope Local
   ```
   This command will return a list of all IAM policies in your AWS account.

3. To check the details of each policy, you can use the following command:
   ```
   aws iam get-policy-version --policy-arn <Policy_ARN> --version-id <Policy_Version_ID>
   ```
   Replace `<Policy_ARN>` and `<Policy_Version_ID>` with the ARN and version ID of the policy you want to check. This command will return the details of the specified policy version.

4. Now, you need to manually inspect the policy details to check if there are any blocked KMS actions. Look for the "Effect": "Deny" statement in the policy. If there are any KMS actions listed under this statement, it means those actions are blocked.

#### Using Python

1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need 'boto3' for AWS, 'azure-identity' and 'azure-mgmt-resource' for Azure, and 'google-cloud-resource-manager' and 'google-auth' for GCP. You can install these libraries using pip:

   ```python
   pip install boto3 azure-identity azure-mgmt-resource azure-mgmt-keyvault google-cloud-resource-manager google-auth google-auth-httplib2 google-auth-oauthlib google-auth-httplib2 google-api-python-client
   ```

2. AWS: Use the AWS SDK 'boto3' to list all IAM policies and check if any policy allows all KMS actions ('kms:*') without explicitly denying any:

   ```python
   import boto3

   client = boto3.client('iam')
   response = client.list_policies(Scope='All')

   for policy in response['Policies']:
       policy_version = client.get_policy_version(PolicyArn=policy['Arn'], VersionId=policy['DefaultVersionId'])
       for statement in policy_version['PolicyVersion']['Document']['Statement']:
           if 'kms:*' in statement['Action'] and 'Effect' not in statement or statement['Effect'] != 'Deny':
               print(f"Policy {policy['PolicyName']} allows all KMS actions without explicit deny.")
   ```

3. Azure: Use the Azure SDK to list all Key Vault access policies and check if any policy allows all Key Vault actions without explicitly denying any:

   ```python
   from azure.identity import DefaultAzureCredential
   from azure.mgmt.keyvault import KeyVaultManagementClient

   credential = DefaultAzureCredential()
   kv_client = KeyVaultManagementClient(credential, "<subscription_id>")

   for vault in kv_client.vaults.list():
       for policy in vault.properties.access_policies:
           if 'all' in policy.permissions.keys and 'deny' not in policy.permissions.keys:
               print(f"Vault {vault.name} allows all Key Vault actions without explicit deny.")
   ```

4. GCP: Use the GCP SDK to list all IAM policies and check if any policy allows all KMS actions ('cloudkms.*') without explicitly denying any:

   ```python
   from google.oauth2 import service_account
   from googleapiclient import discovery

   credentials = service_account.Credentials.from_service_account_file('<path_to_service_account_file>')
   service = discovery.build('cloudresourcemanager', 'v1', credentials=credentials)

   request = service.projects().getIamPolicy(resource='<project_id>')
   response = request.execute()

   for binding in response['bindings']:
       if 'cloudkms.*' in binding['role'] and 'members' in binding and 'allUsers' in binding['members']:
           print(f"Policy {binding['role']} allows all KMS actions for all users.")
   ```

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of blocked KMS actions in IAM policies in AWS, follow these steps using the AWS Management Console:

1. **Access the AWS IAM Console:**
   - Open the AWS Management Console and navigate to the IAM service.

2. **Identify the IAM Policy with Blocked KMS Actions:**
   - In the IAM console, click on "Policies" in the left-hand menu.
   - Review the policies attached to the IAM users, groups, or roles to identify the policy that contains blocked KMS actions.

3. **Edit the IAM Policy:**
   - Click on the policy that contains the blocked KMS actions to open it for editing.

4. **Update the IAM Policy to Allow KMS Actions:**
   - Within the policy document, locate the section that defines the permissions for KMS actions.
   - Modify the policy to allow the necessary KMS actions by adding the required KMS actions to the "Action" section.

5. **Save the Changes:**
   - After updating the policy to allow the necessary KMS actions, save the changes to the policy.

6. **Attach the Updated Policy:**
   - Once the policy is updated, attach it to the relevant IAM user, group, or role that requires access to KMS actions.

7. **Verify Access:**
   - Test the IAM user, group, or role to ensure that they can now perform the necessary KMS actions without any issues.

8. **Monitor and Review:**
   - Regularly monitor and review IAM policies to ensure that they do not contain any blocked KMS actions in the future.

By following these steps, you can remediate the issue of blocked KMS actions in IAM policies in AWS and ensure that the necessary permissions are granted for KMS actions as required.

#### Using CLI

To remediate the misconfiguration of blocked KMS actions in IAM policies in AWS using AWS CLI, follow these steps:

1. Identify the IAM policy that is blocking KMS actions:
   
   Use the following AWS CLI command to list all IAM policies that have explicit deny statements for KMS actions:
   
   ```
   aws iam list-policies --query "Policies[?PolicyId != null].{PolicyName:PolicyName, PolicyId:PolicyId}" --output table
   ```
   
   Look for the IAM policy that is blocking KMS actions.

2. Update the IAM policy to allow the necessary KMS actions:

   Use the following AWS CLI command to update the IAM policy to allow the necessary KMS actions. Replace `POLICY_ARN` with the ARN of the IAM policy that needs to be updated and `KMS_ACTION` with the specific KMS action that needs to be allowed (e.g., `kms:Encrypt`):
   
   ```
   aws iam create-policy-version --policy-arn POLICY_ARN --policy-document '{
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Action": "KMS_ACTION",
               "Resource": "*"
           }
       ]
   }'
   ```
   
   This command will create a new version of the IAM policy that allows the specified KMS action.

3. Set the new policy version as the default version:
   
   Use the following AWS CLI command to set the newly created policy version as the default version for the IAM policy. Replace `POLICY_ARN` with the ARN of the IAM policy that was updated:
   
   ```
   aws iam set-default-policy-version --policy-arn POLICY_ARN --version-id v2
   ```
   
   Replace `v2` with the version number of the policy version that was created in the previous step.

4. Verify the IAM policy changes:
   
   Use the following AWS CLI command to verify that the IAM policy now allows the necessary KMS actions. Replace `POLICY_ARN` with the ARN of the IAM policy that was updated:
   
   ```
   aws iam get-policy-version --policy-arn POLICY_ARN --version-id v2
   ```
   
   This command will display the details of the updated IAM policy version, including the allowed KMS actions.

By following these steps, you can remediate the misconfiguration of blocked KMS actions in IAM policies in AWS using AWS CLI.

#### Using Python

To remediate the issue of blocked KMS actions in IAM policies in AWS using Python, you can follow these steps:

1. Identify the IAM policies that are blocking KMS actions:
   - You can use the AWS SDK for Python (Boto3) to list all the IAM policies in your AWS account.
   - For each policy, check if it contains any explicit deny statements that block KMS actions.

2. Update the IAM policies to allow necessary KMS actions:
   - For policies that are blocking KMS actions, modify the policy to allow the required KMS actions.
   - You can use the `update_policy` method in Boto3 to update the IAM policy with the correct permissions.

3. Test the IAM policies:
   - After updating the IAM policies, test the permissions to ensure that the users or roles can now perform the necessary KMS actions.

Here is a sample Python script to remediate the blocked KMS actions in IAM policies:

```python
import boto3

# Initialize the IAM client
iam_client = boto3.client('iam')

# List all IAM policies
response = iam_client.list_policies()

for policy in response['Policies']:
    policy_arn = policy['Arn']
    
    # Get the policy document
    policy_version = iam_client.get_policy_version(
        PolicyArn=policy_arn,
        VersionId=policy['DefaultVersionId']
    )
    
    policy_document = policy_version['PolicyVersion']['Document']
    
    # Check if the policy contains explicit deny statements for KMS actions
    for statement in policy_document['Statement']:
        if statement.get('Effect') == 'Deny' and 'kms' in statement.get('Action', ''):
            # Update the policy to allow necessary KMS actions
            statement['Effect'] = 'Allow'
            
            # Update the policy with the modified document
            iam_client.create_policy_version(
                PolicyArn=policy_arn,
                PolicyDocument=policy_document,
                SetAsDefault=True
            )
            
            print(f"Policy {policy_arn} updated to allow KMS actions.")
```

Please ensure that you have the necessary permissions to modify IAM policies before running this script. Also, customize the script as per your specific requirements and policies in your AWS account.



</Tab>
</Tabs>