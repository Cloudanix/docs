
---
slug: iam_groups_inline_policies_for_blocked_kms_actions
title: Blocked KMS Actions In Inline Policies Should Be Set
sidebar_label: Blocked KMS Actions In Inline Policies Should Be Set
---

### More Info:

This rule checks if the inline policies attached to your IAM groups do not allow blocked actions on all AWS Key Management Service (KMS) keys. The rule is NON_COMPLIANT if any blocked action is allowed on all AWS KMS keys in an inline policy.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console.
2. Navigate to the IAM dashboard by selecting "Services" from the top menu, then choosing "IAM" under the "Security, Identity, & Compliance" category.
3. In the IAM dashboard, select "Policies" from the left-hand side menu. This will display a list of all the IAM policies in your AWS account.
4. For each policy, click on the policy name to open its details page. Here, you can review the policy document under the "Permissions" tab. Look for any KMS actions (like "kms:Encrypt", "kms:Decrypt", "kms:ReEncrypt*", etc.) that are explicitly denied. If you find any such actions, it means that the Blocked KMS Actions In Inline Policies are set.

#### Using CLI

1. First, you need to install and configure AWS CLI. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to execute IAM related commands.

2. Once AWS CLI is set up, you can list all the IAM policies using the following command:
   ```
   aws iam list-policies --scope Local
   ```
   This command will list all the policies that are created within your AWS account (Local scope). The output will be in JSON format which includes the policy names and their respective ARNs (Amazon Resource Names).

3. Now, for each policy, you can get the policy details including the policy document which contains the permissions. Use the following command to get the policy details:
   ```
   aws iam get-policy-version --policy-arn <Policy_ARN> --version-id <Policy_Version_ID>
   ```
   Replace `<Policy_ARN>` with the ARN of the policy and `<Policy_Version_ID>` with the version of the policy you want to check. The policy version ID can be obtained from the output of the previous command. The output of this command will also be in JSON format.

4. Now, you need to check the policy document for any blocked KMS actions. You can do this manually by looking at the "Statement" section of the policy document. If there are any KMS actions in the "NotAction" element, those are the blocked KMS actions. Alternatively, you can use a tool like `jq` to parse the JSON output and filter for the blocked KMS actions. Here is an example command:
   ```
   aws iam get-policy-version --policy-arn <Policy_ARN> --version-id <Policy_Version_ID> | jq -r '.PolicyVersion.Document.Statement[] | select(.NotAction[] | startswith("kms:"))'
   ```
   This command will list all the statements in the policy that have blocked KMS actions.

#### Using Python

1. Install and configure AWS SDK for Python (Boto3) in your local environment. This will allow you to interact with AWS services including IAM.

```python
pip install boto3
```

2. Import the necessary modules and create a session using your AWS credentials.

```python
import boto3

session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Use the IAM client from Boto3 to retrieve all the IAM policies in your account.

```python
iam_client = session.client('iam')

response = iam_client.list_policies(
    Scope='Local',
    OnlyAttached=True
)
```

4. Iterate over the policies and check for any inline policies that have blocked KMS actions. You can do this by checking if the policy document contains "kms:Decrypt", "kms:Encrypt", "kms:ReEncrypt*", "kms:GenerateDataKey*", "kms:DescribeKey".

```python
for policy in response['Policies']:
    policy_version = iam_client.get_policy_version(
        PolicyArn=policy['Arn'],
        VersionId=policy['DefaultVersionId']
    )
    statements = policy_version['PolicyVersion']['Document']['Statement']
    for statement in statements:
        if 'kms:Decrypt' in statement['Action'] or 'kms:Encrypt' in statement['Action'] or 'kms:ReEncrypt*' in statement['Action'] or 'kms:GenerateDataKey*' in statement['Action'] or 'kms:DescribeKey' in statement['Action']:
            if statement['Effect'] == 'Deny':
                print(f"Blocked KMS action found in policy: {policy['PolicyName']}")
```

This script will print the names of the policies that have blocked KMS actions. You can modify it to suit your needs, for example, by raising an exception or sending a notification when a blocked KMS action is found.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate the issue of blocked KMS actions in inline policies for AWS IAM using the AWS Management Console, you can follow these steps:

1. **Identify the Inline Policy**: First, you need to identify the IAM user, group, or role that has the inline policy with blocked KMS actions.

2. **Access the IAM Console**: Log in to the AWS Management Console and navigate to the IAM service.

3. **Locate the User, Group, or Role**: In the IAM console, locate and select the IAM user, group, or role that has the inline policy with blocked KMS actions.

4. **Edit Inline Policy**: Within the user, group, or role details page, locate the inline policy that contains the blocked KMS actions.

5. **Update the Policy**: Edit the inline policy to allow the necessary KMS actions that were previously blocked. You can do this by adding the required permissions to the policy document.

6. **Review and Save Changes**: After updating the policy document to allow the required KMS actions, review the changes to ensure they are correct. Once you are satisfied, save the changes to update the inline policy.

7. **Verify Permissions**: Test the permissions by attempting to perform the KMS actions that were previously blocked. Ensure that the user, group, or role can now successfully perform these actions.

8. **Monitor for Compliance**: Regularly monitor the IAM policies to ensure that blocked KMS actions are not reintroduced and that all necessary permissions are correctly configured.

By following these steps, you can successfully remediate the issue of blocked KMS actions in inline policies for AWS IAM using the AWS Management Console.

#### Using CLI

To remediate the issue of blocked KMS actions in inline policies for AWS IAM using AWS CLI, follow these step-by-step instructions:

1. Identify the inline policy attached to the IAM user, group, or role that contains blocked KMS actions. You can use the following AWS CLI command to list all the inline policies attached to the IAM entity:

```bash
aws iam list-user-policies --user-name <IAM-USERNAME>
aws iam list-group-policies --group-name <IAM-GROUPNAME>
aws iam list-role-policies --role-name <IAM-ROLENAME>
```

Replace `<IAM-USERNAME>`, `<IAM-GROUPNAME>`, or `<IAM-ROLENAME>` with the appropriate IAM entity name.

2. Once you have identified the inline policy that contains blocked KMS actions, you need to edit the policy document to allow the necessary KMS actions. You can use the following AWS CLI command to get the policy document for the inline policy:

```bash
aws iam get-user-policy --user-name <IAM-USERNAME> --policy-name <POLICY-NAME>
aws iam get-group-policy --group-name <IAM-GROUPNAME> --policy-name <POLICY-NAME>
aws iam get-role-policy --role-name <IAM-ROLENAME> --policy-name <POLICY-NAME>
```

Replace `<IAM-USERNAME>`, `<IAM-GROUPNAME>`, `<IAM-ROLENAME>`, and `<POLICY-NAME>` with the appropriate values.

3. Edit the policy document to allow the necessary KMS actions. You can use a text editor to modify the policy document and add the required KMS actions.

4. Once you have updated the policy document, you can use the following AWS CLI command to update the inline policy with the new policy document:

```bash
aws iam put-user-policy --user-name <IAM-USERNAME> --policy-name <POLICY-NAME> --policy-document file://<PATH-TO-UPDATED-POLICY-DOCUMENT>
aws iam put-group-policy --group-name <IAM-GROUPNAME> --policy-name <POLICY-NAME> --policy-document file://<PATH-TO-UPDATED-POLICY-DOCUMENT>
aws iam put-role-policy --role-name <IAM-ROLENAME> --policy-name <POLICY-NAME> --policy-document file://<PATH-TO-UPDATED-POLICY-DOCUMENT>
```

Replace `<IAM-USERNAME>`, `<IAM-GROUPNAME>`, `<IAM-ROLENAME>`, `<POLICY-NAME>`, and `<PATH-TO-UPDATED-POLICY-DOCUMENT>` with the appropriate values.

5. Verify that the inline policy has been updated successfully by listing the inline policies again and checking the policy document.

By following these steps, you can remediate the issue of blocked KMS actions in inline policies for AWS IAM using AWS CLI.

#### Using Python

To remediate the misconfiguration of blocked KMS actions in inline policies in AWS IAM using Python, you can follow these steps:

1. Identify the IAM user, group, or role that has the inline policy with blocked KMS actions.
2. Update the inline policy to allow the necessary KMS actions.
3. Use the AWS SDK for Python (Boto3) to programmatically update the inline policy.

Here is an example Python script to remediate this misconfiguration:

```python
import boto3

# Define the IAM entity (user, group, role) and the inline policy with blocked KMS actions
entity_name = 'your-entity-name'
policy_name = 'your-inline-policy-name'
blocked_actions = ['kms:Encrypt', 'kms:Decrypt']  # Add any other blocked KMS actions

# Initialize the IAM client
iam = boto3.client('iam')

# Get the inline policy document
policy_document = {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "*",
            "Resource": "*"
        }
    ]
}

# Update the inline policy to allow all KMS actions
response = iam.put_user_policy(
    UserName=entity_name,
    PolicyName=policy_name,
    PolicyDocument=json.dumps(policy_document)
)

# Check if the policy update was successful
if response['ResponseMetadata']['HTTPStatusCode'] == 200:
    print(f"Successfully updated inline policy for {entity_name} to allow all KMS actions.")
else:
    print("Failed to update inline policy.")
```

Make sure to replace `'your-entity-name'` and `'your-inline-policy-name'` with the actual IAM entity name and inline policy name that need to be remediated. Also, update the `blocked_actions` list with the specific KMS actions that were previously blocked.

By running this script, you can programmatically update the inline policy to allow all KMS actions and remediate the misconfiguration of blocked KMS actions in AWS IAM.



</Tab>
</Tabs>