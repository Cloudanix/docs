---
slug: stack_with_iam_role
title: CloudFormation Stack Should Have An IAM Role
sidebar_label: CloudFormation Stack Should Have An IAM Role
---

### More Info:

The IAM service role associated with your Amazon CloudFormation stack should adhere to the principle of least privilege in order avoid unwanted privilege escalation.

### Risk Level

Medium

### Address

Security

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the CloudFormation service.

2. In the CloudFormation console, select the "Stacks" option from the left-hand side menu. This will display a list of all the CloudFormation stacks in your account.

3. Click on the name of the stack you want to check. This will open the stack details page.

4. In the stack details page, look for the "IAM Role" field under the "Stack Info" section. If this field is empty or not present, it means that the CloudFormation stack does not have an IAM role associated with it.

#### Using CLI

1. First, you need to install and configure AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will be prompted to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can list all the CloudFormation stacks in your account using the following command:

   ```
   aws cloudformation list-stacks --query 'StackSummaries[?StackStatus!=`DELETE_COMPLETE`].StackName' --output text
   ```
   This command will list all the stack names whose status is not 'DELETE_COMPLETE'.

3. Now, for each stack, you can describe the stack details to check if it has an IAM role associated with it. Use the following command:

   ```
   aws cloudformation describe-stacks --stack-name <StackName>
   ```
   Replace `<StackName>` with the name of your stack. This command will return a JSON output with all the details of the stack.

4. In the JSON output, look for the "RoleARN" field. If this field is not present or is empty, it means that the CloudFormation stack does not have an IAM role associated with it. If the "RoleARN" field is present and contains an ARN, it means that the stack has an IAM role associated with it. 

   Note: You can use a Python script or any other scripting language to automate these steps and check for the "RoleARN" field in the JSON output for all your stacks.

#### Using Python

1. Import the necessary AWS SDK for Python (Boto3) modules in your Python script. You will need the `boto3` module to interact with AWS services and the `json` module to parse the response.

```python
import boto3
import json
```

2. Create a session using your AWS credentials. Replace `'my_profile'` with your AWS profile name.

```python
session = boto3.Session(profile_name='my_profile')
```

3. Create a CloudFormation client using the session.

```python
cf_client = session.client('cloudformation')
```

4. Use the `describe_stacks()` method of the CloudFormation client to retrieve the details of all stacks. Then, iterate over each stack and check if the `RoleARN` attribute is present. If it's not present, print the stack name as it's a misconfiguration.

```python
response = cf_client.describe_stacks()

for stack in response['Stacks']:
    if 'RoleARN' not in stack:
        print(f"Stack {stack['StackName']} does not have an IAM role.")
```

This script will print the names of all CloudFormation stacks that do not have an IAM role, indicating a misconfiguration.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate this misconfiguration in AWS, you can follow the below steps:

1. Log in to the AWS Management Console.
2. Go to the CloudFormation service.
3. Select the stack that needs remediation.
4. Click on the "Update Stack" button.
5. In the "Specify template" section, select the current template used by the stack.
6. In the "Configure stack options" section, select "Permissions".
7. Under "Permissions", select "Create a new IAM role".
8. Enter a name for the new IAM role.
9. Select the appropriate policies for the IAM role.
10. Click "Create".

Once the new IAM role is created, it will be associated with the CloudFormation stack and the misconfiguration will be remediated.

#### Using CLI

To remediate the misconfiguration of "CloudFormation Stack Should Have An IAM Role" in AWS using AWS CLI, you can follow these steps:

1. Create an IAM Role with the required permissions for the CloudFormation stack. You can use the following command to create an IAM Role:
```
aws iam create-role --role-name <RoleName> --assume-role-policy-document file://<PolicyDocument.json>
```
Replace `<RoleName>` with the name of the IAM Role you want to create and `<PolicyDocument.json>` with the path to the JSON file containing the trust policy for the role.

2. Attach the required policies to the IAM Role using the following command:
```
aws iam attach-role-policy --role-name <RoleName> --policy-arn <PolicyARN>
```
Replace `<RoleName>` with the name of the IAM Role you created in step 1 and `<PolicyARN>` with the ARN of the policy you want to attach to the role.

3. Update the CloudFormation stack to use the IAM Role you created in step 1. You can use the following command to update the stack:
```
aws cloudformation update-stack --stack-name <StackName> --capabilities CAPABILITY_NAMED_IAM --role-arn <RoleARN>
```
Replace `<StackName>` with the name of the CloudFormation stack you want to update, `<RoleARN>` with the ARN of the IAM Role you created in step 1.

After following these steps, the CloudFormation stack will have an IAM Role associated with it, thus remediating the misconfiguration.

#### Using Python

To remediate the misconfiguration of a CloudFormation stack not having an IAM role, you can follow these steps using Python:

1. Import the necessary AWS SDK modules
```python
import boto3
```

2. Create a boto3 client for CloudFormation and IAM
```python
cf_client = boto3.client('cloudformation')
iam_client = boto3.client('iam')
```

3. Get the ARN of the IAM role that needs to be added to the CloudFormation stack
```python
iam_role_arn = iam_client.get_role(RoleName='your-role-name')['Role']['Arn']
```

4. Get the current CloudFormation stack's details using its stack name
```python
stack_name = 'your-stack-name'
stack_details = cf_client.describe_stacks(StackName=stack_name)['Stacks'][0]
```

5. Check if the stack already has an IAM role attached to it
```python
if 'IamRoleArn' in stack_details:
    print('IAM role already attached to the stack')
    exit()
```

6. If the stack does not have an IAM role attached, update the stack with the new IAM role ARN
```python
cf_client.update_stack(
    StackName=stack_name,
    UsePreviousTemplate=True,
    Capabilities=['CAPABILITY_IAM'],
    Parameters=[],
    RoleARN=iam_role_arn
)
```

7. Wait for the stack to update and check if the IAM role has been attached successfully
```python
cf_client.get_waiter('stack_update_complete').wait(StackName=stack_name)
stack_details = cf_client.describe_stacks(StackName=stack_name)['Stacks'][0]
if 'IamRoleArn' in stack_details:
    print('IAM role attached successfully')
else:
    print('Failed to attach IAM role to the stack')
```

By following these steps, you should be able to remediate the misconfiguration of a CloudFormation stack not having an IAM role attached to it.

### Additional Reading:

- [https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html) 


</Tab>
</Tabs>