

<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Log in to the AWS Management Console and navigate to the CloudFormation service.

2. In the CloudFormation dashboard, select the "Stacks" option from the left-hand side menu. This will display a list of all the stacks that are currently deployed in your AWS account.

3. Select the stack you want to inspect for the Deletion Policy. This will open the stack details page.

4. In the stack details page, navigate to the "Template" tab. Here, you can view the JSON or YAML code of the CloudFormation template used to create the stack. Look for the "DeletionPolicy" attribute in the resources of the template. If the "DeletionPolicy" attribute is not present or not set to "Retain", then the Deletion Policy is not in use for that resource.

#### Using CLI

1. Install and configure AWS CLI: Before you can run any AWS CLI commands, you need to install the AWS CLI on your local machine and configure it with your AWS account credentials. You can do this by running the following commands:

   ```
   pip install awscli
   aws configure
   ```

   You will be prompted to enter your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List all CloudFormation stacks: You can list all the CloudFormation stacks in your AWS account by running the following command:

   ```
   aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE ROLLBACK_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE
   ```

   This command will return a list of all CloudFormation stacks that are in a completed state.

3. Describe a specific CloudFormation stack: You can get detailed information about a specific CloudFormation stack by running the following command:

   ```
   aws cloudformation describe-stacks --stack-name <StackName>
   ```

   Replace `<StackName>` with the name of the stack you want to inspect. This command will return a JSON object that contains detailed information about the specified stack.

4. Check the DeletionPolicy attribute: In the output of the previous command, look for the "DeletionPolicy" attribute in the "Stacks" array. If the "DeletionPolicy" attribute is not set or is set to "Delete", then the CloudFormation stack is misconfigured. The "DeletionPolicy" attribute should be set to "Retain" to prevent the accidental deletion of the stack's resources.

#### Using Python

1. Install the necessary Python libraries: Before you start, make sure you have the necessary Python libraries installed. You will need the boto3 library, which is the Amazon Web Services (AWS) SDK for Python. It allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, and others. You can install it using pip:

   ```bash
   pip install boto3
   ```

2. Set up AWS credentials: Boto3 will look for AWS credentials in several locations. You can set them in your environment variables like so:

   ```bash
   export AWS_ACCESS_KEY_ID="your_access_key_id"
   export AWS_SECRET_ACCESS_KEY="your_secret_access_key"
   ```

3. Write a Python script to check for CloudFormation Deletion Policy: The following Python script uses the boto3 library to list all CloudFormation stacks and check if they have a DeletionPolicy attribute.

   ```python
   import boto3

   def check_deletion_policy():
       client = boto3.client('cloudformation')
       stacks = client.describe_stacks()
       for stack in stacks['Stacks']:
           if 'DeletionPolicy' not in stack:
               print(f"Stack {stack['StackName']} does not have a DeletionPolicy")

   if __name__ == "__main__":
       check_deletion_policy()
   ```

4. Run the script: You can run the script using the Python interpreter. The script will print out the names of all CloudFormation stacks that do not have a DeletionPolicy.

   ```bash
   python check_deletion_policy.py
   ```

This script will help you identify any CloudFormation stacks that are potentially at risk because they do not have a DeletionPolicy. However, it's important to note that this is a simple script and does not handle errors or edge cases. For a production environment, you would want to add error handling and possibly other features.

</Tab>

<Tab title='Remediation'>
### Remediation

#### Using Console

The CloudFormation deletion policy should be in use to ensure that resources created by CloudFormation are not accidentally deleted.

To remediate this misconfiguration in AWS using the AWS console, follow the below steps:

1. Go to the AWS CloudFormation console.
2. Select the stack for which you want to enable deletion protection.
3. Click on the "Stack actions" button and select "Update stack".
4. In the "Specify stack details" page, scroll down to the "Advanced" section.
5. In the "Deletion policy" section, select the "Retain" option for resources that you want to protect from deletion.
6. Click on the "Next" button.
7. In the "Review" page, review the changes and click on the "Update stack" button to apply the changes.

Once the deletion policy is enabled, the resources specified in the policy will not be deleted even if the CloudFormation stack is deleted.

#### Using CLI

To remediate the misconfiguration "CloudFormation Deletion Policy Should Be in Use" for AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to list all the CloudFormation stacks in your account:

   ```
   aws cloudformation list-stacks
   ```

3. Identify the stack that has the misconfiguration and note down its name.

4. Run the following command to update the stack with a deletion policy:

   ```
   aws cloudformation update-stack --stack-name <stack-name> --deletion-policy Retain
   ```

   Note: Replace `<stack-name>` with the actual name of the stack that needs to be updated.

5. Wait for the stack update to complete. You can check the status of the stack update using the following command:

   ```
   aws cloudformation describe-stacks --stack-name <stack-name> --query "Stacks[].StackStatus"
   ```

   Note: Replace `<stack-name>` with the actual name of the stack that needs to be updated.

6. Verify that the deletion policy has been set correctly by running the following command:

   ```
   aws cloudformation describe-stack-resource --stack-name <stack-name> --logical-resource-id <logical-resource-id>
   ```

   Note: Replace `<stack-name>` with the actual name of the stack that needs to be updated and `<logical-resource-id>` with the ID of the resource that needs to be retained.

7. Repeat steps 4-6 for any other stacks that have the misconfiguration.

By following these steps, you can remediate the misconfiguration "CloudFormation Deletion Policy Should Be in Use" for AWS using AWS CLI.

#### Using Python

To remediate the misconfiguration "CloudFormation Deletion Policy Should Be in Use" in AWS using Python, follow these steps:

1. Install the AWS SDK for Python (Boto3) using pip:

```
pip install boto3
```

2. Create a Boto3 client for CloudFormation:

```python
import boto3

client = boto3.client('cloudformation')
```

3. Retrieve the list of CloudFormation stacks:

```python
response = client.list_stacks(
    StackStatusFilter=[
        'CREATE_COMPLETE',
        'UPDATE_COMPLETE',
        'ROLLBACK_COMPLETE'
    ]
)

stack_names = [stack['StackName'] for stack in response['StackSummaries']]
```

4. For each stack, retrieve its resources and check if a DeletionPolicy is defined:

```python
for stack_name in stack_names:
    response = client.describe_stack_resources(StackName=stack_name)
    
    for resource in response['StackResources']:
        if 'DeletionPolicy' not in resource:
            print(f"Resource {resource['LogicalResourceId']} in stack {stack_name} does not have a DeletionPolicy defined.")
```

5. If a resource is found without a DeletionPolicy, add one using the `update_stack` method:

```python
client.update_stack(
    StackName=stack_name,
    UsePreviousTemplate=True,
    Capabilities=[
        'CAPABILITY_NAMED_IAM'
    ],
    ResourceTypes=[
        'AWS::*'
    ],
    StackPolicyBody='{"Statement": [{"Effect": "Allow", "Action": "Update:*", "Principal": "*", "Resource": "*"}]}',
    DeletionPolicy='Retain'
)
```

In the above example, the DeletionPolicy is set to 'Retain', which means that the resource will not be deleted when the CloudFormation stack is deleted. You can choose a different DeletionPolicy based on your requirements.

6. Run the script periodically to ensure that all CloudFormation stacks have a DeletionPolicy defined for their resources.


</Tab>
</Tabs>