---
slug: drift_detection
title: AWS CloudFormation Drift Detection
sidebar_label: AWS CloudFormation Drift Detection
---

### More Info:

Your AWS CloudFormation stacks should not be drifted from their expected template configuration. A CloudFormation stack is considered to have drifted from its configuration if one or more of its resources have been drifted.

### Risk Level

Medium

### Address

Operational Maturity, Reliability

### Compliance Standards

CBP



<Tabs><Tab title='Cause'>
### Check Cause

#### Using Console

1. Sign in to the AWS Management Console and open the AWS CloudFormation console at https://console.aws.amazon.com/cloudformation.

2. In the navigation pane, choose "Stacks".

3. Select the stack that you want to check for drift. 

4. On the stack details page, choose the "Drift" tab. Here, you can see the drift status of the stack. If the stack has drifted, the status will be "DRIFTED". If the stack has not drifted, the status will be "IN_SYNC". If a drift detection operation is in progress, the status will be "NOT_CHECKED". If a drift detection operation has failed, the status will be "UNKNOWN".

#### Using CLI

1. First, you need to install and configure the AWS CLI on your local machine. You can download it from the official AWS website and configure it using the "aws configure" command. You will need to provide your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. Once the AWS CLI is set up, you can use the "aws cloudformation detect-stack-drift" command to detect drift on a stack. The syntax of the command is as follows:

   ```
   aws cloudformation detect-stack-drift --stack-name MyStack
   ```

   Replace "MyStack" with the name of your stack. This command returns a Drift Detection ID that you can use to track the progress of the drift detection operation.

3. To check the status of the drift detection operation, use the "aws cloudformation describe-stack-drift-detection-status" command with the Drift Detection ID as an argument:

   ```
   aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id <Drift-Detection-ID>
   ```

   Replace `<Drift-Detection-ID>` with the ID returned by the "detect-stack-drift" command. This command returns the status of the drift detection operation.

4. If the status is "DETECTION_COMPLETE", you can use the "aws cloudformation describe-stack-resource-drifts" command to get details about the resources that have drifted:

   ```
   aws cloudformation describe-stack-resource-drifts --stack-name MyStack
   ```

   Replace "MyStack" with the name of your stack. This command returns a list of stack resources and their drift status.

#### Using Python

1. **Set up AWS SDK for Python (Boto3):** First, you need to set up AWS SDK for Python (Boto3) on your local machine. This will allow you to interact with AWS services using Python. You can install it using pip:

```python
pip install boto3
```

2. **Configure AWS Credentials:** Next, you need to configure your AWS credentials. You can do this by creating a file at ~/.aws/credentials. Inside this file, you should include your AWS Access Key ID and Secret Access Key:

```python
[default]
aws_access_key_id = YOUR_ACCESS_KEY
aws_secret_access_key = YOUR_SECRET_KEY
```

3. **Create a Python Script to Detect Drift:** Now, you can create a Python script that uses Boto3 to detect drift in your CloudFormation stacks. Here's a basic example:

```python
import boto3

# Create a client
client = boto3.client('cloudformation')

# Detect drift in a specific stack
response = client.detect_stack_drift(
    StackName='MyStack'
)

# Print the response
print(response)
```

This script will return a DriftDetectionId that you can use to check the status of the drift detection operation.

4. **Check the Drift Detection Status:** You can use the DriftDetectionId to check the status of the drift detection operation. Here's how you can do it:

```python
import boto3

# Create a client
client = boto3.client('cloudformation')

# Check the drift detection status
response = client.describe_stack_drift_detection_status(
    StackDriftDetectionId='MyDriftDetectionId'
)

# Print the response
print(response)
```

This script will return the status of the drift detection operation, along with any stack drift status details.

</Tab>


<Tab title='Remediation'>
### Remediation

#### Using Console

To remediate AWS CloudFormation Drift Detection, follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the CloudFormation service.
3. Click on the stack that has drift detection enabled.
4. Click on the "Drift" tab.
5. Review the drift detection results to identify the resources that have drifted.
6. Click on the "Resources" tab to see the current state of the resources.
7. Select the resources that have drifted and click on the "Detect Drift" button.
8. Wait for the drift detection process to complete.
9. Review the drift detection results to confirm that the resources have been remediated.
10. If necessary, make changes to the stack to remediate the drift.
11. Update the stack to apply the changes.
12. Repeat the drift detection process to confirm that the resources are no longer drifting.

#### Using CLI

AWS CloudFormation Drift Detection is a feature that helps you identify resources that have drifted away from their expected configurations. Once you have identified the resources that have drifted, you can use the AWS CLI to remediate the drift.

Here are the steps to remediate AWS CloudFormation Drift Detection using AWS CLI:

1. Identify the stack that has drifted by running the following command:

```
aws cloudformation detect-stack-drift --stack-name <stack-name>
```

2. Once you have identified the resources that have drifted, you can generate a drift report by running the following command:

```
aws cloudformation describe-stack-resource-drifts --stack-name <stack-name>
```

3. Review the drift report to identify the resources that have drifted and the expected and actual configurations.

4. To remediate the drift, update the stack with the expected configuration by running the following command:

```
aws cloudformation update-stack --stack-name <stack-name> --template-body file://<path-to-template> --parameters file://<path-to-parameters>
```

Replace `<path-to-template>` and `<path-to-parameters>` with the file paths to the updated CloudFormation template and parameters file.

5. Wait for the stack update to complete by running the following command:

```
aws cloudformation wait stack-update-complete --stack-name <stack-name>
```

6. Verify that the stack has been remediated by running the following command:

```
aws cloudformation describe-stack-resources --stack-name <stack-name>
```

This will show you the current configuration of the resources in the stack. If the resources have been remediated, the expected and actual configurations should match.

#### Using Python

To remediate AWS CloudFormation drift detection using Python, follow these steps:

1. Import the required libraries: boto3, json

```python
import boto3
import json
```

2. Create a boto3 client for AWS CloudFormation:

```python
client = boto3.client('cloudformation')
```

3. Get the list of stacks:

```python
stacks = client.list_stacks(StackStatusFilter=['CREATE_COMPLETE', 'UPDATE_COMPLETE'])['StackSummaries']
```

4. Loop through the stacks and check for drift:

```python
for stack in stacks:
    stack_drift = client.detect_stack_drift(StackName=stack['StackName'])
    if stack_drift['StackDriftStatus'] == 'DRIFTED':
        print('Stack {} has drifted'.format(stack['StackName']))
```

5. If a stack has drifted, remediate it by updating the stack:

```python
response = client.update_stack(StackName=stack['StackName'], UsePreviousTemplate=True)
print('Stack {} has been remediated'.format(stack['StackName']))
```

Note: Make sure to test the script thoroughly before running it in a production environment.

### Additional Reading:

- [https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/detect-drift-stack.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/detect-drift-stack.html) 


</Tab>
</Tabs>