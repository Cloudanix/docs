---
slug: drift_detection
title: AWS CloudFormation Drift Detection
sidebar_label: AWS CloudFormation Drift Detection
---

### More Info:

Your AWS CloudFormation stacks should not be drifted from their expected template configuration. A CloudFormation stack is considered to have drifted from its configuration if one or more of its resources have been drifted.

### Risk Level

Medium

### Address

Operational Maturity, Reliability

### Compliance Standards

CBP


### Triage and Remediation
<Tabs>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Sign in to the AWS Management Console and open the AWS CloudFormation console at https://console.aws.amazon.com/cloudformation.

2. In the navigation pane, choose "Stacks".

3. Select the stack that you want to check for drift. 

4. On the stack details page, choose the "Drift" tab. Here, you can see the drift status of your stack. If the stack has never been checked for drift, the drift status is "Not checked". If resources in the stack have drifted, the drift status is "Drifted". If no resources have drifted, the drift status is "In sync".
</Accordion>

<Accordion title='Using CLI'>
1. Install and configure AWS CLI: Before you can use AWS CLI, you need to install it on your local machine and configure it with your AWS account credentials. You can install AWS CLI by following the instructions on the official AWS CLI User Guide. After installation, you can configure it by running `aws configure` command and providing your AWS Access Key ID, Secret Access Key, Default region name, and Default output format.

2. List the stacks: Use the `describe-stacks` command to list all the stacks in your AWS account. The command is as follows:
   ```
   aws cloudformation describe-stacks
   ```
   This command will return a JSON output with details of all the stacks.

3. Detect drift on a stack: Use the `detect-stack-drift` command to detect if there is any drift in the stack. Replace `StackName` with the name of your stack. The command is as follows:
   ```
   aws cloudformation detect-stack-drift --stack-name StackName
   ```
   This command will return a Drift Detection ID that you can use to check the status of the drift detection operation.

4. Check drift detection status: Use the `describe-stack-drift-detection-status` command to check the status of the drift detection operation. Replace `DriftDetectionId` with the ID you got from the previous step. The command is as follows:
   ```
   aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id DriftDetectionId
   ```
   This command will return a JSON output with the status of the drift detection operation. If the status is `DETECTION_COMPLETE`, it means the drift detection operation is complete and you can check the results.
</Accordion>

<Accordion title='Using Python'>
1. **Set up AWS SDK for Python (Boto3):** First, you need to set up AWS SDK for Python (Boto3) on your local machine. This will allow you to interact with AWS services using Python. You can install it using pip:

```python
pip install boto3
```

2. **Configure AWS Credentials:** Next, you need to configure your AWS credentials. You can do this by creating a file at ~/.aws/credentials. At the command line, type:

```python
aws configure
```

Then follow the prompts to input your AWS Access Key ID, Secret Access Key, default region name, and default output format.

3. **Create a Python Script to Detect Drift:** Now, you can create a Python script that uses Boto3 to detect drift in your AWS CloudFormation stacks. Here's a basic example:

```python
import boto3

# Create a client
client = boto3.client('cloudformation')

# Detect drift in a stack
response = client.detect_stack_drift(
    StackName='MyStack'
)

print(response)
```

This script creates a CloudFormation client, then uses the `detect_stack_drift` method to detect drift in a stack named 'MyStack'. The response from AWS will be printed to the console.

4. **Interpret the Response:** The response from AWS will include a `StackDriftStatus` field, which will tell you whether the stack has drifted from its expected configuration. The possible values are `DRIFTED`, `NOT_CHECKED`, `IN_SYNC`, or `UNKNOWN`. If the status is `DRIFTED`, it means that one or more of the stack's resources have drifted.

Remember to replace 'MyStack' with the name of your actual stack. Also, this script assumes that you have the necessary permissions to detect drift in the specified stack.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To remediate AWS CloudFormation Drift Detection, follow these steps:

1. Log in to the AWS Management Console.
2. Navigate to the CloudFormation service.
3. Click on the stack that has drift detection enabled.
4. Click on the "Drift" tab.
5. Review the drift detection results to identify the resources that have drifted.
6. Click on the "Resources" tab to see the current state of the resources.
7. Select the resources that have drifted and click on the "Detect Drift" button.
8. Wait for the drift detection process to complete.
9. Review the drift detection results to confirm that the resources have been remediated.
10. If necessary, make changes to the stack to remediate the drift.
11. Update the stack to apply the changes.
12. Repeat the drift detection process to confirm that the resources are no longer drifting.

#
</Accordion>

<Accordion title='Using CLI'>
AWS CloudFormation Drift Detection is a feature that helps you identify resources that have drifted away from their expected configurations. Once you have identified the resources that have drifted, you can use the AWS CLI to remediate the drift.

Here are the steps to remediate AWS CloudFormation Drift Detection using AWS CLI:

1. Identify the stack that has drifted by running the following command:

```
aws cloudformation detect-stack-drift --stack-name <stack-name>
```

2. Once you have identified the resources that have drifted, you can generate a drift report by running the following command:

```
aws cloudformation describe-stack-resource-drifts --stack-name <stack-name>
```

3. Review the drift report to identify the resources that have drifted and the expected and actual configurations.

4. To remediate the drift, update the stack with the expected configuration by running the following command:

```
aws cloudformation update-stack --stack-name <stack-name> --template-body file://<path-to-template> --parameters file://<path-to-parameters>
```

Replace `<path-to-template>` and `<path-to-parameters>` with the file paths to the updated CloudFormation template and parameters file.

5. Wait for the stack update to complete by running the following command:

```
aws cloudformation wait stack-update-complete --stack-name <stack-name>
```

6. Verify that the stack has been remediated by running the following command:

```
aws cloudformation describe-stack-resources --stack-name <stack-name>
```

This will show you the current configuration of the resources in the stack. If the resources have been remediated, the expected and actual configurations should match.
</Accordion>

<Accordion title='Using Python'>
To remediate AWS CloudFormation drift detection using Python, follow these steps:

1. Import the required libraries: boto3, json

```python
import boto3
import json
```

2. Create a boto3 client for AWS CloudFormation:

```python
client = boto3.client('cloudformation')
```

3. Get the list of stacks:

```python
stacks = client.list_stacks(StackStatusFilter=['CREATE_COMPLETE', 'UPDATE_COMPLETE'])['StackSummaries']
```

4. Loop through the stacks and check for drift:

```python
for stack in stacks:
    stack_drift = client.detect_stack_drift(StackName=stack['StackName'])
    if stack_drift['StackDriftStatus'] == 'DRIFTED':
        print('Stack {} has drifted'.format(stack['StackName']))
```

5. If a stack has drifted, remediate it by updating the stack:

```python
response = client.update_stack(StackName=stack['StackName'], UsePreviousTemplate=True)
print('Stack {} has been remediated'.format(stack['StackName']))
```

Note: Make sure to test the script thoroughly before running it in a production environment.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/detect-drift-stack.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/detect-drift-stack.html) 

