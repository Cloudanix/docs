---
slug: deletion_policy_in_use
title: CloudFormation Deletion Policy Should Be in Use
sidebar_label: CloudFormation Deletion Policy Should Be in Use
---

### More Info:

A deletion policy, implemented with the DeletionPolicy attribute, should be used for your Amazon CloudFormation stacks in order preserve or backup AWS resources when the stacks are deleted.

### Risk Level

Low

### Address

Security, Operational Maturity

### Compliance Standards

CBP



### Triage and Remediation
<Tabs>


<Tab title='Prevention'>
### How to Prevent
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
To prevent the misconfiguration of not having a Deletion Policy in use in AWS CloudFormation using the AWS Management Console, follow these steps:

1. **Navigate to CloudFormation:**
   - Open the AWS Management Console.
   - In the Services menu, select "CloudFormation" under the "Management & Governance" section.

2. **Create or Update a Stack:**
   - Click on "Create stack" to create a new stack or select an existing stack and click "Update" to modify it.

3. **Specify Template:**
   - In the "Specify template" section, either upload your template file or use a sample template provided by AWS. Ensure that your template is in JSON or YAML format.

4. **Add Deletion Policy:**
   - In the template, for each resource that you want to protect from deletion, add a `DeletionPolicy` attribute. For example:
     ```yaml
     Resources:
       MyS3Bucket:
         Type: "AWS::S3::Bucket"
         DeletionPolicy: Retain
     ```
   - Ensure that the `DeletionPolicy` attribute is set to `Retain`, `Snapshot`, or `Delete` as per your requirements.

By following these steps, you can ensure that your CloudFormation stacks have appropriate Deletion Policies in place, thereby preventing accidental deletions of critical resources.
</Accordion>

<Accordion title='Using CLI'>
To prevent the misconfiguration of not having a Deletion Policy in use in AWS CloudFormation using the AWS CLI, follow these steps:

1. **Create or Update CloudFormation Template with DeletionPolicy:**
   Ensure that your CloudFormation template includes the `DeletionPolicy` attribute for the resources you want to protect. For example:
   ```yaml
   Resources:
     MyS3Bucket:
       Type: 'AWS::S3::Bucket'
       DeletionPolicy: Retain
   ```

2. **Validate the CloudFormation Template:**
   Before deploying, validate your CloudFormation template to ensure it is correctly formatted and includes the necessary `DeletionPolicy` attributes.
   ```sh
   aws cloudformation validate-template --template-body file://template.yaml
   ```

3. **Deploy the CloudFormation Stack:**
   Use the `create-stack` or `update-stack` command to deploy your CloudFormation stack with the validated template.
   ```sh
   aws cloudformation create-stack --stack-name my-stack --template-body file://template.yaml
   ```
   or
   ```sh
   aws cloudformation update-stack --stack-name my-stack --template-body file://template.yaml
   ```

4. **Verify the DeletionPolicy:**
   After deployment, describe the stack to verify that the `DeletionPolicy` is correctly applied to the resources.
   ```sh
   aws cloudformation describe-stacks --stack-name my-stack
   ```

By following these steps, you can ensure that the `DeletionPolicy` attribute is in use for your CloudFormation resources, thereby preventing accidental deletions.
</Accordion>

<Accordion title='Using Python'>
To prevent the misconfiguration of not having a Deletion Policy in use in AWS CloudFormation using Python scripts, you can follow these steps:

1. **Install Boto3 Library**:
   Ensure you have the Boto3 library installed, which is the AWS SDK for Python. You can install it using pip if you haven't already.

   ```bash
   pip install boto3
   ```

2. **Create a CloudFormation Template with Deletion Policy**:
   Define your CloudFormation template in JSON or YAML format, ensuring that you include the `DeletionPolicy` attribute for the resources you want to protect.

   Example of a CloudFormation template with a Deletion Policy in JSON:

   ```json
   {
     "Resources": {
       "MyS3Bucket": {
         "Type": "AWS::S3::Bucket",
         "DeletionPolicy": "Retain"
       }
     }
   }
   ```

3. **Write a Python Script to Create/Update the Stack**:
   Use Boto3 to create or update the CloudFormation stack with the template that includes the Deletion Policy.

   ```python
   import boto3
   import json

   # Initialize a session using Amazon CloudFormation
   cf_client = boto3.client('cloudformation')

   # Define the CloudFormation template
   template_body = json.dumps({
       "Resources": {
           "MyS3Bucket": {
               "Type": "AWS::S3::Bucket",
               "DeletionPolicy": "Retain"
           }
       }
   })

   # Create or update the CloudFormation stack
   stack_name = 'my-stack-with-deletion-policy'
   try:
       response = cf_client.create_stack(
           StackName=stack_name,
           TemplateBody=template_body,
           Capabilities=['CAPABILITY_IAM']
       )
       print(f'Stack {stack_name} creation initiated.')
   except cf_client.exceptions.AlreadyExistsException:
       response = cf_client.update_stack(
           StackName=stack_name,
           TemplateBody=template_body,
           Capabilities=['CAPABILITY_IAM']
       )
       print(f'Stack {stack_name} update initiated.')
   ```

4. **Validate the Stack**:
   Ensure that the stack is created or updated successfully and that the Deletion Policy is in place.

   ```python
   # Check the status of the stack
   stack_status = cf_client.describe_stacks(StackName=stack_name)['Stacks'][0]['StackStatus']
   print(f'Stack {stack_name} status: {stack_status}')
   ```

By following these steps, you can ensure that your CloudFormation stacks have the necessary Deletion Policies in place to prevent accidental deletions of critical resources.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Cause'>
### Check Cause
<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
1. Log in to the AWS Management Console and navigate to the CloudFormation service.

2. In the CloudFormation dashboard, select the "Stacks" option from the left-hand side menu. This will display a list of all the stacks that are currently deployed in your AWS account.

3. Select the stack you want to inspect and click on the "Template" tab. This will display the JSON or YAML code that was used to create the stack.

4. In the template code, look for the "DeletionPolicy" attribute in each resource definition. If the "DeletionPolicy" attribute is not present or not set to "Retain", then the resource does not have a deletion policy in use.
</Accordion>

<Accordion title='Using CLI'>
1. First, you need to install and configure AWS CLI on your local machine. You can do this by following the instructions provided by AWS. Make sure you have the necessary permissions to access the CloudFormation stacks.

2. Once the AWS CLI is set up, you can list all the CloudFormation stacks in your account using the following command:

   ```
   aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE ROLLBACK_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE --query 'StackSummaries[].StackName' --output text
   ```
   This command will list all the CloudFormation stacks that are in a completed state.

3. Now, for each stack, you can describe the stack resources using the following command:

   ```
   aws cloudformation describe-stack-resources --stack-name <StackName>
   ```
   Replace `<StackName>` with the name of your stack. This command will provide a detailed description of all the resources in the specified stack.

4. Finally, you need to check the `DeletionPolicy` attribute for each resource. If the `DeletionPolicy` attribute is not set or is set to `Delete`, then the resource is not protected from deletion. The `DeletionPolicy` attribute is part of the JSON output from the previous command. You can use a tool like `jq` to parse the JSON and check the `DeletionPolicy` attribute:

   ```
   aws cloudformation describe-stack-resources --stack-name <StackName> | jq -r '.StackResources[] | select(.DeletionPolicy=="Delete" or .DeletionPolicy==null)'
   ```
   This command will list all the resources in the specified stack that are not protected from deletion. If this command returns any resources, then the CloudFormation Deletion Policy is not in use for those resources.
</Accordion>

<Accordion title='Using Python'>
1. Import the necessary libraries: You will need the boto3 library, which allows Python developers to write software that makes use of services like Amazon S3, Amazon EC2, etc.

```python
import boto3
```

2. Create a session using your AWS credentials. You can also use the AWS CLI's default configuration.

```python
session = boto3.Session(
    aws_access_key_id='YOUR_ACCESS_KEY',
    aws_secret_access_key='YOUR_SECRET_KEY',
    region_name='us-west-2'
)
```

3. Create a CloudFormation client.

```python
cf = session.client('cloudformation')
```

4. Now, you can use the `describe_stacks()` function to get a list of all CloudFormation stacks. For each stack, check if the `DeletionPolicy` attribute is set. If it's not, then the stack is misconfigured.

```python
response = cf.describe_stacks()

for stack in response['Stacks']:
    if 'DeletionPolicy' not in stack:
        print(f"Stack {stack['StackName']} is misconfigured.")
```

This script will print the names of all stacks that are misconfigured. If no stacks are printed, then all stacks have a `DeletionPolicy` set.
</Accordion>

</AccordionGroup>
</Tab>

<Tab title='Remediation'>
### Remediation

<AccordionGroup>
<Accordion title='Using Console' defaultOpen='true'>
The CloudFormation deletion policy should be in use to ensure that resources created by CloudFormation are not accidentally deleted.

To remediate this misconfiguration in AWS using the AWS console, follow the below steps:

1. Go to the AWS CloudFormation console.
2. Select the stack for which you want to enable deletion protection.
3. Click on the "Stack actions" button and select "Update stack".
4. In the "Specify stack details" page, scroll down to the "Advanced" section.
5. In the "Deletion policy" section, select the "Retain" option for resources that you want to protect from deletion.
6. Click on the "Next" button.
7. In the "Review" page, review the changes and click on the "Update stack" button to apply the changes.

Once the deletion policy is enabled, the resources specified in the policy will not be deleted even if the CloudFormation stack is deleted.

#
</Accordion>

<Accordion title='Using CLI'>
To remediate the misconfiguration "CloudFormation Deletion Policy Should Be in Use" for AWS using AWS CLI, follow these steps:

1. Open the AWS CLI on your local machine or EC2 instance.

2. Run the following command to list all the CloudFormation stacks in your account:

   ```
   aws cloudformation list-stacks
   ```

3. Identify the stack that has the misconfiguration and note down its name.

4. Run the following command to update the stack with a deletion policy:

   ```
   aws cloudformation update-stack --stack-name <stack-name> --deletion-policy Retain
   ```

   Note: Replace `<stack-name>` with the actual name of the stack that needs to be updated.

5. Wait for the stack update to complete. You can check the status of the stack update using the following command:

   ```
   aws cloudformation describe-stacks --stack-name <stack-name> --query "Stacks[].StackStatus"
   ```

   Note: Replace `<stack-name>` with the actual name of the stack that needs to be updated.

6. Verify that the deletion policy has been set correctly by running the following command:

   ```
   aws cloudformation describe-stack-resource --stack-name <stack-name> --logical-resource-id <logical-resource-id>
   ```

   Note: Replace `<stack-name>` with the actual name of the stack that needs to be updated and `<logical-resource-id>` with the ID of the resource that needs to be retained.

7. Repeat steps 4-6 for any other stacks that have the misconfiguration.

By following these steps, you can remediate the misconfiguration "CloudFormation Deletion Policy Should Be in Use" for AWS using AWS CLI.
</Accordion>

<Accordion title='Using Python'>
To remediate the misconfiguration "CloudFormation Deletion Policy Should Be in Use" in AWS using Python, follow these steps:

1. Install the AWS SDK for Python (Boto3) using pip:

```
pip install boto3
```

2. Create a Boto3 client for CloudFormation:

```python
import boto3

client = boto3.client('cloudformation')
```

3. Retrieve the list of CloudFormation stacks:

```python
response = client.list_stacks(
    StackStatusFilter=[
        'CREATE_COMPLETE',
        'UPDATE_COMPLETE',
        'ROLLBACK_COMPLETE'
    ]
)

stack_names = [stack['StackName'] for stack in response['StackSummaries']]
```

4. For each stack, retrieve its resources and check if a DeletionPolicy is defined:

```python
for stack_name in stack_names:
    response = client.describe_stack_resources(StackName=stack_name)
    
    for resource in response['StackResources']:
        if 'DeletionPolicy' not in resource:
            print(f"Resource {resource['LogicalResourceId']} in stack {stack_name} does not have a DeletionPolicy defined.")
```

5. If a resource is found without a DeletionPolicy, add one using the `update_stack` method:

```python
client.update_stack(
    StackName=stack_name,
    UsePreviousTemplate=True,
    Capabilities=[
        'CAPABILITY_NAMED_IAM'
    ],
    ResourceTypes=[
        'AWS::*'
    ],
    StackPolicyBody='{"Statement": [{"Effect": "Allow", "Action": "Update:*", "Principal": "*", "Resource": "*"}]}',
    DeletionPolicy='Retain'
)
```

In the above example, the DeletionPolicy is set to 'Retain', which means that the resource will not be deleted when the CloudFormation stack is deleted. You can choose a different DeletionPolicy based on your requirements.

6. Run the script periodically to ensure that all CloudFormation stacks have a DeletionPolicy defined for their resources.
</Accordion>

</AccordionGroup>
</Tab>
</Tabs>
### Additional Reading:

- [https://aws.amazon.com/premiumsupport/knowledge-center/delete-cf-stack-retain-resources/](https://aws.amazon.com/premiumsupport/knowledge-center/delete-cf-stack-retain-resources/) 

